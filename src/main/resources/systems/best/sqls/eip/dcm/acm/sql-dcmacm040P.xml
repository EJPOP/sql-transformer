<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.dcm.acm.dao.DCMACM040PMapper">

	<!-- BEST20 문서편집요청 이력 조회 -->
	<select id="selectEdtRqsHisList" parameterType="paramMap" resultType="egovMap">
	/* kr.go.bai.eip.dcm.acm.dao.DCMACM040PMapper.selectEdtRqsHisList */
	<![CDATA[
		SELECT A.AUD_YR 
		      , A.AUD_NO 
		      , A.AUD_STEP_CD 
		      , A.DOC_ID 
		      , A.SRNO 
		      , B.RPRT_NM 
		      , F_CODE_NM('1000333',C.APV_STA_CD) AS APV_STA_NM 
		      , A.APV_STA_CD                      AS EDT_RQS_APV_STA_CD
		      , F_CODE_NM('1000956',B.APV_STA_CD) AS EDT_RQS_APV_STA_NM
		      , A.RQR_ID 
		      , F_USR_INFO_BY_ID(A.RQR_ID ,'2')   AS RQR_NM
		      , A.EDT_ALLOW_DM
		      , A.EDT_ALLOW_DH
		      , TO_CHAR(A.FRT_REGI_DH,'yyyy-MM-dd') AS RQS_DT
		      , (CASE WHEN A.EDT_ALLOW_DM IS NOT NULL THEN TO_CHAR(TO_DATE(A.EDT_ALLOW_DM||A.EDT_ALLOW_DH,'yyyyMMddhh24mi'),'yyyy-MM-dd hh24:mi') ELSE '' END) AS EDT_ALLOW_DT 
		      , NVL(A.CMPT_YN,'N') AS  CMPT_YN
		      , (CASE WHEN A.EDT_ALLOW_DM IS NULL  OR  A.APV_STA_CD != '30'                                 THEN 'N' 
			             WHEN SYSDATE <= TO_DATE(A.EDT_ALLOW_DM||A.EDT_ALLOW_DH,'yyyyMMddhh24mi') THEN 'Y' ELSE 'N' END) AS EDT_YN
		  FROM TBBADDED149M A
		 INNER JOIN
		       TBBADDED103M B
		    ON B.AUD_YR = A.AUD_YR
		   AND B.AUD_NO = A.AUD_NO
		   AND B.AUD_STEP_CD = A.AUD_STEP_CD
		   AND B.DOC_ID = A.DOC_ID
		  LEFT OUTER JOIN
		       TBDCMACM022L C
		    ON C.APV_DOC_NO = A.APV_RQS_ID 
		   AND C.APV_DVSN_CD = 'fieldAuditEdtRqs'
		 WHERE A.AUD_YR = #{audYr}
		    AND A.AUD_NO = #{audNo}
		 ORDER BY
		          A.FRT_REGI_DH DESC
		]]>
	</select>
	
	<!-- 문서편집요청 완료 -->
    <update id="edtRqsCmpt" parameterType="paramMap">
        /* kr.go.bai.eip.dcm.acm.dao.DCMACM040PMapper.edtRqsCmpt */
        <![CDATA[
            UPDATE TBBADDED149M
               SET FNL_MDF_DH = SYSDATE
                  , CMPT_YN  =  #{cmptYn}
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND DOC_ID = #{docId}
               AND AUD_STEP_CD = #{audStepCd}
               AND SRNO = #{srno}
         ]]>
    </update>
</mapper> 