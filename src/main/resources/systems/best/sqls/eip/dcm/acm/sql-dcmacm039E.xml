<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.dcm.acm.dao.DCMACM039EMapper">
	<select id="selectMainList" parameterType="paramMap" resultType="egovMap">
	<include refid="include.pageSelct" />
		SELECT TB.IF_SEQ ,
				TB.TARE_NM ,
				TB.IF_REF_SEQ ,
				TB.IF_TABLE_PK ,
				TB.IF_STATUS ,
				TB.IF_TRY ,
				substr(TB.IF_RAISE_DT,0,4) || '/' || substr(TB.IF_RAISE_DT,5, 2) || '/' || substr(TB.IF_RAISE_DT,7, 2) || ' ' || substr(TB.IF_RAISE_DT,9, 2) || ':' || substr(TB.IF_RAISE_DT,11, 2) || ':' || substr(TB.IF_RAISE_DT,13, 2)  as IF_RAISE_DT ,
				TB.IF_DEAL_DT ,
				TB.IF_SIID ,
				TB.IF_MESSG ,
				TB.IF_TYPE ,
				TB.STTM_KND_CD ,
				TB.HMP_APL_NO,
				TB.LNK_CL_CD,
				F_CODE_NM('1000958',TB.LNK_CL_CD) AS LNK_CL_NM,
				F_CODE_NM('1000959', SUBSTR(TB.IF_STATUS,2,1)) AS LNK_STTUS_NM,
				F_CODE_NM('1000957', SUBSTR(TB.IF_TYPE,1,1)) AS LNK_SE_NM
				FROM (
				SELECT A.IF_SEQ
						, A.TARE_NM
						, A.IF_REF_SEQ
						, A.IF_TABLE_PK
						, A.IF_STATUS
						, A.IF_TRY
						, A.IF_RAISE_DT
						, A.IF_DEAL_DT
						, A.IF_SIID
						, A.IF_MESSG
						, B.IF_TYPE
						, B.STTM_KND_CD
						, B.HMP_APL_NO
						, CASE
						WHEN STTM_KND_CD = '9999' THEN 'F001'
						ELSE 'G001'
						END AS LNK_CL_CD
						
						FROM BAI_INF_DB_RCV_001 A
						, HE_INF_SP_CP_811 B
						WHERE 1=1
						AND A.IF_SEQ = B.IF_SEQ
						AND #{lnkCl} = #{lnkCl}
						<if test="lnkCl != null or lnkCl !='' ">
							<if test="lnkCl=='F002' or lnkCl=='G002'">
								AND 1=2
							</if>
						</if>
						UNION ALL
						SELECT A.IF_SEQ
						, A.TARE_NM
						, A.IF_REF_SEQ
						, A.IF_TABLE_PK
						, A.IF_STATUS
						, A.IF_TRY
						, A.IF_RAISE_DT
						, A.IF_DEAL_DT
						, A.IF_SIID
						, A.IF_MESSG
						, B.IF_TYPE
						, TO_CHAR(B.SRNO) AS STTM_KND_CD
						, B.HMP_APL_NO
						, CASE
						WHEN B.SRNO = '9' THEN 'F002'
						ELSE'G002'
						END AS LNK_CL_CD
						FROM BAI_INF_DB_RCV_001 A
						, HE_INF_SP_CP_812 B
						WHERE 1=1
						AND A.IF_SEQ = B.IF_SEQ
						<if test="lnkCl != null or lnkCl !='' ">
							<if test="lnkCl=='F001' or lnkCl=='G001'">
								AND 1=2
							</if>
						</if>
						UNION ALL
						SELECT A.IF_SEQ
						, A.TARE_NM
						, A.IF_REF_SEQ
						, '' AS IF_TABLE_PK
						, A.IF_STATUS
						, A.IF_TRY
						, A.IF_RAISE_DT
						, A.IF_DEAL_DT
						, A.IF_SIID
						, A.IF_MESSG
						, B.IF_TYPE
						, B.STTM_KND_CD
						, B.HMP_APL_NO
						, CASE
						WHEN STTM_KND_CD = '9999' THEN 'F001'
						ELSE 'G001'
						END AS LNK_CL_CD
						FROM BAI_INF_DB_SND_001 A
						, EH_INF_SP_CP_811 B
						WHERE 1=1
						AND A.IF_SEQ = B.IF_SEQ
						<if test="lnkCl != null or lnkCl !='' ">
							<if test="lnkCl=='F002' or lnkCl=='G002'">
								AND 1=2
							</if>
						</if>
						UNION ALL
						SELECT A.IF_SEQ
						, A.TARE_NM
						, A.IF_REF_SEQ
						, '' AS IF_TABLE_PK
						, A.IF_STATUS
						, A.IF_TRY
						, A.IF_RAISE_DT
						, A.IF_DEAL_DT
						, A.IF_SIID
						, A.IF_MESSG
						, B.IF_TYPE
						, TO_CHAR(B.SRNO) AS STTM_KND_CD
						, B.HMP_APL_NO
						,CASE
						WHEN B.SRNO = '999' THEN 'F002'
						ELSE 'G002'
						END AS LNK_CL_CD
						FROM BAI_INF_DB_SND_001 A
						, EH_INF_SP_CP_812 B
						WHERE 1=1
						AND A.IF_SEQ = B.IF_SEQ
						<if test="lnkCl != null or lnkCl !='' ">
							<if test="lnkCl=='F001' or lnkCl=='G001'">
								AND 1=2
							</if>
						</if>
						) TB
				WHERE 1=1
				AND TB.IF_RAISE_DT BETWEEN #{lnkStrDt}||'000000' AND
				#{lnkEndDt}||'999999'
				<if test="lnkSe!=null and lnkSe!=''">
					AND TB.IF_TYPE = DECODE(#{lnkSe}, 'S', 'SND', 'RCV')
				</if>
				<choose>
					<when test="lnkCl=='F001'">
						AND TB.STTM_KND_CD = '9999'
					</when>
					<when test="lnkCl=='F002'">
						AND (TB.STTM_KND_CD = '999' OR TB.STTM_KND_CD = '9')
					</when>
					<when test="lnkCl=='G001'">
						AND TB.STTM_KND_CD != '9999'
					</when>
					<when test="lnkCl=='G002'">
						AND (TB.STTM_KND_CD != '999' OR TB.STTM_KND_CD IS NULL)
					</when>
				</choose>
				<if test="lnkSttus!=null and lnkSttus!=''">
					AND TB.IF_STATUS like '%'||#{lnkSe}||#{lnkSttus}
				</if>
				<if test="hmpAplNo !=null and hmpAplNo !=''">
					AND TB.HMP_APL_NO = #{hmpAplNo}
				</if>
				 ORDER BY TB.IF_RAISE_DT DESC, TB.TARE_NM ASC
				 <include refid="include.pageOrder" />
				 
	</select>
	
	<resultMap id="boardMap" type="egovMap" >
        <result property="STTM_TXT" column="STTM_TXT" javaType="java.lang.String" jdbcType="CLOB" />
        <result property="ANS_TXT" column="ANS_TXT" javaType="java.lang.String" jdbcType="CLOB" />
    </resultMap>
	
	<select id="detailList" parameterType="paramMap" resultMap="boardMap">
		SELECT *
		<if test ="tareNm =='EH_INF_SP_CP_811'">
			FROM EH_INF_SP_CP_811
		</if>
		
		<if test ="tareNm =='EH_INF_SP_CP_812'">
			FROM EH_INF_SP_CP_812
		</if>
		
		<if test ="tareNm =='HE_INF_SP_CP_811'">
			FROM HE_INF_SP_CP_811
		</if>
			
		<if test ="tareNm =='HE_INF_SP_CP_812'">
			FROM HE_INF_SP_CP_812
		</if>
		WHERE IF_SEQ = #{ifSeq}
	</select>
	
	
	<update id="retry" parameterType="paramMap">
		/* kr.go.bai.eip.dcm.acm.dao.DCMACM039EMapper.retry */
		UPDATE 
			<if test ="table =='BAI_INF_DB_SND_001'">
			BAI_INF_DB_SND_001
			SET IF_STATUS = 'SS'
	        </if>
	        <if test ="table =='BAI_INF_DB_RCV_001'">
	        BAI_INF_DB_RCV_001
			SET IF_STATUS = 'RS'
	        </if>
	    WHERE IF_SEQ = #{ifSeq}
	</update>
</mapper> 