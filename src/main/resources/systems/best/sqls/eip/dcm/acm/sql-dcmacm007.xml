<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.dcm.acm.dao.DCMACM007EMapper">

    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.dcm.acm.dao.DCMACM007EMapper.selectMainList*/
        <include refid="include.pageSelct" />
            <![CDATA[    
			SELECT 
			    F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') AS AUD_YR_NO
			    , AUD_SBJ_NM 
			    , (SELECT MAX(CASE WHEN AUD_STEP_CD = '10' THEN '자료수집/확인출장' ELSE AUD_STEP_NM END) AS CD_NM
			         FROM TBBADDED101B
			        WHERE AUD_STEP_CD = T2.AUD_STEP_CD) AS AUD_STEP_NM
			    , (SELECT 
					   DECODE(AUD_DOC_CD, 'A10600100', '개별처분요구안',AGGR_CONCAT(DTIL_AUD_DOC_NM,',')) AS CD_NM
					  FROM (
					        SELECT 
					            AUD_DOC_CD
					            , DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1)) AS DTIL_AUD_DOC_NM
					          FROM TBFDMADM002M
					         WHERE SUBSTR(AUD_DOC_CD,0,1) = 'A'
					         GROUP BY AUD_DOC_CD, DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1))
                             UNION ALL SELECT 'A10800500' , '공개문' FROM DUAL
                             UNION ALL SELECT 'A10700700' , '부의안요약문-보고자용' FROM DUAL
                             UNION ALL SELECT 'A10700800' , '부의안요약문-원장님용' FROM DUAL
					        )
					  WHERE AUD_DOC_CD = T2.RPRT_CD 
					 GROUP BY AUD_DOC_CD) AS RPRT_KND_NM
			    , T2.RPRT_NM
                , T2.RPRT_NM AS RPRT_REAL_NM
			    , F_CODE_NM('1000773', T2.APV_STA_CD) AS APV_STA_NM
			    , F_USR_INFO_BY_ID(DOC_WRT_ID,'2') AS DOC_WRT_NM
			    , TO_CHAR(T2.FRT_REGI_DH,'YYYY"-"MM"-"DD" "HH24:MI') AS REGI_DH 
			    ,(CASE WHEN TO_DATE(SYSDATE) >= TO_DATE(T3.EDT_END_DT)+1  THEN 'N'   /*현재날짜가 종료일+1보다 클떄 */
			             ELSE NVL(T2.EDT_AUTH,'N')   /*EDT_AUTH가 NULL이면 N ,  Y면 Y*/
				         END) EDT_AUTH
				,T2.EDT_AUTH AS O_EDT_AUTH
				, (CASE WHEN TO_DATE(SYSDATE) >= TO_DATE(T3.EDT_END_DT)+1 THEN '편집불가'  /*현재날짜가 종료일+1보다 클떄 */
				         WHEN T2.APV_STA_CD = '10' THEN '편집가능'  /*결재상태가 작성중이면 편집가능*/
				         WHEN T2.APV_STA_CD != '10' AND T2.EDT_AUTH IS NULL THEN '편집불가'    /*결재상태가 작성중이 아니고  EDT_AUTH가 NULL이면 '편집불가'*/
				         ELSE DECODE(T2.EDT_AUTH,'N','편집불가','편집가능')
				         END) AS EDT_AUTH_NM    
			    , T2.AUD_YR
			    , T2.AUD_NO
			    , T2.AUD_STEP_CD
                , T2.AUD_KND_CD
			    , T2.DOC_ID
			    , T2.APV_STA_CD
			    , T2.APV_RQS_ID
			    , T2.REF_ID
			    , T2.RPRT_CD
			    , F_DPT_INFO(T1.MNG_DPT_CD,'1') AS DPT_NM
			    , CURR_APV.APVR_NM AS CURR_APV_USR_NM
			    , FNL_APV.APVR_NM AS FNL_APV_USR_NM
			    , F_OPEN_EDIT(T2.LINK_URL) AS DOC_TYPE
			    ,(SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END
			       FROM TBDCMACM018H 
			      WHERE DOC_ID = T2.DOC_ID
			         AND CFM_PEN_CFM_YN = 'Y') AS Y_CNT
			    , T4.CFM_PEN_CFM_YN
 			    , T4.SEQ
                , (SELECT APV_STA_CD 
                     FROM TBBADDED103M
                     WHERE RPRT_CD = 'A10700700'
                       AND REF_ID = T2.REF_ID) AS APV_STA_CD_2 -- 부의안 요약문
                , (SELECT APV_STA_CD 
                     FROM TBBADDED103M
                     WHERE RPRT_CD = 'A10700220'
                       AND REF_DOC_ID = T2.REF_DOC_ID) AS APV_STA_CD_3 -- 소위원회 심의안 요약문 			    
			  FROM TBBADDED001M T1
			       INNER JOIN TBBADDED103M T2
			       ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO)
			       INNER JOIN TBFDMADM001M T5
                   ON(T2.RPRT_CD = T5.AUD_DOC_CD AND T5.APV_WAY_CD <> '20')
			       LEFT OUTER JOIN (
									SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
									     , DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
									  FROM TBDCMACM023L M
									 WHERE M.APV_DVSN_CD = 'fieldAudit' 
									   AND SUBSTR(M.APVR_STA_CD,1,1) = '1'
									   AND M.APVR_KND_CD <> '6'
									 GROUP BY M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD, M.APVR_CNB) CURR_APV
			 	   ON (T2.APV_RQS_ID = CURR_APV.APV_DOC_NO)
			 	   LEFT OUTER JOIN (
									SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
  										  ,DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
									  FROM TBDCMACM023L M
									  	   ,(
											SELECT APV_DOC_NO, APV_DVSN_CD, MAX(APVR_SEQ) AS MAX_APVR_SEQ
											  FROM TBDCMACM023L
											 GROUP BY APV_DOC_NO, APV_DVSN_CD
											) SUB
									 WHERE M.APV_DOC_NO = SUB.APV_DOC_NO
									   AND M.APV_DVSN_CD = SUB.APV_DVSN_CD
									   AND M.APVR_SEQ = SUB.MAX_APVR_SEQ
									   AND M.APV_DVSN_CD = 'fieldAudit' ) FNL_APV
			 	   ON (T2.APV_RQS_ID = FNL_APV.APV_DOC_NO)
			 	   LEFT OUTER JOIN TBDCMACM018M T3
			 	   ON(T2.AUD_YR = T3.AUD_YR AND T2.AUD_NO = T3.AUD_NO AND T2.AUD_STEP_CD = T3.AUD_STEP_CD AND T2.DOC_ID = T3.DOC_ID )
			 	   LEFT OUTER JOIN ( 
                                    SELECT M.AUD_YR, M.AUD_NO, M.AUD_STEP_CD, M.DOC_ID, M.CFM_PEN_CFM_YN, M.SEQ
                                      FROM TBDCMACM018H M,
                                          (SELECT AUD_YR
                                                 , AUD_NO
                                                 , AUD_STEP_CD
                                                 , DOC_ID
                                                 , MAX(SEQ) AS SEQ
                                              FROM TBDCMACM018H
                                            WHERE CFM_PEN_CFM_YN = 'N'
                                            GROUP BY AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID
                                            ) SUB
                                      WHERE M.AUD_YR = SUB.AUD_YR 
                                        AND M.AUD_NO = SUB.AUD_NO 
                                        AND M.AUD_STEP_CD = SUB.AUD_STEP_CD 
                                        AND M.DOC_ID = SUB.DOC_ID 
                                        AND M.SEQ = SUB.SEQ) T4
                  ON(T4.AUD_YR = T2.AUD_YR AND T4.AUD_NO = T2.AUD_NO AND T4.AUD_STEP_CD = T2.AUD_STEP_CD AND T4.DOC_ID = T2.DOC_ID)
			 WHERE 1=1
			     
			 	 AND T1.AUD_YR = #{schAudYr}
			]]>
			<if test="schCfmPenCfmYn != null and schCfmPenCfmYn != '' ">
				AND T4.CFM_PEN_CFM_YN = #{schCfmPenCfmYn}
			</if>
			<if test="schAudYrNoKndCd != null and schAudYrNoKndCd != '' "> 
			 	AND T1.AUD_KND_CD = #{schAudYrNoKndCd}
			</if>
			<if test="schAudGrnNo != null and schAudGrnNo != '' "> 
 				AND T1.AUD_GRN_NO = #{schAudGrnNo}
 			</if>
			<if test="schAudSbjNm != null and schAudSbjNm != '' "> 
				 AND T1.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
			</if>
			<if test="schDeptCd != null and schDeptCd != '' "> 
				 AND T1.MNG_DPT_CD = #{schDeptCd}
			</if>
			<if test="schSpvBrdvCd != null and schSpvBrdvCd != '' "> 
				 AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = T1.MNG_DPT_CD) =#{schSpvBrdvCd}
			</if>
			<if test="schPrssStepCd != null and schPrssStepCd != ''  and schPrssStepCd neq  'A1095'.toString()">  
				 AND T2.AUD_STEP_CD = #{schPrssStepCd}
			</if>
            <if test="schPrssStepCd eq  'A1095'.toString()">  
                 AND SUBSTR(T2.RPRT_CD,0,5) = #{schPrssStepCd}
            </if>
			<if test="schRprtNm != null and schRprtNm != '' "> 
				 AND T2.RPRT_NM LIKE '%'||#{schRprtNm}||'%'
			</if>
			<if test="schRprtCd != null and schRprtCd != '' "> 
				 AND T2.RPRT_CD = #{schRprtCd}
			</if>
			<if test="schApvStaCd != null and schApvStaCd != '' "> 
				 AND T2.APV_STA_CD = #{schApvStaCd}
			</if>
			<if test="schEdtAuth != null and schEdtAuth != '' "> 
				 AND NVL(T2.EDT_AUTH,'N') = #{schEdtAuth}
			</if>
			<if test="schCurrApvr != null and schCurrApvr != '' ">
				<choose>
					<when test="schCurrApvr eq '1'.toString()">
						AND CURR_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
					</when>
					<when test="schCurrApvr eq '2'.toString()">
						AND CURR_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
					</when>
					<when test="schCurrApvr eq '3'.toString()">
						AND CURR_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
					</when>
					<when test="schCurrApvr eq '4'.toString()">
						AND CURR_APV.APVR_PST_CD = '0055700'						/*최종결재자가 총장 단계*/				
					</when>
					<when test="schCurrApvr eq '5'.toString()">
						AND CURR_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
					</when>
					<when test="schCurrApvr eq '6'.toString()">
						AND CURR_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
					</when>
				</choose>
			</if>
			<if test="schFnlApvr != null and schFnlApvr != '' ">
				<choose>
					<when test="schFnlApvr eq '1'.toString()">
						AND FNL_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
					</when>
					<when test="schFnlApvr eq '2'.toString()">
						AND FNL_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
					</when>
					<when test="schFnlApvr eq '3'.toString()">
						AND FNL_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
					</when>
					<when test="schFnlApvr eq '4'.toString()">
						AND FNL_APV.APVR_PST_CD = '0055700'							/*최종결재자가 총장 단계*/				
					</when>
					<when test="schFnlApvr eq '5'.toString()">
						AND FNL_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
					</when>
					<when test="schFnlApvr eq '6'.toString()">
						AND FNL_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
					</when>
				</choose>
			</if>
			<if test="schCfmPenCfmYn != null and schFnlApvr != '' ">
			</if>
			 ORDER BY T1.AUD_YR, T1.AUD_KND_CD, T1.AUD_GRN_NO DESC, T2.AUD_STEP_CD, T2.RPRT_CD
		<include refid="include.pageOrder" />
    </select>
    
   	<update id="saveModifyEdtAuth">
        /* kr.go.bai.eip.dcm.acm.dao.DCMACM007EMapper.saveModifyEdtAuth */
       UPDATE TBBADDED103M
       SET EDT_AUTH =  #{edtAuth}
       WHERE
            AUD_YR = #{audYr}
       AND AUD_NO = #{audNo}
       AND DOC_ID = #{docId}
    </update>
    
     <update id="deleteDocRqsId" parameterType="paramMap">
    /* kr.go.bai.eip.dcm.acm.dao.DCMACM007EMapper.deleteDocRqsId*/
       DECLARE
         BEGIN
           UPDATE TBBADDED103M
           SET APV_RQS_ID = ''
           WHERE
                AUD_YR = #{audYr}
           AND AUD_NO = #{audNo}
           AND DOC_ID = #{docId}
            ;
            DELETE 
              FROM PTL_ORDER_NOTI
              WHERE seq in (SELECT SEQ
                          FROM PTL_ORDER_LIST
                         WHERE DOC_No  = #{apvRqsId}) 
            ;
            DELETE
              FROM PTL_ORDER_RECEIVE_LIST
             WHERE seq in (SELECT SEQ
                          FROM PTL_ORDER_LIST
                         WHERE DOC_No  = #{apvRqsId})
            ;
            DELETE
              from PTL_ORDER_LIST
             where seq in (SELECT SEQ
                          FROM PTL_ORDER_LIST
                         WHERE DOC_No  = #{apvRqsId})
            ;
            delete
              FROM TBBADDED109M A
             WHERE A.APV_RQS_ID = #{apvRqsId}
            ;
            delete
              from TBDCMACM023H
             where apv_doc_no = #{apvRqsId}
             and apv_dvsn_cd = 'fieldAudit'
             ; 
            delete
              from TBDCMACM022H
             where apv_doc_no = #{apvRqsId}
            and apv_dvsn_cd = 'fieldAudit'
             ;
            delete
              from TBDCMACM023L
             where apv_doc_no = #{apvRqsId}
             ;
            delete
              from TBDCMACM022L
             where apv_doc_no = #{apvRqsId}
             ;
         END;
    </update>  
    

	<select id="selectExcelExport" parameterType="paramMap" resultType="egovMap">
		<![CDATA[  
		/* kr.go.bai.eip.dcm.acm.dao.DCMACM007EMapper.selectExcelExport*/
		SELECT ROWNUM
		      ,AUD_YR_NO 
		      ,AUD_SBJ_NM
		      ,DPT_NM
		      ,AUD_STEP_NM
		      ,RPRT_KND_NM
		      ,RPRT_NM
		      ,APV_STA_NM
		      ,DOC_WRT_NM
		      ,REGI_DH
		      ,CURR_APV_USR_NM
		      ,FNL_APV_USR_NM
		      ,EDT_AUTH_NM
		  FROM (
				  SELECT 
					    F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') AS AUD_YR_NO
					    , AUD_SBJ_NM 
					    , (SELECT MAX(CASE WHEN AUD_STEP_CD = '10' THEN '자료수집/확인출장' ELSE AUD_STEP_NM END) AS CD_NM
					         FROM TBBADDED101B
					        WHERE AUD_STEP_CD = T2.AUD_STEP_CD) AS AUD_STEP_NM
					    , (SELECT 
							   DECODE(AUD_DOC_CD, 'A10600100', '개별처분요구안',AGGR_CONCAT(DTIL_AUD_DOC_NM,',')) AS CD_NM
							  FROM (
							        SELECT 
							            AUD_DOC_CD
							            , DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1)) AS DTIL_AUD_DOC_NM
							          FROM TBFDMADM002M
							         WHERE SUBSTR(AUD_DOC_CD,0,1) = 'A'
							         GROUP BY AUD_DOC_CD, DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1))
		                             UNION ALL SELECT 'A10800500' , '공개문' FROM DUAL
		                             UNION ALL SELECT 'A10700700' , '부의안요약문-보고자용' FROM DUAL
		                             UNION ALL SELECT 'A10700800' , '부의안요약문-원장님용' FROM DUAL
							        )
							  WHERE AUD_DOC_CD = T2.RPRT_CD 
							 GROUP BY AUD_DOC_CD) AS RPRT_KND_NM
					    , T2.RPRT_NM
		                , T2.RPRT_NM AS RPRT_REAL_NM
					    , F_CODE_NM('1000773', T2.APV_STA_CD) AS APV_STA_NM
					    , F_USR_INFO_BY_ID(DOC_WRT_ID,'2') AS DOC_WRT_NM
					    , TO_CHAR(T2.FRT_REGI_DH,'YYYY"-"MM"-"DD" "HH24:MI') AS REGI_DH 
					    , DECODE(NVL(EDT_AUTH,'N'),'N','편집불가','편집가능') AS EDT_AUTH_NM
		                , NVL(EDT_AUTH,'N') AS EDT_AUTH
					    , T2.AUD_YR
					    , T2.AUD_NO
					    , T2.AUD_STEP_CD
					    , T2.DOC_ID
					    , T2.APV_STA_CD
					    , T2.APV_RQS_ID
					    , F_DPT_INFO(T1.MNG_DPT_CD,'1') AS DPT_NM
					    , CURR_APV.APVR_NM AS CURR_APV_USR_NM
			    		, FNL_APV.APVR_NM AS FNL_APV_USR_NM
					  FROM TBBADDED001M T1
					       INNER JOIN TBBADDED103M T2
					       ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO)
					       LEFT OUTER JOIN (
											SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
											     , DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
											  FROM TBDCMACM023L M
											 WHERE M.APV_DVSN_CD = 'fieldAudit' 
											   AND SUBSTR(M.APVR_STA_CD,1,1) = '1'
											   AND M.APVR_KND_CD <> '6'
											 GROUP BY M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD, M.APVR_CNB) CURR_APV
					 	   ON (T2.APV_RQS_ID = CURR_APV.APV_DOC_NO)
					 	   LEFT OUTER JOIN (
											SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
		  										  ,DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
											  FROM TBDCMACM023L M
											  	   ,(
													SELECT APV_DOC_NO, APV_DVSN_CD, MAX(APVR_SEQ) AS MAX_APVR_SEQ
													  FROM TBDCMACM023L
													 GROUP BY APV_DOC_NO, APV_DVSN_CD
													) SUB
											 WHERE M.APV_DOC_NO = SUB.APV_DOC_NO
											   AND M.APV_DVSN_CD = SUB.APV_DVSN_CD
											   AND M.APVR_SEQ = SUB.MAX_APVR_SEQ
											   AND M.APV_DVSN_CD = 'fieldAudit' ) FNL_APV
					 	   ON (T2.APV_RQS_ID = FNL_APV.APV_DOC_NO)
					 WHERE 1=1
					 	 AND T1.AUD_YR = #{schAudYr}
					]]>
					<if test="schAudYrNoKndCd != null and schAudYrNoKndCd != '' "> 
					 	AND T1.AUD_KND_CD = #{schAudYrNoKndCd}
					</if>
					<if test="schAudGrnNo != null and schAudGrnNo != '' "> 
		 				AND T1.AUD_GRN_NO = #{schAudGrnNo}
		 			</if>
					<if test="schAudSbjNm != null and schAudSbjNm != '' "> 
						 AND T1.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
					</if>
					<if test="schDeptCd != null and schDeptCd != '' "> 
						 AND T1.MNG_DPT_CD = #{schDeptCd}
					</if>
					<if test="schSpvBrdvCd != null and schSpvBrdvCd != '' "> 
						 AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = T1.MNG_DPT_CD) =#{schSpvBrdvCd}
					</if>
					<if test="schPrssStepCd != null and schPrssStepCd != ''  and schPrssStepCd neq  'A1095'.toString()">  
						 AND T2.AUD_STEP_CD = #{schPrssStepCd}
					</if>
		            <if test="schPrssStepCd eq  'A1095'.toString()">  
		                 AND SUBSTR(T2.RPRT_CD,0,5) = #{schPrssStepCd}
		            </if>
					<if test="schRprtNm != null and schRprtNm != '' "> 
						 AND T2.RPRT_NM LIKE '%'||#{schRprtNm}||'%'
					</if>
					<if test="schRprtCd != null and schRprtCd != '' "> 
						 AND T2.RPRT_CD = #{schRprtCd}
					</if>
					<if test="schApvStaCd != null and schApvStaCd != '' "> 
						 AND T2.APV_STA_CD = #{schApvStaCd}
					</if>
					<if test="schEdtAuth != null and schEdtAuth != '' "> 
						 AND NVL(T2.EDT_AUTH,'N') = #{schEdtAuth}
					</if>
					<if test="schCurrApvr != null and schCurrApvr != '' ">
						<choose>
							<when test="schCurrApvr eq '1'.toString()">
								AND CURR_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
							</when>
							<when test="schCurrApvr eq '2'.toString()">
								AND CURR_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
							</when>
							<when test="schCurrApvr eq '3'.toString()">
								AND CURR_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
							</when>
							<when test="schCurrApvr eq '4'.toString()">
								AND CURR_APV.APVR_PST_CD = '0055700'						/*최종결재자가 총장 단계*/				
							</when>
							<when test="schCurrApvr eq '5'.toString()">
								AND CURR_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
							</when>
							<when test="schCurrApvr eq '6'.toString()">
								AND CURR_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
							</when>
						</choose>
					</if>
					<if test="schFnlApvr != null and schFnlApvr != '' ">
						<choose>
							<when test="schFnlApvr eq '1'.toString()">
								AND FNL_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
							</when>
							<when test="schFnlApvr eq '2'.toString()">
								AND FNL_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
							</when>
							<when test="schFnlApvr eq '3'.toString()">
								AND FNL_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
							</when>
							<when test="schFnlApvr eq '4'.toString()">
								AND FNL_APV.APVR_PST_CD = '0055700'							/*최종결재자가 총장 단계*/				
							</when>
							<when test="schFnlApvr eq '5'.toString()">
								AND FNL_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
							</when>
							<when test="schFnlApvr eq '6'.toString()">
								AND FNL_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
							</when>
						</choose>
					</if>
					ORDER BY T1.AUD_YR, T1.AUD_KND_CD, T1.AUD_GRN_NO DESC, T2.AUD_STEP_CD, T2.RPRT_CD
				)
	</select>
    <select id="selectCheckOutDocumentList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.dcm.acm.dao.DCMACM007EMapper.selectCheckOutDocumentList*/
        <if test="cntChk != null and cntChk != '' "> 
		SELECT COUNT(1) CNT FROM (
		</if>
        <include refid="include.pageSelct" />
        <![CDATA[
			SELECT TB.* FROM (
                 
				SELECT F_CODE_NM('1000787',SUBSTR(T2.AUD_STEP_CD,1,3)) AS TSK_KND_NM
	                , SUBSTR(T2.AUD_STEP_CD,1,3) AS AUD_GROUP_CD
				    , F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') AS AUD_YR_NO
				    , AUD_SBJ_NM 
				    , (SELECT MAX(CASE WHEN AUD_STEP_CD = '10' THEN '자료수집/확인출장' ELSE AUD_STEP_NM END) AS CD_NM
				         FROM TBBADDED101B
				        WHERE AUD_STEP_CD = T2.AUD_STEP_CD) AS AUD_STEP_NM
				    , T2.RPRT_CD
				    , F_CODE_NM('1000786', T2.RPRT_CD) AS ORG_RPRT_NM
	                , T2.RPRT_NM
				    , F_CODE_NM('1000773', T2.APV_STA_CD) AS APV_STA_NM
				    , F_USR_INFO_BY_ID(DOC_WRT_ID,'2') AS DOC_WRT_NM
				    , TO_CHAR(T2.FRT_REGI_DH,'YYYY"-"MM"-"DD" "HH24:MI') AS REGI_DH 
				    , DECODE(NVL(EDT_AUTH,'N'),'N','편집불가','편집가능') AS EDT_AUTH_NM
	                , NVL(EDT_AUTH,'N') AS EDT_AUTH
				    , T2.AUD_YR
				    , T2.AUD_GRN_NO AS AUD_NO
				    , T2.AUD_KND_CD
				    , T2.AUD_STEP_CD
				    , T2.DOC_ID
				    , T2.APV_STA_CD
				    , T2.APV_RQS_ID
				    , F_DPT_INFO(T1.MNG_DPT_CD,'1') AS DPT_NM
				    , T1.MNG_DPT_CD
				    , F_OPEN_EDIT(T2.LINK_URL) AS DOC_TYPE
				  FROM TBBADDED001M T1 INNER JOIN TBBADDED103M T2 ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO)
	               WHERE 1=1
	          ]]>
	          <if test="schAudYr != null and schAudYr != '' "> 
            	AND T1.AUD_YR = #{schAudYr}
            </if>
        <![CDATA[
    	UNION ALL
              
              SELECT F_CODE_NM('1000787',SUBSTR(T4.ACP_STEP_CD,1,3)) AS TSK_KND_NM
	                , SUBSTR(T4.ACP_STEP_CD,1,3) AS AUD_GROUP_CD
	                ,  (  SELECT DECODE(A.RM_CVPT_ACP_NO,NULL,NULL,T3.ACP_YR||'-'||F_CODE_NM('1000740',T3.REQ_DVSN_CD)||'-'||A.RM_CVPT_ACP_NO) 
	                    FROM   TBCSPDCP101M A
	                    WHERE A.REQ_DVSN_CD = T3.REQ_DVSN_CD
	                    AND A.ACP_YR = T3.ACP_YR
	                    AND A.CVPT_ACP_NO = T3.CVPT_ACP_NO ) AS AUD_YR_NO 
	               ,  (SELECT TIT_NM FROM TBCSPDCP101M 
	                       WHERE ACP_YR = T3.ACP_YR
	                       AND RM_CVPT_ACP_NO= T3.CVPT_ACP_NO
	                       AND REQ_DVSN_CD = T3.REQ_DVSN_CD ) AS AUD_SBJ_NM
	               	, (	SELECT	ACP_STEP_NM
				      		FROM	TBCSPDCP601M S3
				      		WHERE	(S3.REQ_DVSN_CD, S3.ACP_YR, S3.CVPT_ACP_NO, ACP_STEP_CD ) IN (	SELECT	S4.REQ_DVSN_CD,S4.ACP_YR,S4.CVPT_ACP_NO,MAX(ACP_STEP_CD)
				      																		FROM	TBCSPDCP601M S4
				      																		WHERE	T3.REQ_DVSN_CD = S4.REQ_DVSN_CD
				      																		AND		T3.ACP_YR = S4.ACP_YR
				      																		AND		T3.CVPT_ACP_NO = S4.CVPT_ACP_NO
	                                                                                        AND     S4.STEP_CMPT_YN = 'P'
				      																		GROUP BY S4.REQ_DVSN_CD,S4.ACP_YR,S4.CVPT_ACP_NO
				      																	))  AS    ACP_STEP_NM
				    , T4.RPRT_CD
				    , F_CODE_NM('1000786', T4.RPRT_CD) AS ORG_RPRT_NM
	                , T4.RPRT_NM
				    , F_CODE_NM('1000773', T4.APV_STA_CD) AS APV_STA_NM
				    , F_USR_INFO_BY_ID(T4.DOC_WRT_ID,'2') AS DOC_WRT_NM
				    , TO_CHAR(T4.FRT_REGI_DH,'YYYY-MM-DD" "HH24:MI') AS REGI_DH
				    , '편집가능' AS EDT_AUTH_NM
	                , 'Y' AS EDT_AUTH
				    , T4.ACP_YR AS AUD_YR
	                ,  ( SELECT DECODE(A.RM_CVPT_ACP_NO, NULL, T3.CVPT_ACP_NO, A.RM_CVPT_ACP_NO) 
	                    FROM   TBCSPDCP101M A
	                    WHERE A.REQ_DVSN_CD = T3.REQ_DVSN_CD
	                    AND A.ACP_YR = T3.ACP_YR
	                    AND A.CVPT_ACP_NO = T3.CVPT_ACP_NO ) AS AUD_NO 
	                , T4.REQ_DVSN_CD  AS AUD_KND_CD
				    , T4.ACP_STEP_CD
				    , T4.DOC_ID
				    , T4.APV_STA_CD
				    , T4.APV_RQS_ID
				    , F_DPT_INFO(T3.HNDL_DPT_CD,'1') AS DPT_NM
				    , T3.HNDL_DPT_CD AS MNG_DPT_CD
				    , F_OPEN_EDIT(T4.LINK_URL) AS DOC_TYPE
	          FROM TBCSPDCP201M T3 INNER JOIN TBCSPDCP603M T4 ON (T3.ACP_YR = T4.ACP_YR AND T3.REQ_DVSN_CD = T4.REQ_DVSN_CD AND T3.CVPT_ACP_NO = T4.CVPT_ACP_NO)
	         WHERE 1=1
	   ]]>
	         <if test="schAudYr != null and schAudYr != '' "> 
            	AND T3.ACP_YR = #{schAudYr}
            </if>
        
        <![CDATA[
    	UNION ALL
              
              SELECT F_CODE_NM('1000787',SUBSTR(T4.ACP_STEP_CD,1,3)) AS TSK_KND_NM
	                , SUBSTR(T4.ACP_STEP_CD,1,3) AS AUD_GROUP_CD
	                ,  (  SELECT DECODE(A.RM_CVPT_ACP_NO,NULL,NULL,T3.ACP_YR||'-'||F_CODE_NM('1000740',T3.REQ_DVSN_CD)||'-'||A.RM_CVPT_ACP_NO) 
	                    FROM   TBCSPDCP101M A
	                    WHERE A.REQ_DVSN_CD = T3.REQ_DVSN_CD
	                    AND A.ACP_YR = T3.ACP_YR
	                    AND A.CVPT_ACP_NO = T3.CVPT_ACP_NO ) AS AUD_YR_NO 
	               ,  (SELECT TIT_NM FROM TBCSPDCP101M 
	                       WHERE ACP_YR = T3.ACP_YR
	                       AND RM_CVPT_ACP_NO= T3.CVPT_ACP_NO
	                       AND REQ_DVSN_CD = T3.REQ_DVSN_CD ) AS AUD_SBJ_NM
	               	, (	SELECT	ACP_STEP_NM
				      		FROM	TBCSPDCP601M S3
				      		WHERE	(S3.REQ_DVSN_CD, S3.ACP_YR, S3.CVPT_ACP_NO, ACP_STEP_CD ) IN (	SELECT	S4.REQ_DVSN_CD,S4.ACP_YR,S4.CVPT_ACP_NO,MAX(ACP_STEP_CD)
				      																		FROM	TBCSPDCP601M S4
				      																		WHERE	T3.REQ_DVSN_CD = S4.REQ_DVSN_CD
				      																		AND		T3.ACP_YR = S4.ACP_YR
				      																		AND		T3.CVPT_ACP_NO = S4.CVPT_ACP_NO
	                                                                                        AND     S4.STEP_CMPT_YN = 'P'
				      																		GROUP BY S4.REQ_DVSN_CD,S4.ACP_YR,S4.CVPT_ACP_NO
				      																	))  AS    ACP_STEP_NM
				    , T4.RPRT_CD
				    , F_CODE_NM('1000786', T4.RPRT_CD) AS ORG_RPRT_NM
	                , T4.RPRT_NM
				    , F_CODE_NM('1000773', T4.APV_STA_CD) AS APV_STA_NM
				    , F_USR_INFO_BY_ID(T4.DOC_WRT_ID,'2') AS DOC_WRT_NM
				    , TO_CHAR(T4.FRT_REGI_DH,'YYYY-MM-DD" "HH24:MI') AS REGI_DH
				    , '편집가능' AS EDT_AUTH_NM
	                , 'Y' AS EDT_AUTH
				    , T4.ACP_YR AS AUD_YR
	                ,  ( SELECT DECODE(A.RM_CVPT_ACP_NO, NULL, T3.CVPT_ACP_NO, A.RM_CVPT_ACP_NO) 
	                    FROM   TBCSPDCP101M A
	                    WHERE A.REQ_DVSN_CD = T3.REQ_DVSN_CD
	                    AND A.ACP_YR = T3.ACP_YR
	                    AND A.CVPT_ACP_NO = T3.CVPT_ACP_NO ) AS AUD_NO 
	                , T4.REQ_DVSN_CD  AS AUD_KND_CD
				    , T4.ACP_STEP_CD
				    , T4.DOC_ID
				    , T4.APV_STA_CD
				    , T4.APV_RQS_ID
				    , F_DPT_INFO(T3.HNDL_DPT_CD,'1') AS DPT_NM
				    , T3.HNDL_DPT_CD AS MNG_DPT_CD
				    , F_OPEN_EDIT(T4.LINK_URL) AS DOC_TYPE
	          FROM TBCSPEAR001M T3 INNER JOIN TBCSPDCP603M T4 ON (T3.ACP_YR = T4.ACP_YR AND T3.REQ_DVSN_CD = T4.REQ_DVSN_CD AND T3.CVPT_ACP_NO = T4.CVPT_ACP_NO)
	         WHERE 1=1
	   ]]>
	         <if test="schAudYr != null and schAudYr != '' "> 
            	AND T3.ACP_YR = #{schAudYr}
            </if>
        
        <![CDATA[
		UNION ALL		
			 
              SELECT  F_CODE_NM('1000787',SUBSTR(T6.ACP_STEP_CD,1,3)) AS TSK_KND_NM
	               , SUBSTR(T6.ACP_STEP_CD,1,3) AS AUD_GROUP_CD
				    , T5.ACP_YR || '-' || DECODE(T5.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정')|| '-' || DECODE(T5.ORG_ACP_SRNO, NULL, T5.ACP_SRNO, T5.ORG_ACP_SRNO) AS AUD_YR_NO
				    , T5.TIT_NM AS AUD_SBJ_NM
				    , F_CODE_NM('1000807', T5.ACP_HNDL_STA_CD) AS AUD_STEP_NM
				    , T6.RPRT_CD
				    , F_CODE_NM('1000786', T6.RPRT_CD) AS ORG_RPRT_NM
	                , T6.RPRT_NM
				    , F_CODE_NM('1000773', T6.APV_STA_CD) AS APV_STA_NM
				    , F_USR_INFO_BY_ID(T6.DOC_WRT_ID,'2') AS DOC_WRT_NM
				    , TO_CHAR(T6.FRT_REGI_DH,'YYYY-MM-DD" "HH24:MI') AS REGI_DH
	                , DECODE(NVL(T6.EDT_AUTH,'N'),'N','편집불가','편집가능') AS EDT_AUTH_NM
	                , NVL(T6.EDT_AUTH,'N') AS EDT_AUTH
				    , T5.ACP_YR AS AUD_YR
	                , TO_CHAR(T5.ACP_SRNO) AS AUD_NO
	                , T6.ACP_DVSN_CD AS AUD_KND_CD
				    , T6.ACP_STEP_CD
				    , T6.DOC_ID
				    , T6.APV_STA_CD
				    , T6.APV_RQS_ID
				    , F_DPT_INFO((SELECT DPT_CD FROM TBDCMACM001M WHERE T5.HNDL_CHGR_CD = CNB ),'1') AS DPT_NM
				    , (SELECT DPT_CD FROM TBDCMACM001M WHERE T5.HNDL_CHGR_CD = CNB )  AS MNG_DPT_CD
				    , F_OPEN_EDIT(T6.LINK_URL) AS DOC_TYPE
			FROM  TBBADFRE012M T5 INNER JOIN TBBADFRE103M T6 ON (T5.ACP_YR = T6.ACP_YR AND T5.ACP_DVSN_CD = T6.ACP_DVSN_CD AND T5.ACP_SRNO = T6.ACP_SRNO)
           WHERE 1=1
        ]]>
           <if test="schAudYr != null and schAudYr != '' "> 
            	AND T5.ACP_YR = #{schAudYr}
            </if>
            
        ) TB
        WHERE 1=1
	 	
		<if test="docIdWhere != null and docIdWhere != '' "> 
			AND TB.DOC_ID IN
			<foreach collection="docIdWhere" item="docId" index="index" separator="," open="(" close=")">
	            #{docId}
	         </foreach>
		</if>
		<if test="cbbAudKnd != null and cbbAudKnd != '' "> 
		AND TB.AUD_GROUP_CD=#{cbbAudKnd}
		</if>
		<if test="schAudYrNoKndCd != null and schAudYrNoKndCd != '' "> 
		AND TB.AUD_KND_CD=#{schAudYrNoKndCd}
		</if>
		<if test="schAudGrnNo != null and schAudGrnNo != '' "> 
		AND TB.AUD_NO = #{schAudGrnNo}
		</if>
		<if test="schDeptCd != null and schDeptCd != '' "> 
		AND TB.MNG_DPT_CD = #{schDeptCd}
		</if>
		<if test="schSpvBrdvCd != null and schSpvBrdvCd != '' "> 
		AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = TB.MNG_DPT_CD) = #{schSpvBrdvCd}
		</if>
				 
		ORDER BY TB.AUD_GROUP_CD, TB.AUD_YR, TB.AUD_STEP_CD, TB.RPRT_CD
		
		<include refid="include.pageOrder" />
		<if test="cntChk != null and cntChk != '' "> 
		) TT
		</if>
    </select>
    
    <select id="selectUserName" parameterType="paramMap" resultType="java.lang.String">
	    /* kr.go.bai.eip.dcm.acm.dao.DCMACM007EMapper.selectUserName */
	    SELECT USR_NAM FROM TBDCMACM001M 
	    WHERE USR_ID = #{usrId}
    </select>
    
    <select id="selectPrintHistoryList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.dcm.acm.dao.DCMACM007EMapper.selectPrintHistoryList */
        <include refid="include.pageSelct" />
        <![CDATA[
            SELECT F_DPT_INFO(T.HIRK_DPT_CD,'1') AS HIRK_DPT_NM
                     , T.DOC_NM AS FILE_NM
                     , T.*
              FROM (
                SELECT A.SRNO
                         , A.DOC_NM
                         , A.DOC_ID
                         , A.PRT_DPT_CD
                         , A.PRT_DPT_NM
                         , (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = A.PRT_DPT_CD) AS HIRK_DPT_CD
                         , A.PRT_USR_ID
                         , A.PRT_USR_NM
                         , A.PRT_USR_ID ||'/'|| A.PRT_USR_NM AS PRT_USR_IDNM 
                         , A.PRT_DT
                         , TO_CHAR(A.PRT_DT, 'YYYY-MM-DD HH24:MI:SS') AS PRT_DT_TXT
                         , F_CODE_NM('1000787',SUBSTR(B.AUD_STEP_CD,1,3)) AS TSK_KND_NM 
                         , F_MNG_KND_AUDYRNO(B.AUD_YR, B.AUD_NO, B.AUD_KND_CD, '-') AS AUD_YR_NO
                         , B.AUD_SBJ_NM 
                         , (SELECT MAX(AUD_STEP_NM) AS CD_NM
                              FROM TBBADDED101B
                            WHERE AUD_STEP_CD = REL_STEP_CD) AS AUD_STEP_NM
                         , A.RPRT_CD
                         , DECODE(SUBSTR(A.RPRT_CD,4, LENGTH(A.RPRT_CD)),'999999','증거서류',F_CODE_NM('1000786', A.RPRT_CD)) AS ORG_RPRT_NM
                         , A.REL_WORK_CD
                         , A.REL_WORK_YEAR
                         , A.REL_WORK_DVSN_CD
                         , A.REL_WORK_NO
                         , A.REL_STEP_CD
                         , B.AUD_GRN_NO
                         , F_CODE_NM('1000894', B.DOC_WRIT_KND_CD) AS DOC_TYPE
                FROM TBDCMACM043H A, TBBADDED001M B
              WHERE A.REL_WORK_YEAR = B.AUD_YR
                  AND A.REL_WORK_DVSN_CD = B.AUD_KND_CD
                  AND A.REL_WORK_NO = B.AUD_NO
                  AND A.REL_WORK_CD = 'A10'
                
          UNION
          
                SELECT A.SRNO
                         , A.DOC_NM
                         , A.DOC_ID
                         , A.PRT_DPT_CD
                         , A.PRT_DPT_NM
                         , (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = A.PRT_DPT_CD) AS HIRK_DPT_CD
                         , A.PRT_USR_ID
                         , A.PRT_USR_NM
                         , A.PRT_USR_ID ||'/'|| A.PRT_USR_NM AS PRT_USR_IDNM
                         , A.PRT_DT
                         , TO_CHAR(A.PRT_DT, 'YYYY-MM-DD HH24:MI:SS') AS PRT_DT_TXT
                         , F_CODE_NM('1000787',SUBSTR(A.REL_STEP_CD,1,3)) AS TSK_KND_NM 
                         , DECODE(B.RM_CVPT_ACP_NO,NULL,NULL,B.ACP_YR||'-'||F_CODE_NM('1000740',B.REQ_DVSN_CD)||'-'||B.RM_CVPT_ACP_NO) AS AUD_YR_NO
                         , B.TIT_NM AS AUD_SBJ_NM
                         , (SELECT MAX(AUD_STEP_NM) AS CD_NM
                              FROM TBBADDED101B
                            WHERE AUD_STEP_CD = REL_STEP_CD) AS AUD_STEP_NM
                         , A.RPRT_CD
                         , DECODE(SUBSTR(A.RPRT_CD,4, LENGTH(A.RPRT_CD)),'999999','증거서류',F_CODE_NM('1000786', A.RPRT_CD)) AS ORG_RPRT_NM
                         , A.REL_WORK_CD
                         , A.REL_WORK_YEAR
                         , A.REL_WORK_DVSN_CD
                         , A.REL_WORK_NO
                         , A.REL_STEP_CD
                         , B.CVPT_ACP_NO AS AUD_GRN_NO
                         , F_CODE_NM('1000894', B.DOC_WRIT_KND_CD) AS DOC_TYPE
                  FROM TBDCMACM043H A, TBCSPDCP101M B
                 WHERE A.REL_WORK_YEAR = B.ACP_YR
                     AND A.REL_WORK_DVSN_CD = B.REQ_DVSN_CD
                     AND A.REL_WORK_NO = B.CVPT_ACP_NO
                     AND A.REL_WORK_CD IN ('B10', 'C10')
                        
              UNION  
                  
                SELECT A.SRNO
                        , A.DOC_NM
                        , A.DOC_ID
                        , A.PRT_DPT_CD
                        , A.PRT_DPT_NM
                        , (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = A.PRT_DPT_CD) AS HIRK_DPT_CD
                        , A.PRT_USR_ID
                        , A.PRT_USR_NM
                        , A.PRT_USR_ID ||'/'|| A.PRT_USR_NM AS PRT_USR_IDNM
                        , A.PRT_DT
                        , TO_CHAR(A.PRT_DT, 'YYYY-MM-DD HH24:MI:SS') AS PRT_DT_TXT
                        , F_CODE_NM('1000787',SUBSTR(A.REL_STEP_CD,1,3)) AS TSK_KND_NM
                        , B.ACP_YR || '-' || DECODE(B.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') || '-' || DECODE(B.ORG_ACP_SRNO, null, B.ACP_SRNO, B.ORG_ACP_SRNO) AS AUD_YR_NO
                        , B.TIT_NM AS AUD_SBJ_NM
                        , (SELECT MAX(AUD_STEP_NM) AS CD_NM
                             FROM TBBADDED101B
                            WHERE AUD_STEP_CD = REL_STEP_CD) AS AUD_STEP_NM
                        , A.RPRT_CD
                        , DECODE(SUBSTR(A.RPRT_CD,4, LENGTH(A.RPRT_CD)),'999999','증거서류',F_CODE_NM('1000786', A.RPRT_CD)) AS ORG_RPRT_NM
                        , A.REL_WORK_CD
                        , A.REL_WORK_YEAR
                        , A.REL_WORK_DVSN_CD
                        , A.REL_WORK_NO
                        , A.REL_STEP_CD
                        , TO_CHAR(B.ACP_SRNO) AS AUD_GRN_NO
                        , F_CODE_NM('1000894', B.DOC_WRIT_KND_CD) AS DOC_TYPE
                  FROM TBDCMACM043H A, TBBADFRE012M B
                    WHERE A.REL_WORK_YEAR = B.ACP_YR
                        AND A.REL_WORK_DVSN_CD = B.ACP_DVSN_CD
                        AND A.REL_WORK_NO = B.ACP_SRNO
                        AND A.REL_WORK_CD IN ('D10', 'E10')
              
              UNION
            
                SELECT A.SRNO
                        , A.DOC_NM
                        , A.DOC_ID
                        , A.PRT_DPT_CD
                        , A.PRT_DPT_NM
                        , (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = A.PRT_DPT_CD) AS HIRK_DPT_CD
                        , A.PRT_USR_ID
                        , A.PRT_USR_NM
                        , A.PRT_USR_ID ||'/'|| A.PRT_USR_NM AS PRT_USR_IDNM
                        , A.PRT_DT
                        , TO_CHAR(A.PRT_DT, 'YYYY-MM-DD HH24:MI:SS') AS PRT_DT_TXT
                        , F_CODE_NM('1000787',SUBSTR(A.REL_STEP_CD,1,3)) AS TSK_KND_NM
                        ,'' AS AUD_YR_NO
                        , B.AUD_PLAN_YR ||'-'||(SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD = B.DPT_CD ) AS AUD_SBJ_NM
                        , (SELECT MAX(AUD_STEP_NM) AS CD_NM
                             FROM TBBADDED101B
                            WHERE AUD_STEP_CD = REL_STEP_CD) AS AUD_STEP_NM
                        , A.RPRT_CD
                        , DECODE(SUBSTR(A.RPRT_CD,4, LENGTH(A.RPRT_CD)),'999999','증거서류',F_CODE_NM('1000786', A.RPRT_CD)) AS ORG_RPRT_NM
                        , A.REL_WORK_CD
                        , A.REL_WORK_YEAR
                        , A.REL_WORK_DVSN_CD
                        , A.REL_WORK_NO
                        , A.REL_STEP_CD
                        , TO_CHAR(B.AUD_PLAN_SNO) AS AUD_GRN_NO
                        , F_OPEN_EDIT(B.LINK_URL) AS DOC_TYPE
                  FROM TBDCMACM043H A, TBBADDED131M B
                WHERE A.REL_WORK_YEAR = B.AUD_PLAN_YR
                   AND A.REL_WORK_DVSN_CD = B.DPT_CD
                   AND A.REL_WORK_NO = B.AUD_PLAN_SNO
                   AND A.REL_WORK_CD IN ('A11')
        
              UNION
        
                SELECT A.SRNO
                        , A.DOC_NM
                        , A.DOC_ID
                        , A.PRT_DPT_CD
                        , A.PRT_DPT_NM
                        , (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = A.PRT_DPT_CD) AS HIRK_DPT_CD
                        , A.PRT_USR_ID
                        , A.PRT_USR_NM
                        , A.PRT_USR_ID ||'/'|| A.PRT_USR_NM AS PRT_USR_IDNM
                        , A.PRT_DT
                        , TO_CHAR(A.PRT_DT, 'YYYY-MM-DD HH24:MI:SS') AS PRT_DT_TXT
                        , F_CODE_NM('1000787',SUBSTR(A.REL_STEP_CD,1,3)) AS TSK_KND_NM
                        ,'' AS AUD_YR_NO
                        , DOC_NM AS AUD_SBJ_NM
                        , (SELECT MAX(AUD_STEP_NM) AS CD_NM
                             FROM TBBADDED101B
                            WHERE AUD_STEP_CD = REL_STEP_CD) AS AUD_STEP_NM
                        , A.RPRT_CD
                        , DECODE(SUBSTR(A.RPRT_CD,4, LENGTH(A.RPRT_CD)),'999999','증거서류',F_CODE_NM('1000786', A.RPRT_CD)) AS ORG_RPRT_NM
                        , A.REL_WORK_CD
                        , A.REL_WORK_YEAR
                        , A.REL_WORK_DVSN_CD
                        , A.REL_WORK_NO
                        , A.REL_STEP_CD
                        , '' AS AUD_GRN_NO
                        , '' AS DOC_TYPE
                 FROM TBDCMACM043H A
               WHERE A.REL_WORK_CD IN ('Z10')  
                        
                ) T
            WHERE 1=1
        ]]>
                <if test="schPrtIdNm != null and schPrtIdNm != '' "> 
                AND (PRT_USR_ID LIKE #{schPrtIdNm}||'%' OR PRT_USR_NM LIKE #{schPrtIdNm}||'%' )
                </if>
                <if test="schPrtDt != null and schPrtDt != '' "> 
                AND TO_CHAR(PRT_DT,'YYYYMMDD') = #{schPrtDt}
                </if>
                <if test="schDeptCd != null and schDeptCd != '' "> 
                AND PRT_DPT_CD = #{schDeptCd}
                </if>
                <if test="schSpvBrdvCd != null and schSpvBrdvCd != '' "> 
                 AND HIRK_DPT_CD = #{schSpvBrdvCd}
                </if>
                <if test="cbbAudKnd != null and cbbAudKnd != '' ">
                AND REL_WORK_CD = #{cbbAudKnd}
                </if>
                <if test="schAudYr != null and schAudYr != '' "> 
                AND REL_WORK_YEAR = #{schAudYr}
                </if>
                <if test="schAudYrNoKndCd != null and schAudYrNoKndCd != '' "> 
                AND REL_WORK_DVSN_CD = #{schAudYrNoKndCd}
                </if>
                <if test="schAudGrnNo != null and schAudGrnNo != '' "> 
                AND AUD_GRN_NO = #{schAudGrnNo}
                </if>
                <if test="schPrtDtFrom != null and schPrtDtFrom != '' "> 
                 AND TO_CHAR(PRT_DT,'YYYYMMDD') BETWEEN #{schPrtDtFrom} AND #{schPrtDtTo}
                </if>
                <if test="schAudSbjNm != null and schAudSbjNm != '' "> 
                 AND AUD_SBJ_NM LIKE '%'|| #{schAudSbjNm} ||'%'
                </if>
                <if test="eviDcmbChk ==  'Y'.toString()">
                AND SUBSTR(T.RPRT_CD,4, LENGTH(T.RPRT_CD)) = '999999'
                </if>
                <if test="eviDcmbChk == null or eviDcmbChk == '' ">
                AND SUBSTR(T.RPRT_CD,4, LENGTH(T.RPRT_CD)) != '999999'
                </if>
            ORDER BY SRNO
        <include refid="include.pageOrder" />
    </select>
    
   <update id="updateCfmPenCfmYn" parameterType="paramMap">
   		UPDATE TBDCMACM018H 
   		     SET CFM_PEN_CFM_YN = 'Y'
   		WHERE DOC_ID = #{docId}
   		  AND AUD_YR =  #{audYr}
   		  AND AUD_NO =  #{audNo}
          AND CFM_PEN_CFM_YN = 'N'
   </update>
    
    
</mapper> 