<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="DCMIAM006Mapper">
	<resultMap id="adminMap" type="egovMap">
		<result property="adminId" column="ADM_ID" />
		<result property="adminAttrId" column="ADM_ATTR_ID" />
		<result property="adminName" column="ADM_NM" />
		<result property="adminPassword" column="ADM_PWD" />
		<result property="regDate" column="REGI_DT" />
		<result property="status" column="STA" />
		<result property="loginMethod" column="LOGIN_WAY" />
		<result property="certDn" column="CERT_DNV" />
		<result property="accIp" column="ACC_IP" />
		<result property="totCnt" column="TOT_CNT" />
		<result property="hndlYr" column="HNDL_YR" />
		<result property="tgTypCd" column="TG_TYP_CD" />
		<result property="grnTypCd" column="GRN_TYP_CD" />
		<result property="hndlDvsnCd" column="HNDL_DVSN_CD" />
		<result property="cnt" column="CNT" />
	</resultMap>

    <select id="countAdminId" resultType="int">

		SELECT COUNT(*) FROM TBDCMIAM013M WHERE ADM_ID = #{adminId}

    </select>


    <select id="selectAdminMenuList" resultMap="adminMap">

        SELECT B.*

        FROM (

          SELECT ROWNUM ROWNO, A.*, COUNT(*) OVER() AS TOT_CNT

          FROM (

                SELECT *

				FROM TBDCMIAM013M

		        <trim prefix="WHERE" prefixOverrides="AND |OR ">

		            <if test="searchSelector != null and searchSelector !='' and searchSelector =='adminId' and searchSelectedValue !=''">

	               		AND TBDCMIAM013M.ADM_ID like '%'||#{searchSelectedValue}||'%'

	           		</if>

	            	<if test="searchSelector != null and searchSelector !='' and searchSelector =='adminName' and searchSelectedValue !=''">

	            		AND TBDCMIAM013M.ADM_NM like '%'||#{searchSelectedValue}||'%'

	            	</if>

		        </trim>

           ) A


        )B

		WHERE ROWNO BETWEEN (((#{currPage}- 1) * #{pageSize}) + 1) AND (#{currPage} * #{pageSize})
    </select>

    <select id="selectCountAdminId" resultType="int">

		SELECT COUNT(ADM_ID)

		FROM TBDCMIAM013M

		WHERE ADM_ID = #{admin_id_addModal}

    </select>


	<select id="selectLogList" resultMap="adminMap">

        SELECT B.*
		
		FROM(
			
			SELECT ROWNUM ROWNO, A.*, COUNT(*) OVER() AS TOT_CNT

			FROM (

				SELECT HNDL_PEN_ID,
                       TO_CHAR(HNDL_DH,'YYYY-MM-DD HH24:MI:SS') AS  HNDL_DH,
                       TG_TYP_CD,
                       TG_ID,
                       TG_NM,
                       TG_DES,
                       HNDL_DVSN_CD,
                       HNDL_STA_CD,
                       HNDL_ERR_HIS,
                       GRN_TYP_CD,
                       GRN_ID,
                       ETC_HNDL_HIS

				FROM TBDCMIAM012H

				WHERE 1=1
				
				


				<if test="searchSelector != null and searchSelector !='' and searchSelector =='adminId' and searchSelectedValue !=''">

	               	AND HNDL_PEN_ID like '%'||#{searchSelectedValue}||'%'

	           	</if>

	            <if test="searchSelector != null and searchSelector !='' and searchSelector =='doType' and searchSelectedValue !=''">

	            	AND TG_TYP_CD like '%'||#{searchSelectedValue}||'%'

	            </if>
				
				<if test="strDt != null and strDt != '' and endDt != null and endDt != '' ">
				
					AND TO_CHAR(HNDL_DH, 'YYYY-MM-DD') BETWEEN #{strDt} AND #{endDt}
				
				</if>
				
				ORDER BY HNDL_DH desc
			) A

		) B

		WHERE ROWNO BETWEEN (((#{currPage}- 1) * #{pageSize}) + 1) AND (#{currPage} * #{pageSize})
		
		ORDER BY ROWNO ASC

    </select>
    
    
    
    
    <select id="selectLogYMList" resultMap="adminMap">

				<if test="pDtType=='year'">
	            SELECT HNDL_YR AS HNDL_YR
	           	</if>
	            <if test="pDtType =='month'">
	            SELECT HNDL_YM AS HNDL_YR
	            </if>
					     , TG_TYP_CD
					     , GRN_TYP_CD
					     , HNDL_DVSN_CD
					     , COUNT(1) AS CNT
					  FROM TBDCMIAM012H
				WHERE 1=1
				<if test="pDtType =='year' and pDate != null and pDate != ''">
	               	AND HNDL_YR like '%'||#{pDate}||'%'
	           	</if>
	            <if test="pDtType =='month' and pDate != null and pDate != ''">
	            	AND HNDL_YM like '%'||#{pDate}||'%'
	            </if>
	            GROUP BY
	            <if test="pDtType =='year'">
	               	HNDL_YR,
	           	</if>
	            <if test="pDtType =='month'">
	            	HNDL_YM,
	            </if>
	              TG_TYP_CD, GRN_TYP_CD, HNDL_DVSN_CD
				ORDER BY
				 <if test="pDtType =='year'">
	               	HNDL_YR
	           	</if>
	            <if test="pDtType =='month'">
	            	HNDL_YM
	            </if> 
				 desc
				

    </select>
    




     <update id="updateAdminInfo">

		UPDATE TBDCMIAM013M

		SET 

		  ADM_NM = #{adminNameModifyModal},

		  STA = #{adminAuthenModifyModal},

		  ACC_IP = #{adminIpModifyModal}

		WHERE TBDCMIAM013M.ADM_ID = #{adminIdModifyModal}

	</update>


	<update id="updateAdminInfoWithPw">

		UPDATE TBDCMIAM013M

		SET 

		  ADM_NM = #{adminNameModifyModal},

		  STA = #{adminAuthenModifyModal},

		  ADM_PWD = #{adminPasswordModifyModal},

		  ACC_IP =  #{adminIpModifyModal}

		WHERE TBDCMIAM013M.ADM_ID = #{adminIdModifyModal}

	</update>


	<insert id="addAdminInfo">

		INSERT

		INTO TBDCMIAM013M (ADM_ID, ADM_ATTR_ID, ADM_NM, ADM_PWD, REGI_DT, STA, ACC_IP)

		VALUES (#{adminIdAddModal}, #{adminAttrId},

		      #{adminNameAddModal}, #{adminPasswordAddModal}, sysdate, #{adminAuthenAddModal}, #{adminIpAddModal})

    </insert>

    

     <delete id="deleteAdminInfo">

    	DELETE

		FROM TBDCMIAM013M

		WHERE (TBDCMIAM013M.ADM_ID = #{oneAdminID})

    </delete>
    
    
    <select id="selectUserListRole" resultType ="egovMap">
	   /* kr.go.bai.eip.cor.cor.dao.dcmiam006.selectUserListRole */
SELECT B.*
		FROM (
		SELECT ROWNUM ROWNO, A.*, COUNT(*) OVER() AS TOT_CNT
		FROM (
		SELECT *
  FROM (SELECT EV2.CNB /*사용자 전산번호*/
  		     , EV2.USR_ID    /*사용자ID*/
             , EV2.USR_NAM      /*사용자명*/
             , EV2.DPT_NM        /*부서명*/
             , (SELECT DISTINCT AGGR_CONCAT(CASE WHEN RG.STR_DT IS NOT NULL THEN RI.ROLE_DES || '(' || TO_CHAR(RG.STR_DT, 'YYYY-MM-DD') || ' 부터 ' || TO_CHAR(RG.END_DT, 'YYYY-MM-DD') || ' 까지)'
                                                 ELSE RI.ROLE_DES END, ',')
                   FROM TBDCMIAM003M RI  /*역할정보*/
                      , TBDCMIAM009M RG    /*역할-그룹매핑정보*/
                  WHERE 1=1
                    AND EV2.DPT_CD = RG.GRP_ID
                    AND RG.ROLE_ID = RI.ROLE_ID) AS DPT_ROLE_NAME  /*부서역할정보*/
             , EV2.RANK_NM_2 --직책
             , (SELECT DISTINCT AGGR_CONCAT(GI.GRP_DES, ',')
                  FROM TBDCMIAM008D GU /*그룹-사용자매핑 정보*/
                     , TBDCMIAM007M GI /*그룹정보*/
                 WHERE 1=1
                   AND EV2.USR_ID = GU.USR_ID
                   AND GU.GRP_ID  = GI.GRP_ID)   AS GROUP_NAME    /*사용자그룹명정보*/
             , (SELECT DISTINCT AGGR_CONCAT(GI.GRP_ID, ',')
                  FROM TBDCMIAM008D GU /*그룹-사용자매핑 정보*/
                     , TBDCMIAM007M GI /*그룹정보*/
                 WHERE 1=1
                   AND EV2.USR_ID = GU.USR_ID
                   AND GU.GRP_ID  = GI.GRP_ID)   AS GROUP_ID      /*사용자그룹ID정보*/
             , (SELECT DISTINCT AGGR_CONCAT(CASE WHEN RU.STR_DT IS NOT NULL THEN RI.ROLE_DES || '(' || TO_CHAR(RU.STR_DT, 'YYYY-MM-DD') || ' 부터 ' || TO_CHAR(RU.END_DT, 'YYYY-MM-DD') || ' 까지)'
                                                 ELSE RI.ROLE_DES END, ',')
                   FROM TBDCMIAM003M RI /*역할정보*/
                      , TBDCMIAM010M RU /*역할-사용자매핑정보*/
                  WHERE 1=1
                    AND EV2.USR_ID = RU.USR_ID
                    AND RU.ROLE_ID = RI.ROLE_ID) AS ROLE_NAME     /*사용자역할정보*/
            
          FROM EAMUSER_VIEW EV2
         WHERE 1=1
         ORDER BY DPT_NM
                , RANK_NM_2)
			WHERE 1=1
			<if test="usrId !='' and usrId != null">
				AND USR_ID like '%'||#{usrId}||'%'
			</if>
			<if test="usrNam !='' and usrNam != null">
				AND USR_NAM like '%'||#{usrNam}||'%'
			</if>
			<if test="dptNam !='' and dptNam != null">
				AND DPT_NM like '%'||#{dptNam}||'%'
			</if>
			<if test="groupName !='' and groupName != null">
				AND GROUP_NAME like '%'||#{groupName}||'%'
			</if>
			<if test="roleName !='' and roleName != null">
				AND (ROLE_NAME like '%'||#{roleName}||'%' OR GROUP_NAME like '%'||#{roleName}||'%') 
			</if>
			
			ORDER BY USR_NAM, CNB
		
		) A
		)B
		<if test="currPage !='' and currPage != null and pageSize !='' and pageSize != null" >
		WHERE ROWNO BETWEEN (((#{currPage}- 1) * #{pageSize}) + 1) AND (#{currPage} * #{pageSize})
		</if>
	</select>




	<select id="selectHisRole" resultType ="egovMap">
	   /* kr.go.bai.eip.cor.cor.dao.dcmiam006.selectHisRole */
		SELECT B.*
		FROM (
		SELECT ROWNUM ROWNO, A.*, COUNT(*) OVER() AS TOT_CNT
		FROM (
			SELECT TO_CHAR(MAX(FNL_MDF_DH), 'YYYY-MM-DD') AS FNL_MDF_DH
			     , USR_ID
			     , USR_NAM
			     , DPT_NM
			     , DPT_ROLE_NAME
			     , RANK_NM_2
			     , GROUP_NAME
			     , GROUP_ID
			     , ROLE_NAME
			  FROM (SELECT EV2.FNL_MDF_DH
			             , EV2.USR_ID    /*사용자ID*/
			             , EV2.USR_NAM   /*사용자명*/
			             , EV2.DPT_NM    /*부서명*/
			             , (SELECT DISTINCT AGGR_CONCAT(CASE WHEN RG.STR_DT IS NOT NULL THEN RI.ROLE_DES || '(' || TO_CHAR(RG.STR_DT, 'YYYY-MM-DD') || ' 부터 ' || TO_CHAR(RG.END_DT, 'YYYY-MM-DD') || ' 까지)'
			                                                 ELSE RI.ROLE_DES END, ',')
			                   FROM TBDCMIAM003M RI /*역할정보*/
			                      , TBDCMIAM009M RG /*역할-그룹매핑정보*/
			                  WHERE 1=1
			                    AND EV2.DPT_CD = RG.GRP_ID
			                    AND RG.ROLE_ID = RI.ROLE_ID) AS DPT_ROLE_NAME /*부서역할정보*/
			             , EV2.RANK_NM_2 /*직책*/
			             , (SELECT DISTINCT AGGR_CONCAT(GI.GRP_DES, ',')
			                  FROM (SELECT MAX(LG_ID)
			                             , DECODE(TG_TYP_CD, 'User', GRN_ID, TG_ID)  AS GRP_ID
			                             , DECODE(TG_TYP_CD, 'User', TG_ID,  GRN_ID) AS USR_ID
			                          FROM TBDCMIAM012H
			                         WHERE 1=1
			                           AND (TG_TYP_CD    = 'User'
			                             OR GRN_TYP_CD   = 'User')
			                     <![CDATA[ 
			                           AND TG_TYP_CD    <> 'Resource'
			                           AND GRN_TYP_CD   <> 'Resource'
			                      ]]>
			                           AND HNDL_DVSN_CD  = 'Insert'
			                           AND ((TG_TYP_CD   = 'User'  AND GRN_TYP_CD = 'Group')
			                             OR (TG_TYP_CD   = 'Group' AND GRN_TYP_CD = 'User'))
			                           <if test="strDt != null and strDt != '' and endDt != null and endDt != '' ">
					                            AND HNDL_DH BETWEEN #{strDt} /*기간조건1*/
					                                            		 AND #{endDt} /*기간조건2*/
										</if>
			                         GROUP BY DECODE(TG_TYP_CD, 'User', GRN_ID, TG_ID)
			                                , DECODE(TG_TYP_CD, 'User', TG_ID,  GRN_ID)) GU /*그룹-사용자매핑 정보*/
			                     , TBDCMIAM007M GI /*그룹정보*/
			                 WHERE 1=1
			                   AND EV2.USR_ID = GU.USR_ID
			                   AND GU.GRP_ID  = GI.GRP_ID)   AS GROUP_NAME    /*사용자그룹명정보*/
			             , (SELECT DISTINCT AGGR_CONCAT(GI.GRP_ID, ',')
			                  FROM (SELECT MAX(LG_ID)
			                             , DECODE(TG_TYP_CD, 'User', GRN_ID, TG_ID)  AS GRP_ID
			                             , DECODE(TG_TYP_CD, 'User', TG_ID,  GRN_ID) AS USR_ID
			                          FROM TBDCMIAM012H
			                         WHERE 1=1
			                           AND (TG_TYP_CD    = 'User'
			                             OR GRN_TYP_CD   = 'User')
			                           <![CDATA[
			                           AND TG_TYP_CD    <> 'Resource'
			                           AND GRN_TYP_CD   <> 'Resource'
			                           ]]>
			                           AND HNDL_DVSN_CD  = 'Insert'
			                           AND ((TG_TYP_CD   = 'User'  AND GRN_TYP_CD = 'Group')
			                              OR (TG_TYP_CD  = 'Group' AND GRN_TYP_CD = 'User'))
			                          <if test="strDt != null and strDt != '' and endDt != null and endDt != '' ">
					                            AND HNDL_DH BETWEEN #{strDt} /*기간조건1*/
					                                            		 AND #{endDt} /*기간조건2*/
										</if>
			                         GROUP BY DECODE(TG_TYP_CD, 'User', GRN_ID, TG_ID)
			                                , DECODE(TG_TYP_CD, 'User', TG_ID,  GRN_ID)) GU /*그룹-사용자매핑 정보*/
			                     , TBDCMIAM007M GI /*그룹정보*/
			                 WHERE 1=1
			                   AND EV2.USR_ID = GU.USR_ID
			                   AND GU.GRP_ID  = GI.GRP_ID)   AS GROUP_ID      /*사용자그룹ID정보*/
			             , (SELECT DISTINCT AGGR_CONCAT(RI.ROLE_DES, ',')
			                   FROM TBDCMIAM003M RI /*역할정보*/
			                      , (SELECT MAX(LG_ID)
			                              , DECODE(TG_TYP_CD, 'User', TG_ID,  GRN_ID) AS USR_ID
			                              , DECODE(TG_TYP_CD, 'User', GRN_ID, TG_ID)  AS ROLE_ID
			                           FROM TBDCMIAM012H
			                          WHERE 1=1
			                            AND (TG_TYP_CD    = 'User'
			                              OR GRN_TYP_CD   = 'User')
			                            <![CDATA[
			                            AND TG_TYP_CD    <> 'Resource'
			                            AND GRN_TYP_CD   <> 'Resource'
			                            ]]>
			                            AND HNDL_DVSN_CD  = 'Insert'
			                            AND ((TG_TYP_CD   = 'User' AND GRN_TYP_CD = 'Role')
			                              OR (TG_TYP_CD   = 'Role' AND GRN_TYP_CD = 'User'))
										<if test="strDt != null and strDt != '' and endDt != null and endDt != '' ">
					                            AND HNDL_DH BETWEEN #{strDt} /*기간조건1*/
					                                            		 AND #{endDt} /*기간조건2*/
										</if>
			                          GROUP BY DECODE(TG_TYP_CD, 'User', GRN_ID, TG_ID)
			                                 , DECODE(TG_TYP_CD, 'User', TG_ID,  GRN_ID)) RU /*역할-사용자매핑정보*/
					                  WHERE 1=1
					                    AND EV2.USR_ID = RU.USR_ID
					                    AND RU.ROLE_ID = RI.ROLE_ID) AS ROLE_NAME     /*사용자역할정보*/
					          FROM EAMUSER_HST_VIEW EV2
					         WHERE 1=1
					         ORDER BY DPT_NM
					                , RANK_NM_2)
						 WHERE 1=1
						   <if test="usrId !='' and usrId != null">
								AND USR_ID like '%'||#{usrId}||'%'
							</if>
							<if test="usrNam !='' and usrNam != null">
								AND USR_NAM like '%'||#{usrNam}||'%'
							</if>
							<if test="dptNam !='' and dptNam != null">
								AND DPT_NM like '%'||#{dptNam}||'%'
							</if>
							<if test="groupName !='' and groupName != null">
								AND GROUP_NAME like '%'||#{groupName}||'%'
							</if>
							<if test="roleName !='' and roleName != null">
								AND (ROLE_NAME like '%'||#{roleName}||'%' AND GROUP_NAME like '%'||#{roleName}||'%')
							</if>
							<if test="strDt != null and strDt != '' and endDt != null and endDt != '' ">
					                            AND FNL_MDF_DH BETWEEN #{strDt} /*기간조건1*/
					                                            		 AND #{endDt} /*기간조건2*/
							</if>
						 GROUP BY USR_ID
						        , USR_NAM
						        , DPT_NM
						        , DPT_ROLE_NAME
						        , RANK_NM_2
						        , GROUP_NAME
						        , GROUP_ID
						        , ROLE_NAME
						 ORDER BY USR_NAM
						        , FNL_MDF_DH DESC
			
			) A
		)B
		<if test="currPage !='' and currPage != null and pageSize !='' and pageSize != null" >
		WHERE ROWNO BETWEEN (((#{currPage}- 1) * #{pageSize}) + 1) AND (#{currPage} * #{pageSize})
		</if>
	</select>
</mapper>