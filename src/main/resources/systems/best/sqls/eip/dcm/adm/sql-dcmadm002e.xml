<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.dcm.adm.dao.DCMADM002EMapper">

	<!-- 감사자료 제출 요구 목록 조회 -->
	<select id="selectMainList" parameterType="paramMap"
		resultType="egovMap">
		/* DCMADM002EMapper.selectMainList 감사자료 제출 요구 목록 조회 */
		<include refid="include.pageSelct"/>
		<![CDATA[
			SELECT MIN(F_CODE_NM('1000989',NVL(T2.ACP_DVSN_CD, '10'))) AS ACP_DVSN_NM
			      ,T1.MTRL_SRNO
			      ,MIN(T1.SMT_YR) AS SMT_YR
			      ,MIN(T1.SMT_SNO) AS SMT_SNO
			      ,MIN(T1.SMT_YR||'-'||T1.SMT_SNO) AS SMT_YR_SNO
			      ,MIN(TO_CHAR(TO_DATE(T1.SMT_DT),'YYYY-MM-DD')) AS SMT_DT
			      ,MIN(T1.PRSR_NM) AS PRSR_NM
			      ,MIN(T1.PRSR_EML_AD) AS PRSR_EML_AD
			      ,MIN(T1.SMT_ORG_CD) AS SMT_ORG_CD
			      ,MIN(T1.SMT_ORG_NM) AS SMT_ORG_NM
			      ,MIN(T1.PRSR_DPT_CD) AS PRSR_DPT_CD
			      ,MIN(T1.PRSR_DPT_NM) AS PRSR_DPT_NM
			      ,MIN(T1.PRSR_TNB) AS PRSR_TNB
			      ,MIN(T1.PRSR_ADMN_STND_CD) AS PRSR_ADMN_STND_CD
			      ,MIN(T1.PRSR_HHT_STND_CD) AS PRSR_HHT_STND_CD
			      ,MIN(T1.TIT_NM) AS TIT_NM
			      ,MIN(T1.SMT_TXT) AS SMT_TXT
			      ,MIN(T1.RQR_CNB) AS RQR_CNB
			      ,MIN(T1.RQR_DPT_CD) AS RQR_DPT_CD
			      ,MIN(T1.SMT_DVSN_CD) AS SMT_DVSN_CD
			      ,MIN(F_CODE_NM('1000991',T1.SMT_DVSN_CD)) AS SMT_DVSN_NM
			      ,MIN(T1.CRT_DVSN_CD) AS CRT_DVSN_CD
			      ,MIN(F_CODE_NM('1000983', T1.CRT_DVSN_CD)) AS CRT_DVSN_NM
			      ,MIN(T1.CRT_USR_SIGN) AS CRT_USR_SIGN
			      ,MIN(T1.CRT_DH) AS CRT_DH
			      ,MIN(T1.CRT_PEN_DNV) AS CRT_PEN_DNV
			  FROM TBDCMADM002M T1 
			     , TBDCMADM003M T2 
			 WHERE 1=1
			  AND T1.MTRL_SRNO = T2.MTRL_SRNO
			  AND RQR_CNB = #{sCnb}
		]]>
		<if test='schSmtDts != null and schSmtDts != ""'>
				<![CDATA[
				   AND T1.SMT_DT >= #{schSmtDts}
				]]>
			</if>
			
		<if test='schSmtDte != null and schSmtDte != ""'>
				<![CDATA[
				   AND T1.SMT_DT <= #{schSmtDte}
				]]>
			</if>
		<if test='schSmtDvsnCd != null and schSmtDvsnCd != ""'>
				<![CDATA[
				   AND T1.SMT_DVSN_CD <= #{schSmtDvsnCd}
				]]>
			</if>
		<if test='schSmtOrgNm != null and schSmtOrgNm != ""'>
				<![CDATA[
				   AND T1.SMT_ORG_NM LIKE  '%'||#{schSmtOrgNm}||'%'
				]]>
			</if>
        <if test='acpDvsnNm != null and acpDvsnNm != ""'>
				<![CDATA[
				   AND T2.ACP_DVSN_CD = #{acpDvsnNm}
				]]>
			</if>
			
			
		<![CDATA[
		    GROUP BY T1.MTRL_SRNO
			ORDER BY MIN(F_CODE_NM('1000989',NVL(T2.ACP_DVSN_CD, '10'))) , MIN(T1.SMT_DT) DESC
		]]>
		<include refid="include.pageOrder" />
	</select>
	
	<select id="selectDetailList" parameterType="paramMap"
		resultType="egovMap">
		/* DCMADM002EMapper.selectDetailList 감사자료 제출 요구 목록 조회 */
		<![CDATA[
			SELECT T2.IDVT_MTRL_SRNO,
					T2.MTRL_SRNO
			      ,T2.FL_NM
			      ,T2.FL_HASH
			      ,T2.DOC_ID
			      ,T2.FL_DNV
			      ,T2.FL_SIGN
			      ,T2.FL_CPT
			      ,NVL(T2.ACP_DVSN_CD, '10') AS ACP_DVSN_CD
			      ,F_CODE_NM('1000989',NVL(T2.ACP_DVSN_CD, '10')) AS ACP_DVSN_NM
			      ,T2.SHAR_DVSN_CD
			      ,T2.CERT_CRE_YN
			      ,T2.PSN_INF_ICLS_YN
			      ,T2.CLC_TM_CD
			      ,T2.CLC_PPS_CD
			      ,T2.MTRL_TYP_CD
			      ,TO_CHAR(TO_DATE(T1.SMT_DT),'YYYY-MM-DD') AS SMT_DT
			      ,T1.SMT_ORG_NM
			      ,T1.CRT_DVSN_CD
			      ,F_CODE_NM('1000983', T1.CRT_DVSN_CD) AS CRT_DVSN_NM
			      ,F_CODE_NM('1000991',T1.SMT_DVSN_CD) AS SMT_DVSN_NM
			      ,NVL(T2.DEL_YN,'N') AS DEL_YN
			      ,T2.CERT_DOC_ID
			  FROM TBDCMADM002M T1
			         , TBDCMADM003M T2 
			 WHERE 1=1
			  AND T1.MTRL_SRNO = #{mtrlSrno}
			  AND T1.MTRL_SRNO = T2.MTRL_SRNO
		]]>
		<![CDATA[
			ORDER BY T2.IDVT_MTRL_SRNO ASC
		]]>
	</select>
	
	<update id="save" parameterType="paramMap">
	/* DCMADM002EMapper.save 감사자료 제출 개별건 저장 */
		<![CDATA[
			UPDATE TBDCMADM003M
       			SET	PSN_INF_ICLS_YN = #{psnInfIclsYn}
       				   ,CLC_TM_CD = #{clcTmCd}
       				   ,CLC_PPS_CD = #{clcPpsCd}
       				   ,MTRL_TYP_CD = #{mtrlTypCd}
       				   ,SHAR_DVSN_CD = #{sharDvsnCd}
       					,FNL_USR_ID = #{fnlUsrId}
       					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
       					,FNL_MNU_ID = #{fnlMnuId}
       					,FNL_MDF_DH = SYSDATE
       		 WHERE MTRL_SRNO = #{mtrlSrno}
       		   AND IDVT_MTRL_SRNO = #{idvtMtrlSrno}
		]]>
	</update>
	
	<update id="receipt" parameterType="paramMap">
	/* DCMADM002EMapper.receipt 감사자료 제출 개별건 접수 */
		<![CDATA[
			UPDATE TBDCMADM003M
       			SET	PSN_INF_ICLS_YN = #{psnInfIclsYn}
       				   ,CLC_TM_CD = #{clcTmCd}
       				   ,CLC_PPS_CD = #{clcPpsCd}
       				   ,MTRL_TYP_CD = #{mtrlTypCd}
       				   ,SHAR_DVSN_CD = #{sharDvsnCd}
       			       ,ACP_DVSN_CD = '20'
       			       ,FNL_USR_ID = #{fnlUsrId}
       					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
       					,FNL_MNU_ID = #{fnlMnuId}
       					,FNL_MDF_DH = SYSDATE
       		 WHERE MTRL_SRNO = #{mtrlSrno}
       		   AND IDVT_MTRL_SRNO = #{idvtMtrlSrno}
		]]>
	</update>
	
	
	<select id="selectTranList" parameterType="paramMap"
		resultType="egovMap">
		/* DCMADM002EMapper.selectTranList 감사자료 제출 이송 목록 조회 */
		<![CDATA[
			SELECT T3.IDVT_MTRL_SRNO,
					T3.MTRL_SRNO
			      ,T3.SRNO
			      ,T3.TSK_DVSN_CD
			      ,F_CODE_NM('1000990', T3.TSK_DVSN_CD) AS TSK_DVSN_NM
			      ,CASE WHEN TSK_DVSN_CD ='40' THEN '10'
			      			 WHEN TSK_DVSN_CD ='50' THEN '10' 
			      			 ELSE TSK_DVSN_CD
						      END||T3.EVI_DCM_DVSN_CD as EVI_DCM_DVSN_CD
			      ,CASE WHEN T3.TSK_DVSN_CD = '10' THEN F_MNG_KND_AUDYRNO(T3.YE_KY, T3.NO_KY, NULL, '-') 
			           WHEN T3.TSK_DVSN_CD = '20' THEN T3.YE_KY ||'-심사-'||T3.NO_KY
			           WHEN T3.TSK_DVSN_CD = '30' THEN T3.YE_KY ||'-재심-'||T3.NO_KY
			           WHEN T3.TSK_DVSN_CD = '40' THEN (SELECT S1.ACP_YR||'-'||F_CODE_NM('1000949', S1.RM_ACP_KND_CD) ||'-'||S1.RM_CVPT_ACP_NO FROM TBCSPDCP101M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.REQ_DVSN_CD = '1' AND S1.CVPT_ACP_NO = T3.NO_KY)
			           WHEN T3.TSK_DVSN_CD = '50' THEN (SELECT S1.ACP_YR||'-'||DECODE(S1.REQ_DVSN_CD ,'2','국민','3','공익')||'-'||substring(S1.CVPT_ACP_NO, 3, 3) FROM TBCSPDCP101M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.REQ_DVSN_CD = T3.DVSN_KY AND S1.CVPT_ACP_NO = T3.NO_KY)
			        ELSE '' END AS AUD_YR_NO
			      ,T3.YE_KY
			      ,T3.DVSN_KY
			      ,T3.NO_KY
			      ,T2.DOC_ID
			      ,T3.DOC_ID AS TRAN_DOC_ID
			      ,CASE WHEN T3.TSK_DVSN_CD = '10' THEN (SELECT S1.AUD_SBJ_NM FROM TBBADDED001M S1 WHERE S1.AUD_YR = T3.YE_KY AND S1.AUD_NO = T3.NO_KY)
			              WHEN T3.TSK_DVSN_CD IN ( '20', '30') THEN (SELECT S1.TIT_NM FROM TBBADFRE012M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.ACP_SRNO = T3.NO_KY AND S1.ACP_DVSN_CD = T3.DVSN_KY)
			              WHEN T3.TSK_DVSN_CD = '40' THEN (SELECT S1.TIT_NM FROM TBCSPDCP101M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.REQ_DVSN_CD = '1' AND S1.CVPT_ACP_NO = T3.NO_KY)
			              WHEN T3.TSK_DVSN_CD = '50' THEN (SELECT S1.TIT_NM FROM TBCSPDCP101M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.REQ_DVSN_CD = T3.DVSN_KY AND S1.CVPT_ACP_NO = T3.NO_KY)
			         ELSE NULL END AS TIT_NM
			      ,TO_CHAR(TO_DATE(T3.TRNF_DT),'YYYY-MM-DD') AS TRNF_DT 
			      ,T2.FL_NM
			      ,T2.PSN_INF_ICLS_YN
			      ,T2.FL_CPT
			      ,T2.DEL_YN
			      ,T2.CERT_DOC_ID
			      ,T3.CERT_DOC_ID AS TRAN_CERT_DOC_ID
			      ,T3.CERT_ICLS_YN
			      ,T2.CERT_CRE_YN
			      ,T3.EVI_DCMB_SNO AS EVI_DCMB_SNO
			  FROM TBDCMADM002M T1
			         , TBDCMADM003M T2 
			         ,TBDCMADM004M T3
			 WHERE 1=1
			  AND T1.MTRL_SRNO = #{mtrlSrno}
			  AND T2.IDVT_MTRL_SRNO = #{idvtMtrlSrno}
			  AND T1.MTRL_SRNO = T2.MTRL_SRNO
			  AND T2.MTRL_SRNO = T3.MTRL_SRNO
			  AND T2.IDVT_MTRL_SRNO = T3.IDVT_MTRL_SRNO
			   AND T3.FRT_USR_ID = #{fnlUsrId} 
		]]>
		<![CDATA[
			ORDER BY T3.SRNO ASC
		]]>
	</select>
	
	<select id="selectTranKey" parameterType="paramMap" resultType="Integer">
		SELECT NVL(MAX(SRNO),0) +1 FROM TBDCMADM004M S1 WHERE S1.IDVT_MTRL_SRNO = #{idvtMtrlSrno} AND S1.MTRL_SRNO = #{mtrlSrno}	
	</select>
	
	<insert id="tranInsert" parameterType="paramMap">
		<![CDATA[
			INSERT INTO TBDCMADM004M
			( IDVT_MTRL_SRNO
			 ,MTRL_SRNO
			 ,SRNO
			 ,TSK_DVSN_CD
			 ,EVI_DCM_DVSN_CD
			 ,YE_KY
			 ,DVSN_KY
			 ,NO_KY
			 ,CERT_ICLS_YN
			 ,FRT_USR_ID
			,FNL_USR_ID
			,FNL_DEAL_DPT_CD
			,FNL_MNU_ID
			,FRT_REGI_DH
			,FNL_MDF_DH
			,EVI_DCMB_SNO
			) VALUES (
			 #{idvtMtrlSrno}
			 ,#{mtrlSrno}
			 ,#{srno}
			 ,#{tskDvsnCd}
			 ,#{eviDcmDvsnCd}
			 ,#{yeKy}
			 ,#{dvsnKy}
			 ,#{noKy}
			 ,#{certIclsYn}
			 ,#{fnlUsrId}
									, #{fnlUsrId}
									, #{fnlDealDptCd}
									, #{fnlMnuId}
									,SYSDATE
									,SYSDATE
			 ,#{eviDcmbSno}
			)
		]]>
	</insert>
	
	<update id="tranUpdate" parameterType="paramMap">
		<![CDATA[
			UPDATE TBDCMADM004M
			  SET TSK_DVSN_CD = #{tskDvsnCd}
			     , EVI_DCM_DVSN_CD = #{eviDcmDvsnCd}
			     ,YE_KY = #{yeKy}
			     ,DVSN_KY = #{dvsnKy}
			     ,NO_KY = #{noKy}
			     ,CERT_ICLS_YN =  #{certIclsYn}
			     ,FNL_USR_ID = #{fnlUsrId}
			     , FNL_DEAL_DPT_CD = #{fnlDealDptCd}
			     , FNL_MNU_ID = #{fnlMnuId}
			     ,FNL_MDF_DH = SYSDATE
			     ,EVI_DCMB_SNO = #{eviDcmbSno}
			 WHERE IDVT_MTRL_SRNO = #{idvtMtrlSrno}
			   AND MTRL_SRNO = #{mtrlSrno}
			   AND SRNO  = #{srno}
		]]>
	</update>
	
	<update id="tranSendUpdate" parameterType="paramMap">
		<![CDATA[
			UPDATE TBDCMADM004M
			  SET TRNF_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
			   ,DOC_ID = #{tranDocId}
			   ,CERT_DOC_ID = #{tranCertDocId}
			     ,FNL_USR_ID = #{fnlUsrId}
			     , FNL_DEAL_DPT_CD = #{fnlDealDptCd}
			     , FNL_MNU_ID = #{fnlMnuId}
			     ,FNL_MDF_DH = SYSDATE
			 WHERE IDVT_MTRL_SRNO = #{idvtMtrlSrno}
			   AND MTRL_SRNO = #{mtrlSrno}
			   AND SRNO  = #{srno}
		]]>
	</update>
	
	
	
	<insert id="insertAudTran" parameterType="paramMap">
		<![CDATA[
			INSERT INTO TBBADDED108D
        (
            AUD_YR /*감사년도 */
            ,AUD_NO /*감사번호*/ 
            ,EVI_DCMB_SNO	/*감사서류함순번 */
            ,AUD_DCM_DOC_ID	/*감사서류문서ID */
            ,AUD_KND_CD	/*감사종류코드 */
            ,AUD_GRN_NO	/*감사부여코드 */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,EVI_DCMB_DVSN_CD	/*감사서류구분코드 */
            ,AUD_DCM_CRE_ID	/*감사서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
            ,EVI_DCM_NO
            ,DOC_STA_CD
            ,EVI_DCM_GRP_SNO
            ,PERS_INF_INC_CD
        ) VALUES (
        	#{yeKy}
        	,#{noKy}
        	,'1000000000'
        	,#{tranDocId}
        	,(SELECT S1.AUD_KND_CD FROM TBBADDED001M S1 WHERE S1.AUD_YR = #{yeKy} AND S1.AUD_NO = #{noKy} )
        	,(SELECT S1.AUD_GRN_NO FROM TBBADDED001M S1 WHERE S1.AUD_YR = #{yeKy} AND S1.AUD_NO = #{noKy} )
        	,#{eviDcmDvsnCd}
        	,#{flNm}
        	,'10'
        	,#{fnlUsrId}
        	,(SELECT NVL(MAX(SORT_SNO),0)+1 
                 FROM TBBADDED108D
                  WHERE AUD_YR = #{yeKy}
                  AND AUD_NO = #{noKy}
              )
           ,#{fnlUsrId}
			, #{fnlUsrId}
			, #{fnlDealDptCd}
			, #{fnlMnuId}
			,SYSDATE
			,SYSDATE
           ,#{flCpt}
           ,(SELECT LPAD(NVL(MAX(TO_NUMBER(NVL(EVI_DCM_NO,0))),0)+1,4,'0')
                 FROM TBBADDED108D
                  WHERE AUD_YR = #{yeKy}
                  AND AUD_NO = #{noKy}
                  AND EVI_DCM_DVSN_CD = #{eviDcmDvsnCd}
              )
              ,'Y'
              ,''
              ,CASE WHEN #{psnInfIclsYn} = 'Y' THEN '10' ELSE '20' END 
        )
		]]>
	</insert>
	
	
	<insert id="insertAudTranCert" parameterType="paramMap">
		<![CDATA[
			INSERT INTO TBBADDED108D
        (
            AUD_YR /*감사년도 */
            ,AUD_NO /*감사번호*/ 
            ,EVI_DCMB_SNO	/*감사서류함순번 */
            ,AUD_DCM_DOC_ID	/*감사서류문서ID */
            ,AUD_KND_CD	/*감사종류코드 */
            ,AUD_GRN_NO	/*감사부여코드 */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,EVI_DCMB_DVSN_CD	/*감사서류구분코드 */
            ,AUD_DCM_CRE_ID	/*감사서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
            ,EVI_DCM_NO
            ,DOC_STA_CD
            ,EVI_DCM_GRP_SNO
            ,PERS_INF_INC_CD
        ) VALUES (
        	#{yeKy}
        	,#{noKy}
        	,'1000000000'
        	,#{tranCertDocId}
        	,(SELECT S1.AUD_KND_CD FROM TBBADDED001M S1 WHERE S1.AUD_YR = #{yeKy} AND S1.AUD_NO = #{noKy} )
        	,(SELECT S1.AUD_GRN_NO FROM TBBADDED001M S1 WHERE S1.AUD_YR = #{yeKy} AND S1.AUD_NO = #{noKy} )
        	,#{eviDcmDvsnCd}
        	,#{certFlNm}
        	,'10'
        	,#{fnlUsrId}
        	,(SELECT NVL(MAX(SORT_SNO),0)+1 
                 FROM TBBADDED108D
                  WHERE AUD_YR = #{yeKy}
                  AND AUD_NO = #{noKy}
              )
           ,#{fnlUsrId}
			, #{fnlUsrId}
			, #{fnlDealDptCd}
			, #{fnlMnuId}
			,SYSDATE
			,SYSDATE
           ,#{certFlCpt}
           ,(SELECT LPAD(NVL(MAX(TO_NUMBER(NVL(EVI_DCM_NO,0))),0)+1,4,'0')
                 FROM TBBADDED108D
                  WHERE AUD_YR = #{yeKy}
                  AND AUD_NO = #{noKy}
                  AND EVI_DCM_DVSN_CD = #{eviDcmDvsnCd}
              )
              ,'Y'
              ,''
              ,'20'
        )
		]]>
	</insert>
	
	
	<insert id="insertTran2" parameterType="paramMap">
		<![CDATA[
			INSERT INTO TBBADFRE108D
        (
            ACP_YR /*감사년도 */
            ,ACP_SRNO /*감사번호*/
            ,EVI_DCMB_SNO	/*감사서류함순번 */
            ,ACP_DCM_DOC_ID	/*감사서류문서ID */
            ,ACP_DVSN_CD	/*감사종류코드 */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,ACP_DCM_CRE_ID	/*감사서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
        ) VALUES (
        	#{yeKy}
        	,#{noKy}
        	,'1'
        	,#{tranDocId}
        	,#{dvsnKy}
        	,#{eviDcmDvsnCd}
        	,#{flNm}
        	,#{fnlUsrId}
        	,(SELECT NVL(MAX(SORT_SNO),0)+1 
                 FROM TBBADFRE108D
                  WHERE ACP_YR = #{yeKy}
                  AND ACP_SRNO = #{noKy}
                  AND EVI_DCMB_SNO = '1'
              )
           ,#{fnlUsrId}
			, #{fnlUsrId}
			, #{fnlDealDptCd}
			, #{fnlMnuId}
			,SYSDATE
			,SYSDATE
           ,#{flCpt}
        )
		]]>
	</insert>
	
	<insert id="insertTran2Cert" parameterType="paramMap">
		<![CDATA[
			INSERT INTO TBBADFRE108D
        (
            ACP_YR /*감사년도 */
            ,ACP_SRNO /*감사번호*/
            ,EVI_DCMB_SNO	/*감사서류함순번 */
            ,ACP_DCM_DOC_ID	/*감사서류문서ID */
            ,ACP_DVSN_CD	/*감사종류코드 */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,ACP_DCM_CRE_ID	/*감사서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
        ) VALUES (
        	#{yeKy}
        	,#{noKy}
        	,'1'
        	,#{tranCertDocId}
        	,#{dvsnKy}
        	,#{eviDcmDvsnCd}
        	,#{certFlNm}
        	,#{fnlUsrId}
        	,(SELECT NVL(MAX(SORT_SNO),0)+1 
                 FROM TBBADFRE108D
                  WHERE ACP_YR = #{yeKy}
                  AND ACP_SRNO = #{noKy}
                  AND EVI_DCMB_SNO = '1'
              )
           ,#{fnlUsrId}
			, #{fnlUsrId}
			, #{fnlDealDptCd}
			, #{fnlMnuId}
			,SYSDATE
			,SYSDATE
           ,#{certFlCpt}
        )
		]]>
	</insert>
	
	
	<select id="selectTbcspdcp608m" parameterType="paramMap" resultType="egovMap">
		<![CDATA[
			SELECT t1.EVI_DCMB_SNO, T1.SRNO
			FROM TBCSPDCP608M T1
			WHERE T1.ACP_YR = #{yeKy}
			  AND T1.CVPT_ACP_NO = #{noKy}
			  AND T1.REQ_DVSN_CD = '1'
			  AND T1.FOLDER_NM = '감사자료 이송' 
			  AND ROWNUM = 1
			  
		]]>
	</select>	
	
	<insert id="insertTbcspdcp608m" parameterType="paramMap">
		 INSERT INTO TBCSPDCP608M
        (
            ACP_YR  /*접수년도 */
            ,REQ_DVSN_CD /*구분코드 */
            ,CVPT_ACP_NO /*접수번호 */
            ,EVI_DCMB_SNO   /*서류함순번 */
            ,FOLDER_NM  /*폴더명 */
            ,SORT_SNO   /*정렬순번 */
            ,FRT_USR_ID  /*최초사용자ID */
            ,FNL_USR_ID /*최종사용자ID */
            ,FNL_DEAL_DPT_CD    /*최종거래부서코드 */
            ,FNL_MNU_ID /*최종메뉴ID */
            ,FRT_REGI_DH    /*최초등록일시 */
            ,FNL_MDF_DH /*최종수정일시 */
            ,SRNO
        )
        values
        (
            #{yeKy}         /*접수년도 */
            ,'1'  /*구분코드 */
            ,#{noKy}  /*접수번호 */
            ,#{eviDcmbSno}  /*서류함순번 */
            ,'감사자료 이송'  /*폴더명 */
            ,(SELECT NVL(MAX(SORT_SNO),0)+1
                 FROM TBCSPDCP608M
                  WHERE ACP_YR =#{yeKy}  
                  AND REQ_DVSN_CD = '1'
                  AND CVPT_ACP_NO =#{noKy} /*정렬순번 */
              )
           ,#{fnlUsrId}
			, #{fnlUsrId}
			, #{fnlDealDptCd}
			, #{fnlMnuId}
			,SYSDATE
			,SYSDATE
            ,''
        ) 
	</insert>
	
	<select id="selectTbcspdcp608mKey" parameterType="paramMap" resultType="Integer">
		SELECT NVL(MAX(EVI_DCMB_SNO),0)+1 FROM TBCSPDCP608M
	</select>
	
	<insert id="insertTran3" parameterType="paramMap">
		<![CDATA[
			INSERT INTO TBCSPDCP608D
        (
            ACP_YR /*접수년도 */
            ,REQ_DVSN_CD /*구분코드 */
            ,CVPT_ACP_NO /*접수번호*/
            ,EVI_DCMB_SNO	/*서류함순번 */
            ,ACP_DCM_DOC_ID	/*서류문서ID */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,EVI_DCMB_DVSN_CD	/*서류구분코드 */
            ,ACP_DCM_CRE_ID	/*서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
            ,SRNO
        ) VALUES (
        	#{yeKy}
        	,'1'
        	,#{noKy}
        	,#{eviDcmbSno}
        	,#{tranDocId}
        	,#{eviDcmDvsnCd}
        	,#{flNm}
        	,'10'
        	,#{fnlUsrId}
        	,(SELECT NVL(MAX(SORT_SNO),0)+1
                 FROM TBCSPDCP608D
                  WHERE ACP_YR = #{yeKy}
                  AND REQ_DVSN_CD = '1'
                  AND CVPT_ACP_NO = #{noKy}
                  AND EVI_DCMB_SNO = #{eviDcmbSno} /*정렬순번 */
              )
           ,#{fnlUsrId}
			, #{fnlUsrId}
			, #{fnlDealDptCd}
			, #{fnlMnuId}
			,SYSDATE
			,SYSDATE
           ,#{flCpt}
           ,nvl(#{srno},'1')
        )
		]]>
	</insert>
	
	<insert id="insertTran3Cert" parameterType="paramMap">
		<![CDATA[
			INSERT INTO TBCSPDCP608D
        (
            ACP_YR /*접수년도 */
            ,REQ_DVSN_CD /*구분코드 */
            ,CVPT_ACP_NO /*접수번호*/
            ,EVI_DCMB_SNO	/*서류함순번 */
            ,ACP_DCM_DOC_ID	/*서류문서ID */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,EVI_DCMB_DVSN_CD	/*서류구분코드 */
            ,ACP_DCM_CRE_ID	/*서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
            ,SRNO
        ) VALUES (
        	#{yeKy}
        	,'1'
        	,#{noKy}
        	,#{eviDcmbSno}
        	,#{tranCertDocId}
        	,#{eviDcmDvsnCd}
        	,#{certFlNm}
        	,'10'
        	,#{fnlUsrId}
        	,(SELECT NVL(MAX(SORT_SNO),0)+1
                 FROM TBCSPDCP608D
                  WHERE ACP_YR = #{yeKy}
                  AND REQ_DVSN_CD = '1'
                  AND CVPT_ACP_NO = #{noKy}
                  AND EVI_DCMB_SNO = #{eviDcmbSno} /*정렬순번 */
              )
           ,#{fnlUsrId}
			, #{fnlUsrId}
			, #{fnlDealDptCd}
			, #{fnlMnuId}
			,SYSDATE
			,SYSDATE
           ,#{certFlCpt}
           ,nvl(#{srno},'1')
        )
		]]>
	</insert>
	
	<insert id="insertTran4" parameterType="paramMap">
		/*DCMADM002EMapper.insertTran4*/
		<![CDATA[
			INSERT INTO TBCSPDCP608D
        (
            ACP_YR /*접수년도 */
            ,REQ_DVSN_CD /*구분코드 */
            ,CVPT_ACP_NO /*접수번호*/
            ,EVI_DCMB_SNO	/*기타서류함순번 */
            ,ACP_DCM_DOC_ID	/*서류문서ID */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,EVI_DCMB_DVSN_CD	/*서류구분코드 */
            ,ACP_DCM_CRE_ID	/*서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
            ,SRNO
        ) VALUES (
        	#{yeKy}
        	,#{dvsnKy}
        	,#{noKy}
        	,#{reqEviDcmbSno}
        	,#{tranDocId}
        	,#{eviDcmDvsnCd}
        	,#{flNm}
        	,'10'
        	,#{fnlUsrId}
        	,(SELECT NVL(MAX(SORT_SNO),0)+1
                 FROM TBCSPDCP608D
                  WHERE ACP_YR = #{yeKy}
                  AND REQ_DVSN_CD = #{dvsnKy}
                  AND CVPT_ACP_NO = #{noKy}
                  AND EVI_DCMB_SNO = #{reqEviDcmbSno} /*정렬순번 */
              )
           ,#{fnlUsrId}
			, #{fnlUsrId}
			, #{fnlDealDptCd}
			, #{fnlMnuId}
			,SYSDATE
			,SYSDATE
           ,#{flCpt}
           ,nvl(#{srno},'1')
        )
		]]>
	</insert>
	
	<insert id="insertTran4Cert" parameterType="paramMap">
		/*DCMADM002EMapper.insertTran4Cert*/
		<![CDATA[
			INSERT INTO TBCSPDCP608D
        (
            ACP_YR /*접수년도 */
            ,REQ_DVSN_CD /*구분코드 */
            ,CVPT_ACP_NO /*접수번호*/
            ,EVI_DCMB_SNO	/*서류함순번 */
            ,ACP_DCM_DOC_ID	/*서류문서ID */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,EVI_DCMB_DVSN_CD	/*서류구분코드 */
            ,ACP_DCM_CRE_ID	/*서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
            ,SRNO
        ) VALUES (
        	#{yeKy}
        	,#{dvsnKy}
        	,#{noKy}
        	,#{reqEviDcmbSno}
        	,#{tranCertDocId}
        	,#{eviDcmDvsnCd}
        	,#{certFlNm}
        	,'10'
        	,#{fnlUsrId}
        	,(SELECT NVL(MAX(SORT_SNO),0)+1
                 FROM TBCSPDCP608D
                  WHERE ACP_YR = #{yeKy}
                  AND REQ_DVSN_CD = #{dvsnKy}
                  AND CVPT_ACP_NO = #{noKy}
                  AND EVI_DCMB_SNO = #{reqEviDcmbSno} /*정렬순번 */
              )
           ,#{fnlUsrId}
			, #{fnlUsrId}
			, #{fnlDealDptCd}
			, #{fnlMnuId}
			,SYSDATE
			,SYSDATE
           ,#{certFlCpt}
           ,nvl(#{srno},'1')
        )
		]]>
	</insert>
	
	<update id="delete" parameterType="paramMap">
		<![CDATA[
			UPDATE TBDCMADM003M
       			SET	DEL_YN = 'Y'
       		 WHERE MTRL_SRNO = #{mtrlSrno}
       		   AND IDVT_MTRL_SRNO = #{idvtMtrlSrno}
		]]>
	</update>
	
	
	<select id="selectCertData" parameterType="paramMap" resultType="egovMap">
		<![CDATA[
			SELECT T2.IDVT_MTRL_SRNO,
					T2.MTRL_SRNO
			      ,T2.FL_NM
			      ,T2.FL_HASH
			      ,T2.DOC_ID
			      ,T2.FL_DNV
			      ,T2.FL_SIGN
			      ,T2.FL_CPT
			      ,NVL(T2.ACP_DVSN_CD, '10') AS ACP_DVSN_CD
			      ,F_CODE_NM('1000989',NVL(T2.ACP_DVSN_CD, '10')) AS ACP_DVSN_NM
			      ,T2.SHAR_DVSN_CD
			      ,T2.CERT_CRE_YN
			      ,T2.PSN_INF_ICLS_YN
			      ,T2.CLC_TM_CD
			      ,T2.CLC_PPS_CD
			      ,T2.MTRL_TYP_CD
			      ,TO_CHAR(TO_DATE(T1.SMT_DT),'YYYY. MM. DD') AS SMT_DT
			      ,T1.SMT_ORG_NM
			      ,T1.CRT_DVSN_CD
			      ,F_CODE_NM('1000983', T1.CRT_DVSN_CD) AS CRT_DVSN_NM
			      ,F_CODE_NM('1000991',T1.SMT_DVSN_CD) AS SMT_DVSN_NM
			      ,T1.PRSR_NM  ,T1.SMT_ORG_NM
			      ,NVL(T2.DEL_YN,'N') AS DEL_YN
			      ,TO_CHAR(T1.FRT_REGI_DH, 'YYYY.MM.DD HH24:MI') AS CREATE_DT
			      ,TO_CHAR(SYSDATE,'YYYY. MM. DD.') AS TODAY
			      
			      ,T2.CERT_DOC_ID
			      ,T2.CERT_CRE_DH
			      ,TO_CHAR(CERT_CRE_DH,'YYYY. MM. DD.') AS CERT_CRE_DT
			  FROM TBDCMADM002M T1
			         , TBDCMADM003M T2 
			 WHERE 1=1
			  AND T1.MTRL_SRNO = #{mtrlSrno}
			  AND T1.MTRL_SRNO = T2.MTRL_SRNO
			  AND T2.IDVT_MTRL_SRNO = #{idvtMtrlSrno}
		]]>
	</select>
	
	<update id="updateCertFile" parameterType="paramMap">
		<![CDATA[
			UPDATE TBDCMADM003M
       			SET	CERT_DOC_ID = #{certDocId}
       			       ,CERT_CRE_DH = SYSDATE
       			       ,CERT_CRE_YN = 'Y'
       		 WHERE MTRL_SRNO = #{mtrlSrno}
       		   AND IDVT_MTRL_SRNO = #{idvtMtrlSrno}
		]]>
	</update>
	
	<select id="selectTranInfo" parameterType="paramMap"
		resultType="egovMap">
		/* DCMADM002EMapper.selectTranList 감사자료 제출 이송 목록 조회 */
		<![CDATA[
			SELECT T3.IDVT_MTRL_SRNO,
					T3.MTRL_SRNO
			      ,T3.SRNO
			      ,T3.TSK_DVSN_CD
			      ,F_CODE_NM('1000990', T3.TSK_DVSN_CD) AS TSK_DVSN_NM
			      ,CASE WHEN TSK_DVSN_CD ='40' THEN '10'
			      			 WHEN TSK_DVSN_CD ='50' THEN '10' 
			      			 ELSE TSK_DVSN_CD
						      END||T3.EVI_DCM_DVSN_CD as EVI_DCM_DVSN_CD
			      ,CASE WHEN T3.TSK_DVSN_CD = '10' THEN F_MNG_KND_AUDYRNO(T3.YE_KY, T3.NO_KY, NULL, '-') 
			           WHEN T3.TSK_DVSN_CD = '20' THEN T3.YE_KY ||'-심사-'||T3.NO_KY
			           WHEN T3.TSK_DVSN_CD = '30' THEN T3.YE_KY ||'-재심-'||T3.NO_KY
			           WHEN T3.TSK_DVSN_CD = '40' THEN (SELECT S1.ACP_YR||'-'||F_CODE_NM('1000949', S1.RM_ACP_KND_CD) ||'-'||S1.RM_CVPT_ACP_NO FROM TBCSPDCP101M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.REQ_DVSN_CD = '1' AND S1.CVPT_ACP_NO = T3.NO_KY)
			           WHEN T3.TSK_DVSN_CD = '50' THEN (SELECT S1.ACP_YR||'-'||DECODE(S1.REQ_DVSN_CD ,'2','국민','3','공익')||'-'||substring(S1.CVPT_ACP_NO, 3, 3) FROM TBCSPDCP101M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.REQ_DVSN_CD = T3.DVSN_KY AND S1.CVPT_ACP_NO = T3.NO_KY)
			        ELSE '' END AS AUD_YR_NO
			      ,T3.YE_KY
			      ,T3.DVSN_KY
			      ,T3.NO_KY
			      ,T2.DOC_ID
			      ,T3.DOC_ID AS TRAN_DOC_ID
			      ,CASE WHEN T3.TSK_DVSN_CD = '10' THEN (SELECT S1.AUD_SBJ_NM FROM TBBADDED001M S1 WHERE S1.AUD_YR = T3.YE_KY AND S1.AUD_NO = T3.NO_KY)
			              WHEN T3.TSK_DVSN_CD IN ( '20', '30') THEN (SELECT S1.TIT_NM FROM TBBADFRE012M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.ACP_SRNO = T3.NO_KY AND S1.ACP_DVSN_CD = T3.DVSN_KY)
			              WHEN T3.TSK_DVSN_CD = '40' THEN (SELECT S1.TIT_NM FROM TBCSPDCP101M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.REQ_DVSN_CD = '1' AND S1.CVPT_ACP_NO = T3.NO_KY)
			              WHEN T3.TSK_DVSN_CD = '50' THEN (SELECT S1.TIT_NM FROM TBCSPDCP101M S1 WHERE S1.ACP_YR = T3.YE_KY AND S1.REQ_DVSN_CD = T3.DVSN_KY AND S1.CVPT_ACP_NO = T3.NO_KY)
			         ELSE NULL END AS TIT_NM
			      ,TO_CHAR(TO_DATE(T3.TRNF_DT),'YYYY-MM-DD') AS TRNF_DT 
			      ,T2.FL_NM
			      ,T2.PSN_INF_ICLS_YN
			      ,T2.FL_CPT
			      ,T2.DEL_YN
			      ,T2.CERT_DOC_ID
			      ,T3.CERT_DOC_ID AS TRAN_CERT_DOC_ID
			      ,T3.CERT_ICLS_YN
			      ,T2.CERT_CRE_YN
			      ,T3.EVI_DCMB_SNO AS EVI_DCMB_SNO
			  FROM TBDCMADM002M T1
			         , TBDCMADM003M T2 
			         ,TBDCMADM004M T3
			 WHERE 1=1
			  AND T1.MTRL_SRNO = #{mtrlSrno}
			  AND T2.IDVT_MTRL_SRNO = #{idvtMtrlSrno}
			  AND T1.MTRL_SRNO = T2.MTRL_SRNO
			  AND T2.MTRL_SRNO = T3.MTRL_SRNO
			  AND T2.IDVT_MTRL_SRNO = T3.IDVT_MTRL_SRNO
			   AND T3.FRT_USR_ID = #{fnlUsrId} 
			   AND T3.SRNO = #{srno}
		]]>
	</select>
	
	
</mapper>
