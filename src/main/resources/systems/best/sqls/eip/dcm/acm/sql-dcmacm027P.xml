<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.dcm.acm.dao.DCMACM027PMapper">

    <insert id="saveEdtAuth" parameterType="paramMap">
     /* kr.go.bai.eip.dcm.acm.dao.DCMACM027PMapper.saveEdtAuth */
		INSERT INTO TBDCMACM202M
		(
			 AUTH_SEQ
			,AUD_YR
			,AUD_NO
			,AUD_STEP_CD
			,DOC_ID
			,EDT_CNB
			,EDT_RANK_CD
			,EDT_PST_CD
			,REASON
			,FRT_USR_ID
			,FNL_USR_ID
			,FNL_DEAL_DPT_CD
			,FNL_MNU_ID
			,FRT_REGI_DH
			,FNL_MDF_DH
		)
		VALUES
		(
			(SELECT NVL(MAX(AUTH_SEQ),0)+1 FROM TBDCMACM202M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND DOC_ID = #{docId})
			, #{audYr}
			, #{audNo}
			, #{audStepCd}
			, #{docId}
			, #{edtCnb}
			, #{edtRankCd}
			, #{edtPstCd}
			, #{reason}
			, #{usrId}
			, #{usrId}
			, #{dptCd}
			, #{menuNo}
			, SYSDATE
			, SYSDATE
		)
	</insert>
	
	<delete id="deleteEdtAuth" parameterType="paramMap">
        /*kr.go.bai.eip.dcm.acm.dao.DCMACM027PMapper.deleteEdtAuth*/
        DELETE 
          FROM TBDCMACM202M 
         WHERE AUTH_SEQ = #{authSeq}
           AND AUD_YR = #{audYr}
		   AND AUD_NO = #{audNo}
	       AND DOC_ID = #{docId}
    </delete>
	
	<insert id="saveEdtAuthHis" parameterType="paramMap">
       /* kr.go.bai.eip.dcm.acm.dao.DCMACM027PMapper.saveEdtAuthHis */
		INSERT INTO TBDCMACM202H
		(
			 AUTH_SEQ
			,AUD_YR
			,AUD_NO
			,AUD_STEP_CD
			,DOC_ID
			,EDT_CNB
			,EDT_RANK_CD
			,EDT_PST_CD
			,EDT_AUTH
			,REASON
			,FRT_USR_ID
			,FNL_USR_ID
			,FNL_DEAL_DPT_CD
			,FNL_MNU_ID
			,FRT_REGI_DH
			,FNL_MDF_DH
		)
		VALUES
		(
			(SELECT NVL(MAX(AUTH_SEQ),0)+1 FROM TBDCMACM202H)
			, #{audYr}
			, #{audNo}
			, #{audStepCd}
			, #{docId}
			, #{edtCnb}
			, #{edtRankCd}
			, #{edtPstCd}
			, #{edtAuth}
			, #{reason}
			, #{usrId}
			, #{usrId}
			, #{dptCd}
			, #{menuNo}
			, SYSDATE
			, SYSDATE
		)
	</insert>
	
	
	
	<!-- 사용자조회 팝업 -->
	<select id="dcmacm027PUsrSelect" parameterType="paramMap" resultType="egovMap">
	<include refid="include.pageSelct" />
	/* kr.go.bai.eip.dcm.acm.dao.DCMACM027PMapper.dcmacm027PUsrSelect */
	<![CDATA[
       SELECT A.USR_DVSN_CD
            , A.ORG_CD
            , F_ORG_INFO(A.ORG_CD,'1') AS ORG_NM
            , A.CNB                    AS EDT_CNB
            , A.DPT_CD
            , F_DPT_INFO(A.DPT_CD,'1') AS DPT_NM
            , A.USR_ID
            , A.USR_NAM
            , A.RQS_STA_CD
            , A.RLS_DT
            , A.TNB
            , A.RANK_CD                      AS EDT_RANK_CD
            , F_CODE_NM('1000173',A.RANK_CD) AS RANK_NM
            , A.PST_CD                       AS EDT_PST_CD
            , F_CODE_NM('1000176',A.PST_CD)  AS PST_NM
            , A.EIN
            , SUBSTR(A.EIN,0,6)||'-*******' AS P_EIN
            , A.EML_AD
            , F_CODE_NM('1000338',A.USR_DVSN_CD) AS USR_DVSN_NM
            , A.BAI_USR_YN
            , A.ZCD
            , A.APM_DVSN_CD
            , A.HOM_TNB
            , F_DPT_INFO(A.DPT_CD, '3')  AS DEP_RGN_CD
            , F_CODE_NM('1000029', F_DPT_INFO(A.DPT_CD, '3')) AS DEP_RGN_NM
            , A.PS_CD
            , F_CODE_NM('1000177',A.PS_CD) AS PS_NM
     		, A.RAL_BLT_DIV_CD
     		, F_CODE_NM ('1000144',A.RAL_BLT_DIV_CD) AS RAL_BLT_DIV_NM
            , A.DOC_ID
            , D2.FILE_NAME AS IMG_FILE_NAME
         FROM TBDCMACM001M A
         , UBKERAPP.ECM_FILE_LIST_VIEW2 D2
         WHERE 1=1
           AND A.DOC_ID = D2.DOC_ID(+)
          ]]>

		<if test='usrNam != null and usrNam != ""'>
			AND (A.USR_NAM LIKE #{usrNam}||'%' OR
				A.USR_ID LIKE #{usrNam}||'%' OR
				A.CNB LIKE #{usrNam}||'%')
		</if>
		<if test='wrkDvsnCd != null and wrkDvsnCd != ""'>
			AND A.RQS_STA_CD = #{wrkDvsnCd}
		</if>
		<if test='usrDvsn != null and usrDvsn != ""'>
			AND A.USR_DVSN_CD = #{usrDvsn}
		</if>
		<if test='usrdptauth != null and usrdptauth != ""'>
			AND A.DPT_CD IN ( SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#{usrcnb}, #{usrdptauth}, 'Y')))
		</if>
		<if test='dptCd != null and dptCd != ""'>
			AND A.DPT_CD = #{dptCd}
		</if>
		    AND NOT EXISTS ( SELECT 'X'
			                   FROM TBDCMACM202M AA
			                  WHERE AA.AUD_YR = #{audYr}
			                    AND AA.AUD_NO = #{audNo}
			                    AND AA.AUD_STEP_CD = #{audStepCd}
			                    AND AA.DOC_ID = #{docId}
			                    AND AA.EDT_CNB = A.CNB )
            AND NOT EXISTS ( SELECT 'X'
						       FROM ( SELECT B.AUTH_CD
							               , B.AUTH_CD_NM
							               , (CASE WHEN B.AUTH_CD = 'R01' THEN F_USR_INFO_BY_ID(A.DOC_WRT_ID,'1')
							                                              ELSE C.CNB
							                   END) AS CNB
									    FROM TBBADDED103M A 			
									   INNER JOIN 
									         (SELECT AA.AUD_DOC_CD /* 문서그룹ID */
									 	           , AA.AUTH_CD /* 권한코드 */
										           , CC.CD_NM AS AUTH_CD_NM /* 코드명 */ 
										        FROM TBDCMACM201M AA /* 감사문서기본편집권한관리 */
										       INNER JOIN
										             TBFDMADM001M BB
										          ON BB.AUD_DOC_CD = AA.AUD_DOC_CD
									           INNER JOIN    
									                 ( SELECT CD
									                        , CD_NM 
									                     FROM TBDCMACM013C 
									                    WHERE CMM_CD_DVSN_CD = '1000889' 
									                      AND USE_YN = 'Y' 
									                      AND CD != '000000000') CC /* 공통코드 */
									              ON AA.AUTH_CD = CC.CD ) B
									      ON A.RPRT_CD = B.AUD_DOC_CD
									    LEFT OUTER JOIN
									         (/* 주관자, 보조자, 주관자권한, 서무권한*/
										  	  SELECT A.AUD_YR
											       , A.AUD_NO
											       , CASE WHEN A.AUDTOR_DVSN_CD = '1'        THEN 'R02' -- 주관자
											              WHEN A.AUDTOR_DVSN_CD = '2'        THEN 'R03' -- 보조자
											              WHEN A.AUDTOR_DVSN_CD = '3'        THEN 'R04' -- 주관자권한
											              WHEN A.AUDTOR_DVSN_CD = '4'        THEN 'R05' -- 서무권한
											          END AS AUTH_CD 
											       , CNB  
											    FROM TBBADDED031L A
											   UNION ALL
											   /* 감사단장 */
											  SELECT A.AUD_YR
											       , A.AUD_NO
											       , 'R06' AS AUD_TH
											       , A.AUD_TOT_DRTR_CNB AS CNB
											    FROM TBBADDED001M A
											   UNION ALL
											  /* 부서장 */
											  SELECT B.AUD_YR
											       , B.AUD_NO
											       , 'R07' AS AUD_CD
											       , A.CNB
											    FROM TBDCMACM001M A
											   INNER JOIN 
											         TBBADDED001M B
											      ON B.MNG_DPT_CD = A.DPT_CD
											   WHERE A.PST_CD = '0013600'  ) C	  
									      ON C.AUD_YR = A.AUD_YR
									     AND C.AUD_NO = A.AUD_NO
									     AND C.AUTH_CD = B.AUTH_CD  
						 			   WHERE 1=1
									     AND A.AUD_YR = #{audYr}
									     AND A.AUD_NO = #{audNo}
									     AND A.AUD_STEP_CD = #{audStepCd}
									     AND A.DOC_ID = #{docId} ) AA
						     LEFT OUTER JOIN
						          TBDCMACM001M BB
						       ON AA.CNB = BB.CNB
						    WHERE AA.CNB = A.CNB )
							 
        ORDER BY A.USR_NAM
		<include refid="include.pageOrder" />
	</select>
	
</mapper> 