<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.dcm.acm.dao.DCMACM041EMapper">

    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.dcm.acm.dao.DCMACM041EMapper.selectMainList*/
        <include refid="include.pageSelct" />
            <![CDATA[    
			SELECT 
			    F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D1.AUD_KND_CD, '-') AS AUD_YR_NO
			    , AUD_SBJ_NM 
			    , F_CODE_NM('1000007', D1.AUD_KND_CD) AS AUD_KND_NM
			    , F_DPT_INFO(D1.MNG_DPT_CD,'1') AS DPT_NM
			    , D1.AUD_YR
			    , D1.AUD_NO
			    , F_ORG_INFO(D1.AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM
			    , CASE WHEN D1.PRSS_STEP_CD LIKE 'A10%' THEN (SELECT AUD_STEP_NM 
                                                                 FROM TBBADDED101M 
                                                                WHERE AUD_YR = D1.AUD_YR
                                                                  AND AUD_NO = D1.AUD_NO
                                                                  AND AUD_STEP_CD = D1.PRSS_STEP_CD)
                        ELSE F_CODE_NM('1000475',CASE WHEN SUBSTR(D1.AUD_KND_CD,3) = '55' THEN '' 
                                                      WHEN D3.AUD_EXEC_HNDL_STA_CD = '9'  THEN '10'
                                                      ELSE
                                                        CASE WHEN TRIM(D3.ENF_APV_DT) IS NOT NULL THEN '10'
                                                             WHEN TRIM(D3.CHF_CMTR_APV_DT)IS NOT NULL THEN '09'
                                                             WHEN TRIM(D3.OW_DHD_APV_DT)  IS NOT NULL THEN '08'
                                                             WHEN TRIM(D3.JA_JDG_SSEC_APV_DT) IS NOT NULL THEN '07'
                                                             WHEN TRIM(D3.MDT_DDG_APV_DT) IS NOT NULL THEN '06'
                                                             WHEN TRIM(D3.MDT_OFER_APV_DT)IS NOT NULL THEN '05'
                                                             WHEN TRIM(D3.AUD_BRDV_APV_DT)IS NOT NULL THEN '04'
                                                             WHEN TRIM(D3.RTN_RPT_DT) IS NOT NULL THEN '03'
                                                        ELSE
                                                            (CASE WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8' END) = '8' AND D3.RTN_RPT_DT IS NULL AND D3.FLD_AUD_END_DT IS NULL THEN '02'
                                                                  WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8' END) = '8' AND D3.RTN_RPT_DT IS NULL THEN '11'
                                                                  WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8' END) = '7' THEN '02'
                                                                   END)
                                                        END
                                                      END)
                        END    AS PRSS_STEP_NM
			  FROM TBBADDED001M D1
			  LEFT OUTER JOIN TBBADDED003M AS D3 ON D1.AUD_YR = D3.AUD_YR AND D1.AUD_NO = D3.AUD_NO
			 WHERE 1=1
			 	 AND D1.AUD_YR = #{schAudYr}
			]]>
			<if test="schAudYrNoKndCd != null and schAudYrNoKndCd != '' "> 
			 	AND D1.AUD_KND_CD = #{schAudYrNoKndCd}
			</if>
			<if test="schAudGrnNo != null and schAudGrnNo != '' "> 
 				AND D1.AUD_GRN_NO = #{schAudGrnNo}
 			</if>
			<if test="schAudSbjNm != null and schAudSbjNm != '' "> 
				 AND D1.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
			</if>
			<if test="schDeptCd != null and schDeptCd != '' "> 
				 AND D1.MNG_DPT_CD = #{schDeptCd}
			</if>
			<if test="schSpvBrdvCd != null and schSpvBrdvCd != '' "> 
				 AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = D1.MNG_DPT_CD) =#{schSpvBrdvCd}
			</if>
			 ORDER BY D1.AUD_YR, D1.AUD_KND_CD, D1.AUD_GRN_NO DESC
			 
		<include refid="include.pageOrder" />
    </select>
    
 
	<select id="selectExcelExport" parameterType="paramMap" resultType="egovMap">
		<![CDATA[  
		/* kr.go.bai.eip.dcm.acm.dao.DCMACM041EMapper.selectExcelExport*/
		SELECT ROWNUM
		      ,AUD_YR_NO 
		      ,AUD_SBJ_NM
		      ,DPT_NM
		      ,AUD_STEP_NM
		      ,RPRT_KND_NM
		      ,RPRT_NM
		      ,APV_STA_NM
		      ,DOC_WRT_NM
		      ,REGI_DH
		      ,CURR_APV_USR_NM
		      ,FNL_APV_USR_NM
		      ,EDT_AUTH_NM
		  FROM (
				  SELECT 
					    F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') AS AUD_YR_NO
					    , AUD_SBJ_NM 
					    , (SELECT MAX(CASE WHEN AUD_STEP_CD = '10' THEN '자료수집/확인출장' ELSE AUD_STEP_NM END) AS CD_NM
					         FROM TBBADDED101B
					        WHERE AUD_STEP_CD = T2.AUD_STEP_CD) AS AUD_STEP_NM
					    , (SELECT 
							   DECODE(AUD_DOC_CD, 'A10600100', '개별처분요구안',AGGR_CONCAT(DTIL_AUD_DOC_NM,',')) AS CD_NM
							  FROM (
							        SELECT 
							            AUD_DOC_CD
							            , DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1)) AS DTIL_AUD_DOC_NM
							          FROM TBFDMADM002M
							         WHERE SUBSTR(AUD_DOC_CD,0,1) = 'A'
							         GROUP BY AUD_DOC_CD, DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1))
		                             UNION ALL SELECT 'A10800500' , '공개문' FROM DUAL
		                             UNION ALL SELECT 'A10700700' , '부의안요약문-보고자용' FROM DUAL
		                             UNION ALL SELECT 'A10700800' , '부의안요약문-원장님용' FROM DUAL
							        )
							  WHERE AUD_DOC_CD = T2.RPRT_CD 
							 GROUP BY AUD_DOC_CD) AS RPRT_KND_NM
					    , T2.RPRT_NM
		                , T2.RPRT_NM AS RPRT_REAL_NM
					    , F_CODE_NM('1000773', T2.APV_STA_CD) AS APV_STA_NM
					    , F_USR_INFO_BY_ID(DOC_WRT_ID,'2') AS DOC_WRT_NM
					    , TO_CHAR(T2.FRT_REGI_DH,'YYYY"-"MM"-"DD" "HH24:MI') AS REGI_DH 
					    , DECODE(NVL(EDT_AUTH,'N'),'N','편집불가','편집가능') AS EDT_AUTH_NM
		                , NVL(EDT_AUTH,'N') AS EDT_AUTH
					    , T2.AUD_YR
					    , T2.AUD_NO
					    , T2.AUD_STEP_CD
					    , T2.DOC_ID
					    , T2.APV_STA_CD
					    , T2.APV_RQS_ID
					    , F_DPT_INFO(T1.MNG_DPT_CD,'1') AS DPT_NM
					    , CURR_APV.APVR_NM AS CURR_APV_USR_NM
			    		, FNL_APV.APVR_NM AS FNL_APV_USR_NM
					  FROM TBBADDED001M T1
					       INNER JOIN TBBADDED103M T2
					       ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO)
					       LEFT OUTER JOIN (
											SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
											     , DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
											  FROM TBDCMACM023L M
											 WHERE M.APV_DVSN_CD = 'fieldAudit' 
											   AND SUBSTR(M.APVR_STA_CD,1,1) = '1'
											   AND M.APVR_KND_CD <> '6'
											 GROUP BY M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD, M.APVR_CNB) CURR_APV
					 	   ON (T2.APV_RQS_ID = CURR_APV.APV_DOC_NO)
					 	   LEFT OUTER JOIN (
											SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
		  										  ,DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
											  FROM TBDCMACM023L M
											  	   ,(
													SELECT APV_DOC_NO, APV_DVSN_CD, MAX(APVR_SEQ) AS MAX_APVR_SEQ
													  FROM TBDCMACM023L
													 GROUP BY APV_DOC_NO, APV_DVSN_CD
													) SUB
											 WHERE M.APV_DOC_NO = SUB.APV_DOC_NO
											   AND M.APV_DVSN_CD = SUB.APV_DVSN_CD
											   AND M.APVR_SEQ = SUB.MAX_APVR_SEQ
											   AND M.APV_DVSN_CD = 'fieldAudit' ) FNL_APV
					 	   ON (T2.APV_RQS_ID = FNL_APV.APV_DOC_NO)
					 WHERE 1=1
					 	 AND T1.AUD_YR = #{schAudYr}
					]]>
					<if test="schAudYrNoKndCd != null and schAudYrNoKndCd != '' "> 
					 	AND T1.AUD_KND_CD = #{schAudYrNoKndCd}
					</if>
					<if test="schAudGrnNo != null and schAudGrnNo != '' "> 
		 				AND T1.AUD_GRN_NO = #{schAudGrnNo}
		 			</if>
					<if test="schAudSbjNm != null and schAudSbjNm != '' "> 
						 AND T1.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
					</if>
					<if test="schDeptCd != null and schDeptCd != '' "> 
						 AND T1.MNG_DPT_CD = #{schDeptCd}
					</if>
					<if test="schSpvBrdvCd != null and schSpvBrdvCd != '' "> 
						 AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = T1.MNG_DPT_CD) =#{schSpvBrdvCd}
					</if>
					<if test="schPrssStepCd != null and schPrssStepCd != ''  and schPrssStepCd neq  'A1095'.toString()">  
						 AND T2.AUD_STEP_CD = #{schPrssStepCd}
					</if>
		            <if test="schPrssStepCd eq  'A1095'.toString()">  
		                 AND SUBSTR(T2.RPRT_CD,0,5) = #{schPrssStepCd}
		            </if>
					<if test="schRprtNm != null and schRprtNm != '' "> 
						 AND T2.RPRT_NM LIKE '%'||#{schRprtNm}||'%'
					</if>
					<if test="schRprtCd != null and schRprtCd != '' "> 
						 AND T2.RPRT_CD = #{schRprtCd}
					</if>
					<if test="schApvStaCd != null and schApvStaCd != '' "> 
						 AND T2.APV_STA_CD = #{schApvStaCd}
					</if>
					<if test="schEdtAuth != null and schEdtAuth != '' "> 
						 AND NVL(T2.EDT_AUTH,'N') = #{schEdtAuth}
					</if>
					<if test="schCurrApvr != null and schCurrApvr != '' ">
						<choose>
							<when test="schCurrApvr eq '1'.toString()">
								AND CURR_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
							</when>
							<when test="schCurrApvr eq '2'.toString()">
								AND CURR_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
							</when>
							<when test="schCurrApvr eq '3'.toString()">
								AND CURR_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
							</when>
							<when test="schCurrApvr eq '4'.toString()">
								AND CURR_APV.APVR_PST_CD = '0055700'						/*최종결재자가 총장 단계*/				
							</when>
							<when test="schCurrApvr eq '5'.toString()">
								AND CURR_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
							</when>
							<when test="schCurrApvr eq '6'.toString()">
								AND CURR_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
							</when>
						</choose>
					</if>
					<if test="schFnlApvr != null and schFnlApvr != '' ">
						<choose>
							<when test="schFnlApvr eq '1'.toString()">
								AND FNL_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
							</when>
							<when test="schFnlApvr eq '2'.toString()">
								AND FNL_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
							</when>
							<when test="schFnlApvr eq '3'.toString()">
								AND FNL_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
							</when>
							<when test="schFnlApvr eq '4'.toString()">
								AND FNL_APV.APVR_PST_CD = '0055700'							/*최종결재자가 총장 단계*/				
							</when>
							<when test="schFnlApvr eq '5'.toString()">
								AND FNL_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
							</when>
							<when test="schFnlApvr eq '6'.toString()">
								AND FNL_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
							</when>
						</choose>
					</if>
					ORDER BY T1.AUD_YR, T1.AUD_KND_CD, T1.AUD_GRN_NO DESC, T2.AUD_STEP_CD, T2.RPRT_CD
				)
	</select>
   
</mapper> 