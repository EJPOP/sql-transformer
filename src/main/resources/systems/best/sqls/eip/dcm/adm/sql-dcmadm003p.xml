<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.dcm.adm.dao.DCMADM003PMapper">

	<!-- 감사자료 제출 요구 목록 조회 -->
	<select id="selectList0" parameterType="paramMap"
		resultType="egovMap">
		/* DCMADM003PMapper.selectList0*/
		<include refid="include.pageSelct"/>
		<![CDATA[
			SELECT T1.AUD_YR AS YE_KY
      ,T1.AUD_NO AS NO_KY
      ,F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, NULL, '-') AS AUD_YR_NO
      , F_CODE_NM('1000751',T1.BZT_BGT_DVSN_CD) AS BZT_BGT_DVSN_NM
      ,T1.AUD_SBJ_NM AS TIT_NM
      ,F_ORG_INFO(T1.AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM
      ,F_DPT_INFO(T1.MNG_DPT_CD,'1')         AS MNG_DPT_NM
      ,AUD_CTRL_CD
      ,'10' TSK_DVSN_CD
      ,'실지감사' AS TSK_DVSN_NM
      ,'' AS DVSN_KY
  FROM TBBADDED001M T1
 WHERE T1.AUD_YR = #{schAudYr}
   AND T1.AUD_CTRL_CD ='2'
 ]]>
		<if test='schAudYrNoKndCd != null and schAudYrNoKndCd != ""'>
				<![CDATA[
				   AND T1.AUD_KND_CD = #{schAudYrNoKndCd}
				]]>
			</if>
		<if test='schAudNo != null and schAudNo != ""'>
				<![CDATA[
				   AND T1.AUD_GRN_NO = #{schAudNo}
				]]>
			</if>
		<if test='schAudSbjNm != null and schAudSbjNm != ""'>
				<![CDATA[
				   AND T1.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
				]]>
			</if>
		<![CDATA[	
		]]>
		<include refid="include.pageOrder" />
	</select>
	
	
	<select id="selectList1" parameterType="paramMap"
		resultType="egovMap">
		/* DCMADM003PMapper.selectList0*/
		<include refid="include.pageSelct"/>
		<![CDATA[
					SELECT T1.ACP_NO  AS AUD_YR_NO                     /*접수번호*/
					 , T1.ACP_YR AS YE_KY                    /*접수년도*/
		               , T1.ACP_DVSN_CD AS DVSN_KY               /*접수구분*/    
		               , T1.ACP_SRNO  AS   NO_KY               /*접수일련번호*/
		                 ,CASE WHEN T1.ACP_DVSN_CD = '1' THEN '20' ELSE '30' END AS TSK_DVSN_CD
					      ,CASE WHEN T1.ACP_DVSN_CD = '1' THEN '심사' ELSE '재심의' END AS TSK_DVSN_NM
		               , T1.HST_NA                     /*결재코드(국)*/
		               , T1.HST_DE                     /*결재코드(과)*/
		               , T1.ACP_HNDL_STA_CD            /*진행단계코드*/
		               , T1.ACP_HNDL_STA_NM            /*진행단계명*/
		               , T1.ACP_DT                     /*접수일*/
		               , T1.DSP_OFC_ACP_DT             /*처분청접수일*/
		               , T1.ORG_NM                     /*처분청*/
		               , T1.DSPTCH_INSTT_NAM           /*발신기관명*/
		               , T1.REQR_NM                    /*청구인명*/
		               , T1.TIT_NM                     /*제목*/
		               , T1.DPT_CD                     /*부서코드*/
		               , T1.DPT_NM                     /*부서명*/
		               , T1.HNDL_DDLN_DT               /*처리기한*/
		               , T1.HNDL_CHGR_NM               /*담당자*/
		               , T1.ENF_DT                     /*결정일*/
		              
		               , T1.ORG_ACP_SRNO               /*접수일련번호(구)*/
		               , T1.MG_ACP_YR                  /*대표건 접수년도*/
		               , T1.MG_ACP_DVSN_CD             /*대표건 접수구분*/
		               , T1.MG_ACP_SRNO                /*대표건 접수일련번호*/
		               , T1.MG_DPT_CD                  /*병합부서코드*/
		               , T1.MG_DIV_CD                  /*병행병합구분코드 10:병합, 20:병행*/
		               , T1.MG_DIV_NM                  /*병행병합구분*/
		               , DECODE(MG_COUNT,0,'',DECODE(MG_DIV_CD,'10','병합(' || MG_COUNT || ')', '병행(' || MG_COUNT || ')')) AS MG_COUNT                   /*병행병합 건수*/
		               , DECODE(T2.LINK_URL, null, (
		                 	SELECT ST1.LINK_URL
		                    FROM TBBADFRE101M ST1
		                   WHERE ST1.ACP_YR = T1.ACP_YR
		                      AND ST1.ACP_DVSN_CD = T1.ACP_DVSN_CD
		                      AND ST1.ACP_SRNO = T1.ACP_SRNO
		                      AND ST1.NECES_YN ='Y'
		                      AND ST1.ACP_STEP_CD = (SELECT MAX(ST2.ACP_STEP_CD)
		                      						  FROM TBBADFRE101M ST2 
		                      						  WHERE ST2.ACP_YR = ST1.ACP_YR
								                      AND ST2.ACP_DVSN_CD = ST1.ACP_DVSN_CD
								                      AND ST2.ACP_SRNO = ST1.ACP_SRNO
								                      AND ST2.NECES_YN ='Y')
		                 ), T2.LINK_URL) AS LINK_URL /* 페이지 URL */
		               , DECODE(T2.ACP_STEP_CD, null, (SELECT MAX(ACP_STEP_CD)
		                                                        FROM TBBADFRE101M
		                                                       WHERE ACP_YR = T1.ACP_YR
		                                                          AND ACP_DVSN_CD = T1.ACP_DVSN_CD
		                                                          AND ACP_SRNO = T1.ACP_SRNO
		                                                          AND NECES_YN ='Y'), T2.ACP_STEP_CD) AS ACP_STEP_CD /* 프로세스 단계 코드 */
		                 ,T2.ACP_STEP_NM /* 프로세스 단계명 */
		               , PRC_CNT                    /*전자감사여부구분값*/
		               , PRC_CNT2                   /*전자감사여부구분값*/
		               , HNDL_DT                    /*경과일*/
		               , ROWNUM
		               , T1.DOC_TYPE   /* 편집기 구분  */ 
		        FROM (
				    SELECT A.ACP_YR || '-' || DECODE(A.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') || '-' || DECODE(A.ORG_ACP_SRNO, null, A.ACP_SRNO, A.ORG_ACP_SRNO) AS ACP_NO /* 분류번호 */
				         ,(SELECT
				               APV_RQS_ID      /*결재ID*/
				          FROM TBBADFRE103M 
				          WHERE ACP_YR = A.ACP_YR
				             AND ACP_DVSN_CD = A.ACP_DVSN_CD
				             AND ACP_SRNO = A.ACP_SRNO
				             AND APV_RQS_ID IS NOT NULL
				             AND RPRT_CD = DECODE('1','1','D10100001','2','E10100001')) as HST_NA /* 결재이력-선람전 (국) */
				         ,(SELECT
				               APV_RQS_ID      
				          FROM TBBADFRE103M 
				          WHERE ACP_YR = A.ACP_YR
				             AND ACP_DVSN_CD = A.ACP_DVSN_CD
				             AND ACP_SRNO = A.ACP_SRNO
				             AND APV_RQS_ID IS NOT NULL
				             AND RPRT_CD = DECODE('1','1','D10100002','2','E10100002')) as HST_DE /* 결재이력-선람전 (과) */
				         ,A.ACP_HNDL_STA_CD /* 진행단계코드 */
					     ,F_CODE_NM('1000807', A.ACP_HNDL_STA_CD) AS ACP_HNDL_STA_NM /* 진행단계명 */
					     ,to_char(to_date(A.ACP_DT), 'YYYY-MM-DD') AS ACP_DT		/* 접수일 */
					     ,to_char(to_date(A.DSP_OFC_ACP_DT), 'YYYY-MM-DD') AS DSP_OFC_ACP_DT		/* 처분청접수일자 */
					     ,A.ORG_NM /* 처분청 */
					     ,A.DSPTCH_INSTT_NAM /* 발신기관명 */
					     ,DECODE(A.AGT_NM, NULL, A.REQR_NM, A.REQR_NM || '(代:' || A.AGT_NM || ')' ) AS REQR_NM/* 청구인명 */
					     ,A.TIT_NM /* 청구내용 */
					     ,A.DPT_CD /* 부서코드 */
					     ,(SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD = A.DPT_CD) AS DPT_NM /* 처리과 */
					     ,to_char(to_date(A.HNDL_DDLN_DT), 'YYYY-MM-DD') AS HNDL_DDLN_DT /* 처리기한 */
					     ,A.HNDL_CHGR_NM /* 담당자 */
		                 ,A.HNDL_CHGR_CD
					     ,to_char(to_date(B.ENF_DT), 'YYYY-MM-DD') AS ENF_DT /* 결정일자(시행일) */
					     ,A.ACP_YR /* 접수년도 */
					     ,A.ACP_DVSN_CD /* 접수구분코드 */
					     ,A.ACP_SRNO /* 접수일련번호 */
					     ,A.ORG_ACP_SRNO /* 기존접수일련번호 */
					     ,A.MG_ACP_YR /* 병합접수년도 */
					     ,A.MG_ACP_DVSN_CD /* 병합접수구분코드 */
					     ,A.MG_ACP_SRNO /* 병합접수일련번호 */
					     ,A.MG_DPT_CD /* 병합부서코드 */
					     ,A.MG_DIV_CD /* 병합병행구분코드 */
					     ,CASE WHEN (A.ACP_YR = A.MG_ACP_YR AND A.ACP_DVSN_CD = A.MG_ACP_DVSN_CD AND A.ACP_SRNO = A.MG_ACP_SRNO) THEN '대표'
					           WHEN A.MG_DIV_CD IS NULL AND A.MG_ACP_YR IS NULL THEN '대표'
					           WHEN A.MG_DIV_CD IS NULL THEN '대표'
					           WHEN A.MG_DIV_CD = '10' THEN '병합'
					           WHEN A.MG_DIV_CD = '20' THEN '병행'
					            END AS MG_DIV_NM /* 병합병행구분명 */
					     ,(SELECT COUNT(MG_ACP_YR)
		                     FROM TBBADFRE012M
		                    WHERE MG_ACP_YR = A.MG_ACP_YR
		                      AND MG_ACP_DVSN_CD = A.MG_ACP_DVSN_CD
		                      AND MG_ACP_SRNO = A.MG_ACP_SRNO) AS MG_COUNT
					     ,(SELECT COUNT(ACP_YR)
					       FROM TBBADFRE103M
					      WHERE ACP_YR = A.ACP_YR
					         AND ACP_DVSN_CD = A.ACP_DVSN_CD
					         AND ACP_SRNO = A.ACP_SRNO) AS PRC_CNT /* 프로세스 갯수 */
					     ,(SELECT COUNT(ACP_YR)
					       FROM TBBADFRE102M
					      WHERE ACP_YR = A.ACP_YR
					         AND ACP_DVSN_CD = A.ACP_DVSN_CD
					         AND ACP_SRNO = A.ACP_SRNO) AS PRC_CNT2  /* 프로세스 갯수 */
					    ,CASE WHEN B.ENF_DT IS NULL THEN to_char(TO_DATE(SYSDATE) - TO_DATE(ACP_DT))
					    	  WHEN B.ENF_DT IS NOT NULL THEN to_char(TO_DATE(B.ENF_DT) - TO_DATE(ACP_DT))
					      END AS HNDL_DT /* 경과일 */
					    , F_CODE_NM('1000894', A.DOC_WRIT_KND_CD) AS DOC_TYPE /* 편집기 구분  */ 
				 FROM TBBADFRE012M A
				 INNER JOIN TBBADFRE013D B ON (B.ACP_YR 		= A.ACP_YR
		                                       AND B.ACP_DVSN_CD 	= A.ACP_DVSN_CD
		                                       AND B.ACP_SRNO 		= A.ACP_SRNO)
			    WHERE 1=1
 ]]>
		<if test='schAcpYr != null and schAcpYr != ""'>
				<![CDATA[
				   AND A.ACP_YR = #{schAcpYr}
				]]>
			</if>
			<if test='schAcpSrno != null and schAcpSrno != ""'>
				<![CDATA[
				   AND A.ACP_SRNO = #{schAcpSrno}
				]]>
			</if>
			
		<if test='schAcpDvsnCd != null and schAcpDvsnCd != ""'>
				<![CDATA[
				   AND A.ACP_DVSN_CD = #{schAcpDvsnCd}
				]]>
			</if>
		<if test='schTitNm != null and schTitNm != ""'>
				<![CDATA[
				   AND T1.TIT_NM like  '%'||#{schTitNm}||'%'
				]]>
			</if>
		<![CDATA[	
		AND (B.ENF_DT IS NULL OR A.ACP_HNDL_STA_CD NOT IN ('420') )
		ORDER BY A.FRT_REGI_DH DESC
		) T1
		LEFT OUTER JOIN (SELECT ACP_YR
                               ,ACP_DVSN_CD
                               ,ACP_SRNO
                               ,LINK_URL
                               ,ACP_STEP_CD
                               ,ACP_STEP_NM
                         FROM TBBADFRE101M
                        WHERE STEP_CMPT_YN = 'P'
                           AND NECES_YN ='Y') T2 ON (T2.ACP_YR 		= T1.ACP_YR
                                                    AND T2.ACP_DVSN_CD 	= T1.ACP_DVSN_CD
                                                    AND T2.ACP_SRNO 		= T1.ACP_SRNO)
		WHERE 1=1
		   AND HNDL_CHGR_CD IS NOT NULL
		   AND ACP_HNDL_STA_CD >= 250
		   AND MG_DIV_NM  = '대표'
		]]>
		<include refid="include.pageOrder" />
	</select>
	
	<select id="selectList2" parameterType="paramMap"
		resultType="egovMap">
		/* DCMADM003PMapper.selectList2*/
		<include refid="include.pageSelct"/>
		<![CDATA[
			SELECT T1.ACP_YR||'-'|| F_CODE_NM('1000949', T1.RM_ACP_KND_CD) ||'-'||T1.RM_CVPT_ACP_NO  AS AUD_YR_NO                     /*접수번호*/
					 , T1.ACP_YR AS YE_KY                    /*접수년도*/
		               , T1.REQ_DVSN_CD AS DVSN_KY               /*접수구분*/    
		               , T1.CVPT_ACP_NO  AS   NO_KY               /*접수일련번호*/
		                 ,'40' AS TSK_DVSN_CD
					      ,'감사제보' AS TSK_DVSN_NM
					      ,T1.TIT_NM
					      ,T1.CVPTR_NM
					      ,F_CODE_NM('1000361', T1.CVPT_HNDL_STA_CD) AS CVPT_HNDL_STA_NM
					      ,T1.RM_CVPT_ACP_NO
			  FROM TBCSPDCP101M T1, TBCSPDCP201M T2
			 WHERE T1.REQ_DVSN_CD = '1'
			   AND T1.RM_ACP_KND_CD = #{schRmAcpKndCd}
			   AND T1.ACP_YR = #{schAcpYr}
			   AND T1.CVPT_HNDL_STA_CD NOT IN ('50','60','70')
			   AND T1.REQ_DVSN_CD = T2.REQ_DVSN_CD
			   AND T1.ACP_YR = T2.ACP_YR
			   AND T1.CVPT_ACP_NO = T2.CVPT_ACP_NO
			
		]]>
		<if test='schTitNm != null and schTitNm != ""'>
				<![CDATA[
				   AND T1.TIT_NM like  '%'||#{schTitNm}||'%'
				]]>
		</if>
		<if test='schRmCvptAcpNo != null and schRmCvptAcpNo != ""'>
			<![CDATA[
			   AND T1.RM_CVPT_ACP_NO  = #{schRmCvptAcpNo}
			]]>
		</if>
			order by T1.ACP_YR DESC , to_number(T1.RM_CVPT_ACP_NO) DESC
		<include refid="include.pageOrder" />
	</select>
	
	<select id="selectList3" parameterType="paramMap"
		resultType="egovMap">
		/* DCMADM003PMapper.selectList3*/
		<include refid="include.pageSelct"/>
		<![CDATA[
			SELECT T1.ACP_YR||'-'|| F_CODE_NM('1000740', T1.REQ_DVSN_CD) ||'-'||T1.CVPT_ACP_NO  AS AUD_YR_NO                     /*접수번호*/
					 , T1.ACP_YR AS YE_KY                    /*접수년도*/
		               , T1.REQ_DVSN_CD AS DVSN_KY               /*접수구분*/    
		               , T1.CVPT_ACP_NO  AS   NO_KY               /*접수일련번호*/
		                 ,'50' AS TSK_DVSN_CD
					      ,'감사청구' AS TSK_DVSN_NM
					      ,T1.TIT_NM
					      ,T1.CVPTR_NM
					      ,F_CODE_NM('1000361', T1.CVPT_HNDL_STA_CD) AS CVPT_HNDL_STA_NM
			  FROM TBCSPDCP101M T1, TBCSPEAR001M T2
			 WHERE T1.REQ_DVSN_CD = #{schReqDvsnCd}
			   AND T1.ACP_YR = #{schAcpYr}
			   AND T1.CVPT_HNDL_STA_CD NOT IN ('10','20','21')
			   AND T1.REQ_DVSN_CD = T2.REQ_DVSN_CD
			   AND T1.ACP_YR = T2.ACP_YR
			   AND T1.CVPT_ACP_NO = T2.CVPT_ACP_NO
			
		]]>
		<if test='schTitNm != null and schTitNm != ""'>
				<![CDATA[
				   AND T1.TIT_NM like  '%'||#{schTitNm}||'%'
				]]>
			</if>
			
			<if test='schRmCvptAcpNo != null and schRmCvptAcpNo != ""'>
				<![CDATA[
				   AND T1.RM_CVPT_ACP_NO  = #{schRmCvptAcpNo}
				]]>
			</if>
			order by T1.ACP_YR DESC, T1.CVPT_ACP_NO DESC
		<include refid="include.pageOrder" />
	</select>
	
	<select id="selectEviDcmList" parameterType="paramMap" resultType="egovMap">
		/* DCMADM003PMapper.selectEviDcmList */
		<![CDATA[
			SELECT	B.EVI_DCMB_SNO AS EVI_DCMB_SNO
					,B.SPMT_DVSN_CD AS SPMT_DVSN_CD
					,F_CODE_NM('1000746',B.SPMT_DVSN_CD) AS SPMT_DVSN_NM
					,TO_CHAR(TO_DATE(B.SPMT_RQ_DT), 'YYYY-MM-DD') AS SPMT_RQ_DT
					,B.SPMT_RQ_RT AS SPMT_RQ_RT
					,B.TG_ORG_NM AS TG_ORG_NM
					,B.SPMT_RQ_TXT AS SPMT_RQ_TXT
					,TO_CHAR(TO_DATE(B.SPMT_CMPT_DT), 'YYYY-MM-DD') AS SPMT_CMPT_DT
					,B.SPMT_RQ_STA_CD AS SPMT_RQ_STA_CD
					,F_CODE_NM('1000747',B.SPMT_RQ_STA_CD) AS SPMT_RQ_STA_NM
					,B.ONR_DOC_NO AS ONR_DOC_NO
			FROM	TBCSPEAR001M A
					,TBCSPEAR003L B
			WHERE	A.ACP_YR = #{acpYr}
			AND		A.REQ_DVSN_CD = #{reqDvsnCd}
			AND		A.CVPT_ACP_NO = #{cvptAcpNo}
   			AND		A.REQ_DVSN_CD = B.REQ_DVSN_CD
   			AND		A.ACP_YR = B.ACP_YR
   			AND		A.CVPT_ACP_NO = B.CVPT_ACP_NO
   			ORDER BY TO_NUMBER(B.SPMT_RQ_SLN) ASC
		]]>
	</select>
	<select id="selectReqInfo" parameterType="paramMap" resultType="egovMap">
		/* DCMADM003PMapper.selectReqInfo */
		<![CDATA[
			SELECT	ACP_YR||'-'|| F_CODE_NM('1000740', REQ_DVSN_CD) ||'-'||CVPT_ACP_NO  AS AUD_YR_NO 
						,TIT_NM
			FROM	TBCSPDCP101M
			WHERE	ACP_YR = #{acpYr}
			AND		REQ_DVSN_CD = #{reqDvsnCd}
			AND		CVPT_ACP_NO = #{cvptAcpNo}
		]]>
	</select>
</mapper>
