<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.arp.dao.AEPARP006EMapper">

    <insert id="insertBadded142m" parameterType="paramMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP006EMapper.insertBadded142m */
        INSERT INTO TBBADDED142M (
              AUD_YR
            , AUD_NO
            , AUD_STEP_CD
            , RPRT_CD
            , DOC_ID
            , APVR_CD
            , AFF_SNO
            , CNB
            , AUD_SBJ_NM_TXT
            , DPT_NM_TXT
            , AUD_RPRT_NUM_TXT
            , TITLE_NM_TXT
            , RPRT_FILD_ID
            , FRT_USR_ID
            , FNL_USR_ID
            , FNL_DEAL_DPT_CD
            , FNL_MNU_ID
            , FRT_REGI_DH
            , FNL_MDF_DH
        ) VALUES (
              #{audYr}
            , #{audNo}
            , #{audStepCd}
            , #{rprtCd}
            , #{docId}
            , #{apvrCd}
            , #{affSno}
            , #{cnb}
            , (SELECT AUD_SBJ_NM FROM TBBADDED001M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo})
            , (SELECT F_DPT_INFO(MNG_DPT_CD, '1') FROM TBBADDED001M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo})
            , #{audRprtNumTxt}
            , #{titleNmTxt}
            , #{rprtFildId}
            , #{usrId}
            , #{usrId}
            , #{dptCd}
            , #{menuNo}
            , SYSDATE
            , SYSDATE
        )
    </insert>
    
    
    <delete id="deleteBadded142m" parameterType="paramMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP006EMapper.deleteBadded142m */
        DELETE FROM TBBADDED142M
        WHERE AUD_YR = #{audYr}
          AND AUD_NO = #{audNo}
          AND AUD_STEP_CD = #{audStepCd}
          AND DOC_ID = #{docId}
    </delete>
    
    
    
    <select id="selectSendDoc" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP006EMapper.selectSendDoc */
        <![CDATA[
                SELECT B.AUD_YR
                     , B.AUD_NO
                     , B.AUD_STEP_CD
                     , B.DOC_ID
                     , B.AUD_KND_CD
                     , B.AUD_GRN_NO
                     , B.RPRT_NM
                     , B.RPRT_CD
                     , B.LINK_URL
                     , B.AUD_RPRT_DVSN_CD 
                     , B.DOC_KND_CD 
                     , B.REF_ID
                     , B.REF_DY
                     , B.SND_DPT_CD
                     , F_DPT_INFO(B.SND_DPT_CD,'1') AS SND_DPT_NM
                     , B.RCPT_DPT_CD
                     , F_DPT_INFO(B.RCPT_DPT_CD,'1') AS RCPT_DPT_NM
                     , TO_CHAR(B.RCPT_DH,'YYYY-MM-DD') AS RCPT_DH
                     , '발신' AS SND_INFO
                     , (SELECT DECODE(ST.DOC_WRIT_KND_CD, '10', 'polaris', 'hancom') FROM TBBADDED001M ST WHERE ST.AUD_YR = A.AUD_YR AND ST.AUD_NO = A.AUD_NO) AS DOC_TYPE
                     , NVL(A.OPIN_NO_YN, 'N') AS OPIN_NO_YN
                  FROM TBBADDED141M A
            INNER JOIN TBBADDED111M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.AUD_STEP_CD = A.AUD_STEP_CD AND B.DOC_ID = A.OPIN_DOC_ID)
                 WHERE A.AUD_YR = #{audYr}
                   AND A.AUD_NO = #{audNo}
                   AND A.AUD_STEP_CD = #{audStepCd}
                   AND A.DOC_ID = #{docId}
        ]]>
    </select>
    
    <select id="selectSendMsgInfo" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP006EMapper.selectSendMsgInfo*/
        <![CDATA[
		  SELECT HIRK_DPT_NM
               , AUD_SBJ_NM
               , AUD_KND_NM
               , MNG_DPT_NM
               , CMPL_DT
               , AGGR_CONCAT(CNB,'') AS RCPT_USR_CNB
               , COUNT(CNB) AS RCPT_USR_CNT
           FROM (
	            SELECT (SELECT F_DPT_INFO(ST.HIRK_DPT_CD,'1') FROM TBDCMACM002M ST WHERE ST.DPT_CD = B.MNG_DPT_CD) AS HIRK_DPT_NM
	                   , B.AUD_SBJ_NM
	                   , F_CODE_NM('1000007', B.AUD_KND_CD) AS AUD_KND_NM
	                   , F_DPT_INFO(B.MNG_DPT_CD,'1') AS MNG_DPT_NM
	                   , TO_CHAR(SYSDATE,'YYYY. MM. DD. HH24') || '시' || TO_CHAR(SYSDATE,'MI') || '분' AS CMPL_DT
	                   , C.CNB
	              FROM TBBADDED141M A
	        INNER JOIN TBBADDED001M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO)
	        INNER JOIN (SELECT ST.CNB
	                         , ST.AUD_YR
	                         , ST.AUD_NO
	                      FROM TBBADDED031L ST
	                     WHERE ST.AUD_YR = #{audYr}
	                       AND ST.AUD_NO = #{audNo}
	                       AND ST.AUDTOR_DVSN_CD IN ('1','2')
	                    UNION
	                    SELECT ST2.APVR_CNB AS CNB
	                         , ST.AUD_YR
	                         , ST.AUD_NO
	                      FROM TBBADDED103M ST
	                INNER JOIN TBDCMACM023L ST2 ON (ST2.APV_DOC_NO = ST.APV_RQS_ID)
	                     WHERE ST.AUD_YR = #{audYr}
	                       AND ST.AUD_NO = #{audNo}
	                       AND ST.DOC_ID = #{docId}
	                       AND ST2.APVR_STA_CD IN ('102','103')
	                     ) C ON (C.AUD_YR = A.AUD_YR AND C.AUD_NO = A.AUD_NO)
		    WHERE A.AUD_YR = #{audYr}
              AND A.AUD_NO = #{audNo}
              AND A.AUD_STEP_CD = #{audStepCd}
              AND A.DOC_ID = #{docId}
              GROUP BY B.MNG_DPT_CD, B.AUD_SBJ_NM, B.AUD_KND_CD, C.CNB
	       )
	       GROUP BY HIRK_DPT_NM, AUD_SBJ_NM, AUD_KND_NM, MNG_DPT_NM, CMPL_DT
        ]]>
    </select>    
    
    <select id="selectOpinDoc" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP006EMapper.selectSendDoc*/
            SELECT 
                A.AUD_YR
                ,A.AUD_NO
                ,A.AUD_STEP_CD
                ,A.DOC_ID
                ,A.AUD_KND_CD
                ,A.AUD_GRN_NO
                ,A.RPRT_NM
                ,A.RPRT_CD
                ,A.LINK_URL
                ,A.AUD_RPRT_DVSN_CD 
                ,A.DOC_KND_CD 
                ,A.REF_ID
                ,A.REF_DY
                ,(SELECT ST.MNG_DPT_CD FROM TBBADDED001M ST WHERE ST.AUD_YR = A.AUD_YR AND ST.AUD_NO = A.AUD_NO) AS MNG_DPT_CD 
            FROM TBBADDED103M A
            INNER JOIN TBBADDED141M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.AUD_STEP_CD = A.AUD_STEP_CD AND B.OPIN_DOC_ID = A.DOC_ID)
            WHERE B.AUD_YR = #{audYr}
            AND B.AUD_NO = #{audNo}
            AND B.AUD_STEP_CD = #{audStepCd}
            AND B.DOC_ID = #{docId}
      </select>
      
      <select id="selExamCluCd" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP006EMapper.selExamCluCd */
        <![CDATA[
        SELECT T2.CD AS EXAM_CLU_DVSN_CD
          FROM TBDCMACM013C T2
         WHERE T2.CMM_CD_DVSN_CD = '1001031'
           AND T2.CD != '000000000'
           AND T2.USE_YN  = (SELECT CASE WHEN CNT = 0 OR CNT = (SELECT COUNT(*)
                                                                  FROM TBDCMACM013C
                                                                 WHERE CMM_CD_DVSN_CD = '1001031'
                                                                   AND CD != '000000000'
                                                                   AND USE_YN = 'Y') THEN 'Y'
                                     ELSE 'N'
                                    END
                               FROM (SELECT COUNT(*) AS CNT
                                       FROM TBBADDED142D T1
                                      WHERE T1.AUD_YR = #{audYr}
                                        AND T1.AUD_NO = #{audNo}
                                        AND T1.RPRT_CD = #{rprtCd}
                                        AND T1.RPRT_FILD_ID = #{rprtFildId}
                                        AND T1.DOC_ID = #{docId})
                            )
        ]]>
      </select>
      
      <insert id="insertBadded142d" parameterType="paramMap">
	    /* kr.go.bai.eip.aep.arp.dao.AEPARP006EMapper.insertBadded142d */
	        INSERT INTO TBBADDED142D (
	              AUD_YR
	            , AUD_NO
	            , AUD_STEP_CD
	            , RPRT_CD
	            , DOC_ID
	            , APVR_CD
	            , AFF_SNO
	            , EXAM_CLU_DVSN_CD
	            , CNB
	            , AUD_SBJ_NM_TXT
	            , DPT_NM_TXT
	            , AUD_RPRT_NUM_TXT
	            , TITLE_NM_TXT
	            , OPIN_TXT
	            , OPIN_BRF_TXT
	            , RPRT_FILD_ID
	            , FRT_USR_ID
	            , FNL_USR_ID
	            , FNL_DEAL_DPT_CD
	            , FNL_MNU_ID
	            , FRT_REGI_DH
	            , FNL_MDF_DH
	        ) VALUES (
	              #{audYr}
	            , #{audNo}
	            , #{audStepCd}
	            , #{rprtCd}
	            , #{docId}
	            , #{apvrCd}
	            , #{affSno}
	            , #{examCluDvsnCd}
	            , #{cnb}
	            , (SELECT AUD_SBJ_NM FROM TBBADDED001M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo})
	            , (SELECT F_DPT_INFO(MNG_DPT_CD, '1') FROM TBBADDED001M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo})
	            , #{audRprtNumTxt}
	            , #{titleNmTxt}
	            , #{opinTxt}
	            , #{opinBrfTxt}
	            , #{rprtFildId}
	            , #{usrId}
	            , #{usrId}
	            , #{dptCd}
	            , #{menuNo}
	            , SYSDATE
	            , SYSDATE
	        )
      </insert>
      
      <delete id="deleteBadded142d" parameterType="paramMap">
      /* kr.go.bai.eip.aep.arp.dao.AEPARP006EMapper.deleteBadded142d */
         DELETE FROM TBBADDED142D
          WHERE AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = #{audStepCd}
            AND DOC_ID = #{docId}
      </delete>
    
</mapper> 
