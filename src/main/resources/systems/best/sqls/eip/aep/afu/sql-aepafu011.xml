<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.afu.dao.AEPAFU011QMapper">
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.afu.dao.AEPAFU011QMapper.selectMainList*/
        <include refid="include.pageSelct" />
            <![CDATA[
            SELECT D.AUD_YR_NO
                  ,D.AUD_YR
                  ,D.AUD_NO
                  ,D.AUD_KND_CD
                  ,D.AUD_KND_NM
                  ,D.AUD_SBJ_NM
                  ,D.BZT_BGT_DVSN_NM
                  ,D.AUD_RPST_ORG_NM
                  ,D.MNG_DPT_NM
                  ,D.REQ_DVSN_NM
                  ,D.PRSS_STEP_CD
                  ,D.PRSS_STEP_NM
                  ,D.RPRT_DOC_ID1
                  ,D.RPRT_NM1
                  ,D.RPRT_DOC_ID2
                  ,D.RPRT_NM2
                  ,D.APV_RQS_ID
                  ,D.CODE_NM
                  ,D.CODE
                  ,D.RPRT_YN1
                  ,D.RPRT_YN2
                  ,D.DOC_TYPE
              FROM (
	            SELECT  C.AUD_YR_NO  /*분류번호*/
	                   ,C.AUD_YR
	                   ,C.AUD_NO
	                   ,C.AUD_KND_CD
	                   ,C.AUD_KND_NM
	                   ,C.AUD_SBJ_NM    /*감사사항명*/
	                   ,C.BZT_BGT_DVSN_NM   /*예산구분*/
	                   ,C.AUD_RPST_ORG_NM    /*감사대표기관*/
	                   ,C.MNG_DPT_NM       /*관리부서*/
	                   ,C.REQ_DVSN_NM      /*관련업무*/
	                   ,C.PRSS_STEP_CD   
	                   ,C.PRSS_STEP_NM     /*진행단계*/
	                   ,C.RPRT_DOC_ID1       
	                   ,C.RPRT_NM1        
	                   ,C.RPRT_DOC_ID2       
	                   ,C.RPRT_NM2
	                   ,C.APV_RQS_ID
	                   ,F_CODE_NM('1000348', C.CODE) AS CODE_NM
	                   ,C.CODE
	                   ,DECODE(C.RPRT_DOC_ID1,NULL,'N','Y') AS RPRT_YN1        /*실지감사계획서 작성여부*/
	                   ,DECODE(C.RPRT_DOC_ID2,NULL,'N','Y') AS RPRT_YN2       /*감사활동 조정전 작성여부*/
	                   ,C.DOC_TYPE
	            FROM 
	            (SELECT F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, A.AUD_KND_CD, '-') AS AUD_YR_NO
	                   ,A.AUD_YR
	                   ,A.AUD_NO
	                   ,A.AUD_KND_CD
	                   ,A.AUD_SBJ_NM
	                   ,F_CODE_NM('1000739',A.AUD_KND_CD) AS AUD_KND_NM
	                   ,F_CODE_NM('1000751',A.BZT_BGT_DVSN_CD) AS BZT_BGT_DVSN_NM  
	                   ,F_ORG_INFO(A.AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM
	                   ,F_DPT_INFO(A.MNG_DPT_CD,'1')  AS MNG_DPT_NM  
	                   ,F_CODE_NM('1000337',A.REQ_DVSN_CD) AS REQ_DVSN_NM 
	                   ,A.PRSS_STEP_CD
	                   ,CASE WHEN A.PRSS_STEP_CD LIKE 'A10%' THEN (SELECT T1.AUD_STEP_NM  
	                                                                 FROM TBBADDED101M T1 
	                                                                WHERE T1.AUD_YR = A.AUD_YR
	                                                                  AND T1.AUD_NO = A.AUD_NO
	                                                                  AND T1.AUD_STEP_CD = A.PRSS_STEP_CD)
	                        ELSE NULL END  AS PRSS_STEP_NM  
	                   ,(SELECT T2.DOC_ID 
	                       FROM TBBADDED103M T2 
	                      WHERE T2.AUD_YR = A.AUD_YR 
	                        AND T2.AUD_NO = A.AUD_NO 
	                        AND T2.RPRT_CD = B.RPRT_CD
	                        AND T2.APV_RQS_ID = B.APV_RQS_ID
	                        AND EXISTS (SELECT 1 
	                            FROM TBDCMACM023L T3 
	                           WHERE T3.APV_DOC_NO = T2.APV_RQS_ID 
	                           AND (SELECT F.DPT_CD FROM TBDCMACM001M F WHERE F.CNB = T3.APVR_CNB) IN ('140000' ,'140100')
	                           AND T3.APVR_KND_CD = 4
	                           AND T3.APVR_STA_CD IN ('204', '104')
	                           AND T3.APV_DOC_NO  = T2.APV_RQS_ID )
	                           AND ROWNUM  = 1)  AS RPRT_DOC_ID1
	                   ,(SELECT T2.RPRT_NM 
	                       FROM TBBADDED103M T2 
	                      WHERE T2.AUD_YR = A.AUD_YR 
	                        AND T2.AUD_NO = A.AUD_NO 
	                        AND T2.RPRT_CD = B.RPRT_CD
	                        AND T2.APV_RQS_ID = B.APV_RQS_ID
	                        AND EXISTS (SELECT 1 
	                            FROM TBDCMACM023L T3 
	                           WHERE T3.APV_DOC_NO = T2.APV_RQS_ID 
	                           AND (SELECT F.DPT_CD FROM TBDCMACM001M F WHERE F.CNB = T3.APVR_CNB) IN ('140000' ,'140100')
	                           AND T3.APVR_KND_CD = 4
	                           AND T3.APVR_STA_CD IN ('204', '104')
	                           AND T3.APV_DOC_NO  = T2.APV_RQS_ID )
	                           AND ROWNUM  = 1)  AS RPRT_NM1
	                   ,(SELECT T2.DOC_ID FROM TBBADDED103M T2 WHERE T2.AUD_YR = A.AUD_YR AND T2.AUD_NO = A.AUD_NO AND T2.RPRT_CD = 'A10300400' AND ROWNUM = 1) AS RPRT_DOC_ID2
	                   ,(SELECT T2.RPRT_NM FROM TBBADDED103M T2 WHERE T2.AUD_YR = A.AUD_YR AND T2.AUD_NO = A.AUD_NO AND T2.RPRT_CD = 'A10300400' AND ROWNUM = 1) AS RPRT_NM2
	                   ,B.APV_RQS_ID
	                   ,(SELECT  E.APVR_STA_CD
	                      FROM TBBADDED103M D INNER JOIN TBDCMACM023L E
	                        ON D.APV_RQS_ID = E.APV_DOC_NO
	                       AND D.RPRT_CD = 'A10300100' 
	                       AND E.APVR_KND_CD = 4
	                       AND E.APV_SNO = (SELECT MAX(K.APV_SNO) 
	                                          FROM  TBDCMACM023L K 
	                                         WHERE K.APV_DOC_NO = E.APV_DOC_NO 
	                                           AND K.APVR_KND_CD = 4 
	                                           AND K.APVR_STA_CD IN ('204', '104')
	                                           AND (SELECT F.DPT_CD FROM TBDCMACM001M F WHERE F.CNB = K.APVR_CNB) IN ('140000' ,'140100') ) 
	                       AND (SELECT F.DPT_CD FROM TBDCMACM001M F WHERE F.CNB = E.APVR_CNB) IN ('140000' ,'140100') 
	                      WHERE D.AUD_YR = A.AUD_YR 
	                        AND D.AUD_NO = A.AUD_NO 
	                        ) AS CODE
	                   , F_OPEN_EDIT(B.LINK_URL)    AS DOC_TYPE  -- 편집기구분
	             FROM TBBADDED001M A INNER JOIN TBBADDED103M B
	               ON A.AUD_YR = B.AUD_YR
	              AND A.AUD_NO = B.AUD_NO
	              AND B.AUD_STEP_CD = 'A1030'
	              AND B.RPRT_CD = 'A10300100'
	            WHERE 1=1
	            ]]>
				               
	           <if test="audYr != null and audYr != '' "> 
	               AND A.AUD_YR = #{audYr} 
	           </if>
	           <if test="audYrNoKndCd != null and audYrNoKndCd != ''">
	               AND A.AUD_KND_CD = #{audYrNoKndCd}
	           </if>
	           <if test="audGrnNo != null and audGrnNo != '' ">
	               AND A.AUD_GRN_NO = #{audGrnNo}  /*감사번호*/
	           </if>
				 AND A.AUD_KND_CD <![CDATA[<>]]> '175'
				 ) C  
			 ) D
		WHERE 1=1
          AND CODE IS NOT NULL
          <if test="rprtYn1 != null and rprtYn1 != '' ">
             AND D.RPRT_YN1 = #{rprtYn1}
          </if>
          <if test="rprtYn2 != null and rprtYn2 != '' ">
             AND D.RPRT_YN2 = #{rprtYn2}
          </if>
         ORDER BY   DECODE(PRSS_STEP_CD, 'A1030', '1', PRSS_STEP_CD), DECODE(RPRT_DOC_ID1,  NULL, 1), RPRT_DOC_ID2 NULLS FIRST
        <include refid="include.pageOrder" />
    </select>

    <select id="selectMdtRprtDocId" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.afu.dao.AEPAFU011QMapper.selectMdtRprtDocId*/
            SELECT MAX(DOC_ID) AS DOC_ID
              FROM TBFDMADM002M
             WHERE AUD_DOC_CD = 'A10300400'
    </select>
    
    <update id="deleteDocument" parameterType="paramMap">
    /* kr.go.bai.eip.aep.afu.dao.AEPAFU011QMapper.deleteDocument*/
        DELETE FROM TBBADDED103M
        WHERE
        AUD_YR  = #{audYr}
        AND AUD_NO  = #{audNo}
        AND AUD_STEP_CD  = #{audStepCd}
        AND DOC_ID  = #{docId}
    </update>  
    
</mapper>