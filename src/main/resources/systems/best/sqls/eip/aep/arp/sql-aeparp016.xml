<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper">
    
   <select id="selectDocList" parameterType="paramMap" resultType="egovMap" >
   <![CDATA[
        /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectDocList */
        SELECT A.AUD_YR        -- 감사년도
		     , A.AUD_NO        -- 감사번호
		     , A.SRNO	       -- 일련번호
		     , DECODE(A.MFEX_DVSN_CD,'10',A.MFEX_NO,A.IMMUN_NO)      AS YR_SRNO        -- 소명자료관리번호
		     , TO_CHAR(TO_DATE(A.SMT_DT,'yyyyMMdd'),'yyyy-MM-dd')    AS SMT_DT	       -- 제출일자
		     , A.SMT_ORG_NM                                          AS RLTN_ORG_NM    -- 제출기관
		     , A.PRSR          -- 제출자
		     , (SELECT COUNT(1)
		          FROM TBCSPKDE106M AA
		          INNER JOIN 
		               TBBADDED145M BB
		            ON AA.AUD_YR = BB.AUD_YR
		           AND AA.AUD_NO = BB.AUD_NO
		           AND AA.AFF_SNO = BB.AFF_SNO 
                   AND NVL(AA.RPRT_FILD_ID,'@') = NVL(BB.RPRT_FILD_ID,'@')
		         WHERE AA.AUD_YR = A.AUD_YR
		           AND AA.AUD_NO = A.AUD_NO
		           AND AA.SRNO = A.SRNO
		           AND AA.MFEX_DVSN_CD = A.MFEX_DVSN_CD
		           AND BB.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
                                   FROM (
                                         SELECT RANK() OVER (PARTITION BY A.DOC_ID ORDER BY DECODE(A.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
                                            , A.APVR_CD APVR_CD
                                            , A.DOC_ID
                                         FROM TBBADDED145M A
                                        WHERE A.AUD_YR = #{audYr}
                                          AND A.AUD_NO  = #{audNo}
                                          AND A.APVR_CD <> '0010200'
                                        GROUP BY A.DOC_ID, A.APVR_CD )   
                                  WHERE RN = 1 
                                    AND BB.DOC_ID = DOC_ID) )   || '건'   AS AFF_MPP_CNT  -- 개별사건정보 개수
		     , (SELECT COUNT(1)
		          FROM TBCSPKDE104M AA
		         WHERE AA.AUD_YR = A.AUD_YR
		           AND AA.AUD_NO = A.AUD_NO
		           AND AA.SRNO = A.SRNO   )  || '건'   AS MT_CNT      -- 소명서 개수
		     , TO_CHAR(A.SPV_DPT_RCV_DT,'yyyy-MM-dd')            AS SPV_DPT_RCV_DT       -- 접수일자
		     , (CASE WHEN NVL(A.CLSNG_YN,'N') = 'Y'                                                             THEN '완료'
		             WHEN NVL(A.CLSNG_YN,'N') = 'N' AND A.SPV_DPT_RCV_DT IS NOT NULL AND ('Y' = (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																					              FROM TBBADDED103M T1
																						         WHERE T1.AUD_YR = A.AUD_YR
																						 	       AND T1.AUD_NO = A.AUD_NO
																						 	       AND T1.RPRT_CD IN ('A10600900','A10600960')
																						 	       AND T1.REF_DY = A.SRNO || A.MFEX_DVSN_CD)  OR 'Y' = (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																																				              FROM TBBADDED103M T1
																																					         WHERE T1.AUD_YR = A.AUD_YR
																																					 	       AND T1.AUD_NO = A.AUD_NO
																																					 	       AND T1.RPRT_CD IN ('A10600900','A10600960')
																																					 	       AND T1.REF_DY IN (SELECT TO_CHAR(AA.AFF_SNO)
																																					 			  			         FROM TBCSPKDE106M AA
																																					 						        WHERE AA.AUD_YR = A.AUD_YR
																																												      AND AA.AUD_NO = A.AUD_NO
																																												      AND AA.SRNO = A.SRNO )  )) THEN  '처리중'
		             WHEN NVL(A.CLSNG_YN,'N') = 'N' AND A.SPV_DPT_RCV_DT IS NOT NULL                            THEN  '접수' 
		                                                                                                        ELSE ''
		         END) AS SPV_DPT_OM_RCV_STA   -- 상태
		     , A.MFEX_DVSN_CD       -- 소명자료 구분 코드
		     , (DECODE(A.MFEX_DVSN_CD,'20','A1096','A1095')) AS AUD_STEP_CD -- 감사단계코드
		     , A.RECEV_DY           -- 소명자료 접수년도
             , A.GRN_SRNO           -- 소명자료 부여번호
             , DECODE(A.SPV_DPT_RCV_DT,NULL,'N','Y')         AS SPV_DPT_RCV_YN  -- 소명자료 접수여부
             , A.AUD_KND_CD
             , A.AUD_GRN_NO
             , NVL(A.CLSNG_YN,'N')                           AS CLSNG_YN      -- 마감여부
		  FROM TBCSPKDE103M_VIEW A
		 WHERE A.AUD_YR = #{audYr}
		   AND A.AUD_NO = #{audNo}
		   AND A.SPV_DPT_OM_YN = 'Y'
		   AND NVL(A.CLSNG_YN,'N') != 'F'
		 ORDER BY
		       A.FRT_REGI_DH DESC 
		     , DECODE(A.MFEX_DVSN_CD,'10',A.MFEX_NO,A.IMMUN_NO) DESC
		    ]]>
    </select>
    
    <select id="selectMainTskPrcsList" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectMainTskPrcsList */
        
        /*실지감사 주요업무 프로세스 sql*/
        SELECT A.AUD_MAIN_STEP_ID  /*주요업무코드*/
             , A.AUD_STEP_CD /*감사단계코드*/
             , A.AUD_MAIN_STEP_SNO  /*주요업무순번 */
             , A.AUD_MAIN_SEQ_W /*주요업무순서_가로 */
             , A.AUD_MAIN_SEQ_H /*주요업무순서_세로 */
             , (CASE WHEN A.AUD_MAIN_STEP_ID = '950201' 			 THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																	         FROM TBBADDED103M T1
																	        WHERE T1.AUD_YR = A.AUD_YR
																	 	      AND T1.AUD_NO = A.AUD_NO
																 		      AND T1.RPRT_CD = 'A10600900'
																 		      AND ( T1.REF_DY IN (SELECT TO_CHAR(AA.AFF_SNO)
																					  			    FROM TBCSPKDE106M AA
																							       WHERE AA.AUD_YR = #{audYr}
																								     AND AA.AUD_NO = #{audNo}
																								     AND AA.SRNO = #{srno} )
																	                OR T1.REF_DY = #{srno} || #{mfexDvsnCd}))             -- 소명자료 검토보고서 작성
                     WHEN A.AUD_MAIN_STEP_ID = '960201' 		     THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																	         FROM TBBADDED103M T1
																	        WHERE T1.AUD_YR = A.AUD_YR
																		      AND T1.AUD_NO = A.AUD_NO
																		      AND T1.RPRT_CD = 'A10600960'
																		      AND (T1.REF_DY IN (SELECT TO_CHAR(AA.AFF_SNO)
																					 			   FROM TBCSPKDE106M AA
																					 		      WHERE AA.AUD_YR = #{audYr}
																								    AND AA.AUD_NO = #{audNo}
																								    AND AA.SRNO = #{srno} )
																				  OR T1.REF_DY = #{srno} || #{mfexDvsnCd} ))             -- 적극행정면책 검토보고서 작성
                     WHEN A.AUD_MAIN_STEP_ID IN ('950301','960301')  THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																	         FROM TBBADDED103M T1
																	        WHERE T1.AUD_YR = A.AUD_YR
																		      AND T1.AUD_NO = A.AUD_NO
																		      AND T1.RPRT_CD = 'A10700900'
																		      AND (T1.REF_ID IN (SELECT TO_CHAR(AA.AFF_SNO)
																				 				   FROM TBCSPKDE106M AA
																							      WHERE AA.AUD_YR = #{audYr}
																								    AND AA.AUD_NO = #{audNo}
																								    AND AA.SRNO = #{srno} )
																				  OR T1.REF_ID = #{srno} || #{mfexDvsnCd} ))             -- 권익보호관용 처리안 작성
				     WHEN A.AUD_MAIN_STEP_ID IN ('950101','960101')  THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																	         FROM TBCSPKDE106M AA
																	        WHERE AA.AUD_YR = A.AUD_YR
																	          AND AA.AUD_NO = A.AUD_NO
																	          AND AA.SRNO = #{srno}
																	          AND AA.MFEX_DVSN_CD = #{mfexDvsnCd}  )		        -- 개별사건연결	
				     WHEN A.AUD_MAIN_STEP_ID IN ('950401','960401')  THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END )
													                         FROM TBCSPKDE107M T4
													                        WHERE T4.AUD_YR = A.AUD_YR
													                          AND T4.AUD_NO = A.AUD_NO
													                          AND T4.AFF_SNO IN (SELECT AA.AFF_SNO
																								  FROM TBCSPKDE106M AA
																							     WHERE AA.AUD_YR = #{audYr}
																								   AND AA.AUD_NO = #{audNo}
																								   AND AA.SRNO = #{srno}
																								   AND AA.MFEX_DVSN_CD = #{mfexDvsnCd} )
													                          AND T4.EVI_OPEN_STAT_YN = 'Y')	   -- 권익보호관증거서류 람처리(선택)				   
                                                     			     ELSE A.CMPT_YN
                 END)             AS CMPT_YN /*완료여부*/
             , A.AUD_GRN_NO  /*감사부여번호*/
             , A.AUD_DOC_CD /*문서ID*/
             , TRIM(A.MAIN_JOB_NM) AS MAIN_JOB_NM /*주요업무명*/
             , TRIM(A.LINK_TYPE) AS LINK_TYPE/*링크유형*/
             , DECODE(TRIM(A.LINK_TYPE), 'NAN', ''
                                 , 'POP', A.LINK_URL
                                 , 'FNC', A.LINK_URL
                                 , (SELECT DOC_ID
                                      FROM TBFDMADM002M B
                                     WHERE A.AUD_DOC_CD = B.AUD_DOC_CD
                                       AND B.DOC_KND_CD = DECODE(A.LINK_TYPE, 'DOC', '10', '20')
                                       AND NVL(AUD_RPRT_TYPE_CD, SUBSTR(A.AUD_KND_CD, 3, 3)) = SUBSTR(A.AUD_KND_CD, 3, 3)
                                   <if test='audStepCd == "A1050"'>
                                       AND B.DTIL_AUD_DOC_NO = DECODE(B.AUD_DOC_CD,'A10500100','162',
                                                                    (SELECT CASE WHEN T1.REQ_DVSN_CD IN ('2', '3') THEN '394'
                                                                            ELSE '163'
                                                                       END
                                                                  FROM TBBADDED001M T1
                                                                 WHERE T1.AUD_YR = #{audYr}
                                                                   AND T1.AUD_NO = #{audNo}
                                                                  ))
                                   </if>
                                   )
                     ) AS LINK_URL /*링크주소*/
          FROM TBBADDED102M A
         WHERE 1=1
        <if test='audYr != null and audYr != ""'>
           AND A.AUD_YR = #{audYr} /* PARAM : 감사년도 */
        </if>
        <if test='audNo != null and audNo != ""'>
           AND A.AUD_NO = #{audNo}/* PARAM : 감사연번(내부  pk 번호) */
        </if>
        <if test='audKndCd != null and audKndCd != ""'>
           AND A.AUD_KND_CD = #{audKndCd}
        </if>
        <if test='audStepCd != null and audStepCd != ""'>
           AND A.AUD_STEP_CD = #{audStepCd} /* PARAM : 감사단계코드  */
        </if>
        <if test='audMainStepSno != null and audMainStepSno != ""'>
           AND A.AUD_MAIN_STEP_SNO = #{audMainStepSno} /* PARAM : 주요업무 순번  */
        </if>
        <if test='audMainStepDsvnCd != null and audMainStepDsvnCd != ""'>
           AND SUBSTR(A.AUD_MAIN_STEP_ID,0,2) = #{audMainStepDsvnCd} /* PARAM : 주요업무구분코드(AUD_MAIN_STEP_ID 앞 2자리) */
        </if>
         ORDER BY A.AUD_MAIN_STEP_SNO, A.AUD_MAIN_SEQ_W ASC
    </select>
    
    <select id="selectRprtApvList" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectRprtApvList */
        <![CDATA[
            SELECT G1.RPRT_NM
                  ,G1.APV_STA_CD
                  ,G1.APV_STA_NM
                  ,G1.DOC_ID
                  ,G1.APV_RQS_ID
                  ,MAX(G1.APV_INFO_1) AS APV_INFO_1
                  ,MAX(G1.APV_INFO_2) AS APV_INFO_2
                  ,MAX(G1.APV_INFO_3) AS APV_INFO_3
                  ,MAX(G1.APV_INFO_4) AS APV_INFO_4
                  ,MAX(G1.APV_INFO_5) AS APV_INFO_5
                  ,MAX(G1.APV_INFO_6) AS APV_INFO_6
                  ,MAX(G1.APV_INFO_7) AS APV_INFO_7
                  ,(
                    CASE WHEN G1.RPRT_CD = 'A10600900' THEN 
                          (SELECT (CASE WHEN COUNT(1) = 1  THEN 'P' 
                                            WHEN COUNT(1) > 1  THEN 'Y' 
                                             ELSE 'N' END)
                             FROM TBBADDED111M T3
                            WHERE T3.AUD_YR = G1.AUD_YR
                              AND T3.AUD_NO = G1.AUD_NO
                              AND T3.RPRT_CD = G1.RPRT_CD
                              AND T3.REF_DY = G1.AFF_SNO)
                          WHEN G1.RPRT_CD = 'A10600960' THEN 
                           (SELECT  (CASE WHEN COUNT(1) > 0 THEN 'Y'
                                        ELSE 'N' END)
                             FROM TBBADDED111M T3
                            WHERE T3.AUD_YR = G1.AUD_YR
                              AND T3.AUD_NO = G1.AUD_NO
                              AND T3.RPRT_CD = G1.RPRT_CD
                              AND T3.REF_DY = G1.AFF_SNO)
                          ELSE 
                          (SELECT (CASE WHEN COUNT(1) > 0 THEN 'Y'
                                        ELSE 'N' END)
                             FROM TBBADDED111M T3
                            WHERE T3.AUD_YR = G1.AUD_YR
                              AND T3.AUD_NO = G1.AUD_NO
                              AND T3.RPRT_CD = G1.RPRT_CD
                              AND T3.REF_ID = G1.AFF_SNO)
                          END
                   ) AS SEND_YN
                  ,G1.RPRT_CD
                  , (SELECT DECODE(COUNT(1), 0, 'N', 'Y') FROM TBDCMACM023H ST1 WHERE ST1.APV_DOC_NO = G1.APV_RQS_ID AND ST1.APVR_STA_CD NOT IN ('301', '201')) AS APV_HIS_YN
                  ,G1.AFF_SNO
                  ,G1.DOC_TYPE
              FROM (
                SELECT AUD_YR
                      ,AUD_NO
                      ,RPRT_CD
                      ,RPRT_NM
                      ,APV_STA_CD
                      ,APV_STA_NM
                      ,DOC_ID
                      ,APV_RQS_ID
                      ,AFF_SNO
                      ,DOC_TYPE
                      ,DECODE(ROW_ID, 1, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_1
                      ,DECODE(ROW_ID, 2, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_2
                      ,DECODE(ROW_ID, 3, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_3
                      ,DECODE(ROW_ID, 4, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_4
                      ,DECODE(ROW_ID, 5, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_5
                      ,DECODE(ROW_ID, 6, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_6
                      ,DECODE(ROW_ID, 7, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_7
                  FROM (
                    SELECT AUD_YR
                          ,AUD_NO
                          ,RPRT_CD
                          ,RPRT_NM
                          ,APV_STA_CD
                          ,APV_STA_NM
                          ,DOC_ID
                          ,APV_RQS_ID
                          ,PST_NM
                          ,APVR_NM
                          ,APV_DH
                          ,AFF_SNO
                          ,DOC_TYPE
                          ,ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SNO) AS ROW_ID 
                      FROM (
                        SELECT T1.AUD_YR
                              ,T1.AUD_NO
                              ,T1.RPRT_CD
                              ,T1.RPRT_NM
                              ,T1.APV_STA_CD
                              ,F_CODE_NM('1000773',APV_STA_CD) AS APV_STA_NM
                              ,T1.DOC_ID
                              ,T2.APV_SNO
                              ,T1.APV_RQS_ID
                              ,CASE WHEN APVR_PST_CD IS NULL
                                    THEN (SELECT MAX(ONR_PST_NM) FROM TBDCMACM001M WHERE CNB = APVR_CNB)
                                    ELSE F_CODE_NM('1000176', T2.APVR_PST_CD)
                               END  AS PST_NM
                              ,F_USR_INFO(T2.APVR_CNB, '2') AS APVR_NM
                              ,CASE WHEN SUBSTR(T2.APVR_STA_CD,0,1) = '2' THEN TO_CHAR(T2.APV_DH, 'YYYY-MM-DD')
                                    ELSE ''
                               END  AS APV_DH
                              ,T1.REF_DY AS AFF_SNO
                              ,F_OPEN_EDIT(T1.LINK_URL) AS DOC_TYPE
                          FROM TBBADDED103M T1
                         LEFT OUTER JOIN TBDCMACM023L T2 ON
                                    T1.APV_RQS_ID = T2.APV_DOC_NO
                                AND T2.APV_SNO <> '1' --(기안자 제외)
                                AND T2.APVR_KND_CD <> '4' --(협조자 제외)
                         WHERE T1.AUD_YR = #{audYr}
                           AND T1.AUD_NO = #{audNo}
                           AND T1.RPRT_CD IN ( 'A10600900', 'A10600960')
                           AND ( T1.REF_DY IN (SELECT AA.AFF_SNO
											     FROM TBCSPKDE106M AA
										        WHERE AA.AUD_YR = #{audYr}
											      AND AA.AUD_NO = #{audNo}
											      AND AA.SRNO = #{srno} ) 
			                     OR T1.REF_DY = #{srno} || #{mfexDvsnCd} )
                         UNION ALL
                        SELECT T1.AUD_YR
                              ,T1.AUD_NO
                              ,T1.RPRT_CD
                              ,T1.RPRT_NM
                              ,T1.APV_STA_CD
                              ,F_CODE_NM('1000773',APV_STA_CD) AS APV_STA_NM
                              ,T1.DOC_ID
                              ,T2.APV_SNO
                              ,T1.APV_RQS_ID
                              ,CASE WHEN APVR_PST_CD IS NULL
                                    THEN (SELECT MAX(ONR_PST_NM) FROM TBDCMACM001M WHERE CNB = APVR_CNB)
                                    ELSE F_CODE_NM('1000176', T2.APVR_PST_CD)
                               END  AS PST_NM
                              ,F_USR_INFO(T2.APVR_CNB, '2') AS APVR_NM
                              ,CASE WHEN SUBSTR(T2.APVR_STA_CD,0,1) = '2' THEN TO_CHAR(T2.APV_DH, 'YYYY-MM-DD')
                                    ELSE ''
                               END  AS APV_DH
                              ,T1.REF_ID AS AFF_SNO
                              ,F_OPEN_EDIT(T1.LINK_URL) AS DOC_TYPE
                          FROM TBBADDED103M T1
                         LEFT OUTER JOIN TBDCMACM023L T2 ON
                                    T1.APV_RQS_ID = T2.APV_DOC_NO
                                AND T2.APV_SNO <> '1' --(기안자 제외)
                                AND T2.APVR_KND_CD <> '4' --(협조자 제외)
                         WHERE T1.AUD_YR = #{audYr}
                           AND T1.AUD_NO = #{audNo}
                           AND T1.RPRT_CD = 'A10700900'
                           AND ( T1.REF_ID IN (SELECT AA.AFF_SNO
								   			     FROM TBCSPKDE106M AA
										        WHERE AA.AUD_YR = #{audYr}
											      AND AA.AUD_NO = #{audNo}
											      AND AA.SRNO = #{srno} )
								  OR T1.REF_ID = #{srno} || #{mfexDvsnCd} )		    
											     
                            ) 
                        )
                    ) AS G1
            GROUP BY G1.AUD_YR
                    ,G1.AUD_NO
                    ,G1.RPRT_CD
                    ,G1.RPRT_NM
                    ,G1.APV_STA_CD
                    ,G1.APV_STA_NM
                    ,G1.DOC_ID
                    ,G1.APV_RQS_ID
                    ,G1.AFF_SNO
                    ,G1.DOC_TYPE
            ORDER BY 
                  G1.AFF_SNO
                , G1.RPRT_CD
        ]]>
    </select>
    
    <select id="selectOpinRprtApvList" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectOpinRprtApvList */
        <![CDATA[
            SELECT G1.RPRT_NM
                  ,G1.APV_STA_CD
                  ,G1.APV_STA_NM
                  ,G1.DOC_ID
                  ,G1.APV_RQS_ID
                  ,MAX(G1.APV_INFO_1) AS APV_INFO_1
                  ,MAX(G1.APV_INFO_2) AS APV_INFO_2
                  ,MAX(G1.APV_INFO_3) AS APV_INFO_3
                  ,MAX(G1.APV_INFO_4) AS APV_INFO_4
                  ,MAX(G1.APV_INFO_5) AS APV_INFO_5
                  ,MAX(G1.APV_INFO_6) AS APV_INFO_6
                  ,MAX(G1.APV_INFO_7) AS APV_INFO_7
                  ,(
                    SELECT TO_CHAR(SND_DH,'YYYY"-"MM"-"DD') AS SND_DH
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
    				   AND (T3.REF_ID = #{srno} OR T3.REF_ID IN (SELECT TO_CHAR(NVL(AFF_SNO,0))
			                                                     FROM TBCSPKDE106M
			                                                    WHERE AUD_YR = #{audYr}
			                                                      AND AUD_NO = #{audNo}
			                                                      AND SRNO = #{srno}))
                       AND T3.RCPT_DPT_CD IN ('180130', '151100') 
                       AND T3.LINK_URL LIKE '%'||G1.DOC_ID||''
                   ) AS SND_DH
                  ,(
                    SELECT DECODE(COUNT(1), 2, 'E', 1, 'Y', 'N')
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
    				   AND (T3.REF_ID = #{srno} OR T3.REF_ID IN (SELECT TO_CHAR(NVL(AFF_SNO,0))
			                                                     FROM TBCSPKDE106M
			                                                    WHERE AUD_YR = #{audYr}
			                                                      AND AUD_NO = #{audNo}
			                                                      AND SRNO = #{srno}))
                       AND T3.RCPT_DPT_CD IN ('510000', '160200', '180130', '151100') 
                   ) AS SEND_YN
                  ,G1.RPRT_CD
                  , (SELECT DECODE(COUNT(1), 0, 'N', 'Y') FROM TBDCMACM023H ST1 WHERE ST1.APV_DOC_NO = G1.APV_RQS_ID AND ST1.APVR_STA_CD NOT IN ('301', '201')) AS APV_HIS_YN
                  , G1.DOC_TYPE
              FROM (
                SELECT AUD_YR
                      ,AUD_NO
                      ,RPRT_CD
                      ,RPRT_NM
                      ,APV_STA_CD
                      ,APV_STA_NM
                      ,DOC_ID
                      ,APV_RQS_ID
                      ,(SELECT DISTINCT 'Y' FROM TBBADDED103M A, TBDCMACM023L B
                                  WHERE A.APV_RQS_ID = B.APV_DOC_NO
                                    AND A.AUD_YR = AUD_YR
                                    AND A.AUD_NO = AUD_NO
                                    AND A.AUD_YR = #{audYr}
                                    AND A.AUD_NO = #{audNo}
                                    AND A.AUD_STEP_CD = 'A1060'
                                    AND A.RPRT_CD = 'A10600200'
                                    AND B.APVR_PST_CD = '0055700'
                                    AND B.APVR_STA_CD IN ('202','203') ) AS APV_YN /* 개별처리안 사무총장 결재 여부 */
                      ,(SELECT T1.ADV_COMMIT_END_YN FROM TBCSPKDE109M T1 
                                                   WHERE T1.ADV_COMMIT_YY = (SELECT MAX(ADV_COMMIT_YY) FROM TBCSPKDE103M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND SRNO = #{srno})  
                                                     AND T1.ADV_COMMIT_SRNO = (SELECT MAX(ADV_COMMIT_SRNO) FROM TBCSPKDE103M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND SRNO = #{srno}) ) AS ADV_YN
                      ,DECODE(ROW_ID, 1, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_1
                      ,DECODE(ROW_ID, 2, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_2
                      ,DECODE(ROW_ID, 3, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_3
                      ,DECODE(ROW_ID, 4, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_4
                      ,DECODE(ROW_ID, 5, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_5
                      ,DECODE(ROW_ID, 6, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_6
                      ,DECODE(ROW_ID, 7, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_7
                      ,DOC_TYPE
                  FROM (
                    SELECT AUD_YR
                          ,AUD_NO
                          ,RPRT_CD
                          ,RPRT_NM
                          ,APV_STA_CD
                          ,APV_STA_NM
                          ,DOC_ID
                          ,APV_RQS_ID
                          ,PST_NM
                          ,APVR_NM
                          ,APV_DH
                          ,DOC_TYPE
                          ,ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SNO) AS ROW_ID 
                      FROM (
                        SELECT T1.AUD_YR
                              ,T1.AUD_NO
                              ,T1.RPRT_CD
                              ,T1.RPRT_NM
                              ,T1.APV_STA_CD
                              ,F_CODE_NM('1000773',APV_STA_CD) AS APV_STA_NM
                              ,T1.DOC_ID
                              ,T2.APV_SNO
                              ,T1.APV_RQS_ID
                              ,CASE WHEN APVR_PST_CD IS NULL
                                    THEN (SELECT MAX(ONR_PST_NM) FROM TBDCMACM001M WHERE CNB = APVR_CNB)
                                    ELSE F_CODE_NM('1000176', T2.APVR_PST_CD)
                               END  AS PST_NM
                              ,F_USR_INFO(T2.APVR_CNB, '2') AS APVR_NM
                              ,CASE WHEN SUBSTR(T2.APVR_STA_CD,0,1) = '2' THEN TO_CHAR(T2.APV_DH, 'YYYY-MM-DD')
                                    ELSE ''
                               END  AS APV_DH
                              ,F_OPEN_EDIT(T1.LINK_URL) AS DOC_TYPE
                          FROM TBBADDED103M T1
                         LEFT OUTER JOIN TBDCMACM023L T2 ON
                                    T1.APV_RQS_ID = T2.APV_DOC_NO
                                AND T2.APV_SNO <> '1' --(기안자 제외)
                                AND T2.APVR_KND_CD <> '4' --(협조자 제외)
                         WHERE T1.AUD_YR = #{audYr}
                           AND T1.AUD_NO = #{audNo}
						   AND (T1.REF_ID = #{srno} OR T1.REF_ID IN (SELECT NVL(AFF_SNO,0) 
                                             							FROM TBCSPKDE106M
                                            						WHERE AUD_YR = #{audYr}
                                              						AND AUD_NO = #{audNo}
                                              						AND SRNO = #{srno}))
                           AND T1.RPRT_CD = 'A10601000' )
                        )
                    ) AS G1
            WHERE 
                  CASE WHEN #{mfexDvsnCd} = '10' AND G1.APV_YN = 'Y' THEN 'Y'
                       WHEN #{mfexDvsnCd} = '20' AND (G1.ADV_YN = 'Y' AND G1.APV_YN = 'Y') THEN 'Y'
                       ELSE 'N' END = 'Y'
              AND G1.APV_STA_CD = '30'
            GROUP BY G1.AUD_YR
                    ,G1.AUD_NO
                    ,G1.RPRT_CD
                    ,G1.RPRT_NM
                    ,G1.APV_STA_CD
                    ,G1.APV_STA_NM
                    ,G1.DOC_ID
                    ,G1.APV_RQS_ID 
                    ,G1.DOC_TYPE
          ]]> 
    </select>    
    
    <select id="selectEviDocList" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectEviDocList */
        <![CDATA[
            SELECT F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || T2.AFF_CD AS AFF_NO
                  ,T2.TITLE_NM
                  ,F_CODE_NM('1000776', T3.EVI_DCM_DVSN_CD) AS EVI_DCM_DVSN_NM
                  ,T3.FILE_NM
                  ,(SELECT MAX(DECODE(T4.EVI_OPEN_STAT_YN, 'Y', '열람', 'N', '열람취소', ''))
                      FROM TBCSPKDE107M T4
                     WHERE T1.AUD_YR = T4.AUD_YR
                       AND T1.AUD_NO = T4.AUD_NO
                       AND T4.AFF_SNO = T2.AFF_SNO
                       AND T1.AUD_DCM_DOC_ID = T4.AUD_DCM_DOC_ID
                   ) AS EVI_OPEN_STAT_YN
                  ,TO_CHAR((SELECT MAX(EVI_OPEN_STAT_DT)
                      FROM TBCSPKDE107M T4
                     WHERE T1.AUD_YR = T4.AUD_YR
                       AND T1.AUD_NO = T4.AUD_NO
                       AND T4.AFF_SNO = T2.AFF_SNO
                       AND T1.AUD_DCM_DOC_ID = T4.AUD_DCM_DOC_ID
                   ), 'YYYY-MM-DD') AS EVI_OPEN_STAT_DT
                  ,T2.AUD_YR
                  ,T2.AUD_NO
                  ,T3.AUD_DCM_DOC_ID
                  ,T3.AUD_DCM_DOC_ID AS DOC_ID
                  ,T2.AFF_SNO
                  ,T2.RPRT_FILD_ID
                  ,T3.FILE_NM AS V_FILE_NM
              FROM TBBADDED110M T1
             INNER JOIN TBBADDED145M T2 ON
                       T1.AUD_YR = T2.AUD_YR
                   AND T1.AUD_NO = T2.AUD_NO
                   AND T1.RPRT_FILD_ID = T2.RPRT_FILD_ID
                   AND T2.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
                                       FROM (
                                             SELECT RANK() OVER (PARTITION BY A.DOC_ID ORDER BY DECODE(A.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
                                                , A.APVR_CD APVR_CD
                                                , A.DOC_ID
                                             FROM TBBADDED145M A
                                            WHERE A.AUD_YR = #{audYr}
                                              AND A.AUD_NO  =  #{audNo}
                                              AND A.APVR_CD <> '0010200'
                                            GROUP BY A.DOC_ID, A.APVR_CD )   
                                      WHERE RN = 1 
                                        AND T2.DOC_ID = DOC_ID)
                   AND T1.AUD_YR = #{audYr}
                   AND T1.AUD_NO = #{audNo}
                   AND T2.AFF_SNO IN (SELECT AA.AFF_SNO
								        FROM TBCSPKDE106M AA
									   WHERE AA.AUD_YR = #{audYr}
										 AND AA.AUD_NO = #{audNo}
										 AND AA.SRNO = #{srno}
										 AND AA.MFEX_DVSN_CD = #{mfexDvsnCd} )
             INNER JOIN TBBADDED108D T3 ON
                       T1.AUD_YR = T3.AUD_YR
                   AND T1.AUD_NO = T3.AUD_NO
                   AND T1.AUD_DCM_DOC_ID = T3.AUD_DCM_DOC_ID
        ]]>
            <if test="eviDcmDvsnCd != null and eviDcmDvsnCd != ''">
                <![CDATA[
                   AND T3.EVI_DCM_DVSN_CD = #{eviDcmDvsnCd}
                ]]>
            </if>
            ORDER BY 
                  T2.AFF_SNO
    </select>
    
    <select id="selectEviDcmDvsnList" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectEviDcmDvsnList */
        <![CDATA[
            SELECT T3.EVI_DCM_DVSN_CD
                  ,F_CODE_NM('1000776', T3.EVI_DCM_DVSN_CD) AS EVI_DCM_DVSN_NM
              FROM TBBADDED110M T1
             INNER JOIN TBBADDED145M T2 ON
                       T1.AUD_YR = T2.AUD_YR
                   AND T1.AUD_NO = T2.AUD_NO
                   AND T1.RPRT_FILD_ID = T2.RPRT_FILD_ID
                   AND T2.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
                                       FROM (
                                             SELECT RANK() OVER (PARTITION BY A.DOC_ID ORDER BY DECODE(A.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
                                                , A.APVR_CD APVR_CD
                                                , A.DOC_ID
                                             FROM TBBADDED145M A
                                            WHERE A.AUD_YR = #{audYr}
                                              AND A.AUD_NO  =  #{audNo}
                                              AND A.APVR_CD <> '0010200'
                                            GROUP BY A.DOC_ID, A.APVR_CD )   
                                      WHERE RN = 1 
                                        AND T2.DOC_ID = DOC_ID)
                   AND T1.AUD_YR = #{audYr}
                   AND T1.AUD_NO = #{audNo}
                   AND T2.AFF_SNO IN (SELECT AA.AFF_SNO
								        FROM TBCSPKDE106M AA
									   WHERE AA.AUD_YR = #{audYr}
										 AND AA.AUD_NO = #{audNo}
										 AND AA.SRNO = #{srno}
										 AND AA.MFEX_DVSN_CD = #{mfexDvsnCd} )
             INNER JOIN TBBADDED108D T3 ON
                       T1.AUD_YR = T3.AUD_YR
                   AND T1.AUD_NO = T3.AUD_NO
                   AND T1.AUD_DCM_DOC_ID = T3.AUD_DCM_DOC_ID
             GROUP BY T3.EVI_DCM_DVSN_CD
             ORDER BY T3.EVI_DCM_DVSN_CD
        ]]>
    </select>
    
    <insert id="insertAffMppInfo" parameterType="paramMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.insertAffMppInfo */
            INSERT INTO TBCSPKDE106M(
                    AUD_YR
                   ,AUD_NO
                   ,SRNO
                   ,AFF_SNO
                   ,RPRT_FILD_ID
                   ,AFF_SND_STAT_CD
                   ,RPRT_REQ_CD
                   ,RPRT_REQ_DT
                   ,FRT_USR_ID
                   ,FNL_USR_ID
                   ,FNL_DEAL_DPT_CD
                   ,FNL_MNU_ID
                   ,FRT_REGI_DH
                   ,FNL_MDF_DH
                   ,RECEV_DY
                   ,GRN_SRNO
                   ,APVR_CD
                   ,RPRT_LINK_SEQ
                   ,MFEX_DVSN_CD 
                )
                VALUES (
                    #{audYr}
                   ,#{audNo}
                   ,#{srno}
                   ,#{affSno}
                   ,#{rprtFildId}
                   ,#{affSndStatCd}
                   ,#{rprtReqCd}
                   ,#{rprtReqDt}
                   ,#{usrId}
                   ,#{usrId}
                   ,#{dptCd}
                   ,#{mnuId}
                   ,SYSDATE
                   ,SYSDATE
                   ,#{recevDy}
                   ,#{grnSrno}
                   ,#{apvrCd}
                   ,(SELECT NVL(MAX(RPRT_LINK_SEQ), 0)+1
		               FROM TBCSPKDE106M
		              WHERE AUD_YR = #{audYr}
		                AND AUD_NO = #{audNo}) 
		           ,#{mfexDvsnCd}
                 )
    </insert>
    
    <delete id="deleteAffRegiInfo" parameterType="paramMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.deleteAffRegiInfo */
        <![CDATA[
             DELETE
               FROM TBCSPKDE106M
              WHERE AUD_YR = #{audYr}
                AND AUD_NO = #{audNo}
                AND SRNO = #{srno}
                AND AFF_SNO = #{affSno}
                AND MFEX_DVSN_CD = #{mfexDvsnCd}
        ]]>
    </delete>
    
    <update id="updateAffSndStat103m" parameterType="paramMap">
    
     /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.updateAffSndStat103m */
        <![CDATA[
            MERGE INTO TBCSPKDE103M T1
                 USING DUAL
                    ON (    T1.AUD_YR = #{audYr}
                        AND T1.AUD_NO = #{audNo}
                        AND T1.SRNO IN (SELECT T2.SRNO
                                          FROM TBCSPKDE106M T2
                                         WHERE T1.AUD_YR = T2.AUD_YR
                                           AND T1.AUD_NO = T2.AUD_NO
                                           AND T2.AFF_SNO = #{affSno}
                                           AND T2.MFEX_DVSN_CD = #{mfexDvsnCd})
                       )
                  WHEN MATCHED THEN
            UPDATE SET T1.AFF_SND_STAT_CD = '10'
                      ,T1.AFF_SND_STAT_DT = SYSDATE
                      ,T1.FNL_USR_ID       = #{usrId}
                      ,T1.FNL_DEAL_DPT_CD  = #{dptCd}
                      ,T1.FNL_MNU_ID       = #{mnuId}
                      ,T1.FNL_MDF_DH       = SYSDATE
                 WHERE T1.AFF_SND_STAT_CD IS NULL
        ]]>
    </update>
    
    <update id="updateAffSndStat106m" parameterType="paramMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.updateAffSndStat106m */
        <![CDATA[
            MERGE INTO TBCSPKDE106M T1
                 USING DUAL
                    ON (    T1.AUD_YR = #{audYr}
                        AND T1.AUD_NO = #{audNo}
                        AND T1.AFF_SNO = #{affSno}
                        AND T1.MFEX_DVSN_CD = #{mfexDvsnCd}
                       )
                  WHEN MATCHED THEN
            UPDATE SET T1.AFF_SND_STAT_CD = '10'
                      ,T1.AFF_SND_STAT_DT = SYSDATE
                      ,T1.FNL_USR_ID       = #{usrId}
                      ,T1.FNL_DEAL_DPT_CD  = #{dptCd}
                      ,T1.FNL_MNU_ID       = #{mnuId}
                      ,T1.FNL_MDF_DH       = SYSDATE
                 WHERE T1.AFF_SND_STAT_CD IS NULL
        ]]>
    </update>
    
    <select id="selectMfexInfoForSndMsg" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectMfexInfoForSndMsg */
        <![CDATA[
            SELECT AGGR_CONCAT(A.RECEV_DY || '-소명-' || A.GRN_SRNO, ', ') AS MFEX_NO
                   , F_MNG_KND_AUDYRNO(B.AUD_YR, B.AUD_NO, B.AUD_KND_CD, '-') || ' : ' || B.AUD_SBJ_NM AS AUD_YR_NO
                   , B.MNG_DPT_CD
                   , F_DPT_INFO(B.MNG_DPT_CD, '1') AS MNG_DPT_NM
                   , (SELECT nvl(AGGR_CONCAT(ST.USR_DFN_TXT_1,''), '000') FROM TBDCMACM013C ST WHERE ST.CMM_CD_DVSN_CD = '1000860') AS RCPT_USR_CNB
                   , (SELECT COUNT(ST.USR_DFN_TXT_1) FROM TBDCMACM013C ST WHERE ST.CMM_CD_DVSN_CD = '1000860') AS RCPT_USR_CNT
              FROM TBCSPKDE106M A
        INNER JOIN TBBADDED001M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO)
             WHERE A.AUD_YR = #{audYr}
               AND A.AUD_NO = #{audNo}
               AND A.AFF_SNO = #{affSno}
               AND A.MFEX_DVSN_CD = #{mfexDvsnCd}
          GROUP BY B.AUD_YR, B.AUD_NO, B.AUD_KND_CD, B.AUD_GRN_NO, B.MNG_DPT_CD,  B.AUD_SBJ_NM
        ]]>
    </select>
    
    
    <update id="updateSpvDptRcv" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.updateSpvDptRcv */
        <![CDATA[
            UPDATE TBCSPKDE103M
               SET SPV_DPT_RCV_YN = 'Y'
                  ,SPV_DPT_RCV_DT = SYSDATE
                  ,SPV_DPT_RCV_USR_ID = #{usrId}
                  ,FNL_USR_ID       = #{usrId}
                  ,FNL_DEAL_DPT_CD  = #{dptCd}
                  ,FNL_MNU_ID       = #{mnuId}
                  ,FNL_MDF_DH       = SYSDATE
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND SRNO = #{srno}
        ]]>
    </update>
    
    
    <select id="selectAffRegiList" parameterType="paramMap" resultType="egovMap">
       /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectAffRegiList */
        <![CDATA[
            SELECT F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || T1.AFF_CD AS AFF_NO
                  ,T1.TITLE_NM
                  ,(SELECT AGGR_CONCAT(DECODE(AA.MFEX_DVSN_CD, '10', AA.MFEX_NO, AA.IMMUN_NO), '|')
                      FROM TBCSPKDE106M T3
                         , TBCSPKDE103M_VIEW AA
                     WHERE T3.AUD_YR = AA.AUD_YR
                       AND T3.AUD_NO = AA.AUD_NO
                       AND T3.SRNO = AA.SRNO
                       AND T3.MFEX_DVSN_CD = AA.MFEX_DVSN_CD
                       AND T3.AUD_YR = T1.AUD_YR
                       AND T3.AUD_NO = T1.AUD_NO
                       AND NVL(T3.RPRT_FILD_ID,'@') = NVL(T1.RPRT_FILD_ID,'@')
                       AND T3.AFF_SNO = T1.AFF_SNO
                       AND T3.SRNO || T3.MFEX_DVSN_CD <> T2.SRNO || T2.MFEX_DVSN_CD
                   ) AS MFEX_MPP
                  ,(
                    SELECT COUNT(1)
                      FROM TBBADDED110M T3
                     WHERE T3.AUD_YR = T1.AUD_YR
                       AND T3.AUD_NO = T1.AUD_NO
                       AND T3.RPRT_FILD_ID = T1.RPRT_FILD_ID
                   ) AS EVI_DOC_CNT
                  ,T1.AUD_YR
                  ,T1.AUD_NO
                  ,T1.RPRT_FILD_ID
                  ,T1.AFF_SNO
                  ,T2.SRNO
                  ,(SELECT MAX(RPRT_NM) FROM TBBADDED103M WHERE AUD_YR = T1.AUD_YR AND AUD_NO = T1.AUD_NO AND DOC_ID = T1.DOC_ID) AS RPRT_NM
                  ,(SELECT AGGR_CONCAT(MAX(ST2.RPRT_NM), '|')
                      FROM TBCSPKDE106M ST1
                     INNER JOIN TBBADDED103M ST2
                             ON ST1.AUD_YR = ST2.AUD_YR
                            AND ST1.AUD_NO = ST2.AUD_NO
                         --   AND ST1.RPRT_LINK_SEQ = ST2.REF_ID
                         --   AND ST1.AFF_SNO = ST2.REF_DY
                            AND ST2.RPRT_CD  IN ( 'A10600900', 'A10600960')
                     WHERE ST1.AUD_YR = T2.AUD_YR
                       AND ST1.AUD_NO = T2.AUD_NO
                       AND ST1.AFF_SNO = T2.AFF_SNO
                       AND (ST1.AFF_SNO = ST2.REF_DY OR ST2.REF_DY = T2.SRNO || T2.MFEX_DVSN_CD )
                       AND ST1.MFEX_DVSN_CD = T2.MFEX_DVSN_CD
                     GROUP BY ST2.RPRT_NM, ST2.DOC_ID) AS MFEX_EXAM_DOC
                  ,(SELECT AGGR_CONCAT(MAX(ST2.DOC_ID), '|')
                      FROM TBCSPKDE106M ST1
                     INNER JOIN TBBADDED103M ST2
                             ON ST1.AUD_YR = ST2.AUD_YR
                            AND ST1.AUD_NO = ST2.AUD_NO
                         --   AND ST1.RPRT_LINK_SEQ = ST2.REF_ID
                         --   AND ST1.AFF_SNO = ST2.REF_DY
                            AND ST2.RPRT_CD  IN ( 'A10600900', 'A10600960')
                     WHERE ST1.AUD_YR = T2.AUD_YR
                       AND ST1.AUD_NO = T2.AUD_NO
                       AND ST1.AFF_SNO = T2.AFF_SNO
                       AND (ST1.AFF_SNO = ST2.REF_DY OR ST2.REF_DY = T2.SRNO || T2.MFEX_DVSN_CD )
                       AND ST1.MFEX_DVSN_CD = T2.MFEX_DVSN_CD
                     GROUP BY ST2.RPRT_NM, ST2.DOC_ID) AS MFEX_EXAM_DOC_ID
                 ,(SELECT AGGR_CONCAT(MAX(F_OPEN_EDIT(ST2.LINK_URL)), '|')
                      FROM TBCSPKDE106M ST1
                     INNER JOIN TBBADDED103M ST2
                             ON ST1.AUD_YR = ST2.AUD_YR
                            AND ST1.AUD_NO = ST2.AUD_NO
                        --   AND ST1.RPRT_LINK_SEQ = ST2.REF_ID
                        --    AND ST1.AFF_SNO = ST2.REF_DY
                            AND ST2.RPRT_CD  IN ( 'A10600900', 'A10600960')
                     WHERE ST1.AUD_YR = T2.AUD_YR
                       AND ST1.AUD_NO = T2.AUD_NO
                       AND ST1.AFF_SNO = T2.AFF_SNO
                       AND (ST1.AFF_SNO = ST2.REF_DY OR ST2.REF_DY = T2.SRNO || T2.MFEX_DVSN_CD )
                       AND ST1.MFEX_DVSN_CD = T2.MFEX_DVSN_CD
                     GROUP BY ST2.RPRT_NM, ST2.DOC_ID) AS MFEX_EXAM_DOC_TYPE
                 , T2.MFEX_DVSN_CD
              FROM TBBADDED145M T1
             INNER JOIN TBCSPKDE106M T2 ON
                       T2.AUD_YR = T1.AUD_YR
                   AND T2.AUD_NO = T1.AUD_NO
                   AND T2.AFF_SNO = T1.AFF_SNO
                   AND T1.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
                                       FROM (
                                             SELECT RANK() OVER (PARTITION BY A.DOC_ID ORDER BY DECODE(A.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
                                                , A.APVR_CD APVR_CD
                                                , A.DOC_ID
                                             FROM TBBADDED145M A
                                            WHERE A.AUD_YR = #{audYr}
                                              AND A.AUD_NO  =  #{audNo}
                                              AND A.APVR_CD <> '0010200'
                                            GROUP BY A.DOC_ID, A.APVR_CD )   
                                      WHERE RN = 1
                                        AND T1.DOC_ID = DOC_ID )
                   AND T1.AUD_YR = #{audYr}
                   AND T1.AUD_NO = #{audNo}
                   AND T2.SRNO = #{srno}
                   AND T2.MFEX_DVSN_CD = #{mfexDvsnCd}
                   
        ]]>
    </select>
    
    <select id="selectAffList" parameterType="paramMap" resultType="egovMap">
       /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectAffList */
        <![CDATA[
            SELECT F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || T1.AFF_CD AS AFF_NO
                  ,F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') AS AUD_GRN_NO
                  ,T1.AUD_YR
                  ,T1.AUD_NO
                  ,T1.AFF_SNO
                  ,T1.RPRT_FILD_ID
                  ,T1.TITLE_NM
                  ,(
                    SELECT RPRT_NM
                      FROM TBBADDED103M
                     WHERE AUD_YR = T1.AUD_YR
                       AND AUD_NO = T1.AUD_NO
                       AND DOC_ID = T1.DOC_ID
                   ) AS RPRT_NM
                  ,(SELECT AGGR_CONCAT(AAA.RPRT_NM, '|')
                      FROM ( SELECT DISTINCT
                                    AA.AUD_YR
                                  , AA.AUD_NO
                                  , ST2.RPRT_NM
                                  , ST1.AFF_SNO
                                  , ST1.RPRT_FILD_ID
                                  , ST2.DOC_ID
                                  , F_OPEN_EDIT(ST2.LINK_URL)
		                      FROM TBCSPKDE103M_VIEW AA
		                     INNER JOIN TBBADDED103M ST2
		                             ON ST2.AUD_YR = AA.AUD_YR
		                            AND ST2.AUD_NO = AA.AUD_NO
		                            AND ST2.RPRT_CD IN ('A10600900','A10600960')    
		                    INNER JOIN TBCSPKDE106M ST1
		                            ON ST1.AUD_YR = AA.AUD_YR
		                           AND ST1.AUD_NO = AA.AUD_NO
		                           AND ST1.SRNO = AA.SRNO
		                           AND ST1.MFEX_DVSN_CD = AA.MFEX_DVSN_CD
		                   WHERE (ST2.REF_DY = ST1.AFF_SNO OR ST2.REF_DY = AA.SRNO || AA.MFEX_DVSN_CD )) AAA
		                 WHERE AAA.AUD_YR = T1.AUD_YR
		                       AND AAA.AUD_NO = T1.AUD_NO
		                       AND AAA.AFF_SNO = T1.AFF_SNO
		                       AND NVL(AAA.RPRT_FILD_ID,'@') = NVL(T1.RPRT_FILD_ID,'@')
                   ) AS MFEX_EXAM_RPRT
                   ,(SELECT AGGR_CONCAT(AAA.DOC_ID, '|')
                      FROM ( SELECT DISTINCT
                                    AA.AUD_YR
                                  , AA.AUD_NO
                                  , ST2.RPRT_NM
                                  , ST1.AFF_SNO
                                  , ST1.RPRT_FILD_ID
                                  , ST2.DOC_ID
                                  , F_OPEN_EDIT(ST2.LINK_URL)
		                      FROM TBCSPKDE103M_VIEW AA
		                     INNER JOIN TBBADDED103M ST2
		                             ON ST2.AUD_YR = AA.AUD_YR
		                            AND ST2.AUD_NO = AA.AUD_NO
		                            AND ST2.RPRT_CD IN ('A10600900','A10600960')    
		                    INNER JOIN TBCSPKDE106M ST1
		                            ON ST1.AUD_YR = AA.AUD_YR
		                           AND ST1.AUD_NO = AA.AUD_NO
		                           AND ST1.SRNO = AA.SRNO
		                           AND ST1.MFEX_DVSN_CD = AA.MFEX_DVSN_CD
		                   WHERE (ST2.REF_DY = ST1.AFF_SNO OR ST2.REF_DY = AA.SRNO || AA.MFEX_DVSN_CD )) AAA
		                 WHERE AAA.AUD_YR = T1.AUD_YR
		                       AND AAA.AUD_NO = T1.AUD_NO
		                       AND AAA.AFF_SNO = T1.AFF_SNO
		                       AND NVL(AAA.RPRT_FILD_ID,'@') = NVL(T1.RPRT_FILD_ID,'@')
                   ) AS MFEX_EXAM_DOC_ID 
                   ,(SELECT AGGR_CONCAT(DOC_TYPE, '|')
                      FROM ( SELECT DISTINCT
                                    AA.AUD_YR
                                  , AA.AUD_NO
                                  , ST2.RPRT_NM
                                  , ST1.AFF_SNO
                                  , ST1.RPRT_FILD_ID
                                  , ST2.DOC_ID
                                  , F_OPEN_EDIT(ST2.LINK_URL) AS DOC_TYPE
		                      FROM TBCSPKDE103M_VIEW AA
		                     INNER JOIN TBBADDED103M ST2
		                             ON ST2.AUD_YR = AA.AUD_YR
		                            AND ST2.AUD_NO = AA.AUD_NO
		                            AND ST2.RPRT_CD IN ('A10600900','A10600960')    
		                    INNER JOIN TBCSPKDE106M ST1
		                            ON ST1.AUD_YR = AA.AUD_YR
		                           AND ST1.AUD_NO = AA.AUD_NO
		                           AND ST1.SRNO = AA.SRNO
		                           AND ST1.MFEX_DVSN_CD = AA.MFEX_DVSN_CD
		                   WHERE (ST2.REF_DY = ST1.AFF_SNO OR ST2.REF_DY = AA.SRNO || AA.MFEX_DVSN_CD )) AAA
		                 WHERE AAA.AUD_YR = T1.AUD_YR
		                       AND AAA.AUD_NO = T1.AUD_NO
		                       AND AAA.AFF_SNO = T1.AFF_SNO
		                       AND NVL(AAA.RPRT_FILD_ID,'@') = NVL(T1.RPRT_FILD_ID,'@')
                   ) AS MFEX_EXAM_DOC_TYPE
                  ,(SELECT AGGR_CONCAT(DECODE(AA.MFEX_DVSN_CD, '10', AA.MFEX_NO, AA.IMMUN_NO), '|')
                      FROM TBCSPKDE106M T3
                         , TBCSPKDE103M_VIEW AA
                     WHERE T3.AUD_YR = AA.AUD_YR
                       AND T3.AUD_NO = AA.AUD_NO
                       AND T3.SRNO = AA.SRNO
                       AND T3.MFEX_DVSN_CD = AA.MFEX_DVSN_CD
                       AND T3.AUD_YR = T1.AUD_YR
                       AND T3.AUD_NO = T1.AUD_NO
                       AND NVL(T3.RPRT_FILD_ID,'@') = NVL(T1.RPRT_FILD_ID,'@')
                       AND T3.AFF_SNO = T1.AFF_SNO
                   ) AS MFEX_MPP
                  ,(
                    SELECT COUNT(1)
                      FROM TBBADDED110M T2
                     WHERE T1.AUD_YR = T2.AUD_YR
                       AND T1.AUD_NO = T2.AUD_NO
                       AND T1.RPRT_FILD_ID = T2.RPRT_FILD_ID
                   ) AS EVI_DOC_CNT
                   , T1.APVR_CD
                   , (SELECT ( CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END ) 
                        FROM TBCSPKDE106M AA
                       WHERE AA.AUD_YR = T1.AUD_YR
                         AND AA.AUD_NO = T1.AUD_NO
                         AND AA.AFF_SNO = T1.AFF_SNO 
                         AND NVL(AA.RPRT_FILD_ID,'@') = NVL(T1.RPRT_FILD_ID,'@')
                         AND AA.SRNO = #{srno}
                         AND AA.MFEX_DVSN_CD = #{mfexDvsnCd} ) AS AFF_STATE
              FROM TBBADDED145M T1
             WHERE T1.AUD_YR = #{audYr}
               AND T1.AUD_NO = #{audNo}
               AND T1.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
                                   FROM (
                                         SELECT RANK() OVER (PARTITION BY A.DOC_ID ORDER BY DECODE(A.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
                                            , A.APVR_CD APVR_CD
                                            , A.DOC_ID
                                         FROM TBBADDED145M A
                                        WHERE A.AUD_YR = #{audYr}
                                          AND A.AUD_NO  =  #{audNo}
                                          AND A.APVR_CD <> '0010200'
                                        GROUP BY A.DOC_ID, A.APVR_CD )   
                                  WHERE RN = 1 
                                    AND T1.DOC_ID = DOC_ID)
        ]]>
    </select>
    
        
</mapper>