<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.ewm.dao.AEPEWM001QMapper">
	
	<select id="selectMainList" parameterType="paramMap" resultType="egovMap" >
	/* kr.go.bai.eip.aep.ewm.dao.AEPEWM001QMapper.selectMainList */
       <![CDATA[
           SELECT D1.AUD_YR                          AS AUD_YR                          /*감사년도*/
                , D1.AUD_NO                          AS AUD_NO                          /*감사번호*/
                , D3.DSP_RQ_SNO
                , F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D1.AUD_KND_CD, '-')      
                                                     AS AUD_YR_NO                       /*감사연번호*/
                , D1.SPV_BRDV_CD                     AS SPV_BRDV_CD                     /*주관국과코드*/
                , F_DPT_INFO(D1.SPV_BRDV_CD,'1')     AS SPV_BRDV_NM                     /*주관국과명*/
                , D1.MNG_DPT_CD                      AS MNG_DPT_CD                      /*관리부서코드 - 2016.03.09 yyh*/
                , F_DPT_INFO(D1.MNG_DPT_CD,'1')      AS MNG_DPT_NM                      /*관리부서명*/                 
                , D1.AUD_SBJ_NM                      AS AUD_SBJ_NM                      /*감사사항명*/
                , CASE WHEN D2.DTM_STA_CD = '2'                                
                            THEN '확정'
                       WHEN D2.DTM_STA_CD = '1' AND  D2.DSP_RQ_APV_STA_CD  = '3'                                   
                            THEN '완결' || CASE WHEN D2.CPLT_STA_DVSN_CD IS NOT NULL     THEN '(' || DECODE(D2.CPLT_STA_DVSN_CD,'1','완결','종결') || ')' 
                                                    ELSE '' 
                                           END
                       WHEN D2.DTM_STA_CD = '1' AND (D2.DSP_RQ_APV_STA_CD IS NULL OR D2.DSP_RQ_APV_STA_CD <> '3') 
                            THEN '미결' || CASE WHEN D2.NOT_CPLT_STA_DVSN_CD IS NOT NULL THEN '(' || DECODE(D2.NOT_CPLT_STA_DVSN_CD,'1','정상','집중') || ')' 
                                                    ELSE '' 
                                           END
                       ELSE ''
                   END  AS DTM_YN_NM
                 , (SELECT F_ORG_INFO(MIN(RLTN_ORG_CD),'1')
                     FROM TBBADEAR006M T1
                    WHERE 1=1
                      AND T1.AUD_YR     = D3.AUD_YR
                      AND T1.AUD_NO     = D3.AUD_NO
                      AND T1.DSP_RQ_SNO = D3.DSP_RQ_SNO)  AS RLTN_ORG_NM                     /*처분기관*/
                , (SELECT MIN(RLTN_ORG_CD)
                     FROM TBBADEAR006M T1
                    WHERE 1=1
                      AND T1.AUD_YR     = D3.AUD_YR
                      AND T1.AUD_NO     = D3.AUD_NO
                      AND T1.DSP_RQ_SNO = D3.DSP_RQ_SNO)  AS RLTN_ORG_CD                     /*처분기관*/
                /* , F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D1.AUD_KND_CD, '-') || '-' || D2.DSP_RQ_SNO AS AUD_DSP_RQ_SNO                  감사처분요구순번*/ 
                , NVL2(D3.ACT_DSP_NM,D3.ACT_DSP_NM, F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D1.AUD_KND_CD, '-') || '-' || D2.DSP_RQ_SNO  ) AS AUD_DSP_RQ_SNO
                
                , TO_CHAR(TO_DATE(D2.HNDL_DDLN_DT,'YYYY-MM-DD') , 'YYYY-MM-DD') AS HNDL_DDLN_DT
                , D3.TIT_TXT
                , F_CODE_NM('1000002', D3.DSP_RQ_KND_CD) AS DSP_RQ_KND_NM
                , D3.DSP_RQ_KND_CD
                , D3.EXEC_DSP_NM
                , D3.ACT_DSP_NM
                , ROWNUM AS NUM
           FROM TBBADDED001M D1 
                JOIN TBBADEAR002D D2 ON ( D1.AUD_YR = D2.AUD_YR AND D1.AUD_NO = D2.AUD_NO)
                JOIN TBBADEAR001M D3 ON ( D2.AUD_YR = D3.AUD_YR AND D2.AUD_NO = D3.AUD_NO AND D2.DSP_RQ_SNO = D3.DSP_RQ_SNO 
                                          AND D3.DSP_RQ_KND_CD IN ('110','210','310','320','391','396','620','621','623','630','510','520','530','610','611','810','820','830','840','850')
                                        )
           WHERE 1=1
                AND D1.AUD_YR = #{audYr}
                AND D1.AUD_NO = #{audNo}
           ORDER BY D1.AUD_YR, D1.AUD_NO, D2.DSP_RQ_SNO
		  ]]>
	</select>
	
	<select id="selectInfoForMsg" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.ewm.dao.AEPEWM001QMapper.selectInfoForMsg */
        <![CDATA[
            SELECT F_DPT_INFO(A.MNG_DPT_CD, '1') AS MNG_DPT_NM
                , F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, A.AUD_KND_CD, '-') AS AUD_YR_NO
                 , A.AUD_SBJ_NM
                 , B.RPRT_NM
                 , B.DOC_ID
                 , C.TIT_TXT
                 , F_CODE_NM('1000002', C.DSP_RQ_KND_CD) AS DSP_RQ_KND_NM
                 , (SELECT AGGR_CONCAT(ST.CNB,'')
				      FROM (                                   
                            SELECT T.CNB
                            FROM TBDCMACM001M T
                            WHERE 1=1
                            AND  T.RAL_BLT_DIV_CD = '180105'
                            AND T.RANK_CD IN ('015','016','017')
                            ORDER BY RANK_CD 
					       ) ST  
				) AS RCPT_USR_CNB
                , (SELECT COUNT(ST.CNB) FROM TBDCMACM001M ST WHERE ST.RAL_BLT_DIV_CD = '180105' AND RANK_CD IN ('015','016','017')) AS RCPT_USR_CNT
            FROM TBBADDED001M A 
            INNER JOIN TBBADDED103M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO)
            INNER JOIN TBBADEAR001M C ON (B.AUD_YR = C.AUD_YR AND B.AUD_NO = C.AUD_NO AND B.REF_ID = C.DSP_RQ_SNO)
           WHERE A.AUD_YR = #{audYr}
             AND A.AUD_NO = #{audNo}
             AND B.RPRT_CD = #{rprtCd}
             AND B.REF_ID = #{refId}
             AND B.DOC_ID = #{docId}
        ]]>
    </select>
    
     <select id="selectSendSbcnDocInfo" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.ewm.dao.AEPEWM001QMapper.selectSendSbcnDocInfo */
        <![CDATA[
            SELECT 
                AUD_YR
                ,AUD_NO
                ,AUD_STEP_CD
                ,DOC_ID
                ,AUD_KND_CD
                ,AUD_GRN_NO
                ,RPRT_NM
                ,RPRT_CD
                ,LINK_URL
                ,AUD_RPRT_DVSN_CD 
                ,DOC_KND_CD 
                ,REF_ID
                ,REF_DY
            FROM TBBADDED103M 
            WHERE AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = #{audStepCd}
            AND DOC_ID = #{docId} 
            AND  REF_ID = #{refId}
        ]]>
    </select>
    
    <insert id="saveSendDoc"> 
        /* kr.go.bai.eip.aep.ewm.dao.AEPEWM001QMapper.saveSendDoc */
        <![CDATA[
            INSERT INTO TBBADDED111M (
            			AUD_YR,
            			AUD_NO,
            			AUD_STEP_CD,
                		DOC_ID,
                		SR_DOC_SNO,
                		AUD_KND_CD,
                		AUD_GRN_NO,
                		RPRT_NM,
                		RPRT_CD,
                        LINK_URL,
                        DOC_STA_CD,
                        SND_DPT_CD,
                        SNDR_ID,
                        SND_DH,
                        RCPT_DPT_CD,
                		RCNT_ID,
                		RCPT_DH,
                		AUD_RPRT_DVSN_CD,
                		DOC_KND_CD,
                		REF_ID,
                		REF_DY,
                		SORT_SNO,
                        FRT_USR_ID,
                        FNL_USR_ID,
                        FNL_DEAL_DPT_CD,
                        FNL_MNU_ID,
                        FRT_REGI_DH,
                        FNL_MDF_DH)
            VALUES (
            		   #{audYr},
            		   #{audNo},
            		   #{audStepCd},
                       #{docId}, 
                       (SELECT  LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0) 
                        FROM TBBADDED111M 
                        WHERE AUD_YR = #{audYr} 
                        AND AUD_NO =#{audNo}
                        AND AUD_STEP_CD = #{audStepCd}
                        AND DOC_ID = #{docId} ),
                	#{audKndCd},
                	#{audGrnNo},
                	#{rprtNm},
                	#{rprtCd},
                    #{linkUrl},
                    '10',
                    #{dptCd},
                    #{usrId},
                    SYSDATE,
                    '180105',
                    NULL,
                    NULL,
                    #{audRprtDvsnCd},
                    #{docKndCd},
                    #{refId},
                    #{refDy},
                    (SELECT  LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0) 
                      FROM TBBADDED111M 
                      WHERE AUD_YR = #{audYr} 
                      AND AUD_NO =#{audNo}
                      AND AUD_STEP_CD =#{audStepCd}
                      AND DOC_ID = #{docId} ),
                   #{usrId},
                   #{usrId},
                   #{dptCd},
                   'AEPEWM001Q',
                   SYSDATE,SYSDATE)
        ]]>
    </insert>


	<select id="selectTskPrcsList" parameterType="paramMap" resultType="egovMap" >
	/* kr.go.bai.eip.aep.ewm.dao.AEPEWM001QMapper.selectTskPrcsList */
       <![CDATA[
			SELECT
			        CASE WHEN MAX(RTN_CNT)>0 THEN 'Y'
			             ELSE 'N'
			        END AS RTN_YN,
			        CASE WHEN MAX(PRT_CNT)>0 THEN 'Y'
			             ELSE 'N'
			        END AS PRT_YN,
			        CASE WHEN MAX(COMPLETE_YN)>0 THEN 'Y'
			             ELSE 'N'
			        END AS COMPLETE_YN,
			         CASE WHEN MAX(CMPT_YN)>0 THEN 'Y'
			             ELSE 'N'
			        END AS CMPT_YN
			FROM
			(
                --이행회보
                SELECT
                     COUNT(*) AS RTN_CNT, 0 AS PRT_CNT, 0 AS  COMPLETE_YN ,0 AS CMPT_YN , 'A' AS AAA
                FROM TBBADEAR002D T1
                WHERE 1=1
                    AND T1.AUD_YR = #{audYr}
                    AND T1.AUD_NO = #{audNo}
                    AND T1.DSP_RQ_SNO = #{dspRqSno}
                    AND EXISTS (
                        SELECT AUD_YR 
                        FROM TBBADFRE001H ST1 
                        WHERE 1 = 1
	                        AND ST1.AUD_YR = T1.AUD_YR
	                        AND ST1.AUD_NO = T1.AUD_NO
	                        AND ST1.DSP_RQ_SNO = T1.DSP_RQ_SNO
	                        AND ST1.BAI_CHGD_ACP_DT IS NOT NULL --접수일
                    )
                UNION
			    --검토보고서
			    SELECT 0 AS RTN_CNT, COUNT(*) AS PRT_CNT, 0 AS COMPLETE_YN , 0 AS CMPT_YN , 'A' AS AAA
			    FROM TBBADEAR002D
			    WHERE 1=1
			        AND   DTM_STA_CD IN  ( '1' , '2')   -- 완결은 2
			        AND   DTM_YN = 'Y'
			        AND   ENFM_WHLS_APV_KND_CD IN ('1', '2','3')   -- 집행전말결재종류코드 : 권고통보외처분요구사항(과장전결)(2) & 처분요구결재상태코드 : 승인(3) 이 아닌것
			        AND   AUD_YR = #{audYr}
			        AND   AUD_NO = #{audNo}
			        AND   DSP_RQ_SNO = #{dspRqSno}
			    UNION
			    -- 완결
			    SELECT 0 AS RTN_CNT, 0 AS PRT_CNT ,COUNT(*) AS COMPLETE_YN ,0 AS CMPT_YN ,'A' AS AAA 
			    FROM TBBADEAR002D
			    WHERE 1=1
			        AND DTM_STA_CD = '2'
			        AND   AUD_YR = #{audYr}
			        AND   AUD_NO = #{audNo}
			        AND   DSP_RQ_SNO = #{dspRqSno}
               UNION
			    -- 징계위원회 출석 결과 보고서   
			    SELECT 0 AS RTN_CNT, 0 AS PRT_CNT , 0 AS COMPLETE_YN , COUNT(*) AS CMPT_YN ,'A' AS AAA 
			    FROM TBBADDED103M
			    WHERE 1=1		
			    AND   AUD_YR = #{audYr}
			    AND   AUD_NO = #{audNo}
			    AND   REF_ID = #{dspRqSno}	        
			    AND   RPRT_CD = 'A10900900'
			)
			GROUP BY AAA
		  ]]>
	</select>
	
	<select id="selectDocumentList" parameterType="paramMap" resultType="egovMap" >
	/* kr.go.bai.eip.aep.ewm.dao.AEPEWM001QMapper.selectDocumentList */
       <![CDATA[
		    SELECT       
			       RPRT_NM
                  , RPRT_CD
                  , APV_STA_CD
                  , APV_STA_NM
                  , SORT_SNO             
                  , DOC_ID 
                  , CON_PGM_CD                                           
                  , APV_RQS_ID
                  , APV_YN
                  , NECES_YN
                  , APV_WAY_CD
                  , DOC_WRT_ID
                  , REF_ID
                  , REF_DY
                  , TEMPLATE_DOC_ID
                  , DOC_TYPE
                  , (SELECT DECODE(COUNT(1), 0, 'N', 'Y') FROM TBDCMACM023H ST1 WHERE ST1.APV_DOC_NO = APV_RQS_ID AND ST1.APVR_STA_CD NOT IN ('301', '201')) AS APV_HIS_YN
       	     FROM (
	          SELECT
	               A.RPRT_NM/*보고서명 */
	               ,A.RPRT_CD       /*보고서코드*/
	               ,A.APV_STA_CD    /*결재상태코드 */
	               ,F_CODE_NM('1000773',A.APV_STA_CD) AS APV_STA_NM    /*결재상태코드 */
	               ,A.SORT_SNO       /*보고서순번  */
	               ,A.DOC_ID         /*결재문서번호 */
	               ,A.APV_RQS_ID      /*결재ID*/
	               ,(CASE WHEN A.RPRT_CD = 'A10900900' THEN (DECODE(1, (
	                                                           SELECT 1
	                                                           FROM DUAL
	                                                           WHERE EXISTS (
	                                                                         SELECT 1
	                                                                          FROM TBBADDED111M B
	                                                                          WHERE A.AUD_YR = B.AUD_YR
	                                                                          AND A.AUD_NO = B.AUD_NO
	                                                                          AND A.AUD_STEP_CD = B.AUD_STEP_CD
	                                                                          AND A.DOC_ID = B.DOC_ID)
	                                  ), 'N', 'Y'))
	                END ) AS APV_YN            /*결재여부 */
	                , A.NECES_YN
	                , A.APV_WAY_CD /*결재방법코드*/
	                , A.DOC_WRT_ID
                    , A.REF_ID
                    , A.REF_DY
                    , A.LINK_URL
                    , A.TEMPLATE_DOC_ID
                    , A.SYT_TRTM_DVSN_YN
                    , F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
                    , A.CON_PGM_CD
	           FROM TBBADDED103M AS A
	          WHERE A.AUD_YR = #{audYr}
	            AND A.AUD_NO = #{audNo}
	            AND A.AUD_STEP_CD =#{audStepCd}
	            AND A.AUD_KND_CD = #{audKndCd}
	            AND A.REF_ID = #{refId}
        )
         GROUP BY RPRT_NM, RPRT_CD, APV_STA_CD, APV_STA_NM, SORT_SNO, DOC_ID, APV_RQS_ID, APV_YN, NECES_YN, APV_WAY_CD
             , DOC_WRT_ID,  REF_ID, REF_DY , LINK_URL, TEMPLATE_DOC_ID, DOC_TYPE,CON_PGM_CD
         ORDER BY SORT_SNO
		  ]]>
	</select>
</mapper> 
