<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper">

    <select id="selectAudList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.selectAudList */
        <include refid="include.pageSelct" />
        <![CDATA[
            SELECT AUD_YR, AUD_NO, ACP_DVSN_CD, AUD_YR_NO, AUD_SBJ_NM, RPRT_NM, MNG_DPT_NM, AUD_STEP_NM, SND_DH, MNG_DPT_CD, DOC_ID, DOC_ID2, APV_RQS_ID, APV_USR_NM, AUD_KND_CD, AUD_RPRT_DVSN_CD, AUD_RPRT_DVSN_NM, SR_DOC_SNO, DOC_STA_CD, AUD_STEP_CD, QLT_STEP_NM, TRTM_LEADER_EXAMER_NM, V_RPRT_NM,DOC_TYPE
         FROM (
            SELECT 
                    T1.AUD_YR,
                    T1.AUD_NO,
                    '9' AS ACP_DVSN_CD,
                    F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-')    AS AUD_YR_NO,
                    T1.AUD_SBJ_NM,
                    T2.RPRT_NM,
                    F_DPT_INFO(T1.MNG_DPT_CD,'1') AS MNG_DPT_NM,
                    F_CODE_NM('1000785',T2.AUD_STEP_CD) AS AUD_STEP_NM,
                    TO_CHAR(T2.SND_DH, 'YYYY-MM-DD') AS SND_DH,
                    T1.MNG_DPT_CD,
                    T2.DOC_ID,
                    (
                       SELECT MAX(T4.DOC_ID)
                         FROM TBBADDED111M T4
                        WHERE T4.AUD_YR = T1.AUD_YR
                          AND T4.AUD_NO = T1.AUD_NO
                          AND T4.AUD_STEP_CD = 'A1060'
                          AND T4.REF_ID = T2.DOC_ID
                          AND T4.RPRT_CD = 'A10600200'
                      ) AS DOC_ID2,
                    T3.APV_RQS_ID,
                    ( SELECT CASE WHEN APV_STA_CD = '2' THEN '결재중 ( '||(SELECT F_USR_INFO(APVR_CNB, '2')
                                                                          FROM TBDCMACM023L S2
                                                                         WHERE S1.APV_DOC_NO = S2.APV_DOC_NO
                                                                           AND S2.APVR_STA_CD IN ('102','103'))||' )'
                                  WHEN APV_STA_CD = '3' THEN '결재완료 ( '||F_USR_INFO(S1.FNL_APV_CNB, '2')||', '||TO_CHAR(S1.FNL_APV_DH, 'YYYY-MM-DD')||' )'
                                  WHEN APV_STA_CD = '4' THEN '반려 ( '||(SELECT F_USR_INFO(APVR_CNB, '2')||', '|| TO_CHAR(S2.APV_DH, 'YYYY-MM-DD')
                                                                         FROM TBDCMACM023L S2
                                                                        WHERE S1.APV_DOC_NO = S2.APV_DOC_NO
                                                                          AND S2.APVR_STA_CD = '401')||' )'
                                  WHEN APV_STA_CD = '4' THEN '상신취소'
                                  ELSE ''
                                  END
                        FROM TBDCMACM022L S1
                       WHERE S1.APV_DOC_NO = T3.APV_RQS_ID ) AS APV_USR_NM,
                    T1.AUD_KND_CD,
                    T3.AUD_RPRT_DVSN_CD,
                    F_CODE_NM('1000788', T3.AUD_RPRT_DVSN_CD) AS AUD_RPRT_DVSN_NM,
                    T2.SR_DOC_SNO,
                    T2.DOC_STA_CD,
                    T2.AUD_STEP_CD,
                    CASE
                        WHEN (SELECT COUNT(1)
                                FROM TBBADDED118M T3
                               WHERE T1.AUD_YR = T3.AUD_YR
                                 AND T1.AUD_NO = T3.AUD_NO
                                 AND T2.DOC_ID = T3.DOC_ID
                                 AND T3.AUD_STEP_CD = 'A1060'
                                 AND T3.APVR_CD = '0013600'
                                 AND T3.REVIEW_DOC_ID IS NULL) = 0
                             AND
                             (SELECT COUNT(1)
                                FROM TBBADDED145M T3
                               WHERE T1.AUD_YR = T3.AUD_YR
                                 AND T1.AUD_NO = T3.AUD_NO
                                 AND T2.DOC_ID = T3.DOC_ID
                                 AND T3.AUD_STEP_CD = 'A1060'
                                 AND T3.APVR_CD = '0013600'
                                 AND T3.TRTM_EXAMER_CNB IS NULL) = 0
                             AND
                             (SELECT COUNT(1)
                                FROM TBBADDED118M T3
                               WHERE T1.AUD_YR = T3.AUD_YR
                                 AND T1.AUD_NO = T3.AUD_NO
                                 AND T2.DOC_ID = T3.DOC_ID
                                 AND T3.AUD_STEP_CD = 'A1060'
                                 AND T3.APVR_CD = '0013600')
                             =
                             (SELECT COUNT(1)
                                FROM TBBADDED145M T3
                               WHERE T1.AUD_YR = T3.AUD_YR
                                 AND T1.AUD_NO = T3.AUD_NO
                                 AND T2.DOC_ID = T3.DOC_ID
                                 AND T3.AUD_STEP_CD = 'A1060'
                                 AND T3.APVR_CD = '0013600')
                        THEN '완료'
                        WHEN (SELECT COUNT(1)
                                FROM TBBADDED145M T3
                               WHERE T1.AUD_YR = T3.AUD_YR
                                 AND T1.AUD_NO = T3.AUD_NO
                                 AND T2.DOC_ID = T3.DOC_ID
                                 AND T3.AUD_STEP_CD = 'A1060'
                                 AND T3.APVR_CD = '0013600'
                                 AND T3.TRTM_EXAMER_CNB IS NULL) = 0
                              AND
                             (SELECT COUNT(1)
                                FROM TBBADDED145M T3
                               WHERE T1.AUD_YR = T3.AUD_YR
                                 AND T1.AUD_NO = T3.AUD_NO
                                 AND T2.DOC_ID = T3.DOC_ID
                                 AND T3.AUD_STEP_CD = 'A1060'
                                 AND T3.APVR_CD = '0013600'
                                 AND EXISTS (
                                             SELECT 1
                                               FROM TBBADDED103M T4
                                              WHERE T3.AUD_YR = T4.AUD_YR
                                                AND T3.AUD_NO = T4.AUD_NO
                                                AND TO_CHAR(T3.AFF_SNO) = T4.REF_ID)) > 0
                        THEN '의견서작성 ('||
                                (SELECT COUNT(1)
                                FROM TBBADDED118M T3
                               WHERE T1.AUD_YR = T3.AUD_YR
                                 AND T1.AUD_NO = T3.AUD_NO
                                 AND T2.DOC_ID = T3.DOC_ID
                                 AND T3.AUD_STEP_CD = 'A1060'
                                 AND T3.APVR_CD = '0013600'
                                 AND T3.REVIEW_DOC_ID IS NOT NULL)
                                || '/' ||
                                (SELECT COUNT(1)
                                FROM TBBADDED145M T3
                               WHERE T1.AUD_YR = T3.AUD_YR
                                 AND T1.AUD_NO = T3.AUD_NO
                                 AND T2.DOC_ID = T3.DOC_ID
                                 AND T3.AUD_STEP_CD = 'A1060'
                                 AND T3.APVR_CD = '0013600'
                                 AND T3.TRTM_EXAMER_CNB IS NOT NULL)
                                || ')'
                        WHEN T2.DOC_STA_CD = '20'
                        THEN '담당자배부'
                        ELSE '접수대기'
                    END AS QLT_STEP_NM,
                    F_USR_INFO(T3.REF_ID, '2') AS TRTM_LEADER_EXAMER_NM,
                    T2.RPRT_NM AS V_RPRT_NM,
                    F_OPEN_EDIT(T3.LINK_URL) AS DOC_TYPE
                FROM
                    TBBADDED001M T1
                    INNER JOIN
                    TBBADDED111M T2 ON (
                            T1.AUD_YR = T2.AUD_YR
                        AND T1.AUD_NO = T2.AUD_NO )
                    INNER JOIN
                    TBBADDED103M T3 ON (
                            T2.AUD_YR = T3.AUD_YR
                        AND T2.AUD_NO = T3.AUD_NO
                        AND T2.DOC_ID = T3.DOC_ID )
                WHERE 1=1
                AND T2.AUD_STEP_CD = 'A1060'
                AND T2.RCPT_DPT_CD = '160200'
                AND T2.RPRT_CD IN ('A10600200')
            ]]>
	        <if test='schAudYr != null and schAudYr != ""'>
	            AND T1.AUD_YR = #{schAudYr}
	        </if>
	        <if test='schAudGrnNo != null and schAudGrnNo != ""'>
	            AND T1.AUD_GRN_NO = #{schAudGrnNo}
	        </if>
	        <if test='schAudYrNoKndCd != null and schAudYrNoKndCd != ""'>
	            AND T1.AUD_KND_CD = #{schAudYrNoKndCd}
	        </if>
	        <if test='iptAudSbjNm != null and iptAudSbjNm != ""'>
	            AND AUD_SBJ_NM LIKE '%'||#{iptAudSbjNm}||'%'
	        </if>
	        
	        <if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
	            AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = T1.MNG_DPT_CD) =
	            #{schSpvBrdvCd}
	        </if>
	        <if test="schDeptCd != null and schDeptCd != ''">
	            AND MNG_DPT_CD = #{schDeptCd}
	        </if>
	        UNION ALL
	        SELECT 
                    T1.ACP_YR AS AUD_YR,
                    TO_CHAR(T1.ACP_SRNO) AS AUD_NO,
                    T1.ACP_DVSN_CD,
                    T1.ACP_YR || '-' || DECODE(T1.ACP_DVSN_CD,'1','심사','재심') || '-' || T1.ACP_SRNO AS AUD_YR_NO,
                    T1.TIT_NM AS AUD_SBJ_NM,
                    T2.RPRT_NM,
                    F_DPT_INFO(T1.DPT_CD,'1') AS MNG_DPT_NM,
                    F_CODE_NM('1000785',T2.ACP_STEP_CD) AS AUD_STEP_NM,
                    TO_CHAR(T2.SND_DH, 'YYYY-MM-DD') AS SND_DH,
                    T1.DPT_CD AS MNG_DPT_CD,
                    T2.DOC_ID,
                    (
                       SELECT MAX(T4.DOC_ID)
                         FROM TBBADFRE111M T4
                        WHERE T4.ACP_YR = T1.ACP_YR
                          AND T4.ACP_DVSN_CD = T1.ACP_DVSN_CD
                          AND T4.ACP_SRNO = T1.ACP_SRNO
                          AND T4.ACP_STEP_CD IN ('D1020','E1040')
                          AND T4.ORGN_DOC_ID = T2.DOC_ID
                          AND T4.RPRT_CD IN ('D10200100', 'E10400100')
                      ) AS DOC_ID2,
                    T4.APV_RQS_ID,
                    ( SELECT CASE WHEN APV_STA_CD = '2' THEN '결재중 ( '||(SELECT F_USR_INFO(APVR_CNB, '2')
                                                                          FROM TBDCMACM023L S2
                                                                         WHERE S1.APV_DOC_NO = S2.APV_DOC_NO
                                                                           AND S2.APVR_STA_CD IN ('102','103'))||' )'
                                  WHEN APV_STA_CD = '3' THEN '결재완료 ( '||F_USR_INFO(S1.FNL_APV_CNB, '2')||', '||TO_CHAR(S1.FNL_APV_DH, 'YYYY-MM-DD')||' )'
                                  WHEN APV_STA_CD = '4' THEN '반려 ( '||(SELECT F_USR_INFO(APVR_CNB, '2')||', '|| TO_CHAR(S2.APV_DH, 'YYYY-MM-DD')
                                                                         FROM TBDCMACM023L S2
                                                                        WHERE S1.APV_DOC_NO = S2.APV_DOC_NO
                                                                          AND S2.APVR_STA_CD = '401')||' )'
                                  WHEN APV_STA_CD = '4' THEN '상신취소'
                                  ELSE ''
                                  END
                        FROM TBDCMACM022L S1
                       WHERE S1.APV_DOC_NO = T4.APV_RQS_ID ) AS APV_USR_NM,
                    '' AS AUD_KND_CD,
                    '' AS AUD_RPRT_DVSN_CD,
                    '' AS AUD_RPRT_DVSN_NM,
                    T2.SR_DOC_SNO,
                    T2.DOC_STA_CD,
                    T2.ACP_STEP_CD,
                    '' AS QLT_STEP_NM,
                    '' AS TRTM_LEADER_EXAMER_NM,
                    T2.RPRT_NM AS V_RPRT_NM,
                    F_OPEN_EDIT(T3.LINK_URL) AS DOC_TYPE
                FROM
                    TBBADFRE012M T1
                    INNER JOIN
                    TBBADFRE111M T2 ON (
                            T1.ACP_YR = T2.ACP_YR
                        AND T1.ACP_DVSN_CD = T2.ACP_DVSN_CD
                        AND T1.ACP_SRNO = T2.ACP_SRNO )
                    INNER JOIN
                    TBBADFRE103M T3 ON (
                            T2.ACP_YR = T3.ACP_YR
                        AND T2.ACP_DVSN_CD = T3.ACP_DVSN_CD
                        AND T2.ACP_SRNO = T3.ACP_SRNO
                        AND T2.ACP_STEP_CD = T3.ACP_STEP_CD
                        AND T2.DOC_ID = T3.DOC_ID )
                    INNER JOIN TBBADFRE103M T4 ON (T4.ACP_YR = T3.ACP_YR
                        AND T4.ACP_DVSN_CD = T3.ACP_DVSN_CD
                        AND T4.ACP_SRNO = T3.ACP_SRNO
                        AND T4.REF_ID = T3.DOC_ID
                        AND T4.ACP_STEP_CD IN ('D1020', 'E1040')
                        AND T4.RPRT_CD IN ('D10200200', 'E10400200'))
                WHERE 1=1
                AND T2.ACP_STEP_CD IN ('D1020', 'E1040')
                AND T2.RCPT_DPT_CD = '160200'
                AND T2.RPRT_CD IN ('D10200100', 'E10400100')
            <if test='schAudYr != null and schAudYr != ""'>
	            AND T1.ACP_YR = #{schAudYr}
	        </if>
	        <if test='schAudGrnNo != null and schAudGrnNo != ""'>
	            AND T1.ACP_SRNO = #{schAudGrnNo}
	        </if>
	        <if test='schAudYrNoKndCd != null and schAudYrNoKndCd != ""'>
	            AND T1.ACP_DVSN_CD = #{schAudYrNoKndCd}
	        </if>
	        <if test='iptAudSbjNm != null and iptAudSbjNm != ""'>
	            AND TIT_NM LIKE '%'||#{iptAudSbjNm}||'%'
	        </if>
	        
	        <if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
	            AND (SELECT ST1.HIRK_DPT_CD FROM TBDCMACM002M ST1 WHERE ST1.DPT_CD = T1.DPT_CD) =
	            #{schSpvBrdvCd}
	        </if>
	        <if test="schDeptCd != null and schDeptCd != ''">
	            AND DPT_CD = #{schDeptCd}
	        </if>
                
                )
          ORDER BY SND_DH DESC
        <include refid="include.pageOrder" />
    </select>
    
    
    <select id="selectRcptDoc" resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.selectRcptDoc */
        <![CDATA[
            SELECT 
                AUD_YR, 
                AUD_NO, 
                DOC_ID, 
                A.AUD_KND_CD,
                A.AUD_GRN_NO,
                RPRT_CD, 
                A.RPRT_NM,
                A.RPRT_NM AS V_RPRT_NM, 
                F_CODE_NM('1000780',DOC_STA_CD) DOC_STA_NM, 
                DOC_STA_CD,
                APV_STA_CD,
                F_DPT_INFO(SND_DPT_CD,'1') SND_DPT_NM,
                F_USR_INFO_BY_ID(SNDR_ID,'2') AS SNDR_NM,
                TO_CHAR(SND_DH,'YYYY"-"MM"-"DD') SND_DH,
                F_DPT_INFO(RCPT_DPT_CD,'1') RCPT_DPT_NM,
                F_USR_INFO_BY_ID(RCNT_ID,'2') AS RCNT_NM,
                TO_CHAR(RCPT_DH,'YYYY"-"MM"-"DD') AS RCPT_DH,
                SR_DOC_SNO,
                B.SORT_SNO,
                B.REF_ID,
                A.AUD_STEP_CD,
                F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
            FROM 
                TBBADDED103M A 
                INNER JOIN  
                TBBADDED111M B
                USING(AUD_YR, AUD_NO, DOC_ID, RPRT_CD)
            WHERE AUD_YR =  #{audYr}
            AND AUD_NO = #{audNo}
            AND RPRT_CD = 'A10600410' /*처리안검토의견서 취합본 RPRT_CD*/
            AND A.APV_STA_CD = '30'
        ]]>
            <if test="refId != null and refId != ''">
                AND A.REF_ID = #{refId}
            </if>
    </select>
    
    <update id="saveRcptDoc" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.saveRcptDoc */
        <![CDATA[
        UPDATE TBBADDED111M
        SET 
            DOC_STA_CD = '20',
            FNL_MDF_DH = SYSDATE,
            RCPT_DH = SYSDATE,
            RCNT_ID = #{usrId},
            FNL_USR_ID = #{usrId},
            FNL_DEAL_DPT_CD = #{dptCd},
            FNL_MNU_ID = 'AEPARP004Q'
        WHERE 
                AUD_YR = #{audYr}
        AND AUD_NO = #{audNo}
        AND AUD_STEP_CD = #{audStepCd}
        AND DOC_ID = #{docId}
        AND SR_DOC_SNO = #{srDocSno}
        ]]>
    </update>
    
    <select id="selectSendDocInfo" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.selectSendDocInfo */
        <![CDATA[
            SELECT 
                A.AUD_YR
                ,A.AUD_NO
                ,A.AUD_STEP_CD
                ,A.DOC_ID
                ,A.AUD_KND_CD
                ,A.AUD_GRN_NO
                ,A.RPRT_NM
                ,A.RPRT_CD
                ,A.LINK_URL
                ,A.AUD_RPRT_DVSN_CD 
                ,A.DOC_KND_CD 
                ,A.REF_ID
                ,A.REF_DY
                ,(SELECT ST.MNG_DPT_CD FROM TBBADDED001M ST WHERE ST.AUD_YR = A.AUD_YR AND ST.AUD_NO = A.AUD_NO) AS MNG_DPT_CD 
            FROM TBBADDED103M A
            WHERE A.AUD_YR = #{audYr}
            AND A.AUD_NO = #{audNo}
            AND A.AUD_STEP_CD = #{audStepCd}
            AND A.DOC_ID = #{docId}
        ]]>
    </select>
    
    <insert id="saveSendDoc"> 
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.saveSendDoc */
        <![CDATA[
            INSERT INTO TBBADDED111M (
                   AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,SR_DOC_SNO
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM
                  ,RPRT_CD
                  ,LINK_URL
                  ,DOC_STA_CD
                  ,SND_DPT_CD
                  ,SNDR_ID
                  ,SND_DH
                  ,RCPT_DPT_CD
                  ,RCNT_ID
                  ,RCPT_DH
                  ,AUD_RPRT_DVSN_CD
                  ,DOC_KND_CD
                  ,REF_ID
                  ,REF_DY
                  ,SORT_SNO
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH)
            VALUES (
                   #{audYr}
                   ,#{audNo}
                   ,#{audStepCd}
                   ,#{docId}
                   ,(SELECT LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0) 
                       FROM TBBADDED111M 
                      WHERE AUD_YR = #{audYr} 
                        AND AUD_NO =#{audNo}
                        AND AUD_STEP_CD = #{audStepCd}
                        AND DOC_ID = #{docId} )
                   ,#{audKndCd}
                   ,#{audGrnNo}
                   ,#{rprtNm}
                   ,#{rprtCd}
                   ,#{linkUrl}
                   ,'20'
                   ,#{dptCd}
                   ,#{usrId}
                   ,SYSDATE
                   ,#{rcptDptCd}
                   ,NULL
                   ,SYSDATE
                   ,#{audRprtDvsnCd}
                   ,#{docKndCd}
                   ,#{refId}
                   ,#{refDy}
                   ,(SELECT LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0)
                       FROM TBBADDED111M 
                      WHERE AUD_YR = #{audYr}
                        AND AUD_NO =#{audNo}
                        AND AUD_STEP_CD =#{audStepCd}
                        AND DOC_ID = #{docId} )
                   ,#{usrId}
                   ,#{usrId}
                   ,#{dptCd}
                   ,'AEPARP004Q'
                   ,SYSDATE
                   ,SYSDATE)
        ]]>
    </insert>
    
    <delete id="saveRetDoc" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.saveRetDoc */
        <![CDATA[
        DELETE TBBADDED111M
        WHERE 
                AUD_YR = #{audYr}
        AND AUD_NO = #{audNo}
        AND AUD_STEP_CD = #{audStepCd}
        AND DOC_ID = #{docId}
        AND SR_DOC_SNO = #{srDocSno}
        ]]>
    </delete>
    
    <select id="chkPrcs" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.chkPrcs */
        <![CDATA[
             SELECT * 
            FROM
                (
                SELECT AUD_MAIN_STEP_ID, CMPT_YN FROM TBBADDED102M
                WHERE AUD_YR = #{audYr}
                AND AUD_NO = #{audNo}
                ) 
            PIVOT 
                (MAX(CMPT_YN) 
                    FOR AUD_MAIN_STEP_ID 
                    IN (
                             '610101' AS STEP1
                            ,'610201' AS STEP2
                            ,'610301' AS STEP3
                            ,'610401' AS STEP4
                            ,'610501' AS STEP5)
                 )
        ]]>
    </select>
    
    <select id="selectDocumentList" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.selectDocumentList */
        <![CDATA[
            SELECT RPRT_NM,
                   APV_STA_CD,
                   APV_RQS_ID,
                   DOC_ID,
                   APV_SRNO,
                   PST_NM,
                   APVR_NM,
                   APV_DH ,
                   CASE
                        WHEN ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SRNO) = 1 THEN COUNT(*) OVER(PARTITION BY DOC_ID)
                        ELSE 0
                   END ROWSPAN_CNT
              FROM (
                   SELECT 
                          A.RPRT_NM ,       /*보고서명 */
                          A.APV_STA_CD ,    /*결재상태코드 */
                          B.DOC_ID ,        /*결재문서번호 */
                          A.APV_RQS_ID,     /*결재요청ID */
                          B.APV_SRNO ,      /*결재순번 */
                          B.PST_NM ,        /*결재자직위코드 */
                          B.APVR_NM ,       /*결재자전산번호 */
                          B.APV_DH          /*결재일시 */
                     FROM TBBADDED103M A,
                          (
                          SELECT APV_DOC_NO AS DOC_ID ,
                                 APV_SNO AS APV_SRNO ,
                                 F_CODE_NM('1000176', APVR_PST_CD) AS PST_NM ,
                                 F_USR_INFO(APVR_CNB, '2') AS APVR_NM ,
                                 TO_CHAR(APV_DH, 'YYYY-MM-DD') AS APV_DH
                            FROM TBDCMACM023L
                           WHERE APV_SNO <> '0'
                           UNION ALL
                          SELECT DH1.DOC_ID,
                                 DH1.APV_SRNO,
                                 (SELECT H2.PST_NM AS PST_NM
                                    FROM TBDCMACM111H H1,
                                         TBDCMACM112H H2
                                   WHERE 1=1
                                     AND H1.RCPT_DT = H2.RCPT_DT
                                     AND H1.RCPT_ID = H2.RCPT_ID
                                     AND H1.ONR_DOC_MNG_CRD_ID = DH1.DOC_ID
                                     AND H2.APVR_ID = DH1.APVR_ID
                                   GROUP BY H2.PST_NM ) AS PST_NM,
                                 DH1.APVR_NM,
                                 DH1.APV_DH
                            FROM 
                                 (SELECT ONR_DOC_MNG_CRD_ID AS DOC_ID,
                                         APV_HIS_SRNO AS APV_SRNO,
                                         APVR_ID,
                                         APVR_NM AS APVR_NM,
                                         TO_CHAR(APV_DH, 'YYYY-MM-DD') AS APV_DH
                                    FROM TBDCMACM102L D2
                                   WHERE 1=1
                                     AND ONR_APV_DVSN_CD <> '10' --(기안자 제외)
                                      AND NVL(ONR_APV_RSLT_CD,'hh') <>'50'
                                   ORDER BY DOC_ID,APV_SRNO
                                 ) DH1 
                          ) B
                    WHERE A.AUD_YR = #{audYr}
                      AND A.AUD_NO = #{audNo}
                      AND A.AUD_STEP_CD = #{audStepCd}
                      AND A.RPRT_CD = 'A10600400' /*처리안검토의견서 취합본 RPRT_CD*/
                      AND A.REF_ID = #{docId}
                      AND B.DOC_ID = A.APV_RQS_ID
                )
    ]]>
    </select>
    
    <select id="selectDocumentList2" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.selectDocumentList2 */  
        <![CDATA[
            SELECT A.RPRT_NM            /*보고서명 */
                 , A.APV_STA_CD         /*결재상태코드 */
                 , F_CODE_NM('1000773',NVL(A.APV_STA_CD,'10')) AS APV_STA_NM /*결재상태명 */
                 , A.SORT_SNO           /*보고서순번  */
                 , A.DOC_ID             /*결재문서번호 */
                 , A.REF_ID             /*참조ID */
                 , A.REF_DY             /*참조일자 */
                 , A.APV_RQS_ID         /*결재요청ID */
                 , A.AUD_RPRT_DVSN_CD   /*감사보고서구분코드 */
                 , A.RPRT_CD            /*문서종류코드 */
              FROM TBBADDED103M A
             WHERE A.AUD_YR = #{audYr}
               AND A.AUD_NO = #{audNo}
               AND A.AUD_STEP_CD = #{audStepCd}
               AND A.RPRT_CD = 'A10600500'
               AND A.REF_ID = #{docId}
        ]]>
    </select>
    
    
    <select id="selectTrtmTmpId" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.selectTrtmTmpId */
             SELECT MAX(DOC_ID) AS TMP_ID
               FROM TBFDMADM002M
              WHERE AUD_DOC_CD = 'A10600400'
    </select>
    
    <insert id="insertCopyDoc"> 
        /* kr.go.bai.eip.aep.arp.dao.AEPARP004QMapper.insertCopyDoc */
        <![CDATA[
            INSERT INTO TBBADDED111M (
                   AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,SR_DOC_SNO
                  ,RPRT_CD
                  ,REF_ID
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH)
            VALUES (
                   #{audYr}
                   ,#{audNo}
                   ,#{audStepCd}
                   ,#{vDocId}
                   ,(SELECT LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0) 
                       FROM TBBADDED111M 
                      WHERE AUD_YR = #{audYr} 
                        AND AUD_NO =#{audNo}
                        AND AUD_STEP_CD = #{audStepCd}
                        AND DOC_ID = #{docId} )
                   ,'A10600200'
                   ,#{docId}
                   ,#{usrId}
                   ,#{usrId}
                   ,#{dptCd}
                   ,#{currentMenuId}
                   ,SYSDATE
                   ,SYSDATE)
        ]]>
    </insert>
</mapper> 
