<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.cam.dao.AEPCAM003PMapper">

    <select id="selectAffList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003PMapper.selectAffList*/
        <![CDATA[
            SELECT F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || T1.AFF_CD AS AFF_NO
                  ,F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') AS AUD_GRN_NO
                  ,T1.AUD_YR
                  ,T1.AUD_NO
                  ,T1.AFF_SNO
                  ,T1.RPRT_FILD_ID
                  ,T1.TITLE_NM
                  ,(
                    SELECT RPRT_NM
                      FROM TBBADDED103M
                     WHERE AUD_YR = T1.AUD_YR
                       AND AUD_NO = T1.AUD_NO
                       AND DOC_ID = T1.DOC_ID
                   ) AS RPRT_NM
                  ,(SELECT AGGR_CONCAT(ST2.RPRT_NM, '|')
                      FROM TBCSPKDE106M ST1
                     INNER JOIN TBBADDED103M ST2
                             ON ST1.AUD_YR = ST2.AUD_YR
                            AND ST1.AUD_NO = ST2.AUD_NO
                            AND ST1.RPRT_LINK_SEQ = ST2.REF_ID
                            AND ST1.AFF_SNO = ST2.REF_DY
                            AND ST2.RPRT_CD = 'A10600900'
                     WHERE ST1.AUD_YR = T1.AUD_YR
                       AND ST1.AUD_NO = T1.AUD_NO
                       AND ST1.AFF_SNO = T1.AFF_SNO) AS MFEX_EXAM_RPRT
                  ,(SELECT AGGR_CONCAT(ST2.DOC_ID, '|')
                      FROM TBCSPKDE106M ST1
                     INNER JOIN TBBADDED103M ST2
                             ON ST1.AUD_YR = ST2.AUD_YR
                            AND ST1.AUD_NO = ST2.AUD_NO
                            AND ST1.RPRT_LINK_SEQ = ST2.REF_ID
                            AND ST1.AFF_SNO = ST2.REF_DY
                            AND ST2.RPRT_CD = 'A10600900'
                     WHERE ST1.AUD_YR = T1.AUD_YR
                       AND ST1.AUD_NO = T1.AUD_NO
                       AND ST1.AFF_SNO = T1.AFF_SNO) AS MFEX_EXAM_DOC_ID
                  ,(
                    SELECT AGGR_CONCAT(T3.RECEV_DY||'-소명-'||T3.GRN_SRNO, '|')
                      FROM TBCSPKDE106M T3
                     WHERE T3.AUD_YR = T1.AUD_YR
                       AND T3.AUD_NO = T1.AUD_NO
                       AND T3.RPRT_FILD_ID = T1.RPRT_FILD_ID
                       AND T3.AFF_SNO = T1.AFF_SNO
                   ) AS MFEX_MPP
                  ,(
                    SELECT COUNT(1)
                      FROM TBBADDED110M T2
                     WHERE T1.AUD_YR = T2.AUD_YR
                       AND T1.AUD_NO = T2.AUD_NO
                       AND T1.RPRT_FILD_ID = T2.RPRT_FILD_ID
                   ) AS EVI_DOC_CNT
                   , T1.APVR_CD
              FROM TBBADDED145M T1
             WHERE T1.AUD_YR = #{audYr}
               AND T1.AUD_NO = #{audNo}
               AND T1.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
                                   FROM (
                                         SELECT RANK() OVER (PARTITION BY A.DOC_ID ORDER BY DECODE(A.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
                                            , A.APVR_CD APVR_CD
                                            , A.DOC_ID
                                         FROM TBBADDED145M A
                                        WHERE A.AUD_YR = #{audYr}
                                          AND A.AUD_NO  =  #{audNo}
                                          AND A.APVR_CD <> '0010200'
                                        GROUP BY A.DOC_ID, A.APVR_CD )   
                                  WHERE RN = 1 
                                    AND T1.DOC_ID = DOC_ID)
               AND T1.AFF_SNO NOT IN (SELECT T2.AFF_SNO
                                        FROM TBCSPKDE106M T2
                                       WHERE T2.AUD_YR = T1.AUD_YR
                                         AND T2.AUD_NO = T1.AUD_NO
                                         AND T2.SRNO = #{srno}
                                         AND T2.AFF_SNO = T1.AFF_SNO)
               AND T1.AFF_SNO NOT IN (SELECT T2.AFF_SNO
                                        FROM TBCSPKDE106M T2
                                       WHERE T2.AUD_YR = T1.AUD_YR
                                         AND T2.AUD_NO = T1.AUD_NO
                                         AND T2.AFF_SNO = T1.AFF_SNO
                                         AND T2.CLSNG_YN = 'Y')
        ]]>
    </select>
    
    
    <insert id="insertAffMppInfo" parameterType="paramMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003PMapper.insertMergeInfo*/
            INSERT INTO TBCSPKDE106M(
                    AUD_YR
                   ,AUD_NO
                   ,SRNO
                   ,AFF_SNO
                   ,RPRT_FILD_ID
                   ,AFF_SND_STAT_CD
                   ,RPRT_REQ_CD
                   ,RPRT_REQ_DT
                   ,FRT_USR_ID
                   ,FNL_USR_ID
                   ,FNL_DEAL_DPT_CD
                   ,FNL_MNU_ID
                   ,FRT_REGI_DH
                   ,FNL_MDF_DH
                   ,RECEV_DY
                   ,GRN_SRNO
                   ,APVR_CD 
                )
                VALUES (
                    #{audYr}
                   ,#{audNo}
                   ,#{srno}
                   ,#{affSno}
                   ,#{rprtFildId}
                   ,#{affSndStatCd}
                   ,#{rprtReqCd}
                   ,#{rprtReqDt}
                   ,#{usrId}
                   ,#{usrId}
                   ,#{dptCd}
                   ,#{mnuId}
                   ,SYSDATE
                   ,SYSDATE
                   ,#{recevDy}
                   ,#{grnSrno}
                   ,#{apvrCd} 
                 )
    </insert>
</mapper> 

