<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper">

<select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.selectMainList*/
        <include refid="include.pageSelct" />
            <![CDATA[
            WITH AUTH_DEPT AS (
                SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#{cnb}, #{dptAuth}, '', #{schSpvBrdvCd}))
            )
            SELECT D1.AUD_YR AS AUD_YR
                 , D1.AUD_NO AS AUD_NO
                 , D1.AUD_KND_CD AS AUD_KND_CD
                 , D1.AUD_GRN_NO AS AUD_GRN_NO
                 , F_CODE_NM('1000753',D1.AUD_CTRL_CD) AS AUD_CTRL_NM
                 , F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D1.AUD_KND_CD, '-') AS AUD_YR_N0
                 , CASE WHEN D1.AUD_YR >= '2016' 
                        THEN SUBSTR(D1.AUD_KND_CD,3,1)
                        ELSE '' END AS AUD_YR_NO_KND_CD /*감사연번호종류코드*/
                 , CASE WHEN D1.AUD_YR >= '2016' 
                        THEN F_CODE_NM('1000739',D1.AUD_KND_CD)   
                        ELSE '-' END AS AUD_YR_NO_KND_NM /*감사연번호종류코드명*/
                 , D1.AUD_YR||'-'||SUBSTR(D1.AUD_TASK_CD,-1)||'-'||D1.ORG_DVSN_CD||'-'||SUBSTR(D1.AUD_KND_CD,-1)
                    ||'-'||SUBSTR(D1.SPV_BRDV_CD,1,2)||SUBSTR(D1.SPV_BRDV_CD,4,2)||'-'||SUBSTR(D1.AUD_WAY_CD,-1)||'-'||D1.AUD_NO AS AUD_DTL_NO /*세부연번호*/
                 , D1.AUD_YR||'-'||D1.AUD_KND_CD||'-'||D1.AUD_NO AS AUD_YR_KND_NO_CD
                 , F_DPT_INFO(D1.SPV_BRDV_CD,'1')        AS SPV_BRDV_NM
                 , F_CODE_NM('1000007', D1.AUD_KND_CD) AS AUD_KND_NM
                 , F_CODE_NM('1000751',D1.BZT_BGT_DVSN_CD) AS BZT_BGT_DVSN_NM
                 , D1.AUD_SBJ_NM        AS AUD_SBJ_NM
                 , F_ORG_INFO(D1.AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM
                 , F_DPT_INFO(D1.MNG_DPT_CD,'1')         AS MNG_DPT_NM
                 , D1.MNG_DPT_CD         AS  MNG_DPT_CD  /*관리국코드 - 2017.02.01 EUNOK */
                 , F_CODE_NM('1000742',D1.REQ_DVSN_CD) AS REQ_DVSN_NM /*관련업무 코드 변경 1000337 -> 1000742  2017.07.07 EUNOK */
                 , CASE WHEN D1.PRSS_STEP_CD LIKE 'A10%' THEN (SELECT AUD_STEP_NM 
                                                                 FROM TBBADDED101M 
                                                                WHERE AUD_YR = D1.AUD_YR
                                                                  AND AUD_NO = D1.AUD_NO
                                                                  AND AUD_STEP_CD = D1.PRSS_STEP_CD)
                        ELSE F_CODE_NM('1000475',CASE WHEN SUBSTR(D1.AUD_KND_CD,3) = '55' THEN '' 
                                                      WHEN D3.AUD_EXEC_HNDL_STA_CD = '9'  THEN '10'
                                                      ELSE
                                                        CASE WHEN TRIM(D3.ENF_APV_DT) IS NOT NULL THEN '10'
                                                             WHEN TRIM(D3.CHF_CMTR_APV_DT)IS NOT NULL THEN '09'
                                                             WHEN TRIM(D3.OW_DHD_APV_DT)  IS NOT NULL THEN '08'
                                                             WHEN TRIM(D3.JA_JDG_SSEC_APV_DT) IS NOT NULL THEN '07'
                                                             WHEN TRIM(D3.MDT_DDG_APV_DT) IS NOT NULL THEN '06'
                                                             WHEN TRIM(D3.MDT_OFER_APV_DT)IS NOT NULL THEN '05'
                                                             WHEN TRIM(D3.AUD_BRDV_APV_DT)IS NOT NULL THEN '04'
                                                             WHEN TRIM(D3.RTN_RPT_DT) IS NOT NULL THEN '03'
                                                        ELSE
                                                            (CASE WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8' END) = '8' AND D3.RTN_RPT_DT IS NULL AND D3.FLD_AUD_END_DT IS NULL THEN '02'
                                                                  WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8' END) = '8' AND D3.RTN_RPT_DT IS NULL THEN '11'
                                                                  WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8' END) = '7' THEN '02'
                                                                   END)
                                                        END
                                                      END)
                        END    AS PRSS_STEP_NM
                 ,DECODE(NVL((SELECT SUM(NVL(CNT,0)) AS SBCN_CNT
                                              FROM (
                                                    SELECT 
                                                        REL_AUD_YR AS AUD_YR
                                                        , REL_AUD_NO AS AUD_NO
                                                        , COUNT(1) CNT
                                                    FROM TBBADDED121M
                                                    WHERE WORK_DVSN_CD = 'A10'
                                                    GROUP BY REL_AUD_YR, REL_AUD_NO
                                                    UNION
                                                    SELECT 
                                                        AUD_YR
                                                        , AUD_NO
                                                        , COUNT(1) CNT
                                                    FROM TBBADDED113M T1
                                                    WHERE EXISTS (SELECT 1
                                                                                 FROM TBBADDED120M ST1
                                                                               WHERE ST1.CMT_DY = T1.SBCN_DY
                                                                                    AND ST1.CMT_DVSN_CD = '10')
                                                    GROUP BY AUD_YR, AUD_NO
                                                    UNION
                                                    SELECT 
                                                        AUD_YR
                                                        , AUD_NO
                                                        , COUNT(1) CNT
                                                    FROM TBBADDED114M T1
                                                    WHERE EXISTS (SELECT 1
                                                                                 FROM TBBADDED120M ST1
                                                                               WHERE ST1.CMT_DY = REPLACE(T1.SBMT_FIX_DT,'-')
                                                                                    AND ST1.CMT_DVSN_CD = '20')
                                                    GROUP BY AUD_YR, AUD_NO
                                                   )
                                             WHERE AUD_YR = D1.AUD_YR
                                               AND AUD_NO = D1.AUD_NO
                                             GROUP BY AUD_YR, AUD_NO),0),0,'N','Y') AS SBCN_YN /*부의 실시 여부 */
                 , D1.PRSS_STEP_CD
                 , D3.REQ_NTAS_DCS_DT  /*20170817 EUNOK 청구국회결정일 */
                 , D1.AUD_TOT_DRTR_CNB                                         /* 감사주관자 */
                 , F_USR_INFO(D1.AUD_TOT_DRTR_CNB,'2') AS AUD_TOT_DRTR_CNB_NM  /* 감사주관자 */
                 , D3.AUD_EXEC_HNDL_STA_CD  /* 감사종료구분 */
            FROM TBBADDED001M AS D1
 LEFT OUTER JOIN TBBADDED003M AS D3 ON D1.AUD_YR = D3.AUD_YR AND D1.AUD_NO = D3.AUD_NO
           WHERE 1=1
              AND ((D3.ENF_APV_DT IS NOT NULL AND D1.AUD_YR > '2016') OR 
                      (EXISTS (SELECT 1 
                                 FROM TBBADEAR002D T1 
                               WHERE T1.AUD_YR = D1.AUD_YR AND T1.AUD_NO = D1.AUD_NO AND T1.AUD_YR < '2017') )  
                     )
           AND 
                (
                     ( EXISTS (SELECT ST1.DPT_CD FROM AUTH_DEPT ST1 WHERE D1.MNG_DPT_CD = ST1.DPT_CD)
                        OR  (#{schSpvBrdvCd}  = (SELECT D4.HIRK_DPT_CD FROM TBDCMACM002M D4 WHERE D4.DPT_CD  = D1.MNG_DPT_CD AND D4.USE_YN = 'Y') 
                            AND D1.AUD_SCL_CD =  2  )
                     )
                   /* 부서권한은 없으나 출장 배정자로 등록 된 경우 감사사항 조회 가능하도록 수정 MJ */
                   OR EXISTS (
                        SELECT 1
                          FROM TBBADDED002M ST4
                         INNER JOIN TBBADDED005L ST5
                            ON ST4.BZT_YR = ST5.BZT_YR
                           AND ST4.BZT_SNO = ST5.BZT_SNO
                         WHERE D1.AUD_YR = ST4.REL_AUD_YR
                           AND D1.AUD_NO = ST4.REL_AUD_NO
                           AND ST5.PCT_CNB = #{cnb}
                   )
                )

            AND SUBSTR(D1.AUD_KND_CD, 3, 1) <> '5' /*확인출장은 조회하지 않음*/
            ]]>
            
            /*20170202 EUNOK 관리부서 != 감찰담당관, 감찰관, 유지보수,구축용역이 아니면 감찰관부서의 데이터는 검색되지 않음*/
            <if test='searchChk != "Y"  and  dptCd != "140100" '>
               AND D1.MNG_DPT_CD NOT IN ('100000','100100')
            </if>
            <if test="schAudYr != null and schAudYr != ''">
                    AND D1.AUD_YR  = #{schAudYr}
            </if>
            <if test="schAudYrNoKndCd != null and schAudYrNoKndCd != ''">
                    AND D1.AUD_KND_CD = #{schAudYrNoKndCd}
            </if>
            <if test="schAudNo != null and schAudNo != ''">
                    AND D1.AUD_GRN_NO = #{schAudNo}
            </if>
            <if test="schAudSbjNm != null and schAudSbjNm != ''">
                    AND D1.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
            </if>
            <if test="schPrssStepCd != null and schPrssStepCd != ''">
                <![CDATA[
                AND (
                CASE WHEN #{schAudYr} < 2017 THEN (CASE WHEN SUBSTR(D1.AUD_KND_CD,3) = '55' THEN ''
                                                        WHEN D3.AUD_EXEC_HNDL_STA_CD = '9'  THEN '10'
                                                   ELSE 
                                                        CASE WHEN TRIM(D3.ENF_APV_DT) IS NOT NULL THEN '10'
                                                             WHEN TRIM(D3.CHF_CMTR_APV_DT)IS NOT NULL THEN '09'
                                                             WHEN TRIM(D3.OW_DHD_APV_DT)  IS NOT NULL THEN '08'
                                                             WHEN TRIM(D3.JA_JDG_SSEC_APV_DT) IS NOT NULL THEN '07'
                                                             WHEN TRIM(D3.MDT_DDG_APV_DT) IS NOT NULL THEN '06'
                                                             WHEN TRIM(D3.MDT_OFER_APV_DT)IS NOT NULL THEN '05'
                                                             WHEN TRIM(D3.AUD_BRDV_APV_DT)IS NOT NULL THEN '04'
                                                             WHEN TRIM(D3.RTN_RPT_DT) IS NOT NULL THEN '03'
                                                        ELSE 
                                                            (CASE WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8'
                                                                              END) = '8' AND D3.RTN_RPT_DT IS NULL AND D3.FLD_AUD_END_DT IS NULL THEN '02'
                                                                  WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8'
                                                                              END) = '8' AND D3.RTN_RPT_DT IS NULL THEN '11'
                                                                  WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8'
                                                                              END) = '7' THEN '02'
                                                                  END)
                                                        END
                                                   END)
                     ELSE (SELECT AUD_STEP_CD FROM TBBADDED101M WHERE AUD_YR = D1.AUD_YR AND AUD_NO = D1.AUD_NO AND AUD_STEP_CD = D1.PRSS_STEP_CD)
                     END	
                  ) = #{schPrssStepCd}
                ]]>
            </if>
            <if test="schAudKndCd != null and schAudKndCd != ''">
                    AND D1.AUD_KND_CD  = #{schAudKndCd}
            </if>
            <if test="schDeptCd != null and schDeptCd != ''">
                    AND D1.MNG_DPT_CD = #{schDeptCd}
            </if>
            <if test="schReqDvsnCd != null and schReqDvsnCd != ''">
            		/* 관련업무 조건 수정 - 2017.02.13 yyh */
                    AND EXISTS (SELECT 1
                                  FROM TBBADDED030L 
                                 WHERE AUD_YR  = D1.AUD_YR
                                   AND AUD_NO  = D1.AUD_NO
                                   AND DVSN_CD = #{schReqDvsnCd})        
            </if>
             <if test="reqDvsnCd != null and reqDvsnCd != ''">
                    AND D1.REQ_DVSN_CD = #{reqDvsnCd}
            </if>
            ORDER BY D1.FRT_REGI_DH DESC /* 20170721 EUNOK 수정 ORDER BY D1.AUD_YR DESC, D1.AUD_KND_CD, D1.AUD_GRN_NO DESC */
               
        <include refid="include.pageOrder" />
    </select>
    

		<select id="selectMajorAudDocListReadReq" parameterType="paramMap" resultType="egovMap">
		/*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.selectMajorAudDocListReadReq*/
		<![CDATA[
			 SELECT F_CODE_NM('1000786',A.RPRT_CD) AS AUD_DOC_NM
			      , A.RPRT_NM
				  , A.RPRT_CD 
			      , A.APV_STA_CD
			      , A.APV_RQS_ID
			      , A.DOC_ID                    
			      , A.REF_ID
			      , A.AUD_YR
			      , A.AUD_NO
			      , A.AUD_STEP_CD
			      , (CASE WHEN (SELECT COUNT(AUD_YR) 
			      				  FROM TBBADEAR002D D		/*처분요구가 한건도 없는 경우 열람 불가*/
				 				 WHERE D.AUD_YR = A.AUD_YR
				 				   AND D.AUD_NO = A.AUD_NO) < 1 THEN 'N'
					      WHEN (SELECT COUNT(AUD_YR) 
			     	 		 	  FROM TBBADEAR002D D		/*시행일이 없는 처분요구가 한건이라도 있는 경우 열람 불가*/
								 WHERE D.AUD_YR = A.AUD_YR
								   AND D.AUD_NO = A.AUD_NO
								   AND D.ENF_DT IS NULL) > 0    THEN 'N'										  
				    		                                    ELSE 'Y'
					  END)                               AS REQ_POSSIBLE_YN
				   , B.MNG_DPT_CD
				   , F_DPT_INFO(B.MNG_DPT_CD,'1')        AS MNG_DPT_NM
				   , F_USR_INFO_BY_ID(A.DOC_WRT_ID,'2')  AS DOC_WRT_NM 
			    FROM TBBADDED103M A
	           INNER JOIN 
	                 TBBADDED001M B
			  	  ON A.AUD_YR = B.AUD_YR
			     AND A.AUD_NO = B.AUD_NO		  
			   WHERE A.AUD_YR = #{audYr}
			     AND A.AUD_NO =  #{audNo}
			     AND A.RPRT_CD IN (SELECT AA.CD
			                         FROM TBDCMACM013C AA
			                        WHERE AA.CMM_CD_DVSN_CD = '1000786'
			                          AND AA.USR_DFN_TXT_3 = 'Y'
			                          AND USE_YN = 'Y' ) /*감사실시계획서, 감사보고서, 실지감사 종료보고서 'A10300100','A10500200','A10600200'*/
			     AND ((A.RPRT_CD = 'A10600200' AND A.AUD_STEP_CD = 'A1070'  ) OR 
			          (A.RPRT_CD != 'A10600200' AND A.APV_STA_CD = '30' ) )
		       ORDER BY 
		             A.RPRT_CD 
		]]>
	</select>
	
	
	<!-- 2017이후 감사사항별 주요 문서 조회 -->
	<select id="selectMajorAudDocListReadReq2" parameterType="paramMap" resultType="egovMap">
		/*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.selectMajorAudDocListReadReq2*/
		<![CDATA[
			 SELECT F_CODE_NM('1000786',A.RPRT_CD) AS AUD_DOC_NM
			      , A.RPRT_NM
				  , A.RPRT_CD 
			      , A.APV_STA_CD
			      , A.APV_RQS_ID
			      , A.DOC_ID                    
			      , A.REF_ID
			      , A.AUD_YR
			      , A.AUD_NO
			      , A.AUD_STEP_CD
			      , (CASE WHEN (SELECT COUNT(AUD_YR) 
			      				  FROM TBBADEAR002D D		/*처분요구가 한건도 없는 경우 열람 불가*/
				 				 WHERE D.AUD_YR = A.AUD_YR
				 				   AND D.AUD_NO = A.AUD_NO) < 1 THEN 'N'
					      WHEN (SELECT COUNT(AUD_YR) 
			     	 		 	  FROM TBBADEAR002D D		/*시행일이 없는 처분요구가 한건이라도 있는 경우 열람 불가*/
								 WHERE D.AUD_YR = A.AUD_YR
								   AND D.AUD_NO = A.AUD_NO
								   AND D.ENF_DT IS NULL) > 0    THEN 'N'										  
				    		                                    ELSE 'Y'
					  END)                               AS REQ_POSSIBLE_YN
				   , B.MNG_DPT_CD
				   , F_DPT_INFO(B.MNG_DPT_CD,'1')        AS MNG_DPT_NM
				   , F_USR_INFO_BY_ID(A.DOC_WRT_ID,'2')  AS DOC_WRT_NM 
			    FROM TBBADDED103M A
	           INNER JOIN 
	                 TBBADDED001M B
			  	  ON A.AUD_YR = B.AUD_YR
			     AND A.AUD_NO = B.AUD_NO		  
			   WHERE A.AUD_YR = #{audYr}
			     AND A.AUD_NO =  #{audNo}
			     AND A.RPRT_CD IN (SELECT AA.CD
			                         FROM TBDCMACM013C AA
			                        WHERE AA.CMM_CD_DVSN_CD = '1000786'
			                          AND AA.USR_DFN_TXT_3 = 'Y'
			                          AND USE_YN = 'Y' ) /*감사실시계획서, 감사보고서, 실지감사 종료보고서 'A10300100','A10500200','A10600200'*/
			     AND ((A.RPRT_CD = 'A10600200' AND A.AUD_STEP_CD = 'A1070'  ) OR 
			          (A.RPRT_CD != 'A10600200' AND A.APV_STA_CD = '30' ) )
		       ORDER BY 
		             A.RPRT_CD 
		]]>
	</select>
	
	<select id="selectMajorAudDocListReadReqBfEip" parameterType="paramMap" resultType="egovMap">
		/*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.selectMajorAudDocListReadReqBfEip*/
		<![CDATA[
			SELECT DECODE(D1.DOC_TYP_CD,'AD-AR-002','실지감사계획서','AD-AR-003','실지감사종료보고','AD-AR-001','감사결과보고서') AS AUD_DOC_NM
			      ,D2.FILE_NAME AS RPRT_NM
			      ,'' AS DISP_APV_STA_NM
			      ,D1.DOC_TYP_CD AS RPRT_CD
			      ,'' AS APV_RQS_ID
			      ,'' AS APV_STA_CD
			      ,D1.DOC_ID
			      ,D1.AUD_YR
			      ,D1.AUD_NO
			 FROM TBBADDED021M D1
			    , ECM_FILE_LIST_VIEW2 D2
			WHERE 1=1
			  AND D1.DOC_ID = D2.DOC_ID
			  AND D1.AUD_YR = #{audYr}
			  AND D1.AUD_NO = #{audNo}
			  AND D1.DOC_TYP_CD IN ('AD-AR-003','AD-AR-001','AD-AR-002')
			ORDER BY DECODE(D1.DOC_TYP_CD,  'AD-AR-002', 1, 'AD-AR-003', 2,  'AD-AR-001', 3)
		]]>
	</select>
	
	<!-- 2017이전 감사사항별 주요 문서 조회 -->
	<select id="selectMajorAudDocListReadReqBfEip2" parameterType="paramMap" resultType="egovMap">
		/*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.selectMajorAudDocListReadReqBfEip2*/
		<![CDATA[
			SELECT DECODE(D1.DOC_TYP_CD,'AD-AR-002','실지감사계획서','AD-AR-003','실지감사종료보고','AD-AR-001','감사결과보고서') AS AUD_DOC_NM
			      ,D2.FILE_NAME AS RPRT_NM
			      ,'' AS DISP_APV_STA_NM
			      ,D1.DOC_TYP_CD AS RPRT_CD
			      ,'' AS APV_RQS_ID
			      ,'' AS APV_STA_CD
			      ,D1.DOC_ID
			      ,D1.AUD_YR
			      ,D1.AUD_NO
			 FROM TBBADDED021M D1
			    , ECM_FILE_LIST_VIEW2 D2
			WHERE 1=1
			  AND D1.DOC_ID = D2.DOC_ID
			  AND D1.AUD_YR = #{audYr}
			  AND D1.AUD_NO = #{audNo}
			  AND D1.DOC_TYP_CD IN ('AD-AR-003','AD-AR-001','AD-AR-002')
			ORDER BY DECODE(D1.DOC_TYP_CD,  'AD-AR-002', 1, 'AD-AR-003', 2,  'AD-AR-001', 3)
		]]>
	</select>
	
	<insert id="insertReadRqs">
       /*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.insertReadRqs*/
	   INSERT 
	     INTO TBAEPMAR001M
		   	( AUD_YR		     /* 감사년도 */
		   	, AUD_NO             /* 감사번호 */
		   	, AUD_STEP_CD        /* 감사단계코드 */
		   	, RPRT_CD            /* 보고서구분코드 */
		   	, REF_DOC_ID         /* 요청문서ID */
		   	, RQS_SEQ            /* 요청순번 */
		   	, DOC_ID	         /* 편집문서ID */
		   	, PRSS_CD            /* 진행상태코드 */
		   	, PRSS_REGI_DT       /* 진행일시 */
		   	, RQS_ID             /* 요청자ID */
		   	<if test="reqFlag eq 'P'.toString()">
				, RQS_USR_ID       /* 개인의 요청일 경우 USR ID INSERT */
		    </if>
		    <if test="reqFlag eq 'G'.toString()">
		   		, RQS_DPT_CD		/* 부서의 요청일 경우 DPT CD INSERT */
		    </if>
		   	, RQS_REGI_DT        /* 요청일시 */
		   	, RCV_REGI_DT        /* 접수일시 */
		   	, RCV_USR_ID         /* 접수자ID */
		   	, RQS_DAY_NUM        /* 요청일수 */  
		   	, ADJ_DAY_NUM        /* 조정일수 */
		   	, RQS_RSN            /* 요청사유 */
		   	, RET_RSN            /* 반려사유 */
		   	, ADJ_DAY_RSN        /* 일수조정사유 */
		   	, APV_RQS_ID         /* 결재요청ID */
			, APV_STA_CD         /* 결재상태코드 */
		   	, DOC_WRT_ID         /* 편집문서작성ID */
		   	, LINK_URL           /* 링크주소 */
			, FRT_USR_ID         /* 최초사용자ID */
			, FNL_USR_ID         /* 최종사용자ID */
			, FNL_DEAL_DPT_CD    /* 최종거래부서코드 */
			, FNL_MNU_ID         /* 최종메뉴ID */
			, FRT_REGI_DH        /* 최초등록일시 */
			, FNL_MDF_DH         /* 최종수정일시 */	
		   	)
	   VALUES
		   	( #{audYr}		          /* 감사년도 */
		   	, #{audNo}                /* 감사번호 */
		   	, NVL(#{audStepCd},'NO')  /* 감사단계코드 */
		   	, #{rprtCd}               /* 보고서구분코드 */
		   	, #{docId}                /* 요청문서ID */
		   	, (SELECT NVL(MAX(A.RQS_SEQ),0) + 1
		   	     FROM TBAEPMAR001M A
		   	    WHERE A.AUD_YR = #{audYr}
		   	      AND A.AUD_NO = #{audNo}
		   	      AND A.AUD_STEP_CD = NVL(#{audStepCd},'NO')
		   	      AND A.RPRT_CD = #{rprtCd}
		   	      AND A.REF_DOC_ID = #{docId} ) /* 요청순번 */
		   	, NULL	              /* 편집문서ID */
		   	, '10'                /* 진행상태코드 */
		   	, NULL                /* 진행일시 */
		   	, #{usrId}            /* 요청자ID */
		   	<if test="reqFlag eq 'P'.toString()">
				,#{usrId}
			</if>
			<if test="reqFlag eq 'G'.toString()">
				,#{dptCd}
			</if>
		   	, SYSDATE             /* 요청일시 */
		   	, NULL                /* 접수일시 */
		   	, NULL                /* 접수자ID */
		   	, #{rqsDayNum}        /* 요청일수 */  
		   	, NULL                /* 조정일수 */
		   	, #{rqsRsn}           /* 요청사유 */
		   	, NULL                /* 반려사유 */
		   	, NULL                /* 일수조정사유 */
		   	, NULL                /* 결재요청ID */
			, '10'                /* 결재상태코드 */
		   	, NULL                /* 편집문서작성ID */
		   	, NULL                /* 링크주소 */
			, #{usrId}            /* 최초사용자ID */
			, #{usrId}            /* 최종사용자ID */
			, #{dptCd}            /* 최종거래부서코드 */
			, NVL(#{menuNo},'NVL')           /* 최종메뉴ID */
			, SYSDATE             /* 최초등록일시 */
			, SYSDATE             /* 최종수정일시 */	
		   	)
	</insert>
	
	<insert id="insertReadRqs2">
       /*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.insertReadRqs2*/
	   INSERT 
	     INTO TBAEPMAR001M
		   	( AUD_YR		     /* 감사년도 */
		   	, AUD_NO             /* 감사번호 */
		   	, AUD_STEP_CD        /* 감사단계코드 */
		   	, RPRT_CD            /* 보고서구분코드 */
		   	, REF_DOC_ID         /* 요청문서ID */
		   	, RQS_SEQ            /* 요청순번 */
		   	, DOC_ID	         /* 편집문서ID */
		   	, PRSS_CD            /* 진행상태코드 */
		   	, PRSS_REGI_DT       /* 진행일시 */
		   	, RQS_ID             /* 요청자ID */
		   	<if test="reqFlag eq 'P'.toString()">
				, RQS_USR_ID       /* 개인의 요청일 경우 USR ID INSERT */
		    </if>
		    <if test="reqFlag eq 'G'.toString()">
		   		, RQS_DPT_CD		/* 부서의 요청일 경우 DPT CD INSERT */
		    </if>
		   	, RQS_REGI_DT        /* 요청일시 */
		   	, RCV_REGI_DT        /* 접수일시 */
		   	, RCV_USR_ID         /* 접수자ID */
		   	, RQS_DAY_NUM        /* 요청일수 */  
		   	, ADJ_DAY_NUM        /* 조정일수 */
		   	, RQS_RSN            /* 요청사유 */
		   	, RET_RSN            /* 반려사유 */
		   	, ADJ_DAY_RSN        /* 일수조정사유 */
		   	, APV_RQS_ID         /* 결재요청ID */
			, APV_STA_CD         /* 결재상태코드 */
		   	, DOC_WRT_ID         /* 편집문서작성ID */
		   	, LINK_URL           /* 링크주소 */
			, FRT_USR_ID         /* 최초사용자ID */
			, FNL_USR_ID         /* 최종사용자ID */
			, FNL_DEAL_DPT_CD    /* 최종거래부서코드 */
			, FNL_MNU_ID         /* 최종메뉴ID */
			, FRT_REGI_DH        /* 최초등록일시 */
			, FNL_MDF_DH         /* 최종수정일시 */	
		   	)
<![CDATA[
			 SELECT A.AUD_YR
			      , A.AUD_NO
                  , A.AUD_STEP_CD
                  , A.RPRT_CD
                  , A.DOC_ID
                  , (SELECT NVL(MAX(B.RQS_SEQ),0) + 1
                         FROM TBAEPMAR001M B
                        WHERE B.AUD_YR = A.AUD_YR
                          AND B.AUD_NO = A.AUD_NO
                          AND B.AUD_STEP_CD = A.AUD_STEP_CD
                          AND B.RPRT_CD = A.RPRT_CD
                          AND B.REF_DOC_ID = A.DOC_ID) /* 요청순번 */
                  , NULL
                  , '10'
                  , NULL 
                  , #{usrId}
                  ]]>
                  <if test="reqFlag eq 'P'.toString()">
						,#{usrId}
				  </if>
				  <if test="reqFlag eq 'G'.toString()">
				  		,#{dptCd}
				  </if>
<![CDATA[
                  , SYSDATE
                  , NULL
                  , NULL
                  , #{rqsDayNum}
                  , NULL
                  , #{rqsRsn}
                  , NULL
                  , NULL
                  , NULL
                  , '10'
                  , NULL
                  , NULL
                  , #{usrId}
                  , #{usrId}
                  , #{dptCd}
                  , NVL(#{menuNo},'NVL')
                  , SYSDATE
                  , SYSDATE                  
			    FROM TBBADDED103M A
	           INNER JOIN 
	                 TBBADDED001M B
			  	  ON A.AUD_YR = B.AUD_YR
			     AND A.AUD_NO = B.AUD_NO		  
			   WHERE A.AUD_YR = #{audYr}
			     AND A.AUD_NO =  #{audNo}
			     AND A.RPRT_CD IN (SELECT AA.CD
			                         FROM TBDCMACM013C AA
			                        WHERE AA.CMM_CD_DVSN_CD = '1000786'
			                          AND AA.USR_DFN_TXT_3 = 'Y'
			                          AND USE_YN = 'Y' ) /*감사실시계획서, 감사보고서, 실지감사 종료보고서 'A10300100','A10500200','A10600200'*/
			     AND ((A.RPRT_CD = 'A10600200' AND A.AUD_STEP_CD = 'A1070'  ) OR 
			          (A.RPRT_CD != 'A10600200' AND A.APV_STA_CD = '30' ) )
		       ORDER BY 
		             A.RPRT_CD 
		]]>
	</insert>
	
	<update id="updateReadRqsCancel">
       /*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.updateReadRqsCancel*/
	   UPDATE TBAEPMAR001M  
	      SET PRSS_CD        = '20'                     /* 진행상태코드 ( 20 = 요청취소 ) */
	        , FNL_USR_ID      = #{usrId}                /* 최종사용자ID */ 
		    , FNL_DEAL_DPT_CD = #{dptCd}                /* 최종거래부서코드 */
			, FNL_MNU_ID      = NVL(#{menuNo},'NVL')    /* 최종메뉴ID */
			, FNL_MDF_DH      = SYSDATE                 /* 최종수정일시 */	
		WHERE AUD_YR		  = #{audYr}       /* 감사년도 */
		  AND AUD_NO          = #{audNo}       /* 감사번호 */
		  AND AUD_STEP_CD     = #{audStepCd}   /* 감사단계코드 */
		  AND RPRT_CD         = #{rprtCd}      /* 보고서구분코드 */
		  AND REF_DOC_ID      = #{refDocId}    /* 요청문서ID */
		  AND RQS_SEQ         = #{rqsSeq}      /* 요청순번 */ 
		   	
	</update>
	
	<select id="selectRqsStatsList" parameterType="paramMap" resultType="egovMap">
       /*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.selectRqsStatsList*/
        <include refid="include.pageSelct" />
            <![CDATA[
           SELECT A.AUD_YR                                            /* 감사년도 */
			     , A.AUD_NO                                            /* 감사번호 */
			     , A.AUD_STEP_CD                                       /* 감사단계코드 */
			     , A.RPRT_CD                                           /* 보고서구분코드 */
			     , A.REF_DOC_ID                                        /* 요청문서ID */
			     , A.RQS_SEQ                                           /* 요청순번 */
			     , TO_CHAR(A.RQS_REGI_DT,'yyyy.MM.dd') AS RQS_REGI_DT  /* 요청일시(요청일자)*/
			     , A.RQS_ID                                            /* 요청자ID */
			     , F_USR_INFO_BY_ID(A.RQS_ID,'2')      AS RQS_NM       /* 요청자성명 */
			     , A.PRSS_CD                                           /* 진행상태코드 (요청상태) */
			     , F_CODE_NM('1000902',A.PRSS_CD)      AS PRSS_NM      /* 진행상태명(요청상태)*/
			     , DECODE(A.APV_STA_CD,30,TO_CHAR(D.APV_DH,'yyyy.MM.dd'),'')   AS APV_DT       /* 관리부서처리일자 */
			     , A.RCV_USR_ID                                        /* 접수자ID */
			     , F_USR_INFO_BY_ID(A.RCV_USR_ID,'2')  AS RCV_USR_NM   /* 접수자성명 */
			     , F_MNG_KND_AUDYRNO(B.AUD_YR, B.AUD_NO, B.AUD_KND_CD, '-') AS AUD_YR_N0   /* 분류번호 */
			     , B.AUD_SBJ_NM                                        /* 감사사항명 */
			     , B.MNG_DPT_CD                                        /* 관리부서 */                                       
			     , F_DPT_INFO(B.MNG_DPT_CD,'1')        AS MNG_DPT_NM   /* 관리부서명 */
 			     , F_CODE_NM('1000786',C.RPRT_CD)      AS AUD_DOC_NM   /* 보고서구분명 */
			     , C.RPRT_NM                                           /* 보고서명 */
			     , A.RQS_DAY_NUM                                       /* 요청일수(열람요청일수) */
			     , A.RQS_RSN                                           /* 요청사유 */
			  FROM TBAEPMAR001M A
			 INNER JOIN
			       TBBADDED001M B
			    ON B.AUD_YR = A.AUD_YR
			   AND B.AUD_NO = A.AUD_NO
			 INNER JOIN
			       (SELECT AA.AUD_YR
			             , AA.AUD_NO
			             , AA.AUD_STEP_CD
			             , AA.DOC_ID
			             , AA.RPRT_CD
			             , AA.RPRT_NM
			          FROM TBBADDED103M AA
			         UNION ALL 
			        SELECT BB.AUD_YR
			             , BB.AUD_NO
			             , 'NO'
			             , BB.DOC_ID
			             , DECODE(BB.DOC_TYP_CD,'AD-AR-002','A10300100','AD-AR-003','A10600200','AD-AR-001','A10500200')   AS RPRT_CD /* 감사실시계획서, 감사보고서, 실지감사 종료보고서 'A10300100','A10500200','A10600200' */
			             , CC.FILE_NAME    AS RPRT_NM
			          FROM TBBADDED021M BB  
			         INNER JOIN
			               ECM_FILE_LIST_VIEW2 CC
			            ON CC.DOC_ID = BB.DOC_ID
			        ) C
			    ON C.AUD_YR = A.AUD_YR
			   AND C.AUD_NO = A.AUD_NO
			   AND C.AUD_STEP_CD = A.AUD_STEP_CD
			   AND C.DOC_ID = A.REF_DOC_ID
			  LEFT OUTER JOIN
			      (SELECT AA.APV_DOC_NO
			            , MAX(AA.APV_DH) AS APV_DH
                     FROM TBDCMACM023L AA
                    GROUP BY 
                          AA.APV_DOC_NO ) D
                ON D.APV_DOC_NO =  A.APV_RQS_ID
			 WHERE 1=1
			  ]]>
			 
            /* 분류번호 (번호) */
			 <if test="schAudYr2 != null and schAudYr2 != ''">
                    AND B.AUD_YR  = #{schAudYr2}
            </if>
            /* 분류번호 (감사구분) */
            <if test="schAudYrNoKndCd2 != null and schAudYrNoKndCd2 != ''">
                    AND B.AUD_KND_CD = #{schAudYrNoKndCd2}
            </if>
            /* 분류번호 (일련번호) */
            <if test="schAudNo2 != null and schAudNo2 != ''">
                    AND B.AUD_GRN_NO = #{schAudNo2}
            </if>
            /* 감사사항명 */
            <if test="schAudSbjNm2 != null and schAudSbjNm2 != ''">
                    AND B.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm2}||'%'
            </if>
             /* 관리부서 (상위) */
			<if test="schSpvBrdvCd2 != null and schSpvBrdvCd2 != ''">
                    AND (SELECT D4.HIRK_DPT_CD 
                           FROM TBDCMACM002M D4 
                          WHERE D4.DPT_CD  = B.MNG_DPT_CD 
                            AND D4.USE_YN = 'Y') = #{schSpvBrdvCd2} 
            </if>
            /* 관리부서  */
            <if test="schDeptCd2 != null and schDeptCd2 != ''">
                    AND B.MNG_DPT_CD = #{schDeptCd2}
            </if>
            /* 보고서 종류 */
            <if test="schRprtCd2 != null and schRprtCd2 != ''">
                    AND C.RPRT_CD = #{schRprtCd2}
            </if>
            /* 요청진행상태 */
            <if test="schPrssCd2 != null and schPrssCd2 != ''">
                    AND A.PRSS_CD = #{schPrssCd2}
            </if>
            AND EXISTS (SELECT 'X'
                          FROM TBAEPMAR001M AA 
                             , TBDCMACM001M BB
                         WHERE AA.AUD_YR = A.AUD_YR
                           AND AA.AUD_NO = A.AUD_NO
                           AND AA.AUD_STEP_CD = A.AUD_STEP_CD
                           AND AA.RPRT_CD = A.RPRT_CD
                           AND AA.REF_DOC_ID = A.REF_DOC_ID
                           AND AA.RQS_SEQ = A.RQS_SEQ
                           AND AA.RQS_ID = BB.USR_ID
         <if test='MaintenanceRoleYn != "Y" '>
              <if test="dptCd != null and dptCd != '' ">
                           AND BB.DPT_CD = #{dptCd} 
               </if>
         </if>
                           )
             <![CDATA[
			 ORDER BY
			       A.PRSS_CD
			     , A.RQS_REGI_DT
            ]]>
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectRqsOrRetRsnInfo" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.selectRqsOrRetRsnInfo*/
        <![CDATA[
			SELECT B.AUD_SBJ_NM                                        /* 감사사항명 */
			     , B.MNG_DPT_CD                                        /* 관리부서 */                                       
				 , F_DPT_INFO(B.MNG_DPT_CD,'1')        AS MNG_DPT_NM   /* 관리부서명 */
				 , (CASE WHEN #{popFlag} = 'RET' THEN (SELECT F_DPT_INFO(AA.DPT_CD,'1') || ' ' || NVL(F_CODE_NM('1000176',AA.PST_CD),F_CODE_NM('1000173',AA.RANK_CD)) || ' ' || AA.USR_NAM
				                                         FROM TBDCMACM001M AA
				                                        WHERE AA.USR_ID = A.RCV_USR_ID ) /* 처리자 */
				                                 ELSE (SELECT F_DPT_INFO(AA.DPT_CD,'1') || ' ' || NVL(F_CODE_NM('1000176',AA.PST_CD),F_CODE_NM('1000173',AA.RANK_CD)) || ' ' || AA.USR_NAM
				                                         FROM TBDCMACM001M AA
				                                        WHERE AA.USR_ID = A.RQS_ID ) /* 요청자 */
				     END)                              AS USR_NM       /* 요청자,처리자 */
				 , C.RPRT_NM                                           /* 보고서명 */
				 , (CASE WHEN #{popFlag} = 'RET' THEN A.RET_RSN
				                                 ELSE A.RQS_RSN
				     END)                              AS RSN      /* 요청사유,반려사유 */
			  FROM TBAEPMAR001M A
			 INNER JOIN
				   TBBADDED001M B
			    ON B.AUD_YR = A.AUD_YR
			   AND B.AUD_NO = A.AUD_NO
			 INNER JOIN
				   (SELECT AA.AUD_YR
			             , AA.AUD_NO
			             , AA.AUD_STEP_CD
			             , AA.DOC_ID
			             , AA.RPRT_CD
			             , AA.RPRT_NM
			          FROM TBBADDED103M AA
			         UNION ALL 
			        SELECT BB.AUD_YR
			             , BB.AUD_NO
			             , 'NO'
			             , BB.DOC_ID
			             , DECODE(BB.DOC_TYP_CD,'AD-AR-002','A10300100','AD-AR-003','A10600200','AD-AR-001','A10500200')   AS RPRT_CD /* 감사실시계획서, 감사보고서, 실지감사 종료보고서 'A10300100','A10500200','A10600200' */
			             , CC.FILE_NAME    AS RPRT_NM
			          FROM TBBADDED021M BB  
			         INNER JOIN
			               ECM_FILE_LIST_VIEW2 CC
			            ON CC.DOC_ID = BB.DOC_ID
			        ) C
			    ON C.AUD_YR = A.AUD_YR
			   AND C.AUD_NO = A.AUD_NO
			   AND C.AUD_STEP_CD = A.AUD_STEP_CD
			   AND C.DOC_ID = A.REF_DOC_ID
			 WHERE A.AUD_YR = #{audYr}
			   AND A.AUD_NO = #{audNo}
			   AND A.AUD_STEP_CD = #{audStepCd}
			   AND A.RPRT_CD = #{rprtCd}
			   AND A.REF_DOC_ID = #{refDocId}
			   AND RQS_SEQ = #{rqsSeq}
        ]]>
    </select>
    
    <select id="selectOpenList" parameterType="paramMap" resultType="egovMap">
       /*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.selectOpenList*/
        <include refid="include.pageSelct" />
            <![CDATA[
            SELECT A.AUD_YR                                            /* 감사년도 */
			     , A.AUD_NO                                            /* 감사번호 */
			     , A.AUD_STEP_CD                                       /* 감사단계코드 */
			     , A.RPRT_CD                                           /* 보고서구분코드 */
			     , A.REF_DOC_ID                                        /* 요청문서ID */
			     , A.RQS_SEQ                                           /* 요청순번 */
			     , A.DOC_ID	                                           /* 편집문서ID */
			     , TO_CHAR(A.RQS_REGI_DT,'yyyy.MM.dd') AS RQS_REGI_DT  /* 요청일시(요청일자)*/
			     , CASE WHEN A.READ_COFM_DH IS NOT NULL THEN TO_CHAR(A.READ_COFM_DH,'yyyy.MM.dd')  
                        ELSE TO_CHAR(D.APV_DH,'yyyy.MM.dd')   
                     END      AS APV_DT       /* 처리일자 */ 
                 , F_MNG_KND_AUDYRNO(B.AUD_YR, B.AUD_NO, B.AUD_KND_CD, '-') AS AUD_YR_N0   /* 분류번호 */
                 , B.AUD_SBJ_NM                                        /* 감사사항명 */
                 , B.MNG_DPT_CD                                        /* 관리부서 */                                       
			     , F_DPT_INFO(B.MNG_DPT_CD,'1')        AS MNG_DPT_NM   /* 관리부서명 */
			     , F_CODE_NM('1000786',A.RPRT_CD)      AS AUD_DOC_NM   /* 보고서구분명 */
			     , C.RPRT_NM || ' (열람용)'               AS RPRT_NM      /* 보고서명 */
			     , CASE WHEN A.READ_COFM_DH IS NOT NULL THEN TO_CHAR(A.READ_COFM_DH,'yyyy.MM.dd') || ' ~ ' || TO_CHAR(A.READ_COFM_DH + A.ADJ_DAY_NUM - 1,'yyyy.MM.dd')
                        ELSE                                 TO_CHAR(D.APV_DH,'yyyy.MM.dd')       || ' ~ ' || TO_CHAR(D.APV_DH + A.ADJ_DAY_NUM - 1,'yyyy.MM.dd')  
                    END                                AS OPEN_DT      /* 열람기간 */         			     
			     , A.ADJ_DAY_NUM                                       /* 열람일수 */
			     , DECODE(A.RQS_DAY_NUM,A.ADJ_DAY_NUM,'N','Y')  AS ADJ_DAY_YN    /* 열람일자 조정여부 */
			     , CASE WHEN A.READ_COFM_DH IS NOT NULL THEN TRUNC(A.READ_COFM_DH + A.ADJ_DAY_NUM) - TRUNC(SYSDATE)  
                        ELSE                                 TRUNC(D.APV_DH       + A.ADJ_DAY_NUM) - TRUNC(SYSDATE)  
                    END               AS OPEN_DAY_NUM  /* 열람가능일수 */
			     , F_OPEN_EDIT(A.LINK_URL)             AS DOC_TYPE     /* 편집기구분 */ 
			     , B.AUD_KND_CD                                        /* 감사종류코드 */
			  FROM TBAEPMAR001M A
			 INNER JOIN
			       TBBADDED001M B
			    ON B.AUD_YR = A.AUD_YR
			   AND B.AUD_NO = A.AUD_NO
			 INNER JOIN
			       (SELECT AA.AUD_YR
			             , AA.AUD_NO
			             , AA.AUD_STEP_CD
			             , AA.DOC_ID
			             , AA.RPRT_CD
			             , AA.RPRT_NM
			          FROM TBBADDED103M AA
			         UNION ALL 
			        SELECT BB.AUD_YR
			             , BB.AUD_NO
			             , 'NO'
			             , BB.DOC_ID
			             , DECODE(BB.DOC_TYP_CD,'AD-AR-002','A10300100','AD-AR-003','A10600200','AD-AR-001','A10500200')   AS RPRT_CD /* 감사실시계획서, 감사보고서, 실지감사 종료보고서 'A10300100','A10500200','A10600200' */
			             , CC.FILE_NAME    AS RPRT_NM
			          FROM TBBADDED021M BB  
			         INNER JOIN
			               ECM_FILE_LIST_VIEW2 CC
			            ON CC.DOC_ID = BB.DOC_ID
			        ) C
			    ON C.AUD_YR = A.AUD_YR
			   AND C.AUD_NO = A.AUD_NO
			   AND C.AUD_STEP_CD = A.AUD_STEP_CD
			   AND C.DOC_ID = A.REF_DOC_ID
			 LEFT OUTER JOIN
			      (SELECT AA.APV_DOC_NO
			            , MAX(AA.APV_DH) AS APV_DH
                     FROM TBDCMACM023L AA
                    GROUP BY 
                          AA.APV_DOC_NO ) D
                ON D.APV_DOC_NO =  A.APV_RQS_ID
			 WHERE A.APV_STA_CD = '30' /* 결제 완료된 목록만 조회 */
			  ]]>
		     /* 분류번호 (번호) */
			 <if test="schAudYr3 != null and schAudYr3 != ''">
                    AND B.AUD_YR  = #{schAudYr3}
            </if>
            /* 분류번호 (감사구분) */
            <if test="schAudYrNoKndCd3 != null and schAudYrNoKndCd3 != ''">
                    AND B.AUD_KND_CD = #{schAudYrNoKndCd3}
            </if>
            /* 분류번호 (일련번호) */
            <if test="schAudNo3 != null and schAudNo3 != ''">
                    AND B.AUD_GRN_NO = #{schAudNo3}
            </if>
            /* 감사사항명 */
            <if test="schAudSbjNm3 != null and schAudSbjNm3 != ''">
                    AND B.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm3}||'%'
            </if>
             /* 관리부서 (상위) */
			<if test="schSpvBrdvCd3 != null and schSpvBrdvCd3 != ''">
                    AND (SELECT D4.HIRK_DPT_CD 
                           FROM TBDCMACM002M D4 
                          WHERE D4.DPT_CD  = B.MNG_DPT_CD 
                            AND D4.USE_YN = 'Y') = #{schSpvBrdvCd3} 
            </if>
            /* 관리부서  */
            <if test="schDeptCd3 != null and schDeptCd3 != ''">
                    AND B.MNG_DPT_CD = #{schDeptCd3}
            </if>
            /* 보고서 종류 */
            <if test="schRprtCd3 != null and schRprtCd3 != ''">
                    AND C.RPRT_CD = #{schRprtCd3}
            </if>
            /* 열람가능상태  */
            
            <if test="schOpenYn3 != null and schOpenYn3 != ''">
            <![CDATA[  AND (( #{schOpenYn3} = 'Y' AND TRUNC(D.APV_DH + A.ADJ_DAY_NUM) > TRUNC(SYSDATE) ) OR
                            ( #{schOpenYn3} = 'N' AND TRUNC(D.APV_DH + A.ADJ_DAY_NUM) <= TRUNC(SYSDATE) ))   ]]>
            </if>
           <if test='MaintenanceRoleYn != "Y" '>  
            AND (A.RQS_DPT_CD = #{dptCd}
            
            OR A.RQS_USR_ID = #{usrId})
            </if>
             <![CDATA[
			 ORDER BY
			       A.PRSS_CD
			     , A.RQS_REGI_DT
            ]]>
        <include refid="include.pageOrder" />
    </select>
    
    <insert id="sendAdjMngDptMsg">
        /* kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.sendAdjMngDptMsg */
    <![CDATA[
		 INSERT INTO TBDCMACM026L
		            (
			              MSG_SNO
			            , TSK_CAT_CD
			            , FUNC_CAT_CD
			            , SEND_ID
			            , MSG_TP_YN
			            , MSG_TXT_2
			            , RCNT_CNT
			            , RCNT_HIS
			            , MSG_REGI_DH
			            , FRT_USR_ID
			            , FNL_USR_ID
			            , FNL_DEAL_DPT_CD
			            , FNL_MNU_ID
			            , FRT_REGI_DH
			            , FNL_MDF_DH    
		            )
			VALUES
		            (
			              (SELECT NVL(MAX(MSG_SNO),'0')+1 AS MSG_SNO FROM TBDCMACM026L)
			            , 'CM'
			            , 'CM'
			            , 'OASYS'
			            , '0'
			            , #{sendMsg}
			            , (SELECT COUNT(*) FROM TBDCMACM001M WHERE DPT_CD = #{mngDptCd} AND INN_RANK_CD = '30') /* 내부직급코드로 변경 - 2021.04.21 yyh */
			            , (SELECT AGGR_CONCAT(CNB, '') FROM TBDCMACM001M WHERE DPT_CD = #{mngDptCd} AND INN_RANK_CD = '30')  /* 해당부서 과장에게 전송. 내부직급코드로 변경 - 2021.04.21 yyh */
			            , SYSDATE 
			            , #{usrId}
			            , #{usrId}
			            , #{dptCd}
			            , 'AEPMAR006E'
			            , SYSDATE
			            , SYSDATE 
		            )
        ]]>
    </insert>	
    
    <select id="selectRqsUsrInfo" parameterType="paramMap" resultType="egovMap">
       /*kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.selectRqsUsrInfo*/
       SELECT F_DPT_INFO(AA.DPT_CD,'1') || ' ' || F_CODE_NM('1000173',AA.RANK_CD) || ' ' || AA.USR_NAM || ' 감사관' || DECODE(AA.PST_CD,NULL,'','('||F_CODE_NM('1000176',AA.PST_CD)||')') AS USR_INFO
	     FROM TBDCMACM001M AA
    	WHERE AA.USR_ID = #{usrId}
    </select>
    
    
    <select id="selectMsgUsr" parameterType="paramMap" resultType="egovMap">
    	<![CDATA[
    		SELECT A.CNB        /* 전산번호 */
			      ,A.USR_ID     /* 사용자ID */
			  FROM (
			     SELECT CASE WHEN A.USR_ID = 'sil08' THEN '3283' 
			                 ELSE A.CNB
			             END                                         AS CNB      
			           ,USR_ID                                       AS USR_ID   
			           ,USR_NAM                                      AS USR_NAM  
			           ,DPT_CD                                       AS DPT_CD   
			           ,F_DPT_INFO(DPT_CD, '1')                      AS DPT_NM        
			           ,RANK_CD                                      AS RANK_CD 
			           ,CASE WHEN CNB = '8883' THEN '1' 
			                 ELSE 
			                     (SELECT USR_DFN_TXT_1
			                        FROM TBDCMACM013C
			                       WHERE CMM_CD_DVSN_CD = '1000338'
			                         AND CD = A.USR_DVSN_CD) 
			             END                                         AS OCP_CD 
			           ,CASE WHEN CNB = '2560' THEN '20180226'
			                 ELSE CRNT_RANK_APM_DT
			             END                                         AS CRNT_RANK_APM_DT
			                    
			           ,SRT_KY_NO     
			           ,RANK_SRT_SEQ_NM
			           ,NVL(CRNT_DPT_APM_DT, WRK_STR_DT)             AS CRNT_DPT_APM_DT 
			           ,SUBSTR(EIN, 1, 6)                            AS EIN 
			      FROM TBDCMACM001M A 
			     WHERE A.RANK_CD = '015'
			       AND ( 
			               (USR_DVSN_CD = '1' AND CNB < '5000' AND RQS_STA_CD ='3')
			            OR (USR_DVSN_CD = '2' AND CNB LIKE '8%' AND RQS_STA_CD ='3') 
			            OR (USR_DVSN_CD = '3' AND CNB LIKE '9%' AND RQS_STA_CD ='3') 
			            OR ( 
			                  (USR_DVSN_CD = '4'  AND CNB LIKE '9%' AND RQS_STA_CD ='3')
			                  AND
			                  (SELECT USE_YN
			                     FROM TBDCMACM002M
			                    WHERE DPT_CD = A.DPT_CD) = 'Y'
			               ) 
			           )            
			    ORDER BY OCP_CD
			            ,NVL(INN_RANK_CD, '50') ASC 
			            ,RANK_SRT_SEQ_NM
			            ,CRNT_RANK_APM_DT
			            ,SRT_KY_NO
			            ,CRNT_DPT_APM_DT
			            ,EIN
			) A
			WHERE A.DPT_CD = #{mngDptCd}
			  AND ROWNUM = 1
    	]]>
    </select>
	
	
	<insert id="sendAdjMngDptMsg2">
        /* kr.go.bai.eip.aep.mar.dao.AEPMAR006EMapper.sendAdjMngDptMsg2 */
    <![CDATA[
		 INSERT INTO TBDCMACM026L
		            (
			              MSG_SNO
			            , TSK_CAT_CD
			            , FUNC_CAT_CD
			            , SEND_ID
			            , MSG_TP_YN
			            , MSG_TXT_2
			            , RCNT_CNT
			            , RCNT_HIS
			            , MSG_REGI_DH
			            , FRT_USR_ID
			            , FNL_USR_ID
			            , FNL_DEAL_DPT_CD
			            , FNL_MNU_ID
			            , FRT_REGI_DH
			            , FNL_MDF_DH    
		            )
			VALUES
		            (
			              (SELECT NVL(MAX(MSG_SNO),'0')+1 AS MSG_SNO FROM TBDCMACM026L)
			            , 'CM'
			            , 'CM'
			            , 'OASYS'
			            , '0'
			            , #{sendMsg}
			            , 1
			            , #{msgCnb}
			            , SYSDATE 
			            , #{usrId}
			            , #{usrId}
			            , #{dptCd}
			            , 'AEPMAR006E'
			            , SYSDATE
			            , SYSDATE 
		            )
        ]]>
    </insert>
</mapper> 