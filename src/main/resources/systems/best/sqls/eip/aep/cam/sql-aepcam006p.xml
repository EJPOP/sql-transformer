<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.cam.dao.AEPCAM006PMapper">
    
    <select id="selectMainDetail" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM006PMapper.selectMainDetail*/
         SELECT D.AUD_YR,
                F_CODE_NM('1000739', D1.AUD_KND_CD) AS AUD_KND_NM,
                D.AUD_KND_CD,
                D.AUD_NO,
                D.AUD_GRN_NO,
                D.AUD_SBJ_NM,
                D.AUD_YR AS AUD_YR2,
                F_CODE_NM('1000739', D.AUD_KND_CD) AS AUD_KND_NM2,
                D.AUD_GRN_NO AS AUD_GRN_NO2,
                B.AFF_CD,
                B.TITLE_NM,
                F_ORG_INFO(A.RLTN_ORG_CD, 1) AS RLTN_ORG_NM,
                TO_CHAR(TO_DATE(A.SMT_DT),'YYYY-MM-DD') AS SMT_DT,
                A.PRSR,
                TO_CHAR(A.FRT_REGI_DH,'YYYY-MM-DD') AS FRT_REGI_DH,
                A.SRNO,
                A.AFF_SNO
           FROM TBCSPKDE103M AS A 
     INNER JOIN TBBADDED001M AS D ON D.AUD_YR  = A.AUD_YR
                                 AND D.AUD_NO  = A.AUD_NO
LEFT OUTER JOIN TBBADDED145M AS B ON A.AUD_YR  = B.AUD_YR
                                 AND A.AUD_NO  = B.AUD_NO
                                 AND A.AFF_SNO = B.AFF_SNO
          WHERE A.AUD_YR  = #{audYr}
            AND A.AUD_NO  = #{audNo}
            AND A.SRNO    = #{srno}
            AND A.AFF_SNO = #{affSno}
    </select>
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM006PMapper.selectMainList*/
        <include refid="include.pageSelct" />
         <![CDATA[
            SELECT B.FILE_NM,
                   CASE NVL(C.SR_DOC_SNO, 0) WHEN 0 THEN '미발신' ELSE '발신' END AS SEND_YN_NM,
                   CASE NVL(C.SR_DOC_SNO, 0) WHEN 0 THEN 'N' ELSE 'Y' END AS SEND_YN,
                   F_DPT_INFO(D.MNG_DPT_CD, '1') AS MNG_DPT_NM,
                   C.SNDR_ID,
                   TO_CHAR(C.SND_DH,'YYYY-MM-DD') AS SND_DH,
                   D.AUD_YR,
                   D.AUD_NO,
                   A.AUD_STEP_CD,
                   B.DOC_ID,
                   D.AUD_KND_CD,
                   D.AUD_GRN_NO,
                   A.SRNO,
                   D.MNG_DPT_CD,
                   D.SPVR_CNB
              FROM TBCSPKDE103M AS A
        INNER JOIN TBCSPKDE104M AS B ON A.AUD_YR  = B.AUD_YR
                                    AND A.AUD_NO  = B.AUD_NO
                                    AND A.SRNO    = B.SRNO
        INNER JOIN TBBADDED001M AS D ON D.AUD_YR  = A.AUD_YR
                                    AND D.AUD_NO  = A.AUD_NO
   LEFT OUTER JOIN TBBADDED111M AS C ON A.AUD_YR  = C.AUD_YR
                                    AND A.AUD_NO  = C.AUD_NO
                                    AND A.SRNO    = C.REF_ID
                                    AND B.DOC_ID  = C.DOC_ID
                                    AND C.RCPT_DPT_CD <> '160201'
             WHERE 1=1
               AND D.AUD_YR = #{audYr}
               AND D.AUD_KND_CD = #{audKndCd}
               AND D.AUD_NO = #{audNo}
               AND A.SRNO    = #{srno}
               AND A.AFF_SNO = #{affSno}
               ]]>
        <include refid="include.pageOrder" />
    </select>
    
    <insert id="insertBADDED111M" parameterType="paramMap">
        INSERT INTO TBBADDED111M(AUD_YR             /*감사년도*/
                                ,AUD_NO             /*감사번호*/
                                ,AUD_STEP_CD        /*감사단계코드*/
                                ,DOC_ID             /*문서ID*/
                                ,SR_DOC_SNO         /*송수신문서순번*/
                                ,AUD_KND_CD         /*감사종류코드*/
                                ,AUD_GRN_NO         /*감사부여번호*/
                                ,RPRT_NM            /*보고서명*/
                                ,DOC_STA_CD         /*문서상태코드*/
                                ,SND_DPT_CD         /*송신부서코드*/
                                ,SNDR_ID            /*송신자ID*/
                                ,SND_DH             /*송신일시*/
                                ,RCPT_DPT_CD        /*수신부서코드*/
                                ,RCNT_ID            /*수신자ID*/
                                ,RCPT_DH            /*수신일시*/
                                ,DOC_KND_CD         /*문서구분코드*/
                                ,REF_ID
                                ,FRT_USR_ID         /*최초사용자ID*/
                                ,FNL_USR_ID         /*최종사용자ID*/
                                ,FNL_DEAL_DPT_CD    /*최종거래부서코드*/
                                ,FNL_MNU_ID         /*최종메뉴ID*/
                                ,FRT_REGI_DH        /*최초등록일시*/
                                ,FNL_MDF_DH         /*최종수정일시*/ )
                          vALUES(#{audYr}
                                ,#{audNo}
                                ,#{audStepCd}
                                ,#{docId}
                                ,(SELECT NVL(MAX(SR_DOC_SNO),0)+1 FROM TBBADDED111M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND REF_ID = #{srno})
                                ,#{audKndCd}
                                ,#{audGrnNo}
                                ,#{fileNm}
                                ,'10'
                                ,#{dptCd}
                                ,#{usrId}
                                ,SYSDATE
                                ,#{mngDptCd}
                                ,#{spvrCnb}
                                ,SYSDATE
                                ,'50'
                                ,#{srno}
                                ,#{usrId}
                                ,#{usrId}
                                ,#{dptCd}
                                ,#{menuNo}
                                ,SYSDATE
                                ,SYSDATE)
    </insert>
    
</mapper> 