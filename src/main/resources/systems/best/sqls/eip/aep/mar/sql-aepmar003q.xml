<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.mar.dao.AEPMAR003QMapper">
		<select id="selectMajorAudDocReqList" parameterType="paramMap" resultType="egovMap">
			<include refid="include.pageSelct" />			
			/*kr.go.bai.eip.aep.mar.dao.AEPMAR003QMapper.selectMajorAudDocReqList*/
			<![CDATA[		
				SELECT F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, B.AUD_KND_CD, '-') AS AUD_YR_NO
						, C.AUD_SBJ_NM
						, F_ORG_INFO(C.AUD_RPST_ORG_CD, '1') AS AUD_RPST_ORG_NM
						, F_DPT_INFO(C.MNG_DPT_CD,'1') AS MNG_DPT_NM
						, F_CODE_NM('1000786',B.RPRT_CD) AS AUD_DOC_NM
						, B.RPRT_NM
					 	, CASE WHEN A.READ_ST_DH IS NOT NULL AND A.READ_END_DH IS NOT NULL THEN TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || ' ~ ' || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
						   	   ELSE TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
					       END AS READ_DH
						, CASE WHEN A.PRSS_CD = '10' THEN '승인대기'
						  	   WHEN A.PRSS_CD = '20' THEN '취소'
						  	   WHEN A.PRSS_CD = '30' THEN '승인'
						  	   WHEN A.PRSS_CD = '40' THEN '반려'
						   END AS PRSS_NM
						, A.RET_RSN
						, A.SRNO
					    , A.PRSS_CD
					    , A.REF_DOC_ID
					    , C.MNG_DPT_CD
					    , A.DOC_ID
					    , A.RQS_ID
					 	, TO_CHAR(A.READ_ST_DH,'YYYYMMDD') 		AS READ_ST_DH
					 	, TO_CHAR(A.READ_END_DH,'YYYYMMDD') 		AS READ_END_DH
					    , A.AUD_YR
					    , A.AUD_NO
						, B.RPRT_CD
						, A.RQS_REGI_DT
						, A.APV_STA_CD
						, CASE WHEN A.PRSS_CD = '10' and A.DOC_ID IS NULL THEN 'Y'
							     ELSE 'N'
						   END AS CANCEL_YN	
						, CASE WHEN A.PRSS_CD = '30' and SYSDATE BETWEEN READ_ST_DH AND READ_END_DH THEN 'Y'
							      ELSE 'N'
						  END AS READ_YN		
						, (CASE WHEN B.LINK_URL IS NULL             THEN ''
						      	  WHEN INSTR(B.LINK_URL,'hancom') = 0 THEN 'polaris' 
						      	  ELSE 'hancom' 
						   END ) AS DOC_TYPE								
				      FROM TBAEPMAR001M A 
			  INNER JOIN TBBADDED001M C 
						ON A.AUD_YR = C.AUD_YR 
					   AND A.AUD_NO = C.AUD_NO
		LEFT OUTER JOIN TBBADDED103M B
						ON A.AUD_YR = B.AUD_YR 
					   AND A.AUD_NO = B.AUD_NO
					   AND A.REF_DOC_ID = B.DOC_ID
					   AND A.AUD_STEP_CD = B.AUD_STEP_CD	   
				     WHERE 1=1
				]]>
		           <if test="schAudYr != null and schAudYr != ''">
		                    AND C.AUD_YR  = #{schAudYr}
		           </if>
		           <if test="schAudYrNoKndCd != null and schAudYrNoKndCd != ''">
		                    AND C.AUD_KND_CD = #{schAudYrNoKndCd}
		           </if>
		           <if test="schAudNo != null and schAudNo != ''">
		                    AND B.AUD_GRN_NO = #{schAudNo}
		           </if>
		           <if test="schAudSbjNm != null and schAudSbjNm != ''">
		                    AND C.AUD_SBJ_NM LIKE '%'|| #{schAudSbjNm} || '%'
		           </if>
		           <if test="schDeptCd != null and schDeptCd != ''">
		                    AND C.MNG_DPT_CD = #{schDeptCd}
		           </if>
		           <if test="schRprtNm != null and schRprtNm != ''">
		                    AND B.RPRT_NM LIKE '%' || #{schRprtNm} || '%'
		           </if>
		           <if test="schPrssCd != null and schPrssCd != ''">
		                    AND A.PRSS_CD = #{schPrssCd}
		           </if>
		           <if test="usrId != null and usrId != ''">
		                    AND A.RQS_ID  = #{usrId}
		           </if>
			<![CDATA[		
		UNION ALL /*2017년 이전 데이터*/
				SELECT F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, C.AUD_KND_CD, '-') AS AUD_YR_NO
						, C.AUD_SBJ_NM
						, F_ORG_INFO(C.AUD_RPST_ORG_CD, '1') AS AUD_RPST_ORG_NM
						, F_DPT_INFO(C.MNG_DPT_CD,'1') AS MNG_DPT_NM
						, F_CODE_NM('1000786',D.DOC_TYP_CD) AS AUD_DOC_NM
						, B.FILE_NAME AS RPRT_NM
					 	, CASE WHEN A.READ_ST_DH IS NOT NULL AND A.READ_END_DH IS NOT NULL THEN TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || ' ~ ' || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
						   	   ELSE TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
					       END AS READ_DH
						, CASE WHEN A.PRSS_CD = '10' THEN '승인대기'
						  	   WHEN A.PRSS_CD = '20' THEN '취소'
						  	   WHEN A.PRSS_CD = '30' THEN '승인'
						  	   WHEN A.PRSS_CD = '40' THEN '반려'
						   END AS PRSS_NM
						, A.RET_RSN
						, A.SRNO
					    , A.PRSS_CD
					    , A.REF_DOC_ID
					    , C.MNG_DPT_CD
					    , A.DOC_ID
					    , A.RQS_ID
					 	, TO_CHAR(A.READ_ST_DH,'YYYYMMDD') 		AS READ_ST_DH
					 	, TO_CHAR(A.READ_END_DH,'YYYYMMDD') 		AS READ_END_DH
					    , A.AUD_YR
					    , A.AUD_NO
						, D.DOC_TYP_CD AS RPRT_CD
						, A.RQS_REGI_DT
						, A.APV_STA_CD
						, CASE WHEN A.PRSS_CD = '30' and SYSDATE BETWEEN READ_ST_DH AND READ_END_DH THEN 'Y'
							      ELSE 'N'
						  END AS READ_YN
						, CASE WHEN A.PRSS_CD = '10' and A.DOC_ID IS NULL THEN 'Y'
							     ELSE 'N'
						   END AS CANCEL_YN
						, 'hancom' AS DOC_TYPE
				      FROM TBAEPMAR001M A 
				INNER JOIN UBKERAPP.ECM_FILE_LIST_VIEW2 B
					    ON A.DOC_ID = B.DOC_ID	  
		        INNER JOIN TBBADDED001M C 
						ON A.AUD_YR = C.AUD_YR 
					   AND A.AUD_NO = C.AUD_NO
				INNER JOIN TBBADDED021M	  D
					    ON A.AUD_YR = D.AUD_YR 
					   AND A.AUD_NO = D.AUD_NO 
				     WHERE 1=1
				]]>
		           <if test="schAudYr != null and schAudYr != ''">
		                    AND C.AUD_YR  = #{schAudYr}
		           </if>
		           <if test="schAudYrNoKndCd != null and schAudYrNoKndCd != ''">
		                    AND C.AUD_KND_CD = #{schAudYrNoKndCd}
		           </if>
		           <if test="schAudNo != null and schAudNo != ''">
		                    AND D.AUD_NO = #{schAudNo}
		           </if>
		           <if test="schAudSbjNm != null and schAudSbjNm != ''">
		                    AND C.AUD_SBJ_NM LIKE '%'|| #{schAudSbjNm} || '%'
		           </if>
		           <if test="schDeptCd != null and schDeptCd != ''">
		                    AND C.MNG_DPT_CD = #{schDeptCd}
		           </if>
		           <if test="schRprtNm != null and schRprtNm != ''">
		                    AND B.FILE_NAME LIKE '%' || #{schRprtNm} || '%'
		           </if>
		           <if test="schPrssCd != null and schPrssCd != ''">
		                    AND A.PRSS_CD = #{schPrssCd}
		           </if>
		           <if test="usrId != null and usrId != ''">
		                    AND A.RQS_ID  = #{usrId}
		           </if>  
		   <![CDATA[	                 
		    	ORDER BY A.RQS_REGI_DT DESC
		    ]]>
        <include refid="include.pageOrder" />	    
	</select>

	<select id="selectMaxMltHndlSrno" parameterType="paramMap" resultType="egovMap">			
			/*kr.go.bai.eip.aep.mar.dao.AEPMAR003QMapper.selectMaxMltHndlSrno*/
			SELECT (NVL(MAX(MLT_HNDL_SRNO), 0) + 1) AS MLT_HNDL_SRNO FROM TBAEPMAR001M
	</select>
	
	<update id="saveMajorAudDocReadCancel">
			/*kr.go.bai.eip.aep.mar.dao.AEPMAR003QMapper.saveMajorAudDocReadCancel*/
		   	UPDATE TBAEPMAR001M
		   		SET PRSS_CD = '20'
		   			, MLT_HNDL_SRNO = #{mltHndlSrno}
		   	  WHERE SRNO = #{srno}
		   		AND AUD_YR = #{audYr}
		        AND AUD_NO = #{audNo}
	</update>

	<select id="selectMsgSendTarget" parameterType="paramMap" resultType="egovMap">			
			/*kr.go.bai.eip.aep.mar.dao.AEPMAR003QMapper.selectMsgSendTarget*/
		     SELECT (SELECT CNB
					   FROM TBDCMACM001M
			   	 	  WHERE DPT_CD = B.SPV_BRDV_CD
				 	    AND INN_RANK_CD = '30'
				 	    AND ROWNUM = 1) AS CNB
				  , COUNT(*) AS CNT
		       FROM TBAEPMAR001M A
	LEFT OUTER JOIN TBBADDED001M B
				 ON A.AUD_YR = B.AUD_YR
				AND A.AUD_NO = B.AUD_NO
			  WHERE A.MLT_HNDL_SRNO = #{mltHndlSrno}
		   GROUP BY B.SPV_BRDV_CD
	</select>	
	
   <insert id="sendMajorAudDocCancelMsg">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.sendMajorAudDocCancelMsg */
    <![CDATA[
		 INSERT INTO TBDCMACM026L
		            (
			              MSG_SNO
			            , TSK_CAT_CD
			            , FUNC_CAT_CD
			            , SEND_ID
			            , MSG_TP_YN
			            , MSG_TXT_2
			            , RCNT_CNT
			            , RCNT_HIS
			            , MSG_REGI_DH
			            , FRT_USR_ID
			            , FNL_USR_ID
			            , FNL_DEAL_DPT_CD
			            , FNL_MNU_ID
			            , FRT_REGI_DH
			            , FNL_MDF_DH    
		            )
			VALUES
		            (
			              (SELECT NVL(MAX(MSG_SNO),'0')+1 AS MSG_SNO FROM TBDCMACM026L)
			            , 'CM'
			            , 'CM'
			            , #{sendId}
			            , '0'
			            , #{sendMsg}
			            , #{cnt}
			            , #{rcvMsgCnb}
			            , SYSDATE 
			            , #{usrId}
			            , #{usrId}
			            , #{dptCd}
			            , 'AEPMAR003Q'
			            , SYSDATE
			            , SYSDATE 
		            )
        ]]>
    </insert>		
</mapper> 