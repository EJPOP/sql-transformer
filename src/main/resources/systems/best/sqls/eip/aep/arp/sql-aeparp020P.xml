<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.arp.dao.AEPARP020PMapper">

    <select id="selectOvrOpinExiYn" parameterType="paramMap" resultType="String">
     /* kr.go.bai.eip.aep.arp.dao.AEPARP020PMapper.selectOvrOpinExiYn */
      <![CDATA[
            SELECT CASE WHEN COUNT(*) > 0 THEN 'Y'
                    ELSE 'N'
		           END OVR_OPIN_EXI_YN
		      FROM TBBADDED141M T1
		LEFT OUTER JOIN TBBADDED142D T2 ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO AND T1.AUD_STEP_CD = T2.AUD_STEP_CD AND T1.APVR_CD = T2.APVR_CD AND T1.AFF_SNO = T2.AFF_SNO AND T1.RPRT_FILD_ID = T2.RPRT_FILD_ID AND T2.RPRT_CD = 'A10600530')
		     WHERE T1.AUD_YR = #{audYr}
		       AND T1.AUD_NO = #{audNo}
		       AND T1.AUD_STEP_CD = #{audStepCd}
		       AND T1.APVR_CD IN ('0015800','0035100','0058100','0013900')
		       AND T1.RPRT_FILD_ID = '000000000000000000'
		       AND T1.DOC_ID = #{docId}
		       AND NVL(T1.OPIN_NO_YN, 'N') = 'N'
		       AND EXISTS (SELECT 1 FROM TBBADDED103M B WHERE B.AUD_YR = T2.AUD_YR AND B.AUD_NO = T2.AUD_NO AND B.DOC_ID = T2.DOC_ID AND B.REF_DOC_ID = T1.DOC_ID)

      ]]>
    </select>
      
    <select id="selectOpinBrfInfo" parameterType="paramMap" resultType="egovMap">
    	/* kr.go.bai.eip.aep.arp.dao.AEPARP020PMapper.selectOpinBrfInfo */
    	<![CDATA[
    	SELECT RPRT_NM
    	      ,TITLE_NM_TXT
    	      ,EXAM_CLU_DVSN_NM
    	  FROM (SELECT RPRT_NM
    	              ,TITLE_NM_TXT
    	              ,EXAM_CLU_DVSN_NM
    	              ,AFF_SNO
    	          FROM (
				    	SELECT NVL((SELECT RPRT_NM
			                          FROM TBBADDED103M
			                         WHERE AUD_YR = T1.AUD_YR
		                               AND AUD_NO = T1.AUD_NO
		                               AND DOC_ID = T2.DOC_ID), T2.TITLE_NM_TXT) AS RPRT_NM
				    	     , T2.TITLE_NM_TXT 
			                 , LISTAGG((SELECT T3.CD_NM
			                              FROM TBDCMACM013C T3
			                             WHERE T3.CMM_CD_DVSN_CD = '1001031'
			                               AND T3.CD != '000000000'
			                               AND T3.CD = T2.EXAM_CLU_DVSN_CD), ', ') WITHIN GROUP(ORDER BY T1.AFF_SNO) AS EXAM_CLU_DVSN_NM
			                 , T1.AFF_SNO
			              FROM TBBADDED141M T1
			   LEFT OUTER JOIN TBBADDED142D T2 ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO AND T1.AUD_STEP_CD = T2.AUD_STEP_CD AND T1.APVR_CD = T2.APVR_CD AND T1.AFF_SNO = T2.AFF_SNO AND T1.RPRT_FILD_ID = T2.RPRT_FILD_ID AND T2.RPRT_CD = 'A10600530')
			             WHERE T1.AUD_YR = #{audYr}
						   AND T1.AUD_NO = #{audNo}
			               AND T1.AUD_STEP_CD = #{audStepCd}
			               AND T1.APVR_CD IN ('0015800','0035100','0058100','0013900')
			               AND T1.RPRT_FILD_ID = '000000000000000000'
			               AND T1.DOC_ID = #{docId}
			               AND NVL(T1.OPIN_NO_YN, 'N') = 'N'
			               AND T2.OPIN_BRF_TXT IS NULL
			               AND EXISTS (SELECT 1 FROM TBBADDED103M B WHERE B.AUD_YR = T2.AUD_YR AND B.AUD_NO = T2.AUD_NO AND B.DOC_ID = T2.DOC_ID AND B.REF_DOC_ID = T1.DOC_ID)
			             GROUP BY T1.AUD_YR, T1.AUD_NO, T2.DOC_ID, T2.TITLE_NM_TXT, T1.AFF_SNO
			             ]]>
			             <if test=" 'N' .toString() == ovrOpinExiYn and 'N' .toString() == ovrOpinYn">
		    	               UNION ALL
		                SELECT '감사품질담당관 검토의견 검토보고' AS RPRT_NM
		                     ,'감사품질담당관 종합의견' AS TITLE_NM_TXT
		                     ,'(검토보고서 미작성)' AS EXAM_CLU_DVSN_NM
		                     ,0 AS AFF_SNO
		                  FROM DUAL
		                 </if>
		        <![CDATA[        
    	               )
    	         WHERE ROWNUM = 1
	            UNION ALL
		    	SELECT NVL((SELECT RPRT_NM
	                          FROM TBBADDED103M
	                         WHERE DOC_ID = T3.DOC_ID), T1.TITLE_NM) AS RPRT_NM
	                 , NVL(T3.TITLE_NM_TXT, T1.TITLE_NM) AS TITLE_NM_TXT
	                 , NVL(LISTAGG((SELECT T3.CD_NM
		                              FROM TBDCMACM013C T3
		                             WHERE T3.CMM_CD_DVSN_CD = '1001031'
		                               AND T3.CD != '000000000'
		                               AND T3.CD = T3.EXAM_CLU_DVSN_CD), ', ') WITHIN GROUP(ORDER BY T1.AFF_SNO), '(검토보고서 미작성)') AS EXAM_CLU_DVSN_NM
		             , T1.AFF_SNO
				  FROM TBBADDED145M T1
	   LEFT OUTER JOIN TBBADDED141M T2 ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO AND T1.AUD_STEP_CD = T2.AUD_STEP_CD AND T1.DOC_ID = T2.DOC_ID AND T1.APVR_CD = T2.APVR_CD AND T1.AFF_SNO = T2.AFF_SNO AND T1.RPRT_FILD_ID = T2.RPRT_FILD_ID)
	   LEFT OUTER JOIN TBBADDED142D T3 ON (T3.AUD_YR = T1.AUD_YR AND T3.AUD_NO = T1.AUD_NO AND T3.AUD_STEP_CD = T1.AUD_STEP_CD AND T3.APVR_CD = T1.APVR_CD AND T3.AFF_SNO = T1.AFF_SNO AND T3.RPRT_FILD_ID = T1.RPRT_FILD_ID AND T3.RPRT_CD = 'A10600530')
				 WHERE T1.AUD_YR = #{audYr}
				   AND T1.AUD_NO = #{audNo}
				   AND T1.AUD_STEP_CD = #{audStepCd}
				   AND T1.APVR_CD IN ('0015800','0035100','0058100','0013900')
				   AND T1.DOC_ID = #{docId}
				   AND NVL(T2.OPIN_NO_YN, 'N') = 'N'
				   AND T3.OPIN_BRF_TXT IS NULL
				 GROUP BY T3.DOC_ID, T1.TITLE_NM, T3.TITLE_NM_TXT, T1.AFF_SNO
    	       )
    	  ORDER BY AFF_SNO 
    	]]>
    </select>
    
</mapper> 
