<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.arp.dao.AEPARP019PMapper">

    <select id="selectAffList" resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP019PMapper.selectAffList */
        <![CDATA[
            SELECT F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-')||'-'||AA.AFF_CD AS AFF_FULL_CD
                 , AA.TITLE_NM
                 , AA.AUD_YR
                 , AA.AUD_NO
                 , AA.AUD_KND_CD
                 , AA.AUD_STEP_CD
                 , AA.DOC_ID
                 , AA.APVR_CD
                 , AA.AFF_SNO
                 , AA.AFF_CD
                 , AA.RPRT_FILD_ID
                 , (SELECT DECODE(ST.DOC_WRIT_KND_CD, '10', 'polaris', 'hancom') FROM TBBADDED001M ST WHERE ST.AUD_YR = AA.AUD_YR AND ST.AUD_NO = AA.AUD_NO) AS DOC_TYPE
                 , DECODE(CC.USR_PSTN,'1','주:','2','부:','') || F_USR_INFO(CC.CNB,'2') AS EXAMER_NM
                 , DECODE(COUNT(CC.CNB),0,'N','Y') AS EXAMER_YN
                 , (SELECT ST.ALLOC_CMPL_YN FROM TBBADDED140M ST WHERE ST.AUD_YR = AA.AUD_YR AND ST.AUD_NO = AA.AUD_NO AND ST.AUD_STEP_CD = AA.AUD_STEP_CD AND ST.DOC_ID = AA.DOC_ID) AS ALLOC_CMPL_YN
                 , (SELECT (DECODE('hancom', (SELECT DECODE(ST.DOC_WRIT_KND_CD, '10', 'polaris', 'hancom') FROM TBBADDED001M ST WHERE ST.AUD_YR = AA.AUD_YR AND ST.AUD_NO = AA.AUD_NO),HWP_DOC_ID,DOC_ID)) AS TMP_DOC_ID
		              FROM TBFDMADM001M D1, TBFDMADM002M D2
		             WHERE D1.AUD_DOC_CD = D2.AUD_DOC_CD
		               AND D1.AUD_DOC_CD = 'A10600510') AS TMP_DOC_ID
		         , CC.OPIN_DOC_ID
		         , DD.APV_RQS_ID
		         , DD.APV_STA_CD
		         , F_CODE_NM('1000773',DD.APV_STA_CD) AS APV_STA_NM
		         , DD.RPRT_NM
		         , CC.USR_PSTN
		         , CC.CNB
		         , (SELECT COUNT(ST.DSP_RQ_SNO) FROM TBBADDED146M ST WHERE ST.AUD_YR = AA.AUD_YR AND ST.AUD_NO = AA.AUD_NO AND ST.AUD_STEP_CD = AA.AUD_STEP_CD AND ST.DOC_ID = AA.DOC_ID AND ST.APVR_CD = AA.APVR_CD AND ST.AFF_SNO = AA.AFF_SNO) AS AFF_DSP_RQ_CNT
		         , (SELECT MIN(ST.DSP_RQ_SNO) FROM TBBADDED146M ST WHERE ST.AUD_YR = AA.AUD_YR AND ST.AUD_NO = AA.AUD_NO AND ST.AUD_STEP_CD = AA.AUD_STEP_CD AND ST.DOC_ID = AA.DOC_ID AND ST.APVR_CD = AA.APVR_CD AND ST.AFF_SNO = AA.AFF_SNO) AS MIN_DSP_RQ_SNO
		         , NVL(CC.OPIN_NO_YN, 'N') AS OPIN_NO_YN
		         , AA.DETL_DOC_NO 
		         , AA.SORT_SNO
		         , CC.OVR_OPIN_YN 
		         , LISTAGG(EE.HNDL_OFER_NM, ', ') WITHIN GROUP(ORDER BY FF.CRNT_RANK_APM_DT) AS HNDL_OFER_NM
              FROM TBBADDED145M AA
        INNER JOIN TBBADDED111M BB ON (AA.AUD_YR = BB.AUD_YR
                                   AND AA.AUD_NO = BB.AUD_NO
                                   AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                                   AND AA.DOC_ID = BB.DOC_ID)
   LEFT OUTER JOIN TBBADDED141M CC ON (CC.AUD_YR = AA.AUD_YR
                                   AND CC.AUD_NO = AA.AUD_NO
                                   AND CC.AUD_STEP_CD = AA.AUD_STEP_CD
                                   AND CC.DOC_ID = AA.DOC_ID
                                   AND CC.APVR_CD = AA.APVR_CD
                                   AND CC.AFF_SNO = AA.AFF_SNO)
   LEFT OUTER JOIN TBBADDED103M DD ON (DD.AUD_YR = CC.AUD_YR
                                   AND DD.AUD_NO = CC.AUD_NO
                                   AND DD.AUD_STEP_CD = CC.AUD_STEP_CD
                                   AND DD.DOC_ID = CC.OPIN_DOC_ID)
   LEFT OUTER JOIN TBBADDED143M EE ON (EE.AUD_YR = AA.AUD_YR
                                   AND EE.AUD_NO = AA.AUD_NO
                                   AND EE.AUD_STEP_CD = AA.AUD_STEP_CD
                                   AND EE.DOC_ID = AA.DOC_ID
                                   AND EE.APVR_CD = AA.APVR_CD
                                   AND EE.AFF_SNO = AA.AFF_SNO)
   LEFT OUTER JOIN TBDCMACM001M FF ON (EE.HNDL_OFER_CNB = FF.CNB)
             WHERE AA.AUD_YR = #{audYr}
               AND AA.AUD_NO = #{audNo}
               AND AA.AUD_STEP_CD = #{audStepCd}
               AND AA.DOC_ID = #{docId}
               AND AA.APVR_CD IN ('0015800','0035100','0058100','0013900')
               AND BB.DOC_STA_CD = '20'
             ]]>
             <if test="allocYn eq 'Y'.toString()">
              AND (EE.HNDL_OFER_CNB = #{cnb} OR CC.CNB = #{cnb})
             </if>
             <if test="allocYn eq 'N'.toString()">
               AND CC.CNB != #{cnb}
               AND (NOT EXISTS (SELECT 1
                                 FROM TBBADDED143M EE
                                WHERE EE.AUD_YR = CC.AUD_YR
                                  AND EE.AUD_NO = CC.AUD_NO
                                  AND EE.DOC_ID = CC.DOC_ID
                                  AND EE.AFF_SNO = CC.AFF_SNO
                                  AND EE.HNDL_OFER_CNB = #{cnb}))
             </if>
             GROUP BY AA.TITLE_NM, AA.AUD_YR, AA.AUD_NO, AA.AUD_STEP_CD, AA.DOC_ID, AA.APVR_CD, AA.AFF_SNO, AA.AFF_CD, AA.RPRT_FILD_ID, AA.AUD_KND_CD
                    , BB.LINK_URL, AA.DETL_DOC_NO, AA.SORT_SNO, CC.OPIN_DOC_ID, DD.APV_RQS_ID, DD.APV_STA_CD, DD.RPRT_NM, CC.USR_PSTN, CC.CNB, AA.AUD_KND_CD, CC.OPIN_NO_YN, CC.OVR_OPIN_YN
             UNION ALL 
             SELECT AFF_FULL_CD
                   ,TITLE_NM
                   ,AUD_YR
                   ,AUD_NO
                   ,AUD_KND_CD
                   ,AUD_STEP_CD
                   ,DOC_ID
                   ,APVR_CD
                   ,AFF_SNO
                   ,AFF_CD
                   ,RPRT_FILD_ID
                   ,DOC_TYPE
                   ,EXAMER_NM
                   ,EXAMER_YN
                   ,ALLOC_CMPL_YN
                   ,TMP_DOC_ID
                   ,OPIN_DOC_ID
                   ,APV_RQS_ID
                   ,APV_STA_CD
                   ,APV_STA_NM
                   ,RPRT_NM
                   ,USR_PSTN
                   ,CNB
                   ,AFF_DSP_RQ_CNT
                   ,MIN_DSP_RQ_SNO
                   ,OPIN_NO_YN
                   ,DETL_DOC_NO
                   ,SORT_SNO
                   ,OVR_OPIN_YN
                   ,LISTAGG(HNDL_OFER_NM, ', ') WITHIN GROUP(ORDER BY CRNT_RANK_APM_DT) AS HNDL_OFER_NM
               FROM (SELECT F_MNG_KND_AUDYRNO(CC.AUD_YR, CC.AUD_NO, '', '-') AS AFF_FULL_CD
	                     , '품질담당관 종합의견' AS TITLE_NM
	                     , CC.AUD_YR
	                     , CC.AUD_NO
	                     , '' AS AUD_KND_CD
	                     , CC.AUD_STEP_CD
	                     , CC.DOC_ID
	                     , CC.APVR_CD
	                     , CC.AFF_SNO
	                     , '' AS AFF_CD
	                     , CC.RPRT_FILD_ID
	                     , (SELECT DECODE(ST.DOC_WRIT_KND_CD, '10', 'polaris', 'hancom') FROM TBBADDED001M ST WHERE ST.AUD_YR = CC.AUD_YR AND ST.AUD_NO = CC.AUD_NO) AS DOC_TYPE
	                     , DECODE(CC.USR_PSTN,'1','주:','2','부:','') || F_USR_INFO(CC.CNB,'2') AS EXAMER_NM
	                     , DECODE(CC.CNB,NULL,'N','Y') AS EXAMER_YN
	                     , (SELECT ST.ALLOC_CMPL_YN FROM TBBADDED140M ST WHERE ST.AUD_YR = CC.AUD_YR AND ST.AUD_NO = CC.AUD_NO AND ST.AUD_STEP_CD = CC.AUD_STEP_CD AND ST.DOC_ID = CC.DOC_ID) AS ALLOC_CMPL_YN
	                     , (SELECT (DECODE('hancom', (SELECT DECODE(ST.DOC_WRIT_KND_CD, '10', 'polaris', 'hancom') FROM TBBADDED001M ST WHERE ST.AUD_YR = CC.AUD_YR AND ST.AUD_NO = CC.AUD_NO),HWP_DOC_ID,DOC_ID)) AS TMP_DOC_ID
	                        FROM TBFDMADM001M D1, TBFDMADM002M D2
	                      WHERE D1.AUD_DOC_CD = D2.AUD_DOC_CD
	                         AND D1.AUD_DOC_CD = 'A10600510') AS TMP_DOC_ID
	                     , CC.OPIN_DOC_ID
	                     , DD.APV_RQS_ID
	                     , DD.APV_STA_CD
	                     , F_CODE_NM('1000773',DD.APV_STA_CD) AS APV_STA_NM
	                     , DD.RPRT_NM
	                     , CC.USR_PSTN
	                     , CC.CNB
	                     , 0 AS AFF_DSP_RQ_CNT
	                     , 0 AS MIN_DSP_RQ_SNO
	                     , NVL(CC.OPIN_NO_YN, 'N') AS OPIN_NO_YN
	                     , '' DETL_DOC_NO 
	                     , 0 SORT_SNO 
	                     , CC.OVR_OPIN_YN 
	                     , EE.HNDL_OFER_NM
	                     , EE.HNDL_OFER_CNB
	                     , FF.CRNT_RANK_APM_DT
	               FROM  TBBADDED141M CC
	                        LEFT OUTER JOIN TBBADDED103M DD 
	                                         ON (DD.AUD_YR = CC.AUD_YR
	                                        AND DD.AUD_NO = CC.AUD_NO
	                                        AND DD.AUD_STEP_CD = CC.AUD_STEP_CD
	                                        AND DD.DOC_ID = CC.OPIN_DOC_ID)
	                        LEFT OUTER JOIN TBBADDED143M EE 
	                                         ON (EE.AUD_YR = CC.AUD_YR
	                                        AND EE.AUD_NO = CC.AUD_NO
	                                        AND EE.AUD_STEP_CD = CC.AUD_STEP_CD
	                                        AND EE.DOC_ID = CC.DOC_ID
	                                        AND EE.APVR_CD = CC.APVR_CD
	                                        AND EE.AFF_SNO = CC.AFF_SNO)
	                        LEFT OUTER JOIN TBDCMACM001M FF ON (EE.HNDL_OFER_CNB = FF.CNB)
	             WHERE CC.AUD_YR = #{audYr}
	                AND CC.AUD_NO = #{audNo}
	                AND CC.AUD_STEP_CD =#{audStepCd}
	                AND CC.DOC_ID = #{docId}
	                AND CC.AFF_SNO = 0
	                AND CC.APVR_CD IN ('0015800','0035100','0058100','0013900')
	               <if test="allocYn eq 'Y'.toString()">
	                    AND (EE.HNDL_OFER_CNB = #{cnb} OR CC.CNB = #{cnb})
	               </if>
	               <if test="allocYn eq 'N'.toString()">
	                    AND CC.CNB != #{cnb}
                        AND (NOT EXISTS (SELECT 1
                                 FROM TBBADDED143M EE
                                WHERE EE.AUD_YR = CC.AUD_YR
                                  AND EE.AUD_NO = CC.AUD_NO
                                  AND EE.DOC_ID = CC.DOC_ID
                                  AND EE.AFF_SNO = CC.AFF_SNO
                                  AND EE.HNDL_OFER_CNB = #{cnb}))
	              </if>
                    )
             GROUP BY AFF_FULL_CD,TITLE_NM,AUD_YR,AUD_NO,AUD_KND_CD,AUD_STEP_CD,DOC_ID,APVR_CD,AFF_SNO,AFF_CD,RPRT_FILD_ID,DOC_TYPE
			         ,EXAMER_NM,EXAMER_YN,ALLOC_CMPL_YN,TMP_DOC_ID,OPIN_DOC_ID,APV_RQS_ID,APV_STA_CD,APV_STA_NM,RPRT_NM,USR_PSTN,CNB
			         ,AFF_DSP_RQ_CNT,MIN_DSP_RQ_SNO,OPIN_NO_YN,DETL_DOC_NO,SORT_SNO,OVR_OPIN_YN
             ORDER BY SORT_SNO
    </select>
    
    <select id="selectHndlOferList" resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP019PMapper.selectHndlOferList */
        <![CDATA[
        SELECT T2.CNB                                  AS HNDL_OFER_CNB
              ,T2.USR_NAM                              AS HNDL_OFER_NM
              ,T2.RANK_CD                              AS HNDL_OFER_RANK_CD
              ,T2.DPT_CD                               AS HNDL_OFER_DPT_CD
              ,T2.RAL_BLT_DIV_CD                       AS HNDL_OFER_RAL_BLT_CD
              ,F_CODE_NM ('1000144',T2.RAL_BLT_DIV_CD) AS HNDL_OFER_RAL_BLT_NM
		  FROM (SELECT CD_NM
		          FROM TBDCMACM013C TT1
		         WHERE NOT EXISTS (SELECT 1
		                             FROM TBBADDED143M TT2
		                            WHERE TT2.AUD_YR      = #{audYr}
				                      AND TT2.AUD_NO      = #{audNo}
				                      AND TT2.AUD_STEP_CD = #{audStepCd}
				                      AND TT2.DOC_ID      = #{docId}
				                      AND TT2.AFF_SNO     = #{affSno}
		                              AND TT1.CD_NM = TT2.HNDL_OFER_CNB
		                          )
		           AND TT1.CMM_CD_DVSN_CD = '1000914'
		           AND TT1.CD != '000000000'
		           AND TT1.USE_YN ='Y'
		           AND TT1.USR_DFN_TXT_1 = '10') T1
		      ,TBDCMACM001M T2
		 WHERE T2.CNB = T1.CD_NM
		 ORDER BY T2.CRNT_RANK_APM_DT
        ]]>
    </select>
    
    <select id="selectHndlOferRfcList" resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP019PMapper.selectHndlOferRfcList */
        <![CDATA[
        SELECT T1.AUD_YR
		     , T1.AUD_NO
		     , T1.AUD_STEP_CD
		     , T1.DOC_ID
		     , T1.AFF_SNO
		     , T1.HNDL_OFER_CNB
		     , T1.HNDL_OFER_NM
		     , T1.HNDL_OFER_RANK_CD
		     , T1.HNDL_OFER_DPT_CD
		     , F_CODE_NM ('1000144', T1.HNDL_OFER_RAL_BLT_CD) AS HNDL_OFER_RAL_BLT_NM
		  FROM TBBADDED143M T1
             , TBDCMACM001M T2
		 WHERE 1=1
		   AND T1.HNDL_OFER_CNB = T2.CNB
		   AND T1.AUD_YR      = #{audYr}
		   AND T1.AUD_NO      = #{audNo}
		   AND T1.AUD_STEP_CD = #{audStepCd}
		   AND T1.DOC_ID      = #{docId}
		   AND T1.AFF_SNO     = #{affSno}
		 ORDER BY T2.CRNT_RANK_APM_DT
        ]]>
    </select>
    
    <insert id="insertRfcList" parameterType="paramMap">
		/* kr.go.bai.eip.aep.arp.dao.AEPARP019PMapper.insertRfcList */
		<![CDATA[
		INSERT INTO TBBADDED143M
				            ( AUD_YR
				             ,AUD_NO
				             ,AUD_STEP_CD
				             ,DOC_ID
				             ,APVR_CD
				             ,AFF_SNO
				             ,DSP_RQ_SNO
				             ,HNDL_OFER_CNB
				             ,HNDL_OFER_RANK_CD
				             ,HNDL_OFER_DPT_CD
				             ,HNDL_OFER_RAL_BLT_CD
				             ,HNDL_OFER_NM
				             ,AUD_KND_CD
				             ,FRT_USR_ID
				             ,FRT_REGI_DH
				             ,FNL_USR_ID
				             ,FNL_MDF_DH
				             ,FNL_DEAL_DPT_CD
				             ,FNL_MNU_ID
				            )
				     VALUES ( #{audYr}
				             ,#{audNo}
				             ,#{audStepCd}
				             ,#{docId}
				             ,#{apvrCd}
				             ,#{affSno}
				             ,#{minDspRqSno}
				             ,#{hndlOferCnb}
				             ,#{hndlOferRankCd}
				             ,#{hndlOferDptCd}
				             ,#{hndlOferRalBltCd}
				             ,#{hndlOferNm}
				             ,#{audKndCd}
				             ,#{usrId}
				             ,SYSDATE
				             ,#{usrId}
				             ,SYSDATE
				             ,#{dptCd}
				             ,#{menuNo}
				            )
		]]>
	</insert>
	
	<delete id="deleteRfcList">
	     /* kr.go.bai.eip.aep.arp.dao.AEPARP019PMapper.deleteRfcList */
	    <![CDATA[
	    DELETE TBBADDED143M
	     WHERE AUD_YR = #{audYr}
	       AND AUD_NO = #{audNo}
	       AND AUD_STEP_CD = #{audStepCd}
	       AND DOC_ID = #{docId}
	       AND AFF_SNO = #{affSno}
	       AND HNDL_OFER_CNB = #{hndlOferCnb}
	        ]]>
    </delete>
    
</mapper> 
