<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper">     
    <select id="selectPreAffList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.selectPreAffList */
            SELECT AA.AUD_YR
                 , BB.TITLE_NM
                 , BB.AUD_STEP_CD
                 , AA.AUD_NO
                 , AA.AUD_KND_CD
                 , CC.AFF_DSP_CD
                 , BB.AFF_CD
                 , BB.AFF_SNO
                 , BB.SORT_SNO
                 , CC.DSP_RQ_SNO
                 , CC.DSP_RQ_CD
                 , CC.APVR_CD
                 , F_CODE_NM('1000002', CC.DSP_RQ_CD)  AS DSP_RQ_NM
                 , DECODE(CC.AFF_DSP_CD, '00', '', BB.AFF_CD || '-' || CC.AFF_DSP_CD) AS AFFDSP_CD
                 , CASE WHEN CC.AFF_DSP_CD = '00'
                        THEN F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || ' - -' 
                        ELSE F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || '-' || BB.AFF_CD || '-' || CC.AFF_DSP_CD 
                    END AS AFF_NO
                 , CC.DOC_ID
                 , CC.RPRT_FILD_ID
                 , F_ORG_INFO(CC.RLTN_ORG_CD, 1) AS RLTN_ORG_NM
                 , BB.REFER_DVSN_CD
                 , F_CODE_NM('1000774', BB.REFER_DVSN_CD) AS REFER_DVSN_NM
                 , CC.HD_AUD_STEP_CD
                 , CC.HD_DOC_ID
                 , CC.HD_APVR_CD
                 , CC.HD_AFF_SNO
                 , CC.HD_DSP_RQ_SNO
                 , CC.KYWD1
                 , CC.KYWD2
                 , CC.KYWD3
                 , CC.KYWD4
                 , CC.KYWD5
              FROM TBBADDED001M AA
                 , TBBADDED145M BB
                 , TBBADDED146M CC
             <if test='preAudStepCd != "A1050"'>
                 , TBBADDED103M DD
             </if>
             WHERE AA.AUD_YR = BB.AUD_YR
               AND AA.AUD_NO = BB.AUD_NO
               AND AA.AUD_YR = CC.AUD_YR
               AND AA.AUD_NO = CC.AUD_NO
               AND AA.AUD_YR = #{audYr}
               AND AA.AUD_NO = #{audNo}
               AND BB.AFF_SNO = CC.AFF_SNO
               AND BB.AUD_STEP_CD = #{preAudStepCd}
               AND BB.AUD_STEP_CD = CC.AUD_STEP_CD
           <if test='preAudStepCd != "A1050"'>
               AND AA.AUD_YR = DD.AUD_YR
               AND AA.AUD_NO = DD.AUD_NO
               AND CC.DOC_ID = DD.DOC_ID
           </if>
           <if test='preApvrCd != null and preApvrCd != ""'>
               AND BB.APVR_CD IN 
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
               AND BB.APVR_CD = CC.APVR_CD
           </if>
               AND NOT EXISTS (
                               SELECT 1 
                                 FROM TBBADDED147M ZZ
                                WHERE ZZ.AUD_YR = #{audYr}
                                  AND ZZ.AUD_NO = #{audNo}
                                  AND ZZ.PRE_AFF_NO = F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || '-' || BB.AFF_CD || '-' || CC.AFF_DSP_CD
                                  AND ZZ.AUD_STEP_CD = #{nextAudStepCd}
                              <if test='apvrCd != null and apvrCd != ""'>
                                  AND ZZ.APVR_CD IN
                                        <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                                        #{item}
                                        </foreach>
                              </if>
                              )
             ORDER BY 
                  <if test='preAudStepCd != "A1050"'>
                      DD.AUD_RPRT_DVSN_CD, DD.DOC_ID, 
                  </if>
                      BB.SORT_SNO, CC.SORT_SNO
    </select>

    <select id="selectAffList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.selectAffList */
        <![CDATA[  
            SELECT CASE WHEN COUNT(1) > 1
                        THEN MIN(G2.RPRT_CD)
                        ELSE MAX(G1.RPRT_CD)
                   END AS RPRT_CD
                 , CASE WHEN COUNT(1) > 1
                        THEN MIN(G2.AUD_RPRT_DVSN_CD)
                        ELSE MAX(G1.AUD_RPRT_DVSN_CD)
                   END AS SORT_SNO0
                 , CASE WHEN COUNT(1) > 1
                        THEN MIN(G2.SUB_SORT_SNO1)
                        ELSE MAX(G1.SORT_SNO1)
                   END AS SORT_SNO1
                 , CASE WHEN COUNT(1) > 1
                        THEN MIN(G2.SUB_SORT_SNO2)
                        ELSE MAX(G1.SORT_SNO2)
                   END AS SORT_SNO2
                 , MAX(G1.AUD_RPRT_DVSN_CD) AS AUD_RPRT_DVSN_CD
                 , G1.AUD_YR
                 , G1.AUD_NO
                 , G1.AUD_STEP_CD
                 , G1.AUD_KND_CD
                 , G1.AFF_DSP_CD
                 , G1.AFF_SNO
                 , G1.DSP_RQ_SNO
                 , G1.TITLE_NM
                 , G1.APVR_CD
                 , G1.AFF_CD
                 , G1.DOC_ID
                 , G1.RPRT_FILD_ID
                 , G1.DSP_RQ_CD
                 , G1.RLTN_ORG_CD
                 , G1.MPP_ABLE_YN
                 , G1.MPP_CANCEL_YN
                 , G1.REFER_DVSN_CD
                 , F_ORG_INFO(G1.RLTN_ORG_CD, 1) AS RLTN_ORG_NM
                 , F_CODE_NM('1000002', G1.DSP_RQ_CD)  AS DSP_RQ_NM
                 , DECODE(G1.AFF_DSP_CD, '00', '', G1.AFF_CD || '-' || G1.AFF_DSP_CD) AS AFFDSP_CD
                 , F_MNG_KND_AUDYRNO(G1.AUD_YR, G1.AUD_NO, G1.AUD_KND_CD, '-') || '-' || G1.AFF_CD || '-' || G1.AFF_DSP_CD AS AFF_NO
                 , F_CODE_NM('1000774', G1.REFER_DVSN_CD) AS REFER_DVSN_NM
                 , G1.KYWD1
                 , G1.KYWD2
                 , G1.KYWD3
                 , G1.KYWD4
                 , G1.KYWD5
              FROM (
                    SELECT AA.AUD_YR
                         , BB.AUD_STEP_CD
                         , AA.AUD_NO
                         , AA.AUD_KND_CD
                         , CC.AFF_DSP_CD
                         , BB.AFF_SNO
                         , CC.DSP_RQ_SNO
                         , CC.DSP_RQ_CD
                         , BB.TITLE_NM
                         , BB.APVR_CD
                         , BB.AFF_CD
                         , CC.DOC_ID
                         , CC.RPRT_FILD_ID
                         , DD.AUD_RPRT_DVSN_CD
                         , CC.RLTN_ORG_CD
                         , CASE 
                                WHEN BB.APVR_CD IN ('0015800','0035100','0058100','0045900','0055600','0055700','0010600') AND DD.RPRT_CD IN ('A10601100','A10601300','A10601320','A10601330','A10601340','A10601700')
                                THEN 'N'
                                WHEN BB.APVR_CD ='0055700' 
                                THEN (
                                      SELECT DECODE(COUNT(*), 0, 'N', 'Y') 
                                        FROM TBBADDED145M EE
                                       WHERE EE.AUD_YR = CC.AUD_YR
                                         AND EE.AUD_NO = CC.AUD_NO
                                         AND EE.AUD_STEP_CD = CC.AUD_STEP_CD
                                         AND EE.APVR_CD = CC.APVR_CD
                                         AND EE.DOC_ID = CC.DOC_ID
                                         AND EE.REFER_DVSN_CD = 'D10'
                                     )
                                ELSE 'Y'
                           END AS MPP_ABLE_YN
                         , (
                            SELECT DECODE(COUNT(T1.APV_DOC_NO), 0, 'Y', 'N')
                              FROM TBDCMACM023L T1 
                             WHERE DD.APV_RQS_ID = T1.APV_DOC_NO
                               AND T1.APVR_STA_CD IN ('202','203','204')
                               AND T1.APVR_PST_CD = BB.APVR_CD
                            ) AS MPP_CANCEL_YN
                         , BB.REFER_DVSN_CD
                         , (SELECT T2.PRE_AFF_NO
                              FROM TBBADDED147M T2
                             WHERE T2.AUD_YR = BB.AUD_YR
                               AND T2.AUD_NO = BB.AUD_NO
                               AND T2.AUD_STEP_CD = BB.AUD_STEP_CD
                               AND T2.APVR_CD = BB.APVR_CD
                               AND T2.DOC_ID = BB.DOC_ID
                               AND T2.AFF_SNO = BB.AFF_SNO
                               AND T2.DSP_RQ_SNO = CC.DSP_RQ_SNO) AS PRE_AFF_NO
                         , BB.SORT_SNO AS SORT_SNO1
                         , CC.SORT_SNO AS SORT_SNO2
                         , DD.RPRT_CD
                         , CC.KYWD1
                         , CC.KYWD2
                         , CC.KYWD3
                         , CC.KYWD4
                         , CC.KYWD5
                      FROM TBBADDED001M AA
                         , TBBADDED145M BB
                         , TBBADDED146M CC
                         , TBBADDED103M DD
                     WHERE AA.AUD_YR = BB.AUD_YR
                       AND AA.AUD_NO = BB.AUD_NO
                       AND AA.AUD_YR = CC.AUD_YR
                       AND AA.AUD_NO = CC.AUD_NO
                       AND AA.AUD_YR = #{audYr}
                       AND AA.AUD_NO = #{audNo}
                       AND BB.AFF_SNO = CC.AFF_SNO
                       AND BB.AUD_STEP_CD = #{audStepCd}
                       AND BB.AUD_STEP_CD = CC.AUD_STEP_CD
                       AND AA.AUD_YR = DD.AUD_YR
                       AND AA.AUD_NO = DD.AUD_NO
                       AND BB.DOC_ID = DD.DOC_ID
                       AND CC.DOC_ID = DD.DOC_ID
                   ]]>
                   <if test='apvrCd != null and apvrCd != ""'>
                       AND BB.APVR_CD IN
                               <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                                  #{item}
                               </foreach>
                       AND BB.APVR_CD = CC.APVR_CD
                   </if>
                   <if test='vApvrCd != null and vApvrCd != ""'>
                       AND CC.DSP_RQ_CD NOT IN ('390', '391', '395', '396', '490', '495', '730')
                   </if>
                   ) AS G1
              LEFT OUTER JOIN (SELECT ST3.AUD_YR
                                     , ST3.AUD_NO
                                     , ST3.AUD_STEP_CD
                                     , ST3.APVR_CD
                                     , ST3.PRE_AFF_NO
                                     , ST4.RPRT_CD
                                     , ST4.AUD_RPRT_DVSN_CD
                                     , ST1.SORT_SNO AS SUB_SORT_SNO1
                                     , ST2.SORT_SNO AS SUB_SORT_SNO2
                                 FROM TBBADDED145M ST1
                                INNER JOIN TBBADDED146M ST2 ON (    ST2.AUD_YR = ST1.AUD_YR
                                                                AND ST2.AUD_NO = ST1.AUD_NO
                                                                AND ST2.AUD_STEP_CD = ST1.AUD_STEP_CD
                                                                AND ST2.APVR_CD = ST1.APVR_CD
                                                                AND ST2.DOC_ID = ST1.DOC_ID
                                                                AND ST2.AFF_SNO = ST1.AFF_SNO)
                                INNER JOIN TBBADDED147M ST3 ON (    ST3.AUD_YR = ST1.AUD_YR
                                                                AND ST3.AUD_NO = ST1.AUD_NO
                                                                AND ST3.AUD_STEP_CD = ST1.AUD_STEP_CD
                                                                AND ST3.APVR_CD = ST1.APVR_CD
                                                                AND ST3.DOC_ID = ST1.DOC_ID
                                                                AND ST3.AFF_SNO = ST1.AFF_SNO
                                                                AND ST3.DSP_RQ_SNO = ST2.DSP_RQ_SNO )
                                INNER JOIN TBBADDED103M ST4 ON (    ST4.AUD_YR = ST1.AUD_YR
                                                                AND ST4.AUD_NO = ST1.AUD_NO
                                                                AND ST4.DOC_ID = ST1.DOC_ID)
                                 ) G2 ON (    G2.AUD_YR = G1.AUD_YR
                                            AND G2.AUD_NO = G1.AUD_NO
                                            AND G2.AUD_STEP_CD = G1.AUD_STEP_CD
                                            AND G2.APVR_CD = G1.APVR_CD
                                            AND G2.PRE_AFF_NO = G1.PRE_AFF_NO)
             GROUP BY G1.AUD_YR
                     , G1.AUD_NO
                     , G1.AUD_STEP_CD
                     , G1.AUD_KND_CD
                     , G1.AFF_DSP_CD
                     , G1.AFF_SNO
                     , G1.DSP_RQ_SNO
                     , G1.TITLE_NM
                     , G1.APVR_CD
                     , G1.AFF_CD
                     , G1.DOC_ID
                     , G1.RPRT_FILD_ID
                     , G1.DSP_RQ_CD
                     , G1.RLTN_ORG_CD
                     , G1.MPP_ABLE_YN
                     , G1.MPP_CANCEL_YN
                     , G1.REFER_DVSN_CD
                     , G1.KYWD1
                     , G1.KYWD2
                     , G1.KYWD3
                     , G1.KYWD4
                     , G1.KYWD5
             ORDER BY DECODE(RPRT_CD, 'A10600200', 1
                                    , 'A10601300', 2
                                    , 'A10601320', 2
                                    , 'A10601330', 2
                                    , 'A10601340', 2
                                    , 'A10601100', 3)
                     , SORT_SNO0
                     , SORT_SNO1
                     , SORT_SNO2
    </select>

    <select id="selectNotMppCnt" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.selectNotMppCnt */
            SELECT COUNT(AA.AUD_NO) AS CNT
              FROM TBBADDED145M AA
                 , TBBADDED146M BB
             WHERE AA.AUD_YR = BB.AUD_YR
               AND AA.AUD_NO = BB.AUD_NO
               AND AA.AUD_YR = #{audYr}
               AND AA.AUD_NO = #{audNo}
               AND AA.AFF_SNO = BB.AFF_SNO
               AND AA.AUD_STEP_CD = #{nextAudStepCd}
               AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
           <if test='apvrCd != null and apvrCd != ""'>
               AND AA.APVR_CD IN
                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
               AND AA.APVR_CD = BB.APVR_CD
           </if>
               AND NOT EXISTS (
                              SELECT 1
                                FROM TBBADDED147M CC
                               WHERE CC.AUD_YR = AA.AUD_YR
                                 AND CC.AUD_NO = AA.AUD_NO
                                 AND CC.AUD_STEP_CD = AA.AUD_STEP_CD
                             <if test='apvrCd != null and apvrCd != ""'>
                                 AND CC.APVR_CD = AA.APVR_CD
                             </if>
                                 AND CC.AFF_SNO = BB.AFF_SNO
                                 AND CC.DSP_RQ_SNO = BB.DSP_RQ_SNO
                              )
           
           <if test='vApvrCd != null and vApvrCd != ""'>
               AND BB.DSP_RQ_CD NOT IN ('390', '391', '395', '396', '490', '495', '730')
           </if>
             ORDER BY BB.SORT_SNO
    </select>

    <select id="selectInsertItem" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.selectInsertItem */
            SELECT F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || '-' || BB.AFF_CD || '-' || CC.AFF_DSP_CD AS AFF_NO
              FROM TBBADDED001M AA
                 , TBBADDED145M BB
                 , TBBADDED146M CC
             WHERE AA.AUD_YR = #{audYr}
               AND AA.AUD_NO = #{audNo}
               AND AA.AUD_YR = BB.AUD_YR
               AND AA.AUD_NO = BB.AUD_NO
               AND AA.AUD_YR = CC.AUD_YR
               AND AA.AUD_NO = CC.AUD_NO
               AND BB.AFF_SNO = #{affSno}
               AND BB.AFF_SNO = CC.AFF_SNO
               AND BB.AUD_STEP_CD = #{audStepCd}
               AND BB.AUD_STEP_CD = CC.AUD_STEP_CD
               AND CC.DSP_RQ_SNO = #{dspRqSno}
           <if test='apvrCd != null and apvrCd != ""'>
               AND BB.APVR_CD = #{apvrCd}
               AND BB.APVR_CD = CC.APVR_CD
           </if>
    </select>

    <insert id="updateAffCdData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.updateAffCdData */
            UPDATE TBBADDED145M
            <if test='saveType != "NEW"'>
               SET AFF_CD = #{affCd}
            </if>
            <if test='saveType == "NEW"'>
             <![CDATA[  
               SET AFF_CD = (
                            SELECT LPAD(MAX(AFF_CD), 2, '0') 
                              FROM (
                                   SELECT CASE WHEN '0' <> (
                                                            SELECT MAX(AFF_CD + 0)
                                                              FROM TBBADDED145M
                                                             WHERE AUD_YR = #{audYr}
                                                               AND AUD_NO = #{audNo}
                                                               AND AFF_SNO = #{affSno}
                                                               AND AUD_STEP_CD = #{audStepCd}
                                                               AND APVR_CD = #{apvrCd}
                                                            )
                                               THEN (
                                                    SELECT MAX(AFF_CD + 0)
                                                      FROM TBBADDED145M
                                                     WHERE AUD_YR = #{audYr}
                                                       AND AUD_NO = #{audNo}
                                                       AND AFF_SNO = #{affSno}
                                                       AND AUD_STEP_CD = #{audStepCd}
                                                       AND APVR_CD = #{apvrCd}
                                                    )
                                               ELSE (SELECT NVL(MIN(T1.RNUM),
                                                                 (
                                                                  SELECT MAX(MAX_CD) + 1
                                                                    FROM (
                                                                      SELECT EXPT_PRB_CD + 0 AS MAX_CD
                                                                        FROM TBBADDED144M
                                                                       WHERE AUD_YR = #{audYr}
                                                                         AND AUD_NO = #{audNo}
                                                                       UNION ALL                  
                                                                      SELECT AFF_CD + 0
                                                                        FROM TBBADDED145M
                                                                       WHERE AUD_YR = #{audYr}
                                                                         AND AUD_NO = #{audNo}
                                                                         AND AFF_CD <> '00'
                                                                         AND AFF_CD IS NOT NULL
                                                                       GROUP BY AFF_CD)
                                                                  ))
                                                      FROM (
                                                        SELECT ROWNUM AS RNUM
                                                          FROM DUAL
                                                        CONNECT BY ROWNUM <= (
                                                                        SELECT MAX(MAX_CD)
                                                                          FROM (
                                                                            SELECT EXPT_PRB_CD + 0 AS MAX_CD
                                                                              FROM TBBADDED144M
                                                                             WHERE AUD_YR = #{audYr}
                                                                               AND AUD_NO = #{audNo}
                                                                            UNION ALL                  
                                                                            SELECT AFF_CD + 0
                                                                              FROM TBBADDED145M
                                                                             WHERE AUD_YR = #{audYr}
                                                                               AND AUD_NO = #{audNo}
                                                                               AND AFF_CD <> '00'
                                                                               AND AFF_CD IS NOT NULL
                                                                             GROUP BY AFF_CD) )
                                                                ) AS T1
                                                    WHERE NOT EXISTS ( SELECT 1
                                                                         FROM ( SELECT EXPT_PRB_CD + 0 AS CD
                                                                                  FROM TBBADDED144M
                                                                                 WHERE AUD_YR = #{audYr}
                                                                                   AND AUD_NO = #{audNo}
                                                                                UNION ALL                  
                                                                                SELECT AFF_CD + 0
                                                                                  FROM TBBADDED145M
                                                                                 WHERE AUD_YR = #{audYr}
                                                                                   AND AUD_NO = #{audNo}
                                                                                   AND AFF_CD <> '00'
                                                                                   AND AFF_CD IS NOT NULL) T2
                                                                      WHERE T1.RNUM = T2.CD ))
                                           END AS AFF_CD
                                     FROM TBBADDED144M AA
                                    RIGHT JOIN
                                          TBBADDED145M BB
                                       ON AA.AUD_YR = BB.AUD_YR AND AA.AUD_NO = BB.AUD_NO
                                    WHERE BB.AUD_YR = #{audYr}
                                      AND BB.AUD_NO = #{audNo}
                                   )
                            )
            ]]>
            </if>
                 , FNL_USR_ID = #{fnlUsrId}
                 , FNL_DEAL_DPT_CD = #{fnlDealDptCd}
                 , FNL_MNU_ID = #{fnlMnuId}
                 , FNL_MDF_DH = SYSDATE
             WHERE AFF_SNO = #{affSno}
               AND AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = #{audStepCd}
           <if test='apvrCd != null and apvrCd != ""'>
               AND APVR_CD = #{apvrCd}
           </if>
    </insert>

    <insert id="updateAffDspCdData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.updateAffDspCdData */
            UPDATE TBBADDED146M
               SET AFF_DSP_CD = 
                            <if test='saveType == "DTEN" or saveType == "ITDC"'>
                                #{affDspCd}
                            </if>
                            <if test='saveType == "NEW"'>
                                    (
                                    SELECT LPAD(AFF_DSP_CD, 2, '0') AS AFF_DSP_CD
                                      FROM (
                                           SELECT NVL(MAX(BB.AFF_DSP_CD+0), 0)+1 AS AFF_DSP_CD
                                             FROM TBBADDED145M AA
                                                , TBBADDED146M BB
                                            WHERE AA.AUD_YR = #{audYr}
                                              AND AA.AUD_NO = #{audNo}
                                              AND AA.AUD_YR = BB.AUD_YR
                                              AND AA.AUD_NO = BB.AUD_NO
                                              AND AA.AFF_CD = #{affCd}
                                              AND AA.AFF_SNO = BB.AFF_SNO
                                              AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                                              AND AA.APVR_CD = BB.APVR_CD
                                           )
                                    )
                            </if>
                            <if test='saveType == "DIMR"'>
                                <if test='firstYn == "Y"'>
                                    #{affDspCd}
                                </if>
                                <if test='firstYn == "N"'>
                                    (
                                    SELECT LPAD(AFF_DSP_CD, 2, '0') AS AFF_DSP_CD
                                      FROM (
                                           SELECT NVL(MAX(BB.AFF_DSP_CD+0), 0)+1 AS AFF_DSP_CD
                                             FROM TBBADDED145M AA
                                                , TBBADDED146M BB
                                            WHERE AA.AUD_YR = #{audYr}
                                              AND AA.AUD_NO = #{audNo}
                                              AND AA.AUD_YR = BB.AUD_YR
                                              AND AA.AUD_NO = BB.AUD_NO
                                              AND AA.AFF_CD = #{affCd}
                                              AND AA.AFF_SNO = BB.AFF_SNO
                                              AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                                              AND AA.APVR_CD = BB.APVR_CD
                                           )
                                    )
                                </if>
                            </if>
            
           <if test='hdAudStepCd != null and hdAudStepCd != ""'>
                 , HD_AUD_STEP_CD = #{hdAudStepCd}
           </if>
           <if test='hdDocId != null and hdDocId != ""'>
                 , HD_DOC_ID = #{hdDocId}
           </if>
           <if test='hdApvrCd != null and hdApvrCd != ""'>
                 , HD_APVR_CD = #{hdApvrCd}
           </if>
           <if test='hdAffSno != null and hdAffSno != ""'>
                 , HD_AFF_SNO = #{hdAffSno}
           </if>
           <if test='hdDspRqSno != null and hdDspRqSno != ""'>
                 , HD_DSP_RQ_SNO = #{hdDspRqSno}
           </if>
                 , FNL_USR_ID = #{fnlUsrId}
                 , FNL_DEAL_DPT_CD = #{fnlDealDptCd}
                 , FNL_MNU_ID = #{fnlMnuId}
                 , FNL_MDF_DH = SYSDATE
             WHERE AFF_SNO = #{affSno}
               AND DSP_RQ_SNO = #{dspRqSno}
               AND AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = #{audStepCd}
           <if test='apvrCd != null and apvrCd != ""'>
               AND APVR_CD = #{apvrCd}
           </if>
    </insert>

    <insert id="updateAffDspCdDataReset" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.updateAffCdDataReset */
            UPDATE TBBADDED146M
               SET AFF_DSP_CD = '00'
                 , HD_AUD_STEP_CD = ''
                 , HD_DOC_ID = ''
                 , HD_APVR_CD = ''
                 , HD_AFF_SNO = ''
                 , HD_DSP_RQ_SNO = ''
                 , FNL_USR_ID = #{fnlUsrId}
                 , FNL_DEAL_DPT_CD = #{fnlDealDptCd}
                 , FNL_MNU_ID = #{fnlMnuId}
                 , FNL_MDF_DH = SYSDATE
             WHERE AFF_SNO IN (SELECT AFF_SNO
                                      FROM TBBADDED145M
                                     WHERE AUD_YR = #{audYr}
                                       AND AUD_NO = #{audNo}
                                       AND AUD_STEP_CD = #{audStepCd}
                                       AND APVR_CD IN 
                                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                                           #{item}
                                       </foreach>
                                       AND AFF_CD IN (SELECT AFF_CD
                                                        FROM TBBADDED145M
                                                       WHERE AUD_YR = #{audYr}
                                                         AND AUD_NO = #{audNo}
                                                         AND AUD_STEP_CD = #{audStepCd}
                                                         AND APVR_CD IN 
                                                         <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                                                             #{item}
                                                         </foreach> 
                                                         AND AFF_SNO = #{affSno}) ) 
               AND AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = #{audStepCd}
           <if test='apvrCd != null and apvrCd != ""'>
               AND APVR_CD IN 
                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
           </if>
    </insert>

    <insert id="updateAffCdDataReset" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.updateAffCdDataReset */
            UPDATE TBBADDED145M
               SET AFF_CD = '00'
                 , FNL_USR_ID = #{fnlUsrId}
                 , FNL_DEAL_DPT_CD = #{fnlDealDptCd}
                 , FNL_MNU_ID = #{fnlMnuId}
                 , FNL_MDF_DH = SYSDATE
             WHERE AFF_SNO IN (SELECT AFF_SNO
                                      FROM TBBADDED145M
                                     WHERE AUD_YR = #{audYr}
                                       AND AUD_NO = #{audNo}
                                       AND AUD_STEP_CD = #{audStepCd}
                                       AND APVR_CD IN 
                                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                                           #{item}
                                       </foreach>
                                       AND AFF_CD IN (SELECT AFF_CD
                                                        FROM TBBADDED145M
                                                       WHERE AUD_YR = #{audYr}
                                                         AND AUD_NO = #{audNo}
                                                         AND AUD_STEP_CD = #{audStepCd}
                                                         AND APVR_CD IN 
                                                         <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                                                             #{item}
                                                         </foreach> 
                                                         AND AFF_SNO = #{affSno}) ) 
               AND AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = #{audStepCd}
           <if test='apvrCd != null and apvrCd != ""'>
               AND APVR_CD IN 
                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
           </if>
    </insert>

    <select id="selectDelAffList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.selectDelAffList */
            SELECT BB.AUD_YR
                 , BB.TITLE_NM
                 , BB.AUD_STEP_CD
                 , BB.SORT_SNO
                 , BB.AFF_SNO
                 , AA.AUD_KND_CD
                 , CC.AFF_DSP_CD
                 , CC.DSP_RQ_CD
                 , CC.AFF_DSP_CD
                 , F_CODE_NM('1000002', CC.DSP_RQ_CD)  AS DSP_RQ_NM
                 , BB.AFF_CD || '-' || CC.AFF_DSP_CD AS AFFDSP_CD
                 , F_ORG_INFO(CC.RLTN_ORG_CD, 1) AS RLTN_ORG_NM
                 , CC.DOC_ID
                 , CC.RPRT_FILD_ID
                 , ZZ.PRE_AFF_NO
                 , (
                    SELECT GG.AUD_RPRT_DVSN_CD
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                         , TBBADDED103M GG
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND AA.AUD_NO = GG.AUD_NO
                       AND AA.AUD_NO = GG.AUD_NO
                       AND FF.DOC_ID = GG.DOC_ID
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = #{preAudStepCd}
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND EE.APVR_CD IN 
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                       AND ZZ.PRE_AFF_NO = F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                   ) AS PRE_AUD_RPRT_DVSN_CD
                 , BB.REFER_DVSN_CD
                 , F_CODE_NM('1000774', BB.REFER_DVSN_CD) AS REFER_DVSN_NM
                 , CASE 
                       WHEN BB.APVR_CD IN ('0015800','0035100','0058100','0045900','0055600','0055700','0010600','A1070') AND EE.RPRT_CD IN ('A10601100','A10601300','A10601320','A10601330','A10601340','A10601700')
                       THEN 'N'
                       ELSE 'Y'
                   END MPP_ABLE_YN
              FROM TBBADDED001M AA
                 , TBBADDED145M BB
                 , TBBADDED146M CC
                 , TBBADDED147M ZZ
                 , TBBADDED103M EE
             WHERE BB.AUD_YR = #{audYr}
               AND BB.AUD_NO = #{audNo}
               AND BB.AUD_YR = EE.AUD_YR
               AND BB.AUD_NO = EE.AUD_NO
               AND BB.DOC_ID = EE.DOC_ID
               AND AA.AUD_YR = BB.AUD_YR
               AND AA.AUD_NO = BB.AUD_NO
               AND AA.AUD_YR = CC.AUD_YR
               AND AA.AUD_NO = CC.AUD_NO
               AND ZZ.AUD_YR = BB.AUD_YR
               AND ZZ.AUD_NO = BB.AUD_NO
               AND BB.AFF_SNO = CC.AFF_SNO
               AND BB.AUD_STEP_CD = #{preAudStepCd}
               AND BB.AUD_STEP_CD = CC.AUD_STEP_CD
               AND ZZ.PRE_AFF_NO = F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || '-' || BB.AFF_CD || '-' || CC.AFF_DSP_CD
               AND ZZ.AUD_STEP_CD = #{nextAudStepCd}
           <if test='preApvrCd != null and preApvrCd != ""'>
               AND BB.APVR_CD IN 
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
               AND BB.APVR_CD = CC.APVR_CD
           </if>
           <if test='apvrCd != null and apvrCd != ""'>
               AND ZZ.APVR_CD IN
                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
           </if>
             ORDER BY  SORT_SNO
    </select>

    <select id="selectAffMpp" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.selectAffMpp */
                        WITH DATA AS ( SELECT MAX(F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-')) AS AUD_KEY
                            FROM TBBADDED147M AA 
                            WHERE AA.AUD_YR = #{audYr}
                            AND AA.AUD_NO = #{audNo}
                            AND AA.AUD_STEP_CD = #{audStepCd}
                            AND ROWNUM = 1
            )
            SELECT AA.PRE_AFF_NO
                  , AA.AFF_NO
                  , CC.DOC_ID
                  , AA.AUD_KND_CD
                  , DD.AUD_RPRT_DVSN_CD
                  , DECODE(#{preAudStepCd}, 'A1050', '10', (
                    SELECT MAX(GG.AUD_RPRT_DVSN_CD)
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                         , TBBADDED103M GG
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND AA.AUD_NO = GG.AUD_NO
                       AND AA.AUD_NO = GG.AUD_NO
                       AND FF.DOC_ID = GG.DOC_ID
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = #{preAudStepCd}
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND EE.APVR_CD IN 
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                       AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                    )) AS PRE_AUD_RPRT_DVSN_CD
                  , (
                    SELECT MAX(EE.APVR_CD)
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = #{preAudStepCd} 
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND EE.APVR_CD IN 
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                       AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                    ) AS APVR_CD
                  , (
                    SELECT EE.AFF_CD || '-' || FF.AFF_DSP_CD
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = #{preAudStepCd} 
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND EE.APVR_CD IN 
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                       AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                    ) AS AFFDSP_CD
                  , (
                    SELECT MAX(EE.TITLE_NM)
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = #{preAudStepCd} 
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND EE.APVR_CD IN 
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                       AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                    ) AS TITLE_NM
                  , (
                    SELECT MAX(F_CODE_NM('1000002', FF.DSP_RQ_CD))  AS DSP_RQ_NM
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = #{preAudStepCd} 
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND EE.APVR_CD IN
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                       AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                    ) AS DSP_RQ_NM
                  , (
                    SELECT F_ORG_INFO(FF.RLTN_ORG_CD, 1) AS RLTN_ORG_NM
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = #{preAudStepCd} 
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND EE.APVR_CD IN
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                       AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                    ) AS RLTN_ORG_NM
                  , (
                    SELECT MAX(FF.DOC_ID)
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = #{preAudStepCd} 
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND EE.APVR_CD IN
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                       AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                    ) AS DOC_ID
                  , (
                    SELECT MAX(FF.RPRT_FILD_ID)
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = #{preAudStepCd} 
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND EE.APVR_CD IN
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                       AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                    ) AS RPRT_FILD_ID
                  , CASE 
                        WHEN BB.APVR_CD IN ('0015800','0035100','0058100','0045900','0055600','0055700','0010600') AND DD.RPRT_CD IN ('A10601100','A10601300','A10601320','A10601330','A10601340','A10601700')
                        THEN 'N'
                        WHEN BB.APVR_CD ='0055700' 
                        THEN (
                              SELECT DECODE(COUNT(*), 0, 'N', 'Y')
                                FROM TBBADDED145M EE
                               WHERE EE.AUD_YR = CC.AUD_YR
                                 AND EE.AUD_NO = CC.AUD_NO
                                 AND EE.AUD_STEP_CD = CC.AUD_STEP_CD
                                 AND EE.APVR_CD = CC.APVR_CD
                                 AND EE.DOC_ID = CC.DOC_ID
                                 AND EE.REFER_DVSN_CD = 'D10'
                             )
                        ELSE 'Y'
                    END MPP_ABLE_YN
                 , (
                    SELECT DECODE(COUNT(T1.APV_DOC_NO), 0, 'Y', 'N')
                      FROM TBDCMACM023L T1 
                     WHERE DD.APV_RQS_ID = T1.APV_DOC_NO
                       AND T1.APVR_STA_CD IN ('202','203','204')
                       AND T1.APVR_PST_CD = BB.APVR_CD
                    ) AS MPP_CANCEL_YN
                 , (
                    SELECT MAX(EE.REFER_DVSN_CD)
                      FROM TBBADDED145M EE
                         , TBBADDED146M FF
                     WHERE AA.AUD_YR = EE.AUD_YR
                       AND AA.AUD_YR = FF.AUD_YR
                       AND AA.AUD_NO = EE.AUD_NO
                       AND AA.AUD_NO = FF.AUD_NO
                       AND EE.AFF_SNO = FF.AFF_SNO
                       AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                       AND EE.APVR_CD = FF.APVR_CD
                       AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                       AND EE.AUD_STEP_CD = #{preAudStepCd} 
                       AND EE.APVR_CD IN
                       <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                   ) AS REFER_DVSN_CD
                 , F_CODE_NM('1000774', (
                                        SELECT MAX(EE.REFER_DVSN_CD)
                                          FROM TBBADDED145M EE
                                             , TBBADDED146M FF
                                         WHERE AA.AUD_YR = EE.AUD_YR
                                           AND AA.AUD_YR = FF.AUD_YR
                                           AND AA.AUD_NO = EE.AUD_NO
                                           AND AA.AUD_NO = FF.AUD_NO
                                           AND EE.AFF_SNO = FF.AFF_SNO
                                           AND EE.AUD_STEP_CD = FF.AUD_STEP_CD
                                           AND EE.APVR_CD = FF.APVR_CD
                                           AND AA.PRE_AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || EE.AFF_CD || '-' || FF.AFF_DSP_CD
                                           AND EE.AUD_STEP_CD = #{preAudStepCd}  
                                           AND EE.APVR_CD IN
                                           <foreach collection="preApvrCd" item="item" index="index" separator="," open="(" close=")">
                                           #{item}
                                           </foreach>
                                       )) AS REFER_DVSN_NM
               FROM TBBADDED147M AA
                  , TBBADDED145M BB
                  , TBBADDED146M CC
                  , TBBADDED103M DD
              WHERE AA.AUD_YR = #{audYr}
                AND AA.AUD_NO = #{audNo}
                AND AA.AUD_YR = BB.AUD_YR
                AND AA.AUD_NO = BB.AUD_NO
                AND AA.AUD_YR = CC.AUD_YR
                AND AA.AUD_NO = CC.AUD_NO
                AND BB.AFF_SNO = CC.AFF_SNO
                AND AA.AUD_STEP_CD = #{audStepCd}
                AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                AND BB.AUD_STEP_CD = CC.AUD_STEP_CD
                AND AA.AUD_YR = DD.AUD_YR
                AND AA.AUD_NO = DD.AUD_NO
                AND CC.DOC_ID = DD.DOC_ID
                AND AA.AFF_NO = (SELECT AUD_KEY FROM DATA) || '-' || BB.AFF_CD || '-' || CC.AFF_DSP_CD
            <if test='apvrCd != null and apvrCd != ""'>
               AND AA.APVR_CD IN
                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
               AND BB.APVR_CD = CC.APVR_CD
               AND BB.APVR_CD = AA.APVR_CD
           </if>
    </select>

    <insert id="insertAffData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.insertAffData */
            INSERT INTO TBBADDED147M(
                        AUD_YR
                      , AUD_NO
                      , AUD_STEP_CD
                      , APVR_CD
                      , AUD_KND_CD
                      , PRE_AFF_NO
                      , AFF_NO
                      , AFF_SNO
                      , DSP_RQ_SNO
                      , DOC_ID
                      , MPP_SEQ
                      , RPRT_FILD_ID
                      , FRT_USR_ID
                      , FNL_USR_ID
                      , FNL_DEAL_DPT_CD
                      , FNL_MNU_ID
                      , FRT_REGI_DH
                      , FNL_MDF_DH
                        )
                 VALUES (
                        #{audYr}
                      , #{audNo}
                      , #{audStepCd}
                      , #{apvrCd}
                      , #{audKndCd}
                      , #{preAffNo}
                      , #{affNo}
                      , #{affSno}
                      , #{dspRqSno}
                      , #{docId}
                      , SEQ_MPP.NEXTVAL
                      , #{rprtFildId}
                      , #{frtUsrId}
                      , #{fnlUsrId}
                      , #{fnlDealDptCd}
                      , #{fnlMnuId}
                      , SYSDATE
                      , SYSDATE
                        )
    </insert>
    
    <insert id="deleteMppData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.deleteMppData */
            DELETE FROM TBBADDED147M
                  WHERE AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND AUD_STEP_CD = #{audStepCd}
                    AND APVR_CD IN 
                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
                <if test='preAffNo != null and preAffNo != ""'>
                    AND PRE_AFF_NO = #{preAffNo}
                </if>
                <if test='affSno != null and affSno != ""'>
                    AND AFF_SNO IN (SELECT AFF_SNO
                                      FROM TBBADDED145M
                                     WHERE AUD_YR = #{audYr}
                                       AND AUD_NO = #{audNo}
                                       AND AUD_STEP_CD = #{audStepCd}
                                       AND APVR_CD IN 
                                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                                           #{item}
                                       </foreach>
                                       AND AFF_CD IN (SELECT AFF_CD
                                                        FROM TBBADDED145M
                                                       WHERE AUD_YR = #{audYr}
                                                         AND AUD_NO = #{audNo}
                                                         AND AUD_STEP_CD = #{audStepCd}
                                                         AND APVR_CD IN 
                                                         <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                                                             #{item}
                                                         </foreach> 
                                                         AND AFF_SNO = #{affSno}) ) 
                </if>
    </insert>
    
    <insert id="updateRsnData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.updateRsnData */
            UPDATE TBBADDED147M 
               SET FNL_USR_ID = #{usrId}
                 , FNL_DEAL_DPT_CD = #{dptCd}
                 , FNL_MNU_ID = #{mnuId}
                 , FNL_MDF_DH = SYSDATE
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = #{audStepCd}
               AND APVR_CD = #{apvrCd}
           <if test='preAffNo != null and preAffNo != ""'>
               AND PRE_AFF_NO = #{preAffNo}
           </if>
           <if test='affNo != null and affNo != ""'>
               AND AFF_NO = #{affNo}
           </if>
    </insert>
    
    <select id="selectNextMppYn" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.selectNextMppYn */
            SELECT DECODE(COUNT(AA.AFF_NO),0,'N','Y') AS NEXT_MPP_YN
              FROM TBBADDED147M AA
             WHERE AA.AUD_YR = #{audYr}
               AND AA.AUD_NO = #{audNo}
               AND AA.AUD_STEP_CD = #{audStepCd}
               AND AA.APVR_CD IN
                       <foreach collection="apvrCd" item="item" index="index" separator="," open="(" close=")">
                       #{item}
                       </foreach>
               AND AA.AFF_SNO = #{affSno}
               AND AA.DSP_RQ_SNO = #{dspRqSno}
               AND EXISTS (SELECT 1
                             FROM TBBADDED147M BB
                            WHERE AA.AUD_YR = BB.AUD_YR
                              AND AA.AUD_NO = BB.AUD_NO
                              AND BB.AUD_STEP_CD = #{nAudStepCd}
                              AND BB.APVR_CD IN
                              <foreach collection="nApvrCd" item="item" index="index" separator="," open="(" close=")">
                              #{item}
                              </foreach>
                              AND AA.AFF_NO = BB.PRE_AFF_NO
                          )
    </select>
    
    <update id="updateReSbcnInfo" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.updateReSbcnInfo */
            UPDATE TBBADDED146M
                   SET HD_AUD_STEP_CD = #{hdAudStepCd}
                         , HD_DOC_ID = #{hdDocId} 
                         , HD_APVR_CD = #{hdApvrCd} 
                         , HD_AFF_SNO = #{hdAffSno} 
                         , HD_DSP_RQ_SNO = #{hdDspRqSno} 
                         , FNL_USR_ID = #{usrId}
                         , FNL_DEAL_DPT_CD = #{dptCd}
                         , FNL_MNU_ID = #{mnuId}
                         , FNL_MDF_DH = SYSDATE
               WHERE 
                    AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND AUD_STEP_CD = #{audStepCd}
                    AND DOC_ID = #{docId}
                    AND APVR_CD = #{apvrCd}
                    AND AFF_SNO = #{affSno}
                    AND DSP_RQ_SNO = #{dspRqSno}
    </update>
    
    
    <update id="resetReSbcnDfData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.resetReSbcnDfData */
        /*      */
            UPDATE TBBADDED146M
            SET 
                DF_AUD_STEP_CD = ''
                 , DF_DOC_ID = ''
                 , DF_APVR_CD = ''
                 , DF_AFF_SNO = ''
                 , DF_DSP_RQ_SNO = ''
                 , FNL_USR_ID = #{usrId}
                 , FNL_DEAL_DPT_CD = #{dptCd}
                 , FNL_MNU_ID = #{mnuId}
                 , FNL_MDF_DH = SYSDATE
            WHERE 
                    AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND DF_AUD_STEP_CD = #{audStepCd}
            AND DF_DOC_ID = #{docId} 
            AND DF_APVR_CD = #{apvrCd} 
            AND DF_AFF_SNO = #{affSno} 
            AND DF_DSP_RQ_SNO = #{dspRqSno}
    </update>
    
    <update id="updateReSbcnDfData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.updateReSbcnInfo */
        /*      */
        UPDATE TBBADDED146M
           SET DF_AUD_STEP_CD = #{audStepCd}
                 , DF_DOC_ID = #{docId} 
                 , DF_APVR_CD = #{apvrCd} 
                 , DF_AFF_SNO = #{affSno} 
                 , DF_DSP_RQ_SNO = #{dspRqSno} 
                 , FNL_USR_ID = #{usrId}
                 , FNL_DEAL_DPT_CD = #{dptCd}
                 , FNL_MNU_ID = #{mnuId}
                 , FNL_MDF_DH = SYSDATE
       WHERE 
            AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = #{hdAudStepCd}
            AND DOC_ID = #{hdDocId}
            AND APVR_CD = #{hdApvrCd}
            AND AFF_SNO = #{hdAffSno}
            AND DSP_RQ_SNO = #{hdDspRqSno};
    </update>
    
        <update id="updateReSbcnInfo2" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM003PMapper.updateReSbcnInfo2 */
            UPDATE TBBADDED146M
                   SET HD_AUD_STEP_CD = #{hdAudStepCd}
                         , HD_DOC_ID = #{hdDocId} 
                         , HD_APVR_CD = #{hdApvrCd} 
                         , HD_AFF_SNO = #{hdAffSno} 
                         , HD_DSP_RQ_SNO = #{hdDspRqSno} 
               WHERE 
                    AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND AUD_STEP_CD = #{audStepCd}
                    AND APVR_CD = #{apvrCd}
                   AND AFF_SNO = (SELECT AFF_SNO 
                                                  FROM TBBADDED147M
                                                 WHERE AUD_YR = #{audYr}
                                                   AND AUD_NO = #{audNo}
                                                   AND AUD_STEP_CD = #{audStepCd}
                                                   AND APVR_CD = #{apvrCd}
                                                   AND AFF_NO = #{affNo} )
                   AND DSP_RQ_SNO = (SELECT DSP_RQ_SNO 
                                                  FROM TBBADDED147M
                                                 WHERE AUD_YR = #{audYr}
                                                   AND AUD_NO = #{audNo}
                                                   AND AUD_STEP_CD = #{audStepCd}
                                                   AND APVR_CD = #{apvrCd}
                                                   AND AFF_NO = #{affNo})
    </update>
    
</mapper> 