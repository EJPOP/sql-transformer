<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.arp.dao.AEPARP017QMapper">
    
   <select id="selectLawList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP017QMapper.selectLawList*/
        <![CDATA[
            SELECT LEGAL_REQ_DVSN_CD
                 , AUD_YR_NO
                 , AFF_NO
                 , AFF_NO AS AFF_NO_REGI
                 , TITLE_NM
                 , RQS_DOC_NM
                 , RQS_DOC_NM AS V_RQS_DOC_NM
                 , RQS_DOC_ID
                 , RQS_DOC_SND_DT
                 , RQS_DOC_APV_STA_CD
                 , NVL(F_CODE_NM('1000773', RQS_DOC_APV_STA_CD), '미작성') AS RQS_DOC_APV_STA_NM
                 , RQS_DOC_APV_RQS_ID
                 , NVL(RQS_DOC_SND_DT, '미발신') RQS_DOC_SND_STA_NM
                 , OPIN_DOC_NM
                 , OPIN_DOC_NM AS V_OPIN_DOC_NM
                 , OPIN_DOC_ID
                 , OPIN_DOC_RCPT_NM
                 , EXAM_DOC_NM
                 , EXAM_DOC_NM AS V_EXAM_DOC_NM
                 , EXAM_DOC_ID
                 , EXAM_DOC_APV_STA_CD
                 , NVL(F_CODE_NM('1000773', EXAM_DOC_APV_STA_CD), '미작성') AS EXAM_DOC_APV_STA_NM
                 , EXAM_DOC_APV_RQS_ID
                 , WRK_YR
                 , WRK_NO
                 , AUD_STEP_CD
                 , LEGAL_REQ_SRNO
                 , AUD_DOC_ID
                 , AFF_SNO
                 , APVR_CD
                 , TRTM_DOC_ID
                 , REQ_STAT_CD
                 , F_CODE_NM('1000830', REQ_STAT_CD) AS REQ_STAT_NM
                 , SUPPLM_REQ_CNT
                 , WRK_DVSN_CD
                 , (SELECT MAX(ST2.AUD_KND_CD) FROM TBBADDED001M ST2 WHERE ST2.AUD_YR = WRK_YR AND ST2.AUD_NO = WRK_NO) AS AUD_KND_CD
              FROM (
                SELECT T1.LEGAL_REQ_DVSN_CD
                     , F_MNG_KND_AUDYRNO(T1.WRK_YR, T1.WRK_NO, '', '-') AS AUD_YR_NO
                     , CASE WHEN T1.LEGAL_REQ_DVSN_CD = '50'  THEN '-' 
                                ELSE DECODE(T2.AFF_CD, NULL, '', F_MNG_KND_AUDYRNO(T1.WRK_YR, T1.WRK_NO, '', '-') || '-' || T2.AFF_CD) END AS AFF_NO
                     , CASE WHEN T1.LEGAL_REQ_DVSN_CD = '50' THEN (SELECT T5.RPRT_NM 
                                                                                      FROM TBBADDED103M T5 
                                                                                     WHERE T5.AUD_YR = T1.WRK_YR
                                                                                        AND T5.AUD_NO = T1.WRK_NO
                                                                                        AND T5.DOC_ID = T1.AUD_DOC_ID 
                                                                                        AND T5.RPRT_CD = 'A10601700')
                               ELSE T2.TITLE_NM END AS TITLE_NM
                     , (SELECT MAX(RPRT_NM)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_NM
                     , (SELECT MAX(DOC_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_ID
                     , (SELECT TO_CHAR(MAX(SND_DH), 'YYYY-MM-DD')
                          FROM TBBADDED111M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND RCPT_DPT_CD = '160100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_SND_DT
                     , (SELECT MAX(APV_STA_CD)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_APV_STA_CD
                     , (SELECT MAX(APV_RQS_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_APV_RQS_ID
                     , (SELECT MAX(RPRT_NM)
                          FROM TBBADDED111M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602300'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS OPIN_DOC_NM
                     , (SELECT MAX(DOC_ID)
                          FROM TBBADDED111M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602300'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS OPIN_DOC_ID
                     , NVL((SELECT MAX('수신('||TO_CHAR(RCPT_DH, 'YYYY-MM-DD')||')')
                          FROM TBBADDED111M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602300'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)), '미수신') AS OPIN_DOC_RCPT_NM
                     , (SELECT MAX(RPRT_NM)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602400'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS EXAM_DOC_NM
                     , (SELECT MAX(DOC_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602400'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS EXAM_DOC_ID
                     , (SELECT APV_STA_CD
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602400'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS EXAM_DOC_APV_STA_CD
                     , (SELECT MAX(APV_RQS_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602400'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS EXAM_DOC_APV_RQS_ID
                     , (SELECT MAX(DOC_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602200'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS TRTM_DOC_ID
                     ,(SELECT COUNT(T3.DOC_ID) AS CNT
                        FROM TBBADDED111M T3
                       WHERE T3.AUD_YR = T1.WRK_YR
                          AND T3.AUD_NO = T1.WRK_NO
                          AND T3.RPRT_CD IN  ('A10602100', 'A10602200')
                          AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                          AND T3.REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)
                          AND T3.DOC_STA_CD = '51'
                       ) AS SUPPLM_REQ_CNT
                     , T1.WRK_YR
                     , T1.WRK_NO
                     , T1.AUD_STEP_CD
                     , T1.LEGAL_REQ_SRNO
                     , T1.AUD_DOC_ID   /*전자감사문서ID*/
                     , T2.AFF_SNO
                     , T2.APVR_CD
                     , T1.REQ_STAT_CD
                     , T1.WRK_DVSN_CD
                  FROM TBBADDED126M T1
                  LEFT OUTER JOIN (SELECT ST1.AUD_YR
                                          , ST1.AUD_NO
                                          , ST1.AFF_SNO
                                          , ST1.AFF_CD
                                          , ST1.APVR_CD
                                          , ST1.TITLE_NM
                                          , ST1.RPRT_FILD_ID
                                      FROM TBBADDED145M ST1
                                     WHERE ST1.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
                                                            FROM (
                                                                SELECT RANK() OVER (PARTITION BY H.DOC_ID ORDER BY DECODE(H.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
                                                                     , H.APVR_CD
                                                                     , H.DOC_ID
                                                                     , H.AUD_YR
                                                                     , H.AUD_NO
                                                                  FROM TBBADDED145M H
                                                                 WHERE H.APVR_CD <> '0010200'
                                                                 GROUP BY H.DOC_ID, H.APVR_CD, H.AUD_YR, H.AUD_NO)   
                                                           WHERE RN = 1 
                                                             AND ST1.DOC_ID = DOC_ID
                                                             AND ST1.AUD_YR = AUD_YR
                                                             AND ST1.AUD_NO = AUD_NO)) T2 ON (    T1.WRK_YR = T2.AUD_YR
                                                                                              AND T1.WRK_NO = T2.AUD_NO
                                                                                              AND T1.AFF_SNO = T2.AFF_SNO)
                 WHERE T1.WRK_YR = #{audYr}
                   AND T1.WRK_NO = #{audNo}
                      )
             ORDER BY DECODE(REQ_STAT_CD, '70', '30', REQ_STAT_CD), LEGAL_REQ_SRNO DESC
        ]]>
    </select>
    
    <select id="selectMainTskPrcsList" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.arp.dao.AEPARP016QMapper.selectMainTskPrcsList */
        
        /*실지감사 주요업무 프로세스 sql*/
        SELECT A.AUD_MAIN_STEP_ID  /*주요업무코드*/
             , A.AUD_STEP_CD /*감사단계코드*/
             , A.AUD_MAIN_STEP_SNO  /*주요업무순번 */
             , A.AUD_MAIN_SEQ_W /*주요업무순서_가로 */
             , A.AUD_MAIN_SEQ_H /*주요업무순서_세로 */
             , (CASE WHEN A.AUD_MAIN_STEP_ID = '970101' 			 THEN (SELECT (CASE WHEN T1.AFF_SNO IS NOT NULL THEN 'Y'
                                                                                                               WHEN T1.AUD_DOC_ID IS NOT NULL  THEN 'Y' 
                                                                                                                ELSE 'N' END) 
																	         FROM TBBADDED126M T1
																			WHERE T1.WRK_DVSN_CD = #{wrkDvsnCd}
																			  AND T1.WRK_YR = #{wrkYr}
																			  AND T1.WRK_NO = #{wrkNo}
																			  AND T1.AUD_STEP_CD = #{audStepCd2}
																			  AND T1.LEGAL_REQ_DVSN_CD = #{legalReqDvsnCd}
																			  AND T1.LEGAL_REQ_SRNO = #{legalReqSrno})             -- 개별사건연결
                     WHEN A.AUD_MAIN_STEP_ID = '970201' 		     THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																	         FROM TBBADDED103M T1
																			WHERE T1.AUD_YR = #{wrkYr}
																			  AND T1.AUD_NO = #{wrkNo}
																			  AND T1.RPRT_CD IN ('A10602100','E10400300','D10200500') 
																			  AND T1.REF_ID = #{legalReqSrno})             -- 법률자문요청서작성
                     WHEN A.AUD_MAIN_STEP_ID = '970301'              THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																	         FROM TBBADDED103M T1
																			WHERE T1.AUD_YR = #{wrkYr}
																			  AND T1.AUD_NO = #{wrkNo}
																			  AND T1.RPRT_CD = 'A10602310'
																			  AND T1.REF_ID = #{legalReqSrno}
																			  AND T1.APV_STA_CD IN ('20','25','29','30') )             -- 법률자문의견서 보고
				     WHEN A.AUD_MAIN_STEP_ID = '970401'              THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																	         FROM TBBADDED103M T1
																			WHERE T1.AUD_YR = #{wrkYr}
																			  AND T1.AUD_NO = #{wrkNo}
																			  AND T1.RPRT_CD IN ('A10602400','E10400700','D10200900')
																			  AND T1.REF_ID = #{legalReqSrno})		             -- 법률자문검토보고서 작성
                                                     			     ELSE A.CMPT_YN
                 END)             AS CMPT_YN /*완료여부*/
             , A.AUD_GRN_NO  /*감사부여번호*/
             , A.AUD_DOC_CD /*문서ID*/
             , TRIM(A.MAIN_JOB_NM) AS MAIN_JOB_NM /*주요업무명*/
             , TRIM(A.LINK_TYPE) AS LINK_TYPE/*링크유형*/
             , DECODE(TRIM(A.LINK_TYPE), 'NAN', ''
                                 , 'POP', A.LINK_URL
                                 , 'FNC', A.LINK_URL
                                 , (SELECT DOC_ID
                                      FROM TBFDMADM002M B
                                     WHERE A.AUD_DOC_CD = B.AUD_DOC_CD
                                       AND B.DOC_KND_CD = DECODE(A.LINK_TYPE, 'DOC', '10', '20')
                                       AND NVL(AUD_RPRT_TYPE_CD, SUBSTR(A.AUD_KND_CD, 3, 3)) = SUBSTR(A.AUD_KND_CD, 3, 3)
                                   <if test='audStepCd == "A1050"'>
                                       AND B.DTIL_AUD_DOC_NO = DECODE(B.AUD_DOC_CD,'A10500100','162',
                                                                    (SELECT CASE WHEN T1.REQ_DVSN_CD IN ('2', '3') THEN '394'
                                                                            ELSE '163'
                                                                       END
                                                                  FROM TBBADDED001M T1
                                                                 WHERE T1.AUD_YR = #{audYr}
                                                                   AND T1.AUD_NO = #{audNo}
                                                                  ))
                                   </if>
                                   )
                     ) AS LINK_URL /*링크주소*/
          FROM TBBADDED102M A
         WHERE 1=1
        <if test='audYr != null and audYr != ""'>
           AND A.AUD_YR = #{audYr} /* PARAM : 감사년도 */
        </if>
        <if test='audNo != null and audNo != ""'>
           AND A.AUD_NO = #{audNo}/* PARAM : 감사연번(내부  pk 번호) */
        </if>
        <if test='audKndCd != null and audKndCd != ""'>
           AND A.AUD_KND_CD = #{audKndCd}
        </if>
        <if test='audStepCd != null and audStepCd != ""'>
           AND A.AUD_STEP_CD = #{audStepCd} /* PARAM : 감사단계코드  */
        </if>
        <if test='audMainStepSno != null and audMainStepSno != ""'>
           AND A.AUD_MAIN_STEP_SNO = #{audMainStepSno} /* PARAM : 주요업무 순번  */
        </if>
        <if test='audMainStepDsvnCd != null and audMainStepDsvnCd != ""'>
           AND SUBSTR(A.AUD_MAIN_STEP_ID,0,2) = #{audMainStepDsvnCd} /* PARAM : 주요업무구분코드(AUD_MAIN_STEP_ID 앞 2자리) */
        </if>
         ORDER BY A.AUD_MAIN_STEP_SNO, A.AUD_MAIN_SEQ_W ASC
    </select>
        
        
</mapper>