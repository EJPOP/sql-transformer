<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper">
    
    <!-- 포렌식 요청 목록 조회 -->
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap" >
        <![CDATA[
        /* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.selectMainList */
        SELECT T1.AUD_YR           /* 감사년도 */
              ,T1.AUD_NO           /* 감사번호 */
              ,F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, '', '-') AS AUD_YR_NO /* 분류번호 */
              ,T1.FRS_REQ_SRNO     /* 포렌식 요청 일련번호 */
              ,T1.AUD_STEP_CD      /* 감사단계코드 */
              ,T2.AUD_KND_CD       /* 감사종류 */
              ,T1.FRS_REQ_DVSN_CD  /* 포렌식 요청 구분 코드 */
              ,T1.REQ_DPT_CD       /* 요청부서코드 */
              ,T1.REQ_DH           /* 요청일시 */
              ,TO_CHAR(T1.REQ_DH,'yyyy-MM-dd') AS REQ_DT /* 요청일자 */
              ,T1.REQ_CNB          /* 요청자전산번호 */
              ,T1.REQ_STAT_CD      /* 요청상태코드 */
              ,F_CODE_NM('1000994',T1.REQ_STAT_CD) AS REQ_STAT_NM /* 요청상태명 */
              ,DECODE(T1.REQ_STAT_CD,'90',T1.DOC_ID,'') AS DOC_ID
              ,(SELECT F_CODE_NM('1000773',A.APV_STA_CD) 
                  FROM TBBADDED103M A
				 WHERE A.AUD_YR = T1.AUD_YR
				   AND A.AUD_NO = T1.AUD_NO
				   AND A.RPRT_CD = 'A10610100'
				   AND A.REF_ID = T1.FRS_REQ_SRNO ) AS REQ_DOC_APV_STA_NM /* 요청서 작성,결재상태 */
              ,T1.ORG_CD	       /* 대상기관코드 */
              ,F_ORG_INFO(T1.ORG_CD, '1') AS ORG_NM /* 대상기관명 */
              ,T1.FRS_DPT_RCP_YN   /* 포렌식 법무부서 접수여부 */
              ,T1.FRS_DPT_RCP_DH   /* 포렌식 법무부서 접수일시 */
              ,T1.REV_OPT_RCV_YN   /* 검토의견서 수신여부 */
              ,T1.REV_OPT_RCV_DH   /* 검토의견서 수신일시 */
              ,T1.REV_OPT_OM_YN    /* 검토의견서 발신여부 */
              ,T1.REV_OPT_OM_DH    /* 검토의견서 발신일시 */
              ,(SELECT F_CODE_NM('1000773',A.APV_STA_CD) 
                  FROM TBBADDED103M A
				 WHERE A.AUD_YR = T1.AUD_YR
				   AND A.AUD_NO = T1.AUD_NO
				   AND A.RPRT_CD = 'A10610210'
				   AND A.REF_ID = T1.FRS_REQ_SRNO ) AS REV_DOC_APV_STA_NM /* 의견서 작성,결재상태 */ 
              ,T1.HNDL_DH          /* 처리일시 */
              ,T1.HNDL_PEN_CNB     /* 처리자전산번호 */
              ,T1.HNDL_DPT_CD      /* 처리부서코드 */
              ,T1.HNDL_RPT_RCV_YN  /* 처리보고서 수신여부 */
              ,T1.HNDL_RPT_RCV_DH  /* 처리보고서 수신일시 */
              ,T1.HNDL_RPT_OM_YN   /* 처리보고서 발신여부 */
              ,(SELECT F_CODE_NM('1000773',A.APV_STA_CD) 
                  FROM TBBADDED103M A
				 WHERE A.AUD_YR = T1.AUD_YR
				   AND A.AUD_NO = T1.AUD_NO
				   AND A.RPRT_CD = 'A10610300'
				   AND A.REF_ID = T1.FRS_REQ_SRNO ) AS HNDL_DOC_APV_STA_NM /* 처리서 작성,결재상태 */
              ,(SELECT TO_CHAR(RCPT_DH,'YYYYMMDD')
                  FROM TBBADDED111M A
				 WHERE A.AUD_YR = T1.AUD_YR
				   AND A.AUD_NO = T1.AUD_NO
				   AND A.RPRT_CD = 'A10610300'
				   AND A.REF_ID = T1.FRS_REQ_SRNO ) AS HNDL_RCPT_DT /* 처리서 수신일자 */ 
			  ,(SELECT MAX(DOC_ID) FROM TBAEPFRS101L WHERE AUD_YR = T1.AUD_YR AND AUD_NO = T1.AUD_NO AND FRS_REQ_SRNO = T1.FRS_REQ_SRNO AND FILE_DVSN = 'AG') AS DOC_ID2	   
         FROM
        ]]>
               TBAEPFRS101M T1, TBBADDED001M T2 
        WHERE
               T1.AUD_YR = T2.AUD_YR
          AND  T1.AUD_NO = T2.AUD_NO
          AND  T1.AUD_YR = #{audYr}
          AND  T1.AUD_NO = #{audNo}
        
    </select>
   
    <!-- 실지감사 주요업무 프로세스 조회 -->
    <select id="selectMainTskPrcsList" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.selectMainTskPrcsList */
        SELECT A.AUD_MAIN_STEP_ID  /* 주요업무코드 */
             , A.AUD_STEP_CD       /* 감사단계코드 */
             , A.AUD_MAIN_STEP_SNO /* 주요업무순번 */
             , A.AUD_MAIN_SEQ_W    /* 주요업무순서_가로 */
             , A.AUD_MAIN_SEQ_H    /* 주요업무순서_세로 */
             , (CASE WHEN A.AUD_MAIN_STEP_ID = '980101' THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																FROM TBBADDED103M T1
															   WHERE T1.AUD_YR = #{audYr}
																 AND T1.AUD_NO = #{audNo}
																 AND T1.RPRT_CD = 'A10610100'
																 AND T1.REF_ID = #{frsReqSrno})                     -- 포렌식 요청서
                     WHEN A.AUD_MAIN_STEP_ID = '980201' THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																FROM TBBADDED103M T1
															   WHERE T1.AUD_YR = #{audYr}
																 AND T1.AUD_NO = #{audNo}
																 AND T1.RPRT_CD = 'A10610300'
																 AND T1.REF_ID = #{frsReqSrno}
																 AND T1.APV_STA_CD = '30' )       -- 포렌식 처리 명세서
				     WHEN A.AUD_MAIN_STEP_ID = '980301' THEN (SELECT (CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END) 
																FROM TBBADDED108D T1
															   WHERE T1.AUD_YR = #{audYr}
																 AND T1.AUD_NO = #{audNo}
																 AND T1.EVI_DCM_DVSN_CD = '80')
					ELSE A.CMPT_YN
                     END ) AS CMPT_YN /* 완료여부 */
             , A.AUD_GRN_NO /* 감사부여번호 */
             , A.AUD_DOC_CD /* 문서ID */
             , TRIM(A.MAIN_JOB_NM) AS MAIN_JOB_NM /* 주요업무명 */
             , TRIM(A.LINK_TYPE) AS LINK_TYPE /* 링크유형 */
             , DECODE(TRIM(A.LINK_TYPE), 'NAN', ''
                                       , 'POP', A.LINK_URL
                                       , 'FNC', A.LINK_URL
                                       , (SELECT DOC_ID
                                            FROM TBFDMADM002M B
                                           WHERE A.AUD_DOC_CD = B.AUD_DOC_CD
                                             AND B.DOC_KND_CD = DECODE(A.LINK_TYPE, 'DOC', '10', '20')
                                             AND NVL(AUD_RPRT_TYPE_CD, SUBSTR(A.AUD_KND_CD, 3, 3)) = SUBSTR(A.AUD_KND_CD, 3, 3)
                                         )
                     ) AS LINK_URL /* 링크주소 */
          FROM TBBADDED102M A
         WHERE 1=1
        <if test='audYr != null and audYr != ""'>
           AND A.AUD_YR = #{audYr} /* PARAM : 감사년도 */
        </if>
        <if test='audNo != null and audNo != ""'>
           AND A.AUD_NO = #{audNo} /* PARAM : 감사연번(내부  pk 번호) */
        </if>
        <if test='audKndCd != null and audKndCd != ""'>
           AND A.AUD_KND_CD = #{audKndCd}
        </if>
        <if test='audStepCd != null and audStepCd != ""'>
           AND A.AUD_STEP_CD = #{audStepCd} /* PARAM : 감사단계코드  */
        </if>
        <if test='audMainStepSno != null and audMainStepSno != ""'>
           AND A.AUD_MAIN_STEP_SNO = #{audMainStepSno} /* PARAM : 주요업무 순번  */
        </if>
        <if test='audMainStepDsvnCd != null and audMainStepDsvnCd != ""'>
           AND SUBSTR(A.AUD_MAIN_STEP_ID,0,2) = #{audMainStepDsvnCd} /* PARAM : 주요업무구분코드(AUD_MAIN_STEP_ID 앞 2자리) */
        </if>
         ORDER BY A.AUD_MAIN_STEP_SNO, A.AUD_MAIN_SEQ_W ASC
    </select>   
    
    <!-- 문서 ID 조회 -->
    <select id="selectDocId" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.selectDocId */
        <![CDATA[
            SELECT MAX(DOC_ID) AS DOC_ID
              FROM TBFDMADM002M
             WHERE AUD_DOC_CD = #{rprtCd}
        ]]>
    </select>
    
    <!-- 포렌식 관련 문서 조회 -->
    <select id="selectRprtApvList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.selectRprtApvList*/
        <![CDATA[
            SELECT G1.RPRT_NM
                  ,G1.RPRT_NM AS V_RPRT_NM
                  ,G1.APV_STA_CD
                  ,G1.APV_STA_NM
                  ,G1.DOC_ID
                  ,G1.APV_RQS_ID
                  ,(SELECT T5.AUD_SBJ_NM FROM TBBADDED001M T5 WHERE G1.AUD_YR = T5.AUD_YR AND G1.AUD_NO = T5.AUD_NO) AS AUD_SBJ_NM
                  ,MAX(G1.APV_INFO_1) AS APV_INFO_1
                  ,MAX(G1.APV_INFO_2) AS APV_INFO_2
                  ,MAX(G1.APV_INFO_3) AS APV_INFO_3
                  ,MAX(G1.APV_INFO_4) AS APV_INFO_4
                  ,MAX(G1.APV_INFO_5) AS APV_INFO_5
                  ,MAX(G1.APV_INFO_6) AS APV_INFO_6
                  ,MAX(G1.APV_INFO_7) AS APV_INFO_7
                  ,(
                    SELECT DECODE(COUNT(1), 0, 'N', 'Y')
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                   ) AS SEND_YN
                    ,(
                    SELECT T3.DOC_STA_CD
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS SEND_STA_CD
                   ,(
                    SELECT T3.SUPPLM_REQ
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS SUPPLM_REQ
                   ,(
                    SELECT T3.RCPT_DPT_CD
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS RCPT_DPT_CD
                   ,(
                    SELECT DECODE(T3.RCPT_DPT_CD, '160100', '법무담당관') 
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS RCPT_DPT_NM
                  ,G1.RPRT_CD
                  , G1.DOC_WRT_ID
                  , (SELECT DECODE(COUNT(1), 0, 'N', 'Y') FROM TBDCMACM023H ST1 WHERE ST1.APV_DOC_NO = G1.APV_RQS_ID AND ST1.APVR_STA_CD NOT IN ('301', '201')) AS APV_HIS_YN
                  , G1.DOC_TYPE
              FROM (
                SELECT AUD_YR
                      ,AUD_NO
                      ,RPRT_CD
                      ,RPRT_NM
                      ,APV_STA_CD
                      ,APV_STA_NM
                      ,DOC_ID
                      ,APV_RQS_ID
                      ,DOC_WRT_ID
                      ,DOC_TYPE
                      ,DECODE(ROW_ID, 1, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_1
                      ,DECODE(ROW_ID, 2, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_2
                      ,DECODE(ROW_ID, 3, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_3
                      ,DECODE(ROW_ID, 4, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_4
                      ,DECODE(ROW_ID, 5, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_5
                      ,DECODE(ROW_ID, 6, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_6
                      ,DECODE(ROW_ID, 7, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_7
                  FROM (
                    SELECT AUD_YR
                          ,AUD_NO
                          ,RPRT_CD
                          ,RPRT_NM
                          ,APV_STA_CD
                          ,APV_STA_NM
                          ,DOC_ID
                          ,APV_RQS_ID
                          ,PST_NM
                          ,APVR_NM
                          ,APV_DH
                          ,DOC_WRT_ID
                          ,DOC_TYPE
                          ,ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SNO) AS ROW_ID 
                      FROM (
                        SELECT T1.AUD_YR
                              ,T1.AUD_NO
                              ,T1.RPRT_CD
                              ,T1.RPRT_NM
                              ,T1.APV_STA_CD
                              ,F_CODE_NM('1000773',APV_STA_CD) AS APV_STA_NM
                              ,T1.DOC_ID
                              ,T2.APV_SNO
                              ,T1.APV_RQS_ID
                              ,T1.DOC_WRT_ID
                              ,CASE WHEN APVR_PST_CD IS NULL
                                    THEN (SELECT MAX(ONR_PST_NM) FROM TBDCMACM001M WHERE CNB = APVR_CNB)
                                    ELSE F_CODE_NM('1000176', T2.APVR_PST_CD)
                               END  AS PST_NM
                              ,F_USR_INFO(T2.APVR_CNB, '2') AS APVR_NM
                              ,CASE WHEN SUBSTR(T2.APVR_STA_CD,0,1) = '2' THEN TO_CHAR(T2.APV_DH, 'YYYY-MM-DD')
                                    ELSE ''
                               END  AS APV_DH
                             , F_OPEN_EDIT(T1.LINK_URL) AS DOC_TYPE
                          FROM TBBADDED103M T1
                         LEFT OUTER JOIN TBDCMACM023L T2 ON
                                    T1.APV_RQS_ID = T2.APV_DOC_NO
                                AND T2.APV_SNO <> '1' --(기안자 제외)
                                AND T2.APVR_KND_CD <> '4' --(협조자 제외)
                         WHERE T1.AUD_YR = #{audYr}
                           AND T1.AUD_NO = #{audNo}
                           AND T1.RPRT_CD = 'A10610100'
                           AND T1.REF_ID = #{frsReqSrno}
                            ) 
                        )
                    ) AS G1
            GROUP BY G1.AUD_YR
                    ,G1.AUD_NO
                    ,G1.RPRT_CD
                    ,G1.RPRT_NM
                    ,G1.APV_STA_CD
                    ,G1.APV_STA_NM
                    ,G1.DOC_ID
                    ,G1.APV_RQS_ID
                    ,G1.DOC_WRT_ID
                    ,G1.DOC_TYPE
        ]]>
    </select> 
    
    <!-- 포렌식 수신 문서 조회 -->
    <select id="selectRprtRcptList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.selectRprtRcptList*/
        <![CDATA[
            SELECT RPRT_NM
                 , DOC_ID
                 , '수신' AS STA_NM
                 , F_DPT_INFO(SND_DPT_CD, 1) AS SND_DPT_NM
                 , TO_CHAR(SND_DH, 'YYYY-MM-DD') AS SND_DT
                 , F_DPT_INFO(RCPT_DPT_CD, 1) AS RCPT_DPT_NM
                 , TO_CHAR(RCPT_DH, 'YYYY-MM-DD') AS RCPT_DT
                 , F_OPEN_EDIT(LINK_URL) AS DOC_TYPE
              FROM TBBADDED111M 
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND RPRT_CD = 'A10610210'
               AND REF_ID = #{frsReqSrno}
               
            UNION ALL
        
            SELECT RPRT_NM
                 , DOC_ID
                 , '수신' AS STA_NM
                 , F_DPT_INFO(SND_DPT_CD, 1) AS SND_DPT_NM
                 , TO_CHAR(SND_DH, 'YYYY-MM-DD') AS SND_DT
                 , F_DPT_INFO(RCPT_DPT_CD, 1) AS RCPT_DPT_NM
                 , TO_CHAR(RCPT_DH, 'YYYY-MM-DD') AS RCPT_DT
                 , F_OPEN_EDIT(LINK_URL) AS DOC_TYPE
              FROM TBBADDED111M 
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND RPRT_CD = 'A10610300'
               AND REF_ID = #{frsReqSrno}

        ]]>
    </select>
    
    <!-- 포렌식 자료매체 목록 조회 -->
	<select id="selectMdmList" parameterType="paramMap" resultType="egovMap">
	/* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.selectMdmList */
        <![CDATA[
        	SELECT ROWNUM AS NUM    /* 순번 */
        		  ,T1.AUD_YR        /* 감사년도 */
        		  ,T1.AUD_NO        /* 감사번호 */
        		  ,T2.FRS_REQ_SRNO  /* 포렌식 요청 일련번호 */
        		  ,T2.FRS_TG_SRNO   /* 매체 일련번호 */
        		  ,TO_CHAR(TO_DATE(T2.FRS_CLC_DT),'yyyy-mm-dd') AS FRS_CLC_DT /* 수집일자 */
        		  ,T2.FRS_TG        /* 대상   */
        		  ,T2.ORG_NM        /* 소속기관  */
        		  ,T2.DPT_NM        /* 소속부서  */
        	  FROM TBAEPFRS101M T1
        		  ,TBAEPFRS102M T2
        	 WHERE 1=1
        	   AND T1.AUD_YR = T2.AUD_YR
        	   AND T1.AUD_NO = T2.AUD_NO
        	   AND T1.FRS_REQ_SRNO = T2.FRS_REQ_SRNO
        	   AND T1.AUD_YR = #{audYr}
        	   AND T1.AUD_NO = #{audNo}
        	   AND T1.FRS_REQ_SRNO = #{frsReqSrno}
        	   AND T1.REQ_STAT_CD = '90'
          ORDER BY T2.FRS_TG_SRNO
		]]>
	</select>
	
    <!-- 포렌식 자료매체 상세 목록 조회 -->
	<select id="selectMdmDtlList" parameterType="paramMap" resultType="egovMap">
	/* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.selectMdmDtlList */
        <![CDATA[
        	SELECT ROWNUM AS NUM    /* 순번 */
        		  ,T1.AUD_YR        /* 감사년도 */
        		  ,T1.AUD_NO        /* 감사번호 */
        		  ,T1.FRS_REQ_SRNO  /* 포렌식 요청 일련번호 */
        		  ,T1.FRS_TG_SRNO   /* 대상일련번호 */
        		  ,T2.SRNO          /* 매체일련번호 */
        		  ,T2.FRS_TYPE_CD   /* 매체구분코드 */
        		  ,TO_CHAR(TO_DATE(T2.FRS_DT),'yyyy-mm-dd') AS FRS_DT /* 일자 */
        		  ,F_CODE_NM('1000802',T2.FRS_TYPE_CD) AS FRS_TYPE_NM
        		  ,T2.USR_TYPE      /* 구분  */
        		  ,F_CODE_NM('1000995',T2.USR_TYPE) AS USR_TYPE_NM
        		  ,T2.MDM_ETP       /* 제조사  */
        		  ,T2.MDM_SRNO      /* 일련번호,시리얼  */
        		  ,T2.MDM_MD        /* 모델  */
        		  ,T2.MDM_CPT       /* 용량  */
        		  ,T2.USR_TNB       /* 계정정보  */
        		  ,T2.USR_ACCT      /* 전화번호  */
        		  ,T2.USIM          /* 유심  */
        		  ,T2.EXTL_DRIV     /* 외부메모리  */
        		  ,T2.RMK_TXT       /* 비고  */
        	  FROM TBAEPFRS102M T1
        		  ,TBAEPFRS102D T2
        	 WHERE 1=1
        	   AND T1.AUD_YR = T2.AUD_YR
        	   AND T1.AUD_NO = T2.AUD_NO
        	   AND T1.FRS_REQ_SRNO = T2.FRS_REQ_SRNO
        	   AND T1.FRS_TG_SRNO = T2.FRS_TG_SRNO
        	   AND T1.AUD_YR = #{audYr}
        	   AND T1.AUD_NO = #{audNo}
        	   AND T1.FRS_REQ_SRNO = #{frsReqSrno}
        	   AND T2.FRS_TG_SRNO = #{frsTgSrno}
          ORDER BY T2.SRNO
		]]>
	</select> 
   
    <insert id="insertFrsReq" parameterType="paramMap">
    /* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.insertFrsReq */
            INSERT INTO TBAEPFRS101M(
                    AUD_YR           /* 감사년도 */
                   ,AUD_NO           /* 감사번호 */
                   ,FRS_REQ_SRNO     /* 포렌식 요청 일련번호 */
                   ,AUD_STEP_CD      /* 감사단계코드 */
                   ,FRS_REQ_DVSN_CD  /* 포렌식 요청 구분 코드 */
                   ,REQ_DPT_CD       /* 요청부서코드 */
                   ,REQ_DH           /* 요청일시 */
                   ,REQ_CNB          /* 요청자전산번호 */
                   ,ORG_CD	         /* 대상기관코드 */
                   ,REQ_STAT_CD      /* 요청상태코드 */
                   ,FRT_USR_ID
                   ,FNL_USR_ID
                   ,FNL_DEAL_DPT_CD
                   ,FNL_MNU_ID
                   ,FRT_REGI_DH
                   ,FNL_MDF_DH
                )
                VALUES (
                    #{audYr}
                   ,#{audNo}
                   ,(SELECT NVL(MAX(FRS_REQ_SRNO), 0)+1
		               FROM TBAEPFRS101M
		              WHERE AUD_YR = #{audYr}
		                AND AUD_NO = #{audNo}) 
                   ,#{audStepCd}
                   ,#{frsReqDvsnCd}
                   ,#{dptCd}
                   ,sysdate
                   ,#{cnb}
                   ,#{orgCd}
                   ,'10'
                   ,#{usrId}
                   ,#{usrId}
                   ,#{dptCd}
                   ,#{mnuId}
                   ,SYSDATE
                   ,SYSDATE
                 )
    </insert>  
    
    <update id="updateFrsReq">
    /* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.updateFrsReq */
            UPDATE TBAEPFRS101M SET
                    FRS_REQ_DVSN_CD = #{frsReqDvsnCd}
                   ,ORG_CD = #{orgCd}
                   ,FNL_USR_ID = #{usrId}
                   ,FNL_DEAL_DPT_CD = #{dptCd}
                   ,FNL_MNU_ID = #{mnuId}
                   ,FNL_MDF_DH = SYSDATE
             WHERE
                    AUD_YR = #{audYr}
               AND  AUD_NO = #{audNo}
               AND  FRS_REQ_SRNO = #{frsReqSrno}

    </update>
    
    <!-- 포렌식 수신문서함 조회 -->
    <select id="selectRprtRqsList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.selectRprtRqsList*/
        <![CDATA[
            SELECT G1.RPRT_NM
                  ,G1.RPRT_NM AS V_RPRT_NM
                  ,G1.APV_STA_CD
                  ,G1.APV_STA_NM
                  ,G1.DOC_ID
                  ,G1.APV_RQS_ID
                  ,(SELECT T5.AUD_SBJ_NM FROM TBBADDED001M T5 WHERE G1.AUD_YR = T5.AUD_YR AND G1.AUD_NO = T5.AUD_NO) AS AUD_SBJ_NM
                  ,MAX(G1.APV_INFO_1) AS APV_INFO_1
                  ,MAX(G1.APV_INFO_2) AS APV_INFO_2
                  ,MAX(G1.APV_INFO_3) AS APV_INFO_3
                  ,MAX(G1.APV_INFO_4) AS APV_INFO_4
                  ,MAX(G1.APV_INFO_5) AS APV_INFO_5
                  ,MAX(G1.APV_INFO_6) AS APV_INFO_6
                  ,MAX(G1.APV_INFO_7) AS APV_INFO_7
                  ,(
                    SELECT DECODE(COUNT(1), 0, 'N', 'Y')
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                   ) AS SEND_YN
                    ,(
                    SELECT T3.DOC_STA_CD
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS SEND_STA_CD
                   ,(
                    SELECT T3.SUPPLM_REQ
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS SUPPLM_REQ
                   ,(
                    SELECT T3.RCPT_DPT_CD
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS RCPT_DPT_CD
                   ,(
                    SELECT DECODE(T3.RCPT_DPT_CD, '160100', '법무담당관') 
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS RCPT_DPT_NM
                  ,G1.RPRT_CD
                  , G1.DOC_WRT_ID
                  , (SELECT DECODE(COUNT(1), 0, 'N', 'Y') FROM TBDCMACM023H ST1 WHERE ST1.APV_DOC_NO = G1.APV_RQS_ID AND ST1.APVR_STA_CD NOT IN ('301', '201')) AS APV_HIS_YN
                  , G1.DOC_TYPE
              FROM (
                SELECT AUD_YR
                      ,AUD_NO
                      ,RPRT_CD
                      ,RPRT_NM
                      ,APV_STA_CD
                      ,APV_STA_NM
                      ,DOC_ID
                      ,APV_RQS_ID
                      ,DOC_WRT_ID
                      ,DOC_TYPE
                      ,DECODE(ROW_ID, 1, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_1
                      ,DECODE(ROW_ID, 2, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_2
                      ,DECODE(ROW_ID, 3, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_3
                      ,DECODE(ROW_ID, 4, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_4
                      ,DECODE(ROW_ID, 5, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_5
                      ,DECODE(ROW_ID, 6, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_6
                      ,DECODE(ROW_ID, 7, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_7
                  FROM (
                    SELECT AUD_YR
                          ,AUD_NO
                          ,RPRT_CD
                          ,RPRT_NM
                          ,APV_STA_CD
                          ,APV_STA_NM
                          ,DOC_ID
                          ,APV_RQS_ID
                          ,PST_NM
                          ,APVR_NM
                          ,APV_DH
                          ,DOC_WRT_ID
                          ,DOC_TYPE
                          ,ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SNO) AS ROW_ID 
                      FROM (
                        SELECT T1.AUD_YR
                              ,T1.AUD_NO
                              ,T1.RPRT_CD
                              ,T1.RPRT_NM
                              ,T1.APV_STA_CD
                              ,F_CODE_NM('1000773',APV_STA_CD) AS APV_STA_NM
                              ,T1.DOC_ID
                              ,T2.APV_SNO
                              ,T1.APV_RQS_ID
                              ,T1.DOC_WRT_ID
                              ,CASE WHEN APVR_PST_CD IS NULL
                                    THEN (SELECT MAX(ONR_PST_NM) FROM TBDCMACM001M WHERE CNB = APVR_CNB)
                                    ELSE F_CODE_NM('1000176', T2.APVR_PST_CD)
                               END  AS PST_NM
                              ,F_USR_INFO(T2.APVR_CNB, '2') AS APVR_NM
                              ,CASE WHEN SUBSTR(T2.APVR_STA_CD,0,1) = '2' THEN TO_CHAR(T2.APV_DH, 'YYYY-MM-DD')
                                    ELSE ''
                               END  AS APV_DH
                             , F_OPEN_EDIT(T1.LINK_URL) AS DOC_TYPE
                          FROM TBBADDED103M T1
                         LEFT OUTER JOIN TBDCMACM023L T2 ON
                                    T1.APV_RQS_ID = T2.APV_DOC_NO
                                AND T2.APV_SNO <> '1' --(기안자 제외)
                                AND T2.APVR_KND_CD <> '4' --(협조자 제외)
                         WHERE T1.AUD_YR = #{audYr}
                           AND T1.AUD_NO = #{audNo}
                           AND T1.RPRT_CD = 'A10610100'
                           AND T1.REF_ID = #{frsReqSrno}
                            ) 
                        )
                    ) AS G1
            GROUP BY G1.AUD_YR
                    ,G1.AUD_NO
                    ,G1.RPRT_CD
                    ,G1.RPRT_NM
                    ,G1.APV_STA_CD
                    ,G1.APV_STA_NM
                    ,G1.DOC_ID
                    ,G1.APV_RQS_ID
                    ,G1.DOC_WRT_ID
                    ,G1.DOC_TYPE
        ]]>
    </select>     
    
	<delete id="deleteFrsReq" parameterType="paramMap">
	/* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.deleteFrsReq */
		<![CDATA[
		   DELETE
			 FROM TBAEPFRS101M
			WHERE AUD_YR = #{audYr}
			  AND AUD_NO = #{audNo}
			  AND FRS_REQ_SRNO = #{frsReqSrno}
		]]>
	</delete>    
	
	<update id="updateRevRcptDt">
		UPDATE /* aep.afu.service.impl.AEPAFU001ServiceImpl.updateRevRcptDt */
			   TBAEPFRS101M                       
		   SET REV_OPT_RCV_DH      = SYSDATE
		     , REV_OPT_RCV_YN      = 'Y'
		     , FNL_USR_ID          = #{usrId}
		     , FNL_DEAL_DPT_CD     = #{dptCd}  
		     , FNL_MNU_ID          = #{mnuId}  
		     , FNL_MDF_DH          = SYSDATE 
		 WHERE AUD_YR			   = #{audYr}
		   AND AUD_NO			   = #{audNo}
		   AND FRS_REQ_SRNO		   = #{frsReqSrno}
	</update>	
	
    <update id="updateRevRcptDt2">
    /* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.updateRevRcptDt2 */
            UPDATE TBBADDED111M SET
                    RCPT_DH = SYSDATE
                   ,RCNT_ID = #{usrId}
                   ,RCPT_DPT_CD = #{dptCd}
                   ,FNL_USR_ID = #{usrId}
                   ,FNL_DEAL_DPT_CD = #{dptCd}
                   ,FNL_MNU_ID = #{mnuId}
                   ,FNL_MDF_DH = SYSDATE
             WHERE
                    AUD_YR = #{audYr}
               AND  AUD_NO = #{audNo}
               AND  RPRT_CD = 'A10610210'
               AND  REF_ID = #{frsReqSrno}

    </update>		
	
    <update id="updateHndlRcptDt">
		UPDATE /* aep.afu.service.impl.AEPAFU001ServiceImpl.updateHndlRcptDt */
			   TBAEPFRS101M                       
		   SET HNDL_RPT_RCV_DH     = SYSDATE
		     , HNDL_RPT_RCV_YN     = 'Y'
		     , FNL_USR_ID          = #{usrId}
		     , FNL_DEAL_DPT_CD     = #{dptCd}  
		     , FNL_MNU_ID          = #{mnuId}  
		     , FNL_MDF_DH          = SYSDATE 
		 WHERE AUD_YR			   = #{audYr}
		   AND AUD_NO			   = #{audNo}
		   AND FRS_REQ_SRNO		   = #{frsReqSrno}

    </update>	
    
    <update id="updateHndlRcptDt2">
    /* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.updateHndlRcptDt2 */
            UPDATE TBBADDED111M SET
                    RCPT_DH = SYSDATE
                   ,RCNT_ID = #{usrId}
                   ,RCPT_DPT_CD = #{dptCd}
                   ,FNL_USR_ID = #{usrId}
                   ,FNL_DEAL_DPT_CD = #{dptCd}
                   ,FNL_MNU_ID = #{mnuId}
                   ,FNL_MDF_DH = SYSDATE
             WHERE
                    AUD_YR = #{audYr}
               AND  AUD_NO = #{audNo}
               AND  RPRT_CD = 'A10610300'
               AND  REF_ID = #{frsReqSrno}

    </update>    
    
	<insert id="insertFile" parameterType="paramMap">
	/* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.insertFile */
		<![CDATA[
		INSERT INTO TBAEPFRS101L (
                   AUD_YR
                  ,AUD_NO
                  ,FRS_REQ_SRNO
                  ,SRNO
                  ,FILE_SEQ
                  ,DOC_ID
                  ,FILE_DVSN
                  ,FILE_ID
                  ,FILE_NAME
                  ,FILE_SIZE
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH )
           (SELECT distinct T1.AUD_YR
                  ,T1.AUD_NO
                  ,T1.FRS_REQ_SRNO
                  ,(
                    SELECT NVL(MAX(SRNO), 0) + 1
                      FROM TBAEPFRS101L T2
                     WHERE T2.AUD_YR = T1.AUD_YR
                       AND T2.AUD_NO = T1.AUD_NO
                       AND T2.FRS_REQ_SRNO = T1.FRS_REQ_SRNO
                       AND T2.FILE_DVSN = 'AG'
                   )
                  ,(
                    SELECT NVL(MAX(FILE_SEQ), 0) + 1
                      FROM TBAEPFRS101L T2
                     WHERE T2.AUD_YR = T1.AUD_YR
                       AND T2.AUD_NO = T1.AUD_NO
                       AND T2.FRS_REQ_SRNO = T1.FRS_REQ_SRNO
                       AND T2.FILE_DVSN = 'AG'
                   )
                  ,#{docId}
                  ,'AG'
                  ,#{fileId}
                  ,#{fileNm}
                  ,#{fileSize}
                  ,#{usrId}
		          ,#{usrId}
		          ,#{dptCd}
		          ,#{fnlMnuId}
                  ,SYSDATE
                  ,SYSDATE 
              FROM TBAEPFRS101M T1
                  ,TBAEPFRS101L T2
             WHERE T1.AUD_YR = T2.AUD_YR(+)
               AND T1.AUD_NO = T2.AUD_NO(+)
               AND T1.FRS_REQ_SRNO = T2.FRS_REQ_SRNO(+)
               AND T1.AUD_YR = #{audYr}
               AND T1.AUD_NO = #{audNo}
               AND T1.FRS_REQ_SRNO = #{frsReqSrno}
               AND 1 > (SELECT count(*) FROM TBAEPFRS101L WHERE DOC_ID = #{docId} AND FILE_ID = #{fileId} AND FILE_DVSN = 'AG')
             )		
		]]>
	</insert>    
	
	<delete id="deleteAgFile" parameterType="paramMap">
	/* kr.go.bai.eip.aep.frs.dao.AEPFRS001QMapper.deleteAgFile */
		<![CDATA[
		   DELETE
			 FROM TBAEPFRS101L
			WHERE AUD_YR = #{audYr}
			  AND AUD_NO = #{audNo}
			  AND FRS_REQ_SRNO = #{frsReqSrno}
			  AND DOC_ID = #{docId}
			  AND FILE_ID = #{fileId}
			  AND DOC_ID = #{docId}
			  AND FILE_DVSN = 'AG'
		]]>
	</delete>    	
        
</mapper>