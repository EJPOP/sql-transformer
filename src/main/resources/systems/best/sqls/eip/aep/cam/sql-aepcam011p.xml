<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.cam.dao.AEPCAM011PMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM011PMapper.selectMainList*/
          SELECT A.RECEV_DY||'-소명-'||A.GRN_SRNO AS YR_SRNO
                  ,A.RECEV_DY
                  ,TO_CHAR(TO_DATE(A.SMT_DT), 'YYYY-MM-DD') AS SMT_DT
                  ,A.SMT_ORG_NM AS RLTN_ORG_NM
                  ,A.PRSR
                  ,A.SPV_DPT_OM_YN        /*발신여부(주관)     */
                  ,TO_CHAR(A.SPV_DPT_OM_DT, 'YYYY-MM-DD') AS SPV_DPT_OM_DT
/*
                  ,CASE
                       WHEN A.SPV_DPT_OM_YN = 'Y' AND A.SPV_DPT_RCV_YN = 'Y' THEN '접수'
                       WHEN A.SPV_DPT_OM_YN = 'Y' AND A.SPV_DPT_RCV_YN IS NULL THEN '발신'
                       ELSE ''
                   END SPV_DPT_STA
                  ,A.PRCT_SPV_DPT_OM_YN
                  ,TO_CHAR(A.PRCT_SPV_DPT_OM_DT, 'YYYY-MM-DD') AS PRCT_SPV_DPT_OM_DT
                  ,(
                    SELECT COUNT(1)
                      FROM TBBADDED111M T1 
                     INNER JOIN TBCSPKDE106M T2 ON
                                T2.AUD_YR = T1.AUD_YR
                            AND T2.AUD_NO = T1.AUD_NO
                            AND T2.RPRT_LINK_SEQ = T1.REF_ID
                            AND T2.AFF_SNO = T1.REF_DY
                     WHERE T1.AUD_YR = A.AUD_YR
                       AND T1.AUD_NO = A.AUD_NO
                       AND T2.SRNO = A.SRNO
                       AND T1.RPRT_CD = 'A10600900' 
                       AND T1.RCPT_DPT_CD IN ('160200','180130', '151100')
                   ) AS REV_RPT_RCV_NM
                  ,(
                    SELECT COUNT(1)
                      FROM TBBADDED111M T1 
                     INNER JOIN TBCSPKDE106M T2 ON
                                T2.AUD_YR = T1.AUD_YR
                            AND T2.AUD_NO = T1.AUD_NO
                            AND T2.AFF_SNO = T1.REF_ID
                     WHERE T1.AUD_YR = A.AUD_YR
                       AND T1.AUD_NO = A.AUD_NO
                       AND T2.SRNO = A.SRNO
                       AND T1.RPRT_CD = 'A10601000' 
                       AND T1.RCPT_DPT_CD IN ('160200','180130', '151100')
                   ) AS REV_OPT_RCV_NM
                  ,CASE
                       WHEN A.PRCT_SPV_DPT_OM_YN = 'Y' THEN '발신'
                       ELSE ''
                   END PRCT_SPV_DPT_STA
*/
                  ,F_DPT_INFO(B.MNG_DPT_CD, 1) AS MNG_DPT_NM
                  ,F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, A.AUD_KND_CD, '-') AS AUD_YR_NO
                  ,B.AUD_SBJ_NM
/*
                  ,F_CODE_NM('1000785', B.PRSS_STEP_CD) AS PRSS_STEP_NM
                  ,CASE WHEN (SELECT DECODE(SUM(DECODE(CLSNG_YN, 'Y', 0, 1)), 0, 'N', 'Y')
                                FROM TBCSPKDE106M
                               WHERE AUD_YR = A.AUD_YR
                                 AND AUD_NO = A.AUD_NO
                                 AND SRNO = A.SRNO
                               GROUP BY AUD_YR, AUD_NO, SRNO) = 'N' 
                        THEN '마감'||'('||TO_CHAR(A.CLSNG_DT, 'YYYY-MM-DD')||')'
                        WHEN NVL((SELECT COUNT(1)
                                FROM TBCSPKDE106M
                               WHERE AUD_YR = A.AUD_YR
                                 AND AUD_NO = A.AUD_NO
                                 AND SRNO = A.SRNO
                               GROUP BY AUD_YR, AUD_NO, SRNO), 0) = 0
                        THEN DECODE(A.CLSNG_YN, 'Y', '마감'||'('||TO_CHAR(A.CLSNG_DT, 'YYYY-MM-DD')||')', '진행중')
                        ELSE '진행중'
                   END AS CLSNG_NM
                  ,A.CLSNG_YN
*/
                  ,A.SRNO
                  ,A.AFF_SNO
                  ,A.AUD_YR
                  ,A.AUD_KND_CD
                  ,A.AUD_NO
                  ,A.AUD_GRN_NO
/*
                  ,A.AUD_STEP_CD
                  ,(
                    SELECT COUNT(T1.DOC_ID)
                      FROM TBCSPKDE104M T1
                     WHERE T1.AUD_YR = A.AUD_YR
                       AND T1.AUD_NO = A.AUD_NO
                       AND T1.SRNO = A.SRNO
                   ) AS MT_CNT
                  ,(
                    SELECT COUNT(1)
                      FROM TBCSPKDE106M T1
                     WHERE T1.AUD_YR = A.AUD_YR
                       AND T1.AUD_NO = A.AUD_NO
                       AND T1.SRNO = A.SRNO
                   ) AS AFF_CNT
*/
                  , DECODE(A.IMMUN_REQ_YN, 'Y', A.RECEV_DY || '-면책-' || A.IMMUN_SRNO, '') AS IMMUN_NO
                  , A.IMMUN_SRNO
/*
                  , ( SELECT AGGR_CONCAT(RPRT_NM, '<![CDATA[<br>]]>' ORDER BY SORT_SNO)
                        FROM (
                        SELECT DISTINCT T3.RPRT_NM, T3.SORT_SNO, T3.AUD_YR, T3.AUD_NO, T1.SRNO
                        FROM TBCSPKDE106M T1
                        INNER JOIN TBBADDED145M T2 ON (T2.AUD_YR = T1.AUD_YR
                                                      AND T2.AUD_NO = T1.AUD_NO
                                                      AND T2.AFF_SNO = T1.AFF_SNO)
                        INNER JOIN TBBADDED103M T3 ON (T3.AUD_YR = T2.AUD_YR
                                                      AND T3.AUD_NO = T2.AUD_NO
                                                      AND T3.DOC_ID = T2.DOC_ID)
                        ) T4
                        WHERE T4.AUD_YR = A.AUD_YR AND T4.AUD_NO = A.AUD_NO AND T4.SRNO = A.SRNO
                        ) AS RPRT_NM
                  , ( SELECT AGGR_CONCAT(DECODE(T6.PST_CD, NULL, T6.USR_NAM, F_CODE_NM('1000176', T6.PST_CD) || '(' || T6.USR_NAM || ')')
                             , '<![CDATA[<br>]]>' ORDER BY SORT_SNO)
                        FROM (
                            SELECT T4.APVR_CNB, T3.SORT_SNO, T3.AUD_YR, T3.AUD_NO, T1.SRNO
                              FROM TBCSPKDE106M T1
                        INNER JOIN TBBADDED145M T2 ON (T2.AUD_YR = T1.AUD_YR
                                                       AND T2.AUD_NO = T1.AUD_NO
                                                       AND T2.AFF_SNO = T1.AFF_SNO)
                        INNER JOIN TBBADDED103M T3 ON (T3.AUD_YR = T2.AUD_YR
                                                       AND T3.AUD_NO = T2.AUD_NO
                                                       AND T3.DOC_ID = T2.DOC_ID
                                                       AND T3.APV_STA_CD > '10')
                        INNER JOIN TBDCMACM023L T4 ON (T4.APV_DOC_NO = T3.APV_RQS_ID
                                                       AND T4.APVR_STA_CD IN ('202','203')
                                                       AND T4.APV_DH IS NOT NULL
                                                       AND T4.APV_SNO = (SELECT MAX(T5.APV_SNO) FROM TBDCMACM023L T5 WHERE T5.APV_DOC_NO = T4.APV_DOC_NO AND T5.APVR_STA_CD IN ('202','203') AND T5.APV_DH IS NOT NULL))
                          GROUP BY T4.APVR_CNB, T3.SORT_SNO, T3.AUD_YR, T3.AUD_NO, T1.SRNO
                        ) T5
                   INNER JOIN TBDCMACM001M T6 ON (T5.APVR_CNB = T6.CNB)
                        WHERE T5.AUD_YR = A.AUD_YR AND T5.AUD_NO = A.AUD_NO AND T5.SRNO = A.SRNO
                        ) AS APVR_NM
                  , (SELECT DISTINCT (SELECT DECODE(ST1.CHF_CMTR_CNB, NULL, '지정전', F_USR_INFO(ST1.CHF_CMTR_CNB, '2'))
                                         FROM TBBADDED116L ST1
                                        WHERE ST1.AUD_YR = T2.AUD_YR 
                                          AND ST1.AUD_NO = T2.AUD_NO 
                                          AND ST1.TASK_DVSN_CD = '9'
                                          AND ST1.DOC_ID = T2.DOC_ID
                                          AND ST1.SRNO = (SELECT MAX(SRNO) 
                                                            FROM TBBADDED116L 
                                                           WHERE AUD_YR = T2.AUD_YR 
                                                             AND AUD_NO = ST1.AUD_NO 
                                                             AND TASK_DVSN_CD = '9' 
                                                             AND DOC_ID = ST1.DOC_ID)) AS CHF_CMTR_NM
                        FROM TBCSPKDE106M T1
                  INNER JOIN TBBADDED145M T2 ON (T2.AUD_YR = T1.AUD_YR AND T2.AUD_NO = T1.AUD_NO AND T2.AFF_SNO = T1.AFF_SNO AND (T2.APVR_CD = '0055700' OR T2.APVR_CD = '0010600'))
                       WHERE T1.AUD_YR = A.AUD_YR AND T1.AUD_NO = A.AUD_NO AND T1.SRNO = A.SRNO
                      ) AS CMTR_NM
                   , (SELECT T1.DOC_ID FROM TBBADDED103M T1 WHERE T1.AUD_YR = A.AUD_YR AND T1.AUD_NO = A.AUD_NO AND T1.REF_ID = A.SRNO AND T1.RPRT_CD = 'A10600910') AS WRT_DOC_ID1
                   , (SELECT T1.DOC_ID FROM TBBADDED103M T1 WHERE T1.AUD_YR = A.AUD_YR AND T1.AUD_NO = A.AUD_NO AND T1.REF_ID = A.SRNO AND T1.RPRT_CD = 'A10600950') AS WRT_DOC_ID2
*/
              FROM TBCSPKDE103M AS A
              INNER JOIN TBBADDED001M B ON (
                        A.AUD_YR = B.AUD_YR
                    AND A.AUD_NO = B.AUD_NO )
             WHERE 1=1
             AND A.IMMUN_REQ_YN = 'Y'
             AND A.ADV_COMMIT_YY IS NULL
             AND A.ADV_COMMIT_SRNO IS NULL
             ORDER BY A.RECEV_DY DESC, A.IMMUN_SRNO DESC
    </select>
    
    
    <insert id="insertTBCSPKDE110M" parameterType="paramMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM011PMapper.insertTBCSPKDE110M*/
    INSERT 
        INTO 
            TBCSPKDE110M (
                           ADV_COMMIT_YY
                         , ADV_COMMIT_SRNO
                         , AUD_YR
                         , AUD_NO
                         , SRNO
                         , FRT_USR_ID
                         , FNL_USR_ID
                         , FNL_DEAL_DPT_CD
                         , FNL_MNU_ID
                         , FRT_REGI_DH
                         , FNL_MDF_DH
            ) VALUES (
                           #{advCommitYy}
                         , #{advCommitSrno}
                         , #{audYr}
                         , #{audNo}
                         , #{srno}
                         , #{fnlUsrId}
                         , #{fnlUsrId}
                         , #{fnlDealDptCd}
                         , #{fnlMnuId}
                         , SYSDATE
                         , SYSDATE
            )
    </insert>
    
    <update id="updateTBCSPKDE103M" parameterType="paramMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM011PMapper.updateTBCSPKDE103M*/
        UPDATE TBCSPKDE103M
           SET ADV_COMMIT_YY = #{advCommitYy}
              , ADV_COMMIT_SRNO = #{advCommitSrno}
         WHERE AUD_YR = #{audYr}
           AND SRNO   = #{srno}
    </update>
    
    <select id="selectRefsAudYrNoExistYn" parameterType="paramMap" resultType="String">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM011PMapper.selectRefsAudYrNoExistYn*/
    <![CDATA[
        SELECT (CASE WHEN COUNT(REFS_AUD_YR) > 0 THEN 'Y' ELSE 'N' END) AUD_YR_NO_EXIST_YN
          FROM TBCSPKDE109M
         WHERE ADV_COMMIT_YY = #{advCommitYy}
           AND ADV_COMMIT_SRNO = #{advCommitSrno}
           AND REFS_AUD_YR IS NOT NULL
           AND REFS_AUD_NO IS NOT NULL
           AND REFS_SRNO IS NOT NULL
    ]]>
    </select>
    
    <update id="updateRefsAudFromTBCSPKDE109M" parameterType="paramMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM011PMapper.updateRefsAudFromTBCSPKDE109M*/
        UPDATE TBCSPKDE109M
           SET REFS_AUD_YR = #{audYr}
              , REFS_AUD_NO = #{audNo}
              , REFS_SRNO = #{srno}
         WHERE ADV_COMMIT_YY = #{advCommitYy}
           AND ADV_COMMIT_SRNO = #{advCommitSrno}
    </update>
    
    <update id="updateEH_INF_CM_CM_001" parameterType="paramMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM011PMapper.updateEH_INF_CM_CM_001*/
		UPDATE EH_INF_CM_CM_001
			SET FLAG = 'U'
			, CMM_COL7 = '30'		-- 적극행정 자문위원회 준비 중
			, CMM_COL8 = (SELECT ADV_COMMIT_DY FROM TBCSPKDE109M WHERE ADV_COMMIT_YY = #{advCommitYy} AND ADV_COMMIT_SRNO = #{advCommitSrno} )
			, FNL_MDF_DH = SYSDATE
		WHERE DVSN_CD = 'SOMYUNG'
		AND CMM_COL1 = #{recevDy}
		AND CMM_COL2 = '1'
		AND CMM_COL3 = #{immunSrno}
		AND FLAG != 'D'
    </update>
</mapper> 