<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.cfr.dao.AEPCFR011PMapper">
    
   <select id="selectMainList1" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.cfr.dao.AEPCFR011PMapper.selectMainList1*/
        <include refid="include.pageSelct" />
            SELECT B.CMT_YR,
                   B.CMT_DVSN_CD ,
                   B.CMT_SQ ,
                   B.CMT_SBJ_SNO ,
                   B.CMT_SBJ_NM ,
                   B.IF_WAY_DVSN ,
                   F_CODE_NM('1000848',B.IF_WAY_DVSN ) AS IF_WAY_DVSN_NM,
                   B.SR_DVSN ,
                   MAX(B.IF_MSG) AS IF_MSG ,
                   TO_CHAR(MIN(B.IF_STR_DH), 'YYYY-MM-DD HH24:MI:SS') AS IF_STR_DH ,
                   TO_CHAR(MAX(B.IF_END_DH), 'YYYY-MM-DD HH24:MI:SS') AS IF_END_DH ,
                   SUM(B.SR_CNT) AS SR_CNT,
                   B.CMT_SBJ_DVSN_CD,
                   B.CMT_IF_SEQ,
                   B.TRNM_SQ,
                   B.TBL_NM,
                   B.TBL_DESC,
                   B.CMT_IF_SEQ,
                   B.CMT_DVSN_NM
              FROM (SELECT A.CMT_YR ,
                           F_CODE_NM('1000789',A.CMT_DVSN_CD) AS CMT_DVSN_NM ,
                           A.CMT_DVSN_CD ,
                           A.CMT_SQ ,
                           A.CMT_IF_SEQ ,
                           A.CMT_SBJ_SNO ,
                           A.CMT_SBJ_NM ,
                           A.IF_WAY_DVSN ,
                           A.SR_DVSN ,
                           A.CMT_SBJ_DVSN_CD ,
                           DECODE(A.IF_MSG, 'Success', 1,null,3,'',3 ,2) AS IF_MSG ,
                           A.IF_STR_DH ,
                           1 AS SR_CNT ,
                           A.IF_END_DH ,
                           A.TRNM_SQ,
                           A.TBL_NM,
                           A.TBL_DESC,
                           MAX(A.TRNM_SQ) OVER (PARTITION BY A.CMT_YR,A.CMT_DVSN_CD,A.CMT_SQ,A.CMT_SBJ_SNO,
                                                             A.CMT_SBJ_NM,A.SR_DVSN,A.CMT_SBJ_DVSN_CD,
                                                             A.CMT_IF_SEQ,A.TBL_NM,A.TBL_DESC) AS MAX_TRNM_SQ
                      FROM EA_INF_CMT_SBJ_INFO A 
                     WHERE A.SR_DVSN = #{srDvsn}
                      AND A.CMT_YR = #{cmtYr}
                      AND A.CMT_DVSN_CD = #{cmtDvsnCd}
                      AND A.CMT_SQ = #{cmtSq}
                      AND A.CMT_IF_SEQ = #{cmtIfSeq}
                      AND A.CMT_SBJ_SNO = #{cmtSbjSno}
                  ORDER BY A.TRNM_SQ DESC
                  ) B
             WHERE B.TRNM_SQ = B.MAX_TRNM_SQ
             GROUP BY B.CMT_YR ,
                   B.CMT_DVSN_CD ,
                   B.CMT_SBJ_DVSN_CD ,
                   B.CMT_SQ ,
                   B.CMT_SBJ_SNO ,
                   B.CMT_SBJ_NM ,
                   B.IF_WAY_DVSN ,
                   B.SR_DVSN,
                   B.CMT_IF_SEQ,
                   B.TRNM_SQ,
                   B.TBL_NM,
                   B.TBL_DESC,
                   B.CMT_DVSN_NM
            ORDER BY IF_STR_DH DESC
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectMainList2" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.cfr.dao.AEPCFR011PMapper.selectMainList2*/
        <include refid="include.pageSelct" />
    SELECT C.CMT_YR
          ,C.CMT_DVSN_NM
          ,C.CMT_DVSN_CD
          ,C.CMT_SQ
          ,C.CMT_SBJ_SNO
          ,C.DOC_ID
          ,C.FILE_NM
          ,C.FILE_SIZE
          ,C.SR_DVSN
          ,C.IF_MSG
          ,C.IF_WAY_DVSN
          ,C.IF_WAY_DVSN_NM
          ,C.IF_STR_DH
          ,C.IF_END_DH
          ,C.CMT_IF_SEQ
          ,C.TRNM_SQ
          ,C.CMT_SBJ_NM
          ,C.CMT_SBJ_DVSN_CD
          ,C.MAX_FILE_SUC_DH
      FROM (
            SELECT 
                    B.CMT_YR
                   ,F_CODE_NM('1000789',B.CMT_DVSN_CD) AS CMT_DVSN_NM
                   ,B.CMT_DVSN_CD
                   ,B.CMT_SQ
                   ,B.CMT_SBJ_SNO
                   ,B.DOC_ID
                   ,B.FILE_NM
                   ,B.FILE_SIZE
                   ,B.SR_DVSN
                   ,B.IF_MSG
                   ,B.IF_WAY_DVSN
                   ,F_CODE_NM('1000848',B.IF_WAY_DVSN ) AS IF_WAY_DVSN_NM
                   ,TO_CHAR(B.IF_STR_DH, 'YYYY-MM-DD HH24:MI:SS') AS IF_STR_DH
                   ,TO_CHAR(B.IF_END_DH, 'YYYY-MM-DD HH24:MI:SS') AS IF_END_DH
                   ,B.CMT_IF_SEQ
                   ,B.TRNM_SQ
                   ,#{cmtSbjNm} AS CMT_SBJ_NM
                   ,#{cmtSbjDvsnCd} AS CMT_SBJ_DVSN_CD
                  ,TO_CHAR(
                       (SELECT MAX(STT.FNL_MDF_DH)
                          FROM( 
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADDED122M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADFRE103M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADFRE110M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.ACP_DCM_DOC_ID AS DOC_ID  FROM TBBADFRE108D ST   
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADFRE115M ST 
                                
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.AUD_DCM_DOC_ID AS DOC_ID FROM TBBADDED108D ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBCSPKDE104M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADDED115M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.AUD_DCM_DOC_ID AS DOC_ID FROM TBBADDED110M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID AS DOC_ID FROM TBBADDED103M ST 
                              ) STT
                          WHERE STT.DOC_ID = B.DOC_ID
                        ) ,'YYYY-MM-DD HH24:MI:SS'
                   ) AS MAX_FILE_SUC_DH
              FROM (SELECT  A.CMT_YR
                           ,A.CMT_DVSN_CD
                           ,A.CMT_SQ
                           /*,A.IF_SEQ*/
                           ,A.CMT_SBJ_SNO
                           ,A.DOC_ID
                           ,A.FILE_NM
                           ,A.FILE_SIZE
                           ,A.SR_DVSN
                           ,A.IF_MSG
                           ,A.IF_WAY_DVSN
                           ,A.IF_STR_DH
                           ,A.IF_END_DH
                           ,A.CMT_IF_SEQ
                           ,A.TRNM_SQ
                           ,MAX(A.TRNM_SQ) OVER (PARTITION BY   A.CMT_YR
                                                               ,A.CMT_DVSN_CD
                                                               ,A.CMT_SQ
                                                               ,A.CMT_SBJ_SNO
                                                               ,A.DOC_ID
                                                               ,A.SR_DVSN
                                                               ,A.CMT_IF_SEQ) AS MAX_TRNM_SQ
                      FROM EA_INF_ECM_FILE A 
                    WHERE A.SR_DVSN = #{srDvsn}
                      AND A.CMT_SBJ_SNO = #{cmtSbjSno}
                      AND A.CMT_YR = #{cmtYr}
                      AND A.CMT_DVSN_CD = #{cmtDvsnCd}
                      AND A.CMT_SQ = #{cmtSq}
                      AND A.CMT_IF_SEQ = #{cmtIfSeq}
                    ORDER BY A.IF_STR_DH DESC
                   ) B
             WHERE B.TRNM_SQ = B.MAX_TRNM_SQ
             ) C
             WHERE 1=1
             <if test='srhChFile != null and srhChFile != ""'>
             AND  C.MAX_FILE_SUC_DH  <![CDATA[>]]> C.IF_STR_DH  
             </if>
     
        <include refid="include.pageOrder" />
    </select>
    
    <!-- 안건 인터페이스테이블 삭제-->
    <update id="deleteInfCmtSbjInfo" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPCFR011PMapper.deleteInfCmtSbjInfo*/
        DELETE FROM EA_INF_CMT_SBJ_INFO
         WHERE CMT_YR         = #{cmtYr}
           AND CMT_SQ         = #{cmtSq}
           AND CMT_DVSN_CD    = #{cmtDvsnCd}
           AND CMT_SBJ_SNO    = #{cmtSbjSno}
           <if test="tblNm != null and tblNm != ''">
           AND TBL_NM         = #{tblNm}
           </if>
    </update>
    
    <!-- 안건 인터페이스테이블 삭제-->
    <update id="deleteEaInfSbcnInfo" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPCFR011PMapper.deleteEaInfSbcnInfo*/
        DELETE FROM EA_INF_SBCN_INFO
         WHERE CMT_YR         = #{cmtYr}
           AND CMT_SQ         = #{cmtSq}
           AND CMT_DVSN_CD    = #{cmtDvsnCd}
    </update>
    
    <!-- 관련문서 인터페이스테이블 삭제-->
    <update id="deleteInfFileSbjInfo" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPCFR011PMapper.deleteInfFileSbjInfo*/
        DELETE FROM EA_INF_ECM_FILE
         WHERE CMT_YR         = #{cmtYr}
           AND CMT_SQ         = #{cmtSq}
           AND CMT_DVSN_CD    = #{cmtDvsnCd}
           AND CMT_SBJ_SNO    = #{cmtSbjSno}
    </update>
    
        <select id="selectEaInfCmtSbjInfo" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.cfr.dao.AEPCFR011PMapper.selectEaInfCmtSbjInfo*/
    SELECT 
            CMT_YR
           ,CMT_DVSN_CD
           ,CMT_SQ
      FROM EA_INF_CMT_SBJ_INFO
            WHERE SR_DVSN = '수신'
              AND CMT_YR = #{cmtYr}
              AND CMT_DVSN_CD = #{cmtDvsnCd}
              AND CMT_SQ = #{cmtSq}
    </select>
    
    <select id="countChFile" parameterType="paramMap" resultType="Integer">
    /*kr.go.bai.eip.aep.cfr.dao.AEPCFR011PMapper.countChFile*/
      SELECT SUM(T.CNT) AS CNT 
        FROM(
             SELECT 
                  DECODE(
                         (SELECT MAX(STT.FNL_MDF_DH)
                           FROM( 
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADDED122M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADFRE103M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADFRE110M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.ACP_DCM_DOC_ID AS DOC_ID  FROM TBBADFRE108D ST   
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADFRE115M ST 
                                
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.AUD_DCM_DOC_ID AS DOC_ID FROM TBBADDED108D ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBCSPKDE104M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID FROM TBBADDED115M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.AUD_DCM_DOC_ID AS DOC_ID FROM TBBADDED110M ST 
                                UNION
                                SELECT ST.FNL_MDF_DH,ST.DOC_ID AS DOC_ID FROM TBBADDED103M ST 
                              ) STT
                          WHERE STT.DOC_ID = B.DOC_ID
                            AND  STT.FNL_MDF_DH  <![CDATA[>]]> B.IF_STR_DH
                  ),NULL,0,'',0,1) AS CNT
              FROM (
              
                      SELECT  A.CMT_YR
                                   ,A.CMT_DVSN_CD
                                   ,A.CMT_SQ
                                   /*,A.IF_SEQ*/
                                   ,A.CMT_SBJ_SNO
                                   ,A.DOC_ID
                                   ,A.FILE_NM
                                   ,A.FILE_SIZE
                                   ,A.SR_DVSN
                                   ,A.IF_MSG
                                   ,A.IF_WAY_DVSN
                                   ,MIN(A.IF_STR_DH) AS IF_STR_DH
                                   ,MAX(A.IF_END_DH) AS IF_END_DH
                                   ,A.CMT_IF_SEQ
                                   ,A.TRNM_SQ
                                   ,MAX(A.TRNM_SQ) OVER (PARTITION BY   A.CMT_YR
                                                                       ,A.CMT_DVSN_CD
                                                                       ,A.CMT_SQ
                                                                       ,A.CMT_SBJ_SNO
                                                                       ,A.DOC_ID
                                                                       ,A.SR_DVSN
                                                                       ,A.CMT_IF_SEQ) AS MAX_TRNM_SQ
                        FROM EA_INF_ECM_FILE A 
                       WHERE A.SR_DVSN     = #{srDvsn}
                         AND A.CMT_SBJ_SNO = #{cmtSbjSno}
                         AND A.CMT_YR      = #{cmtYr}
                         AND A.CMT_DVSN_CD = #{cmtDvsnCd}
                         AND A.CMT_SQ      = #{cmtSq}
                         AND A.CMT_IF_SEQ  = #{cmtIfSeq}
                       GROUP BY A.CMT_YR
                            ,A.CMT_DVSN_CD
                            ,A.CMT_SQ
                            ,A.CMT_SBJ_SNO
                            ,A.DOC_ID
                            ,A.FILE_NM
                            ,A.FILE_SIZE
                            ,A.SR_DVSN
                            ,A.IF_MSG
                            ,A.IF_WAY_DVSN
                            ,A.CMT_IF_SEQ
                            ,A.TRNM_SQ
                   ) B
             WHERE B.TRNM_SQ = B.MAX_TRNM_SQ
            )T   
    </select>
</mapper> 