<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper">



	<!-- 홈페이지 공개문 조회  BADEAR001ESubSelect -->
	<select id="selectMainList" parameterType="paramMap" resultType="egovMap">
		/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.selectMainList */
        <![CDATA[
		SELECT A.TSK_CAT_CD
               , A.TSK_SNO
               , A.AUD_SBJ_NM
               , A.DOC_ID
               , A.OPEN_YN
               , A.AUD_SLN
               , A.AUD_YR_NO
               , A.DGE
               , A.DGE_NM
               , A.DOWN_DOC
               , A.ENF_DT
               , A.PRL_SMT_DT
               , CASE WHEN A.PRL_SMT_DT IS NOT NULL THEN TO_DATE(A.PRL_SMT_DT) - TO_DATE(A.ENF_DT)
   				      ELSE TO_DATE(SYSDATE) - TO_DATE(A.ENF_DT) END AS DAY_CNT /*시행일 이후 경과일수*/
               , A.REGI_DT
               , A.APV_DOC_NO
               , A.PRL_SMT_YN
               , A.PRSS_STA_CD
               , A.PRSS_STA_NM
               , A.AUD_RPRT_NMS
          FROM (
			    SELECT 	D1.TSK_CAT_CD
			      	,D1.TSK_SNO
			      	,D1.AUD_SBJ_NM
			      	,D1.DOC_ID_1 AS DOC_ID
			      	,D1.OPEN_YN
			      	,D1.AUD_SLN
			      	,F_MNG_KND_AUDYRNO(D2.AUD_YR, D2.AUD_NO, D2.AUD_KND_CD, '-')  AS AUD_YR_NO   
					,D1.DGE
					,DECODE(D1.DGE,NULL,NULL,'홈페이지 공개문 '||D1.DGE||'차') AS DGE_NM				
					,D1.DOC_ID_2 AS DOWN_DOC
					,(SELECT TO_CHAR(TO_DATE(MIN(C.ENF_DT)), 'YYYY-MM-DD')
                      FROM TBBADDED146M A 
                      INNER JOIN TBBADEAR001M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.AUD_DSP_RQ_SNO = A.DSP_RQ_SNO)
                      INNER JOIN TBBADEAR002D C ON (C.AUD_YR = B.AUD_YR AND C.AUD_NO = B.AUD_NO AND C.DSP_RQ_SNO = B.DSP_RQ_SNO)
                      WHERE A.AUD_YR = D2.AUD_YR
                      AND A.AUD_NO = D2.AUD_NO
                      AND A.FNL_YN = 'Y'
                      AND NVL(A.REF_DOC_ID, A.DOC_ID) IN (SELECT ST.REF_DOC_ID FROM TBBADEAR028L ST WHERE ST.AUD_SLN = D1.AUD_SLN AND ST.DOC_ID = D1.DOC_ID_1)
                      ) AS ENF_DT
                    ,TO_CHAR(TO_DATE(D1.PRL_SMT_DT),'YYYY-MM-DD') AS PRL_SMT_DT
					,TO_CHAR(TO_DATE(REGI_DT),'YYYY-MM-DD') AS REGI_DT
					,D1.APV_DOC_NO
					,NVL(D1.PRL_SMT_YN,'N') AS PRL_SMT_YN
					,D1.PRSS_STA_CD
					,F_CODE_NM('1000756',D1.PRSS_STA_CD) AS PRSS_STA_NM
					,(SELECT AGGR_CONCAT(ST2.RPRT_NM,'<BR>' ORDER BY ST2.AUD_RPRT_DVSN_CD) 
                        FROM TBBADEAR028L ST1 
                  INNER JOIN TBBADDED103M ST2 ON (ST2.DOC_ID = ST1.REF_DOC_ID)
                       WHERE ST1.AUD_SLN = D1.AUD_SLN 
                         AND ST1.DOC_ID = D1.DOC_ID_1
                        GROUP BY ST1.AUD_SLN, ST1.DOC_ID) AS AUD_RPRT_NMS
			    FROM TBBADEAR028M D1
					,TBBADDED001M D2
			   WHERE D1.AUD_SLN = #{audYr}||#{audNo}
			     AND D2.AUD_YR = SUBSTR(D1.AUD_SLN, 0, 4)
			     AND D2.AUD_NO = SUBSTR(D1.AUD_SLN, 5, 3)
		       ) A
               ORDER BY A.DGE ASC
			]]>
	</select>	
	
	
	
	
	<!-- 홍보제출기본 insert   BADEAR001E028Insert -->
	<insert id="insertMain" parameterType="paramMap">
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.insertMain */
		<![CDATA[  
			INSERT INTO TBBADEAR028M(
		            TSK_CAT_CD 
		            ,TSK_SNO
		            ,REGI_DT
		            ,REGI_HMS
		            ,HNDL_DPT_CD
		            ,AUD_SBJ_NM 
		            ,AUD_SBJ_TXT
		            ,DOC_TYP_CD_1 
		            ,DOC_ID_1 
		            ,DOC_TYP_CD_2 
		            ,DOC_ID_2 
		            ,OPEN_YN 
		            ,AUD_SLN 
		            ,AUD_SPH_CD 
		            ,REL_ORG_CD 
		            ,FRT_USR_ID 
		            ,FNL_USR_ID 
		            ,FNL_DEAL_DPT_CD 
		            ,FNL_MNU_ID 
		            ,FRT_REGI_DH
		            ,FNL_MDF_DH
		            ,DGE
		            ,PRL_SMT_YN
		            ,PRSS_STA_CD	
                ) 
	            SELECT
	                'KP1'
	               ,(SELECT NVL(MAX(TO_NUMBER(TSK_SNO)),0)+1 FROM TBBADEAR028M)
	               ,NULL
	               ,NULL
	               ,NULL
	               ,AUD_SBJ_NM
	               ,NULL
	               ,'AD-AR-005'
	               ,#{docId} 
	               ,NULL
	               ,NULL
	               ,'N'
	               ,AUD_YR||AUD_NO
	               ,NULL
	               ,NULL
	               ,#{fnlUsrId}
	               ,#{fnlUsrId} 
	               ,#{fnlDealDptCd}
	               ,#{fnlMnuId}
	               ,SYSDATE
	               ,SYSDATE
	               ,(SELECT NVL(MAX(TO_NUMBER(DGE)),0)+1 FROM TBBADEAR028M WHERE AUD_SLN = #{audSln})
	               ,'N'
	               ,'10'
	            FROM	TBBADDED001M
	            WHERE  	AUD_YR||AUD_NO = #{audSln}
		]]>
	</insert>
	
	
	<!-- 홍보제출기본 insert   BADEAR001E028Insert -->
	<update id="updateMain" parameterType="paramMap">
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.updateMain */
		<![CDATA[  
			UPDATE	TBBADEAR028M
			SET		DOC_ID_1 = #{docId}
					, FNL_USR_ID      = #{fnlUsrId}
					, FNL_DEAL_DPT_CD = #{fnlDealDptCd}
					, FNL_MNU_ID      = #{fnlMnuId}
					, FNL_MDF_DH      = SYSDATE	
			WHERE	TSK_CAT_CD = #{tskCatCd}
			AND		TSK_SNO = #{tskSno}
		]]>
	</update>
	
	<!-- 홍보제출기본 insert   BADEAR001E028Insert -->
	<delete id="deleteMain" parameterType="paramMap">
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.deleteMain */
		<![CDATA[  
			DELETE	
			FROM	TBBADEAR028M
			WHERE	TSK_CAT_CD = #{tskCatCd}
			AND		TSK_SNO = #{tskSno}
		]]>
	</delete>
	
	<!-- 처분결과 조회-->
	<select id="selectSubList" parameterType="paramMap" resultType="egovMap">
		/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.selectSubList */
        <![CDATA[
            SELECT Z.*, ROWNUM AS NUM
            FROM (
		            SELECT D2.AUD_YR                               AS AUD_YR                          /*감사년도*/
		                 , D2.AUD_NO                               AS AUD_NO                          /*감사번호*/
		                 , D2.DSP_RQ_SNO                           AS DSP_RQ_SNO                      /*처분요구순번*/
		                 , D4.AUD_SBJ_NM
		                 , F_MNG_KND_AUDYRNO(D4.AUD_YR, D4.AUD_NO, D4.AUD_KND_CD, '-')     
		                                                           AS AUD_YR_NO
		                  /* , F_MNG_KND_AUDYRNO(D4.AUD_YR, D4.AUD_NO, D4.AUD_KND_CD, '-') || '-' || D2.DSP_RQ_SNO AS AUD_DSP_RQ_SNO                  감사처분요구순번*/ 
		                                                           
		                  , NVL2(D1.ACT_DSP_NM,D1.ACT_DSP_NM, F_MNG_KND_AUDYRNO(D4.AUD_YR, D4.AUD_NO, D4.AUD_KND_CD, '-') || '-' || D2.DSP_RQ_SNO  ) AS AUD_DSP_RQ_SNO                  /*감사처분요구순번*/ 
		                                                           
		                 , D1.TIT_TXT                              AS TIT_TXT                         /*제목내용*/
		                 , NVL(D3.OPEN_TIT_TXT,D1.TIT_TXT)                         AS OPEN_TIT_TXT                    /*공개제목내용*/
		                 , D3.RPST_ORG_CD
		                 
		                 , (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y'
		                                ELSE 'N'
		                            END  
		                      FROM TBBADEAR030M T1 
		                     WHERE T1.AUD_YR     = D2.AUD_YR
		                       AND T1.AUD_NO     = D2.AUD_NO
		                       AND T1.DSP_RQ_SNO     = D2.DSP_RQ_SNO
		                       AND T1.PRL_SMT_YN = 'Y')       AS PRL_SMT_YN                      /*홍보제출여부*/
		                 
		                  
		                 , (SELECT F_ORG_INFO(MIN(RLTN_ORG_CD),'1')
		                      FROM TBBADEAR006M T1
		                     WHERE 1=1
		                       AND T1.AUD_YR     = D1.AUD_YR
		                       AND T1.AUD_NO     = D1.AUD_NO
		                       AND T1.DSP_RQ_SNO = D1.DSP_RQ_SNO)  AS RLTN_ORG_NM                     /*처분기관*/
		                 , (SELECT MIN(RLTN_ORG_CD)
		                      FROM TBBADEAR006M T1
		                     WHERE 1=1
		                       AND T1.AUD_YR     = D1.AUD_YR
		                       AND T1.AUD_NO     = D1.AUD_NO
		                       AND T1.DSP_RQ_SNO = D1.DSP_RQ_SNO)  AS RLTN_ORG_CD                     /*처분기관*/
		                 , ''                                      AS DSP_RQ_RSLT                     /*처분결과*/
		                 , D1.DSP_RQ_KND_CD                        AS DSP_RQ_KND_CD                   /*처분요구종류코드*/
		                 , D5.CD_NM  AS DSP_RQ_KND_NM                   /*처분요구종류코드명*/
		                 , CASE WHEN D2.DTM_STA_CD = '1' THEN '처분확정'
		                        WHEN D2.DTM_STA_CD = '2' THEN '집행확정' 
		                        ELSE '미확정'
		                    END                                    AS DTM_STA_NM                      /*처분확정여부*/
		                 , NVL(D2.DTM_STA_CD,0) AS DTM_STA_CD
		                 , CASE WHEN D3.HMP_OPEN_YN IS NOT NULL THEN D3.HMP_OPEN_YN
		                 		WHEN D2.HMP_OPEN_YN IN ('1','N') THEN 'N'
		                 		WHEN D2.HMP_OPEN_YN IS NULL THEN 'N'
		                        ELSE 'Y'
		                    END                                    AS OPEN_YN                         /*공개여부*/
		                 , D5.USR_DFN_TXT_1						   AS DSP_RQ_KND_CD2				  /*홈페이지 공개용 처분요구종류코드*/
		                 , SUBSTR(D2.ENF_DT,1,4) AS ENF_YR 
		                 , CASE WHEN D2.HMP_OPEN_YN IN ('1','N') THEN '비공개'
		                 		WHEN D2.HMP_OPEN_YN IS NULL THEN '비공개'
		                        ELSE '공개'
		                    END                                    AS HMP_OPEN_YN   
		                 , D3.OPEN_TXT  
		                 , F_CODE_NM('1000120',D2.TSK_CAT_CD)  AS TSK_CAT_NM 	/*업무분류명*/
		                 ,D3.DOC_ID
							,CASE WHEN D3.DOC_ID IS NULL AND CSD_YN IS NULL THEN '공개문 미생성'
								WHEN D3.DOC_ID IS NULL AND CSD_YN = 'Z' THEN '공개문 미존재' 
								WHEN D3.DOC_ID IS NOT NULL AND CSD_YN IS NULL THEN '공개문 생성중'
								WHEN D3.DOC_ID IS NOT NULL AND CSD_YN = 'Y' THEN '공개문 생성 성공'
								WHEN D3.DOC_ID IS NOT NULL AND CSD_YN = 'N' THEN '공개문 생성 실패'
								ELSE '' END AS CSD_YN_NM
							,D3.CSD_YN AS CSD_YN
		              FROM TBBADEAR001M D1    /*처분요구사항기본*/
		                  ,TBBADEAR002D D2    /*처분요구사항상세*/
		                  ,TBBADEAR030M D3    /*홍보제출기본*/
		                  ,TBBADDED001M D4
		                  ,TBDCMACM013C D5
		             WHERE 1=1
		               AND D4.AUD_YR	 = D1.AUD_YR
		               AND D4.AUD_NO     = D1.AUD_NO
		               AND D1.AUD_YR     = D2.AUD_YR
		               AND D1.AUD_NO     = D2.AUD_NO
		               AND D1.DSP_RQ_SNO = D2.DSP_RQ_SNO
		               AND D1.AUD_YR     = D3.AUD_YR(+)
		               AND D1.AUD_NO     = D3.AUD_NO(+)
		               AND D1.DSP_RQ_SNO = D3.DSP_RQ_SNO(+)
		               AND D1.AUD_YR     = #{audYr}
		               AND D1.AUD_NO     = #{audNo}
		               AND D5.CMM_CD_DVSN_CD = '1000002' 
		               AND D5.CD <> '000000000'
		               AND D1.DSP_RQ_KND_CD = D5.CD
		               AND D1.DSP_RQ_KND_CD NOT IN (
		                                             '120' /* 무책판정     */
		                                            ,'390' /* 현지시정     */
													,'391' /* 현지시정회   */
													,'395' /* 시정(국장전결) */
													,'396' /* 시정(국장전결)회 */
													,'490' /* 현지주의     */
													,'495' /* 주의(국장전결) */
		                                            ,'730' /* 수사요청     */
		                                            ,'904' /* 종합통보     */
		                                            ,'905' /* 개별통보     */
		                                            ,'910' /* 자체처리요구 */
		                                            ,'911' /* 자체징계     */
		                                            ,'912' /* 자체시정     */
		                                            ,'913' /* 자체주의     */
		                                            ,'914' /* 자체통보     */
		                                            ,'915' /* 자체처리고발 */
		                                            ,'916' /* 불문         */
		                                           )
					]]>
		             <if test='dspRqSno != null and dspRqSno != ""'>                              
					 AND D1.DSP_RQ_SNO = #{dspRqSno}
		             </if>	 
		             ORDER BY D1.DSP_RQ_SNO 
            ) Z
	</select>	
	
	<!-- 홍보제출기본 insert   BADEAR048EDtlinsert -->
	<insert id="insertDtl" parameterType="paramMap">
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.insertDtl */
		<![CDATA[  
                INSERT INTO TBBADEAR030M
                (
                     AUD_YR                  /*감사년도*/        
                    ,AUD_NO                  /*감사번호*/        
                    ,DSP_RQ_SNO              /*처분요구순번*/    
                    ,AUD_SBJ_NM
                    ,OPEN_TIT_TXT            /*공개제목내용*/  
                    ,OPEN_TXT                /*공개내용*/
                    ,PRL_SMT_YN              /*홍보제출여부*/
                    ,CON_YN                  /*연계여부*/  
                    ,DSP_RQ_KND_CD           /*처분요구종류코드*/
                    ,RLTN_ORG_CD
                    ,RLTN_ORG_NM			 /*관계기관*/
                    ,ENF_YR
                    ,FRT_USR_ID              /*최초사용자ID*/
                    ,FNL_USR_ID              /*최종사용자ID*/
                    ,FNL_DEAL_DPT_CD         /*최종거래부서코드*/
                    ,FNL_MNU_ID              /*최종메뉴ID*/
                    ,FRT_REGI_DH             /*최초등록일시*/
                    ,FNL_MDF_DH              /*최종수정일시*/
                    ,HMP_OPEN_YN			/*공개여부*/
                    ,PRSS_STA_CD			
                ) 
                VALUES
                (
                     #{audYr}                
                    ,#{audNo}                
                    ,#{dspRqSno}     
                    ,#{audSbjNm}       
                    ,#{openTitTxt}          
                    ,#{openTxt}              
                    ,'N'            
                    ,'N'        
                    ,#{dspRqKndCd2}    
                    ,#{rltnOrgCd}
                    ,#{rltnOrgNm}   
                    ,#{enfYr}  
                    ,#{frtUsrId}            
                    ,#{fnlUsrId}            
                    ,#{fnlDealDptCd}       
                    ,#{fnlMnuId}            
                    ,SYSDATE
                    ,SYSDATE   
                    ,#{openYn}    
                    ,'10'     
                )		
		]]>
	</insert>
		
	<!--홍보제출기본 update  BADEAR048EDtlupdate-->
	<update id="updateDtl" parameterType="paramMap">
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.updateDtl */
		<![CDATA[
	          UPDATE TBBADEAR030M
                 SET OPEN_TIT_TXT      = #{openTitTxt}      /*공개제목내용*/  
                 	,RLTN_ORG_CD = #{rltnOrgCd}
                 	,RLTN_ORG_NM = #{rltnOrgNm}
                    ,FNL_USR_ID        = #{fnlUsrId}        /*최종사용자ID*/
                    ,FNL_DEAL_DPT_CD   = #{fnlDealDptCd}   /*최종거래부서코드*/
                    ,FNL_MNU_ID        = #{fnlMnuId}        /*최종메뉴ID*/
                    ,FNL_MDF_DH        = SYSDATE             /*최종수정일시*/
                    ,HMP_OPEN_YN	   = #{openYn}
                    ,OPEN_TXT		   = #{openTxt}
               WHERE AUD_YR            = #{audYr}
                 AND AUD_NO            = #{audNo}
                 AND DSP_RQ_SNO        = #{dspRqSno}
		]]>   
	</update>			
		
	<!--홍보제출 update   BADEAR048EPrlSmtYnupdate -->
	<update id="updatePrlSmtYn" parameterType="paramMap">
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.updatePrlSmtYn */
		<![CDATA[
		  	
	          UPDATE TBBADEAR030M D1
                 SET PRL_SMT_YN        = 'Y'
                 	,PRL_SMT_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
                 	,RPST_ORG_CD       =	CASE WHEN RPST_ORG_CD IS NOT NULL THEN RPST_ORG_CD
                 							WHEN (	SELECT 	COUNT(*)
                 									FROM	TBBADEAR032M S1 
                 									WHERE 	D1.RLTN_ORG_CD = S1.ORG_CD ) = 1
                 								THEN (	SELECT 	S1.RPST_ORG_CD
                 										FROM	TBBADEAR032M S1
                 										WHERE	D1.RLTN_ORG_CD = S1.ORG_CD
                 									)
                 							ELSE NULL END
                 	,PRSS_STA_CD = '30' 
                    ,FNL_USR_ID        = #{fnlUsrId}        /*최종사용자ID*/
                    ,FNL_DEAL_DPT_CD   = #{fnlDealDptCd}   /*최종거래부서코드*/
                    ,FNL_MNU_ID        = #{fnlMnuId}        /*최종메뉴ID*/
                    ,FNL_MDF_DH        = SYSDATE             /*최종수정일시*/                 
               WHERE AUD_YR            = #{audYr}
                 AND AUD_NO            = #{audNo}

		]]>   
	</update>	

	<!-- 홍보제출존재 여부   BADEAR048EDtlCntselect -->
	<select id="selectDtlCnt" parameterType="paramMap" resultType="egovMap">
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.selectDtlCnt */
        <![CDATA[
            SELECT COUNT(*) AS CNT 
              FROM TBBADEAR030M 
             WHERE 1=1
               AND AUD_YR     = #{audYr}
               AND AUD_NO     = #{audNo}
               AND DSP_RQ_SNO = #{dspRqSno}
		]]>
	</select>	
	
				


    <insert id="insertBADEAR028L" parameterType="paramMap">
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.insertBADEAR028L */
		<![CDATA[  
                INSERT INTO TBBADEAR028L
                (
                     AUD_SLN                  /*감사연번*/        
                    ,DOC_ID                  /*문서ID*/        
                    ,REF_DOC_ID              /*참조문서ID*/    
                    ,FRT_USR_ID              /*최초사용자ID*/
                    ,FNL_USR_ID              /*최종사용자ID*/
                    ,FNL_DEAL_DPT_CD         /*최종거래부서코드*/
                    ,FNL_MNU_ID              /*최종메뉴ID*/
                    ,FRT_REGI_DH             /*최초등록일시*/
                    ,FNL_MDF_DH              /*최종수정일시*/
                ) 
                VALUES
                (
                     #{audSln}                
                    ,#{docId}                
                    ,#{refId}     
                    ,#{frtUsrId}            
                    ,#{fnlUsrId}            
                    ,#{fnlDealDptCd}       
                    ,#{fnlMnuId}            
                    ,SYSDATE
                    ,SYSDATE   
                )		
		]]>
	</insert>
	
	<insert id="deleteBADEAR028L" parameterType="paramMap">
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE202PMapper.deleteBADEAR028L */
		<![CDATA[  
		DELETE 
		  FROM TBBADEAR028L
		 WHERE AUD_SLN = #{audSln}
		   AND DOC_ID = #{docId}
		]]>
	</insert>
</mapper> 
