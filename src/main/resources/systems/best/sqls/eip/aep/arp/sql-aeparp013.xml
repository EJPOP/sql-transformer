<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.arp.dao.AEPARP013QMapper">

    <select id="selectAudList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP013QMapper.selectAudList */
        <include refid="include.pageSelct" />
        <![CDATA[
            SELECT 
                    T1.AUD_YR,
                    T1.AUD_NO,
                    F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-')    AS AUD_YR_NO,
                    T1.AUD_SBJ_NM,
                    T2.RPRT_NM,
                    F_DPT_INFO(T1.MNG_DPT_CD,'1') AS MNG_DPT_NM,
                    F_CODE_NM('1000785', T1.PRSS_STEP_CD) AS AUD_STEP_NM,
                    TO_CHAR(T2.SND_DH, 'YYYY-MM-DD') AS SND_DH,
                    T1.MNG_DPT_CD,
                    NVL((
                       SELECT MAX(T4.DOC_ID)
                         FROM TBBADDED111M T4
                        WHERE T4.AUD_YR = T1.AUD_YR
                          AND T4.AUD_NO = T1.AUD_NO
                          AND T4.AUD_STEP_CD = 'A1060'
                          AND T4.REF_ID = T2.DOC_ID
                          AND T4.RPRT_CD = 'A10600200'
                      ), T3.DOC_ID) AS DOC_ID,
                    T1.AUD_KND_CD,
                    T3.AUD_RPRT_DVSN_CD,
                    F_CODE_NM('1000788', T3.AUD_RPRT_DVSN_CD) AS AUD_RPRT_DVSN_NM,
                    T2.AUD_STEP_CD,
                    T2.SR_DOC_SNO,
                    T2.DOC_STA_CD,
                    T2.RPRT_NM AS V_RPRT_NM,
                    DECODE(T5.DOC_ID, NULL, 'N', 'Y') AS READ_YN,
                    F_OPEN_EDIT(T3.LINK_URL) AS DOC_TYPE
                FROM
                    TBBADDED001M T1
                    INNER JOIN
                    TBBADDED111M T2 ON (
                            T1.AUD_YR = T2.AUD_YR
                        AND T1.AUD_NO = T2.AUD_NO )
                    INNER JOIN
                    TBBADDED103M T3 ON (
                            T2.AUD_YR = T3.AUD_YR
                        AND T2.AUD_NO = T3.AUD_NO
                        AND T2.DOC_ID = T3.DOC_ID )
                    LEFT OUTER JOIN
                    TBBADDED111M T5 ON (
                              T5.AUD_YR = T1.AUD_YR
                          AND T5.AUD_NO = T1.AUD_NO
                          AND T5.AUD_STEP_CD = 'A1060'
                          AND T5.REF_ID = T2.DOC_ID
                          AND T5.RPRT_CD = 'A10600200' )
                WHERE 1=1
                AND T2.AUD_STEP_CD = 'A1060'
                AND T2.RCPT_DPT_CD = '160200'
                AND T2.RPRT_CD IN ('A10600200')
            ]]>
        <if test='schAudYr != null and schAudYr != ""'>
            AND T1.AUD_YR = #{schAudYr}
        </if>
        <if test='schAudGrnNo != null and schAudGrnNo != ""'>
            AND T1.AUD_GRN_NO = #{schAudGrnNo}
        </if>
        <if test='schAudYrNoKndCd != null and schAudYrNoKndCd != ""'>
            AND T1.AUD_KND_CD = #{schAudYrNoKndCd}
        </if>
        <if test='iptAudSbjNm != null and iptAudSbjNm != ""'>
            AND AUD_SBJ_NM LIKE '%'||#{iptAudSbjNm}||'%'
        </if>
        <if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
            AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = T1.MNG_DPT_CD) = #{schSpvBrdvCd}
        </if>
        <if test="schDeptCd != null and schDeptCd != ''">
            AND MNG_DPT_CD = #{schDeptCd}
        </if>
            <![CDATA[
          ORDER BY T2.SND_DH DESC
            ]]>
        <include refid="include.pageOrder" />
    </select>
    
    
    <update id="saveRcptDoc" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP013QMapper.saveRcptDoc */
        <![CDATA[
        UPDATE TBBADDED111M
        SET 
            DOC_STA_CD = '20',
            FNL_MDF_DH = SYSDATE,
            RCPT_DH = SYSDATE,
            RCNT_ID = #{usrId},
            FNL_USR_ID = #{usrId},
            FNL_DEAL_DPT_CD = #{dptCd},
            FNL_MNU_ID = #{mnuId}
        WHERE 
                AUD_YR = #{audYr}
        AND AUD_NO = #{audNo}
        AND AUD_STEP_CD = #{audStepCd}
        AND DOC_ID = #{docId}
        ]]>
    </update>
    
    <insert id="insertCopyDoc"> 
        /* kr.go.bai.eip.aep.arp.dao.AEPARP013QMapper.insertCopyDoc */
        <![CDATA[
            INSERT INTO TBBADDED111M (
                   AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,SR_DOC_SNO
                  ,RPRT_CD
                  ,REF_ID
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH)
            VALUES (
                   #{audYr}
                   ,#{audNo}
                   ,#{audStepCd}
                   ,#{vDocId}
                   ,(SELECT LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0) 
                       FROM TBBADDED111M 
                      WHERE AUD_YR = #{audYr} 
                        AND AUD_NO =#{audNo}
                        AND AUD_STEP_CD = #{audStepCd}
                        AND DOC_ID = #{docId} )
                   ,'A10600200'
                   ,#{docId}
                   ,#{usrId}
                   ,#{usrId}
                   ,#{dptCd}
                   ,#{currentMenuId}
                   ,SYSDATE
                   ,SYSDATE)
        ]]>
    </insert>
    
</mapper> 
