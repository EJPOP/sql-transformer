<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.mac.dao.AEPMAC015PMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC015PMapper.selectMainList*/
        SELECT A.AUD_YR
             , A.AUD_NO
             , A.AUD_STEP_CD
             , A.DOC_ID
             , A.APVR_CD
             , A.AFF_SNO
             , B.DSP_RQ_SNO
             , A.TITLE_NM
             , B.DSP_RQ_CD
             , F_CODE_NM('1000002', B.DSP_RQ_CD) AS DSP_RQ_NM
             , B.RLTN_ORG_CD
             , F_ORG_INFO(B.RLTN_ORG_CD, '1') AS RLTN_ORG_NM
             , B.NOP_AM_DVSN_CD
             , F_CODE_NM('1000784', B.NOP_AM_DVSN_CD) AS NOP_AM_DVSN_NM
             , B.HND_ORG_CD
             , F_ORG_INFO(B.HND_ORG_CD, '1') AS HND_ORG_NM
             , B.NOP_AM
             , B.NOP_SUM
             , (SELECT COUNT(ST.CNDIDAT_SRNO) 
                 FROM TBBADDED146D ST 
                WHERE ST.AUD_YR = B.AUD_YR 
                  AND ST.AUD_NO = B.AUD_NO 
                  AND ST.AUD_STEP_CD = B.AUD_STEP_CD 
                  AND ST.DOC_ID = B.DOC_ID
                  AND ST.APVR_CD = B.APVR_CD
                  AND ST.AFF_SNO = B.AFF_SNO
                  AND ST.DSP_RQ_SNO = B.DSP_RQ_SNO) AS CNDIDAT_CNT
          FROM TBBADDED145M A
    INNER JOIN TBBADDED146M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.AUD_STEP_CD = A.AUD_STEP_CD AND B.DOC_ID = A.DOC_ID AND B.APVR_CD = A.APVR_CD AND B.AFF_SNO = A.AFF_SNO)
         WHERE A.AUD_YR      = #{audYr}
           AND A.AUD_NO      = #{audNo}
           AND A.AUD_STEP_CD = #{audStepCd}
           AND A.DOC_ID      = #{docId}
           AND A.APVR_CD     = #{apvrCd}
           ORDER BY (SELECT DECODE(COUNT(ST.CNDIDAT_SRNO),0,0,1)
                       FROM TBBADDED146D ST 
                      WHERE ST.AUD_YR = B.AUD_YR 
                        AND ST.AUD_NO = B.AUD_NO 
                        AND ST.AUD_STEP_CD = B.AUD_STEP_CD 
                        AND ST.DOC_ID = B.DOC_ID
                        AND ST.APVR_CD = B.APVR_CD
                        AND ST.AFF_SNO = B.AFF_SNO
                        AND ST.DSP_RQ_SNO = B.DSP_RQ_SNO) DESC
                    , A.SORT_SNO ASC, B.DSP_RQ_SNO ASC 
    </select>
       
    <select id="selectSubList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC015PMapper.selectSubList*/
    <![CDATA[
        SELECT AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID, APVR_CD, AFF_SNO, DSP_RQ_SNO, CNDIDAT_SRNO
             , (CASE WHEN REL_AUD_CNT = 0 THEN '' 
                     WHEN REL_AUD_CNT = 1 THEN REL_AUD_NM
                     WHEN REL_AUD_CNT > 1 THEN REL_AUD_NM || '외 ' || TO_CHAR(REL_AUD_CNT-1) || '건' END) AS REL_AUD_NM
             , CNDIDT_NM, CNDIDT_YMD, CNDIDT_RANK_CD, CNDIDT_RANK_NM
             , CNDIDT_ORG_CD, CNDIDT_ORG_NM, CNDIDT_DPT_NM
          FROM (
		        SELECT A.AUD_YR
		             , A.AUD_NO
		             , A.AUD_STEP_CD
		             , A.DOC_ID
		             , A.APVR_CD
		             , A.AFF_SNO
		             , A.DSP_RQ_SNO
		             , A.CNDIDAT_SRNO
		             , (SELECT DISTINCT F_MNG_KND_AUDYRNO(ST.AUD_YR, ST.AUD_NO, ST2.AUD_KND_CD, '-') AS AUD_YRNO
		                  FROM TBBADDED146D ST
		            INNER JOIN TBBADDED001M ST2 ON (ST2.AUD_YR = ST.AUD_YR AND ST2.AUD_NO = ST.AUD_NO)
		            INNER JOIN TBBADDED146M ST3 ON (ST3.AUD_YR = ST.AUD_YR AND ST3.AUD_NO = ST.AUD_NO AND ST3.AUD_STEP_CD = ST.AUD_STEP_CD AND ST3.DOC_ID = ST.DOC_ID AND ST3.APVR_CD = ST.APVR_CD AND ST3.AFF_SNO = ST.AFF_SNO AND ST3.DSP_RQ_SNO = ST.DSP_RQ_SNO)
		                 WHERE ST.CNDIDT_NM = A.CNDIDT_NM
		                   AND ST.CNDIDT_YMD = A.CNDIDT_YMD
		                   AND (ST.AUD_YR <> A.AUD_YR OR ST.AUD_NO <> A.AUD_NO)
		                   AND ROWNUM = 1) AS REL_AUD_NM
		             , (SELECT COUNT(DISTINCT F_MNG_KND_AUDYRNO(ST.AUD_YR, ST.AUD_NO, ST2.AUD_KND_CD, '-'))
		                  FROM TBBADDED146D ST
		            INNER JOIN TBBADDED001M ST2 ON (ST2.AUD_YR = ST.AUD_YR AND ST2.AUD_NO = ST.AUD_NO)
		            INNER JOIN TBBADDED146M ST3 ON (ST3.AUD_YR = ST.AUD_YR AND ST3.AUD_NO = ST.AUD_NO AND ST3.AUD_STEP_CD = ST.AUD_STEP_CD AND ST3.DOC_ID = ST.DOC_ID AND ST3.APVR_CD = ST.APVR_CD AND ST3.AFF_SNO = ST.AFF_SNO AND ST3.DSP_RQ_SNO = ST.DSP_RQ_SNO)
		                 WHERE ST.CNDIDT_NM = A.CNDIDT_NM
		                   AND ST.CNDIDT_YMD = A.CNDIDT_YMD
		                   AND (ST.AUD_YR <> A.AUD_YR OR ST.AUD_NO <> A.AUD_NO)
		                ) AS REL_AUD_CNT
		             , A.CNDIDT_NM
		             , TO_CHAR(TO_DATE(A.CNDIDT_YMD),'YYYY-MM-DD') AS CNDIDT_YMD
		             , A.CNDIDT_RANK_CD
		             , F_CODE_NM('1000173', A.CNDIDT_RANK_CD) AS CNDIDT_RANK_NM
		             , A.CNDIDT_ORG_CD
		             , F_ORG_INFO(A.CNDIDT_ORG_CD, '1') AS CNDIDT_ORG_NM
		             , A.CNDIDT_DPT_NM
		          FROM TBBADDED146D A
                 WHERE A.AUD_YR      = #{audYr}
                   AND A.AUD_NO      = #{audNo}
                   AND A.AUD_STEP_CD = #{audStepCd}
                   AND A.DOC_ID      = #{docId}
                   AND A.APVR_CD     = #{apvrCd}
                   AND A.AFF_SNO     = #{affSno}
                   AND A.DSP_RQ_SNO  = #{dspRqSno}
                ) ORDER BY CNDIDAT_SRNO ASC
         ]]>
    </select>
    
    <insert id="saveTBBADDED146D" parameterType="paramMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC015PMapper.saveTBBADDED146D*/
        <![CDATA[
            MERGE INTO TBBADDED146D 
                 USING (
                        SELECT '1'
                          FROM DUAL ) T2
                    ON (    AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND AUD_STEP_CD = #{audStepCd} 
                        AND DOC_ID = #{docId} 
                        AND APVR_CD = #{apvrCd} 
                        AND AFF_SNO = #{affSno} 
                        AND DSP_RQ_SNO = #{dspRqSno} 
                        AND CNDIDAT_SRNO = #{cndidatSrno} 
                        )
                  WHEN MATCHED THEN
                UPDATE
                   SET CNDIDT_NM        = #{cndidtNm}
                     , CNDIDT_YMD       = REPLACE(#{cndidtYmd},'-')
                     , CNDIDT_RANK_CD   = #{cndidtRankCd}
                     , CNDIDT_ORG_CD    = #{cndidtOrgCd}
                     , CNDIDT_DPT_NM    = #{cndidtDptNm}
                     , FNL_USR_ID       = #{fnlUsrId}
                     , FNL_DEAL_DPT_CD  = #{fnlDealDptCd}
                     , FNL_MNU_ID       = #{fnlMnuId}
                     , FNL_MDF_DH       = SYSDATE
                  WHEN NOT MATCHED THEN
                INSERT (
                    AUD_YR
                    , AUD_NO
                    , AUD_STEP_CD
                    , DOC_ID
                    , APVR_CD
                    , AFF_SNO
                    , DSP_RQ_SNO
                    , CNDIDAT_SRNO
                    , CNDIDT_NM
                    , CNDIDT_YMD
                    , CNDIDT_RANK_CD
                    , CNDIDT_ORG_CD
                    , CNDIDT_DPT_NM
                    , FRT_USR_ID
                    , FNL_USR_ID
                    , FNL_DEAL_DPT_CD
                    , FNL_MNU_ID
                    , FRT_REGI_DH
                    , FNL_MDF_DH
                ) VALUES (
                    #{audYr}
                    , #{audNo}
                    , #{audStepCd}
                    , #{docId}
                    , #{apvrCd}
                    , #{affSno}
                    , #{dspRqSno}
                    , (SELECT NVL(MAX(ST.CNDIDAT_SRNO),0)+1
                         FROM TBBADDED146D ST
                        WHERE ST.AUD_YR = #{audYr} 
                          AND ST.AUD_NO = #{audNo} 
                          AND ST.AUD_STEP_CD = #{audStepCd} 
                          AND ST.DOC_ID = #{docId}
                          AND ST.APVR_CD = #{apvrCd}
                          AND ST.AFF_SNO = #{affSno}
                          AND ST.DSP_RQ_SNO = #{dspRqSno})
                    , #{cndidtNm}
                    , REPLACE(#{cndidtYmd},'-')
                    , #{cndidtRankCd}
                    , #{cndidtOrgCd}
                    , #{cndidtDptNm}
                    , #{fnlUsrId}
                    , #{fnlUsrId}
                    , #{fnlDealDptCd}
                    , #{fnlMnuId}
                    , SYSDATE
                    , SYSDATE )
        ]]>
    </insert>
    
    <delete id="deleteSubList" parameterType="paramMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC015PMapper.deleteSubList*/
        <![CDATA[
            DELETE 
              FROM TBBADDED146D 
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = #{audStepCd} 
               AND DOC_ID = #{docId} 
               AND APVR_CD = #{apvrCd} 
               AND AFF_SNO = #{affSno} 
               AND DSP_RQ_SNO = #{dspRqSno} 
               AND CNDIDAT_SRNO = #{cndidatSrno} 
        ]]>
    </delete>
    
    
</mapper>