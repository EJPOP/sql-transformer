<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.rla.dao.AEPRLA005EMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA005EMapper.selectMainList*/
        <include refid="include.pageSelct" />
    <![CDATA[
			SELECT 
					CASE WHEN D1.LEGAL_REQ_DVSN_CD = '10' THEN '수사요청'
						 WHEN D1.LEGAL_REQ_DVSN_CD = '20' THEN '직접고발'
					 END 																	AS LEGAL_REQ_DVSN_NM
					,D1.LEGAL_REQ_SRNO
					,D7.PEOPLE_CNT
					,D1.INV_ACC_CNT
					,F_MNG_KND_AUDYRNO(D1.WRK_YR, D1.WRK_NO, D2.AUD_KND_CD, '-') 			AS AUD_YR_NO
					,D2.AUD_SBJ_NM 
					,CASE WHEN D3.DSP_RQ_SNO IS NOT NULL THEN F_MNG_KND_AUDYRNO(D3.AUD_YR, D3.AUD_NO, D2.AUD_KND_CD, '-') || '-' || D4.AFF_CD || '-' || D3.AFF_DSP_CD
						  ELSE ''
					  END 																	AS DSP_RQ_SNO_NM
					,F_CODE_NM('1000002', D3.DSP_RQ_CD) 									AS DSP_RQ_KND_NM
					,D4.TITLE_NM
					,CASE WHEN D1.AUD_DT IS NOT NULL THEN TO_CHAR(TO_DATE(D1.AUD_DT),'YYYY-MM-DD')
					 	  ELSE TO_CHAR(TO_DATE(D6.AUD_STR_DT),'YYYY-MM-DD')
					  END 																	AS AUD_DT
					,CASE WHEN D1.ENF_DT IS NOT NULL THEN TO_CHAR(TO_DATE(D1.ENF_DT),'YYYY-MM-DD') 
						  ELSE  TO_CHAR(TO_DATE(D8.ENF_DT),'YYYY-MM-DD') 								
					 END 																	AS ENF_DT
					,F_ORG_INFO(D1.HND_ORG_CD, '1') 										AS HND_ORG_NM
					,F_ORG_INFO(D1.RLTN_ORG_CD, '1') 										AS RLTN_ORG_NM
					,F_DPT_INFO(D1.MNG_DPT_CD, '1') 										AS MNG_DPT_NM
					,F_DPT_INFO(D2.SPV_BRDV_CD, '1') 										AS SPV_BRDV_NM					
					,CASE WHEN D7.PEOPLE_CNT = 1 THEN D7.DEFDT_NAM
						  WHEN D7.PEOPLE_CNT > 1 THEN D7.DEFDT_NAM || ' 외 ' || D7.PEOPLE_CNT || '명'
						  ELSE ''
					 END																	AS DEFDT_NAM
					,CASE WHEN D7.DEFDT_EIN IS NOT NULL THEN SUBSTR(DGUARD.DECRYPT('TB_ENC','EIN',D7.DEFDT_EIN),0,6) || '-' || SUBSTR(DGUARD.DECRYPT('TB_ENC','EIN',D7.DEFDT_EIN),7,13)
						  ELSE ''
					  END 																	AS DEFDT_EIN
					,TO_CHAR(TO_DATE(D1.INV_ORG_SUP_DT),'YYYY-MM-DD') 						AS INV_ORG_SUP_DT
					,TO_CHAR(TO_DATE(D1.AUD_NOTI_DT),'YYYY-MM-DD') 							AS AUD_NOTI_DT
					,D1.INDICT_SUBT
					,CASE WHEN D1.NON_INDICT_DVSN_CD = '10' THEN '범죄성립'
						  WHEN D1.NON_INDICT_DVSN_CD = '20' THEN '범죄불성립'
					  END 																	AS NON_INDICT_DVSN_NM					
					,D1.NON_INDICT_SUBT
					,D1.AUD_NOTI_TYPE
					,F_ORG_INFO(D1.INV_ORG_CD, '1') 										AS INV_ORG_NM
					,D1.RMK
					,D1.WRK_YR
					,D1.WRK_NO					
					,D1.AUD_STEP_CD
					,D3.DSP_RQ_SNO
					,D2.AUD_GRN_NO
					,SUBSTR(F_MNG_KND_AUDYRNO(D1.WRK_YR, D1.WRK_NO, D2.AUD_KND_CD, '-'),6,2) || '감사' AS AUD_KND_NM
					,CASE WHEN D3.DSP_RQ_SNO IS NOT NULL THEN D4.AFF_CD
						  ELSE ''
					  END 																	AS AFF_CD					
					,D5.WRK_DVSN_CD
					,D1.LEGAL_DPT_CD
					,D1.LEGAL_REQ_DVSN_CD
					,D1.NON_INDICT_DVSN_CD
					,D2.AUD_KND_CD
					,F_MNG_KND_AUDYRNO(D3.AUD_YR, D3.AUD_NO, D2.AUD_KND_CD, '-') 			AS AUD_YR_NO2
					,D3.AUD_YR 																AS AUD_YR2
					,D3.AUD_NO 																AS AUD_NO2
					,D3.AUD_GRN_NO															AS AUD_GRN_NO2
					,CASE WHEN D3.AUD_GRN_NO IS NOT NULL THEN SUBSTR(F_MNG_KND_AUDYRNO(D3.AUD_YR, D3.AUD_NO, D2.AUD_KND_CD, '-'),6,2) || '감사' 
						  ELSE ''
					 END 																	AS AUD_KND_NM2	
					,CASE WHEN D7.PEOPLE_CNT = 1 THEN D7.DEFDT_NAM
						  WHEN D7.PEOPLE_CNT > 1 THEN D7.DEFDT_NAM || ' 외 ' || D7.PEOPLE_CNT || '명'
						  ELSE ''
					 END																	AS DEFDT_NAM2
					,CASE WHEN D7.DEFDT_EIN IS NOT NULL THEN SUBSTR(DGUARD.DECRYPT('TB_ENC','EIN',D7.DEFDT_EIN),0,6) || '-' || SUBSTR(DGUARD.DECRYPT('TB_ENC','EIN',D7.DEFDT_EIN),7,13)
						  ELSE ''
					  END 																	AS DEFDT_EIN2	
				FROM TBBADDED126D D1
				INNER JOIN TBBADDED001M D2
				 	ON D2.AUD_YR = D1.WRK_YR 
				 		AND D2.AUD_NO = D1.WRK_NO
				INNER JOIN TBBADDED126M D5
				 	ON D5.WRK_YR = D1.WRK_YR 
				 		AND D5.WRK_NO = D1.WRK_NO 
				 		AND D5.WRK_DVSN_CD = D1.WRK_DVSN_CD
				 		AND D5.AUD_STEP_CD = D1.AUD_STEP_CD
				 		AND D5.LEGAL_REQ_DVSN_CD = D1.LEGAL_REQ_DVSN_CD
				 		AND D5.LEGAL_REQ_SRNO =	D1.LEGAL_REQ_SRNO 
				 		AND D5.REQ_STAT_CD BETWEEN 20 AND 70
				 		AND D5.HIDDEN_YN = 'N'
			 	LEFT OUTER JOIN TBBADDED145M D4
				    ON D4.AUD_YR = D1.WRK_YR
				     	AND D4.AUD_NO = D1.WRK_NO
				     	AND D4.AFF_SNO  = D5.AFF_SNO
				     	AND D4.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
				                        	FROM (
					                            SELECT RANK() OVER (PARTITION BY T2.DOC_ID ORDER BY DECODE(T2.APVR_CD, 'A1070', 1, '100600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
					                                 , T2.APVR_CD
					                                 , T2.DOC_ID
					                                 , T2.AUD_YR
					                                 , T2.AUD_NO
					                              FROM TBBADDED145M T2
					                             WHERE T2.APVR_CD <> '0010200'
					                             GROUP BY T2.AUD_YR, T2.AUD_NO, T2.DOC_ID, T2.APVR_CD )   
					                       WHERE RN = 1
					                         AND D4.DOC_ID = DOC_ID
					                         AND D4.AUD_YR = AUD_YR                     
					                         AND D4.AUD_NO = AUD_NO )
				LEFT OUTER JOIN TBBADDED146M D3
					ON D3.AUD_YR = D1.WRK_YR
						AND D3.AUD_NO = D1.WRK_NO
						--AND D3.AUD_STEP_CD = D1.AUD_STEP_CD
						AND D3.AFF_SNO = D5.AFF_SNO
						AND D3.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
					                        FROM (
					                            SELECT RANK() OVER (PARTITION BY T2.DOC_ID ORDER BY DECODE(T2.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
					                                 , T2.APVR_CD
					                                 , T2.DOC_ID
					                                 , T2.AUD_YR
					                                 , T2.AUD_NO
					                              FROM TBBADDED146M T2
					                             WHERE T2.APVR_CD <> '0010200'
					                             GROUP BY T2.AUD_YR, T2.AUD_NO, T2.DOC_ID, T2.APVR_CD)
					                       WHERE RN = 1
					                         AND D3.DOC_ID = DOC_ID
					                         AND D3.AUD_YR = AUD_YR
					                         AND D3.AUD_NO = AUD_NO)
				LEFT OUTER JOIN (SELECT WRK_YR
										,WRK_NO
										,WRK_DVSN_CD 
										,AUD_STEP_CD
										,LEGAL_REQ_DVSN_CD 
										,LEGAL_REQ_SRNO
										,INV_ACC_PRSN_SRNO
										,FIRST_VALUE(DEFDT_NAM) OVER(PARTITION BY WRK_YR,WRK_NO,WRK_DVSN_CD,AUD_STEP_CD,LEGAL_REQ_DVSN_CD,LEGAL_REQ_SRNO ORDER BY INV_ACC_PRSN_SRNO) AS DEFDT_NAM
										,FIRST_VALUE(DEFDT_EIN) OVER(PARTITION BY WRK_YR,WRK_NO,WRK_DVSN_CD,AUD_STEP_CD,LEGAL_REQ_DVSN_CD,LEGAL_REQ_SRNO ORDER BY INV_ACC_PRSN_SRNO) AS DEFDT_EIN
										,COUNT(DEFDT_NAM) OVER(PARTITION BY WRK_YR,WRK_NO,WRK_DVSN_CD,AUD_STEP_CD,LEGAL_REQ_DVSN_CD,LEGAL_REQ_SRNO) AS PEOPLE_CNT
									FROM TBBADDED126L) D7
					ON D7.WRK_YR = D1.WRK_YR 
					 	AND D7.WRK_NO = D1.WRK_NO 
					 	AND D7.WRK_DVSN_CD = D1.WRK_DVSN_CD
					 	AND D7.AUD_STEP_CD = D1.AUD_STEP_CD
					 	AND D7.LEGAL_REQ_DVSN_CD = D1.LEGAL_REQ_DVSN_CD
					 	AND D7.LEGAL_REQ_SRNO =	D1.LEGAL_REQ_SRNO
					 	AND	D7.INV_ACC_PRSN_SRNO = (SELECT MIN(T2.INV_ACC_PRSN_SRNO) 
														FROM TBBADDED126L T2
														WHERE T2.WRK_YR = D1.WRK_YR 
														 	AND T2.WRK_NO = D1.WRK_NO 
														 	AND T2.WRK_DVSN_CD = D1.WRK_DVSN_CD
														 	AND T2.AUD_STEP_CD = D1.AUD_STEP_CD
														 	AND T2.LEGAL_REQ_DVSN_CD = D1.LEGAL_REQ_DVSN_CD
														 	AND T2.LEGAL_REQ_SRNO =	D1.LEGAL_REQ_SRNO)
				LEFT OUTER JOIN TBBADDED002M D6
					ON D6.REL_AUD_YR = D1.WRK_YR
						AND D6.REL_AUD_NO = D1.WRK_NO
						AND D6.AUD_BZT_KND_CD = '02'	--최초 실지감사 시작
				LEFT OUTER JOIN TBBADEAR002D D8
					ON D8.AUD_YR = D1.WRK_YR 
						AND D8.AUD_NO = D1.WRK_YR
						AND D8.DSP_RQ_SNO = D3.DSP_RQ_SNO	
				WHERE 1=1
		]]>
		       <if test="schAudYr != null and schAudYr != ''">
                   AND D1.WRK_YR = #{schAudYr}
               </if>
               <if test="schAudYrNoKndCd != null and schAudYrNoKndCd != ''">
                   AND D2.AUD_KND_CD = #{schAudYrNoKndCd}
               </if>
               <if test="schAudGrnNo != null and schAudGrnNo != ''">
                   AND D2.AUD_GRN_NO = #{schAudGrnNo}
               </if>
               <if test="schAudSbjNm != null and schAudSbjNm != ''">
                   AND D2.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
               </if>
               <if test="schAudYr2 != null and schAudYr2 != ''">
                   AND D1.WRK_YR = #{schAudYr2}
               </if>
               <if test="schAudYrNoKndCd2 != null and schAudYrNoKndCd2 != ''">
                   AND D2.AUD_KND_CD = #{schAudYrNoKndCd2}
               </if>
               <if test="schAudGrnNo2 != null and schAudGrnNo2 != ''">
                   AND D2.AUD_GRN_NO = #{schAudGrnNo2}
               </if>
               <if test="schAudGrnNo2 != null and schAudGrnNo2 != ''">
                   AND D2.AUD_GRN_NO = #{schAudGrnNo2}
               </if>
               <if test="schAffSno != null and schAffSno != ''">
                   AND D4.AFF_CD = #{schAffSno}
               </if>
               <if test="schAudSbjNm2 != null and schAudSbjNm2 != ''">
                   AND D4.TITLE_NM LIKE '%'||#{schAudSbjNm2}||'%'
               </if>
               <if test="schlegalReqDvsnCd != null and schlegalReqDvsnCd != ''">
                   AND D1.LEGAL_REQ_DVSN_CD = #{schlegalReqDvsnCd}
               </if>                                                                          
        <![CDATA[	    
					AND D1.AUD_STEP_CD = 'A1060'
				 	AND D1.LEGAL_REQ_DVSN_CD IN ('10','20')
			ORDER BY D1.WRK_YR, D1.LEGAL_REQ_SRNO DESC
               ]]>
        <include refid="include.pageOrder" />
    </select>
    
        <insert id="updateMainDetail" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA005EMapper.updateMainDetail*/
            UPDATE TBBADDED126D
               SET AUD_DT 					= #{audDt} 
               	  ,ENF_DT					= #{enfDt}
               	  ,INV_ORG_SUP_DT           = #{invOrgSupDt}
                  ,AUD_NOTI_DT          	= #{audNotiDt}
                  ,INDICT_SUBT      		= #{indictSubt}
                  ,NON_INDICT_DVSN_CD       = #{nonIndictDvsnCd}
                  ,NON_INDICT_SUBT          = #{nonIndictSubt}
                  ,AUD_NOTI_TYPE 			= #{audNotiType}
                  ,INV_ORG_CD 				= #{invOrgCd}
                  ,RMK 						= #{rmk}
             WHERE 
                   WRK_YR           		= #{wrkYr}
                   AND WRK_NO       		= #{wrkNo}
                   AND LEGAL_REQ_DVSN_CD    = #{legalReqDvsnCd}
                   AND LEGAL_REQ_SRNO    	= #{legalReqSrno}
    </insert>
    
</mapper> 