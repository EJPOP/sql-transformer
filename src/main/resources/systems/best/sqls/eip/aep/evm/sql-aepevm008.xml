<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper">		
    <select id="selectMppRsn" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.selectMppRsn */
			SELECT MAX(MPP_RSN) AS MPP_RSN
			FROM TBBADDED148M
			WHERE 1=1
				AND AUD_YR = #{audYr}
				AND AUD_NO = #{audNo}
				AND AUD_STEP_CD = #{audStepCd}
			<if test='audStepCd != null and audStepCd != "A1050"'> 
				AND DOC_ID = #{docId}
			</if>
				AND APVR_CD = #{apvrCd}
				AND AFF_SNO = #{affSno}
				AND DSP_RQ_SNO = #{dspRqSno}
		        <if test='type != null and type != "08" '>
		        	AND MPP_SEQ = #{mppSeq}
		        </if>
           <if test='affNo != null and affNo != ""'>
               AND AFF_NO = #{affNo}
			</if>
		<choose>
			<when test='type != null and type == "08" '> 
				AND AFF_MPP_DVSN_CD IN ('D30', 'D40', 'D21', 'D20')
			</when>
			<when test='type != null and type == "10" '> 
				AND AFF_MPP_DVSN_CD IN ('D70', 'D80', 'D90', 'D99')
			</when>
			<when test='type != null and type == "11" '> 
				AND AFF_MPP_DVSN_CD IN ('D50', 'D81')
			</when>
			<when test='type != null and type == "12" '> 
				AND AFF_MPP_DVSN_CD IN ('D21', 'D20')
			</when>
			<otherwise>
				AND AFF_MPP_DVSN_CD IN ('')
			</otherwise>
		</choose>
               
    </select>
    
    <select id="selectCheckDvsn" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.selectCheckDvsn */
			SELECT AFF_MPP_DVSN_CD
			FROM TBBADDED148M
			WHERE 1=1
				AND AUD_YR = #{audYr}
				AND AUD_NO = #{audNo}
				AND AUD_STEP_CD = #{audStepCd}
			<if test='audStepCd != null and audStepCd != "A1050"'> 
				AND DOC_ID = #{docId}
			</if>
				AND APVR_CD = #{apvrCd}
				AND AFF_SNO = #{affSno}
				AND DSP_RQ_SNO = #{dspRqSno}
				AND MPP_SEQ = #{mppSeq}
           <if test='affNo != null and affNo != ""'>
               AND AFF_NO = #{affNo}
           </if>
		<choose>
			<when test='type != null and type == "08" '> 
				AND AFF_MPP_DVSN_CD IN ('D30', 'D40', 'D21', 'D20')
			</when>
			<when test='type != null and type == "10" '> 
				AND AFF_MPP_DVSN_CD IN ('D70', 'D80', 'D90', 'D99')
			</when>
			<when test='type != null and type == "11" '> 
				AND AFF_MPP_DVSN_CD IN ('D50', 'D81')
			</when>
			<when test='type != null and type == "12" '> 
				AND AFF_MPP_DVSN_CD IN ('D21', 'D20')
			</when>
			<otherwise>
				AND AFF_MPP_DVSN_CD IN ('')
			</otherwise>
		</choose>
			GROUP BY AFF_MPP_DVSN_CD
			
    </select>
    
    
    <select id="selectDspRqCdValue148" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper."selectDspRqCdValue148" */
        	SELECT 
				PRE_DSP_RQ_CD AS PRE_CD
				, F_CODE_NM('1000002', PRE_DSP_RQ_CD ) AS PRE_CD_NM
				, DSP_RQ_CD AS CD
				, F_CODE_NM('1000002', DSP_RQ_CD ) AS CD_NM
			FROM TBBADDED148M 
			WHERE 1=1
	          	AND AUD_YR = #{audYr}
				AND AUD_NO = #{audNo}
				AND AUD_STEP_CD = #{audStepCd}
			<if test='audStepCd != null and audStepCd != "A1050"'> 
				AND DOC_ID = #{docId}
			</if>
				AND APVR_CD = #{apvrCd}
				AND AFF_SNO = #{affSno}
				AND DSP_RQ_SNO = #{dspRqSno}
				AND MPP_SEQ = #{mppSeq}
				AND PRE_DSP_RQ_CD IS NOT NULL
			 AND ROWNUM = 1
    </select>
    
     <select id="selectPreDspRqCdValue146" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.selectPreDspRqCdValue146 */
        	<!-- 
        	SELECT 
				C.DSP_RQ_CD AS CD
				, D.CD_NM AS CD_NM
				, D.CMM_CD_DVSN_CD AS CMM_CD_DVSN_CD
			FROM 
				(
					SELECT 
						 B.DSP_RQ_CD 
					FROM TBBADDED147M A
					INNER JOIN TBBADDED146M B
						ON A.AUD_YR = B.AUD_YR
						AND A.AUD_NO = B.AUD_NO
						AND A.AUD_STEP_CD = B.AUD_STEP_CD
						AND A.DOC_ID = B.DOC_ID
						AND A.APVR_CD = B.APVR_CD
						AND A.AFF_SNO = B.AFF_SNO
						AND A.DSP_RQ_SNO = B.DSP_RQ_SNO
					WHERE 1=1
		            <if test='preAffNo != null and preAffNo != ""'>
		               AND A.PRE_AFF_NO = #{preAffNo}
		           </if>
		           <if test='affNo != null and affNo != ""'>
		               AND A.AFF_NO = #{affNo}
		           </if>
		               AND A.APVR_CD = #{apvrCd}
				) C, 
				TBDCMACM013C D
			WHERE 1=1
				AND C.DSP_RQ_CD = D.CD
				AND CMM_CD_DVSN_CD = '1000002'
				AND D.TSK_CAT_CD = 'AD'
				AND D.FUNC_CAT_CD = 'AR'
				AND D.USE_YN = 'Y'
				 -->
				 
			<!-- 	 
			SELECT	BB.DSP_RQ_CD AS CD
					, F_CODE_NM('1000002', BB.DSP_RQ_CD ) AS CD_NM 
			FROM TBBADDED147M AA
				, TBBADDED146M BB
				, (
					SELECT 
						<if test='audStepCd == "A1050"'>
		               		AFF_NO AS JOIN_AFF_NO
		           		</if>
		           		<if test='audStepCd != "A1050"'>
		               		PRE_AFF_NO AS JOIN_AFF_NO
		           		</if>
					FROM TBBADDED147M 
					WHERE 1=1
						AND AFF_NO = #{affNo}
						<if test='audStepCd != "A1050"'>
							<choose>
								<when test='apvrCd != null and apvrCd == "0010200" '> 종료보고일때
									AND APVR_CD = '0013600'
								</when>
								<when test='apvrCd != null and apvrCd == "0013600" '> 과장일때
									AND APVR_CD IN ('0015800', '0035100', '0058100')
								</when>
								<when test='apvrCd != null and apvrCd == "0015800"  or apvrCd == "0035100" or  apvrCd == "0058100" '> 
									AND APVR_CD IN ('0055600', '0045900') 
								</when>
								<when test='apvrCd != null and apvrCd == "0055600" or apvrCd == "0045900" '> 
									AND APVR_CD = '0055700'
								</when>
								<when test='apvrCd != null and apvrCd == "0055700" '> 
									AND APVR_CD = '0010600'
								</when>
								<when test='apvrCd != null and apvrCd == "0010600" '> 
									AND APVR_CD = 'A1070'
								</when>
								<otherwise>
									AND APVR_CD =#{apvrCd}
								</otherwise>
							</choose>
						</if>
				) CC	
			WHERE 1=1
				AND AA.AUD_YR = BB.AUD_YR
				AND AA.AUD_NO = BB.AUD_NO
				AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
				AND AA.APVR_CD = BB.APVR_CD
				AND AA.AFF_SNO = BB.AFF_SNO
				AND AA.DSP_RQ_SNO = BB.DSP_RQ_SNO
				AND AA.APVR_CD = #{apvrCd}
				AND AA.AFF_NO = CC.JOIN_AFF_NO
			 -->	
						
			SELECT AA.DSP_RQ_CD AS CD
					, F_CODE_NM('1000002', AA.DSP_RQ_CD ) AS CD_NM
			FROM TBBADDED146M AA
				, TBBADDED147M BB
				, (		
					SELECT 
						AA.PRE_AFF_NO	
					FROM TBBADDED147M AA
						, (
							SELECT
								AFF_NO 
							FROM TBBADDED147M 
							WHERE 1=1
								AND PRE_AFF_NO = #{affNo}
								AND APVR_CD = #{nxtApvrCd}
						) BB	
					WHERE 1=1
						AND AA.APVR_CD = #{nxtApvrCd}
						AND AA.AFF_NO = BB.AFF_NO
				) CC
			WHERE 1=1
				AND AA.AUD_YR = BB.AUD_YR
				AND AA.AUD_NO = BB.AUD_NO
				AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
				AND AA.APVR_CD = BB.APVR_CD
				AND AA.AFF_SNO = BB.AFF_SNO
				AND AA.DSP_RQ_SNO = BB.DSP_RQ_SNO
				AND BB.APVR_CD = #{apvrCd}
				AND BB.AFF_NO = CC.PRE_AFF_NO
				
    </select>
    
    
    <select id="selectPreDspRqCdList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.selectPreDspRqCdList */
        	<!-- 
        	SELECT 
				C.DSP_RQ_CD AS CD
				, D.CD_NM AS CD_NM
				, D.CMM_CD_DVSN_CD AS CMM_CD_DVSN_CD
			FROM 
				(
					SELECT 
						B.DSP_RQ_CD
					FROM TBBADDED148M A
					INNER JOIN TBBADDED146M B
						ON A.AUD_YR = B.AUD_YR
						AND A.AUD_NO = B.AUD_NO
						AND A.AUD_STEP_CD = B.AUD_STEP_CD
						AND A.DOC_ID = B.DOC_ID
						AND A.APVR_CD = B.APVR_CD
						AND A.AFF_SNO = B.AFF_SNO
						AND A.DSP_RQ_SNO = B.DSP_RQ_SNO
					WHERE 1=1
					<if test='preAffNo != null and preAffNo != ""'>
		               AND A.PRE_AFF_NO = #{preAffNo}
		           </if>
		           <if test='affNo != null and affNo != ""'>
		               AND A.AFF_NO = #{affNo}
		           </if>
		               AND A.APVR_CD = #{apvrCd}
				) C, 
				TBDCMACM013C D
			WHERE 1=1
				AND C.DSP_RQ_CD = D.CD
				AND CMM_CD_DVSN_CD = '1000002'
				AND D.TSK_CAT_CD = 'AD'
				AND D.FUNC_CAT_CD = 'AR'
				AND D.USE_YN = 'Y'  
				 -->
				 <!-- 
				SELECT
					A.DSP_RQ_CD AS CD
					, F_CODE_NM('1000002', A.DSP_RQ_CD ) AS CD_NM 
				FROM TBBADDED146M A
				INNER JOIN TBBADDED147M B
					ON A.AUD_YR = B.AUD_YR
					AND A.AUD_NO = B.AUD_NO
					AND A.AUD_STEP_CD = B.AUD_STEP_CD
					AND A.DOC_ID = B.DOC_ID
					AND A.APVR_CD = B.APVR_CD
					AND A.AFF_SNO = B.AFF_SNO
					AND A.DSP_RQ_SNO = B.DSP_RQ_SNO
				WHERE 1=1
				<if test='audStepCd == "A1050"'>
					AND B.AFF_NO = #{affNo}
				</if>	
				<if test='audStepCd != "A1050"'>
					AND B.AFF_NO = #{affNo}
					AND B.APVR_CD = #{apvrCd}
				</if>
				GROUP BY A.DSP_RQ_CD, A.DSP_RQ_CD
				 -->
				
				SELECT AA.DSP_RQ_CD AS CD
						, F_CODE_NM('1000002', AA.DSP_RQ_CD ) AS CD_NM
				FROM TBBADDED146M AA
					, TBBADDED147M BB
					, (		
						SELECT 
							AA.PRE_AFF_NO	
						FROM TBBADDED147M AA
							, (
								SELECT 
									AFF_NO 
								FROM TBBADDED147M 
								WHERE 1=1
									AND PRE_AFF_NO = #{affNo}
									AND APVR_CD = #{nxtApvrCd}
							) BB	
						WHERE 1=1
							AND AA.APVR_CD = #{nxtApvrCd}
							AND AA.AFF_NO = BB.AFF_NO
					) CC
				WHERE 1=1
					AND AA.AUD_YR = BB.AUD_YR
					AND AA.AUD_NO = BB.AUD_NO
					AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
					AND AA.APVR_CD = BB.APVR_CD
					AND AA.AFF_SNO = BB.AFF_SNO
					AND AA.DSP_RQ_SNO = BB.DSP_RQ_SNO
					AND BB.APVR_CD = #{apvrCd}
					AND BB.AFF_NO = CC.PRE_AFF_NO
				GROUP BY AA.DSP_RQ_CD, AA.DSP_RQ_CD
    </select>
    
    
    <select id="selectNtxDspRqCdValue146" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.selectNtxDspRqCdValue146 */
        	<!-- 
        	SELECT 
				C.DSP_RQ_CD AS CD
				, D.CD_NM AS CD_NM
				, D.CMM_CD_DVSN_CD AS CMM_CD_DVSN_CD
			FROM 
				(
					SELECT 
						 B.DSP_RQ_CD 
					FROM TBBADDED147M A
					INNER JOIN TBBADDED146M B
						ON A.AUD_YR = B.AUD_YR
						AND A.AUD_NO = B.AUD_NO
						AND A.AUD_STEP_CD = B.AUD_STEP_CD
						AND A.DOC_ID = B.DOC_ID
						AND A.APVR_CD = B.APVR_CD
						AND A.AFF_SNO = B.AFF_SNO
						AND A.DSP_RQ_SNO = B.DSP_RQ_SNO
					WHERE 1=1
		           <if test='preAffNo != null and preAffNo != ""'>
		               AND A.AFF_NO = #{preAffNo}
		           </if>
		           <if test='affNo != null and affNo != ""'>
		               AND A.PRE_AFF_NO = #{affNo}
		           </if>
		               AND A.APVR_CD = #{apvrCd}
				) C, 
				TBDCMACM013C D
			WHERE 1=1
				AND C.DSP_RQ_CD = D.CD
				AND CMM_CD_DVSN_CD = '1000002'
				AND D.TSK_CAT_CD = 'AD'
				AND D.FUNC_CAT_CD = 'AR'
				AND D.USE_YN = 'Y'      
				 -->
			
				SELECT 
					 B.DSP_RQ_CD AS CD
					, F_CODE_NM('1000002', B.DSP_RQ_CD ) AS CD_NM 
				FROM TBBADDED147M A
				INNER JOIN TBBADDED146M B
					ON A.AUD_YR = B.AUD_YR
					AND A.AUD_NO = B.AUD_NO
					AND A.AUD_STEP_CD = B.AUD_STEP_CD
					AND A.APVR_CD = B.APVR_CD
					AND A.AFF_SNO = B.AFF_SNO
					AND A.DSP_RQ_SNO = B.DSP_RQ_SNO
				WHERE 1=1
					AND A.PRE_AFF_NO = #{affNo}
					AND A.APVR_CD = #{nxtApvrCd}
				GROUP BY B.DSP_RQ_CD, B.DSP_RQ_CD
    </select>
    
    
    <select id="selectNtxDspRqCdList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.selectNtxDspRqCdList */
        	<!-- 
        	SELECT 
				C.DSP_RQ_CD AS CD
				, D.CD_NM AS CD_NM
				, D.CMM_CD_DVSN_CD AS CMM_CD_DVSN_CD
			FROM 
				(
					SELECT 
						 B.DSP_RQ_CD 
					FROM TBBADDED148M A
					INNER JOIN TBBADDED146M B
						ON A.AUD_YR = B.AUD_YR
						AND A.AUD_NO = B.AUD_NO
						AND A.AUD_STEP_CD = B.AUD_STEP_CD
						AND A.DOC_ID = B.DOC_ID
						AND A.APVR_CD = B.APVR_CD
						AND A.AFF_SNO = B.AFF_SNO
						AND A.DSP_RQ_SNO = B.DSP_RQ_SNO
					WHERE 1=1
					<if test='preAffNo != null and preAffNo != ""'>
		               AND A.AFF_NO = #{preAffNo}
		           </if>
		           <if test='affNo != null and affNo != ""'>
		               AND A.PRE_AFF_NO = #{affNo}
		           </if>
		               AND A.APVR_CD = #{apvrCd}
				) C, 
				TBDCMACM013C D
			WHERE 1=1
				AND C.DSP_RQ_CD = D.CD
				AND CMM_CD_DVSN_CD = '1000002'
				AND D.TSK_CAT_CD = 'AD'
				AND D.FUNC_CAT_CD = 'AR'
				AND D.USE_YN = 'Y'
				 -->
				
				SELECT
					A.DSP_RQ_CD AS CD
					, F_CODE_NM('1000002', A.DSP_RQ_CD ) AS CD_NM 
				FROM TBBADDED146M A
				INNER JOIN TBBADDED147M B
					ON A.AUD_YR = B.AUD_YR
					AND A.AUD_NO = B.AUD_NO
					AND A.AUD_STEP_CD = B.AUD_STEP_CD
					<!-- AND A.DOC_ID = B.DOC_ID -->
					AND A.APVR_CD = B.APVR_CD
					AND A.AFF_SNO = B.AFF_SNO
					AND A.DSP_RQ_SNO = B.DSP_RQ_SNO
				WHERE 1=1
					AND B.PRE_AFF_NO = #{affNo}
					AND A.APVR_CD = #{nxtApvrCd}
				GROUP BY A.DSP_RQ_CD, A.DSP_RQ_CD	
				
					<!-- 
					<choose>
						<when test='apvrCd != null and apvrCd == "0010200" '> 종료보고일때
							AND B.APVR_CD = '0013600'
						</when>
						<when test='apvrCd != null and apvrCd == "0013600" '> 종료보고일때
							AND B.APVR_CD IN ('0015800', '0035100', '0058100')
						</when>
						<when test='apvrCd != null and apvrCd == "0015800"  or apvrCd == "0035100" or  apvrCd == "0058100" '> 
							AND B.APVR_CD IN ('0055600', '0045900') 
						</when>
						<when test='apvrCd != null and apvrCd == "0055600" or apvrCd == "0045900" '> 
							AND B.APVR_CD = '0055700'
						</when>
						<when test='apvrCd != null and apvrCd == "0055700" '> 
							AND B.APVR_CD = '0010600'
						</when>
						<when test='apvrCd != null and apvrCd == "0010600" '> 
							AND B.APVR_CD = 'A1070'
						</when>
						<otherwise>
							AND B.APVR_CD =#{apvrCd}
						</otherwise>
					</choose>
					 -->
				
    </select>
    
    
    
    <insert id="deleteDsvnData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.deleteDsvnData */
        	DECLARE
        		BEGIN
        			INSERT INTO TBBADDED148H
					(
						HST_DVSN_CD
						, HST_SNO
						, HST_DH
						, HST_USR_ID
						
						, AUD_YR
						, AUD_NO
						, AUD_STEP_CD
						, DOC_ID
						, APVR_CD
						, AFF_SNO
						, DSP_RQ_SNO
						, MPP_SEQ
						, AFF_DVSN_SEQ
						
						, PRE_AFF_NO
						, AFF_NO
						, AFF_MPP_DVSN_CD
						, PRE_DSP_RQ_CD
						, DSP_RQ_CD
						, MPP_RSN
						
						, FRT_USR_ID
						, FNL_USR_ID
						, FNL_DEAL_DPT_CD
						, FNL_MNU_ID
						, FRT_REGI_DH
						, FNL_MDF_DH
					)
					SELECT 
						'D'
						, TBBADDED148H_SEQ.NEXTVAL
						, SYSDATE
						, #{frtUsrId}
						
						, AUD_YR
						, AUD_NO
						, AUD_STEP_CD
						, DOC_ID
						, APVR_CD
						, AFF_SNO
						, DSP_RQ_SNO
						, MPP_SEQ
						, AFF_DVSN_SEQ
						
						, PRE_AFF_NO
						, AFF_NO
						, AFF_MPP_DVSN_CD
						, PRE_DSP_RQ_CD
						, DSP_RQ_CD
						, MPP_RSN
						
						, FRT_USR_ID
						, FNL_USR_ID
						, FNL_DEAL_DPT_CD
						, FNL_MNU_ID
						, FRT_REGI_DH
						, FNL_MDF_DH	
					FROM TBBADDED148M
					WHERE AUD_YR = #{audYr}
						AND AUD_NO = #{audNo}
						AND AUD_STEP_CD = #{audStepCd}
						<if test='audStepCd != null and audStepCd != "A1050"'> 
							AND DOC_ID = #{docId}
						</if>
						AND APVR_CD = #{apvrCd}
						AND AFF_SNO = #{affSno}
						AND DSP_RQ_SNO = #{dspRqSno}
						 <if test='type != null and type != "08" '>
				        	AND MPP_SEQ = #{mppSeq}
				        </if>
						<if test='affNo != null and affNo != ""'>
							AND AFF_NO = #{affNo}
						<choose>
							<when test='type != null and type == "08" '> 
								AND AFF_MPP_DVSN_CD IN ('D30', 'D40', 'D21', 'D20')
							</when>
							<when test='type != null and type == "10" '> 
								AND AFF_MPP_DVSN_CD IN ('D70', 'D80', 'D90', 'D99')
							</when>
							<when test='type != null and type == "11" '> 
								AND AFF_MPP_DVSN_CD IN ('D50', 'D81')
							</when>
							<when test='type != null and type == "12" '> 
								AND AFF_MPP_DVSN_CD IN ('D21', 'D20')
							</when>
							<when test='type != null and type == "13" '> 
								AND AFF_MPP_DVSN_CD IN ('A90', 'A91', 'A92', 'A99')
							</when>
							<otherwise>
								AND AFF_MPP_DVSN_CD IN ('')
							</otherwise>
						</choose>
						
						</if>
					;
				
			        DELETE FROM TBBADDED148M 
					WHERE 1=1
						AND AUD_YR = #{audYr}
						AND AUD_NO = #{audNo}
						AND AUD_STEP_CD = #{audStepCd}
					<if test='audStepCd != null and audStepCd != "A1050"'> 
						AND DOC_ID = #{docId}
					</if>
						AND APVR_CD = #{apvrCd}
						AND AFF_SNO = #{affSno}
						AND DSP_RQ_SNO = #{dspRqSno}
				        <if test='type != null and type != "08" '>
				        	AND MPP_SEQ = #{mppSeq}
				        </if>
						<!-- 
						<if test='preAffNo != null and preAffNo != ""'>
						AND PRE_AFF_NO = #{preAffNo}
						</if>
						 -->
				        <if test='affNo != null and affNo != ""'>
						AND AFF_NO = #{affNo}
						<choose>
							<when test='type != null and type == "08" '> 
								AND AFF_MPP_DVSN_CD IN ('D30', 'D40', 'D21', 'D20')
							</when>
							<when test='type != null and type == "10" '> 
								AND AFF_MPP_DVSN_CD IN ('D70', 'D80', 'D90', 'D99')
							</when>
							<when test='type != null and type == "11" '> 
								AND AFF_MPP_DVSN_CD IN ('D50', 'D81')
							</when>
							<when test='type != null and type == "12" '> 
								AND AFF_MPP_DVSN_CD IN ('D21', 'D20')
							</when>
							<when test='type != null and type == "13" '> 
								AND AFF_MPP_DVSN_CD IN ('A90', 'A91', 'A92', 'A99')
							</when>
							<otherwise>
								AND AFF_MPP_DVSN_CD IN ('')
							</otherwise>
						</choose>
						
						</if>
					;
				END;
    </insert>
    
    
    <insert id="insertDsvnData" parameterType="paramMap">
       /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.insertDsvnData */
       		DECLARE
        		BEGIN
		            INSERT INTO TBBADDED148M
					(
						AUD_YR
						, AUD_NO
						, AUD_STEP_CD
						, DOC_ID
						, APVR_CD
						, AFF_SNO
						, DSP_RQ_SNO
						, MPP_SEQ
						, AFF_DVSN_SEQ
						<if test='preAffNo != null and preAffNo != ""'>
							, PRE_AFF_NO
						</if>
						<if test='affNo != null and affNo != ""'>
							, AFF_NO
						</if>
						, AFF_MPP_DVSN_CD
						<if test='preDspRqCd != null and preDspRqCd != ""'>
							, PRE_DSP_RQ_CD
						</if>
						<if test='dspRqCd != null and dspRqCd != ""'>
							, DSP_RQ_CD
						</if>
						, MPP_RSN
						, FRT_USR_ID
						, FNL_USR_ID
						, FNL_DEAL_DPT_CD
						, FNL_MNU_ID
						, FRT_REGI_DH
						, FNL_MDF_DH
					)VALUES (
						#{audYr}
						, #{audNo}
						, #{audStepCd}
						, #{docId}
						, #{apvrCd}
						, #{affSno}
						, #{dspRqSno}
						, #{mppSeq}
						, SEQ_AFF_DVSN.NEXTVAL
						<if test='preAffNo != null and preAffNo != ""'>
							, #{preAffNo}
						</if>
						<if test='affNo != null and affNo != ""'>
							, #{affNo}
						</if>
							, #{affMppDvsnCd}
						<if test='preDspRqCd != null and preDspRqCd != ""'>
							, #{preDspRqCd}
						</if>
						<if test='dspRqCd != null and dspRqCd != ""'>
							, #{dspRqCd}
						</if>
						, #{mppRsnTxt}
						, #{frtUsrId}
						, #{fnlUsrId}
						, #{fnlDealDptCd}
						, #{fnlMnuId}
						, SYSDATE
						, SYSDATE
					)
					;
					
					INSERT INTO TBBADDED148H
					(
						HST_DVSN_CD
						, HST_SNO
						, HST_DH
						, HST_USR_ID
						
						, AUD_YR
						, AUD_NO
						, AUD_STEP_CD
						, DOC_ID
						, APVR_CD
						, AFF_SNO
						, DSP_RQ_SNO
						, MPP_SEQ
						, AFF_DVSN_SEQ
						
						, PRE_AFF_NO
						, AFF_NO
						, AFF_MPP_DVSN_CD
						, PRE_DSP_RQ_CD
						, DSP_RQ_CD
						, MPP_RSN
						
						, FRT_USR_ID
						, FNL_USR_ID
						, FNL_DEAL_DPT_CD
						, FNL_MNU_ID
						, FRT_REGI_DH
						, FNL_MDF_DH
					)
					SELECT 
						'C'
						, TBBADDED148H_SEQ.NEXTVAL
						, SYSDATE
						, #{frtUsrId}
						
						, AUD_YR
						, AUD_NO
						, AUD_STEP_CD
						, DOC_ID
						, APVR_CD
						, AFF_SNO
						, DSP_RQ_SNO
						, MPP_SEQ
						, AFF_DVSN_SEQ
						
						, PRE_AFF_NO
						, AFF_NO
						, AFF_MPP_DVSN_CD
						, PRE_DSP_RQ_CD
						, DSP_RQ_CD
						, MPP_RSN
						
						, FRT_USR_ID
						, FNL_USR_ID
						, FNL_DEAL_DPT_CD
						, FNL_MNU_ID
						, FRT_REGI_DH
						, FNL_MDF_DH	
					FROM TBBADDED148M
					WHERE AUD_YR = #{audYr}
						AND AUD_NO = #{audNo}
						AND AUD_STEP_CD = #{audStepCd}
						AND APVR_CD = #{apvrCd}
						AND AFF_SNO = #{affSno}
						AND DSP_RQ_SNO = #{dspRqSno}
						AND MPP_SEQ = #{mppSeq}
						AND AFF_NO = #{affNo}
					;
				END;
					
    </insert>
    
    
    <select id="selectDfAffList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.selectDfAffList */
        <![CDATA[
            SELECT 
                ROWNUM
                , T1.AUD_YR
                , T1.AUD_NO
                , T1.AUD_STEP_CD AS HD_AUD_STEP_CD
                , T1.DOC_ID AS HD_DOC_ID
                , T1.APVR_CD AS HD_APVR_CD
                , T1.AFF_SNO AS HD_AFF_SNO
                , T2.DSP_RQ_SNO AS HD_DSP_RQ_SNO
                , T3.AFF_NO 
                , T1.TITLE_NM
                , F_CODE_NM('1000002', T2.DSP_RQ_CD) AS DSP_RQ_NM
                , F_ORG_INFO(T2.RLTN_ORG_CD, 1) AS ORG_NM
                , CASE WHEN (T2.DF_AFF_SNO = #{affSno} AND T2.DF_DSP_RQ_SNO = #{dspRqSno} )
                            OR (SELECT COUNT(1) 
                                  FROM TBBADDED146M ST1
                                 WHERE ST1.AUD_YR = T2.AUD_YR
                                   AND ST1.AUD_NO = T2.AUD_NO
                                   AND ST1.HD_AFF_SNO = T2.AFF_SNO
                                   AND ST1.HD_DSP_RQ_SNO = T2.DSP_RQ_SNO
                                   AND ST1.AFF_SNO = #{affSno}
                                   AND ST1.DSP_RQ_SNO = #{dspRqSno} ) > 0 THEN 'Y' ELSE 'N' END AS SET_YN
              FROM TBBADDED145M T1
                   INNER JOIN TBBADDED146M T2
                   ON (T1.AUD_YR = T2.AUD_YR
                       AND T1.AUD_NO = T2.AUD_NO
                       AND T1.AUD_STEP_CD = T2.AUD_STEP_CD
                       AND T1.DOC_ID = T2.DOC_ID
                       AND T1.APVR_CD = T2.APVR_CD
                       AND T1.AFF_SNO = T2.AFF_SNO)
                   INNER JOIN TBBADDED148M T3
                   ON (T1.AUD_YR = T3.AUD_YR
                       AND T1.AUD_NO = T3.AUD_NO
                       AND T1.AUD_STEP_CD = T3.AUD_STEP_CD
                       AND T1.DOC_ID = T3.DOC_ID
                       AND T1.APVR_CD = T3.APVR_CD
                       AND T1.AFF_SNO = T3.AFF_SNO
                       AND T2.DSP_RQ_SNO = T3.DSP_RQ_SNO
                       AND T3.AFF_MPP_DVSN_CD = 'D80')
              WHERE T1.AUD_YR = #{audYr}
              AND T1.AUD_NO = #{audNo}
            ORDER BY T1.AFF_CD, T2.AFF_DSP_CD
         ]]>
    </select>
    
    <update id="resetReSbcnDfData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.resetReSbcnDfData */
        /* 보류처분요구에 재부의 처분요구 정보 초기화 */
            UPDATE TBBADDED146M
            SET 
                DF_AUD_STEP_CD = ''
                 , DF_DOC_ID = ''
                 , DF_APVR_CD = ''
                 , DF_AFF_SNO = ''
                 , DF_DSP_RQ_SNO = ''
                 , FNL_USR_ID = #{usrId}
                 , FNL_DEAL_DPT_CD = #{dptCd}
                 , FNL_MNU_ID = #{mnuId}
                 , FNL_MDF_DH = SYSDATE
            WHERE 
                    AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND DF_AUD_STEP_CD = #{audStepCd}
            AND DF_DOC_ID = #{docId} 
            AND DF_APVR_CD = #{apvrCd} 
            AND DF_AFF_SNO = #{affSno} 
            AND DF_DSP_RQ_SNO = #{dspRqSno}
    </update>
    
    <update id="updateReSbcnDfData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.updateReSbcnDfData */
        /* 보류처분요구에 재부의 처분요구 정보 입력 */
        UPDATE TBBADDED146M
           SET DF_AUD_STEP_CD = #{audStepCd}
                 , DF_DOC_ID = #{docId} 
                 , DF_APVR_CD = #{apvrCd} 
                 , DF_AFF_SNO = #{affSno} 
                 , DF_DSP_RQ_SNO = #{dspRqSno} 
                 , FNL_USR_ID = #{usrId}
                 , FNL_DEAL_DPT_CD = #{dptCd}
                 , FNL_MNU_ID = #{mnuId}
                 , FNL_MDF_DH = SYSDATE
       WHERE 
            AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = #{hdAudStepCd}
            AND DOC_ID = #{hdDocId}
            AND APVR_CD = #{hdApvrCd}
            AND AFF_SNO = #{hdAffSno}
            AND DSP_RQ_SNO = #{hdDspRqSno};
    </update>
    
  	<update id="updateReSbcnInfo" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.updateReSbcnInfo */
            UPDATE TBBADDED146M
                   SET HD_AUD_STEP_CD = #{hdAudStepCd}
                         , HD_DOC_ID = #{hdDocId} 
                         , HD_APVR_CD = #{hdApvrCd} 
                         , HD_AFF_SNO = #{hdAffSno} 
                         , HD_DSP_RQ_SNO = #{hdDspRqSno} 
                         , FNL_USR_ID = #{usrId}
                         , FNL_DEAL_DPT_CD = #{dptCd}
                         , FNL_MNU_ID = #{mnuId}
                         , FNL_MDF_DH = SYSDATE
               WHERE 
                    AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND AUD_STEP_CD = #{audStepCd}
                    AND DOC_ID = #{docId}
                    AND APVR_CD = #{apvrCd}
                    AND AFF_SNO = #{affSno}
                    AND DSP_RQ_SNO = #{dspRqSno}
    </update>
    
    
    
    <!-- <update id="updateResetD81" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.updateResetD81 */
			DECLARE
				BEGIN
					UPDATE TBBADDED146M
	       				SET DF_AUD_STEP_CD = ''
			             , DF_DOC_ID = '' 
			             , DF_APVR_CD = '' 
			             , DF_AFF_SNO = '' 
			             , DF_DSP_RQ_SNO = '' 
			             , FNL_USR_ID = #{frtUsrId}
			             , FNL_DEAL_DPT_CD = #{fnlDealDptCd}
			             , FNL_MNU_ID = #{fnlMnuId}
			             , FNL_MDF_DH = SYSDATE
					WHERE 
						AUD_YR = #{audYr}
	         			AND AUD_NO = #{audNo}
						AND DF_AUD_STEP_CD = #{audStepCd}
						AND DF_DOC_ID = #{docId}
						AND DF_APVR_CD = #{apvrCd}
						AND DF_AFF_SNO = #{affSno}
						AND DF_DSP_RQ_SNO = #{dspRqSno};
					;
					UPDATE TBBADDED146M
						SET HD_AUD_STEP_CD = ''
						, HD_DOC_ID = ''
						, HD_APVR_CD = ''
						, HD_AFF_SNO = ''
						, HD_DSP_RQ_SNO = ''
						, FNL_USR_ID = #{fnlUsrId}
						, FNL_DEAL_DPT_CD = #{fnlDealDptCd}
						, FNL_MNU_ID = #{fnlMnuId}
						, FNL_MDF_DH = SYSDATE
					WHERE 
						AUD_YR = #{audYr}
						AND AUD_NO = #{audNo}
						AND AUD_STEP_CD = #{audStepCd}
						AND DOC_ID = #{docId}
						AND APVR_CD = #{apvrCd}
						AND AFF_SNO = #{affSno}
						AND DSP_RQ_SNO = #{dspRqSno}
					;
			END;
					
    </update> -->
    
     
    <update id="updateResetD81DF" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.updateResetD81DF */
			UPDATE TBBADDED146M
	     		SET DF_AUD_STEP_CD = ''
	             , DF_DOC_ID = '' 
	             , DF_APVR_CD = '' 
	             , DF_AFF_SNO = '' 
	             , DF_DSP_RQ_SNO = '' 
	             , FNL_USR_ID = #{usrId}
	             , FNL_DEAL_DPT_CD = #{dptCd}
	             , FNL_MNU_ID = #{mnuId}
	             , FNL_MDF_DH = SYSDATE
			WHERE 
				AUD_YR = #{audYr}
	       		AND AUD_NO = #{audNo}
				AND DF_AUD_STEP_CD = #{audStepCd}
				AND DF_DOC_ID = #{docId}
				AND DF_APVR_CD = #{apvrCd}
				AND DF_AFF_SNO = #{affSno}
				AND DF_DSP_RQ_SNO = #{dspRqSno};
					
    </update>
    
    <update id="updateResetD81HD" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.updateResetD81HD */
			UPDATE TBBADDED146M
				SET HD_AUD_STEP_CD = ''
				, HD_DOC_ID = ''
				, HD_APVR_CD = ''
				, HD_AFF_SNO = ''
				, HD_DSP_RQ_SNO = ''
				, FNL_USR_ID = #{usrId}
				, FNL_DEAL_DPT_CD = #{dptCd}
				, FNL_MNU_ID = #{mnuId}
				, FNL_MDF_DH = SYSDATE
			WHERE 
				AUD_YR = #{audYr}
				AND AUD_NO = #{audNo}
				AND AUD_STEP_CD = #{audStepCd}
				AND DOC_ID = #{docId}
				AND APVR_CD = #{apvrCd}
				AND AFF_SNO = #{affSno}
				AND DSP_RQ_SNO = #{dspRqSno}
    </update>
    
    <select id="selectFnlRprtCreYn" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM008PMapper.selectFnlRprtCreYn */
		               
           SELECT (CASE WHEN T1.AUD_CNT = T1.EXEC_CNT THEN 'Y'
                                                      ELSE 'N'
                    END) AS FNL_RPRT_CRE_YN
             FROM ( SELECT A.AUD_YR
		                 , A.AUD_NO
		                 , A.DOC_ID
		                 , COUNT(*) AS AUD_CNT
		                 , (SELECT COUNT(*)
		                      FROM TBBADEAR001M B
		                     WHERE B.AUD_YR = A.AUD_YR
					           AND B.AUD_NO = A.AUD_NO
					           AND B.AUD_DSP_RQ_SNO IN (SELECT AA.DSP_RQ_SNO
					                                      FROM TBBADDED146M AA
					                                     WHERE AA.AUD_YR = A.AUD_YR
					                                       AND AA.AUD_NO = A.AUD_NO
				                                           AND AA.DOC_ID = A.DOC_ID)) AS EXEC_CNT
		              FROM TBBADDED146M A
		             WHERE A.AUD_YR = #{audYr}
		               AND A.AUD_NO = #{audNo} 
		               AND A.AUD_STEP_CD = 'A1070'
		               AND A.APVR_CD = 'A1070'
		               AND ((#{audStepCd} != 'A1050' AND A.DOC_ID = #{docId}) OR 
		                    (#{audStepCd} = 'A1050' AND A.DOC_ID =  (SELECT MAX(A.DOC_ID)
															            FROM TBBADDED147M A
															           WHERE A.AUD_YR = #{audYr}
															             AND A.AUD_NO = #{audNo}  
															             AND A.PRE_AFF_NO = #{affNo} ) ) )
		             GROUP BY
		                   A.AUD_YR
		                 , A.AUD_NO
		                 , A.DOC_ID ) T1
    </select>

</mapper> 