<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper">

    <!-- 부서 과 리스트 조회 -->
    <select id="selectDeptList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001P.selectDeptList */
        <![CDATA[
            SELECT A.CD,A.CD_NM,A.HIRK_DPT_CD
              FROM (SELECT DPT_CD AS CD,  F_CODE_NM('1000144', DPT_CD) AS CD_NM, HIRK_DPT_CD
                      FROM TBDCMACM002M
                     WHERE 1=1
                       AND DPT_CD NOT LIKE '%000'
                       AND DPT_CD NOT LIKE '0L0%'
                       AND DPT_CD <> '880880'
                       AND USE_YN = 'Y'
                   ) A
             WHERE CD_NM IS NOT NULL
        ]]>
        <if test = "bizTripDptCd != null and bizTripDptCd != ''">
               AND CD = #{bizTripDptCd}
        </if>
             ORDER BY CD
    </select>

    <!-- 상세정보 등록 -->
    <insert id="AEPPLN001EInsert" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.AEPPLN001EInsert */
        <![CDATA[
            INSERT INTO TBBADDED128M(AUD_PLAN_YR
                                    ,DPT_CD
                                    ,AUD_PLAN_SNO
                                    ,AUD_SBJ_NM
                                    ,AUD_KND_CD
                                    ,DATA_AUD_STR_DY
                                    ,DATA_AUD_END_DY
                                    ,DATA_AUD_DT
                                    ,PREY_AUD_STR_DY
                                    ,PREY_AUD_END_DY
                                    ,PREY_AUD_DT
                                    ,ACTU_AUD_STR_DY
                                    ,ACTU_AUD_END_DY
                                    ,ACTU_AUD_DT
                                    ,PRSS_AUD_STR_DY
                                    ,PRSS_AUD_END_DY
                                    ,AUD_POINT
                                    ,RLTN_ORG
                                    ,MPP_AUD_YN
                                    ,MPP_AUD_YR
                                    ,MPP_AUD_NO
                                    ,PLAN_PR_GUBN
                                    ,PLAN_NUD_GUBN
                                    ,PLAN_CHG_YN
                                    ,FRT_USR_ID
                                    ,FNL_USR_ID
                                    ,FNL_DEAL_DPT_CD
                                    ,FNL_MNU_ID
                                    ,FRT_REGI_DH
                                    ,FNL_MDF_DH
                                    ) VALUES (#{audPlanYr}
                                             ,#{dptCd}
                                             ,#{audPlanSno}
                                             ,#{audSbjNm}
                                             ,#{audKndCd}
                                             ,#{dataAudStrDy}
                                             ,#{dataAudEndDy}
                                             ,#{dataAudDt}
                                             ,#{preyAudStrDy}
                                             ,#{preyAudEndDy}
                                             ,#{preyAudDt}
                                             ,#{actuAudStrDy}
                                             ,#{actuAudEndDy}
                                             ,#{actuAudDt}
                                             ,#{prssAudStrDy}
                                             ,#{prssAudEndDy}
                                             ,#{audPoint}
                                             ,#{rltnOrg}
                                             ,#{mppAudYn}
                                             ,#{mppAudYr}
                                             ,#{mppAudNo}
                                             ,#{planPrGubn}
                                             ,#{planNudGubn}
                                             ,#{planChgYn}
                                             ,#{frtUsrId}
                                             ,#{fnlUsrId}
                                             ,#{fnlDealDptCd}
                                             ,#{fnlMnuId}
                                             ,SYSDATE
                                             ,SYSDATE
                                             )
        ]]>
    </insert>

    <!-- 상세정보 D 등록 -->
    <insert id="AEPPLN001EInsertD" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.AEPPLN001EInsertD */
        <![CDATA[
            INSERT INTO TBBADDED128D(AUD_PLAN_YR
                                    ,DPT_CD
                                    ,AUD_PLAN_SNO
                                    ,AUD_SBJ_NM
                                    ,AUD_KND_CD
                                    ,DATA_AUD_STR_DY
                                    ,DATA_AUD_END_DY
                                    ,DATA_AUD_DT
                                    ,PREY_AUD_STR_DY
                                    ,PREY_AUD_END_DY
                                    ,PREY_AUD_DT
                                    ,ACTU_AUD_STR_DY
                                    ,ACTU_AUD_END_DY
                                    ,ACTU_AUD_DT
                                    ,PRSS_AUD_STR_DY
                                    ,PRSS_AUD_END_DY
                                    ,AUD_POINT
                                    ,RLTN_ORG
                                    ,MPP_AUD_YN
                                    ,MPP_AUD_YR
                                    ,MPP_AUD_NO
                                    ,PLAN_PR_GUBN
                                    ,PLAN_NUD_GUBN
                                    ,PLAN_CHG_YN
                                    ,FRT_USR_ID
                                    ,FNL_USR_ID
                                    ,FNL_DEAL_DPT_CD
                                    ,FNL_MNU_ID
                                    ,FRT_REGI_DH
                                    ,FNL_MDF_DH
                                    ) VALUES (#{audPlanYr}
                                             ,#{dptCd}
                                             ,#{audPlanSno}
                                             ,#{audSbjNm}
                                             ,#{audKndCd}
                                             ,#{dataAudStrDy}
                                             ,#{dataAudEndDy}
                                             ,#{dataAudDt}
                                             ,#{preyAudStrDy}
                                             ,#{preyAudEndDy}
                                             ,#{preyAudDt}
                                             ,#{actuAudStrDy}
                                             ,#{actuAudEndDy}
                                             ,#{actuAudDt}
                                             ,#{prssAudStrDy}
                                             ,#{prssAudEndDy}
                                             ,#{audPoint}
                                             ,#{rltnOrg}
                                             ,#{mppAudYn}
                                             ,#{mppAudYr}
                                             ,#{mppAudNo}
                                             ,#{planPrGubn}
                                             ,#{planNudGubn}
                                             ,#{planChgYn}
                                             ,#{frtUsrId}
                                             ,#{fnlUsrId}
                                             ,#{fnlDealDptCd}
                                             ,#{fnlMnuId}
                                             ,SYSDATE
                                             ,SYSDATE
                                             )
        ]]>
    </insert>

    <!-- 출장정보 등록 -->
    <insert id="AEPPLN001PInsert" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.AEPPLN001PInsert */
        <![CDATA[
            INSERT INTO TBBADDED129M(AUD_PLAN_YR
                                    ,DPT_CD
                                    ,AUD_PLAN_SNO
                                    ,BIZ_TRIP_CD
                                    ,BIZ_TRIP_DPT_CD
                                    ,BIZ_TRIP_PER
                                    ,SORT_SNO
                                    ,FRT_USR_ID
                                    ,FNL_USR_ID
                                    ,FNL_DEAL_DPT_CD
                                    ,FNL_MNU_ID
                                    ,FRT_REGI_DH
                                    ,FNL_MDF_DH
                                    ) VALUES (#{audPlanYr}
                                             ,#{dptCd}
                                             ,#{audPlanSno}
                                             ,#{bizTripCd}
                                             ,#{bizTripDptCd}
                                             ,#{bizTripPer}
                                             ,#{sortSno}
                                             ,#{frtUsrId}
                                             ,#{fnlUsrId}
                                             ,#{fnlDealDptCd}
                                             ,#{fnlMnuId}
                                             ,SYSDATE
                                             ,SYSDATE
                                             )
        ]]>
    </insert>

    <!-- 출장정보 D 등록 -->
    <insert id="AEPPLN001PInsertD" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.AEPPLN001PInsertD */
        <![CDATA[
            INSERT INTO TBBADDED129D(AUD_PLAN_YR
                                    ,DPT_CD
                                    ,AUD_PLAN_SNO
                                    ,BIZ_TRIP_CD
                                    ,BIZ_TRIP_DPT_CD
                                    ,BIZ_TRIP_PER
                                    ,SORT_SNO
                                    ,FRT_USR_ID
                                    ,FNL_USR_ID
                                    ,FNL_DEAL_DPT_CD
                                    ,FNL_MNU_ID
                                    ,FRT_REGI_DH
                                    ,FNL_MDF_DH
                                    ) VALUES (#{audPlanYr}
                                             ,#{dptCd}
                                             ,#{audPlanSno}
                                             ,#{bizTripCd}
                                             ,#{bizTripDptCd}
                                             ,#{bizTripPer}
                                             ,#{sortSno}
                                             ,#{frtUsrId}
                                             ,#{fnlUsrId}
                                             ,#{fnlDealDptCd}
                                             ,#{fnlMnuId}
                                             ,SYSDATE
                                             ,SYSDATE
                                             )
        ]]>
    </insert>

    <!--감사계획관리 감사계획일련번호 조회-->
    <select id="selectMaxAudplanSno" parameterType="paramMap" resultType="String">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.selectMaxAudplanSno */
        <![CDATA[
            SELECT CASE WHEN D_SNO > M_SNO THEN D_SNO ELSE M_SNO END AS SNO
              FROM (SELECT NVL(MAX(A.AUD_PLAN_SNO),0) + 1 AS M_SNO
                          ,NVL(MAX(B.AUD_PLAN_SNO),0) + 1 AS D_SNO
                      FROM TBBADDED128M A
                      FULL OUTER JOIN TBBADDED128D B
                        ON A.AUD_PLAN_YR = B.AUD_PLAN_YR
                       AND A.DPT_CD      = B.DPT_CD
                     WHERE NVL(A.AUD_PLAN_YR ,B.AUD_PLAN_YR) = #{audPlanYr}
                       AND NVL(A.DPT_CD ,B.DPT_CD)           = #{dptCd}
                   )
        ]]>
    </select>

    <!-- 감사계획관리 delete -->
    <delete id="TBBADDED128MDelete" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED128MDelete */
        DELETE FROM TBBADDED128M
         WHERE AUD_PLAN_YR  = #{audPlanYr}
           AND DPT_CD       = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
    </delete>

    <!-- 출장정보 delete -->
    <delete id="TBBADDED129MDelete" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED129MDelete */
        DELETE FROM TBBADDED129M
         WHERE AUD_PLAN_YR  = #{audPlanYr}
           AND DPT_CD       = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
    </delete>

    <!-- 대상기관 delete -->
    <delete id="TBBADDED130MDelete" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED130MDelete */
        DELETE FROM TBBADDED130M
         WHERE AUD_PLAN_YR  = #{audPlanYr}
           AND DPT_CD       = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
    </delete>

    <!-- 문서함 delete -->
    <delete id="TBBADDED131MDelete" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED131MDelete */
        DELETE FROM TBBADDED131M
         WHERE AUD_PLAN_YR  = #{audPlanYr}
           AND DPT_CD       = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
    </delete>

    <!-- 감사계획관리 D delete -->
    <delete id="TBBADDED128DDelete" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED128DDelete */
        DELETE FROM TBBADDED128D
         WHERE AUD_PLAN_YR  = #{audPlanYr}
           AND DPT_CD       = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
    </delete>

    <!-- 출장정보 D delete -->
    <delete id="TBBADDED129DDelete" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED129DDelete */
        DELETE FROM TBBADDED129D
         WHERE AUD_PLAN_YR  = #{audPlanYr}
           AND DPT_CD       = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
    </delete>

    <!-- 대상기관 delete -->
    <delete id="TBBADDED130DDelete" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED130DDelete */
        DELETE FROM TBBADDED130D
         WHERE AUD_PLAN_YR  = #{audPlanYr}
           AND DPT_CD       = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
    </delete>

    <!--  -->
    <delete id="TBBADDED131DDelete" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED131DDelete */
        DELETE FROM TBBADDED131D
         WHERE AUD_PLAN_YR  = #{audPlanYr}
           AND DPT_CD       = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
    </delete>

    <!-- -->
    <select id="getAudDocData" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.geb.awd.dao.GEBAWD001EMapper.getAudDocData*/
        <if test=" 'Y'.toString() == onlyDocIdParam " >
            SELECT T.*
              FROM (
        </if>
                    SELECT F.*
                          ,F_USR_INFO_BY_ID( F.DOC_WRT_ID, '2' ) AS DOC_WRT_NM
                          ,F_CODE_NM('1000773', F.APV_STA_CD)    AS APV_STA_NM
                          ,F_CODE_NM('1000786', F.RPRT_CD)       AS ORG_RPRT_NM
                      FROM TBBADDED131M F
                     WHERE 1=1
        <if test =" onlyDocIdParam == null or onlyDocIdParam == '' " >
                       AND F.AUD_PLAN_YR    = #{audPlanYr}
                       AND F.AUD_PLAN_SNO   = #{audPlanSno}
                       AND F.DPT_CD         = #{dptCd}
                       AND F.DOC_ID         = #{docId}
        </if>
        <if test=" 'Y'.toString() == onlyDocIdParam " >
                       AND F.DOC_ID         = #{docId}
                     ORDER BY F.DPT_CD DESC
                   ) T
             WHERE ROWNUM=1
        </if>
    </select>

    <!-- 사항별 세부계획 조회 -->
    <select id="selectDetailList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.selectDetailList */
        <include refid="include.pageSelct" />
        <![CDATA[
         WITH MAX_ROW AS (SELECT Z.R_NUM
                                ,Z.AUD_PLAN_YR
                                ,Z.DPT_CD
                                ,Z.AUD_PLAN_SNO
                           FROM (
                                 SELECT
                                       RANK() OVER (PARTITION BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.BIZ_TRIP_CD
                                                         ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.BIZ_TRIP_CD,A.BIZ_TRIP_DPT_CD
                                                    ) AS R_NUM
                                       ,A.AUD_PLAN_YR
                                       ,A.DPT_CD
                                       ,A.AUD_PLAN_SNO
                                       ,A.BIZ_TRIP_CD
                                       ,A.BIZ_TRIP_DPT_CD
                                       ,A.BIZ_TRIP_PER
                                   FROM (/**************************************************************/
                                         SELECT Z.* FROM TBBADDED129M Z
                                          WHERE NOT EXISTS (SELECT 'X'
                                                              FROM TBBADDED129D X
                                                             WHERE X.AUD_PLAN_YR     = Z.AUD_PLAN_YR
                                                               AND X.DPT_CD          = Z.DPT_CD
                                                               AND X.AUD_PLAN_SNO    = Z.AUD_PLAN_SNO
                                                               AND X.BIZ_TRIP_CD     = Z.BIZ_TRIP_CD)
                                          UNION ALL
                                         SELECT Y.* FROM TBBADDED129D Y
                                         /**************************************************************/
                                        ) A
                                  WHERE A.AUD_PLAN_YR = #{audPlanYr}
        ]]>
        <if test='dptCd != null and dptCd != ""'>
                                    AND A.DPT_CD = #{dptCd}
        </if>
        <![CDATA[
                                  ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.BIZ_TRIP_CD,A.BIZ_TRIP_DPT_CD
                                ) Z
                          GROUP BY Z.R_NUM,Z.AUD_PLAN_YR,Z.DPT_CD,Z.AUD_PLAN_SNO
                          ORDER BY Z.AUD_PLAN_YR,Z.DPT_CD,Z.AUD_PLAN_SNO,Z.R_NUM
                        )
            ,DATA_AUD AS (SELECT RANK() OVER (PARTITION BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO
                                                  ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.BIZ_TRIP_CD,A.BIZ_TRIP_DPT_CD ) AS R_NUM
                                ,A.AUD_PLAN_YR
                                ,A.DPT_CD
                                ,A.AUD_PLAN_SNO
                                ,A.BIZ_TRIP_CD
                                ,A.BIZ_TRIP_DPT_CD
                                ,A.BIZ_TRIP_PER
                            FROM (/**************************************************************/
                                  SELECT Z.* FROM TBBADDED129M Z
                                   WHERE NOT EXISTS (SELECT 'X'
                                                       FROM TBBADDED129D X
                                                      WHERE X.AUD_PLAN_YR     = Z.AUD_PLAN_YR
                                                        AND X.DPT_CD          = Z.DPT_CD
                                                        AND X.AUD_PLAN_SNO    = Z.AUD_PLAN_SNO
                                                        AND X.BIZ_TRIP_CD     = Z.BIZ_TRIP_CD)
                                   UNION ALL
                                  SELECT Y.* FROM TBBADDED129D Y
                                  /**************************************************************/
                                 ) A
                           WHERE A.AUD_PLAN_YR = #{audPlanYr}
        ]]>
        <if test='dptCd != null and dptCd != ""'>
                             AND A.DPT_CD      = #{dptCd}
        </if>
        <![CDATA[
                             AND A.BIZ_TRIP_CD = '00'
                           ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.BIZ_TRIP_CD,A.BIZ_TRIP_DPT_CD
                         )
            ,PREY_AUD AS (SELECT RANK() OVER (PARTITION BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO
                                                  ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.BIZ_TRIP_CD,A.BIZ_TRIP_DPT_CD ) AS R_NUM
                                ,A.AUD_PLAN_YR
                                ,A.DPT_CD
                                ,A.AUD_PLAN_SNO
                                ,A.BIZ_TRIP_CD
                                ,A.BIZ_TRIP_DPT_CD
                                ,A.BIZ_TRIP_PER
                            FROM (/**************************************************************/
                                  SELECT Z.* FROM TBBADDED129M Z
                                   WHERE NOT EXISTS (SELECT 'X'
                                                       FROM TBBADDED129D X
                                                      WHERE X.AUD_PLAN_YR     = Z.AUD_PLAN_YR
                                                        AND X.DPT_CD          = Z.DPT_CD
                                                        AND X.AUD_PLAN_SNO    = Z.AUD_PLAN_SNO
                                                        AND X.BIZ_TRIP_CD     = Z.BIZ_TRIP_CD)
                                   UNION ALL
                                  SELECT Y.* FROM TBBADDED129D Y
                                  /**************************************************************/
                                 ) A
                           WHERE A.AUD_PLAN_YR = #{audPlanYr}
        ]]>
        <if test='dptCd != null and dptCd != ""'>
                             AND A.DPT_CD      = #{dptCd}
        </if>
        <![CDATA[
                             AND A.BIZ_TRIP_CD = '01'
                           ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.BIZ_TRIP_CD,A.BIZ_TRIP_DPT_CD
                         )
            ,ACTU_AUD AS (SELECT RANK() OVER (PARTITION BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO
                                                  ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.BIZ_TRIP_CD,A.BIZ_TRIP_DPT_CD ) AS R_NUM
                                ,A.AUD_PLAN_YR
                                ,A.DPT_CD
                                ,A.AUD_PLAN_SNO
                                ,A.BIZ_TRIP_CD
                                ,A.BIZ_TRIP_DPT_CD
                                ,A.BIZ_TRIP_PER
                            FROM (/**************************************************************/
                                  SELECT Z.* FROM TBBADDED129M Z
                                   WHERE NOT EXISTS (SELECT 'X'
                                                       FROM TBBADDED129D X
                                                      WHERE X.AUD_PLAN_YR     = Z.AUD_PLAN_YR
                                                        AND X.DPT_CD          = Z.DPT_CD
                                                        AND X.AUD_PLAN_SNO    = Z.AUD_PLAN_SNO
                                                        AND X.BIZ_TRIP_CD     = Z.BIZ_TRIP_CD)
                                   UNION ALL
                                  SELECT Y.* FROM TBBADDED129D Y
                                  /**************************************************************/
                                 ) A
                           WHERE A.AUD_PLAN_YR = #{audPlanYr}
        ]]>
        <if test='dptCd != null and dptCd != ""'>
                             AND A.DPT_CD      = #{dptCd}
        </if>
        <![CDATA[
                             AND A.BIZ_TRIP_CD = '02'
                           ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.BIZ_TRIP_CD,A.BIZ_TRIP_DPT_CD
                         )
        SELECT A.AUD_PLAN_YR
              ,A.DPT_CD
              ,F_DPT_INFO(A.DPT_CD, '4') AS DPT_NM
              ,A.AUD_PLAN_SNO
              ,DECODE(E.PLAN_NUD_GUBN,NULL,NULL,E.PLAN_NUD_GUBN||' ')||E.AUD_SBJ_NM AS AUD_SBJ_NM
              ,F_CODE_NM('1000739', E.AUD_KND_CD) AS AUD_KND_NM
              ,DECODE (E.DATA_AUD_STR_DY, null, '-',TO_CHAR(TO_DATE(E.DATA_AUD_STR_DY, 'YYYYMMDD'), 'YY-MM-DD')||' ~ '||TO_CHAR(TO_DATE(E.DATA_AUD_END_DY, 'YYYYMMDD'), 'YY-MM-DD')) AS DATA_AUD
              ,DECODE (E.PREY_AUD_STR_DY, null, '-',TO_CHAR(TO_DATE(E.PREY_AUD_STR_DY, 'YYYYMMDD'), 'YY-MM-DD')||' ~ '||TO_CHAR(TO_DATE(E.PREY_AUD_END_DY, 'YYYYMMDD'), 'YY-MM-DD')) AS PREY_AUD
              ,DECODE (E.ACTU_AUD_STR_DY, null, '-',TO_CHAR(TO_DATE(E.ACTU_AUD_STR_DY, 'YYYYMMDD'), 'YY-MM-DD')||' ~ '||TO_CHAR(TO_DATE(E.ACTU_AUD_END_DY, 'YYYYMMDD'), 'YY-MM-DD')) AS ACTU_AUD
              ,DECODE (E.PRSS_AUD_STR_DY, null, '-',TO_CHAR(TO_DATE(E.PRSS_AUD_STR_DY, 'YYYYMMDD'), 'YY-MM-DD')||' ~ '||TO_CHAR(TO_DATE(E.PRSS_AUD_END_DY, 'YYYYMMDD'), 'YY-MM-DD')) AS PRSS_AUD
              ,F_USR_INFO_BY_ID(E.FRT_USR_ID,'2')||' '||'('||TO_CHAR(E.FNL_MDF_DH,'YY"-"MM"-"DD')||')' AS WRIT_NM
              ,DECODE(B.BIZ_TRIP_DPT_CD,NULL,NULL,F_DPT_INFO(B.BIZ_TRIP_DPT_CD, '4')||'('||B.BIZ_TRIP_PER||')') AS DATA_AUD_INFO
              ,DECODE(C.BIZ_TRIP_DPT_CD,NULL,NULL,F_DPT_INFO(C.BIZ_TRIP_DPT_CD, '4')||'('||C.BIZ_TRIP_PER||')') AS PREY_AUD_INFO
              ,DECODE(D.BIZ_TRIP_DPT_CD,NULL,NULL,F_DPT_INFO(D.BIZ_TRIP_DPT_CD, '4')||'('||D.BIZ_TRIP_PER||')') AS ACTU_AUD_INFO
              ,E.PLAN_NUD_GUBN
          FROM MAX_ROW  A
              ,DATA_AUD B
              ,PREY_AUD C
              ,ACTU_AUD D
              ,(/***********************************************************/
                SELECT Z.* FROM TBBADDED128M Z
                 WHERE NOT EXISTS (SELECT 'X'
                                     FROM TBBADDED128D X
                                    WHERE X.AUD_PLAN_YR  = Z.AUD_PLAN_YR
                                      AND X.DPT_CD       = Z.DPT_CD
                                      AND X.AUD_PLAN_SNO = Z.AUD_PLAN_SNO)
                 UNION ALL
                SELECT Y.* FROM TBBADDED128D Y
                /***********************************************************/
               ) E
         WHERE 1=1
           AND A.R_NUM = B.R_NUM(+) AND A.AUD_PLAN_YR = B.AUD_PLAN_YR(+) AND A.DPT_CD = B.DPT_CD(+) AND A.AUD_PLAN_SNO = B.AUD_PLAN_SNO(+)
           AND A.R_NUM = C.R_NUM(+) AND A.AUD_PLAN_YR = C.AUD_PLAN_YR(+) AND A.DPT_CD = C.DPT_CD(+) AND A.AUD_PLAN_SNO = C.AUD_PLAN_SNO(+)
           AND A.R_NUM = D.R_NUM(+) AND A.AUD_PLAN_YR = D.AUD_PLAN_YR(+) AND A.DPT_CD = D.DPT_CD(+) AND A.AUD_PLAN_SNO = D.AUD_PLAN_SNO(+)
                                    AND A.AUD_PLAN_YR = E.AUD_PLAN_YR(+) AND A.DPT_CD = E.DPT_CD(+) AND A.AUD_PLAN_SNO = E.AUD_PLAN_SNO(+)
          ]]>
         <if test='dptCd == null and schSpvBrdvCd != ""'>
           AND A.DPT_CD IN ( SELECT A.DPT_CD FROM TBDCMACM002M
                              WHERE SUBSTR( A.DPT_CD, 0, 3) = SUBSTR(#{schSpvBrdvCd}, 0, 3)
                                AND A.DPT_CD NOT LIKE '%000'
                                AND USE_YN = 'Y'
                           )
        </if>
         ORDER BY A.DPT_CD,A.AUD_PLAN_SNO,A.R_NUM
        <include refid="include.pageOrder" />
    </select>

    <!-- 상세정보 조회 -->
    <select id="AEPPLN001EselecDetailInfo" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecDetailInfo */
        <![CDATA[
            SELECT AUD_PLAN_YR
                  ,DPT_CD
                  ,(SELECT ST.DPT_NM FROM TBDCMACM002M ST WHERE ST.DPT_CD=A.DPT_CD ) AS SL_DPT_NM
                  ,DPT_CD AS AUD_DPT_CD 
                  ,AUD_PLAN_SNO
                  ,AUD_SBJ_NM
                  ,AUD_KND_CD
                  ,DECODE(DATA_AUD_STR_DY, NULL, '',TO_CHAR(TO_DATE(DATA_AUD_STR_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS DATA_AUD_STR_DY
                  ,DECODE(DATA_AUD_END_DY, NULL, '',TO_CHAR(TO_DATE(DATA_AUD_END_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS DATA_AUD_END_DY
                  ,DATA_AUD_DT
                  ,DECODE(PREY_AUD_STR_DY, NULL, '',TO_CHAR(TO_DATE(PREY_AUD_STR_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS PREY_AUD_STR_DY
                  ,DECODE(PREY_AUD_END_DY, NULL, '',TO_CHAR(TO_DATE(PREY_AUD_END_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS PREY_AUD_END_DY
                  ,PREY_AUD_DT
                  ,DECODE(ACTU_AUD_STR_DY, NULL, '',TO_CHAR(TO_DATE(ACTU_AUD_STR_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS ACTU_AUD_STR_DY
                  ,DECODE(ACTU_AUD_END_DY, NULL, '',TO_CHAR(TO_DATE(ACTU_AUD_END_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS ACTU_AUD_END_DY
                  ,ACTU_AUD_DT
                  ,DECODE(PRSS_AUD_STR_DY, NULL, '',TO_CHAR(TO_DATE(PRSS_AUD_STR_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS PRSS_AUD_STR_DY
                  ,DECODE(PRSS_AUD_END_DY, NULL, '',TO_CHAR(TO_DATE(PRSS_AUD_END_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS PRSS_AUD_END_DY
                  ,AUD_POINT
                  ,RLTN_ORG
                  ,MPP_AUD_YN
                  ,MPP_AUD_YR
                  ,MPP_AUD_NO
                  ,PLAN_PR_GUBN
                  ,PLAN_NUD_GUBN
                  ,PLAN_CHG_YN
                  ,FRT_USR_ID
                  /* 자료수집 */
                  ,(SELECT AGGR_CONCAT(F_DPT_INFO(B.BIZ_TRIP_DPT_CD, '4')||'('||B.BIZ_TRIP_PER||')', ',') AS DATA_INFO
                      FROM TBBADDED129M B
                     WHERE B.AUD_PLAN_YR    = A.AUD_PLAN_YR
                       AND B.DPT_CD         = A.DPT_CD
                       AND B.AUD_PLAN_SNO   = A.AUD_PLAN_SNO
                       AND BIZ_TRIP_CD      = '00'
                   ) AS DATA_INFO
                  /* 예비조사 */
                  ,(SELECT AGGR_CONCAT(F_DPT_INFO(B.BIZ_TRIP_DPT_CD, '4')||'('||B.BIZ_TRIP_PER||')', ',') AS PREY_INFO
                      FROM TBBADDED129M B
                     WHERE B.AUD_PLAN_YR    = A.AUD_PLAN_YR
                       AND B.DPT_CD         = A.DPT_CD
                       AND B.AUD_PLAN_SNO   = A.AUD_PLAN_SNO
                       AND BIZ_TRIP_CD      = '01'
                   ) AS PREY_INFO
                  /* 실지감사 */
                  ,(SELECT AGGR_CONCAT(F_DPT_INFO(B.BIZ_TRIP_DPT_CD, '4')||'('||B.BIZ_TRIP_PER||')', ',') AS ACTU_INFO
                      FROM TBBADDED129M B
                     WHERE B.AUD_PLAN_YR    = A.AUD_PLAN_YR
                       AND B.DPT_CD         = A.DPT_CD
                       AND B.AUD_PLAN_SNO   = A.AUD_PLAN_SNO
                       AND BIZ_TRIP_CD      = '02'
                   ) AS ACTU_INFO
                  /* 대상기관 */
                  ,(SELECT AGGR_CONCAT(ORG_NM, ',') AS RLTN_ORG_INFO
                      FROM TBBADDED130M B
                     WHERE B.AUD_PLAN_YR    = A.AUD_PLAN_YR
                       AND B.DPT_CD         = A.DPT_CD
                       AND B.AUD_PLAN_SNO   = A.AUD_PLAN_SNO
                   ) AS RLTN_ORG_INFO
                   ,MPP_AUD_YN
             FROM TBBADDED128M A
            WHERE 1=1
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
              AND AUD_PLAN_YR   = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
              AND DPT_CD        = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
              AND AUD_PLAN_SNO  = #{audPlanSno}
        </if>
    </select>

    <select id="AEPPLN001EselecDetailInfo2" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecDetailInfo2 */
        <![CDATA[
            SELECT   AUD_PLAN_YR
                    ,(SELECT ST.DPT_NM FROM TBDCMACM002M ST WHERE ST.DPT_CD=A.DPT_CD ) AS SL_DPT_NM
                    ,DPT_CD
                    ,AUD_PLAN_SNO
                    ,AUD_SBJ_NM
                    ,AUD_KND_CD
                    ,DECODE (DATA_AUD_STR_DY, null, '',TO_CHAR(TO_DATE(DATA_AUD_STR_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS DATA_AUD_STR_DY
                    ,DECODE (DATA_AUD_END_DY, null, '',TO_CHAR(TO_DATE(DATA_AUD_END_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS DATA_AUD_END_DY
                    ,DATA_AUD_DT
                    ,DECODE (PREY_AUD_STR_DY, null, '',TO_CHAR(TO_DATE(PREY_AUD_STR_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS PREY_AUD_STR_DY
                    ,DECODE (PREY_AUD_END_DY, null, '',TO_CHAR(TO_DATE(PREY_AUD_END_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS PREY_AUD_END_DY
                    ,PREY_AUD_DT
                    ,DECODE (ACTU_AUD_STR_DY, null, '',TO_CHAR(TO_DATE(ACTU_AUD_STR_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS ACTU_AUD_STR_DY
                    ,DECODE (ACTU_AUD_END_DY, null, '',TO_CHAR(TO_DATE(ACTU_AUD_END_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS ACTU_AUD_END_DY
                    ,ACTU_AUD_DT
                    ,DECODE (PRSS_AUD_STR_DY, null, '',TO_CHAR(TO_DATE(PRSS_AUD_STR_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS PRSS_AUD_STR_DY
                    ,DECODE (PRSS_AUD_END_DY, null, '',TO_CHAR(TO_DATE(PRSS_AUD_END_DY, 'YYYYMMDD'), 'YYYY-MM-DD')) AS PRSS_AUD_END_DY
                    ,AUD_POINT
                    ,RLTN_ORG
                    ,MPP_AUD_YN
                    ,MPP_AUD_YR
                    ,MPP_AUD_NO
                    ,PLAN_PR_GUBN
                    ,PLAN_NUD_GUBN
                    ,PLAN_CHG_YN
                    ,FRT_USR_ID
                                                 /* 자료수집 */
                    ,(
                       SELECT AGGR_CONCAT(F_DPT_INFO(B.BIZ_TRIP_DPT_CD, '4')||'('||B.BIZ_TRIP_PER||')', ',') AS DATA_INFO
                         FROM TBBADDED129D B
                        WHERE B.AUD_PLAN_YR = A.AUD_PLAN_YR
                          AND B.DPT_CD = A.DPT_CD
                          AND B.AUD_PLAN_SNO = A.AUD_PLAN_SNO
                          AND BIZ_TRIP_CD = '00'

                   ) AS DATA_INFO
                         /* 예비조사 */
                    ,(
                       SELECT AGGR_CONCAT(F_DPT_INFO(B.BIZ_TRIP_DPT_CD, '4')||'('||B.BIZ_TRIP_PER||')', ',') AS PREY_INFO
                         FROM TBBADDED129D B
                        WHERE B.AUD_PLAN_YR = A.AUD_PLAN_YR
                          AND B.DPT_CD = A.DPT_CD
                          AND B.AUD_PLAN_SNO = A.AUD_PLAN_SNO
                          AND BIZ_TRIP_CD = '01'

                   ) AS PREY_INFO
                            /* 실지감사 */
                    ,(
                       SELECT AGGR_CONCAT(F_DPT_INFO(B.BIZ_TRIP_DPT_CD, '4')||'('||B.BIZ_TRIP_PER||')', ',') AS ACTU_INFO
                         FROM TBBADDED129D B
                        WHERE B.AUD_PLAN_YR = A.AUD_PLAN_YR
                          AND B.DPT_CD = A.DPT_CD
                          AND B.AUD_PLAN_SNO = A.AUD_PLAN_SNO
                          AND BIZ_TRIP_CD = '02'

                   ) AS ACTU_INFO
                           /* 대상기관 */
                    ,(
                       SELECT AGGR_CONCAT(ORG_NM, ',') AS RLTN_ORG_INFO
                         FROM TBBADDED130D B
                        WHERE B.AUD_PLAN_YR = A.AUD_PLAN_YR
                          AND B.DPT_CD = A.DPT_CD
                          AND B.AUD_PLAN_SNO = A.AUD_PLAN_SNO
                   ) AS RLTN_ORG_INFO
             FROM TBBADDED128D A
            WHERE 1=1
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>

    </select>
        <update id="TBBADDED128MUpdate" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.TBBADDED128MUpdate */
        <![CDATA[
        UPDATE TBBADDED128M
           SET   AUD_SBJ_NM = #{audSbjNm}
                ,AUD_KND_CD = #{audKndCd}
                ,DATA_AUD_STR_DY = #{dataAudStrDy}
                ,DATA_AUD_END_DY = #{dataAudEndDy}
                ,DATA_AUD_DT = #{dataAudDt}
                ,PREY_AUD_STR_DY = #{preyAudStrDy}
                ,PREY_AUD_END_DY = #{preyAudEndDy}
                ,PREY_AUD_DT = #{preyAudDt}
                ,ACTU_AUD_STR_DY = #{actuAudStrDy}
                ,ACTU_AUD_END_DY = #{actuAudEndDy}
                ,ACTU_AUD_DT = #{actuAudDt}
                ,PRSS_AUD_STR_DY = #{prssAudStrDy}
                ,PRSS_AUD_END_DY = #{prssAudEndDy}
                ,AUD_POINT = #{audPoint}
                ,RLTN_ORG = #{rltnOrg}
            ]]>
                <if test="mppAudYn != null and mppAudYn !='' ">
                ,MPP_AUD_YN = #{mppAudYn}
                </if>
                <if test="mppAudYr != null and mppAudYr !='' ">
                ,MPP_AUD_YR = #{mppAudYr}
                </if>
                 <if test="mapAudNo != null and mapAudNo !='' ">
                ,MPP_AUD_NO = #{mapAudNo}
                </if>
                <if test="planPrGubn != null and planPrGubn !='' ">
                ,PLAN_PR_GUBN = #{planPrGubn}
                </if>
                 <if test="planNudGubn != null and planNudGubn !='' ">
                ,PLAN_NUD_GUBN = #{planNudGubn}
                </if>
                 <if test="planChgYn != null and planChgYn !='' ">
                ,PLAN_CHG_YN = #{planChgYn}
                </if>
        <![CDATA[
                ,FNL_USR_ID = #{usrId}
                ,FNL_DEAL_DPT_CD = #{dptCd}
                ,FNL_MNU_ID = #{fnlMnuId}
                ,FNL_MDF_DH = SYSDATE
        WHERE  1=1
        ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
    </update>
    <!--감사계획관리 출장정보 조회-->
    <select id="selectBizTripList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.selectBizTripList */
        <![CDATA[
         SELECT BIZ_TRIP_DPT_CD,BIZ_TRIP_PER,SORT_SNO
           FROM TBBADDED129M
          WHERE 1 = 1
          ]]>
          <if test='cnt == 1'>
            AND BIZ_TRIP_CD = '00'
        </if>
         <if test='cnt == 2'>
            AND BIZ_TRIP_CD = '01'
        </if>
         <if test='cnt == 3'>
            AND BIZ_TRIP_CD = '02'
        </if>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
    </select>
    <!--감사계획관리 출장정보 조회 D-->
    <select id="selectBizTripListD" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.selectBizTripListD */
        <![CDATA[
        SELECT BIZ_TRIP_DPT_CD,BIZ_TRIP_PER,SORT_SNO
           FROM TBBADDED129D
          WHERE 1 = 1
          ]]>
        <if test='cnt == 1'>
            AND BIZ_TRIP_CD = '00'
        </if>
         <if test='cnt == 2'>
            AND BIZ_TRIP_CD = '01'
        </if>
         <if test='cnt == 3'>
            AND BIZ_TRIP_CD = '02'
        </if>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
    </select>
            <!-- 종류별 세부계획 조회 -->
    <select id="selectKndList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.selectKndList */
       <include refid="include.pageSelct" />
        <![CDATA[
        SELECT RLTN_ORG
              ,AUD_KND_CD
              ,AUD_PLAN_SNO
              ,DPT_CD
              ,AUD_PLAN_YR
              ,DECODE(PLAN_NUD_GUBN,NULL,NULL,PLAN_NUD_GUBN||' ')||AUD_SBJ_NM AS AUD_SBJ_NM
              ,AUD_POINT
              ,ACTU_AUD_DT
              ,AUD_MONTH
              ,DPT_NM
              ,DECODE(AUD_KND_CD, 1, ORG_NM,4, ORG_NM, RLTN_ORG) AS ORG_NM
              ,ACTU_TRIP_PER
              ,PLAN_NUD_GUBN
          FROM (SELECT A.RLTN_ORG
                      ,A.AUD_KND_CD
                      ,A.AUD_PLAN_SNO
                      ,A.DPT_CD
                      ,A.AUD_PLAN_YR
                      ,A.AUD_SBJ_NM
                      ,A.AUD_POINT
                      ,DECODE(A.ACTU_AUD_DT    , NULL,'',A.ACTU_AUD_DT||'일')                 AS ACTU_AUD_DT
                      ,DECODE(A.ACTU_AUD_STR_DY, NULL,'',SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월') AS AUD_MONTH
                      ,F_DPT_INFO(A.DPT_CD, '4')                                              AS DPT_NM
                      ,(SELECT AGGR_CONCAT(B.ORG_NM,',')
                          FROM (/***********************************************************/
                                SELECT Z.* FROM TBBADDED130M Z
                                 WHERE NOT EXISTS (SELECT 'X'
                                                     FROM TBBADDED130D X
                                                    WHERE X.AUD_PLAN_YR     = Z.AUD_PLAN_YR
                                                      AND X.DPT_CD          = Z.DPT_CD
                                                      AND X.AUD_PLAN_SNO    = Z.AUD_PLAN_SNO
                                                      AND X.ORG_CD          = Z.ORG_CD)
                                 UNION ALL
                                SELECT Y.* FROM TBBADDED130D Y
                                /***********************************************************/
                               ) B
                         WHERE B.AUD_PLAN_YR  = A.AUD_PLAN_YR
                           AND B.DPT_CD       = A.DPT_CD
                           AND B.AUD_PLAN_SNO = A.AUD_PLAN_SNO
                         GROUP BY B.AUD_PLAN_SNO, B.DPT_CD, B.AUD_PLAN_YR
                       ) AS ORG_NM
                      ,(SELECT SUM(BIZ_TRIP_PER)||'명'
                          FROM (/***********************************************************/
                                SELECT Z.* FROM TBBADDED129M Z
                                 WHERE NOT EXISTS (SELECT 'X'
                                                     FROM TBBADDED129D X
                                                    WHERE X.AUD_PLAN_YR     = Z.AUD_PLAN_YR
                                                      AND X.DPT_CD          = Z.DPT_CD
                                                      AND X.AUD_PLAN_SNO    = Z.AUD_PLAN_SNO
                                                      AND X.BIZ_TRIP_CD     = Z.BIZ_TRIP_CD)
                                 UNION ALL
                                SELECT Y.* FROM TBBADDED129D Y
                                /***********************************************************/
                               ) B
                         WHERE BIZ_TRIP_CD    = '02'
                           AND B.AUD_PLAN_YR  = A.AUD_PLAN_YR
                           AND B.DPT_CD       = A.DPT_CD
                           AND B.AUD_PLAN_SNO = A.AUD_PLAN_SNO
                         GROUP BY B.AUD_PLAN_YR,B.DPT_CD,B.AUD_PLAN_SNO
                       ) AS ACTU_TRIP_PER
                      ,A.PLAN_NUD_GUBN
                  FROM (/***********************************************************/
                        SELECT Z.* FROM TBBADDED128M Z
                         WHERE NOT EXISTS (SELECT 'X'
                                             FROM TBBADDED128D X
                                            WHERE X.AUD_PLAN_YR  = Z.AUD_PLAN_YR
                                              AND X.DPT_CD       = Z.DPT_CD
                                              AND X.AUD_PLAN_SNO = Z.AUD_PLAN_SNO)
                         UNION ALL
                        SELECT Y.* FROM TBBADDED128D Y
                        /***********************************************************/
                       ) A
               )
         WHERE 1 = 1
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
         <if test='audKndCd != null and audKndCd != ""'>
            AND AUD_KND_CD = #{audKndCd}
        </if>
         <if test='dptCd == null and schSpvBrdvCd != ""'>
            AND  DPT_CD IN ( SELECT DPT_CD FROM TBDCMACM002M
                                           WHERE SUBSTR( DPT_CD, 0, 3) = SUBSTR(#{schSpvBrdvCd}, 0, 3)
                                             AND DPT_CD NOT LIKE '%000'
                                             AND USE_YN = 'Y'
                              )
         </if>
        ORDER BY DPT_CD
        <include refid="include.pageOrder" />
    </select>

                <!-- 대상기관 등록 -->
<insert id="TBBADDED130MInsert" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED130MInsert */
        <![CDATA[
            INSERT INTO    TBBADDED130M
                        (    AUD_PLAN_YR
                            ,DPT_CD
                            ,AUD_PLAN_SNO
                            ,ORG_CD
                            ,ORG_NM
                            ,SORT_SNO
                            ,FRT_USR_ID
                            ,FNL_USR_ID
                            ,FNL_DEAL_DPT_CD
                            ,FNL_MNU_ID
                            ,FRT_REGI_DH
                            ,FNL_MDF_DH

                        )
                VALUES    (  #{audPlanYr}
                            ,#{dptCd}
                            ,#{audPlanSno}
                            ,#{orgCd}
                            ,#{orgNm}
                            ,#{sortSno}
                            ,#{frtUsrId}
                            ,#{fnlUsrId}
                            ,#{fnlDealDptCd}
                            ,#{fnlMnuId}
                            ,SYSDATE
                            ,SYSDATE
                        )
        ]]>
    </insert>
                <!-- 대상기관 D 등록 -->
<insert id="TBBADDED130DInsert" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.TBBADDED130DInsert */
        <![CDATA[
            INSERT INTO    TBBADDED130D
                        (    AUD_PLAN_YR
                            ,DPT_CD
                            ,AUD_PLAN_SNO
                            ,ORG_CD
                            ,ORG_NM
                            ,SORT_SNO
                            ,FRT_USR_ID
                            ,FNL_USR_ID
                            ,FNL_DEAL_DPT_CD
                            ,FNL_MNU_ID
                            ,FRT_REGI_DH
                            ,FNL_MDF_DH

                        )
                VALUES    (  #{audPlanYr}
                            ,#{dptCd}
                            ,#{audPlanSno}
                            ,#{orgCd}
                            ,#{orgNm}
                            ,#{sortSno}
                            ,#{frtUsrId}
                            ,#{fnlUsrId}
                            ,#{fnlDealDptCd}
                            ,#{fnlMnuId}
                            ,SYSDATE
                            ,SYSDATE
                        )
        ]]>
    </insert>
    <!-- 자료수집 조회 -->
    <select id="AEPPLN001EselecDataAud" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecDataAud */
        <![CDATA[
         SELECT BIZ_TRIP_DPT_CD, BIZ_TRIP_PER, SORT_SNO
           FROM TBBADDED129M
          WHERE BIZ_TRIP_CD = '00'
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
          ORDER BY SORT_SNO
    </select>
        <!-- 예비조사 조회 -->
    <select id="AEPPLN001EselecPreyAud" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecPreyAud */
        <![CDATA[
         SELECT BIZ_TRIP_DPT_CD, BIZ_TRIP_PER, SORT_SNO
           FROM TBBADDED129M
          WHERE BIZ_TRIP_CD = '01'
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
          ORDER BY SORT_SNO
    </select>
        <!-- 실지감사 조회 -->
    <select id="AEPPLN001EselecActuAud" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecActuAud */
        <![CDATA[
         SELECT BIZ_TRIP_DPT_CD, BIZ_TRIP_PER, SORT_SNO
           FROM TBBADDED129M
          WHERE BIZ_TRIP_CD = '02'
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
          ORDER BY SORT_SNO
    </select>
            <!-- 대상기관 조회 -->
    <select id="AEPPLN001EselecrltnOrg" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecrltnOrg */
        <![CDATA[
         SELECT ORG_CD,ORG_NM,SORT_SNO
           FROM TBBADDED130M
          WHERE 1 = 1
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
          ORDER BY SORT_SNO
    </select>


        <!-- D 자료수집 조회 -->
    <select id="AEPPLN001EselecDataAudD" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecDataAudD */
        <![CDATA[
         SELECT BIZ_TRIP_DPT_CD, BIZ_TRIP_PER, SORT_SNO
           FROM TBBADDED129D
          WHERE BIZ_TRIP_CD = '00'
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
          ORDER BY SORT_SNO
    </select>
        <!--D 예비조사 조회 -->
    <select id="AEPPLN001EselecPreyAudD" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecPreyAudD */
        <![CDATA[
         SELECT BIZ_TRIP_DPT_CD, BIZ_TRIP_PER, SORT_SNO
           FROM TBBADDED129D
          WHERE BIZ_TRIP_CD = '01'
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
          ORDER BY SORT_SNO
    </select>
        <!-- 실지감사 조회 -->
    <select id="AEPPLN001EselecActuAudD" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecActuAudD */
        <![CDATA[
         SELECT BIZ_TRIP_DPT_CD, BIZ_TRIP_PER, SORT_SNO
           FROM TBBADDED129D
          WHERE BIZ_TRIP_CD = '02'
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
          ORDER BY SORT_SNO
    </select>
            <!-- 대상기관 조회 -->
    <select id="AEPPLN001EselecrltnOrgD" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselecrltnOrgD */
        <![CDATA[
        SELECT ORG_CD,ORG_NM,SORT_SNO
          FROM TBBADDED130D
          WHERE 1 = 1
         ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
          ORDER BY SORT_SNO
    </select>


    <!-- 보고서 삭제-->
    <update id="deleteDoc" parameterType="paramMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.deleteDoc*/
        DELETE FROM TBBADDED131M
         WHERE RPRT_CD  = #{rprtCd}
           AND DOC_ID   = #{docId}
    </update>
    
    <!--부서명가져오기-->
    <select id="selectDptNm" parameterType="paramMap" resultType="String">
    /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.selectDptNm */
        SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD  = #{schSpvBrdvCd}
    </select>

            <!-- 감사계획 총괄 조회 -->
    <select id="AEPPLN001EselectAudMain" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselectAudMain */
        <![CDATA[
        WITH MAX_ROW AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                               ,A.DPT_CD
                           FROM (/***********************************************************/
                                 SELECT Z.* FROM TBBADDED128M Z
                                  WHERE NOT EXISTS (SELECT 'X'
                                                      FROM TBBADDED128D X
                                                     WHERE X.AUD_PLAN_YR  = Z.AUD_PLAN_YR
                                                       AND X.DPT_CD       = Z.DPT_CD
                                                       AND X.AUD_PLAN_SNO = Z.AUD_PLAN_SNO)
                                  UNION ALL
                                 SELECT Y.* FROM TBBADDED128D Y
                                 /***********************************************************/
                                ) A
                          WHERE 1=1
                            AND A.AUD_PLAN_YR = #{audPlanYr}
                          ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                        )
            ,T_QUARTER1 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                                  ,A.AUD_PLAN_YR
                                  ,A.DPT_CD
                                  ,A.AUD_PLAN_SNO
                                  ,F_DPT_INFO(A.DPT_CD, '4') AS DPT_NM
                                  ,F_CODE_NM('1000739', A.AUD_KND_CD) AS AUD_KND_NM
                                  ,SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월' AS SM
                                  ,A.AUD_SBJ_NM
                                  ,A.PLAN_NUD_GUBN
                                  ,A.MPP_AUD_YN
                                  ,A.DOC_ID
                                  ,A.RPRT_FILD_ID
                              FROM (/***********************************************************/
                                    SELECT Z.* FROM TBBADDED128M Z
                                     WHERE NOT EXISTS (SELECT 'X'
                                                         FROM TBBADDED128D X
                                                        WHERE X.AUD_PLAN_YR  = Z.AUD_PLAN_YR
                                                          AND X.DPT_CD       = Z.DPT_CD
                                                          AND X.AUD_PLAN_SNO = Z.AUD_PLAN_SNO)
                                     UNION ALL
                                    SELECT Y.* FROM TBBADDED128D Y
                                    /***********************************************************/
                                   ) A
                             WHERE A.AUD_PLAN_YR = #{audPlanYr}
                               AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') = '1'
                             ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                           )
            ,T_QUARTER2 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                                  ,A.AUD_PLAN_YR
                                  ,A.DPT_CD
                                  ,A.AUD_PLAN_SNO
                                  ,F_DPT_INFO(A.DPT_CD, '4') AS DPT_NM
                                  ,F_CODE_NM('1000739', A.AUD_KND_CD) AS AUD_KND_NM
                                  ,SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월' AS SM
                                  ,A.AUD_SBJ_NM
                                  ,A.PLAN_NUD_GUBN
                                  ,A.MPP_AUD_YN
                                  ,A.DOC_ID
                                  ,A.RPRT_FILD_ID
                              FROM (/***********************************************************/
                                    SELECT Z.* FROM TBBADDED128M Z
                                     WHERE NOT EXISTS (SELECT 'X'
                                                         FROM TBBADDED128D X
                                                        WHERE X.AUD_PLAN_YR  = Z.AUD_PLAN_YR
                                                          AND X.DPT_CD       = Z.DPT_CD
                                                          AND X.AUD_PLAN_SNO = Z.AUD_PLAN_SNO)
                                     UNION ALL
                                    SELECT Y.* FROM TBBADDED128D Y
                                    /***********************************************************/
                                   ) A
                             WHERE A.AUD_PLAN_YR = #{audPlanYr}
                               AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') = '2'
                             ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                           )
            ,T_QUARTER3 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                                  ,A.AUD_PLAN_YR
                                  ,A.DPT_CD
                                  ,A.AUD_PLAN_SNO
                                  ,F_DPT_INFO(A.DPT_CD, '4') AS DPT_NM
                                  ,F_CODE_NM('1000739', A.AUD_KND_CD) AS AUD_KND_NM
                                  ,SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월' AS SM
                                  ,A.AUD_SBJ_NM
                                  ,A.PLAN_NUD_GUBN
                                  ,A.MPP_AUD_YN
                                  ,A.DOC_ID
                                  ,A.RPRT_FILD_ID
                              FROM (/***********************************************************/
                                    SELECT Z.* FROM TBBADDED128M Z
                                     WHERE NOT EXISTS (SELECT 'X'
                                                         FROM TBBADDED128D X
                                                        WHERE X.AUD_PLAN_YR  = Z.AUD_PLAN_YR
                                                          AND X.DPT_CD       = Z.DPT_CD
                                                          AND X.AUD_PLAN_SNO = Z.AUD_PLAN_SNO)
                                     UNION ALL
                                    SELECT Y.* FROM TBBADDED128D Y
                                    /***********************************************************/
                                   ) A
                             WHERE A.AUD_PLAN_YR = #{audPlanYr}
                               AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') = '3'
                             ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                           )
            ,T_QUARTER4 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                                  ,A.AUD_PLAN_YR
                                  ,A.DPT_CD
                                  ,A.AUD_PLAN_SNO
                                  ,F_DPT_INFO(A.DPT_CD, '4') AS DPT_NM
                                  ,F_CODE_NM('1000739', A.AUD_KND_CD) AS AUD_KND_NM
                                  ,SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월' AS SM
                                  ,A.AUD_SBJ_NM
                                  ,A.PLAN_NUD_GUBN
                                  ,A.MPP_AUD_YN
                                  ,A.DOC_ID
                                  ,A.RPRT_FILD_ID
                              FROM (/***********************************************************/
                                    SELECT Z.* FROM TBBADDED128M Z
                                     WHERE NOT EXISTS (SELECT 'X'
                                                         FROM TBBADDED128D X
                                                        WHERE X.AUD_PLAN_YR  = Z.AUD_PLAN_YR
                                                          AND X.DPT_CD       = Z.DPT_CD
                                                          AND X.AUD_PLAN_SNO = Z.AUD_PLAN_SNO)
                                     UNION ALL
                                    SELECT Y.* FROM TBBADDED128D Y
                                    /***********************************************************/
                                   ) A
                             WHERE A.AUD_PLAN_YR = #{audPlanYr}
                               AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') = '4'
                             ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                           )
        SELECT Q.DPT_NM
              ,(SELECT ST.DPT_NM FROM TBDCMACM002M ST WHERE ST.DPT_CD=Q.DPT_CD ) AS SL_DPT_NM
              ,Q.DPT_CD
              ,DECODE(Q.QUARTER1_NUD,NULL,NULL,Q.QUARTER1_NUD||' ')||Q.QUARTER1 AS QUARTER1
              ,DECODE(Q.QUARTER2_NUD,NULL,NULL,Q.QUARTER2_NUD||' ')||Q.QUARTER2 AS QUARTER2
              ,DECODE(Q.QUARTER3_NUD,NULL,NULL,Q.QUARTER3_NUD||' ')||Q.QUARTER3 AS QUARTER3
              ,DECODE(Q.QUARTER4_NUD,NULL,NULL,Q.QUARTER4_NUD||' ')||Q.QUARTER4 AS QUARTER4
              ,Q.QUARTER1_YR
              ,Q.QUARTER2_YR
              ,Q.QUARTER3_YR
              ,Q.QUARTER4_YR
              ,Q.QUARTER1_SNO
              ,Q.QUARTER2_SNO
              ,Q.QUARTER3_SNO
              ,Q.QUARTER4_SNO
              ,Q.QUARTER1_NUD
              ,Q.QUARTER2_NUD
              ,Q.QUARTER3_NUD
              ,Q.QUARTER4_NUD
              ,Q.QUARTER1_MPP
              ,Q.QUARTER2_MPP
              ,Q.QUARTER3_MPP
              ,Q.QUARTER4_MPP
              ,Q.QUARTER1_DOC_ID
              ,Q.QUARTER2_DOC_ID
              ,Q.QUARTER3_DOC_ID
              ,Q.QUARTER4_DOC_ID
              ,'' AS QUARTER1_RPRT_FILD_ID
              ,'' AS QUARTER2_RPRT_FILD_ID
              ,'' AS QUARTER3_RPRT_FILD_ID
              ,'' AS QUARTER4_RPRT_FILD_ID
          FROM (
                SELECT F_DPT_INFO(MST.DPT_CD, '4') AS DPT_NM
                      ,MST.DPT_CD                  AS DPT_CD
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN '('||A.AUD_KND_NM||'-'||A.SM||') '||A.AUD_SBJ_NM ELSE NULL END AS QUARTER1
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN '('||B.AUD_KND_NM||'-'||B.SM||') '||B.AUD_SBJ_NM ELSE NULL END AS QUARTER2
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN '('||C.AUD_KND_NM||'-'||C.SM||') '||C.AUD_SBJ_NM ELSE NULL END AS QUARTER3
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN '('||D.AUD_KND_NM||'-'||D.SM||') '||D.AUD_SBJ_NM ELSE NULL END AS QUARTER4
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN A.AUD_PLAN_YR  ELSE NULL END AS QUARTER1_YR
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN B.AUD_PLAN_YR  ELSE NULL END AS QUARTER2_YR
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN C.AUD_PLAN_YR  ELSE NULL END AS QUARTER3_YR
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN D.AUD_PLAN_YR  ELSE NULL END AS QUARTER4_YR
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN A.AUD_PLAN_SNO ELSE NULL END AS QUARTER1_SNO
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN B.AUD_PLAN_SNO ELSE NULL END AS QUARTER2_SNO
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN C.AUD_PLAN_SNO ELSE NULL END AS QUARTER3_SNO
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN D.AUD_PLAN_SNO ELSE NULL END AS QUARTER4_SNO
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN DECODE(A.PLAN_NUD_GUBN,NULL,NULL,A.PLAN_NUD_GUBN) ELSE NULL END AS QUARTER1_NUD
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN DECODE(B.PLAN_NUD_GUBN,NULL,NULL,B.PLAN_NUD_GUBN) ELSE NULL END AS QUARTER2_NUD
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN DECODE(C.PLAN_NUD_GUBN,NULL,NULL,C.PLAN_NUD_GUBN) ELSE NULL END AS QUARTER3_NUD
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN DECODE(D.PLAN_NUD_GUBN,NULL,NULL,D.PLAN_NUD_GUBN) ELSE NULL END AS QUARTER4_NUD
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN DECODE(A.MPP_AUD_YN,NULL,'N',A.MPP_AUD_YN) ELSE NULL END AS QUARTER1_MPP
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN DECODE(B.MPP_AUD_YN,NULL,'N',B.MPP_AUD_YN) ELSE NULL END AS QUARTER2_MPP
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN DECODE(C.MPP_AUD_YN,NULL,'N',C.MPP_AUD_YN) ELSE NULL END AS QUARTER3_MPP
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN DECODE(D.MPP_AUD_YN,NULL,'N',D.MPP_AUD_YN) ELSE NULL END AS QUARTER4_MPP
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN DECODE(A.DOC_ID,NULL,NULL,A.DOC_ID) ELSE NULL END AS QUARTER1_DOC_ID
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN DECODE(B.DOC_ID,NULL,NULL,B.DOC_ID) ELSE NULL END AS QUARTER2_DOC_ID
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN DECODE(C.DOC_ID,NULL,NULL,C.DOC_ID) ELSE NULL END AS QUARTER3_DOC_ID
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN DECODE(D.DOC_ID,NULL,NULL,D.DOC_ID) ELSE NULL END AS QUARTER4_DOC_ID
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN DECODE(A.RPRT_FILD_ID,NULL,NULL,A.RPRT_FILD_ID) ELSE NULL END AS QUARTER1_RPRT_FILD_ID
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN DECODE(B.RPRT_FILD_ID,NULL,NULL,B.RPRT_FILD_ID) ELSE NULL END AS QUARTER2_RPRT_FILD_ID
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN DECODE(C.RPRT_FILD_ID,NULL,NULL,C.RPRT_FILD_ID) ELSE NULL END AS QUARTER3_RPRT_FILD_ID
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN DECODE(D.RPRT_FILD_ID,NULL,NULL,D.RPRT_FILD_ID) ELSE NULL END AS QUARTER4_RPRT_FILD_ID
                  FROM MAX_ROW    MST
                      ,T_QUARTER1 A
                      ,T_QUARTER2 B
                      ,T_QUARTER3 C
                      ,T_QUARTER4 D
                 WHERE MST.R_NUM = A.R_NUM(+) AND MST.DPT_CD = A.DPT_CD(+)
                   AND MST.R_NUM = B.R_NUM(+) AND MST.DPT_CD = B.DPT_CD(+)
                   AND MST.R_NUM = C.R_NUM(+) AND MST.DPT_CD = C.DPT_CD(+)
                   AND MST.R_NUM = D.R_NUM(+) AND MST.DPT_CD = D.DPT_CD(+)
                   AND NVL(A.AUD_PLAN_SNO,0)+NVL(B.AUD_PLAN_SNO,0)+NVL(C.AUD_PLAN_SNO,0)+NVL(D.AUD_PLAN_SNO,0) <> 0
               ) Q
         WHERE 1=1
            ]]>
         <if test='dptCd != null and dptCd != ""'>
           AND SUBSTR(Q.DPT_CD, 0, 3)||'000' =SUBSTR( #{dptCd}, 0, 3)||'000'
         </if>
         <if test='dptCd == null and schSpvBrdvCd != ""'>
           AND SUBSTR(Q.DPT_CD, 0, 3)||'000' = #{schSpvBrdvCd}
         </if>
         ORDER BY Q.DPT_CD
    </select>
    
            <!-- 감사계획 총괄 조회 -->
    <select id="AEPPLN001EselectAudMain2" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001E.AEPPLN001EselectAudMain2 */
        <![CDATA[
        WITH MAX_ROW AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                               ,A.DPT_CD
                           FROM TBBADDED128M A
                          WHERE 1=1
                            AND A.AUD_PLAN_YR = #{audPlanYr}
                          ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                        )
            ,T_QUARTER1 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                                  ,A.AUD_PLAN_YR
                                  ,A.DPT_CD
                                  ,A.AUD_PLAN_SNO
                                  ,F_DPT_INFO(A.DPT_CD, '4') AS DPT_NM
                                  ,F_CODE_NM('1000739', A.AUD_KND_CD) AS AUD_KND_NM
                                  ,SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월' AS SM
                                  ,A.AUD_SBJ_NM
                                  ,A.PLAN_NUD_GUBN
                                  ,A.MPP_AUD_YN
                                  ,A.DOC_ID
                                  ,A.RPRT_FILD_ID
                              FROM TBBADDED128M A
                             WHERE A.AUD_PLAN_YR = #{audPlanYr}
                               AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') = '1'
                             ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                           )
            ,T_QUARTER2 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                                  ,A.AUD_PLAN_YR
                                  ,A.DPT_CD
                                  ,A.AUD_PLAN_SNO
                                  ,F_DPT_INFO(A.DPT_CD, '4') AS DPT_NM
                                  ,F_CODE_NM('1000739', A.AUD_KND_CD) AS AUD_KND_NM
                                  ,SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월' AS SM
                                  ,A.AUD_SBJ_NM
                                  ,A.PLAN_NUD_GUBN
                                  ,A.MPP_AUD_YN
                                  ,A.DOC_ID
                                  ,A.RPRT_FILD_ID
                              FROM TBBADDED128M A
                             WHERE A.AUD_PLAN_YR = #{audPlanYr}
                               AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') = '2'
                             ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                           )
            ,T_QUARTER3 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                                  ,A.AUD_PLAN_YR
                                  ,A.DPT_CD
                                  ,A.AUD_PLAN_SNO
                                  ,F_DPT_INFO(A.DPT_CD, '4') AS DPT_NM
                                  ,F_CODE_NM('1000739', A.AUD_KND_CD) AS AUD_KND_NM
                                  ,SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월' AS SM
                                  ,A.AUD_SBJ_NM
                                  ,A.PLAN_NUD_GUBN
                                  ,A.MPP_AUD_YN
                                  ,A.DOC_ID
                                  ,A.RPRT_FILD_ID
                              FROM TBBADDED128M A
                             WHERE A.AUD_PLAN_YR = #{audPlanYr}
                               AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') = '3'
                             ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                           )
            ,T_QUARTER4 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.ACTU_AUD_STR_DY,A.AUD_PLAN_SNO) AS R_NUM
                                  ,A.AUD_PLAN_YR
                                  ,A.DPT_CD
                                  ,A.AUD_PLAN_SNO
                                  ,F_DPT_INFO(A.DPT_CD, '4') AS DPT_NM
                                  ,F_CODE_NM('1000739', A.AUD_KND_CD) AS AUD_KND_NM
                                  ,SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월' AS SM
                                  ,A.AUD_SBJ_NM
                                  ,A.PLAN_NUD_GUBN
                                  ,A.MPP_AUD_YN
                                  ,A.DOC_ID
                                  ,A.RPRT_FILD_ID
                              FROM TBBADDED128M A
                             WHERE A.AUD_PLAN_YR = #{audPlanYr}
                               AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') = '4'
                             ORDER BY A.DPT_CD,ACTU_AUD_STR_DY,A.AUD_PLAN_SNO
                           )
        SELECT Q.DPT_NM
              ,(SELECT ST.DPT_NM FROM TBDCMACM002M ST WHERE ST.DPT_CD=Q.DPT_CD ) AS SL_DPT_NM
              ,Q.DPT_CD
              ,DECODE(Q.QUARTER1_NUD,NULL,NULL,Q.QUARTER1_NUD||' ')||Q.QUARTER1 AS QUARTER1
              ,DECODE(Q.QUARTER2_NUD,NULL,NULL,Q.QUARTER2_NUD||' ')||Q.QUARTER2 AS QUARTER2
              ,DECODE(Q.QUARTER3_NUD,NULL,NULL,Q.QUARTER3_NUD||' ')||Q.QUARTER3 AS QUARTER3
              ,DECODE(Q.QUARTER4_NUD,NULL,NULL,Q.QUARTER4_NUD||' ')||Q.QUARTER4 AS QUARTER4
              ,Q.QUARTER1_YR
              ,Q.QUARTER2_YR
              ,Q.QUARTER3_YR
              ,Q.QUARTER4_YR
              ,Q.QUARTER1_SNO
              ,Q.QUARTER2_SNO
              ,Q.QUARTER3_SNO
              ,Q.QUARTER4_SNO
              ,Q.QUARTER1_NUD
              ,Q.QUARTER2_NUD
              ,Q.QUARTER3_NUD
              ,Q.QUARTER4_NUD
              ,Q.QUARTER1_MPP
              ,Q.QUARTER2_MPP
              ,Q.QUARTER3_MPP
              ,Q.QUARTER4_MPP
              ,Q.QUARTER1_DOC_ID
              ,Q.QUARTER2_DOC_ID
              ,Q.QUARTER3_DOC_ID
              ,Q.QUARTER4_DOC_ID
              ,Q.QUARTER1_RPRT_FILD_ID
              ,Q.QUARTER2_RPRT_FILD_ID
              ,Q.QUARTER3_RPRT_FILD_ID
              ,Q.QUARTER4_RPRT_FILD_ID
          FROM (
                SELECT F_DPT_INFO(MST.DPT_CD, '4') AS DPT_NM
                      ,MST.DPT_CD                  AS DPT_CD
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN '('||A.AUD_KND_NM||'-'||A.SM||') '||A.AUD_SBJ_NM ELSE NULL END AS QUARTER1
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN '('||B.AUD_KND_NM||'-'||B.SM||') '||B.AUD_SBJ_NM ELSE NULL END AS QUARTER2
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN '('||C.AUD_KND_NM||'-'||C.SM||') '||C.AUD_SBJ_NM ELSE NULL END AS QUARTER3
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN '('||D.AUD_KND_NM||'-'||D.SM||') '||D.AUD_SBJ_NM ELSE NULL END AS QUARTER4
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN A.AUD_PLAN_YR  ELSE NULL END AS QUARTER1_YR
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN B.AUD_PLAN_YR  ELSE NULL END AS QUARTER2_YR
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN C.AUD_PLAN_YR  ELSE NULL END AS QUARTER3_YR
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN D.AUD_PLAN_YR  ELSE NULL END AS QUARTER4_YR
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN A.AUD_PLAN_SNO ELSE NULL END AS QUARTER1_SNO
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN B.AUD_PLAN_SNO ELSE NULL END AS QUARTER2_SNO
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN C.AUD_PLAN_SNO ELSE NULL END AS QUARTER3_SNO
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN D.AUD_PLAN_SNO ELSE NULL END AS QUARTER4_SNO
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN DECODE(A.PLAN_NUD_GUBN,NULL,NULL,A.PLAN_NUD_GUBN) ELSE NULL END AS QUARTER1_NUD
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN DECODE(B.PLAN_NUD_GUBN,NULL,NULL,B.PLAN_NUD_GUBN) ELSE NULL END AS QUARTER2_NUD
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN DECODE(C.PLAN_NUD_GUBN,NULL,NULL,C.PLAN_NUD_GUBN) ELSE NULL END AS QUARTER3_NUD
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN DECODE(D.PLAN_NUD_GUBN,NULL,NULL,D.PLAN_NUD_GUBN) ELSE NULL END AS QUARTER4_NUD
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN DECODE(A.MPP_AUD_YN,NULL,'N',A.MPP_AUD_YN) ELSE NULL END AS QUARTER1_MPP
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN DECODE(B.MPP_AUD_YN,NULL,'N',B.MPP_AUD_YN) ELSE NULL END AS QUARTER2_MPP
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN DECODE(C.MPP_AUD_YN,NULL,'N',C.MPP_AUD_YN) ELSE NULL END AS QUARTER3_MPP
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN DECODE(D.MPP_AUD_YN,NULL,'N',D.MPP_AUD_YN) ELSE NULL END AS QUARTER4_MPP
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN DECODE(A.DOC_ID,NULL,NULL,A.DOC_ID) ELSE NULL END AS QUARTER1_DOC_ID
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN DECODE(B.DOC_ID,NULL,NULL,B.DOC_ID) ELSE NULL END AS QUARTER2_DOC_ID
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN DECODE(C.DOC_ID,NULL,NULL,C.DOC_ID) ELSE NULL END AS QUARTER3_DOC_ID
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN DECODE(D.DOC_ID,NULL,NULL,D.DOC_ID) ELSE NULL END AS QUARTER4_DOC_ID
                      ,CASE WHEN A.AUD_SBJ_NM IS NOT NULL THEN DECODE(A.RPRT_FILD_ID,NULL,NULL,A.RPRT_FILD_ID) ELSE NULL END AS QUARTER1_RPRT_FILD_ID
                      ,CASE WHEN B.AUD_SBJ_NM IS NOT NULL THEN DECODE(B.RPRT_FILD_ID,NULL,NULL,B.RPRT_FILD_ID) ELSE NULL END AS QUARTER2_RPRT_FILD_ID
                      ,CASE WHEN C.AUD_SBJ_NM IS NOT NULL THEN DECODE(C.RPRT_FILD_ID,NULL,NULL,C.RPRT_FILD_ID) ELSE NULL END AS QUARTER3_RPRT_FILD_ID
                      ,CASE WHEN D.AUD_SBJ_NM IS NOT NULL THEN DECODE(D.RPRT_FILD_ID,NULL,NULL,D.RPRT_FILD_ID) ELSE NULL END AS QUARTER4_RPRT_FILD_ID
                  FROM MAX_ROW    MST
                      ,T_QUARTER1 A
                      ,T_QUARTER2 B
                      ,T_QUARTER3 C
                      ,T_QUARTER4 D
                 WHERE MST.R_NUM = A.R_NUM(+) AND MST.DPT_CD = A.DPT_CD(+)
                   AND MST.R_NUM = B.R_NUM(+) AND MST.DPT_CD = B.DPT_CD(+)
                   AND MST.R_NUM = C.R_NUM(+) AND MST.DPT_CD = C.DPT_CD(+)
                   AND MST.R_NUM = D.R_NUM(+) AND MST.DPT_CD = D.DPT_CD(+)
                   AND NVL(A.AUD_PLAN_SNO,0)+NVL(B.AUD_PLAN_SNO,0)+NVL(C.AUD_PLAN_SNO,0)+NVL(D.AUD_PLAN_SNO,0) <> 0
               ) Q
         WHERE 1=1
            ]]>
         <if test='dptCd != null and dptCd != ""'>
           AND Q.DPT_CD = #{dptCd}
         </if>
         <if test='dptCd == null and schSpvBrdvCd != ""'>
           AND SUBSTR(Q.DPT_CD, 0, 3)||'000' = #{schSpvBrdvCd}
         </if>
         ORDER BY Q.DPT_CD
    </select>
    
    <!-- 계획관리-업무계획보고서작성 목록* -->
    <select id="selectTab4MainList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectTab4MainList */
        <![CDATA[
            SELECT A.AUD_PLAN_YR ,
                   A.DPT_CD ,
                   F_DPT_INFO(A.DPT_CD, '1') AS DPT_NM , /*감사명*/
                   A.AUD_PLAN_SNO ,
                   A.AUD_SBJ_NM , /*감사명*/
                   F_CODE_NM('1000739',A.AUD_KND_CD) AS AUD_KND_NM , /*감사종류*/
                   B.DOC_ID AS DOC_ID , /*명세서ID*/
                   B.RPRT_NM AS RPRT_NM , /*명세서명*/
                   B.RPRT_CD AS RPRT_CD ,
                   A.DATA_AUD_STR_DY ,
                   A.DATA_AUD_END_DY ,
                   A.DATA_AUD_DT ,
                   A.PREY_AUD_STR_DY ,
                   A.PREY_AUD_END_DY ,
                   A.PREY_AUD_DT ,
                   A.ACTU_AUD_STR_DY ,
                   A.ACTU_AUD_END_DY ,
                   A.ACTU_AUD_DT ,
                   A.PRSS_AUD_STR_DY ,
                   A.PRSS_AUD_END_DY ,
                   A.AUD_POINT ,
                   A.RLTN_ORG ,
                   A.MPP_AUD_YN ,
                   A.MPP_AUD_YR ,
                   A.MPP_AUD_NO ,
                   A.PLAN_PR_GUBN ,
                   A.PLAN_NUD_GUBN ,
                   A.FRT_USR_ID , /*작성자ID*/
                   F_USR_INFO_BY_ID(A.FRT_USR_ID, '2')||'('||TO_CHAR(A.FRT_REGI_DH,'YY"-"MM"-"DD')||')' AS FRT_USR_NM , /*작성자명+(일자)*/
                   A.FNL_USR_ID ,
                   A.FNL_DEAL_DPT_CD ,
                   A.FNL_MNU_ID ,
                   A.FRT_REGI_DH ,
                   A.FNL_MDF_DH ,
                   (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = A.DPT_CD ) AS HI_DPT_CD ,
                   DECODE((SELECT COUNT(1)
                              FROM TBBADDED131M S
                             WHERE S.AUD_PLAN_YR = #{audPlanYr}
                               AND S.DPT_CD IN (SELECT S2.HIRK_DPT_CD FROM TBDCMACM002M S2 WHERE S2.DPT_CD=A.DPT_CD AND S2.USE_YN = 'Y')
                               AND S.RPRT_CD = 'A11000100'
                               AND S.APV_STA_CD = '30'), 0, 'Y', 'N') AS PLAN_CHG_YN/*변경마감 정보*/
              FROM TBBADDED128M A LEFT OUTER JOIN (SELECT AUD_PLAN_YR,AUD_PLAN_SNO,DPT_CD,DOC_ID, RPRT_NM, RPRT_CD
                                                     FROM TBBADDED131M
                                                    WHERE RPRT_CD = 'A11000800') B ON (A.AUD_PLAN_YR=B.AUD_PLAN_YR AND A.DPT_CD=B.DPT_CD AND A.AUD_PLAN_SNO=B.AUD_PLAN_SNO)
              WHERE 1=1
         ]]>
                AND A.AUD_PLAN_YR = #{audPlanYr}
              <if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
                <if test="schDeptCd != null and schDeptCd != ''">
                    AND A.DPT_CD IN (#{schDeptCd})
                </if>
                <if test="schDeptCd == null || schDeptCd == ''">
                    AND A.DPT_CD IN (SELECT DPT_CD FROM TBDCMACM002M WHERE HIRK_DPT_CD=#{schSpvBrdvCd})
                </if>
                
              </if>

             <![CDATA[
              ORDER BY A.DPT_CD ,
                    A.AUD_KND_CD
             ]]>

    </select>

    <!-- 계획관리-개별 보고서 목록 -->
    <select id="selectTab4SubList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectTab4SubList */
        <![CDATA[
        /* kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectTab4SubList */
    SELECT ROWNUM AS NO,
           RPRT_CD,
           RPRT_GUBUN, /*보고서구분*/
           RPRT_NM ,
           FRT_USR_ID,
           FRT_USR_NM , /*작성자명*/
           DOC_ID, /*보고서DOCID*/
           AUD_PLAN_YR ,
           DPT_CD ,
           AUD_PLAN_SNO,
           DEL_NM,
           FRT_REGI_DH,  /*작성자명+(일자)*/
           HI_DPT_CD ,
           PLAN_CHG_YN/*변경마감 정보*/
      FROM
         (    
            SELECT 
                   A.RPRT_CD,
                   A.RPRT_GUBUN, /*보고서구분*/
                   B.RPRT_NM AS RPRT_NM, /*보고서명*/
                   B.FRT_USR_ID,
                   F_USR_INFO_BY_ID(B.FRT_USR_ID, '2') AS FRT_USR_NM , /*작성자명*/
                   B.DOC_ID, /*보고서DOCID*/
                   B.AUD_PLAN_YR ,
                   B.DPT_CD ,
                   B.AUD_PLAN_SNO ,
                   CASE WHEN A.RPRT_CD = 'A11000810' AND (B.DOC_ID IS NULL OR B.DOC_ID='') THEN '취합'
                        WHEN B.DOC_ID IS NULL OR B.DOC_ID='' THEN '작성'
                   ELSE '삭제' END DEL_NM,
                   DECODE(B.FRT_USR_ID,NULL,'','','',F_USR_INFO_BY_ID(B.FRT_USR_ID, '2')||'('||TO_CHAR(B.FRT_REGI_DH,'YY"-"MM"-"DD')||')') AS FRT_REGI_DH,  /*작성자명+(일자)*/
                   #{dptCd} AS HI_DPT_CD ,
                   (DECODE(
                            ( SELECT COUNT(1)
                                FROM TBBADDED131M S3 
                               WHERE S3.AUD_PLAN_YR = #{audPlanYr} 
                                 AND S3.RPRT_CD = 'A11000100' 
                                 AND S3.APV_STA_CD = '30'
                                 AND S3.DPT_CD =  #{dptCd} 
                            ), 0, 'Y', 'N') ) AS PLAN_CHG_YN/*변경마감 정보*/
              FROM(
                   SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11000810'
                   UNION ALL SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11000900' /*감사계획 공개(안)*/
                   UNION ALL SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11001000' /*대행위탁감사 목록*/
                   UNION ALL SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11001100' /*외부전문가 자문등 활용계획*/
                   UNION ALL SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11001200' /*수견직원감사활용계획*/
                   UNION ALL SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11001300' /*연구용역계획*/
                   UNION ALL SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11001400' /*감사연구원 활용계획*/
                   UNION ALL SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11001500' /*해외 자료수집 계획*/
                   UNION ALL SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11001600' /*정책사업모니터링목록*/
                   UNION ALL SELECT AUD_DOC_CD AS RPRT_CD, DTIL_AUD_DOC_NM AS RPRT_GUBUN FROM TBFDMADM002M WHERE AUD_DOC_CD ='A11001700' /*운영발전을위한일반업무 주요과제명세서*/


                   ) A LEFT OUTER JOIN
                   (
                       SELECT S1.RPRT_NM, S1.FRT_USR_ID, S1.DOC_ID, S1.RPRT_CD, S1.FRT_REGI_DH, S1.AUD_PLAN_YR ,S1.DPT_CD , S1.AUD_PLAN_SNO
                         FROM TBBADDED131M S1
]]>
                        WHERE S1.AUD_PLAN_YR = #{audPlanYr}
                          AND S1.DPT_CD =#{dptCd}
                   ) B ON(A.RPRT_CD = B.RPRT_CD)
             ORDER BY A.RPRT_CD
        )
    </select>

    <select id="selectDocumentList" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectDocumentList*/
        /*문서함(결재정보)*/
        <![CDATA[
        SELECT
               RPRT_NM,
               APV_STA_CD,
               APV_RQS_ID,
               DOC_ID,
               APV_SRNO,
               PST_NM,
               APVR_NM,
               APV_DH ,
               CASE WHEN ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SRNO) = 1 THEN COUNT(*) OVER(PARTITION BY DOC_ID)
                    ELSE 0
                END ROWSPAN_CNT
         FROM (
               SELECT
                       A.RPRT_NM ,       /*보고서명 */
                       A.APV_STA_CD ,    /*결재상태코드 */
                       A.DOC_ID ,        /*결재문서번호 */
                      A.APV_RQS_ID,     /*결재요청ID */
                       B.APV_SRNO ,      /*결재순번 */
                       B.PST_NM ,        /*결재자직위코드 */
                       B.APVR_NM ,       /*결재자전산번호 */
                       B.APV_DH          /*결재일시 */
                 FROM TBBADDED131M A,
                      (
                       SELECT APV_DOC_NO AS APV_RQS_ID ,
                              APV_SNO AS APV_SRNO ,
                              CASE WHEN APVR_PST_CD IS NULL
                                   THEN ONR_PST_NM
                                   ELSE F_CODE_NM('1000176', APVR_PST_CD)
                               END  AS PST_NM ,
                              F_USR_INFO(APVR_CNB, '2') AS APVR_NM ,
                              CASE WHEN SUBSTR(APVR_STA_CD,0,1) = '2' THEN TO_CHAR(APV_DH, 'YYYY-MM-DD')
                                   ELSE ''
                               END  AS APV_DH
                         FROM TBDCMACM023L
                        WHERE APV_SNO <> '1'
                          AND APVR_KND_CD NOT IN ('4','6','7')

                       UNION ALL

                       SELECT DH1.APV_RQS_ID,
                              DH1.APV_SRNO,
                              (SELECT H2.PST_NM AS PST_NM
                                 FROM TBDCMACM111H H1,
                                      TBDCMACM112H H2
                                WHERE 1=1
                                  AND H1.RCPT_DT = H2.RCPT_DT
                                  AND H1.RCPT_ID = H2.RCPT_ID
                                  AND H1.ONR_DOC_MNG_CRD_ID = DH1.APV_RQS_ID
                                  AND H2.APVR_ID = DH1.APVR_ID
                                GROUP BY H2.PST_NM ) AS PST_NM,
                               DH1.APVR_NM,
                               DH1.APV_DH
                        FROM
                            (SELECT ONR_DOC_MNG_CRD_ID AS APV_RQS_ID,
                                    APV_HIS_SRNO AS APV_SRNO,
                                    APVR_ID,
                                    APVR_NM AS APVR_NM,
                                    TO_CHAR(APV_DH, 'YYYY-MM-DD') AS APV_DH
                               FROM TBDCMACM102L D2
                              WHERE 1=1
                                AND ONR_APV_DVSN_CD <> '10' --(기안자 제외)
                                AND NVL(ONR_APV_RSLT_CD,'hh') <>'50'
                              ORDER BY APV_RQS_ID,APV_SRNO
                            ) DH1
                      ) B
                     WHERE 1=1
            ]]>
                      AND A.AUD_PLAN_YR = #{audPlanYr}

                     <if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
                      AND A.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD=#{schSpvBrdvCd})
                    </if>
                    <if test="hiDptCd != null and hiDptCd != ''">
                      AND A.DPT_CD IN (#{hiDptCd})
                    </if>
                    <if test="rprtCd != 'A11001800' and rprtCd != 'A11001900'">
                        <if test="rprtCd == 'A11000100'">
                            AND A.RPRT_CD IN (#{rprtCd},'A11002010','A11002000') 
                        </if>
                        <if test="rprtCd != 'A11000100'">
                            AND A.RPRT_CD = #{rprtCd}
                        </if>
                    </if>

                    <if test="rprtCd == 'A11001800' or rprtCd == 'A11001900'">
                      AND A.RPRT_CD IN ('A11001800','A11001900')
                    </if>
                    <if test="rprtCd == 'A11000800'">
                      AND A.DPT_CD = #{dptCd}
                    </if>

                    <if test="audPlanSno != null and audPlanSno != ''">
                      AND A.AUD_PLAN_SNO = #{audPlanSno}
                    </if>
                      AND B.APV_RQS_ID = A.APV_RQS_ID
                    ORDER BY A.SORT_SNO
                )
    </select>

    <select id="selectDocumentList2" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectDocumentList2*/
        /*문서함(문서자체정보)*/
        <![CDATA[
          SELECT
               RPRT_NM ,       /*보고서명 */
               A.AUD_PLAN_YR ,
               A.AUD_PLAN_SNO ,
               A.DPT_CD ,
               A.RPRT_CD ,       /*보고서코드*/
               A.REF_ID ,
               A.APV_STA_CD,    /*결재상태코드 */
               F_CODE_NM('1000773',A.APV_STA_CD) AS APV_STA_NM ,    /*결재상태코드 */
               A.SORT_SNO ,      /*보고서순번  */
               A.DOC_ID,         /*결재문서번호 */
               A.APV_RQS_ID,      /*결재ID*/
               '' AS APV_YN ,           /*결재여부 */
               CON_PGM_CD ,    /*연계프로그램코드*/
               A.NECES_YN , /*필수여부*/
               A.APV_WAY_CD , /*결재방법코드*/
               TO_CHAR(A.SND_DH,'YYYY"-"MM"-"DD') AS SND_DH,  
               TO_CHAR(A.RCPT_DH,'YYYY"-"MM"-"DD') AS RCPT_DH,  
               A.SND_DOC_YN, /*문서발송여부*/
               A.DOC_STA_CD,
               F_USR_INFO_BY_ID(A.FRT_USR_ID, '2') AS FRT_USR_NM ,
               TO_CHAR(A.FRT_REGI_DH,'YYYY"-"MM"-"DD') AS FRT_REGI_DH,
               F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
          FROM TBBADDED131M AS A
          ]]>
         WHERE A.AUD_PLAN_YR = #{audPlanYr}
          <if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
           AND A.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD=#{schSpvBrdvCd})
          </if>
          <if test="hiDptCd != null and hiDptCd != ''">
           AND A.DPT_CD IN (#{hiDptCd})
          </if>
          <if test="rprtCd != 'A11001800' and rprtCd != 'A11001900'">
              <if test="rprtCd == 'A11000100'">
                  AND A.RPRT_CD IN (#{rprtCd},'A11002010','A11002000') 
              </if>
              <if test="rprtCd != 'A11000100'">
                  AND A.RPRT_CD = #{rprtCd}
              </if>
          </if>
          <if test="rprtCd == 'A11000800'">
           AND A.DPT_CD = #{dptCd}
          </if>
          <if test="rprtCd == 'A11001800' or rprtCd == 'A11001900'">
           AND A.RPRT_CD IN ('A11001800','A11001900')
          </if>
          <if test="audPlanSno != null and audPlanSno != ''">
           AND A.AUD_PLAN_SNO = #{audPlanSno}
          </if>
        ORDER BY A.SORT_SNO ASC, A.FRT_REGI_DH ASC
    </select>

    <select id="selectDocumentA11000100List" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectDocumentA11000100List*/
        /*감사계획 필수서식*/
        <![CDATA[
          SELECT
               RPRT_NM ,       /*보고서명 */
               A.AUD_PLAN_YR ,
               A.AUD_PLAN_SNO ,
               A.DPT_CD ,
               A.RPRT_CD ,       /*보고서코드*/
               A.REF_ID ,
               A.APV_STA_CD,    /*결재상태코드 */
               F_CODE_NM('1000773',A.APV_STA_CD) AS APV_STA_NM ,    /*결재상태코드 */
               A.SORT_SNO ,      /*보고서순번  */
               A.DOC_ID,         /*결재문서번호 */
               A.APV_RQS_ID,      /*결재ID*/
               '' AS APV_YN ,           /*결재여부 */
               CON_PGM_CD,    /*연계프로그램코드*/
               A.NECES_YN ,
               A.APV_WAY_CD , /*결재방법코드*/
               A.SND_DOC_YN, /*문서발송여부*/
               F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
          FROM TBBADDED131M AS A
          ]]>
         WHERE A.AUD_PLAN_YR = #{audPlanYr}
           AND A.RPRT_CD = 'A11000100'
         <if test="hiDptCd != null and hiDptCd != ''">
           AND A.DPT_CD IN (#{hiDptCd})
         </if>
         <if test="rprtCd == 'A11000800'">
           AND A.DPT_CD IN (SELECT DPT_CD FROM TBDCMACM002M
                             WHERE SUBSTR( DPT_CD, 0, 3) = SUBSTR(#{dptCd}, 0, 3)
                               AND DPT_CD LIKE '%000'
                               AND USE_YN = 'Y')
         </if>

        ORDER BY A.SORT_SNO ASC, A.FRT_REGI_DH ASC
    </select>

    <select id="selectDocumentReqList" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectDocumentReqList*/
        /*감사업무계획 보고서*/
        <![CDATA[
          SELECT
               RPRT_NM ,       /*보고서명 */
               A.AUD_PLAN_YR ,
               A.AUD_PLAN_SNO ,
               A.DPT_CD ,
               A.RPRT_CD ,       /*보고서코드*/
               A.REF_ID ,
               A.APV_STA_CD,    /*결재상태코드 */
               F_CODE_NM('1000773',A.APV_STA_CD) AS APV_STA_NM ,    /*결재상태코드 */
               A.SORT_SNO ,      /*보고서순번  */
               A.DOC_ID,         /*결재문서번호 */
               A.APV_RQS_ID,      /*결재ID*/
               '' AS APV_YN ,           /*결재여부 */
               CON_PGM_CD,    /*연계프로그램코드*/
               A.NECES_YN ,
               A.APV_WAY_CD , /*결재방법코드*/
               A.SND_DOC_YN, /*문서발송여부*/
               F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
          FROM TBBADDED131M AS A
          ]]>
         WHERE A.AUD_PLAN_YR = #{audPlanYr}
           AND A.RPRT_CD = 'A11002000'
         <if test="hiDptCd != null and hiDptCd != ''">
           AND A.DPT_CD IN (#{hiDptCd})
         </if>
         <if test="rprtCd == 'A11000800'">
           AND A.DPT_CD IN (SELECT DPT_CD FROM TBDCMACM002M
                             WHERE SUBSTR( DPT_CD, 0, 3) = SUBSTR(#{dptCd}, 0, 3)
                               AND DPT_CD LIKE '%000'
                               AND USE_YN = 'Y')
         </if>

        ORDER BY A.SORT_SNO ASC, A.FRT_REGI_DH ASC
    </select>

    <select id="selectTab4MainList2" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectTab4MainList2*/
        /*문서함(문서자체정보)*/
        <![CDATA[
          SELECT Q.AUD_PLAN_YR ,
                 Q.AUD_PLAN_SNO ,
                 P.DPT_SNO ,
                 P.DPT_CD ,
                 Q.RPRT_NM ,/*보고서명 */
                 Q.RPRT_CD ,/*보고서코드*/
                 Q.REF_ID ,
                 Q.APV_STA_CD,/*결재상태코드 */
                 Q.SORT_SNO ,/*보고서순번  */
                 Q.DOC_ID,/*결재문서번호 */
                 Q.APV_RQS_ID,/*결재ID*/
                 Q.APV_YN ,/*결재여부 */
                 Q.CON_PGM_CD, /*연계프로그램코드*/
                 Q.NECES_YN ,/*필수여부*/
                 Q.APV_WAY_CD ,/*결재방법코드*/
                 Q.SND_DOC_YN ,/*문서발송여부*/
                 Q.APV_STA_NM ,/*작성자명+(일자)*/
                 P.DPT_NM ,
                 Q.DOC_STA_NM ,
                 Q.FNL_USR_NM ,/*최종결재자명*/
                 R.RPRT_NM_FL ,
                 R.DOC_ID_FL ,
                 R.AUD_PLAN_YR_FL ,
                 R.DOC_STA_NM_FL ,
                 R.APV_STA_NM_FL ,
                 R.AUD_PLAN_SNO_FL ,
                 (DECODE((SELECT COUNT(1)
                            FROM TBBADDED128M S
                           WHERE S.AUD_PLAN_YR = #{audPlanYr}
                             AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                             AND (S.PLAN_CHG_YN ='N' OR S.PLAN_CHG_YN IS NULL)), 0, 'Y', 'N') ) AS PLAN_CHG_YN  /*변경마감 정보*/
                , Q.DOC_TYPE             
                , R.DOC_TYPE_FL
            FROM (SELECT S1.DPT_SNO,
                         S1.DPT_CD,
                         S1.DPT_NM
                    FROM TBDCMACM002M S1
                   WHERE S1.USE_YN = 'Y'
                     AND S1.IMD_CD = 'Y'
                     AND S1.ORZT_DVSN_CD = '20'
                     AND S1.DPT_CD NOT IN ('100000','150000')
                   ORDER BY S1.DPT_SNO
                 )P LEFT JOIN
                 (SELECT A.AUD_PLAN_YR , A.AUD_PLAN_SNO , A.DPT_CD , A.RPRT_NM , /*보고서명 */
                         A.RPRT_CD ,
                         A.REF_ID , A.APV_STA_CD,
                         A.SORT_SNO ,
                         A.DOC_ID,
                         A.APV_RQS_ID,
                         '' AS APV_YN ,
                         CON_PGM_CD ,
                         A.NECES_YN ,
                         A.APV_WAY_CD ,
                         A.SND_DOC_YN ,
                         DECODE(A.DOC_STA_CD,'10','발신','20','접수','30','반려','40','확정','50','마감','60','마감취소','') AS DOC_STA_NM ,
                         DECODE(A.APV_STA_CD, NULL, '', '', '', F_CODE_NM('1000773', A.APV_STA_CD)) AS APV_STA_NM ,/*결재상태*/
                         (SELECT APV_USR_NM 
                            FROM (SELECT DECODE(APV_DH,NULL,'',F_USR_INFO(APVR_CNB,'2')||'('||TO_CHAR(APV_DH,'YYYY-MM-DD')||')') AS APV_USR_NM,
                                         APV_DOC_NO
                                    FROM TBDCMACM023L
                                   WHERE APVR_KND_CD = '3'
                                   ORDER BY APV_SNO DESC
                                 ) ST1 JOIN TBBADDED131M ST2 ON (ST1.APV_DOC_NO = ST2.APV_RQS_ID)
                           WHERE 1=1
                             AND ST2.AUD_PLAN_YR    = A.AUD_PLAN_YR
                             AND ST2.DPT_CD         = A.DPT_CD
	                         AND ST2.AUD_PLAN_SNO   = A.AUD_PLAN_SNO
	                         AND ST2.APV_STA_CD     = '30'
	                         AND ST2.RPRT_CD        = A.RPRT_CD
                          ) AS FNL_USR_NM
                       , F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
                    FROM TBBADDED131M AS A
                   WHERE A.AUD_PLAN_YR = #{audPlanYr}
                     AND A.RPRT_CD = 'A11000100'  
                ORDER BY A.SORT_SNO ASC, A.FRT_REGI_DH ASC
                     )Q on (P.DPT_CD = Q.DPT_CD)
                LEFT JOIN
                 (SELECT A.DPT_CD AS DPT_CD_FL,A.AUD_PLAN_YR AS AUD_PLAN_YR_FL,
                         A.RPRT_NM AS RPRT_NM_FL, /*보고서명 */
                         A.RPRT_CD AS RPRT_CD_FL ,
                         A.APV_STA_CD AS APV_STA_CD_FL ,
                         A.SORT_SNO AS SROT_SNO_FL,
                         A.DOC_ID AS DOC_ID_FL,
                         A.AUD_PLAN_SNO AS AUD_PLAN_SNO_FL,
                         A.APV_RQS_ID AS APV_RQS_ID_FL,
                         DECODE(A.DOC_STA_CD,'10','발신','20','접수','30','반려','40','확정','50','마감','60','마감취소','') AS DOC_STA_NM_FL ,
                         DECODE(A.APV_STA_CD, NULL, '', '', '', F_CODE_NM('1000773', A.APV_STA_CD)) AS APV_STA_NM_FL ,/*결재상태*/
                         (SELECT APV_USR_NM 
                            FROM (SELECT DECODE(APV_DH,NULL,'',F_USR_INFO(APVR_CNB,'2')||'('||TO_CHAR(APV_DH,'YYYY-MM-DD')||')') AS APV_USR_NM,
                                         APV_DOC_NO
                                    FROM TBDCMACM023L
                                   WHERE APVR_KND_CD = '3'
                                   ORDER BY APV_SNO DESC
                                 ) ST1 JOIN TBBADDED131M ST2 ON (ST1.APV_DOC_NO = ST2.APV_RQS_ID)
                           WHERE 1=1
                             AND ST2.AUD_PLAN_YR    = A.AUD_PLAN_YR
                             AND ST2.DPT_CD         = A.DPT_CD
	                         AND ST2.AUD_PLAN_SNO   = A.AUD_PLAN_SNO
	                         AND ST2.APV_STA_CD     = '30'
	                         AND ST2.RPRT_CD        = A.RPRT_CD
                          ) AS FNL_USR_NM_FL
                       , F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE_FL
                    FROM TBBADDED131M AS A
                                       
                   WHERE A.AUD_PLAN_YR = #{audPlanYr}
                     AND A.RPRT_CD = 'A11002000'
                ORDER BY A.SORT_SNO ASC, A.FRT_REGI_DH ASC
                     )R on (P.DPT_CD = R.DPT_CD_FL)   
           WHERE 1=1
           ]]>
             <if test='schSpvBrdvCd != null and schSpvBrdvCd != ""'>
             AND  P.DPT_CD IN ( SELECT S.DPT_CD FROM TBDCMACM002M S
                                 WHERE SUBSTR( S.DPT_CD, 0, 3) = SUBSTR(#{schSpvBrdvCd}, 0, 3)
                                   AND S.DPT_CD LIKE '%000'
                                   AND S.USE_YN = 'Y'
                              )
             </if>

    </select>

    <update id="updateApvReturn" parameterType="paramMap">
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.updateApvReturn*/
        <![CDATA[
        DECLARE
         BEGIN
            UPDATE TBBADDED131M
           SET APV_STA_CD      = '10'
         WHERE APV_RQS_ID      = #{apvRqsId}
        ;
        
        UPDATE TBDCMACM022L
           SET APV_STA_CD      = '1'
              ,FNL_APV_CNB     = #{cnb}
              ,FNL_USR_ID      = #{fnlUsrId}
              ,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
              ,FNL_MDF_DH      = SYSDATE
         WHERE APV_DOC_NO      = #{apvRqsId}
           AND APV_DVSN_CD     = 'AudExecPlanMng'
        ;
        
        UPDATE TBDCMACM023L
           SET APVR_STA_CD     = DECODE(APV_SNO,1,'101',NULL)
              ,APV_DH          = NULL
              ,APV_OPIN        = NULL
              ,FNL_USR_ID      = #{fnlUsrId}
              ,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
              ,FNL_MDF_DH      = SYSDATE
         WHERE APV_DOC_NO      = #{apvRqsId}
           AND APV_DVSN_CD     = 'AudExecPlanMng'
        ;
        END;
        ]]>
    </update>

   <insert id="insertDoc" parameterType="paramMap">
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.insertDoc*/
        INSERT INTO    TBBADDED131M
                            (    AUD_PLAN_YR
                                ,DPT_CD 
                                ,AUD_PLAN_SNO 
                                ,DOC_ID 
                                ,RPRT_NM 
                                ,LINK_URL 
                                ,NECES_YN 
                                ,APV_STA_CD 
                                ,RPRT_CD 
                                /* ,APV_RQS_ID */
                                ,SND_DOC_YN 
                                ,DOC_KND_CD 
                                ,AUD_RPRT_DVSN_CD 
                                ,REF_ID 
                                ,REF_DY 
                                ,RLTN_ORG_CD 
                                ,SORT_SNO 
                                ,SYT_TRTM_DVSN_YN 
                                ,AUD_DOC_KND_CD 
                                ,CON_PGM_CD 
                                ,APV_WAY_CD 
                                ,DOC_WRT_ID 
                                ,ONR_HNDL_NO 
                                ,SECU_RPT_YN 
                                ,FNL_RPRT_CRE_YN 
                                ,FNL_BAI_RPRT_YN 
                                ,REF_DOC_ID 
                                ,TEMPLATE_DOC_ID 
                                /* ,RCPT_DPT_CD */ 
                                /* ,SND_DH */ 
                                ,EDT_AUTH 
                                ,FRT_USR_ID 
                                ,FNL_USR_ID 
                                ,FNL_DEAL_DPT_CD 
                                ,FNL_MNU_ID 
                                ,FRT_REGI_DH 
                                ,FNL_MDF_DH 
                                /* ,RCPT_DH */ 
                                /* ,DOC_STA_CD */
                            )
                         SELECT    
                                 AUD_PLAN_YR
                                ,DPT_CD 
                                ,'1'                /* AUD_PLAN_SNO */ 
                                ,#{cpDocId}         /* DOC_ID */
                                ,RPRT_NM||'(최종)' 
                                ,#{linkUrl}         /* LINK_URL */ 
                                ,NECES_YN 
                                ,'10'               /* APV_STA_CD */ 
                                ,'A11002010'        /* RPRT_CD */ 
                                /* ,APV_RQS_ID */ 
                                ,SND_DOC_YN 
                                ,DOC_KND_CD 
                                ,AUD_RPRT_DVSN_CD 
                                ,REF_ID 
                                ,REF_DY 
                                ,RLTN_ORG_CD 
                                ,SORT_SNO 
                                ,SYT_TRTM_DVSN_YN 
                                ,AUD_DOC_KND_CD 
                                ,CON_PGM_CD 
                                ,APV_WAY_CD 
                                ,DOC_WRT_ID 
                                ,ONR_HNDL_NO 
                                ,SECU_RPT_YN 
                                ,FNL_RPRT_CRE_YN 
                                ,FNL_BAI_RPRT_YN 
                                ,REF_DOC_ID 
                                ,TEMPLATE_DOC_ID 
                                /* ,RCPT_DPT_CD */ 
                                /* ,SND_DH */ 
                                ,EDT_AUTH 
                                ,FRT_USR_ID 
                                ,#{fnlUsrId}      /* FNL_USR_ID */ 
                                ,#{fnlDealDptCd}  /* FNL_DEAL_DPT_CD */
                                ,FNL_MNU_ID 
                                ,SYSDATE 
                                ,SYSDATE          /* FNL_MDF_DH */ 
                                /* ,RCPT_DH */ 
                                /* ,DOC_STA_CD */
                          FROM TBBADDED131M
                         WHERE AUD_PLAN_YR    = #{audPlanYr}
                           AND DPT_CD         = #{dptCd}
                           AND RPRT_CD        = 'A11000100'
                           AND DOC_ID         = #{docId}
    </insert>

    <select id="selectTab6MainList" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectTab6MainList*/
        <![CDATA[
                    WITH MAX_ROW AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,FNL_MDF_DH ,A.AUD_PLAN_SNO) AS R_NUM
                                           ,A.DPT_CD
                                       FROM TBBADDED131M A
                                      WHERE A.RPRT_CD IN ('A11001800','A11001900')
                                        AND A.AUD_PLAN_YR = #{audPlanYr}
                                      ORDER BY A.DPT_CD,FNL_MDF_DH ,A.AUD_PLAN_SNO
                                    )
                        ,T_RPRT1 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.FNL_MDF_DH ,A.AUD_PLAN_SNO) AS R_NUM
                                           ,A.AUD_PLAN_YR
                                           ,A.DPT_CD
                                           ,A.DOC_ID
                                           ,A.APV_STA_CD
                                           ,A.AUD_PLAN_SNO
                                           ,F_DPT_INFO(A.DPT_CD, '1') AS DPT_NM
                                           ,A.RPRT_NM
                                           ,(
                                               SELECT TO_CHAR(MAX(APV_DH),'YYYY"-"MM"-"DD" "HH24:MI')
	                                             FROM TBDCMACM023L ST1 
                                                 JOIN TBBADDED131M ST2 ON (ST1.APV_DOC_NO = ST2.APV_RQS_ID)
	                                            WHERE ST2.AUD_PLAN_YR    = A.AUD_PLAN_YR
                                                  AND ST2.DPT_CD         = A.DPT_CD
	                                              AND ST2.AUD_PLAN_SNO   = A.AUD_PLAN_SNO
	                                              AND ST2.APV_STA_CD     = '30'
	                                              AND ST2.RPRT_CD        = A.RPRT_CD
                                           ) AS FNL_MDF_DH
                                       FROM TBBADDED131M A
                                      WHERE A.RPRT_CD     = 'A11001800'
                                        AND A.AUD_PLAN_YR = #{audPlanYr}
                                      ORDER BY A.DPT_CD,A.FNL_MDF_DH ,A.AUD_PLAN_SNO
                                    )
                        ,T_RPRT2 AS (SELECT RANK() OVER (PARTITION BY A.DPT_CD ORDER BY A.DPT_CD,A.FNL_MDF_DH ,A.AUD_PLAN_SNO) AS R_NUM
                                           ,A.AUD_PLAN_YR
                                           ,A.DPT_CD
                                           ,A.DOC_ID
                                           ,A.APV_STA_CD
                                           ,A.AUD_PLAN_SNO
                                           ,F_DPT_INFO(A.DPT_CD, '1') AS DPT_NM
                                           ,A.RPRT_NM
                                           ,(
                                               SELECT TO_CHAR(MAX(APV_DH),'YYYY"-"MM"-"DD" "HH24:MI')
	                                             FROM TBDCMACM023L ST1 
                                                 JOIN TBBADDED131M ST2 ON (ST1.APV_DOC_NO = ST2.APV_RQS_ID)
	                                           WHERE ST2.AUD_PLAN_YR     = A.AUD_PLAN_YR
                                                  AND ST2.DPT_CD         = A.DPT_CD
	                                              AND ST2.AUD_PLAN_SNO   = A.AUD_PLAN_SNO
	                                              AND ST2.APV_STA_CD     = '30'
	                                              AND ST2.RPRT_CD        = A.RPRT_CD
                                           ) AS FNL_MDF_DH
                                       FROM TBBADDED131M A
                                      WHERE A.RPRT_CD     = 'A11001900'
                                        AND A.AUD_PLAN_YR = #{audPlanYr}
                                      ORDER BY A.DPT_CD,A.FNL_MDF_DH ,A.AUD_PLAN_SNO
                                    )
                    SELECT P.DPT_NM
                          ,Q.R_NUM
                          ,Q.RPRT1
                          ,Q.RPRT2
                          ,Q.AUD_YRAA
                          ,Q.RPRT1_YR
                          ,Q.RPRT2_YR
                          ,Q.RPRT1_SNO
                          ,Q.RPRT1_DOCID
                          ,Q.RPRT2_SNO
                          ,Q.RPRT2_DOCID
                          ,P.DPT_CD AS OG_DPT_CD
                          ,Q.RPRT1_STACD
                          ,Q.RPRT2_STACD
                          ,P.DPT_SNO
                          ,CASE WHEN (SELECT COUNT(1) FROM TBBADDED128M S
                                       WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                         AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                         AND S.PLAN_CHG_YN = 'Y')>0 THEN '변경가능'
                                 WHEN (SELECT COUNT(1) FROM TBBADDED128M S
                                        WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                          AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          AND (S.PLAN_CHG_YN = 'N' OR S.PLAN_CHG_YN IS NULL)) > 0 THEN '변경불가'
                                 WHEN (
                                          (SELECT COUNT(1) FROM TBBADDED128M S
                                            WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                              AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          )=0
                                          AND 
                                          (SELECT COUNT(1) FROM TBBADDED128D S
                                           WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                             AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          )=0 
                                      )THEN '변경가능'
                                 WHEN (
                                          (SELECT COUNT(1) FROM TBBADDED128M S
                                            WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                              AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          )=0
                                          AND 
                                          (SELECT COUNT(1) FROM TBBADDED128D S
                                           WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                             AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          )>0 
                                      )THEN '변경가능'
                                 ELSE '변경가능'
                                  END AS PLAN_CHG_YN
                          ,CASE WHEN (SELECT COUNT(1) FROM TBBADDED128M S
                                       WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                         AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                         AND S.PLAN_CHG_YN = 'Y')>0 THEN '변경가능'
                                 WHEN (SELECT COUNT(1) FROM TBBADDED128M S
                                        WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                          AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          AND (S.PLAN_CHG_YN = 'N' OR S.PLAN_CHG_YN IS NULL)) > 0 THEN '변경불가'
                                 WHEN (
                                          (SELECT COUNT(1) FROM TBBADDED128M S
                                            WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                              AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          )=0
                                          AND 
                                          (SELECT COUNT(1) FROM TBBADDED128D S
                                           WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                             AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          )=0 
                                      )THEN '감사계획 미작성'
                                 WHEN (
                                          (SELECT COUNT(1) FROM TBBADDED128M S
                                            WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                              AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          )=0
                                          AND 
                                          (SELECT COUNT(1) FROM TBBADDED128D S
                                           WHERE S.AUD_PLAN_YR = #{audPlanYr}
                                             AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                                          )>0 
                                      )THEN '감사계획 미작성<br>(변경요청중)'
                                 ELSE '변경가능'
                                  END AS CH_NM
                          ,(SELECT COUNT(1)
                              FROM TBBADDED128M S
                             WHERE S.AUD_PLAN_YR = #{audPlanYr}
                               AND S.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD = P.DPT_CD AND S2.USE_YN = 'Y')
                            ) AS CHG_YN_CNT
                          ,SUM(Q.RPRT1_NUM) OVER (PARTITION BY P.DPT_CD) AS RPRT1_NUM
                          ,SUM(Q.RPRT2_NUM) OVER (PARTITION BY P.DPT_CD) AS RPRT2_NUM
                          ,SUM(Q.RPRT1_COM_NUM) OVER (PARTITION BY P.DPT_CD) AS RPRT1_COM_NUM
                          ,SUM(Q.RPRT2_COM_NUM) OVER (PARTITION BY P.DPT_CD) AS RPRT2_COM_NUM
                      FROM (SELECT S1.DPT_SNO,S1.DPT_CD,S1.DPT_NM
                              FROM TBDCMACM002M S1
                             WHERE S1.USE_YN         = 'Y'
                               AND S1.IMD_CD         = 'Y'
                               AND S1.ORZT_DVSN_CD   = '20'
                               AND S1.DPT_CD NOT IN ('100000','150000')
                             ORDER BY S1.DPT_SNO
                           )P LEFT JOIN
                           (SELECT F_DPT_INFO(MST.DPT_CD, '1') AS DPT_NM
                                  ,MST.DPT_CD AS DPT_CD
                                  ,MST.R_NUM
                                  ,CASE WHEN A.RPRT_NM IS NOT NULL THEN A.RPRT_NM ELSE NULL END AS RPRT1
                                  ,CASE WHEN B.RPRT_NM IS NOT NULL THEN B.RPRT_NM ELSE NULL END AS RPRT2
                                  ,CASE WHEN A.RPRT_NM IS NOT NULL THEN A.AUD_PLAN_YR
                                        WHEN B.RPRT_NM IS NOT NULL THEN B.AUD_PLAN_YR
                                    END AS AUD_YRAA
                                  ,CASE WHEN A.RPRT_NM IS NOT NULL THEN A.AUD_PLAN_YR   ELSE NULL END AS RPRT1_YR
                                  ,CASE WHEN B.RPRT_NM IS NOT NULL THEN B.AUD_PLAN_YR   ELSE NULL END AS RPRT2_YR
                                  ,CASE WHEN A.RPRT_NM IS NOT NULL THEN A.AUD_PLAN_SNO  ELSE NULL END AS RPRT1_SNO
                                  ,CASE WHEN B.RPRT_NM IS NOT NULL THEN B.AUD_PLAN_SNO  ELSE NULL END AS RPRT2_SNO
                                  ,CASE WHEN A.RPRT_NM IS NOT NULL THEN A.DOC_ID        ELSE NULL END AS RPRT1_DOCID
                                  ,CASE WHEN B.RPRT_NM IS NOT NULL THEN B.DOC_ID        ELSE NULL END AS RPRT2_DOCID
                                  ,CASE WHEN A.RPRT_NM IS NOT NULL THEN DECODE(A.APV_STA_CD,'30',A.FNL_MDF_DH,'') ELSE NULL END AS RPRT1_STACD
                                  ,CASE WHEN B.RPRT_NM IS NOT NULL THEN DECODE(B.APV_STA_CD,'30',B.FNL_MDF_DH,'') ELSE NULL END AS RPRT2_STACD
                                  ,CASE WHEN A.DOC_ID IS NOT NULL THEN 1        ELSE 0 END AS RPRT1_NUM
                                  ,CASE WHEN B.DOC_ID IS NOT NULL THEN 1        ELSE 0 END AS RPRT2_NUM
                                  ,CASE WHEN A.RPRT_NM IS NOT NULL THEN DECODE(A.APV_STA_CD,'30',1,0) ELSE 0 END AS RPRT1_COM_NUM
                                  ,CASE WHEN B.RPRT_NM IS NOT NULL THEN DECODE(B.APV_STA_CD,'30',1,0) ELSE 0 END AS RPRT2_COM_NUM
                              FROM MAX_ROW MST
                                  ,T_RPRT1 A
                                  ,T_RPRT2 B
                             WHERE MST.R_NUM = A.R_NUM(+) AND MST.DPT_CD = A.DPT_CD(+)
                               AND MST.R_NUM = B.R_NUM(+) AND MST.DPT_CD = B.DPT_CD(+)
                               AND NVL(A.AUD_PLAN_SNO,0)+NVL(B.AUD_PLAN_SNO,0) <> 0
                           ) Q
                        ON (P.DPT_CD = Q.DPT_CD)
                     WHERE 1=1
                     
                     ]]>
                     <if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
                       AND P.DPT_CD = #{schSpvBrdvCd}     
                     </if>
                     ORDER BY P.DPT_SNO ASC, Q.R_NUM ASC,Q.RPRT1_STACD ASC, Q.RPRT2_STACD ASC
    </select>

    <select id="selectCkDocumentList" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectCkDocumentList*/
        /*문서함(문서자체정보)*/
        <![CDATA[
        SELECT
               RPRT_NM ,       /*보고서명 */
               A.RPRT_CD ,       /*보고서코드*/
               A.REF_ID ,
               A.APV_STA_CD,    /*결재상태코드 */
               F_CODE_NM('1000773',A.APV_STA_CD) AS APV_STA_NM ,    /*결재상태코드 */
               A.SORT_SNO ,      /*보고서순번  */
               A.DOC_ID,         /*결재문서번호 */
               A.APV_RQS_ID,      /*결재ID*/
               '' AS APV_YN ,           /*결재여부 */
               CON_PGM_CD ,    /*연계프로그램코드*/
                  /*필수여부*/
               A.NECES_YN,
               A.APV_WAY_CD, /*결재방법코드*/
               A.SND_DOC_YN /*문서발송여부*/
          FROM TBBADDED131M AS A
          ]]>
         WHERE A.AUD_PLAN_YR = #{audPlanYr}
         <if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
           AND A.DPT_CD IN (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD=#{schSpvBrdvCd})
         </if>
           AND A.RPRT_CD = #{rprtCd}
    </select>
    
    <select id="selectTab4SndList" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectTab4SndList*/
        /*문서함(문서자체정보)*/
        <![CDATA[
        SELECT
               RPRT_NM ,       /*보고서명 */
               A.RPRT_CD ,       /*보고서코드*/
               A.REF_ID ,
               A.APV_STA_CD,    /*결재상태코드 */
               DECODE(A.DOC_STA_CD,'10','발신','20','접수','30','반려','40','확정','50','마감','60','마감취소','') AS DOC_STA_NM ,
               A.SORT_SNO ,      /*보고서순번  */
               A.DOC_ID,         /*결재문서번호 */
               A.APV_RQS_ID,      /*결재ID*/
               '' AS APV_YN ,           /*결재여부 */
               CON_PGM_CD ,    /*연계프로그램코드*/
                  /*필수여부*/
               A.NECES_YN,
               A.APV_WAY_CD, /*결재방법코드*/
               A.SND_DOC_YN, /*문서발송여부*/
               TO_CHAR(A.SND_DH,'YY"-"MM"-"DD') AS SND_DH,
               TO_CHAR(A.RCPT_DH,'YY"-"MM"-"DD') AS RCPT_DH,
               F_DPT_INFO(A.RCPT_DPT_CD, '4') AS RCPT_DPT_NM
          FROM TBBADDED131M AS A
          ]]>
         WHERE A.AUD_PLAN_YR       = #{audPlanYr}
           AND A.DPT_CD            = #{schSpvBrdvCd}
           AND A.SND_DH IS NOT NULL
           AND A.RPRT_CD IN (
               #{rprtCd1}
               <if test="rprtCd2 != null and rprtCd2 != ''"> 
                   , #{rprtCd2}   
               </if>
               <if test="rprtCd3 != null and rprtCd3 != ''"> 
                   , #{rprtCd3}   
               </if>
           )
           
    </select>
    
    <select id="selectSndList" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectSndList*/
        /*문서함(문서자체정보)*/
        <![CDATA[
        SELECT
               RPRT_NM ,       /*보고서명 */
               A.RPRT_CD ,       /*보고서코드*/
               A.REF_ID ,
               A.APV_STA_CD,    /*결재상태코드 */
               DECODE(A.DOC_STA_CD,'10','발신','20','접수','30','반려','40','확정','50','마감','60','마감취소','') AS DOC_STA_NM ,
               A.SORT_SNO ,      /*보고서순번  */
               A.DOC_ID,         /*결재문서번호 */
               A.APV_RQS_ID,      /*결재ID*/
               '' AS APV_YN ,           /*결재여부 */
               CON_PGM_CD ,    /*연계프로그램코드*/
                  /*필수여부*/
               A.NECES_YN,
               A.APV_WAY_CD, /*결재방법코드*/
               A.SND_DOC_YN, /*문서발송여부*/
               TO_CHAR(A.SND_DH,'YY"-"MM"-"DD') AS SND_DH,
               TO_CHAR(A.RCPT_DH,'YY"-"MM"-"DD') AS RCPT_DH,
               F_DPT_INFO(A.RCPT_DPT_CD, '4') AS RCPT_DPT_NM
          FROM TBBADDED131M AS A
          ]]>
         WHERE A.AUD_PLAN_YR       = #{audPlanYr}
           <if test='dptCd == null and schSpvBrdvCd != ""'>
           AND A.DPT_CD = SUBSTR(#{schSpvBrdvCd}, 0, 3)||'000'
           </if>
           <if test='dptCd != null and dptCd != ""'>
           AND A.DPT_CD = SUBSTR(#{dptCd}, 0, 3)||'000'
           </if>
           AND A.SND_DH IS NOT NULL
           AND A.RPRT_CD IN (
               #{rprtCd1}
               <if test="rprtCd2 != null and rprtCd2 != ''"> 
                   , #{rprtCd2}    
               </if>
               <if test="rprtCd3 != null and rprtCd3 != ''"> 
                   , #{rprtCd3}    
               </if>
           )
           
    </select>
    
    <select id="selectMainPro" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectMainPro*/
        SELECT  
                   (SELECT DECODE(COUNT(1),0,'N','Y')
                      FROM TBBADDED131M A
                     WHERE A.AUD_PLAN_YR = #{audPlanYr}
                       AND A.DPT_CD      = SUBSTR(#{schSpvBrdvCd}, 0, 3)||'000'
                       AND A.RPRT_CD     = 'A11000100'
                  ) AS STEP1 /*업무계획서식 작성(초안)*/
  
                  ,(SELECT DECODE(COUNT(1),0,'N','Y')
                      FROM TBBADDED131M A
                     WHERE A.AUD_PLAN_YR = #{audPlanYr}
                       AND A.DPT_CD =      SUBSTR(#{schSpvBrdvCd}, 0, 3)||'000'
                       AND A.RPRT_CD     = 'A11000100'
                       AND A.APV_STA_CD IN ('20','25','30') --10:작성중,19:작성완료,20:결재요청,25:결재중,30:결재완료
                  ) AS STEP2 /*업무계획서식 결재요청*/
                  ,(SELECT DECODE(COUNT(1),0,'N','Y') AS STEP3
                      FROM TBBADDED131M A
                     WHERE A.AUD_PLAN_YR = #{audPlanYr}
                       AND A.DPT_CD      = SUBSTR(#{schSpvBrdvCd}, 0, 3)||'000'
                       AND A.RPRT_CD     = 'A11002010'
                  )AS STEP3 /*업무계획서식 복사*/
                  ,(SELECT DECODE(COUNT(1),0,'N','Y') AS STEP4
                      FROM TBBADDED131M A
                     WHERE A.AUD_PLAN_YR = #{audPlanYr}
                       AND A.DPT_CD      = SUBSTR(#{schSpvBrdvCd}, 0, 3)||'000'
                       AND A.RPRT_CD     = 'A11000100'
                       AND A.DOC_STA_CD IN ('10','20','50','60')   /*10:발신,20:접수,30:반려,40:확정,50:마감,60:마감취소*/
                  )AS STEP4 /*업무계획서식 발신(기획)*/
  
                  ,(SELECT DECODE(COUNT(1),0,'N','Y') AS STEP5
                      FROM TBBADDED128M A
                     WHERE A.AUD_PLAN_YR = #{audPlanYr}
                       AND SUBSTR(DPT_CD, 0, 3)||'000' = SUBSTR(#{schSpvBrdvCd}, 0, 3)||'000'
                  ) AS STEP5 /*업무계획 입력*/
  
                  ,(SELECT DECODE(COUNT(1),0,'N','Y') AS STEP6
                      FROM TBBADDED131M A
                     WHERE A.AUD_PLAN_YR = #{audPlanYr}
                       AND A.DPT_CD      = SUBSTR(#{schSpvBrdvCd}, 0, 3)||'000'
                       AND A.RPRT_CD     = 'A11002000'
                  ) AS STEP6 /*업무계획 보고서 작성*/
  
                 ,(SELECT DECODE(COUNT(1),0,'N','Y') AS STEP7
                     FROM TBBADDED131M A
                    WHERE A.AUD_PLAN_YR = #{audPlanYr}
                      AND A.DPT_CD      = SUBSTR(#{schSpvBrdvCd}, 0, 3)||'000'
                      AND A.RPRT_CD     = 'A11002000'
                      AND A.APV_STA_CD IN ('20','25','30') --10:작성중,19:작성완료,20:결재요청,25:결재중,30:결재완료
                  ) AS STEP7 /*업무계획 보고서 결재요청*/
        FROM DUAL
    </select>
    
    <select id="selectTab4RcptList" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001.selectTab4RcptList*/
        /*문서함(문서자체정보)*/
        <![CDATA[
        SELECT
               RPRT_NM ,          /*보고서명 */
               A.RPRT_CD ,       /*보고서코드*/
               A.REF_ID ,
               A.APV_STA_CD,    /*결재상태코드 */
               CASE WHEN A.SND_DH IS NOT NULL AND A.RCPT_DH IS NULL THEN '발신'
                    WHEN A.SND_DH IS NOT NULL AND A.RCPT_DH IS NOT NULL THEN '접수'
               END AS DOC_STA_NM ,
               A.SORT_SNO ,      /*보고서순번  */
               A.DOC_ID,         /*결재문서번호 */
               A.APV_RQS_ID,      /*결재ID*/
               '' AS APV_YN ,           /*결재여부 */
               CON_PGM_CD ,    /*연계프로그램코드*/
                  /*필수여부*/
               A.NECES_YN,
               A.APV_WAY_CD, /*결재방법코드*/
               A.SND_DOC_YN, /*문서발송여부*/
               TO_CHAR(A.SND_DH,'YY"-"MM"-"DD') AS SND_DH,
               TO_CHAR(A.RCPT_DH,'YY"-"MM"-"DD') AS RCPT_DH,
               F_DPT_INFO('140100', '4') AS RCPT_DPT_NM
          FROM TBBADDED131M AS A
          ]]>
         WHERE A.AUD_PLAN_YR         = #{audPlanYr}
           AND A.DPT_CD              = #{schSpvBrdvCd}
           AND A.RCPT_DH IS NOT NULL
           AND A.RPRT_CD IN (
               #{rprtCd1}
               <if test="rprtCd2 != null and rprtCd2 != ''">
                   , #{rprtCd2}
               </if>
           )
           
    </select>

    <select id="selectaudKndCdList" parameterType="paramMap" resultType="java.util.HashMap">
    /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.selectaudKndCdList*/
        <![CDATA[
          SELECT CD,CD_NM
            FROM TBDCMACM013C
           WHERE CMM_CD_DVSN_CD = '1000739'
             AND CD <> '000000000'
             AND CD <> '5'
             AND CD <> '9'
        ]]>
    </select>

    <!-- 결재요청 ID 조건으로 문서함조회 -->
    <select id="BADDED131MParentKeySelect" parameterType="String" resultType="egovMap">
         /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.BADDED131MParentKeySelect */
         SELECT AUD_PLAN_YR /* 계획년도 */
               ,AUD_PLAN_SNO /* 계획순번 */
               ,DPT_CD /* 계획부서 */
               ,DOC_ID /* 문서ID */
           FROM TBBADDED131M
          WHERE APV_RQS_ID = #{apvRqsId} /* 결재요청ID */
    </select>

    <update id="updateChYnList" parameterType="paramMap">
         /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.updateChYnList */
         UPDATE TBBADDED128M
            SET PLAN_CHG_YN        = #{planChgYn}
               ,FNL_USR_ID         = #{fnlUsrId}
               ,FNL_DEAL_DPT_CD    = #{fnlDealDptCd}
               ,FNL_MNU_ID         = #{fnlMnuId}
               ,FNL_MDF_DH         = SYSDATE
          WHERE 1=1
            AND AUD_PLAN_YR = #{audPlanYr}
            /*AND DPT_CD      in (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD=)*/
            AND DPT_CD      in (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD=#{ogDptCd})
     </update>
     
     <update id="BADDED131MSndUpdate" parameterType="paramMap">
         /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.BADDED131MSndUpdate */
         UPDATE TBBADDED131M
            SET SND_DH             = SYSDATE
               ,RCPT_DH            = NULL
               ,DOC_STA_CD        = #{docStaCd}
               ,RCPT_DPT_CD        = #{rcptDptCd}
               ,FNL_USR_ID         = #{fnlUsrId}
               ,FNL_DEAL_DPT_CD    = #{fnlDealDptCd}
               ,FNL_MNU_ID         = #{fnlMnuId}
               ,FNL_MDF_DH         = SYSDATE
          WHERE 1=1
            AND AUD_PLAN_YR        = #{audPlanYr}
            AND RPRT_CD            = #{rprtCd}
            AND DOC_ID             = #{docId}
            AND DPT_CD             = #{sndDptCd}
     </update>
     
     <update id="updateDocStaCd" parameterType="paramMap">
         /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.updateDocStaCd */
         UPDATE TBBADDED131M
            SET DOC_STA_CD         = #{docStaCd}
               <if test='docStaCd == "20"'>
               ,RCPT_DH            = SYSDATE
               </if>
               ,FNL_USR_ID         = #{fnlUsrId}
               ,FNL_DEAL_DPT_CD    = #{fnlDealDptCd}
               ,FNL_MNU_ID         = #{fnlMnuId}
               ,FNL_MDF_DH         = SYSDATE
          WHERE 1=1
            AND AUD_PLAN_YR        = #{audPlanYr}
            AND RPRT_CD            = #{rprtCd}
            AND DOC_ID             = #{docId}
            AND DPT_CD             = #{sndDptCd}
     </update>

     <!-- 결재정보 삭제 -->
    <delete id="BADDED132MDelete" parameterType="paramMap">
        /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.BADDED132MDelete*/
        DELETE FROM TBBADDED132M
         WHERE APV_RQS_ID   = #{apvRqsId}
           AND AUD_PLAN_YR  = #{audPlanYr}
           AND AUD_PLAN_SNO = #{audPlanSno}
           AND DPT_CD       = #{dptCd}
           AND DOC_ID       = #{docId}
    </delete>

    <select id="BADDED131MRprtCdSelect" parameterType="paramMap" resultType="egovMap">
         /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.BADDED131MRprtCdSelect */
        SELECT  RPRT_CD /* 보고서코드 */
              , DPT_CD /* 단계코드 */
              , APV_RQS_ID /* 결재요청ID */
              , APV_STA_CD
          FROM TBBADDED131M
         WHERE AUD_PLAN_YR = #{audPlanYr}
           AND AUD_PLAN_SNO = #{audPlanSno}
           AND DPT_CD = #{dptCd}
           AND DOC_ID = #{docId}
    </select>

    <!-- 결재정보 저장 -->
    <insert id="BADDED132MInsert" parameterType="paramMap">
        /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.BADDED132MInsert*/
        <![CDATA[
        INSERT INTO    TBBADDED132M
                            (    APV_RQS_ID        /* 결재요청ID */
                                ,AUD_PLAN_YR              /* 계획년도 */
                                ,AUD_PLAN_SNO     /* 계획순번 */
                                ,DPT_CD          /* 계획부서 */
                                ,DOC_ID              /* 문서ID */
                                ,APV_DVSN_CD     /* 결재구분코드 */
                                ,APV_DOC_DVSN_CD /* 결재문서구분코드 */
                                ,SORT_SNO         /* 정렬순번 */
                                ,FRT_USR_ID        /* 최초사용자ID */
                                ,FNL_USR_ID        /* 최종사용자ID */
                                ,FNL_DEAL_DPT_CD/* 최종거래부서코드 */
                                ,FNL_MNU_ID       /* 최종메뉴ID */
                                ,FRT_REGI_DH       /* 최초등록일시 */
                                ,FNL_MDF_DH       /* 최종수정일시 */
                            )
                    VALUES  (
                                 #{apvRqsId}
                                ,#{audPlanYr}
                                ,#{audPlanSno}
                                ,#{dptCd}
                                ,#{docId}
                                ,#{apvDvsnCd}
                                ,#{apvDocDvsnCd}
                                ,#{sortSno}
                                ,#{frtUsrId}
                                ,#{fnlUsrId}
                                ,#{fnlDealDptCd}
                                ,#{fnlMnuId}
                                ,SYSDATE
                                ,SYSDATE
                            )
        ]]>
    </insert>

     <!-- 결재요청ID 업데이트 -->
    <update id="BADDED131MApvRqsIdUpdate" parameterType="paramMap">
         /*kr.go.bai.eip.com.dao.CommonCodeMapper.BADDED131MApvRqsIdUpdate */
        UPDATE TBBADDED131M
            SET APV_RQS_ID = #{apvRqsId} /* 결재요청ID */
                ,APV_STA_CD = DECODE(#{apvStaCd}, '20',DECODE((SELECT COUNT(*)
                                                                 FROM TBDCMACM023L
                                                                WHERE APV_DOC_NO = #{apvRqsId}
                                                                <![CDATA[
                                                                  AND APVR_KND_CD <> '1'
                                                                  AND APVR_SEQ <> 1
                                                                ]]>
                                                                  AND APV_DH IS NOT NULL
                                                                  AND SUBSTR(APVR_STA_CD, 0,1) = '2'),
                                                                0,'20','25'), #{apvStaCd}) /* 결재상태코드 */
                ,FNL_MDF_DH = SYSDATE
                ,FNL_USR_ID = #{fnlUsrId}
                ,FNL_DEAL_DPT_CD =#{fnlDealDptCd}
          WHERE AUD_PLAN_YR = #{audPlanYr}
            AND DPT_CD = #{dptCd}
            AND AUD_PLAN_SNO = #{audPlanSno}
            AND DOC_ID = #{docId}
    </update>

        <select id="selectDeptBureauList" parameterType="paramMap" resultType="java.util.HashMap">
    /*kr.go.bai.eip.com.dao.CommonCodeMapper.selectDeptBureauList*/
        <![CDATA[
                SELECT
                       DPT_CD AS CD
                      ,DPT_NM AS CD_NM
                      ,HIRK_DPT_CD
                  FROM TBDCMACM002M S1
                 WHERE USE_YN         = 'Y'
                   AND IMD_CD         = 'Y'
                   AND ORZT_DVSN_CD   = '20'
        ]]>

        <if test="strDptAuth != null and strDptAuth != ''">
                   AND DPT_CD IN ( SELECT SUBSTR(DPT_CD,'1','3')||'000' FROM TABLE(F_AUTH_DEPT(#{strCnb}, #{strDptAuth}, 'Y')))
        </if>
        <![CDATA[
                 ORDER BY SRT_SNO
        ]]>

    </select>
<!--        휴일제외 출장일수 : 총일수 - 휴일 -->
    <select id="selectWorkDay" parameterType="paramMap" resultType="java.lang.Integer">
   /*kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.selectWorkDay */

    <![CDATA[
            SELECT F_GET_NUMBER_DAY(#{str},#{end}) - (SELECT COUNT(1) AS HOL_CNT
                                                        FROM TBBADDED013B
                                                       WHERE YE||MD BETWEEN #{str} AND #{end}) AS WRK_CNT
              FROM DUAL
      ]]>
    </select>
    <!--       출장정보 변경대상건 여부 확인 -->
    <select id="selectBizTripChg" parameterType="paramMap" resultType="java.lang.Integer">
   /*kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.selectBizTripChg */

    <![CDATA[
         SELECT COUNT(-1)
           FROM TBBADDED128D
          WHERE PLAN_NUD_GUBN IS NOT NULL

        ]]>
        <if test='audPlanYr != null and audPlanYr != ""'>
            AND AUD_PLAN_YR  = #{audPlanYr}
        </if>
        <if test='dptCd != null and dptCd != ""'>
            AND DPT_CD = #{dptCd}
        </if>
        <if test='audPlanSno != null and audPlanSno != ""'>
            AND AUD_PLAN_SNO = #{audPlanSno}
        </if>
    </select>
    <!--   부서명 확인 -->
    <select id="selectDeptConf" parameterType="paramMap" resultType="java.lang.String">
   /*kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.selectDeptConf */

    <![CDATA[
            SELECT  F_DPT_INFO(#{schDeptCd}, '4') AS DPT_NM FROM DUAL
      ]]>
    </select>
    
    <!--   취합여부확인 -->
    <select id="checkSumYn" parameterType="paramMap" resultType="java.lang.String">
   /*kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.checkSumYn */

    <![CDATA[
            SELECT  DECODE(COUNT(1),0,'N','Y') AS ISYN   
              FROM  TBBADDED131M
             WHERE  AUD_PLAN_YR = #{audPlanYr}
               AND  RPRT_CD = #{rprtCd}
      ]]>
               <if test='hiDptCd != null and hiDptCd != ""'>
               AND DPT_CD in (SELECT S2.DPT_CD FROM TBDCMACM002M S2
                           WHERE SUBSTR( S2.DPT_CD, 0, 3) = SUBSTR(#{hiDptCd}, 0, 3)
                             AND DPT_CD NOT LIKE '%000'
                             AND USE_YN = 'Y' )
               </if>
               <if test='dptCd != null and dptCd != ""'>
               AND DPT_CD =#{dptCd}
               </if>
     
    </select>
    

    <!-- 변경마감 여부 조회 -->
    <select id="ckChangeComplete" parameterType="paramMap" resultType="String">
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.ckChangeComplete */
        SELECT DECODE(COUNT(1),0,'Y','N') DP_YN
          FROM TBBADDED128M
         WHERE AUD_PLAN_YR = #{audPlanYr}
           AND DPT_CD in (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD=#{schSpvBrdvCd} AND S2.USE_YN = 'Y') /* 국 */
           AND (PLAN_CHG_YN = 'N' OR PLAN_CHG_YN IS NULL)
    </select>
    
        <!-- 변경마감 여부 조회2 -->
    <select id="ckChangeComplete2" parameterType="paramMap" resultType="String">
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.ckChangeComplete2 */
        SELECT DECODE(COUNT(1),0,'Y','N') DP_YN
          FROM TBBADDED128M
         WHERE AUD_PLAN_YR = #{audPlanYr}
           AND DPT_CD in (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD=#{schSpvBrdvCd} AND S2.USE_YN = 'Y') /* 국 */
           AND (PLAN_CHG_YN = 'N' OR PLAN_CHG_YN IS NULL)
    </select>
    
    <!-- 변경마감 여부 조회3 -->
    <select id="ckChangeComplete3" parameterType="paramMap" resultType="String">
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.ckChangeComplete3 */
        SELECT DECODE(COUNT(1),0,'N','Y') RP_YN
          FROM TBBADDED128M
         WHERE AUD_PLAN_YR = #{audPlanYr}
           AND DPT_CD in (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD=#{schSpvBrdvCd} AND S2.USE_YN = 'Y') /* 국 */
           AND (PLAN_CHG_YN = 'Y' OR PLAN_CHG_YN IS NULL)
    </select>
    
    <!-- 업무계획 확정 체크 -->
    <select id="ckSelectCp" parameterType="paramMap" resultType="String">
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.ckSelectCp */
        SELECT DECODE(COUNT(1),0,'Y','N') CK_CP
          FROM TBBADDED131M
         WHERE AUD_PLAN_YR  = #{audPlanYr}
           AND DPT_CD       = #{schSpvBrdvCd}
           AND RPRT_CD      = 'A11000100' 
           AND DOC_STA_CD   = '50'
    </select>
    <!-- 변경마감 여부 조회 - 문서함에서 -->
    <select id="ckAeppln131ChangeComplete" parameterType="paramMap" resultType="String">
        /*kr.go.bai.eip.aep.pln.dao.AEPPLN001Mapper.ckAeppln131ChangeComplete */
        SELECT DECODE(COUNT(1),0,'Y','N') AS CHG_YN
          FROM TBBADDED128M
         WHERE AUD_PLAN_YR = #{audPlanYr}
        <if test="hiDptCd != null and hiDptCd != ''">
           AND DPT_CD in (SELECT S2.DPT_CD FROM TBDCMACM002M S2 WHERE S2.HIRK_DPT_CD=#{hiDptCd} AND S2.USE_YN = 'Y') /* 국 */
        </if>
        <if test="dptCd != null and dptCd != ''">
           AND DPT_CD in (SELECT S2.DPT_CD FROM TBDCMACM002M S2
                           WHERE SUBSTR( S2.DPT_CD, 0, 3) = SUBSTR(#{dptCd}, 0, 3)
                             AND DPT_CD NOT LIKE '%000'
                             AND USE_YN = 'Y' )
        </if>
           AND (PLAN_CHG_YN = 'N' OR PLAN_CHG_YN IS NULL)
    </select>
        <!--   업무계획 보고서 결재 확인 -->
    <select id="AEPPLN001ESelectDocApv" parameterType="paramMap" resultType="egovMap">
         /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.AEPPLN001ESelectDocApv */
        SELECT AUD_PLAN_YR /* 계획년도 */
             , AUD_PLAN_SNO /* 계획순번 */
             , DPT_CD /* 계획부서 */
             , APV_STA_CD
             , RPRT_CD
         FROM TBBADDED131M
        WHERE AUD_PLAN_YR = #{audPlanYr}
          AND DPT_CD = #{schSpvBrdvCd} /* 국 */
          AND RPRT_CD = 'A11000100' /* 감사업무 계획 */
    </select>
    <!--   업무계획 보고서 결재 완료 확인 -->
    <select id="ckDocApv" parameterType="paramMap" resultType="String">
         /*kr.go.bai.eip.com.dao.AEPPLN001Mapper.ckDocApv */
        SELECT DECODE(COUNT(1),0,'Y','N') AS CP_YN
         FROM TBBADDED131M
        WHERE AUD_PLAN_YR = #{audPlanYr}
          AND DPT_CD = #{schSpvBrdvCd} /* 국 */
          AND RPRT_CD = 'A11000100' /* 감사업무 계획 */
          AND APV_STA_CD = '30' /* 결재완료 */
    </select>
</mapper>