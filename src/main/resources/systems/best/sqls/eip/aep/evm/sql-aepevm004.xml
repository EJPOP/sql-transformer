<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.evm.dao.AEPEVM004PMapper">		
    <select id="selectMppRsn" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM004PMapper.selectMppRsn */
            SELECT MAX(MPP_RSN) AS MPP_RSN
                , MAX(DOC_ID) AS DOC_ID
              FROM TBBADDED147M
             WHERE 1=1
               AND AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
           <if test='preAffNo != null and preAffNo != ""'>
               AND PRE_AFF_NO = #{preAffNo}
           </if>
           <if test='affNo != null and affNo != ""'>
               AND AFF_NO = #{affNo}
           </if>
               AND APVR_CD = #{apvrCd}
               AND AUD_STEP_CD = #{audStepCd}
    </select>
    
    <select id="selectDfAffList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM004PMapper.selectDfAffList */
        <![CDATA[
            SELECT 
                T1.AUD_YR
                , T1.AUD_NO
                , T1.AUD_STEP_CD AS HD_AUD_STEP_CD
                , T1.DOC_ID AS HD_DOC_ID
                , T1.APVR_CD AS HD_APVR_CD
                , T1.AFF_SNO AS HD_AFF_SNO
                , T2.DSP_RQ_SNO AS HD_DSP_RQ_SNO
                , T3.PRE_AFF_NO 
                , T1.TITLE_NM
                , F_CODE_NM('1000002', T2.DSP_RQ_CD) AS DSP_RQ_NM
                , F_ORG_INFO(T2.RLTN_ORG_CD, 1) AS ORG_NM
                , CASE WHEN (T2.DF_AFF_SNO = #{affSno} AND T2.DF_DSP_RQ_SNO = #{dspRqSno} )
                            OR (SELECT COUNT(1) 
                                  FROM TBBADDED146M ST1
                                 WHERE ST1.AUD_YR = T2.AUD_YR
                                   AND ST1.AUD_NO = T2.AUD_NO
                                   AND ST1.HD_AFF_SNO = T2.AFF_SNO
                                   AND ST1.HD_DSP_RQ_SNO = T2.DSP_RQ_SNO
                                   AND ST1.AFF_SNO = #{affSno}
                                   AND ST1.DSP_RQ_SNO = #{dspRqSno} ) > 0 THEN 'Y' ELSE 'N' END AS SET_YN
              FROM TBBADDED145M T1
                   INNER JOIN TBBADDED146M T2
                   ON (T1.AUD_YR = T2.AUD_YR
                       AND T1.AUD_NO = T2.AUD_NO
                       AND T1.AUD_STEP_CD = T2.AUD_STEP_CD
                       AND T1.DOC_ID = T2.DOC_ID
                       AND T1.APVR_CD = T2.APVR_CD
                       AND T1.AFF_SNO = T2.AFF_SNO)
                   INNER JOIN TBBADDED147M T3
                   ON (T1.AUD_YR = T3.AUD_YR
                       AND T1.AUD_NO = T3.AUD_NO
                       AND T1.AUD_STEP_CD = T3.AUD_STEP_CD
                       AND T1.AFF_CD = SUBSTR(T3.PRE_AFF_NO,13,2)
                       AND T2.AFF_DSP_CD = SUBSTR(T3.PRE_AFF_NO,16,2)
                       AND T3.AFF_MPP_DVSN_CD = 'D80')
              WHERE T1.AUD_YR = #{audYr}
              AND T1.AUD_NO = #{audNo}
            ORDER BY T1.AFF_CD, T2.AFF_DSP_CD
         ]]>
    </select>
    
    <update id="updateMppDvsn" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM004PMapper.updateMppDvsn */
            UPDATE TBBADDED148M
               SET AFF_MPP_DVSN_CD = 'D10'
             WHERE 1=1
               AND AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
           <if test='preAffNo != null and preAffNo != ""'>
               AND PRE_AFF_NO = #{preAffNo}
           </if>
           <if test='affNo != null and affNo != ""'>
               AND AFF_NO = #{affNo}
           </if>
               AND APVR_CD = #{apvrCd}
               AND AUD_STEP_CD = #{audStepCd}

    </update>
    
    
    <update id="updateKywd" parameterType="paramMap">
        /* kr.go.bai.eip.aep.evm.dao.AEPEVM004PMapper.updateKywd */
            UPDATE TBBADDED146M
               SET KYWD1 = REPLACE(#{kywd1}, ' ', '')
                   , KYWD2 = REPLACE(#{kywd2}, ' ', '')
                   , KYWD3 = REPLACE(#{kywd3}, ' ', '')
                   , KYWD4 = REPLACE(#{kywd4}, ' ', '')
                   , KYWD5 = REPLACE(#{kywd5}, ' ', '')
             WHERE 1=1
               AND AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = #{audStepCd}
               AND DOC_ID = #{docId}
               AND APVR_CD = #{apvrCd}
               AND AFF_SNO = #{affSno}
               AND DSP_RQ_SNO = #{dspRqSno}
    </update>
    
</mapper> 