<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.cfr.dao.AEPCFR010QMapper">

    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.cfr.dao.AEPCFR010QMapper.selectMainList1*/
        <include refid="include.pageSelct" />
            SELECT A.TBL_NM_DES
                  ,A.TBL_NM
                  ,A.TBL_DES
                  ,TO_CHAR(B.IF_STR_DH, 'YYYY-MM-DD HH24:MI:SS') AS IF_STR_DH
                  ,CASE WHEN A.TBL_NM = 'TBDCMACM013C' THEN (
                                                                 SELECT COUNT(1) 
                                                                   FROM TBDCMACM013C ST 
                                                                  WHERE TO_CHAR(ST.FNL_MDF_DH, 'YYYY-MM-DD HH24:MI:SS') > DECODE(B.IF_STR_DH
                                                                                                                                       ,NULL,'0000-00-00 00:00:00'
                                                                                                                                       ,'','0000-00-00 00:00:00'
                                                                                                                                       ,TO_CHAR(B.IF_STR_DH, 'YYYY-MM-DD HH24:MI:SS') )
                                                            )
                        WHEN A.TBL_NM = 'TBDCMACM001M' THEN (
                                                                 SELECT COUNT(1) 
                                                                   FROM TBDCMACM001M ST 
                                                                  WHERE TO_CHAR(ST.FNL_MDF_DH, 'YYYY-MM-DD HH24:MI:SS') > DECODE(B.IF_STR_DH
                                                                                                                                       ,NULL,'0000-00-00 00:00:00'
                                                                                                                                       ,'','0000-00-00 00:00:00'
                                                                                                                                       ,TO_CHAR(B.IF_STR_DH, 'YYYY-MM-DD HH24:MI:SS') )
                                                            )
                        WHEN A.TBL_NM = 'TBDCMACM002M' THEN (
                                                                 SELECT COUNT(1) 
                                                                   FROM TBDCMACM002M ST 
                                                                  WHERE TO_CHAR(ST.FNL_MDF_DH, 'YYYY-MM-DD HH24:MI:SS') > DECODE(B.IF_STR_DH
                                                                                                                                       ,NULL,'0000-00-00 00:00:00'
                                                                                                                                       ,'','0000-00-00 00:00:00'
                                                                                                                                       ,TO_CHAR(B.IF_STR_DH, 'YYYY-MM-DD HH24:MI:SS') )
                                                            )
                        WHEN A.TBL_NM = 'TBDCMACM015M' THEN (
                                                                 SELECT COUNT(1) 
                                                                   FROM TBDCMACM015M ST 
                                                                  WHERE TO_CHAR(ST.FNL_MDF_DH, 'YYYY-MM-DD HH24:MI:SS') > DECODE(B.IF_STR_DH
                                                                                                                                        ,NULL,'0000-00-00 00:00:00'
                                                                                                                                       ,'','0000-00-00 00:00:00'
                                                                                                                                       ,TO_CHAR(B.IF_STR_DH, 'YYYY-MM-DD HH24:MI:SS') )
                                                            )
                        WHEN A.TBL_NM = 'TBCSPIIT006M' THEN (
                                                                 SELECT COUNT(1) 
                                                                   FROM TBCSPIIT006M ST 
                                                                  WHERE TO_CHAR(ST.FNL_MDF_DH, 'YYYY-MM-DD HH24:MI:SS') > DECODE(B.IF_STR_DH
                                                                                                                                       ,NULL,'0000-00-00 00:00:00'
                                                                                                                                       ,'','0000-00-00 00:00:00'
                                                                                                                                       ,TO_CHAR(B.IF_STR_DH, 'YYYY-MM-DD HH24:MI:SS') )
                                                            )
                   end TRNM_DATA_CNT
              FROM(
                       SELECT 'TBDCMACM013C(공통코드)' AS TBL_NM_DES
                              ,'TBDCMACM013C' AS TBL_NM
                              ,'공통코드' AS TBL_DES
                         FROM DUAL
                         UNION ALL
                       SELECT 'TBDCMACM001M(사용자정보기본)' AS TBL_NM_DES ,
                               'TBDCMACM001M' AS TBL_NM ,
                               '사용자정보기본' AS TBL_DES
                         FROM DUAL
                         UNION ALL
                       SELECT 'TBDCMACM002M(부서정보기본)' AS TBL_NM_DES ,
                               'TBDCMACM002M' AS TBL_NM ,
                               '부서정보기본' AS TBL_DES
                         FROM DUAL
                        UNION ALL
                        SELECT 'TBDCMACM015M(기관정보기본)' AS TBL_NM_DES ,
                               'TBDCMACM015M' AS TBL_NM ,
                               '기관정보기본' AS TBL_DES
                         FROM DUAL
                         UNION ALL
                        SELECT 'TBCSPIIT006M(GCC행정코드기본)' AS TBL_NM_DES ,
                               'TBCSPIIT006M' AS TBL_NM ,
                               'GCC행정코드기본' AS TBL_DES
                         FROM DUAL 
                 ) A
                 LEFT JOIN 
                 (
                        SELECT TBL_NM
                              ,TBL_DES
                              ,MAX(IF_STR_DH) AS IF_STR_DH
                          FROM EA_INF_FNDT_DATA_INFO
                         WHERE 1=1
                         GROUP BY TBL_NM,TBL_DES
                 ) B ON(A.TBL_NM=B.TBL_NM)
            WHERE 1=1
            <if test='schTblNmDes != null and schTblNmDes != ""'>
              AND A.TBL_NM LIKE '%'||#{schTblNmDes}||'%'
            </if>
            
            ORDER BY B.IF_STR_DH
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectMainList1" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.cfr.dao.AEPCFR011QMapper.selectMainList1*/
        <include refid="include.pageSelct" />
      SELECT 
             T.* 
        FROM (
                SELECT  A.CMT_YR
                       ,F_CODE_NM('1000789',A.CMT_DVSN_CD) AS CMT_DVSN_NM
                       ,A.CMT_DVSN_CD
                       ,A.CMT_SQ
                       ,A.IF_SEQ
                       ,A.CMT_DY
                       ,A.IF_WAY_DVSN
                       ,F_CODE_NM('1000848',A.IF_WAY_DVSN) AS IF_WAY_DVSN_NM
                       ,A.SBCN_CNT
                       ,A.SR_DVSN
                       ,A.IF_MSG
                       ,TO_CHAR(A.IF_STR_DH, 'YYYY-MM-DD HH24:MI:SS') AS IF_STR_DH
                       ,TO_CHAR(A.IF_END_DH, 'YYYY-MM-DD HH24:MI:SS') AS IF_END_DH
                       ,A.FRT_USR_ID
                       ,A.FNL_USR_ID
                       ,A.FRT_REGI_DH
                       ,A.FNL_MDF_DH
                       ,TO_CHAR(TO_DATE(A.CMT_DY, 'YYYYMMDD' ), 'YYYY"년"MM"월"DD"일"(DY)')
                        ||' '
                        ||CASE B.TIME_DVSN_CD WHEN 'AM' THEN '오전'
                                                       WHEN 'PM' THEN '오후'
                                                       ELSE '' END || DECODE(B.CMT_TIME,NULL,'',B.CMT_TIME||'시') 
                        || DECODE(B.CMT_MIN,NULL,'',B.CMT_MIN||'분') AS CMT_DY_NM
                        ,A.CMT_NM
                  FROM EA_INF_SBCN_INFO A LEFT JOIN TBBADDED120M B 
                                                 ON (A.CMT_DY = B.CMT_DY AND A.CMT_DVSN_CD = B.CMT_DVSN_CD AND A.CMT_SQ = B.CMT_SQ)
                WHERE A.SR_DVSN = '수신'
                <if test='schTrnmStDy != null and schTrnmStDy != ""'>
                  <![CDATA[
                  AND TO_NUMBER(TO_CHAR(A.IF_STR_DH, 'YYYYMMDD')) >= TO_NUMBER(#{schTrnmStDy})
                  ]]>
                </if>
                <if test='schTrnmEdDy != null and schTrnmEdDy != ""'>
                <![CDATA[
                  AND TO_NUMBER(TO_CHAR(A.IF_STR_DH, 'YYYYMMDD')) <= TO_NUMBER(#{schTrnmEdDy})
                ]]>
                </if>
            
                <if test='schCfrStDy != null and schCfrStDy != ""'>
                <![CDATA[
                  AND TO_NUMBER(A.CMT_DY) >= TO_NUMBER(#{schCfrStDy})
                ]]>
                </if>
                <if test='schCfrEdDy != null and schCfrEdDy != ""'>
                <![CDATA[
                  AND TO_NUMBER(A.CMT_DY) <= TO_NUMBER(#{schCfrEdDy})
                ]]>
                </if>
            
                <if test='schCfrGubun != null and schCfrGubun != ""'>
                  AND A.CMT_DVSN_CD = #{schCfrGubun}
                </if>
            
                <if test='schCfrSq != null and schCfrSq != ""'>
                  AND A.CMT_SQ = #{schCfrSq}
                </if>
            
                <if test='schIfMsg != null and schIfMsg != ""'>
                    <if test='schIfMsg == "Success"'>
                        AND A.IF_MSG = #{schIfMsg}  
                    </if>
                    <if test='schIfMsg == "fail"'>
                    <![CDATA[
                       AND A.IF_MSG  <> 'Success'  
                    ]]>
                    </if>
                </if>
            
                <if test='schConMean != null and schConMean != ""'>
                  AND A.IF_WAY_DVSN = #{schConMean}
                </if>
                <if test='schYr != null and schYr != ""'>
                  AND A.CMT_YR = #{schYr}
                </if>
            ) T 
            <if test='schCfrTitle != null and schCfrTitle != ""'>
                 INNER JOIN (SELECT DISTINCT C.CMT_YR,C.CMT_DVSN_CD,C.CMT_SQ ,C.CMT_IF_SEQ
                               FROM EA_INF_CMT_SBJ_INFO C 
                              WHERE C.CMT_SBJ_NM LIKE '%'||#{schCfrTitle}||'%' 
                            ) D ON (T.CMT_YR = D.CMT_YR AND T.CMT_DVSN_CD = D.CMT_DVSN_CD AND T.CMT_SQ = D.CMT_SQ AND T.IF_SEQ = D.CMT_IF_SEQ)
            </if>
       ORDER BY IF_STR_DH DESC
                
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectMainList2" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.cfr.dao.AEPCFR010QMapper.selectMainList2*/
        <include refid="include.pageSelct" />
            WITH BASE AS (
                            SELECT B.CMT_YR,
                                   B.CMT_DVSN_CD ,
                                   B.CMT_SQ ,
                                   B.CMT_SBJ_SNO ,
                                   B.CMT_SBJ_NM ,
                                   B.IF_WAY_DVSN ,
                                   F_CODE_NM('1000848',B.IF_WAY_DVSN ) AS IF_WAY_DVSN_NM ,
                                   B.SR_DVSN ,
                                   MAX(B.IF_MSG) AS IF_MSG ,
                                   TO_CHAR(MIN(B.IF_STR_DH), 'YYYY-MM-DD HH24:MI:SS') AS IF_STR_DH ,
                                   TO_CHAR(MAX(B.IF_END_DH), 'YYYY-MM-DD HH24:MI:SS') AS IF_END_DH ,
                                   B.CMT_SBJ_DVSN_CD,
                                   B.CMT_IF_SEQ,
                                   B.TRNM_SQ
                              FROM (SELECT A.CMT_YR ,
                                           A.CMT_DVSN_CD ,
                                           A.CMT_SQ ,
                                           A.CMT_SBJ_SNO ,
                                           A.CMT_SBJ_NM ,
                                           A.IF_WAY_DVSN ,
                                           A.SR_DVSN ,
                                           A.CMT_SBJ_DVSN_CD ,
                                           DECODE(A.IF_MSG, 'Success', 1,null,3,'',3 ,2) AS IF_MSG ,
                                           A.IF_STR_DH ,
                                           A.IF_END_DH ,
                                           A.CMT_IF_SEQ,
                                           A.TRNM_SQ,
                                           1 AS SR_CNT,
                                           MAX(A.TRNM_SQ) OVER (PARTITION BY A.CMT_YR,A.CMT_DVSN_CD,A.CMT_SQ,A.CMT_SBJ_SNO,
                                                                             A.SR_DVSN,
                                                                             A.CMT_SBJ_DVSN_CD,A.CMT_IF_SEQ
                                                               ) AS MAX_TRNM_SQ
                                      FROM EA_INF_CMT_SBJ_INFO A
                                     WHERE A.SR_DVSN      = '수신'
                                       AND A.CMT_YR       = #{cmtYr}
                                       AND A.CMT_DVSN_CD  = #{cmtDvsnCd}
                                       AND A.CMT_SQ       = #{cmtSq}
                                       AND A.CMT_IF_SEQ   = #{cmtIfSeq}
                                     ORDER BY A.TRNM_SQ DESC) B
                             WHERE B.TRNM_SQ = B.MAX_TRNM_SQ
                             GROUP BY B.CMT_YR ,
                                   B.CMT_DVSN_CD ,
                                   B.CMT_SBJ_DVSN_CD ,
                                   B.CMT_SQ ,
                                   B.CMT_SBJ_SNO ,
                                   B.CMT_SBJ_NM ,
                                   B.IF_WAY_DVSN ,
                                   B.SR_DVSN,
                                   B.CMT_IF_SEQ,
                                   B.TRNM_SQ
                             ORDER BY B.TRNM_SQ,IF_STR_DH DESC
            ),  MAX_TB_CNT AS (  SELECT SUM(B.SR_CNT) AS SR_CNT, B.CMT_SBJ_SNO 
                                  FROM(
                                       SELECT ST1.CMT_YR ,
                                              F_CODE_NM('1000789',ST1.CMT_DVSN_CD) AS CMT_DVSN_NM ,
                                              ST1.CMT_DVSN_CD ,
                                              ST1.CMT_SQ ,
                                                    ST1.CMT_IF_SEQ ,
                                        ST1.CMT_SBJ_SNO ,
                                              ST1.CMT_SBJ_NM ,
                                              ST1.IF_WAY_DVSN ,
                                              ST1.SR_DVSN ,
                                              ST1.CMT_SBJ_DVSN_CD ,
                                              DECODE(ST1.IF_MSG, 'Success', 3,null,3,'',1 ,2) AS IF_MSG ,
                                              ST1.IF_STR_DH ,
                                              1 AS SR_CNT ,
                                              ST1.IF_END_DH ,
                                              ST1.TRNM_SQ,
                                              MAX(ST1.TRNM_SQ) OVER (PARTITION BY ST1.CMT_YR,ST1.CMT_DVSN_CD,ST1.CMT_SQ,ST1.CMT_SBJ_SNO,
                                                                             ST1.SR_DVSN,ST1.TBL_NM,
                                                                             ST1.CMT_SBJ_DVSN_CD,ST1.CMT_IF_SEQ
                                                                             ) AS MAX_TRNM_SQ
                                         FROM EA_INF_CMT_SBJ_INFO ST1, BASE C
                                        WHERE ST1.SR_DVSN       = C.SR_DVSN
                                          AND ST1.CMT_YR        = C.CMT_YR
                                          AND ST1.CMT_DVSN_CD   = C.CMT_DVSN_CD
                                          AND ST1.CMT_SQ        = C.CMT_SQ
                                          AND ST1.CMT_IF_SEQ    = C.CMT_IF_SEQ
                                          AND ST1.CMT_SBJ_SNO   = C.CMT_SBJ_SNO
                                       ) B
                                  WHERE B.TRNM_SQ = B.MAX_TRNM_SQ
                                  group by b.CMT_YR,b.CMT_DVSN_CD,b.CMT_SQ,b.CMT_IF_SEQ,b.CMT_SBJ_SNO,b.IF_WAY_DVSN,b.SR_DVSN
            ), MAX_FL_CNT AS (
                                SELECT SUM(B.CNT) AS CNT,B.CMT_SBJ_SNO 
                                  FROM (
                                        SELECT 
                                               ST1.TRNM_SQ,ST1.CMT_SBJ_SNO, 1 AS CNT, MAX(ST1.TRNM_SQ) OVER (PARTITION BY ST1.DOC_ID,ST1.CMT_YR,ST1.CMT_SQ,ST1.CMT_DVSN_CD) AS MAX_TRNM_SQ
                                          FROM EA_INF_ECM_FILE ST1, BASE C
                                         WHERE ST1.SR_DVSN       = C.SR_DVSN
                                           AND ST1.CMT_YR        = C.CMT_YR
                                           AND ST1.CMT_DVSN_CD   = C.CMT_DVSN_CD
                                           AND ST1.CMT_SQ        = C.CMT_SQ
                                           AND ST1.CMT_IF_SEQ    = C.CMT_IF_SEQ
                                           AND ST1.CMT_SBJ_SNO   = C.CMT_SBJ_SNO
                                        ) B
                                  WHERE B.TRNM_SQ = B.MAX_TRNM_SQ
                                  group by B.CMT_SBJ_SNO
           )                 
           SELECT A.CMT_YR,
                  A.CMT_DVSN_CD ,
                  A.CMT_SQ ,
                  A.CMT_SBJ_SNO ,
                  A.CMT_SBJ_NM ,
                  A.IF_WAY_DVSN ,
                  A.IF_WAY_DVSN_NM ,
                  A.SR_DVSN ,
                  A.IF_MSG ,
                  A.IF_STR_DH ,
                  A.IF_END_DH ,
                  A.CMT_SBJ_DVSN_CD,
                  A.CMT_IF_SEQ,
                  A.TRNM_SQ,
                  (
                    SELECT SUM(B.SR_CNT) AS SR_CNT
                      FROM MAX_TB_CNT B
                     WHERE B.CMT_SBJ_SNO = A.CMT_SBJ_SNO
                  ) AS TBL_CNT,
                   (SELECT C.CNT
                     FROM  MAX_FL_CNT C
                     WHERE C.CMT_SBJ_SNO = A.CMT_SBJ_SNO
                  ) AS FILE_CNT
            FROM BASE A
           ORDER BY A.CMT_SBJ_SNO ASC,A.TRNM_SQ,IF_STR_DH DESC
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectMainList3" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.cfr.dao.AEPCFR010QMapper.selectMainList3*/
        <include refid="include.pageSelct" />
            SELECT  A.CMT_YR
                   ,F_CODE_NM('1000789',A.CMT_DVSN_CD) AS CMT_DVSN_NM
                   ,A.CMT_DVSN_CD
                   ,A.CMT_SQ
                   ,A.IF_SEQ
                   ,A.CMT_SBJ_SNO
                   ,A.DOC_ID
                   ,A.FILE_NM
                   ,A.FILE_SIZE
                   ,A.SR_DVSN
                   ,A.IF_MSG
                   ,A.IF_WAY_DVSN
                   ,TO_CHAR(A.IF_STR_DH, 'YYYY-MM-DD HH24:MI:SS') AS IF_STR_DH
                   ,TO_CHAR(A.IF_END_DH, 'YYYY-MM-DD HH24:MI:SS') AS IF_END_DH
                   ,A.FRT_USR_ID
                   ,A.FNL_USR_ID
                   ,A.FRT_REGI_DH
                   ,A.FNL_MDF_DH
                   ,B.CMT_SBJ_NM
                   ,B.CMT_SBJ_DVSN_CD
              FROM EA_INF_ECM_FILE A 
                                     INNER JOIN EA_INF_CMT_SBJ_INFO B 
                                            ON (A.CMT_YR = B.CMT_YR AND A.CMT_SQ = B.CMT_SQ AND A.CMT_DVSN_CD = B.CMT_DVSN_CD AND A.CMT_SBJ_SNO = B.CMT_SBJ_SNO)
            WHERE A.SR_DVSN = '수신'
              AND A.SR_DVSN = B.SR_DVSN
              AND A.CMT_SBJ_SNO = #{cmtSbjSno}
            <if test='ifWayDvsn != null and ifWayDvsn != ""'>
            </if>
            <if test='tblNm != null and tblNm != ""'>
              
            </if>
            <if test='cmtYr != null and cmtYr != ""'>
              AND A.CMT_YR = #{cmtYr}
            </if>
            <if test='cmtDvsnCd != null and cmtDvsnCd != ""'>
              AND A.CMT_DVSN_CD = #{cmtDvsnCd}
            </if>
            
            <if test='cmtSq != null and cmtSq != ""'>
              AND A.CMT_SQ = #{cmtSq}
            </if>
            
            ORDER BY A.IF_STR_DH DESC
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectYearComboList" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.cfr.dao.AEPCFR010QMapper.selectYearComboList*/
            SELECT  DISTINCT A.CMT_YR
              FROM EA_INF_SBCN_INFO A LEFT JOIN TBBADDED120M B 
                                             ON (A.CMT_DY = B.CMT_DY AND A.CMT_DVSN_CD = B.CMT_DVSN_CD AND A.CMT_SQ = B.CMT_SQ)
             WHERE A.SR_DVSN = '수신'
             ORDER BY A.CMT_YR ASC  
    </select>
    
</mapper> 