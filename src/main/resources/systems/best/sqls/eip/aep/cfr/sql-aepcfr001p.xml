<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.cfr.dao.AEPCFR001PMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cfr.dao.AEPCFR001PMapper.selectMainList*/
        <include refid="include.pageSelct" />
            SELECT D.AUD_SBJ_NM||'('||F_MNG_KND_AUDYRNO(D.AUD_YR, D.AUD_NO, D.AUD_KND_CD, '-')||')' AS TITLE,
                   A.SBCN_PAGE_CNT                                  AS SBCN_PAGE_CNT,
                   COUNT(A.SBCN_PAGE_CNT)||'건'                      AS DTL_CNT,
                   F_DPT_INFO(D.MNG_DPT_CD,'1')                     AS MNG_DPT_NM,
                   ''                                               AS ADD_YN_NM,
                   'N'                                              AS ADD_YN,
                   ''                                               AS CMT_DY,
                   ''                                               AS CMT_DVSN_CD,
                   ''                                               AS CMT_SQ,
                   ''                           	                    AS CMT_SBJ_DVSN_CD,
                   ''                                               AS CMT_SBJ_SNO,
                   COUNT(A.SBCN_VT_CD)||'/'||COUNT(A.SBCN_PAGE_CNT) AS CNT,
                   COUNT(A.SBCN_VT_CD)                              AS N_CNT,
                   COUNT(A.SBCN_PAGE_CNT)                           AS T_CNT,
                   D.AUD_YR                                         AS AUD_YR,
                   D.AUD_NO                                         AS AUD_NO,
                   ''                                               AS CMT_SBJ_DVSN_CD,
                   '' 	                                            AS CMT_SBJ_SNO
              FROM TBBADDED113M AS A
        INNER JOIN TBBADDED145M AS D1 ON A.AUD_YR  = D1.AUD_YR
                                     AND A.AUD_NO  = D1.AUD_NO
                                     AND A.APVR_CD = D1.APVR_CD
                                     AND A.AFF_SNO = D1.AFF_SNO
        INNER JOIN TBBADDED146M AS D3 ON A.AUD_YR  = D3.AUD_YR
                                     AND A.AUD_NO  = D3.AUD_NO
                                     AND A.APVR_CD = D3.APVR_CD
                                     AND A.AFF_SNO = D3.AFF_SNO
        INNER JOIN TBBADDED001M AS D ON A.AUD_YR   = D.AUD_YR AND A.AUD_NO = D.AUD_NO
             WHERE A.SBCN_DY	 = REPLACE(#{cmtDy},'-')
               AND A.SBCN_DY IS NOT NULL
          GROUP BY D.AUD_YR, D.AUD_NO, D.AUD_KND_CD, D.AUD_GRN_NO, D.AUD_SBJ_NM, D.MNG_DPT_CD, A.SBCN_PAGE_CNT
         UNION ALL
            SELECT A.CMT_SBJ_TIT                    AS TITLE,
                   MAX(A.SBCN_SNO)                  AS SBCN_PAGE_CNT,
                   COUNT(B.CMT_SBJ_DTL_SNO)||'건'    AS DTL_CNT,
                   F_DPT_INFO(A.REL_DPT_CD,'1')     AS MNG_DPT_NM,
                   '안건추가'                          AS ADD_YN_NM,
                   'Y'                              AS ADD_YN,
                   A.CMT_DY                         AS CMT_DY,
                   A.CMT_DVSN_CD                    AS CMT_DVSN_CD,
                   TO_CHAR(A.CMT_SQ)                AS CMT_SQ,
                   A.CMT_SBJ_DVSN_CD                AS CMT_SBJ_DVSN_CD,
                   TO_CHAR(A.CMT_SBJ_SNO)           AS CMT_SBJ_SNO,
                   COUNT(B.CMT_SBJ_DTL_SNO)||'/'||1 AS CNT,
                   COUNT(B.CMT_SBJ_DTL_SNO)         AS N_CNT,
                   1                                AS T_CNT,
                   ''                               AS AUD_YR,
                   ''                               AS AUD_NO,
                   A.CMT_SBJ_DVSN_CD                AS CMT_SBJ_DVSN_CD,
                   TO_CHAR(A.CMT_SBJ_SNO)           AS CMT_SBJ_SNO
              FROM TBBADDED121M AS A
   LEFT OUTER JOIN TBBADDED122M AS B ON A.CMT_DY = B.CMT_DY
                                    AND A.CMT_DVSN_CD = B.CMT_DVSN_CD
                                    AND A.CMT_SQ = B.CMT_SQ
                                    AND A.CMT_SBJ_DVSN_CD = B.CMT_SBJ_DVSN_CD
                                    AND A.CMT_SBJ_SNO = B.CMT_SBJ_SNO
             WHERE A.CMT_DY = REPLACE(#{cmtDy},'-')
               AND A.CMT_DVSN_CD = #{cmtDvsnCd}
               AND A.CMT_SQ = #{cmtSq}
          GROUP BY A.CMT_DY, A.CMT_DVSN_CD, A.CMT_SQ, A.CMT_SBJ_DVSN_CD, A.CMT_SBJ_SNO, A.CMT_SBJ_TIT, A.REL_DPT_CD
        <include refid="include.pageOrder" />
    </select>
    
    
    <select id="selectSubByAddNList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cfr.dao.AEPCFR001PMapper.selectSubByAddNList*/
        <include refid="include.pageSelct" />
            SELECT D2.AUD_YR||'-'||D2.AUD_KND_CD||'-'||D2.AUD_GRN_NO||'-'||D1.AFF_CD||'-'||D.AFF_DSP_CD AS AUD_KND_GRN_AFF_DSP_SNO,
                   D1.TITLE_NM,
                   CASE WHEN D3.RLTN_ORG_CD IS NOT NULL THEN F_ORG_INFO(D3.RLTN_ORG_CD,'1') ELSE '' END COPT_OFI_NM,
                   F_CODE_NM('1000002',D.DSP_RQ_CD ) AS DSP_RQ_NM,
                   CASE D.SBCN_VT_CD WHEN '90' THEN '보류' ELSE F_CODE_NM('1000772',D.SBCN_VT_CD) END AS SBCN_VT_NM,
                   SBCN_VT_TXT,
                   D.AUD_YR,
                   D.AUD_NO,
                   D.DOC_ID,
                   D.APVR_CD,
                   D.AFF_SNO,
                   D.DSP_RQ_SNO,
                   D.SBCN_DY
              FROM TBBADDED113M AS D
        INNER JOIN TBBADDED145M AS D1 ON D.AUD_YR = D1.AUD_YR
                                     AND D.AUD_NO = D1.AUD_NO
                                     AND D.APVR_CD = D1.APVR_CD
                                     AND D.AFF_SNO = D1.AFF_SNO
        INNER JOIN TBBADDED146M AS D3 ON D.AUD_YR = D3.AUD_YR
                                     AND D.AUD_NO = D3.AUD_NO
                                     AND D.APVR_CD = D3.APVR_CD
                                     AND D.AFF_SNO = D3.AFF_SNO
                                     AND D.DSP_RQ_SNO = D3.DSP_RQ_SNO
        INNER JOIN TBBADDED001M AS D2 ON D.AUD_YR = D2.AUD_YR
                                     AND D.AUD_NO = D2.AUD_NO
             WHERE D.AUD_YR           =  #{audYr}
               AND D.AUD_NO           =  #{audNo}
               AND D.SBCN_DY = REPLACE(#{cmtDy},'-')
          ORDER BY D.AFF_SNO
        <include refid="include.pageOrder" />
    </select>
    
    
    <select id="selectSubByAddYList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cfr.dao.AEPCFR001PMapper.selectSubByAddYList*/
        <include refid="include.pageSelct" />
            SELECT CMT_SBJ_DTL_TIT,
                   NVL(DOC_ID,'-') AS DOC_ID,
                   CMT_SBJ_DTL_SNO,
                   CASE SBCN_VT_CD WHEN '10' THEN '의결'
                                   WHEN '20' THEN '부결'
                                   ELSE '' END AS SBCN_VT_NM,
                   SBCN_VT_TXT,
                   CMT_DY,
                   CMT_DVSN_CD,
                   CMT_SQ,
                   CMT_SBJ_DVSN_CD,
                   CMT_SBJ_SNO,
                   FILE_NM
              FROM TBBADDED122M
             WHERE CMT_DY = REPLACE(#{cmtDy},'-')
               AND CMT_DVSN_CD = #{cmtDvsnCd}
               AND CMT_SQ = #{cmtSq}
               AND CMT_SBJ_DVSN_CD = #{cmtSbjDvsnCd}
               AND CMT_SBJ_SNO = #{cmtSbjSno}
        <include refid="include.pageOrder" />
    </select>
    
    <update id="updateBADDED120M" parameterType="paramMap">
    /*kr.go.bai.eip.aep.cfr.dao.AEPCFR001PMapper.updateBADDED120M*/
        UPDATE TBBADDED120M SET CMT_END_YN = 'Y',
                                CMT_END_DH = SYSDATE,
                                FNL_USR_ID = #{usrId},
                                FNL_DEAL_DPT_CD = #{dptCd},
                                FNL_MNU_ID = #{menuNo},
                                FNL_MDF_DH = SYSDATE
                          WHERE CMT_DY = REPLACE(#{cmtDy},'-')
                            AND CMT_DVSN_CD = #{cmtDvsnCd}
                            AND CMT_SQ = #{cmtSq}
    </update>
    
</mapper>