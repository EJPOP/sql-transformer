<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectMainList*/
        <include refid="include.pageSelct" />
	<![CDATA[
   SELECT A.GRN_SRNO
        , A.RECEV_DY
        , A.RECEV_DY || '-소명-' || A.GRN_SRNO AS MFEX_NO																/*소명자료 관리번호*/
        , A.SRNO
        , ( SELECT COUNT(T4.AFF_SNO)
             FROM TBCSPKDE106M T4
            WHERE T4.AUD_YR = A.AUD_YR
              AND T4.AUD_NO = A.AUD_NO
              AND T4.SRNO = A.SRNO ) AS affCount																	/*개별사건 연결 개수*/
        , (CASE WHEN A.IMMUN_REQ_YN = 'Y' THEN A.RECEV_DY || '-면책-' || A.IMMUN_SRNO ELSE '' END ) AS IMMUN_NO		/*적극행정면책관리번호*/
        , TO_CHAR(TO_DATE(A.SMT_DT),'YYYY-MM-DD') AS SMT_DT															/*제출일자*/
        , A.SMT_ORG_NM AS RLTN_ORG_NM																				/*제출기관*/
        , A.PRSR AS PRSR																							/*제출자*/
        , ( SELECT COUNT(1)
             FROM TBCSPKDE104M
            WHERE AUD_YR = A.AUD_YR
              AND AUD_NO = A.AUD_NO
              AND SRNO = A.SRNO) AS FILE_CNT																		/*자료개수*/
        , DECODE(A.PRCT_SPV_DPT_RCV_YN, 'Y', A.RECEV_DY || '-권익-' || A.PRCT_SPV_RCV_SRNO, '') AS PRCT_NO			/*접수번호*/
        , DECODE(A.PRCT_SPV_DPT_RCV_YN, 'Y', '접수', DECODE(A.PRCT_SPV_DPT_OM_YN, 'Y', '발신'), '') AS PRCT_STA_NM		/*상태*/
        , DECODE(A.PRCT_SPV_DPT_OM_YN, 'Y', TO_CHAR(A.PRCT_SPV_DPT_OM_DT, 'YYYY-MM-DD'), '') AS PRCT_OM_DT			/*발신일자*/
        , DECODE(A.PRCT_SPV_DPT_RCV_YN, 'Y', TO_CHAR(A.PRCT_SPV_DPT_RCV_DT, 'YYYY-MM-DD'), '') AS PRCT_ACP_DT		/*접수일자*/
        , B.AUD_SBJ_NM AS AUD_SBJ_NM																				/*감사사항명*/
        , F_DPT_INFO (B.SPV_BRDV_CD, '1') AS DPT_NM																	/*주관부서*/
        , SUM( ( SELECT COUNT(T4.DOC_ID)
                  FROM TBCSPKDE104M T4
                 WHERE T4.AUD_YR = A.AUD_YR
                   AND T4.AUD_NO = A.AUD_NO
                   AND T4.SRNO = A.SRNO) )																			/*관련소명자료개수*/
		 , (SELECT
		 		COUNT(T7.DOC_ID)
		 	FROM
			TBBADDED111M T7 
			WHERE T7.AUD_YR = A.AUD_YR
			AND T7.AUD_NO = A.AUD_NO
			AND T7.RPRT_CD = 'A10601000'
			AND (T7.REF_ID = TO_CHAR(A.SRNO) OR T7.REF_ID IN (SELECT NVL(AFF_SNO, 0)
																 FROM  TBCSPKDE106M
			                                                     WHERE AUD_YR = A.AUD_YR
			                                                     AND AUD_NO = A.AUD_NO
			                                                     AND SRNO = A.SRNO))
			)
       || '/' || 
		   (SELECT
		 		COUNT(T7.DOC_ID)
		 	FROM
			TBBADDED103M T7 
			WHERE T7.AUD_YR = A.AUD_YR
			AND T7.AUD_NO = A.AUD_NO
			AND T7.RPRT_CD = 'A10601000'
			AND (T7.REF_ID = TO_CHAR(A.SRNO) OR T7.REF_ID IN (SELECT NVL(AFF_SNO, 0)
																 FROM  TBCSPKDE106M
			                                                     WHERE AUD_YR = A.AUD_YR
			                                                     AND AUD_NO = A.AUD_NO
			                                                     AND SRNO = A.SRNO))
			)
			 AS OPT_RPRT_RCV_CNT																					/*검토 의견서 발신/작성건수*/
        , SUM(DECODE(A.PRCT_SPV_DPT_RCV_YN, 'Y', 1, 0) ) || '/' || SUM(DECODE(A.PRCT_SPV_DPT_OM_YN, 'Y', 1, 0) ) AS SND_RCV_CNT		/*(권익보호관 소명자료 접수/발신건수)*/
        , SUM(DECODE(A.PRCT_SPV_DPT_RCV_YN, 'Y', 0, 1) ) AS PRCT_SPV_DPT_NOT_RCV_CNT
        , SUM(DECODE(A.PRCT_SPV_DPT_OM_YN, 'Y', 1, 0) ) AS PRCT_SPV_DPT_OM_YN
        , CASE WHEN A.CLSNG_YN = 'F' THEN '종결'
                      WHEN A.CLSNG_YN = 'Y' THEN DECODE(A.CLSNG_YN, 'Y', '마감'||'('||TO_CHAR(A.CLSNG_DT, 'YYYY-MM-DD')||')', '진행중')
                      ELSE '진행중'
                 END AS CLSNG_NM
        , A.CLSNG_YN
        , A.AUD_YR
        , A.AUD_NO
        , DECODE(A.PRCT_SPV_DPT_RCV_YN, 'Y', 'Y','N') AS MFEX_OPIN_WRT_YN
--        , (SELECT DECODE(COUNT(1), 0, 'Y', 'N')
--             FROM TBBADDED103M T1
--             WHERE T1.AUD_YR = B.AUD_YR
--               AND T1.AUD_NO = B.AUD_NO
--                               AND T1.REF_ID = TO_CHAR(T4.AFF_SNO)
--              AND T1.RPRT_CD = 'A10601000' ) AS MFEX_OPIN_WRT_YN
        , F_CODE_NM('1000894', B.DOC_WRIT_KND_CD) DOC_TYPE
   FROM TBCSPKDE103M A INNER JOIN TBBADDED001M B ON A.AUD_YR = B.AUD_YR
    AND A.AUD_NO = B.AUD_NO
    AND A.PRCT_SPV_DPT_OM_YN = 'Y'
  WHERE 1=1
	]]>
	<if test="schAudYr != null and schAudYr != ''">
	AND A.AUD_YR = #{schAudYr}
	</if>
	<if test="schAudYrNoKndCd != null and schAudYrNoKndCd != ''">
	AND B.AUD_KND_CD = #{schAudYrNoKndCd}
	</if>
	<if test="schAudGrnNo != null and schAudGrnNo != ''">
	AND B.AUD_GRN_NO = #{schAudGrnNo}
	</if>
	<if test="schAudSbjNm != null and schAudSbjNm != ''">
	AND B.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
	</if>
	<if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
	AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = B.MNG_DPT_CD) = #{schSpvBrdvCd}
	</if>
	<if test="schDeptCd != null and schDeptCd != ''">
	AND B.MNG_DPT_CD = #{schDeptCd}
	</if>
	<if test="schAudGrnNo2 != null and schAudGrnNo2 != ''">
	AND B.AUD_GRN_NO = #{schAudGrnNo2} /* 사건, 처분 테이블 */
	</if>
	<if test="docWrtYn != null and docWrtYn != '' and docWrtYn eq 'Y'.toString()">
	AND (SELECT COUNT(T7.DOC_ID) 
		   FROM TBBADDED103M T7 
		   WHERE T7.AUD_YR = A.AUD_YR
			 AND T7.AUD_NO = A.AUD_NO 
			 AND T7.RPRT_CD = 'A10601000'
			 AND T7.REF_ID = TO_CHAR(A.AFF_SNO) ) <![CDATA[>]]> 0
	</if>
	<if test="docWrtYn != null and docWrtYn != '' and docWrtYn eq 'N'.toString()">
	AND (SELECT COUNT(T7.DOC_ID) 
		   FROM TBBADDED103M T7 
		   WHERE T7.AUD_YR = A.AUD_YR
			 AND T7.AUD_NO = A.AUD_NO 
			 AND T7.RPRT_CD = 'A10601000'
			 AND T7.REF_ID = TO_CHAR(A.AFF_SNO) ) = 0
	</if>
	<if test="docSndYn != null and docSndYn != '' and docSndYn eq 'Y'.toString()">
	AND (SELECT COUNT(T7.DOC_ID) 
		   FROM TBBADDED103M T7 
	 INNER JOIN TBBADDED111M T8
			 ON T7.AUD_YR = T8.AUD_YR
			AND T7.AUD_NO = T8.AUD_NO
			AND T7.RPRT_CD = T8.RPRT_CD
			AND T7.DOC_ID = T8.DOC_ID
				AND T7.RPRT_CD  = 'A10601000'   
				AND T8.RCPT_DPT_CD IN ('160200','180130', '151100')
	WHERE T7.AUD_YR = A.AUD_YR
	  AND T7.AUD_NO = A.AUD_NO             
	  AND T7.REF_ID = TO_CHAR(A.AFF_SNO) ) <![CDATA[>]]> 0
	</if>
	<if test="docSndYn != null and docSndYn != '' and docSndYn eq 'N'.toString()">
	AND (SELECT COUNT(T7.DOC_ID) 
		   FROM TBBADDED103M T7 
	 INNER JOIN TBBADDED111M T8
			 ON T7.AUD_YR = T8.AUD_YR
			AND T7.AUD_NO = T8.AUD_NO
			AND T7.RPRT_CD = T8.RPRT_CD
			AND T7.DOC_ID = T8.DOC_ID
			AND T7.RPRT_CD  = 'A10601000'   
			AND T8.RCPT_DPT_CD IN ('160200','180130', '151100')
	 WHERE T7.AUD_YR = A.AUD_YR
	   AND T7.AUD_NO = A.AUD_NO             
	   AND T7.REF_ID = TO_CHAR(A.AFF_SNO) ) = 0
	</if>
	<if test="schClsngYn != null and schClsngYn != ''">
	AND A.CLSNG_YN = #{schClsngYn}
	</if>
	<if test="recevDy != null and recevDy != ''">
	AND A.RECEV_DY = #{recevDy}
	</if>
	<if test="audNo != null and audNo != ''">
	AND A.AUD_NO = #{audNo}
	</if>
	<if test="srno != null and srno != ''">
	AND A.SRNO = #{srno}
	</if>
	<if test="grnSrno != null and grnSrno != ''">
	AND A.GRN_SRNO = #{grnSrno}
	</if>
  GROUP BY A.GRN_SRNO
         , A.RECEV_DY
         , A.IMMUN_REQ_YN
         , A.IMMUN_SRNO
         , A.SMT_DT
         , A.SMT_ORG_NM
         , A.PRSR
         , A.AUD_YR
         , A.AUD_NO
         , A.SRNO
         , A.PRCT_SPV_DPT_RCV_YN
         , A.PRCT_SPV_RCV_SRNO
         , A.PRCT_SPV_DPT_OM_YN
         , A.PRCT_SPV_DPT_OM_DT
         , A.PRCT_SPV_DPT_RCV_DT
         , B.AUD_SBJ_NM
         , B.SPV_BRDV_CD
         , A.CLSNG_YN
         , A.CLSNG_DT
         , B.AUD_YR
         , B.AUD_NO
         , B.DOC_WRIT_KND_CD
  ORDER BY A.SMT_DT DESC
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectMfexList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectMfexList*/
        <![CDATA[
            SELECT T1.RECEV_DY || '-소명-' || T1.GRN_SRNO AS MFEX_NO
                  ,TO_CHAR(TO_DATE(T1.SMT_DT), 'YYYY-MM-DD') AS SMT_DT
                  ,T1.SMT_ORG_NM AS RLTN_ORG_NM
                  ,T1.PRSR
                  ,(SELECT COUNT(1) FROM TBCSPKDE104M WHERE AUD_YR = T1.AUD_YR AND AUD_NO = T1.AUD_NO AND SRNO = T1.SRNO) AS FILE_CNT
                  ,DECODE(T1.PRCT_SPV_DPT_RCV_YN, 'Y', T1.RECEV_DY || '-권익-' || T1.PRCT_SPV_RCV_SRNO, '') AS PRCT_NO
                  ,DECODE(T1.PRCT_SPV_DPT_RCV_YN, 'Y', '접수', DECODE(T1.PRCT_SPV_DPT_OM_YN, 'Y', '발신'), '') AS PRCT_STA_NM
                  ,DECODE(T1.PRCT_SPV_DPT_OM_YN, 'Y', TO_CHAR(T1.PRCT_SPV_DPT_OM_DT, 'YYYY-MM-DD'), '') AS PRCT_OM_DT
                  ,DECODE(T1.PRCT_SPV_DPT_RCV_YN, 'Y', TO_CHAR(T1.PRCT_SPV_DPT_RCV_DT, 'YYYY-MM-DD'), '') AS PRCT_ACP_DT
                  ,(SELECT MAX(RPRT_NM) 
                      FROM TBBADDED103M 
                     WHERE AUD_YR = T1.AUD_YR 
                       AND AUD_NO = T1.AUD_NO 
                       AND RPRT_CD = 'A10600900'
                       AND REF_ID = T2.RPRT_LINK_SEQ
                       AND REF_DY = T2.AFF_SNO) AS RPRT_NM
                  ,T1.AUD_YR
                  ,T1.AUD_NO
                  ,T1.SRNO
                  ,T1.PRCT_SPV_DPT_RCV_YN
                  ,T1.RECEV_DY
                  ,T1.GRN_SRNO
                  ,(CASE WHEN T1.IMMUN_REQ_YN ='Y' THEN T1.RECEV_DY || '-면책-' || T1.IMMUN_SRNO ELSE '' END) AS IMMUN_NO
              FROM TBCSPKDE103M T1
             INNER JOIN TBCSPKDE106M T2 ON
                        T2.AUD_YR = T1.AUD_YR
                    AND T2.AUD_NO = T1.AUD_NO
                    AND T2.SRNO = T1.SRNO
                    AND T2.AUD_YR = #{audYr}
                    AND T2.AUD_NO = #{audNo}
                    AND T1.PRCT_SPV_DPT_OM_YN = 'Y'
        ]]>
    </select>
    
    <select id="selectMfexEviDocList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectMfexEviDocList*/
        <![CDATA[
            SELECT F_CODE_NM('1000776', T3.EVI_DCM_DVSN_CD) AS EVI_DCM_DVSN_NM
                  ,T3.FILE_NM
                  ,DECODE(T4.EVI_OPEN_STAT_YN, 'Y', '열람', 'N', '열람취소', '') AS EVI_OPEN_STAT_YN
                  ,TO_CHAR(T4.EVI_OPEN_STAT_DT, 'YYYY-MM-DD') AS EVI_OPEN_STAT_DT
                  ,T3.FILE_NM AS V_FILE_NM
                  ,T3.AUD_DCM_DOC_ID AS DOC_ID
                  ,'' AS RPRT_CD
              FROM TBBADDED110M T1
             INNER JOIN TBBADDED145M T2 ON
                       T1.AUD_YR = T2.AUD_YR
                   AND T1.AUD_NO = T2.AUD_NO
                   AND T1.RPRT_FILD_ID = T2.RPRT_FILD_ID
                   AND T2.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
                                       FROM (
                                           SELECT RANK() OVER (PARTITION BY A.DOC_ID ORDER BY DECODE(A.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
                                                , A.APVR_CD
                                                , A.DOC_ID
                                             FROM TBBADDED145M A
                                            WHERE A.AUD_YR = #{audYr}
                                              AND A.AUD_NO  =  #{audNo}
                                              AND A.APVR_CD <> '0010200'
                                            GROUP BY A.DOC_ID, A.APVR_CD )   
                                      WHERE RN = 1
                                        AND T2.DOC_ID = DOC_ID )
                   AND T1.AUD_YR = #{audYr}
                   AND T1.AUD_NO = #{audNo}
             INNER JOIN TBBADDED108D T3 ON
                       T1.AUD_YR = T3.AUD_YR
                   AND T1.AUD_NO = T3.AUD_NO
                   AND T1.AUD_DCM_DOC_ID = T3.AUD_DCM_DOC_ID
             INNER JOIN TBCSPKDE107M T4 ON
                       T1.AUD_YR = T4.AUD_YR
                   AND T1.AUD_NO = T4.AUD_NO
                   AND T4.AFF_SNO = T2.AFF_SNO
                   AND T1.AUD_DCM_DOC_ID = T4.AUD_DCM_DOC_ID
                   AND T4.EVI_OPEN_STAT_YN = 'Y'
        ]]>
    </select>
    
    <select id="selectDocList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectDocList*/
        <![CDATA[
            SELECT G1.RPRT_NM
                  ,G1.APV_STA_CD
                  ,G1.APV_STA_NM
                  ,G1.DOC_ID
                  ,G1.APV_RQS_ID
                  ,MAX(G1.APV_INFO_1) AS APV_INFO_1
                  ,MAX(G1.APV_INFO_2) AS APV_INFO_2
                  ,MAX(G1.APV_INFO_3) AS APV_INFO_3
                  ,MAX(G1.APV_INFO_4) AS APV_INFO_4
                  ,MAX(G1.APV_INFO_5) AS APV_INFO_5
                  ,MAX(G1.APV_INFO_6) AS APV_INFO_6
                  ,MAX(G1.APV_INFO_7) AS APV_INFO_7
                  ,(
                    SELECT DECODE(COUNT(1), 2, 'E', 1, 'Y', 'N')
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND SUBSTR(T3.LINK_URL,-36) = G1.DOC_ID
    				   AND (T3.REF_ID = #{srno} OR T3.REF_ID IN (SELECT TO_CHAR(NVL(AFF_SNO,0))
			                                                     FROM TBCSPKDE106M
			                                                    WHERE AUD_YR = #{audYr}
			                                                      AND AUD_NO = #{audNo}
			                                                      AND SRNO = #{srno}))
                       AND T3.RCPT_DPT_CD IN ('510000', '160200','180130', '151100')
                   ) AS SEND_YN
                  ,G1.RPRT_CD
                  , (SELECT DECODE(COUNT(1), 0, 'N', 'Y') FROM TBDCMACM023H ST1 WHERE ST1.APV_DOC_NO = G1.APV_RQS_ID AND ST1.APVR_STA_CD NOT IN ('301', '201')) AS APV_HIS_YN
                  , G1.DOC_TYPE
              FROM (
                SELECT AUD_YR
                      ,AUD_NO
                      ,RPRT_CD
                      ,RPRT_NM
                      ,APV_STA_CD
                      ,APV_STA_NM
                      ,DOC_ID
                      ,APV_RQS_ID
                      ,DECODE(ROW_ID, 1, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_1
                      ,DECODE(ROW_ID, 2, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_2
                      ,DECODE(ROW_ID, 3, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_3
                      ,DECODE(ROW_ID, 4, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_4
                      ,DECODE(ROW_ID, 5, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_5
                      ,DECODE(ROW_ID, 6, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_6
                      ,DECODE(ROW_ID, 7, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_7
                      ,DOC_TYPE
                  FROM (
                    SELECT AUD_YR
                          ,AUD_NO
                          ,RPRT_CD
                          ,RPRT_NM
                          ,APV_STA_CD
                          ,APV_STA_NM
                          ,DOC_ID
                          ,APV_RQS_ID
                          ,PST_NM
                          ,APVR_NM
                          ,APV_DH
                          ,DOC_TYPE
                          ,ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SNO) AS ROW_ID 
                      FROM (
                        SELECT T1.AUD_YR
                              ,T1.AUD_NO
                              ,T1.RPRT_CD
                              ,T1.RPRT_NM
                              ,T1.APV_STA_CD
                              ,F_CODE_NM('1000773',APV_STA_CD) AS APV_STA_NM
                              ,T1.DOC_ID
                              ,T2.APV_SNO
                              ,T1.APV_RQS_ID
                              ,CASE WHEN APVR_PST_CD IS NULL
                                    THEN (SELECT MAX(ONR_PST_NM) FROM TBDCMACM001M WHERE CNB = APVR_CNB)
                                    ELSE F_CODE_NM('1000176', T2.APVR_PST_CD)
                               END  AS PST_NM
                              ,F_USR_INFO(T2.APVR_CNB, '2') AS APVR_NM
                              ,CASE WHEN SUBSTR(T2.APVR_STA_CD,0,1) = '2' THEN TO_CHAR(T2.APV_DH, 'YYYY-MM-DD')
                                    ELSE ''
                               END  AS APV_DH
                              ,F_OPEN_EDIT(T1.LINK_URL) AS DOC_TYPE
                          FROM TBBADDED103M T1
                         LEFT OUTER JOIN TBDCMACM023L T2 ON
                                    T1.APV_RQS_ID = T2.APV_DOC_NO
                                AND T2.APV_SNO <> '1' --(기안자 제외)
                                AND T2.APVR_KND_CD <> '4' --(협조자 제외)
                         WHERE T1.AUD_YR = #{audYr}
                           AND T1.AUD_NO = #{audNo}
						   AND (T1.REF_ID = #{srno} OR T1.REF_ID IN (SELECT NVL(AFF_SNO,0) 
                                             							FROM TBCSPKDE106M
                                            						WHERE AUD_YR = #{audYr}
                                              						AND AUD_NO = #{audNo}
                                              						AND SRNO = #{srno}))
                           AND T1.RPRT_CD = 'A10601000' )
                        )
                    ) AS G1
            GROUP BY G1.AUD_YR
                    ,G1.AUD_NO
                    ,G1.RPRT_CD
                    ,G1.RPRT_NM
                    ,G1.APV_STA_CD
                    ,G1.APV_STA_NM
                    ,G1.DOC_ID
                    ,G1.APV_RQS_ID 
                    ,G1.DOC_TYPE
        ]]>
    </select>
    
    <select id="selectSndDocList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectSndDocList*/
        <![CDATA[
            SELECT RPRT_NM
                  ,DOC_ID
                  ,DECODE(SND_DH, NULL, '', '발신') AS CMPT_STA_NM
                  ,TO_CHAR(SND_DH, 'YYYY-MM-DD')   AS CMPT_SND_DT
                  ,DECODE(SND_DH, NULL, '', '발신') AS QLT_STA_NM
                  ,TO_CHAR(SND_DH, 'YYYY-MM-DD')   AS QLT_SND_DT
              FROM TBBADDED111M
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND RPRT_CD IN ( 'A10601000')
        ]]>
    </select>
    
    <select id="selectMfexOpinDocId" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectMfexOpinDocId*/
        <![CDATA[
            SELECT DOC_ID
              FROM TBFDMADM002M 
             WHERE AUD_DOC_CD = 'A10601000'
        ]]>
    </select>
    
    <insert id="insertSendDoc" parameterType="paramMap">
        /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.insertSendDoc*/
            MERGE INTO  TBBADDED111M T1
                 USING  (
                         SELECT *
                           FROM TBBADDED103M
                          WHERE AUD_YR = #{audYr}
                            AND AUD_NO = #{audNo}
                            AND RPRT_CD = #{rprtCd}
                            AND DOC_ID = #{docId}
                        ) T2
                    ON  (   T1.AUD_YR = #{audYr}
                        AND T1.AUD_NO = #{audNo}
                        AND T1.RPRT_CD = #{rprtCd}
                        AND T1.DOC_ID = #{docId}
                        )
                WHEN    MATCHED THEN
                    UPDATE
                    SET     T1.SND_DH           = SYSDATE
                           ,T1.RCPT_DH          = SYSDATE
                           ,T1.RCPT_DPT_CD      = '510000'
                           ,T1.FNL_USR_ID       = #{usrId}
	                       ,T1.FNL_DEAL_DPT_CD  = #{dptCd}
	                       ,T1.FNL_MNU_ID       = #{mnuId}
	                       ,T1.FNL_MDF_DH       = SYSDATE
                WHEN    NOT MATCHED THEN
                    INSERT  (
	                           AUD_YR
			                  ,AUD_NO
			                  ,AUD_STEP_CD
			                  ,DOC_ID
			                  ,SR_DOC_SNO
			                  ,AUD_KND_CD
			                  ,AUD_GRN_NO
			                  ,RPRT_NM
			                  ,RPRT_CD
			                  ,LINK_URL
			                  ,DOC_STA_CD
			                  ,SND_DPT_CD
			                  ,SNDR_ID
			                  ,SND_DH
			                  ,RCPT_DPT_CD
			                  ,RCNT_ID
			                  ,RCPT_DH
			                  ,AUD_RPRT_DVSN_CD
			                  ,DOC_KND_CD
			                  ,REF_ID
			                  ,REF_DY
			                  ,SORT_SNO
			                  ,FRT_USR_ID
			                  ,FNL_USR_ID
			                  ,FNL_DEAL_DPT_CD
			                  ,FNL_MNU_ID
			                  ,FRT_REGI_DH
			                  ,FNL_MDF_DH )
                      VALUES ( T2.AUD_YR
                              ,T2.AUD_NO
                              ,T2.AUD_STEP_CD
                              ,T2.DOC_ID
                              ,(
                                SELECT NVL(MAX(T3.SR_DOC_SNO), 0) + 1
                                  FROM TBBADDED111M T3
                                 WHERE T3.AUD_YR = T2.AUD_YR
                                   AND T3.AUD_NO = T2.AUD_NO
                                   AND T3.DOC_ID = T2.DOC_ID
                               )
                              ,T2.AUD_KND_CD
                              ,T2.AUD_GRN_NO
                              ,T2.RPRT_NM
                              ,T2.RPRT_CD
                              ,T2.LINK_URL
			                  ,'20'
			                  ,#{dptCd}
			                  ,#{usrId}
			                  ,SYSDATE
			                  ,'510000'
			                  ,''
			                  ,SYSDATE
                              ,T2.AUD_RPRT_DVSN_CD
                              ,T2.DOC_KND_CD
                              ,T2.REF_ID
                              ,T2.REF_DY
                              ,T2.SORT_SNO
			                  ,#{usrId}
			                  ,#{usrId}
			                  ,#{dptCd}
			                  ,#{mnuId}
			                  ,SYSDATE
			                  ,SYSDATE )
    </insert>
    
    <update id="insertSendDoc2" parameterType="paramMap">
        /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.insertSendDoc2*/
            INSERT INTO TBBADDED111M (
                   AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,SR_DOC_SNO
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM
                  ,RPRT_CD
                  ,LINK_URL
                  ,DOC_STA_CD
                  ,SND_DPT_CD
                  ,SNDR_ID
                  ,SND_DH
                  ,RCPT_DPT_CD
                  ,RCNT_ID
                  ,RCPT_DH
                  ,AUD_RPRT_DVSN_CD
                  ,DOC_KND_CD
                  ,REF_ID
                  ,REF_DY
                  ,SORT_SNO
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH )
           (SELECT AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,(
                    SELECT NVL(MAX(SR_DOC_SNO), 0) + 1
                      FROM TBBADDED111M T2
                     WHERE T2.AUD_YR = T1.AUD_YR
                       AND T2.AUD_NO = T1.AUD_NO
                       AND T2.DOC_ID = T1.DOC_ID
                   )
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM
                  ,RPRT_CD
                  ,LINK_URL
                  ,'20'
                  ,#{dptCd}
                  ,#{usrId}
                  ,SYSDATE
                  ,'180130'
                  ,''
                  ,SYSDATE
                  ,AUD_RPRT_DVSN_CD
                  ,DOC_KND_CD
                  ,REF_ID
                  ,REF_DY
                  ,SORT_SNO
                  ,#{usrId}
                  ,#{usrId}
                  ,#{dptCd}
                  ,#{mnuId}
                  ,SYSDATE
                  ,SYSDATE 
              FROM TBBADDED103M T1
             WHERE T1.AUD_YR = #{audYr}
               AND T1.AUD_NO = #{audNo}
               AND T1.DOC_ID = #{docId}
               AND T1.RPRT_CD = #{rprtCd}
             )
    </update>
    
    <update id="updateAcpMfex" parameterType="paramMap">
        /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.updateAcpMfex*/
        <![CDATA[
            UPDATE TBCSPKDE103M
               SET PRCT_SPV_DPT_RCV_YN = 'Y'
                  ,PRCT_SPV_DPT_RCV_DT = SYSDATE
                  ,PRCT_SPV_RCV_SRNO = (
                                        SELECT NVL(MAX(T1.PRCT_SPV_RCV_SRNO), 0) + 1 
                                          FROM TBCSPKDE103M T1
                                         WHERE RECEV_DY = #{recevDy}
                                       )
                  ,FNL_USR_ID       = #{usrId}
                  ,FNL_DEAL_DPT_CD  = #{dptCd}
                  ,FNL_MNU_ID       = #{mnuId}
                  ,FNL_MDF_DH       = SYSDATE
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND SRNO = #{srno}
        ]]>
    </update>
    
    <select id="selectMfexFileList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectMfexFileList*/
        <![CDATA[
            SELECT T1.AUD_YR
                  ,T1.AUD_NO
                  ,T1.SRNO
                  ,T2.DOC_ID
                  ,T2.FILE_NM
                  ,TO_CHAR(TO_DATE(T1.SMT_DT), 'YYYY-MM-DD') AS SMT_DT
                  ,T1.SMT_ORG_NM AS RLTN_ORG_NM
                  ,T1.PRSR
                  ,T1.RECEV_DY||'-소명-'||T1.GRN_SRNO AS YR_SRNO
                  ,F_USR_INFO_BY_ID(T2.FRT_USR_ID, '2') AS FRT_USR_NM
                  ,TO_CHAR(T2.FRT_REGI_DH, 'YYYY-MM-DD') AS FRT_REGI_DH
                  ,T2.FILE_NM AS V_FILE_NM
              FROM TBCSPKDE103M T1
             INNER JOIN TBCSPKDE104M T2 
                ON T1.AUD_YR = T2.AUD_YR
               AND T1.AUD_NO = T2.AUD_NO
               AND T1.SRNO = T2.SRNO
             WHERE T2.AUD_YR = #{audYr}
               AND T2.AUD_NO = #{audNo}
               AND T2.SRNO =  #{srno} 
               AND T2.DOC_KND_CD IS NULL 
          ]]>
    </select>
    
    <select id="selectRcptOmDoc" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectRcptOmDoc*/
        <![CDATA[
	          SELECT A.RPRT_NM
                  ,'수신' AS DOC_STA_NM
                  ,F_DPT_INFO(A.SND_DPT_CD, 1) AS OM_DPT_NM
                  ,TO_CHAR(A.SND_DH, 'YYYY-MM-DD') AS OM_DT
                  ,'' AS RCPT_DPT_NM
                  ,'' AS RCPT_DH
                  ,'N' AS SND_YN
                  ,A.RPRT_NM AS V_RPRT_NM
                  ,A.DOC_ID
                  ,A.RPRT_CD
                  ,F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
              FROM TBBADDED111M A
                     WHERE (A.RPRT_CD = 'A10700900' 
					  	AND A.RCPT_DPT_CD = '160000'
						AND (A.AUD_YR, A.AUD_NO, A.REF_ID) IN (SELECT AUD_YR, AUD_NO, NVL(AFF_SNO,0) 
                                                                                             FROM TBCSPKDE106M
                                                                                            WHERE AUD_YR = #{audYr}
                                                                                              AND AUD_NO = #{audNo}
                                                                                              AND SRNO = #{srno}))
            UNION ALL
            SELECT G1.RPRT_NM
                  ,G1.DOC_STA_NM
                  ,G1.OM_DPT_NM
                  ,G1.OM_DT
                  ,G1.RCPT_DPT_NM
                  ,G1.RCPT_DH
                  ,G1.SND_YN
                  ,G1.V_RPRT_NM
                  ,G1.DOC_ID
                  ,G1.RPRT_CD
                  ,G1.DOC_TYPE
             FROM (
            SELECT A.RPRT_NM
                  ,'수신' AS DOC_STA_NM
                  ,F_DPT_INFO(B.SND_DPT_CD, 1) AS OM_DPT_NM
                  ,TO_CHAR(B.SND_DH, 'YYYY-MM-DD') AS OM_DT
                  ,'' AS RCPT_DPT_NM
                  ,'' AS RCPT_DH
                  ,'N' AS SND_YN
                  ,A.RPRT_NM AS V_RPRT_NM
                  ,A.DOC_ID
                  ,A.RPRT_CD
                  ,F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
                  ,(SELECT DISTINCT 'Y' FROM TBBADDED103M T1, TBDCMACM023L T2
                                  WHERE T1.APV_RQS_ID = T2.APV_DOC_NO
                                    AND T1.AUD_YR = A.AUD_YR
                                    AND T1.AUD_NO = A.AUD_NO
                                    AND T1.AUD_YR = #{audYr}
                                    AND T1.AUD_NO = #{audNo}
                                    AND T1.AUD_STEP_CD = 'A1060'
                                    AND T1.RPRT_CD = 'A10600200'
                                    AND T2.APVR_PST_CD = '0055700'
                                    AND T2.APVR_STA_CD IN ('202','203') ) AS APV_YN /* 개별처리안 사무총장 결재 여부 */
                   ,(SELECT T1.ADV_COMMIT_END_YN FROM TBCSPKDE109M T1 
                                                WHERE T1.ADV_COMMIT_YY = (SELECT MAX(ADV_COMMIT_YY) FROM TBCSPKDE103M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND SRNO = #{srno})  
                                                  AND T1.ADV_COMMIT_SRNO = (SELECT MAX(ADV_COMMIT_SRNO) FROM TBCSPKDE103M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND SRNO = #{srno}) ) AS ADV_YN
              FROM TBBADDED103M A, TBBADDED111M B 
             WHERE B.AUD_YR = A.AUD_YR
               AND B.AUD_NO = A.AUD_NO
               AND B.AUD_STEP_CD = A.AUD_STEP_CD
               AND B.DOC_ID = A.DOC_ID
               AND B.RPRT_CD = A.RPRT_CD
               AND A.APV_STA_CD = '30'
               AND NVL(B.REF_ID, '999999') = NVL(A.REF_ID, '999999')
               AND NVL(B.REF_DY, '999999') = NVL(A.REF_DY, '999999')
               AND (A.RPRT_CD IN ('A10600900','A10600960') AND (A.AUD_YR, A.AUD_NO, A.REF_DY) IN (SELECT AUD_YR, AUD_NO, SRNO || MFEX_DVSN_CD
                                                                                                    FROM TBCSPKDE103M_VIEW
                                                                                                   WHERE AUD_YR = #{audYr}
                                                                                                     AND AUD_NO = #{audNo}
                                                                                                     AND SRNO = #{srno}
                                                                                                     AND SPV_DPT_OM_DT >= '20210701'))
              ) G1
              WHERE CASE WHEN #{immunNo2} IS NULL AND G1.APV_YN = 'Y' THEN 'Y'
                         WHEN #{immunNo2} IS NOT NULL AND (G1.ADV_YN = 'Y' AND G1.APV_YN = 'Y') THEN 'Y'
                         ELSE 'N' END = 'Y' 
			  UNION ALL
              SELECT A.RPRT_NM
                  ,'발신' AS DOC_STA_NM
                  ,'' AS OM_DPT_NM
                  ,'' AS OM_DT
                  ,F_DPT_INFO(A.RCPT_DPT_CD, 1) AS RCPT_DPT_NM
                  ,TO_CHAR(A.RCPT_DH, 'YYYY-MM-DD') AS RCPT_DH
                  ,'N' AS SND_YN
                  ,A.RPRT_NM AS V_RPRT_NM
                  ,A.DOC_ID
                  ,A.RPRT_CD
                  ,F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
              FROM TBBADDED111M A
                     WHERE (A.RPRT_CD = 'A10601000' 
						AND (A.AUD_YR, A.AUD_NO, A.REF_ID) IN (SELECT AUD_YR, AUD_NO, NVL(AFF_SNO,0) 
                                                                                             FROM TBCSPKDE106M
                                                                                            WHERE AUD_YR = #{audYr}
                                                                                              AND AUD_NO = #{audNo}
                                                                                              AND SRNO = #{srno}))
			UNION ALL
            SELECT A.RPRT_NM
                  ,'수신' AS DOC_STA_NM
                  ,F_DPT_INFO(A.SND_DPT_CD, 1) AS OM_DPT_NM
                  ,TO_CHAR(A.SND_DH, 'YYYY-MM-DD') AS OM_DT
                  ,'' AS RCPT_DPT_NM
                  ,'' AS RCPT_DH
                  ,'N' AS SND_YN
                  ,A.RPRT_NM AS V_RPRT_NM
                  ,A.DOC_ID
                  ,A.RPRT_CD
                  ,F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
              FROM TBBADDED111M A
              WHERE (A.RPRT_CD = 'A10700900'				/* 권익보호관용 처리안 */
    		  AND A.RCPT_DPT_CD = '160000'
	          AND (A.AUD_YR, A.AUD_NO, SUBSTR(A.REF_ID, 0, LENGTH(A.REF_ID)-2)) IN (SELECT AUD_YR, AUD_NO, SRNO
                                                                   FROM TBCSPKDE103M
                                                                   WHERE AUD_YR = #{audYr}
                                                                   AND AUD_NO = #{audNo}
                                                                   AND SRNO = #{srno})) 
            UNION ALL
            SELECT A.RPRT_NM
                  ,'발신' AS DOC_STA_NM
                  ,'' AS OM_DPT_NM
                  ,'' AS OM_DT
                  ,F_DPT_INFO(A.RCPT_DPT_CD, 1) AS RCPT_DPT_NM
                  ,TO_CHAR(A.RCPT_DH, 'YYYY-MM-DD') AS RCPT_DH
                  ,'N' AS SND_YN
                  ,A.RPRT_NM AS V_RPRT_NM
                  ,A.DOC_ID
                  ,A.RPRT_CD
                  ,F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
              FROM TBBADDED111M A
              WHERE (A.RPRT_CD = 'A10601000'				/* 소명자료 검토의견서 */
              AND (A.AUD_YR, A.AUD_NO, SUBSTR(A.REF_ID, 0, LENGTH(A.REF_ID))) IN (SELECT AUD_YR, AUD_NO, SRNO
                                                                   FROM TBCSPKDE103M
                                                                   WHERE AUD_YR = #{audYr}
                                                                   AND AUD_NO = #{audNo}
                                                                   AND SRNO = #{srno}))
        ]]>
    </select>
    
    <insert id="insertMfexFile" parameterType="paramMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.insertMfexFile*/
        INSERT INTO TBCSPKDE104M(
                AUD_YR
               ,AUD_NO
               ,SRNO
               ,DOC_ID
               ,AUD_KND_CD
               ,AUD_GRN_NO
               ,DOC_KND_CD
               ,FILE_NM
               ,FRT_USR_ID
               ,FNL_USR_ID
               ,FNL_DEAL_DPT_CD
               ,FNL_MNU_ID
               ,FRT_REGI_DH
               ,FNL_MDF_DH
               ,RECEV_DY
               ,GRN_SRNO )
            VALUES (
                #{audYr}
               ,#{audNo}
               ,#{srno}
               ,#{docId}
               ,#{audKndCd}
               ,#{audGrnNo}
               ,#{docKndCd}
               ,#{fileNm}
               ,#{usrId}
               ,#{usrId}
               ,#{dptCd}
               ,#{mnuId}
               ,SYSDATE
               ,SYSDATE
               ,#{recevDy}
               ,#{grnSrno} )
    </insert>
    
    <delete id="deleteMfexFile" parameterType="paramMap">
        /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.deleteMfexFile*/
        <![CDATA[
        DELETE
          FROM TBCSPKDE104M
         WHERE AUD_YR = #{audYr}
           AND AUD_NO = #{audNo}
           AND SRNO = #{srno}
           AND DOC_ID = #{docId}
       ]]>
    </delete>
    
    <select id="selectMfexFile" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectMfexFile*/
        <![CDATA[
            SELECT T1.AUD_YR
                  ,T1.AUD_NO
                  ,T1.SRNO
                  ,T2.DOC_ID
                  ,T2.FILE_NM
                  ,TO_CHAR(TO_DATE(T1.SMT_DT), 'YYYY-MM-DD') AS SMT_DT
                  ,T1.SMT_ORG_NM AS RLTN_ORG_NM
                  ,T1.PRSR
                  ,T1.RECEV_DY||'-소명-'||T1.GRN_SRNO AS YR_SRNO
                  ,F_USR_INFO_BY_ID(T2.FRT_USR_ID, '2') AS FRT_USR_NM
                  ,TO_CHAR(T2.FRT_REGI_DH, 'YYYY-MM-DD') AS FRT_REGI_DH
                  ,T2.FILE_NM AS V_FILE_NM
              FROM TBCSPKDE103M T1
             INNER JOIN TBCSPKDE104M T2 
                ON T1.AUD_YR = T2.AUD_YR
               AND T1.AUD_NO = T2.AUD_NO
               AND T1.SRNO = T2.SRNO
             WHERE T2.AUD_YR = #{audYr}
               AND T2.AUD_NO = #{audNo}
               AND T2.SRNO =  #{srno}
               AND T2.DOC_KND_CD = #{docKndCd} 
          ]]>
    </select>
    
    <select id="selectDoc" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPCAM003EMapper.selectDoc*/
        <![CDATA[
            SELECT G1.RPRT_NM
                  ,G1.APV_STA_CD
                  ,G1.APV_STA_NM
                  ,G1.DOC_ID
                  ,G1.APV_RQS_ID
                  ,MAX(G1.APV_INFO_1) AS APV_INFO_1
                  ,MAX(G1.APV_INFO_2) AS APV_INFO_2
                  ,MAX(G1.APV_INFO_3) AS APV_INFO_3
                  ,MAX(G1.APV_INFO_4) AS APV_INFO_4
                  ,MAX(G1.APV_INFO_5) AS APV_INFO_5
                  ,MAX(G1.APV_INFO_6) AS APV_INFO_6
                  ,MAX(G1.APV_INFO_7) AS APV_INFO_7
                  ,(
                    SELECT DECODE(COUNT(1), 1, 'Y', 'N')
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND SUBSTR(T3.LINK_URL,-36) = G1.DOC_ID
    				   AND (T3.REF_ID = #{srno} OR T3.REF_ID IN (SELECT TO_CHAR(NVL(AFF_SNO,0))
			                                                     FROM TBCSPKDE106M
			                                                    WHERE AUD_YR = #{audYr}
			                                                      AND AUD_NO = #{audNo}
			                                                      AND SRNO = #{srno}))
                       AND T3.RCPT_DPT_CD IN ('510000')
                   ) AS SEND_YN
                  ,G1.RPRT_CD
                  , (SELECT DECODE(COUNT(1), 0, 'N', 'Y') FROM TBDCMACM023H ST1 WHERE ST1.APV_DOC_NO = G1.APV_RQS_ID AND ST1.APVR_STA_CD NOT IN ('301', '201')) AS APV_HIS_YN
                  , G1.DOC_TYPE
              FROM (
                SELECT AUD_YR
                      ,AUD_NO
                      ,RPRT_CD
                      ,RPRT_NM
                      ,APV_STA_CD
                      ,APV_STA_NM
                      ,DOC_ID
                      ,APV_RQS_ID
                      ,DECODE(ROW_ID, 1, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_1
                      ,DECODE(ROW_ID, 2, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_2
                      ,DECODE(ROW_ID, 3, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_3
                      ,DECODE(ROW_ID, 4, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_4
                      ,DECODE(ROW_ID, 5, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_5
                      ,DECODE(ROW_ID, 6, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_6
                      ,DECODE(ROW_ID, 7, DECODE(PST_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_7
                      ,DOC_TYPE
                  FROM (
                    SELECT AUD_YR
                          ,AUD_NO
                          ,RPRT_CD
                          ,RPRT_NM
                          ,APV_STA_CD
                          ,APV_STA_NM
                          ,DOC_ID
                          ,APV_RQS_ID
                          ,PST_NM
                          ,APVR_NM
                          ,APV_DH
                          ,DOC_TYPE
                          ,ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SNO) AS ROW_ID 
                      FROM (
                        SELECT T1.AUD_YR
                              ,T1.AUD_NO
                              ,T1.RPRT_CD
                              ,T1.RPRT_NM
                              ,T1.APV_STA_CD
                              ,F_CODE_NM('1000773',APV_STA_CD) AS APV_STA_NM
                              ,T1.DOC_ID
                              ,T2.APV_SNO
                              ,T1.APV_RQS_ID
                              ,CASE WHEN APVR_PST_CD IS NULL
                                    THEN (SELECT MAX(ONR_PST_NM) FROM TBDCMACM001M WHERE CNB = APVR_CNB)
                                    ELSE F_CODE_NM('1000176', T2.APVR_PST_CD)
                               END  AS PST_NM
                              ,F_USR_INFO(T2.APVR_CNB, '2') AS APVR_NM
                              ,CASE WHEN SUBSTR(T2.APVR_STA_CD,0,1) = '2' THEN TO_CHAR(T2.APV_DH, 'YYYY-MM-DD')
                                    ELSE ''
                               END  AS APV_DH
                              ,F_OPEN_EDIT(T1.LINK_URL) AS DOC_TYPE
                          FROM TBBADDED103M T1
                         LEFT OUTER JOIN TBDCMACM023L T2 ON
                                    T1.APV_RQS_ID = T2.APV_DOC_NO
                                AND T2.APV_SNO <> '1' --(기안자 제외)
                                AND T2.APVR_KND_CD <> '4' --(협조자 제외)
                         WHERE T1.AUD_YR = #{audYr}
                           AND T1.AUD_NO = #{audNo}
                           AND T1.DOC_ID = #{docId}
						   AND (T1.REF_ID = #{srno} OR T1.REF_ID IN (SELECT NVL(AFF_SNO,0) 
                                             							FROM TBCSPKDE106M
                                            						WHERE AUD_YR = #{audYr}
                                              						AND AUD_NO = #{audNo}
                                              						AND SRNO = #{srno}))
                           AND T1.RPRT_CD = 'A10601000' )
                        )
                    ) AS G1
            GROUP BY G1.AUD_YR
                    ,G1.AUD_NO
                    ,G1.RPRT_CD
                    ,G1.RPRT_NM
                    ,G1.APV_STA_CD
                    ,G1.APV_STA_NM
                    ,G1.DOC_ID
                    ,G1.APV_RQS_ID 
                    ,G1.DOC_TYPE
        ]]>
    </select>
</mapper> 