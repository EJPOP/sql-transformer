<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.asb.dao.AEPASB019PMapper">
    <select id="selectDspRqList" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB019PMapper.selectDspRqList */
        <![CDATA[
        SELECT 
            F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-')||'-'||T1.AFF_CD||'-'||T2.AFF_DSP_CD AS DSP_RQ_CD_NM
            , T1.TITLE_NM
            , F_CODE_NM('1000002', T2.DSP_RQ_CD) AS DSP_RQ_NM
            , F_ORG_INFO(RLTN_ORG_CD,'1') AS RLTN_ORG_NM
            , T1.AUD_YR
            , T1.AUD_NO
            , T1.AUD_STEP_CD
            , T1.DOC_ID
            , T1.APVR_CD
            , T1.AFF_SNO
            , T1.AUD_KND_CD
            , T1.AUD_GRN_NO
            , T1.RPRT_FILD_ID
            , T1.AFF_CD
            , DECODE(T3.DSP_RQ_SNO, NULL, 'N', 'Y') AS REGI_YN
            , T2.DSP_RQ_SNO
          FROM TBBADDED145M T1 
               INNER JOIN TBBADDED146M T2
               ON (T1.AUD_YR = T2.AUD_YR
                   AND T1.AUD_NO = T2.AUD_NO
                   AND T1.AUD_STEP_CD = T2.AUD_STEP_CD
                   AND T1.DOC_ID = T2.DOC_ID
                   AND T1.APVR_CD = T2.APVR_CD
                   AND T1.AFF_SNO = T2.AFF_SNO)
               INNER JOIN TBBADDED114M T4
               ON (T1.AUD_YR = T4.AUD_YR
                   AND T1.AUD_NO = T4.AUD_NO
                   AND T1.AUD_STEP_CD = T4.AUD_STEP_CD
                   AND T1.DOC_ID = T4.DOC_ID
                   AND T1.APVR_CD = T4.APVR_CD
                   AND T1.AFF_SNO = T4.AFF_SNO)
               LEFT OUTER JOIN TBBADDED114D T3
               ON (T2.AUD_YR = T3.AUD_YR
                   AND T2.AUD_NO = T3.AUD_NO
                   AND T2.AUD_STEP_CD = T3.AUD_STEP_CD
                   AND T2.DOC_ID = T3.DOC_ID
                   AND T2.APVR_CD = T3.APVR_CD
                   AND T2.AFF_SNO = T3.AFF_SNO
                   AND T2.AFF_SNO = T3.AFF_SNO
                   AND T4.SBMT_SEQ = T3.SBMT_SEQ
                   AND T2.DSP_RQ_SNO = T3.DSP_RQ_SNO)
         WHERE 1=1
           AND T1.AUD_YR = #{audYr}
           AND T1.AUD_NO = #{audNo}
           AND T1.AUD_STEP_CD = #{audStepCd}
           AND T1.DOC_ID = #{docId}
           AND T1.APVR_CD = #{apvrCd}
           AND T1.AFF_SNO = #{affSno}
           AND T4.SBMT_SEQ = #{sbmtSeq}
        ]]>
    </select>
    
    <insert id="insertAgdDspRqList">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB019PMapper.insertAgdDspRqList */
    <![CDATA[
        INSERT INTO TBBADDED114D(
                AUD_YR,
                AUD_NO,
                AUD_STEP_CD,
                DOC_ID,
                APVR_CD,
                AFF_SNO,
                SBMT_SEQ,
                SBMT_DTL_SEQ,
                SBMT_DTL_DVSN,
                DSP_RQ_SNO,
                FRT_USR_ID,
                FNL_USR_ID,
                FNL_DEAL_DPT_CD,
                FNL_MNU_ID,
                FRT_REGI_DH,
                FNL_MDF_DH
                )
         SELECT 
            #{audYr}
            , #{audNo}
            , #{audStepCd}
            , #{docId}
            , #{apvrCd}
            , #{affSno}
            , #{sbmtSeq}
            , (SELECT NVL(MAX(SBMT_DTL_SEQ),0)+1
                  FROM TBBADDED114D
                 WHERE AUD_YR =  #{audYr}
                   AND AUD_NO = #{audNo}
                   AND AUD_STEP_CD = #{audStepCd}
                   AND DOC_ID = #{docId}
                   AND APVR_CD = #{apvrCd}
                   AND AFF_SNO = #{affSno}
                   AND SBMT_SEQ = #{sbmtSeq})
            , '90'
            , T1.DSP_RQ_SNO
            , #{usrId}
            , #{usrId}
            , #{dptCd}
            , 'AEPASB019P'
            , SYSDATE
            , SYSDATE
          FROM TBBADDED146M T1
         WHERE T1.AUD_YR = #{audYr}
           AND T1.AUD_NO = #{audNo}
           AND T1.AUD_STEP_CD = #{audStepCd}
           AND T1.DOC_ID = #{docId}
           AND T1.APVR_CD = #{apvrCd}
           AND T1.AFF_SNO = #{affSno}
           AND T1.DSP_RQ_SNO = #{dspRqSno}
        ]]>
    </insert>
    
    <delete id="deleteAgdDspRqList">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB019PMapper.deleteAgdDspRqList */
    <![CDATA[
    DECLARE
        BEGIN
            DELETE TBBADDED114D
            WHERE 
                AUD_YR = #{audYr}
            AND AUD_NO =  #{audNo}
            AND AUD_STEP_CD =  #{audStepCd}
            AND DOC_ID =  #{docId}
            AND APVR_CD =  #{apvrCd}
            AND AFF_SNO =  #{affSno}
            AND SBMT_SEQ =  #{sbmtSeq}
            AND SBMT_DTL_DVSN = '90';
        END;
        ]]>
    </delete>


</mapper> 
