<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper">
    
    <select id="selectLawList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.selectLawList*/
        <![CDATA[
            SELECT LEGAL_REQ_DVSN_CD
                 , AUD_YR_NO
                 , AFF_NO
                 , AFF_NO AS AFF_NO_REGI
                 , TITLE_NM
                 , RQS_DOC_NM
                 , RQS_DOC_NM AS V_RQS_DOC_NM
                 , RQS_DOC_ID
                 , RQS_DOC_TYPE
                 , RQS_DOC_SND_DT
                 , RQS_DOC_APV_STA_CD
                 , NVL(F_CODE_NM('1000773', RQS_DOC_APV_STA_CD), '미작성') AS RQS_DOC_APV_STA_NM
                 , RQS_DOC_APV_RQS_ID
                 , NVL(RQS_DOC_SND_DT, '미발신') RQS_DOC_SND_STA_NM
                 , OPIN_DOC_NM
                 , OPIN_DOC_NM AS V_OPIN_DOC_NM
                 , OPIN_DOC_ID
                 , OPIN_DOC_TYPE
                 , OPIN_DOC_RCPT_NM
                 , EXAM_DOC_NM
                 , EXAM_DOC_NM AS V_EXAM_DOC_NM
                 , EXAM_DOC_ID
                 , EXAM_DOC_TYPE
                 , EXAM_DOC_APV_STA_CD
                 , NVL(F_CODE_NM('1000773', EXAM_DOC_APV_STA_CD), '미작성') AS EXAM_DOC_APV_STA_NM
                 , EXAM_DOC_APV_RQS_ID
                 , WRK_YR
                 , WRK_NO
                 , LEGAL_REQ_SRNO
                 , AUD_DOC_ID
                 , AFF_SNO
                 , APVR_CD
                 , TRTM_DOC_ID
                 , REQ_STAT_CD
                 , F_CODE_NM('1000830', REQ_STAT_CD) AS REQ_STAT_NM
                 , SUPPLM_REQ_CNT
                 , WRK_DVSN_CD
                 , (SELECT MAX(ST2.AUD_KND_CD) FROM TBBADDED001M ST2 WHERE ST2.AUD_YR = WRK_YR AND ST2.AUD_NO = WRK_NO) AS AUD_KND_CD
              FROM (
                SELECT T1.LEGAL_REQ_DVSN_CD
                     , F_MNG_KND_AUDYRNO(T1.WRK_YR, T1.WRK_NO, '', '-') AS AUD_YR_NO
                     , CASE WHEN T1.LEGAL_REQ_DVSN_CD = '50'  THEN '-' 
                                ELSE DECODE(T2.AFF_CD, NULL, '', F_MNG_KND_AUDYRNO(T1.WRK_YR, T1.WRK_NO, '', '-') || '-' || T2.AFF_CD) END AS AFF_NO
                     , CASE WHEN T1.LEGAL_REQ_DVSN_CD = '50' THEN (SELECT T5.RPRT_NM 
                                                                                      FROM TBBADDED103M T5 
                                                                                     WHERE T5.AUD_YR = T1.WRK_YR
                                                                                        AND T5.AUD_NO = T1.WRK_NO
                                                                                        AND T5.DOC_ID = T1.AUD_DOC_ID  
                                                                                        AND T5.RPRT_CD = 'A10601700')
                               ELSE T2.TITLE_NM END AS TITLE_NM
                     , (SELECT MAX(RPRT_NM)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_NM
                     , (SELECT MAX(DOC_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_ID
                     , (SELECT F_OPEN_EDIT(MAX(LINK_URL))
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_DOC_TYPE
                     , (SELECT TO_CHAR(MAX(SND_DH), 'YYYY-MM-DD')
                          FROM TBBADDED111M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND RCPT_DPT_CD = '160100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_SND_DT
                     , (SELECT MAX(APV_STA_CD)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_APV_STA_CD
                     , (SELECT MAX(APV_RQS_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602100'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS RQS_DOC_APV_RQS_ID
                     , (SELECT MAX(RPRT_NM)
                          FROM TBBADDED111M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602300'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS OPIN_DOC_NM
                     , (SELECT MAX(DOC_ID)
                          FROM TBBADDED111M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602300'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS OPIN_DOC_ID
                      (SELECT F_OPEN_EDIT(MAX(LINK_URL))
                          FROM TBBADDED111M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602300'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS OPIN_DOC_TYPE
                     , NVL((SELECT MAX('수신('||TO_CHAR(RCPT_DH, 'YYYY-MM-DD')||')')
                          FROM TBBADDED111M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602300'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)), '미수신') AS OPIN_DOC_RCPT_NM
                     , (SELECT MAX(RPRT_NM)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602400'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS EXAM_DOC_NM
                     , (SELECT MAX(DOC_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602400'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS EXAM_DOC_ID
                     , (SELECT F_OPEN_EDIT(MAX(LINK_URL))
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602400'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS EXAM_DOC_TYPE
                     , (SELECT APV_STA_CD
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602400'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS EXAM_DOC_APV_STA_CD
                     , (SELECT MAX(APV_RQS_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602400'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS EXAM_DOC_APV_RQS_ID
                     , (SELECT MAX(DOC_ID)
                          FROM TBBADDED103M
                         WHERE AUD_YR = T1.WRK_YR
                           AND AUD_NO = T1.WRK_NO
                           AND RPRT_CD = 'A10602200'
                           AND REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)) AS TRTM_DOC_ID
                     ,(SELECT COUNT(T3.DOC_ID) AS CNT
                        FROM TBBADDED111M T3
                       WHERE T3.AUD_YR = T1.WRK_YR
                          AND T3.AUD_NO = T1.WRK_NO
                          AND T3.RPRT_CD IN  ('A10602100', 'A10602200')
                          AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                          AND T3.REF_ID = TO_CHAR(T1.LEGAL_REQ_SRNO)
                          AND T3.DOC_STA_CD = '51'
                       ) AS SUPPLM_REQ_CNT
                     , T1.WRK_YR
                     , T1.WRK_NO
                     , T1.LEGAL_REQ_SRNO
                     , T1.AUD_DOC_ID
                     , T2.AFF_SNO
                     , T2.APVR_CD
                     , T1.REQ_STAT_CD
                     , T1.WRK_DVSN_CD
                  FROM TBBADDED126M T1
                  LEFT OUTER JOIN (SELECT ST1.AUD_YR
                                          , ST1.AUD_NO
                                          , ST1.AFF_SNO
                                          , ST1.AFF_CD
                                          , ST1.APVR_CD
                                          , ST1.TITLE_NM
                                          , ST1.RPRT_FILD_ID
                                      FROM TBBADDED145M ST1
                                     WHERE ST1.APVR_CD IN (SELECT NVL(MAX(APVR_CD), '0013600')
                                                            FROM (
                                                                SELECT RANK() OVER (PARTITION BY H.DOC_ID ORDER BY DECODE(H.APVR_CD, 'A1070', 1, '0010600', 2,  '0055700', 3, '0055600' ,4 ,'0045900', 5,  '0015800' ,6,'0035100', 7, '0058100', 8,  '0013600', 9, 99) ASC ) AS RN
                                                                     , H.APVR_CD
                                                                     , H.DOC_ID
                                                                     , H.AUD_YR
                                                                     , H.AUD_NO
                                                                  FROM TBBADDED145M H
                                                                 WHERE H.APVR_CD <> '0010200'
                                                                 GROUP BY H.DOC_ID, H.APVR_CD, H.AUD_YR, H.AUD_NO)   
                                                           WHERE RN = 1 
                                                             AND ST1.DOC_ID = DOC_ID
                                                             AND ST1.AUD_YR = AUD_YR
                                                             AND ST1.AUD_NO = AUD_NO)) T2 ON (    T1.WRK_YR = T2.AUD_YR
                                                                                              AND T1.WRK_NO = T2.AUD_NO
                                                                                              AND T1.AFF_SNO = T2.AFF_SNO)
                 WHERE T1.WRK_YR = #{audYr}
                   AND T1.WRK_NO = #{audNo}
                      )
             ORDER BY DECODE(REQ_STAT_CD, '70', '30', REQ_STAT_CD), LEGAL_REQ_SRNO DESC
        ]]>
    </select>
    
    <insert id="insertLegalReq" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.insertLegalReq*/
                MERGE INTO  TBBADDED126M T1
                    USING   (   SELECT  '1'
                                FROM    DUAL
                            ) T2
                    ON  (    T1.WRK_DVSN_CD     = 'A10'
                         AND T1.WRK_YR          = #{wrkYr}
                         AND T1.WRK_NO          = #{wrkNo}
                         AND T1.AUD_STEP_CD     = 'A1060'
                         AND T1.LEGAL_REQ_SRNO  = #{legalReqSrno}
                        )
                WHEN    MATCHED THEN
                    UPDATE
                    SET     
                            T1.LEGAL_REQ_DVSN_CD   = #{legalReqDvsnCd}
                           ,T1.APVR_CD             = #{apvrCd}
                           ,T1.AFF_SNO             = #{affSno}
                           ,T1.RPRT_FILD_ID        = #{rprtFildId}
                           ,T1.AUD_DOC_ID        = #{refDataDocId}
                           ,T1.FNL_USR_ID          = #{usrId}
                           ,T1.FNL_DEAL_DPT_CD     = #{dptCd}
                           ,T1.FNL_MNU_ID          = #{mnuId}
                           ,T1.FNL_MDF_DH          = SYSDATE
                WHEN    NOT MATCHED THEN
                INSERT (
                            WRK_DVSN_CD
                           ,WRK_YR
                           ,WRK_NO
                           ,AUD_STEP_CD
                           ,LEGAL_REQ_SRNO
                           ,LEGAL_REQ_GRN_SRNO
                           ,LEGAL_REQ_DH
                           ,APVR_CD
                           ,AFF_SNO
                           ,RPRT_FILD_ID
                           ,REQ_STAT_CD
                           ,LEGAL_REQ_DVSN_CD
                           ,LEGAL_RCP_YN
                           ,LEGAL_RCP_DH
                           ,HIDDEN_YN
                           ,FRT_USR_ID
                           ,FNL_USR_ID
                           ,FNL_DEAL_DPT_CD
                           ,FNL_MNU_ID
                           ,FRT_REGI_DH
                           ,FNL_MDF_DH
                           ,AUD_DOC_ID )
                        VALUES (
                            'A10'
                           ,#{wrkYr}
                           ,#{wrkNo}
                           ,'A1060'
                           ,#{legalReqSrno}
                           ,#{legalReqSrno}
                           ,''
                       <if test="apvrCd != null and apvrCd != ''">
                           ,#{apvrCd}
                       </if>
                       <if test="apvrCd == null or apvrCd == ''">
                           ,''
                       </if>
                       <if test="affSno != null and affSno != ''">
                           ,#{affSno}
                       </if>
                       <if test="affSno == null or affSno == ''">
                           ,''
                       </if>
                       <if test="rprtFildId != null and rprtFildId != ''">
                           ,#{rprtFildId}
                       </if>
                       <if test="rprtFildId == null or rprtFildId == ''">
                           ,''
                       </if>
                           ,'10'
                           ,#{legalReqDvsnCd}
                           ,''
                           ,''
                           ,'N'
                           ,#{usrId}
                           ,#{usrId}
                           ,#{dptCd}
                           ,#{mnuId}
                           ,SYSDATE
                           ,SYSDATE
                           ,#{refDataDocId} )
        
    </insert>
    
    <insert id="insertLegalReqRefData" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.insertLegalReqRefData*/
      <![CDATA[
          UPDATE TBBADDED103M
                SET REF_ID = #{legalReqSrno}
            WHERE AUD_YR = #{wrkYr}
               AND AUD_NO = #{wrkNo}
               AND DOC_ID = #{refDataDocId}
       ]]>
    </insert>
    
    <insert id="insertLegalReqDetail" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.insertLegalReqDetail*/
                INSERT INTO  TBBADDED126D T1
                        (
                            WRK_DVSN_CD
                          , WRK_YR
                          , WRK_NO
                          , AUD_STEP_CD
                          , LEGAL_REQ_DVSN_CD
                          , LEGAL_REQ_SRNO
                          , LEGAL_REQ_GRN_SRNO
                          , INV_ACC_CNT
                          , AUD_DT
                          , ENF_DT
                          , HND_ORG_CD
                          , RLTN_ORG_CD
                          , MNG_DPT_CD
                          , SPV_BRDV_CD
                          , FRT_USR_ID
                          , FNL_USR_ID
                          , FNL_DEAL_DPT_CD
                          , FNL_MNU_ID
                          , FRT_REGI_DH
                          , FNL_MDF_DH )
                        VALUES (
                            'A10'
                           ,#{wrkYr}
                           ,#{wrkNo}
                           ,'A1060'
                           ,#{legalReqDvsnCd}
                           ,#{legalReqSrno}
                           ,#{legalReqSrno}
                           ,1
                           ,(SELECT MIN(AUD_STR_DT) FROM TBBADDED002M WHERE REL_AUD_YR = #{wrkYr} AND REL_AUD_NO = #{wrkNo})
                           ,(
                             SELECT MIN(ENF_DT)
                               FROM TBBADEAR002D T1
                              INNER JOIN TBBADEAR001M T2 ON (    T1.AUD_YR = T2.AUD_YR
                                                             AND T1.AUD_NO = T2.AUD_NO
                                                             AND T1.DSP_RQ_SNO = T2.DSP_RQ_SNO ) 
                              INNER JOIN TBBADDED146M T3 ON (    T2.AUD_YR = T3.AUD_YR
                                                            AND T2.AUD_NO = T3.AUD_NO
                                                            AND T2.AUD_DSP_RQ_SNO = T3.DSP_RQ_SNO
                                                            AND T3.APVR_CD = #{apvrCd}
                                                            AND T3.AFF_SNO = #{affSno}) 
                              WHERE T1.AUD_YR = #{wrkYr}
                                AND T1.AUD_NO = #{wrkNo}
                            )
                           ,(SELECT MIN(HND_ORG_CD) FROM TBBADDED146M WHERE AUD_YR = #{wrkYr} AND AUD_NO = #{wrkNo} AND APVR_CD = #{apvrCd} AND AFF_SNO = #{affSno})
                           ,(SELECT MIN(RLTN_ORG_CD) FROM TBBADDED146M WHERE AUD_YR = #{wrkYr} AND AUD_NO = #{wrkNo} AND APVR_CD = #{apvrCd} AND AFF_SNO = #{affSno})
                           ,'180100'
                           ,(SELECT SPV_BRDV_CD FROM TBBADDED001M WHERE AUD_YR = #{wrkYr} AND AUD_NO = #{wrkNo})
                           ,#{usrId}
                           ,#{usrId}
                           ,#{dptCd}
                           ,#{mnuId}
                           ,SYSDATE
                           ,SYSDATE )
        
    </insert>
    
    <delete id="deleteLegalReq" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.deleteLegalReq*/
        <![CDATA[
            DELETE
              FROM TBBADDED126M
             WHERE WRK_DVSN_CD = 'A10'
               AND WRK_YR = #{wrkYr}
               AND WRK_NO = #{wrkNo}
               AND AUD_STEP_CD = 'A1060'
               AND LEGAL_REQ_SRNO = #{legalReqSrno}
        ]]>
    </delete>
    
    <select  id="selectLegalSrNo"  parameterType="paramMap" resultType="egovMap">
     /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.selectLegalSrNo*/
         <![CDATA[
    		   SELECT NVL(MAX(LEGAL_REQ_SRNO),0)+1 AS LEGAL_REQ_SRNO
               FROM TBBADDED126M 
               WHERE 1=1
               AND WRK_YR = #{wrkYr}
          ]]>
    </select>
     
    <select id="selectDocId" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.selectDocId*/
        <![CDATA[
            SELECT MAX(DOC_ID) AS DOC_ID
              FROM TBFDMADM002M
             WHERE AUD_DOC_CD = #{rprtCd}
        ]]>
    </select>
    
    <select id="selectRprtApvList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.selectRprtApvList*/
        <![CDATA[
            SELECT G1.RPRT_NM
                  ,G1.RPRT_NM AS V_RPRT_NM
                  ,G1.APV_STA_CD
                  ,G1.APV_STA_NM
                  ,G1.DOC_ID
                  ,G1.APV_RQS_ID
                  ,(SELECT T5.AUD_SBJ_NM FROM TBBADDED001M T5 WHERE G1.AUD_YR = T5.AUD_YR AND G1.AUD_NO = T5.AUD_NO) AS AUD_SBJ_NM
                  ,MAX(G1.APV_INFO_1) AS APV_INFO_1
                  ,MAX(G1.APV_INFO_2) AS APV_INFO_2
                  ,MAX(G1.APV_INFO_3) AS APV_INFO_3
                  ,MAX(G1.APV_INFO_4) AS APV_INFO_4
                  ,MAX(G1.APV_INFO_5) AS APV_INFO_5
                  ,MAX(G1.APV_INFO_6) AS APV_INFO_6
                  ,MAX(G1.APV_INFO_7) AS APV_INFO_7
                  ,(
                    SELECT DECODE(COUNT(1), 0, 'N', 'Y')
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                   ) AS SEND_YN
                    ,(
                    SELECT T3.DOC_STA_CD
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS SEND_STA_CD
                   ,(
                    SELECT T3.SUPPLM_REQ
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS SUPPLM_REQ
                   ,(
                    SELECT T3.RCPT_DPT_CD
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS RCPT_DPT_CD
                   ,(
                    SELECT DECODE(T3.RCPT_DPT_CD, '160000', '법률자문관I', '160100', '법률자문관II') 
                      FROM TBBADDED111M T3
                     WHERE T3.AUD_YR = G1.AUD_YR
                       AND T3.AUD_NO = G1.AUD_NO
                       AND T3.RPRT_CD = G1.RPRT_CD
                       AND T3.DOC_ID = G1.DOC_ID
                       AND T3.SND_DPT_CD = '160100' --법무에서 발신된 문서
                   ) AS RCPT_DPT_NM
                  ,G1.RPRT_CD
                  , G1.DOC_WRT_ID
                  , (SELECT DECODE(COUNT(1), 0, 'N', 'Y') FROM TBDCMACM023H ST1 WHERE ST1.APV_DOC_NO = G1.APV_RQS_ID AND ST1.APVR_STA_CD NOT IN ('301', '201')) AS APV_HIS_YN
                  , G1.DOC_TYPE
              FROM (
                SELECT AUD_YR
                      ,AUD_NO
                      ,RPRT_CD
                      ,RPRT_NM
                      ,APV_STA_CD
                      ,APV_STA_NM
                      ,DOC_ID
                      ,APV_RQS_ID
                      ,DOC_WRT_ID
                      ,DOC_TYPE
                      ,DECODE(ROW_ID, 1, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_1
                      ,DECODE(ROW_ID, 2, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_2
                      ,DECODE(ROW_ID, 3, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_3
                      ,DECODE(ROW_ID, 4, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_4
                      ,DECODE(ROW_ID, 5, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_5
                      ,DECODE(ROW_ID, 6, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_6
                      ,DECODE(ROW_ID, 7, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_7
                  FROM (
                    SELECT AUD_YR
                          ,AUD_NO
                          ,RPRT_CD
                          ,RPRT_NM
                          ,APV_STA_CD
                          ,APV_STA_NM
                          ,DOC_ID
                          ,APV_RQS_ID
                          ,PST_NM
                          ,APVR_NM
                          ,APV_DH
                          ,DOC_WRT_ID
                          ,DOC_TYPE
                          ,ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SNO) AS ROW_ID 
                      FROM (
                        SELECT T1.AUD_YR
                              ,T1.AUD_NO
                              ,T1.RPRT_CD
                              ,T1.RPRT_NM
                              ,T1.APV_STA_CD
                              ,F_CODE_NM('1000773',APV_STA_CD) AS APV_STA_NM
                              ,T1.DOC_ID
                              ,T2.APV_SNO
                              ,T1.APV_RQS_ID
                              ,T1.DOC_WRT_ID
                              ,CASE WHEN APVR_PST_CD IS NULL
                                    THEN (SELECT MAX(ONR_PST_NM) FROM TBDCMACM001M WHERE CNB = APVR_CNB)
                                    ELSE F_CODE_NM('1000176', T2.APVR_PST_CD)
                               END  AS PST_NM
                              ,F_USR_INFO(T2.APVR_CNB, '2') AS APVR_NM
                              ,CASE WHEN SUBSTR(T2.APVR_STA_CD,0,1) = '2' THEN TO_CHAR(T2.APV_DH, 'YYYY-MM-DD')
                                    ELSE ''
                               END  AS APV_DH
                             , F_OPEN_EDIT(T1.LINK_URL) AS DOC_TYPE
                          FROM TBBADDED103M T1
                         LEFT OUTER JOIN TBDCMACM023L T2 ON
                                    T1.APV_RQS_ID = T2.APV_DOC_NO
                                AND T2.APV_SNO <> '1' --(기안자 제외)
                                AND T2.APVR_KND_CD <> '4' --(협조자 제외)
                         WHERE T1.AUD_YR = #{wrkYr}
                           AND T1.AUD_NO = #{wrkNo}
                           AND T1.RPRT_CD IN ('A10602100','A10602400','A10602200','A10602310')
                           AND T1.REF_ID = #{legalReqSrno}
                            ) 
                        )
                    ) AS G1
            GROUP BY G1.AUD_YR
                    ,G1.AUD_NO
                    ,G1.RPRT_CD
                    ,G1.RPRT_NM
                    ,G1.APV_STA_CD
                    ,G1.APV_STA_NM
                    ,G1.DOC_ID
                    ,G1.APV_RQS_ID
                    ,G1.DOC_WRT_ID
                    ,G1.DOC_TYPE
        ]]>
    </select>
    
    <select id="selectRprtRcptList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.selectRprtRcptList*/
        <![CDATA[
            SELECT RPRT_NM
                 , DOC_ID
                 , '수신' AS STA_NM
                 , DECODE(SND_DPT_CD, '160000', '법률자문관I', '160100', '법률자문관II') AS SND_DPT_NM
                 , TO_CHAR(SND_DH, 'YYYY-MM-DD') AS SND_DT
                 , F_DPT_INFO(RCPT_DPT_CD, 1) AS RCPT_DPT_NM
                 , TO_CHAR(RCPT_DH, 'YYYY-MM-DD') AS RCPT_DT
                 , F_OPEN_EDIT(LINK_URL) AS DOC_TYPE
              FROM TBBADDED111M 
             WHERE AUD_YR = #{wrkYr}
               AND AUD_NO = #{wrkNo}
               AND RPRT_CD = 'A10602310'
               AND REF_ID = #{legalReqSrno}
        ]]>
    </select>
    
    <select id="selectRprtSndList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapperselectRprtSndList*/
        <![CDATA[
            SELECT RPRT_NM
                 , DOC_ID
                 , DECODE(DOC_STA_CD, '10', '발신', '20', '수신', '') AS STA_NM
                 , F_DPT_INFO(SND_DPT_CD, 1) AS SND_DPT_NM
                 , TO_CHAR(SND_DH, 'YYYY-MM-DD') AS SND_DT
                 , F_DPT_INFO(RCPT_DPT_CD, 1) AS RCPT_DPT_NM
                 , TO_CHAR(RCPT_DH, 'YYYY-MM-DD') AS RCPT_DT
              FROM TBBADDED111M 
             WHERE AUD_YR = #{wrkYr}
               AND AUD_NO = #{wrkNo}
               AND RPRT_CD IN ('A10602100', 'A10602200')
               AND SND_DPT_CD <> '160100' --법무에서 발신된 문서 제외
               AND REF_ID = #{legalReqSrno}
        ]]>
    </select>
    
    <insert id="insertSendDoc" parameterType="paramMap">
        /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.insertSendDoc*/
            INSERT INTO TBBADDED111M (
                   AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,SR_DOC_SNO
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM
                  ,RPRT_CD
                  ,LINK_URL
                  ,DOC_STA_CD
                  ,SND_DPT_CD
                  ,SNDR_ID
                  ,SND_DH
                  ,RCPT_DPT_CD
                  ,RCNT_ID
                  ,RCPT_DH
                  ,AUD_RPRT_DVSN_CD
                  ,DOC_KND_CD
                  ,REF_ID
                  ,REF_DY
                  ,SORT_SNO
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH )
           (SELECT AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,(
                    SELECT NVL(MAX(SR_DOC_SNO), 0) + 1
                      FROM TBBADDED111M T2
                     WHERE T2.AUD_YR = T1.AUD_YR
                       AND T2.AUD_NO = T1.AUD_NO
                       AND T2.DOC_ID = T1.DOC_ID
                   )
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM
                  ,RPRT_CD
                  ,LINK_URL
                  ,'10'
                  ,#{dptCd}
                  ,#{usrId}
                  ,SYSDATE
                  ,'160100'
                  ,''
                  ,SYSDATE
                  ,AUD_RPRT_DVSN_CD
                  ,DOC_KND_CD
                  ,REF_ID
                  ,REF_DY
                  ,SORT_SNO
                  ,#{usrId}
                  ,#{usrId}
                  ,#{dptCd}
                  ,#{mnuId}
                  ,SYSDATE
                  ,SYSDATE 
              FROM TBBADDED103M T1
             WHERE T1.AUD_YR = #{wrkYr}
               AND T1.AUD_NO = #{wrkNo}
               AND T1.DOC_ID = #{docId}
               AND T1.RPRT_CD = #{rprtCd}
             )
    </insert>
    
    <insert id="insertSendTrtmDoc" parameterType="paramMap">
        /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.insertSendTrtmDoc*/
            INSERT INTO TBBADDED111M (
                   AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,SR_DOC_SNO
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM
                  ,RPRT_CD
                  ,LINK_URL
                  ,DOC_STA_CD
                  ,SND_DPT_CD
                  ,SNDR_ID
                  ,SND_DH
                  ,RCPT_DPT_CD
                  ,RCNT_ID
                  ,RCPT_DH
                  ,AUD_RPRT_DVSN_CD
                  ,DOC_KND_CD
                  ,REF_ID
                  ,REF_DY
                  ,SORT_SNO
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH )
           (SELECT AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,#{docId}
                  ,(
                    SELECT NVL(MAX(SR_DOC_SNO), 0)
                      FROM TBBADDED111M T2
                     WHERE T2.AUD_YR = T1.AUD_YR
                       AND T2.AUD_NO = T1.AUD_NO
                       AND T2.DOC_ID = T1.DOC_ID
                   ) + ROWNUM
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,#{rprtNm}
                  ,'A10602200'
                  ,LINK_URL
                  ,DOC_STA_CD
                  ,SND_DPT_CD
                  ,#{usrId}
                  ,SYSDATE
                  ,RCPT_DPT_CD
                  ,RCNT_ID
                  ,SYSDATE
                  ,AUD_RPRT_DVSN_CD
                  ,DOC_KND_CD
                  ,REF_ID
                  ,REF_DY
                  ,SORT_SNO
                  ,#{usrId}
                  ,#{usrId}
                  ,#{dptCd}
                  ,#{mnuId}
                  ,SYSDATE
                  ,SYSDATE 
              FROM TBBADDED111M T1
             WHERE T1.AUD_YR = #{wrkYr}
               AND T1.AUD_NO = #{wrkNo}
               AND T1.REF_ID = #{legalReqSrno}
               AND T1.RPRT_CD = 'A10602100'
             )
    </insert>
    
    <update id="updateReqStatCd" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.updateReqStatCd*/
        <![CDATA[
            UPDATE TBBADDED126M
               SET REQ_STAT_CD          = '20'
                 , REQ_STAT_CHG_DH      = SYSDATE
                 , LEGAL_REQ_DH         = SYSDATE
                 , FNL_USR_ID           = #{usrId}
                 , FNL_DEAL_DPT_CD      = #{dptCd}
                 , FNL_MNU_ID           = #{mnuId}
                 , FNL_MDF_DH           = SYSDATE
             WHERE WRK_DVSN_CD          = 'A10'
               AND WRK_YR               = #{wrkYr}
               AND WRK_NO               = #{wrkNo}
               AND AUD_STEP_CD          = 'A1060'
               AND LEGAL_REQ_SRNO       = #{legalReqSrno}
               AND LEGAL_REQ_DVSN_CD    = #{legalReqDvsnCd}
        ]]>
    </update>
    
    <update id="updateReqStatCdClng" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.updateReqStatCdClng*/
        <![CDATA[
            UPDATE TBBADDED126M
               SET REQ_STAT_CD          = '90'
                 , REQ_STAT_CHG_DH      = SYSDATE
                 , LEGAL_REQ_DH         = SYSDATE
                 , FNL_USR_ID           = #{usrId}
                 , FNL_DEAL_DPT_CD      = #{dptCd}
                 , FNL_MNU_ID           = #{mnuId}
                 , FNL_MDF_DH           = SYSDATE
             WHERE WRK_DVSN_CD          = 'A10'
               AND WRK_YR               = #{wrkYr}
               AND WRK_NO               = #{wrkNo}
               AND AUD_STEP_CD          = 'A1060'
               AND LEGAL_REQ_SRNO       = #{legalReqSrno}
               AND LEGAL_REQ_DVSN_CD    = #{legalReqDvsnCd}
        ]]>
    </update>
    
      <update id="deleteLegalRefId" parameterType="paramMap">
     /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.deleteLegalRefId*/
    	UPDATE TBBADDED126M
        SET AUD_DOC_ID = #{refDataDocId} 
        WHERE WRK_YR = #{wrkYr}
        AND WRK_NO =  #{wrkNo}
        AND AUD_STEP_CD = 'A1060' 
        AND LEGAL_REQ_DVSN_CD = #{legalReqDvsnCd}
        AND LEGAL_REQ_SRNO = #{legalReqSrno}  
       
    </update>  
    
     <update id="updateRefDy" parameterType="paramMap">
     /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.updateRefDy*/
    	UPDATE TBBADDED103M
        SET REF_DY = #{legalReqDvsnCd} 
        WHERE AUD_YR = #{wrkYr}
        AND AUD_NO =  #{wrkNo}
        AND REF_ID = #{legalReqSrno}
       
    </update>  
    
    <select id="selectDelDocId" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.selectDelDocId*/
        <![CDATA[
            SELECT DOC_ID
              FROM TBBADDED103M
             WHERE RPRT_CD IN ('A10602100', 'A10602200', 'A10602400')
               AND REF_ID = #{legalReqSrno}
        ]]>
    </select>
    
    <update id="deleteDoc" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper."deleteDoc"*/
        <![CDATA[
            DELETE 
              FROM TBBADDED103M
             WHERE DOC_ID = #{docId}
        ]]>
    </update>
    
    <update id="updateSendDoc" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.updateSendDoc*/
        <![CDATA[
              UPDATE TBBADDED111M
                   SET DOC_STA_CD = '52'
                      , FNL_USR_ID           = #{usrId}
                      , FNL_DEAL_DPT_CD      = #{dptCd}
                      , FNL_MNU_ID           = #{mnuId}
                      , FNL_MDF_DH           = SYSDATE
                    WHERE DOC_ID = #{docId}
                      AND RCPT_DPT_CD = #{rcptDptCd}
                      AND AUD_YR = #{wrkYr}
                      AND AUD_NO = #{wrkNo}
                      AND REF_ID = #{legalReqSrno}
        ]]>
    </update>
    
    <update id="updateBlockEdtAuth" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.updateBlockEdtAuth*/
        <![CDATA[
              UPDATE TBBADDED103M
                   SET EDT_AUTH = NULL
                      , FNL_USR_ID           = #{usrId}
                      , FNL_DEAL_DPT_CD      = #{dptCd}
                      , FNL_MNU_ID           = #{mnuId}
                      , FNL_MDF_DH           = SYSDATE
                    WHERE DOC_ID = #{docId}
                      AND AUD_YR = #{wrkYr}
                      AND AUD_NO = #{wrkNo}
                      AND REF_ID = #{legalReqSrno}
        ]]>
    </update>
    
    
    <select id="selectAudInfoForMsg" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.selectAudInfoForMsg*/
        <![CDATA[
            SELECT F_DPT_INFO(A.MNG_DPT_CD, '1') AS MNG_DPT_NM
                 , F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, A.AUD_KND_CD, '-') AS AUD_YR_NO
                 , A.AUD_SBJ_NM
                 , F_CODE_NM('1000828', #{legalReqDvsnCd}) AS LEGAL_REQ_DVSN_NM
                 , (SELECT NVL(AGGR_CONCAT(ST.USR_DFN_TXT_2,''), '000') FROM TBDCMACM013C ST WHERE ST.CMM_CD_DVSN_CD = '1000859' AND  ST.CD = #{dvsnCd}) AS RCPT_USR_CNB
                 , (SELECT COUNT(ST.USR_DFN_TXT_1) FROM TBDCMACM013C ST WHERE ST.CMM_CD_DVSN_CD = '1000859' AND   ST.CD = #{dvsnCd}) AS RCPT_USR_CNT
            FROM TBBADDED001M A 
           WHERE A.AUD_YR = #{wrkYr}
             AND A.AUD_NO = #{wrkNo}
        ]]>
    </select>
    
     <insert id="insertSendMessage" parameterType="paramMap">
        /*kr.go.bai.eip.aep.rla.dao.AEPRLA003EMapper.insertSendMessage*/
            INSERT INTO
            TBDCMACM026L
            (
              MSG_SNO
            , TSK_CAT_CD
            , FUNC_CAT_CD
            , SEND_ID
            , MSG_TP_YN   
            , MSG_TXT_2
            , RCNT_CNT
            , RCNT_HIS
            , MSG_REGI_DH   
            , FRT_USR_ID
            , FNL_USR_ID
            , FNL_DEAL_DPT_CD
            , FNL_MNU_ID
            , FRT_REGI_DH
            , FNL_MDF_DH  
            )
            (
            SELECT
              (SELECT NVL(MAX(MSG_SNO),'0') AS MSG_SNO FROM TBDCMACM026L) + ROWNUM
            , 'CM'
            , 'CM'
            , 'SYSTEM'
            , '0'
            ,#{sendMsg}
            , 1
            , CNB
            , SYSDATE 
            , #{usrId}
            , #{usrId}
            , #{dptCd}
            , #{mnuId}
            , SYSDATE
            , SYSDATE
            FROM TBDCMACM001M
            WHERE CNB IN ('9339', F_USR_INFO_BY_ID(#{rcptUsrCnb},'1'))
            )
    </insert>
    
     <select id="selectRlaReqInfo" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.selectRlaReqInfo*/
        <![CDATA[
           SELECT USR_NAM AS USR_NAM
                    ,F_DPT_INFO(DPT_CD,'1') AS DPT_NM
            FROM TBDCMACM001M
           WHERE USR_ID = #{usrId}
        ]]>
    </select>
    
    <select id="selectLegalDptInfo" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPRLA001PMapper.selectLegalDptInfo*/
        <![CDATA[
           SELECT A.LEGAL_DPT_RCP_YN
                   ,A.LEGAL_DPT_CD
                   ,CASE WHEN A.LEGAL_DPT_CD = '160000' THEN '10' 
                           WHEN A.LEGAL_DPT_CD = '160100' THEN '20' 
                             ELSE '' END AS DPT_INFO_CD
           FROM TBBADDED126M A
          WHERE A.WRK_YR = #{wrkYr}
             AND A.WRK_NO  = #{wrkNo}
             AND A.WRK_DVSN_CD = #{wrkDvsnCd}
             AND A.LEGAL_REQ_SRNO =  #{legalReqSrno}
      ]]>
    </select>
    
</mapper> 