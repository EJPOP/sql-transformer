<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.ewm.dao.AEPEWM006EMapper">
	
		<!-- 특수관리사항 목록조회  BADFRE014EMainselect-->
		<select id="selectMainList" parameterType="paramMap" resultType="egovMap">
		
		/* kr.go.bai.eip.aep.ewm.dao.AEPEWM006EMapper.selectMainList */
	      SELECT 
                 D1.AUD_YR                                                            /* 감사년도                   */
                ,D1.AUD_NO                                                            /* 감사번호                   */
                ,D4.AUD_GRN_NO                                                        /* 감사부여번호 - 2016.06.02 yyh */
                ,D1.DSP_RQ_SNO                                                        /* 처분요구순번               */
                ,D1.RLTN_ORG_CD                                                       /* 관계기관코드               */
                ,F_ORG_INFO(D1.RLTN_ORG_CD,'1')                    AS RLTN_ORG_NM     /* 관계기관명               */
                ,D1.MNG_SNO                                                           /* 관리순번                   */
                ,D1.SPV_BRDV_CD                                                       /* 주관국과코드               */
                ,F_DPT_INFO(D1.SPV_BRDV_CD,'1')                    AS SPV_BRDV_NM     /* 주관국과명               */
                ,D1.DTM_YN                                                            /* 확정여부        */
                ,D1.MNG_ORG_CD                                                        /* 관리기관코드    */
                ,F_ORG_INFO(D1.MNG_ORG_CD,'1')                     AS MNG_ORG_NM      /* 관리기관명        */
                ,TO_CHAR(TO_DATE(D1.ASG_DT),'YYYY-MM-DD') AS ASG_DT                                                            /* 지정일                     */
                ,D1.ASG_AM                                                            /* 지정금액                   */
                ,D1.CPS_DRTR_NM                                                       /* 변상책임자명               */
                ,F_ORG_INFO(D1.MNG_ORG_CD,'1') || '(' ||
                 D1.CPS_DRTR_NM || ')'                             AS ORG_DRTR_NM     /* 관리기관(책임자) */                     
                ,D1.CPS_DRTR_AD                                                       /* 변상책임자주소             */
                ,TO_CHAR(TO_DATE(D1.RLS_DT),'YYYY-MM-DD') AS RLS_DT           /* 해제일                     */
                ,D1.RLS_RSN                                                           /* 해제사유                   */
                ,D1.RQR_ID                                                            /* 요청자ID      */
                ,F_USR_INFO(D1.RQR_ID,'2')                         AS RQR_NM          /* 요청자명      */
                ,TO_CHAR(TO_DATE(D1.RQS_DT),'YYYY-MM-DD') AS RQS_DT         /* 요청일                     */
                ,D1.RQS_RSN                                                           /* 요청사유                   */
                ,D1.APV_DOC_NO                                                        /* 결재문서번호     */
                ,D1.APV_STA_CD                                                        /* 결재상태코드               */
                ,CASE WHEN D1.APV_STA_CD IS NULL THEN '미상신'
                      ELSE F_CODE_NM('1000603', D1.APV_STA_CD)
                  END                                              AS APV_STA_NM      /* 결재상태명               */
                ,TO_CHAR(TO_DATE(D1.APV_STA_DT),'YYYY-MM-DD')   AS APV_STA_DT                                                        /* 결재상태일                 */
                ,D1.MNG_YR                                                            /* 관리년도                   */
                ,D1.MNG_NO                                                            /* 관리번호                   */
                ,D1.SLF_PRSS_STA_CD                                                   /* 자체진행상태코드           */
                ,TO_CHAR(TO_DATE(D1.SLF_APV_DT),'YYYY-MM-DD') AS SLF_APV_DT                                                           /* 자체결재일                 */
                ,TO_CHAR(TO_DATE(D1.SLF_SEN_DT),'YYYY-MM-DD') AS SLF_SEN_DT                                                          /* 자체발송일                 */
                ,D1.SPCN_MNG_STA_CD                                                   /* 특수관리상태코드           */
                ,D1.ASG_RSN                                                           /* 지정사유                   */
                ,D1.EXAM_RPT_FRM_ENFM_HIS                                             /* 검토보고서식집행내역       */
                ,D1.EXAM_RPT_FRM_ASG_RSN                                              /* 검토보고서식지정사유       */
                ,D1.EXAM_RPT_FRM_EXAM_OPIN                                            /* 검토보고서식검토의견       */
                ,D1.EXAM_RPT_FRM_APV_STA_CD                                           /* 검토보고서식결재상태코드   */
                ,TO_CHAR(TO_DATE(D1.EXAM_RPT_FRM_APV_STA_DT),'YYYY-MM-DD') AS EXAM_RPT_FRM_APV_STA_DT                                           /* 검토보고서식결재상태일     */
            	,D1.EXAM_RPT_FRM_APV_DOC_NO                                           /* 검토보고서식결재문서번호 */
                ,D1.DOC_ID                                                            /* 문서ID      */
                ,D1.DOC_TYP_CD                                                        /* 문서유형코드               */
                ,D1.FRT_USR_ID                                                        /* 최초사용자ID    */
                ,D1.FNL_USR_ID                                                        /* 최종사용자ID   */
                ,D1.FNL_DEAL_DPT_CD                                                   /* 최종거래부서코드           */
                ,D1.FNL_MNU_ID                                                        /* 최종메뉴ID    */
                ,D1.FRT_REGI_DH                                                       /* 최초등록일시               */
                ,D1.FNL_MDF_DH                                                        /* 최종수정일시       */
                /*,F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D4.AUD_KND_CD, '-') || '-' || D1.DSP_RQ_SNO  */
                ,NVL2(D2.ACT_DSP_NM,D2.ACT_DSP_NM, F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D4.AUD_KND_CD, '-') || '-' || D1.DSP_RQ_SNO   )  
                                                                   AS DSP_RQ_NO       /* 처분요구번호                   */
 		     	, CASE WHEN D2.AUD_YR >= '2016' 
			                THEN SUBSTR(D4.AUD_KND_CD,3,1)
			           ELSE '' 
			       END                                             AS AUD_YR_NO_KND_CD /*감사연번호종류코드 추가 - 2015.12.24 yyh*/	                 
                ,D2.TIT_TXT                                        AS TIT_TXT         /* 제목내용                   */
                ,CASE WHEN NVL(D1.DTM_YN,'N')   != 'Y' 
                           AND D1.ASG_DT        IS NOT NULL                 
        	               AND D1.RLS_DT        IS NULL     THEN '지정X'
        	          WHEN NVL(D1.DTM_YN,'N')   = 'Y'                  
        	               AND D1.ASG_DT        IS NOT NULL                  
    	                   AND D1.RLS_DT        IS NULL     THEN '지정O'
    	              WHEN NVL(D1.DTM_YN,'N')  != 'Y'                 
    	                   AND D1.RLS_DT        IS NOT NULL THEN '해제X'
    	              WHEN NVL(D1.DTM_YN,'N')   = 'Y'                  
    	                   AND D1.RLS_DT        IS NOT NULL THEN '해제O'
    	             END                                           AS DVSN                 /* 구분                   */
                
                ,D3.ENF_BRDV_CD                                    AS ENF_BRDV_CD          /* 시행국과명 */
                ,F_DPT_INFO(D3.ENF_BRDV_CD,'1')                    AS ENF_BRDV_NM          /* 시행국과명 */                
                ,D2.DSP_RQ_KND_CD                                  AS DSP_RQ_KND_CD        /* 처분요구종류코드 */
                ,F_CODE_NM('1000002', D2.DSP_RQ_KND_CD)            AS DSP_RQ_KND_NM        /* 처분요구종류명 */
                ,D3.PNL_DRIN_PSVT_AM                               AS PNL_DRIN_PSVT_AM     /* 추징회수보전금액 */ 
                ,TO_CHAR(TO_DATE(D3.ENF_DT),'YYYY-MM-DD')          AS ENF_DT               /* 시행일 */
                ,D4.AUD_SBJ_NM                                     AS AUD_SBJ_NM           /* 감사사항명 */
                ,D3.EXAM_RPRT_DSP_RQ_SBT                           AS EXAM_RPRT_DSP_RQ_SBT /* 검토보고서 처분요구요지 */
                ,(SELECT SUM(AM)
                    FROM TBBADEAR007M /* 관계자 기본 */
                   WHERE 1=1
                     AND AUD_YR     = D1.AUD_YR    
        	         AND AUD_NO     = D1.AUD_NO     
        	         AND DSP_RQ_SNO = D1.DSP_RQ_SNO)               AS DSP_RQ_TAM           /* 처분요구 전체 금액 */
        	         
           FROM TBBADFRE011M D1  /* 특수관리기본 */
               ,TBBADEAR001M D2  /* 처분요구사항기본 */
               ,TBBADEAR002D D3  /* 처분요구사항 상세 */
               ,TBBADDED001M D4  /* 감사사항기본 */               
          WHERE 1=1
            AND D1.AUD_YR               = D2.AUD_YR    
        	AND D1.AUD_NO               = D2.AUD_NO     
        	AND D1.DSP_RQ_SNO           = D2.DSP_RQ_SNO
            AND D2.AUD_YR               = D3.AUD_YR    
        	AND D2.AUD_NO               = D3.AUD_NO     
        	AND D2.DSP_RQ_SNO           = D3.DSP_RQ_SNO 
        	AND D3.AUD_YR               = D4.AUD_YR    
        	AND D3.AUD_NO               = D4.AUD_NO        	
            AND D1.SLF_PRSS_STA_CD  &gt;= '71'
            AND NVL(D1.APV_STA_CD, '1') = '3'  /* 결재완료 상태 */
            
            	
            AND D1.SPV_BRDV_CD   IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#{cnb}, #{dptAuth}, '', #{upSpvBrdvCd})))
            <!-- 주관국과코드 -->    
		<if test='spvBrdvCd != null and spvBrdvCd != ""'>
                AND D1.SPV_BRDV_CD = #{spvBrdvCd}
            </if> 
            
            <!-- 지정접수 -->
		<if test='spCnMngStaCd == "1"'>
                AND NVL(D1.DTM_YN,'N') != 'Y'                           
        	    AND D1.ASG_DT IS NOT NULL                            
        	    AND D1.RLS_DT IS NULL
	        </if>     
            <!-- 지정확정 -->
		<if test='spCnMngStaCd == "2"'>
                AND NVL(D1.DTM_YN,'N') = 'Y'                            
                AND D1.ASG_DT IS NOT NULL                            
                AND D1.RLS_DT IS NULL     
	        </if>                 
            <!-- 해제접수 -->
		<if test='spCnMngStaCd == "3"'>
                AND NVL(D1.DTM_YN,'N') != 'Y'                           
                AND D1.RLS_DT IS NOT NULL     
	        </if>               
            <!-- 해제확정 -->
		<if test='spCnMngStaCd == "4"'>
                AND NVL(D1.DTM_YN,'N') = 'Y'                           
                AND D1.RLS_DT IS NOT NULL     
	        </if>      
	        
			<!-- 검색어 -->
			<if test='schTxt != null and schTxt != ""'>
                AND ( (SELECT ORG_NM 
                         FROM TBDCMACM015M                                
        		        WHERE ORG_CD = D1.MNG_ORG_CD) LIKE  '%' || #{schTxt} || '%'
        		     OR D1.CPS_DRTR_NM  LIKE  '%' || #{schTxt} || '%'
        		     OR D2.TIT_TXT      LIKE  '%' || #{schTxt} || '%'
        		    )
            </if>
           
            <!-- 감사연번 -->
			<if test='audYr != null and audYr != ""'>
                AND D1.AUD_YR = #{audYr}
            </if>
			<if test='audGrnNo != null and audGrnNo != ""'>
                AND D4.AUD_GRN_NO = #{audGrnNo}
            </if>  
                       
			<if test='audYrNoKndCd != null and audYrNoKndCd != ""'>
	              /* 감사연번종류코드 - 2015.12.24 yyh */
				  AND SUBSTR(D4.AUD_KND_CD,3,1) = #{audYrNoKndCd} 
			</if>
			                       
        ORDER BY D1.AUD_YR DESC 
               , D1.AUD_NO DESC
               , D1.DSP_RQ_SNO DESC
               , D1.RLTN_ORG_CD DESC
               , D1.MNG_SNO DESC           
	</select>
	
	
	
	
		<!-- 특수관리사항 상세 목록조회 -->
		<select id="selectMainDtl" parameterType="paramMap" resultType="egovMap">
		
		/* kr.go.bai.eip.aep.ewm.dao.AEPEWM006EMapper.selectMainDtl */
	      SELECT 
                 D1.AUD_YR                                                            /* 감사년도                   */
                ,D1.AUD_NO                                                            /* 감사번호                   */
                ,D4.AUD_GRN_NO                                                        /* 감사부여번호 - 2016.06.02 yyh */
                ,D1.DSP_RQ_SNO                                                        /* 처분요구순번               */
                ,D1.RLTN_ORG_CD                                                       /* 관계기관코드               */
                ,F_ORG_INFO(D1.RLTN_ORG_CD,'1')                    AS RLTN_ORG_NM     /* 관계기관명               */
                ,D1.MNG_SNO                                                           /* 관리순번                   */
                ,D1.SPV_BRDV_CD                                                       /* 주관국과코드               */
                ,F_DPT_INFO(D1.SPV_BRDV_CD,'1')                    AS SPV_BRDV_NM     /* 주관국과명               */
                ,D1.DTM_YN                                                            /* 확정여부        */
                ,D1.MNG_ORG_CD                                                        /* 관리기관코드    */
                ,F_ORG_INFO(D1.MNG_ORG_CD,'1')                     AS MNG_ORG_NM      /* 관리기관명        */
                ,TO_CHAR(TO_DATE(D1.ASG_DT),'YYYY-MM-DD') AS ASG_DT                                                            /* 지정일                     */
                ,D1.ASG_AM                                                            /* 지정금액                   */
                ,D1.CPS_DRTR_NM                                                       /* 변상책임자명               */
                ,F_ORG_INFO(D1.MNG_ORG_CD,'1') || '(' ||
                 D1.CPS_DRTR_NM || ')'                             AS ORG_DRTR_NM     /* 관리기관(책임자) */                     
                ,D1.CPS_DRTR_AD                                                       /* 변상책임자주소             */
                ,TO_CHAR(TO_DATE(D1.RLS_DT),'YYYY-MM-DD') AS RLS_DT           /* 해제일                     */
                ,D1.RLS_RSN                                                           /* 해제사유                   */
                ,D1.RQR_ID                                                            /* 요청자ID      */
                ,F_USR_INFO(D1.RQR_ID,'2')                         AS RQR_NM          /* 요청자명      */
                ,TO_CHAR(TO_DATE(D1.RQS_DT),'YYYY-MM-DD') AS RQS_DT         /* 요청일                     */
                ,D1.RQS_RSN                                                           /* 요청사유                   */
                ,D1.APV_DOC_NO                                                        /* 결재문서번호     */
                ,D1.APV_STA_CD                                                        /* 결재상태코드               */
                ,CASE WHEN D1.APV_STA_CD IS NULL THEN '미상신'
                      ELSE F_CODE_NM('1000603', D1.APV_STA_CD)
                  END                                              AS APV_STA_NM      /* 결재상태명               */
                ,TO_CHAR(TO_DATE(D1.APV_STA_DT),'YYYY-MM-DD')   AS APV_STA_DT                                                        /* 결재상태일                 */
                ,D1.MNG_YR                                                            /* 관리년도                   */
                ,D1.MNG_NO                                                            /* 관리번호                   */
                ,D1.SLF_PRSS_STA_CD                                                   /* 자체진행상태코드           */
                ,TO_CHAR(TO_DATE(D1.SLF_APV_DT),'YYYY-MM-DD') AS SLF_APV_DT                                                           /* 자체결재일                 */
                ,TO_CHAR(TO_DATE(D1.SLF_SEN_DT),'YYYY-MM-DD') AS SLF_SEN_DT                                                          /* 자체발송일                 */
                ,D1.SPCN_MNG_STA_CD                                                   /* 특수관리상태코드           */
                ,D1.ASG_RSN                                                           /* 지정사유                   */
                ,D1.EXAM_RPT_FRM_ENFM_HIS                                             /* 검토보고서식집행내역       */
                ,D1.EXAM_RPT_FRM_ASG_RSN                                              /* 검토보고서식지정사유       */
                ,D1.EXAM_RPT_FRM_EXAM_OPIN                                            /* 검토보고서식검토의견       */
                ,D1.EXAM_RPT_FRM_APV_STA_CD                                           /* 검토보고서식결재상태코드   */
                ,TO_CHAR(TO_DATE(D1.EXAM_RPT_FRM_APV_STA_DT),'YYYY-MM-DD') AS EXAM_RPT_FRM_APV_STA_DT                                           /* 검토보고서식결재상태일     */
            	,D1.EXAM_RPT_FRM_APV_DOC_NO                                           /* 검토보고서식결재문서번호 */
                ,D1.DOC_ID                                                            /* 문서ID      */
                ,D1.DOC_TYP_CD                                                        /* 문서유형코드               */
                ,D1.FRT_USR_ID                                                        /* 최초사용자ID    */
                ,D1.FNL_USR_ID                                                        /* 최종사용자ID   */
                ,D1.FNL_DEAL_DPT_CD                                                   /* 최종거래부서코드           */
                ,D1.FNL_MNU_ID                                                        /* 최종메뉴ID    */
                ,D1.FRT_REGI_DH                                                       /* 최초등록일시               */
                ,D1.FNL_MDF_DH                                                        /* 최종수정일시       */
                /* ,F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D4.AUD_KND_CD, '-') || '-' || D1.DSP_RQ_SNO */  
                ,NVL2(D2.ACT_DSP_NM,D2.ACT_DSP_NM, F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D4.AUD_KND_CD, '-') || '-' || D1.DSP_RQ_SNO   )
                                                                   AS DSP_RQ_NO       /* 처분요구번호                   */
 		     	, CASE WHEN D2.AUD_YR >= '2016' 
			                THEN SUBSTR(D4.AUD_KND_CD,3,1)
			           ELSE '' 
			       END                                             AS AUD_YR_NO_KND_CD /*감사연번호종류코드 추가 - 2015.12.24 yyh*/	                 
                ,D2.TIT_TXT                                        AS TIT_TXT         /* 제목내용                   */
                ,CASE WHEN NVL(D1.DTM_YN,'N')   != 'Y' 
                           AND D1.ASG_DT        IS NOT NULL                 
        	               AND D1.RLS_DT        IS NULL     THEN '지정X'
        	          WHEN NVL(D1.DTM_YN,'N')   = 'Y'                  
        	               AND D1.ASG_DT        IS NOT NULL                  
    	                   AND D1.RLS_DT        IS NULL     THEN '지정O'
    	              WHEN NVL(D1.DTM_YN,'N')  != 'Y'                 
    	                   AND D1.RLS_DT        IS NOT NULL THEN '해제X'
    	              WHEN NVL(D1.DTM_YN,'N')   = 'Y'                  
    	                   AND D1.RLS_DT        IS NOT NULL THEN '해제O'
    	             END                                           AS DVSN                 /* 구분                   */
                
                ,D3.ENF_BRDV_CD                                    AS ENF_BRDV_CD          /* 시행국과명 */
                ,F_DPT_INFO(D3.ENF_BRDV_CD,'1')                    AS ENF_BRDV_NM          /* 시행국과명 */                
                ,D2.DSP_RQ_KND_CD                                  AS DSP_RQ_KND_CD        /* 처분요구종류코드 */
                ,F_CODE_NM('1000002', D2.DSP_RQ_KND_CD)            AS DSP_RQ_KND_NM        /* 처분요구종류명 */
                ,D3.PNL_DRIN_PSVT_AM                               AS PNL_DRIN_PSVT_AM     /* 추징회수보전금액 */ 
                ,TO_CHAR(TO_DATE(D3.ENF_DT),'YYYY-MM-DD')          AS ENF_DT               /* 시행일 */
                ,D4.AUD_SBJ_NM                                     AS AUD_SBJ_NM           /* 감사사항명 */
                ,D3.EXAM_RPRT_DSP_RQ_SBT                           AS EXAM_RPRT_DSP_RQ_SBT /* 검토보고서 처분요구요지 */
                ,(SELECT SUM(AM)
                    FROM TBBADEAR007M /* 관계자 기본 */
                   WHERE 1=1
                     AND AUD_YR     = D1.AUD_YR    
        	         AND AUD_NO     = D1.AUD_NO     
        	         AND DSP_RQ_SNO = D1.DSP_RQ_SNO)               AS DSP_RQ_TAM           /* 처분요구 전체 금액 */
        	         
        	    ,D1.SPV_BRDV_CD                                    AS ENFM_MNG_BRDV_CD
        	    ,F_DPT_INFO(D1.SPV_BRDV_CD,'1')                    AS ENFM_MNG_BRDV_NM   
        	            	         
           FROM TBBADFRE011M D1  /* 특수관리기본 */
               ,TBBADEAR001M D2  /* 처분요구사항기본 */
               ,TBBADEAR002D D3  /* 처분요구사항 상세 */
               ,TBBADDED001M D4  /* 감사사항기본 */               
          WHERE 1=1
            AND D1.AUD_YR               = D2.AUD_YR    
        	AND D1.AUD_NO               = D2.AUD_NO     
        	AND D1.DSP_RQ_SNO           = D2.DSP_RQ_SNO
            AND D2.AUD_YR               = D3.AUD_YR    
        	AND D2.AUD_NO               = D3.AUD_NO     
        	AND D2.DSP_RQ_SNO           = D3.DSP_RQ_SNO 
        	AND D3.AUD_YR               = D4.AUD_YR    
        	AND D3.AUD_NO               = D4.AUD_NO        	
            AND D1.SLF_PRSS_STA_CD  &gt;= '71'            
            	
            AND D1.AUD_YR        = #{audYr}      /* 감사년도 */
            AND D1.AUD_NO        = #{audNo}      /* 감사번호 */
            AND D1.DSP_RQ_SNO    = #{dspRqSno}   /* 처분요구순번 */
            AND D1.RLTN_ORG_CD   = #{rltnOrgCd}  /* 관계기관코드 */
            AND D1.MNG_SNO       = #{mngSno}     /* 관리순번 */   
			                       
          
	</select>

	<!-- 특수관리 집행내역 조회  BADFRE014EHisselect-->
	<select id="selectHis" parameterType="paramMap" resultType="egovMap">
	/* kr.go.bai.eip.aep.ewm.dao.AEPEWM006EMapper.selectHis */
	      SELECT 
                 AUD_YR                                     /* 감사년도 */
                ,AUD_NO                                     /* 감사번호 */   
                ,DSP_RQ_SNO                                 /* 처분요구순번 */
                ,RLTN_ORG_CD                                /* 관계기관코드 */
                ,F_ORG_INFO(RLTN_ORG_CD,'1') AS RLTN_ORG_NM /* 관계기관명 */
                ,MNG_SNO                                    /* 관리순번 */
                ,SLN                                        /* 연번 */     
                ,TO_CHAR(TO_DATE(ENFM_DT),'YYYY-MM-DD') AS ENFM_DT    /* 집행일 */             
                ,ENFM_AM                                    /* 집행금액 */           
                ,ENFM_TXT                                   /* 집행내용 */           
                ,DTM_YN                                     /* 확정여부 */           
	       FROM TBBADFRE011L
	      WHERE 1=1
	        AND AUD_YR        = #{audYr}      /* 감사년도 */
            AND AUD_NO        = #{audNo}      /* 감사번호 */
            AND DSP_RQ_SNO    = #{dspRqSno}   /* 처분요구순번 */
            AND RLTN_ORG_CD   = #{rltnOrgCd}  /* 관계기관코드 */
            AND MNG_SNO       = #{mngSno}     /* 관리순번 */  
	      ORDER BY SLN DESC 
	</select>
	
	<!-- 특수관리기본 수정  BADFRE014EMainupdate -->
	<update id="updateMain" parameterType="paramMap">
	/* kr.go.bai.eip.aep.ewm.dao.AEPEWM006EMapper.updateMain */
        UPDATE TBBADFRE011M                          /* 특수관리 기본 */ 
		  SET FNL_MDF_DH      = SYSDATE              /* 최종수정일시 */ 
             ,FNL_USR_ID      = #{fnlUsrId}         /* 최종사용자ID */       
             ,FNL_DEAL_DPT_CD = #{fnlDealDptCd}    /* 최종거래부서코드 */
             ,FNL_MNU_ID      = #{fnlMnuId}         /* 최종메뉴ID */			  

         
         <if test='apvStaCd != null and apvStaCd != ""'>		  
			 ,APV_STA_CD      = #{apvStaCd}         /* 결재상태코드 */
		 </if>
		  	
		 <if test='apvStaDt != null and apvStaDt != ""'>		  
		  	 ,APV_STA_DT      = REPLACE(#{apvStaDt},'-','')          /* 결재상태일 */
		 </if>
		  	
		 <if test='dtmYn != null and dtmYn != ""'>
		  	 ,DTM_YN          = #{dtmYn}             /* 확정여부 */
		 </if>
		  	
		 <if test='mngYr != null and mngYr != ""'>
		  	 ,MNG_YR          = #{mngYr}             /* 관리년도 */
		 </if>
		  	
		 <if test='mngNo != null and mngNo != ""'>		  
		  	 ,MNG_NO          = #{mngNo}             /* 관리번호 */
		 </if>

		 <if test='spcnMngStaCd != null and spcnMngStaCd != ""'>		  
		  	 ,SPCN_MNG_STA_CD = #{spcnMngStaCd}    /* 특수관리상태코드 */
		 </if>
		 
        WHERE AUD_YR          = #{audYr}             /* 감사년도 */
		  AND AUD_NO          = #{audNo}             /* 감사번호 */
          AND DSP_RQ_SNO      = #{dspRqSno}         /* 처분요구순번 */
          AND RLTN_ORG_CD     = #{rltnOrgCd}        /* 관계기관코드 */
          AND MNG_SNO         = #{mngSno}            /* 관리순번 */
	</update>		
	
	<!-- 특수관리기본의 max관리번호를 조회한다. BADFRE014EMaxMngNoselect-->
	<select id="selectMaxMngNo" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.ewm.dao.AEPEWM006EMapper.selectMaxMngNo */
        SELECT NVL(MAX(MNG_NO),0) + 1 AS MNG_NO
          FROM TBBADFRE011M /* 특수관리기본 */
         WHERE MNG_YR = #{mngYr}	
	</select>
	
	<!-- 처분요구사항상세 수정  BADFRE014EDspRqSbjDtlupdate-->
	<update id="updateDspRqSbjDtl" parameterType="paramMap">
	/* kr.go.bai.eip.aep.ewm.dao.AEPEWM006EMapper.updateDspRqSbjDtl */
        UPDATE TBBADEAR002D                                  /* 처분요구사항 상세 */ 
		  SET FNL_MDF_DH           = SYSDATE                 /* 최종수정일시 */ 
             ,FNL_USR_ID           = #{fnlUsrId}            /* 최종사용자ID */       
             ,FNL_DEAL_DPT_CD      = #{fnlDealDptCd}       /* 최종거래부서코드 */
             ,FNL_MNU_ID           = #{fnlMnuId}            /* 최종메뉴ID */
             ,ENFM_WHLS_DTM_DT     = DECODE(#{dtmStaCd},'2',TO_CHAR(SYSDATE,'YYYYMMDD'),'')
             ,ENFM_WHLS_DTM_PEN_ID = DECODE(#{dtmStaCd},'2',#{cnb},'')
             ,DTM_STA_CD           = #{dtmStaCd}
        WHERE AUD_YR               = #{audYr}                /* 감사년도 */
		  AND AUD_NO               = #{audNo}                /* 감사번호 */
          AND DSP_RQ_SNO           = #{dspRqSno}            /* 처분요구순번 */
	</update>		
	
	
	<!-- (출력물)특수관리사항확정 목록조회-->
	<select id="BADFRE014EReportListselect" parameterType="paramMap" resultType="egovMap">
	      SELECT
	            <!-- 조회조건 -->
	             CASE WHEN #{spcnmngstacd} = '1' THEN '지정접수' 
	                  WHEN #{spcnmngstacd} = '2' THEN '지정확정'
	                  WHEN #{spcnmngstacd} = '3' THEN '해제접수'
	                  WHEN #{spcnmngstacd} = '4' THEN '해제확정' 
	                  ELSE                         '전체'
	              END                                            AS CND_ASG_DVSN      /* 지정구분 */
	            ,CASE WHEN #{dptcd} = '' THEN '전체' 
	                  ELSE F_DPT_INFO(#{dptcd},'1')  
	              END                                            AS CND_SPV_BRDV_NM   /* 주관국과 */
	            ,#{schtxt}                                     AS CND_SCH_TXT       /* 검색어 */
	      
                <!-- 목록 --> 
                /* ,F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || D1.DSP_RQ_SNO */
                
                ,NVL2(D2.ACT_DSP_NM,D2.ACT_DSP_NM, F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || D1.DSP_RQ_SNO   )
                                                                 AS DSP_RQ_NO       /* 처분요구번호(관리번호) */	  
 		     	, CASE WHEN D2.AUD_YR >= '2016' 
			                THEN SUBSTR(T1.AUD_KND_CD,3,1)
			           ELSE '' 
			       END                                           AS AUD_YR_NO_KND_CD /*감사연번호종류코드 추가 - 2015.12.24 yyh*/	                  
                ,F_ORG_INFO(D1.MNG_ORG_CD,'1') || '(' ||
                 D1.CPS_DRTR_NM || ')'                           AS ORG_DRTR_NM  /* 관리기관(책임자) */   	      
                ,D2.TIT_TXT                                      AS TIT_TXT      /* 제목내용 */
                ,F_DPT_INFO(D1.SPV_BRDV_CD,'1')                  AS SPV_BRDV_NM  /* 주관국과명 */                
                ,D1.ASG_AM                                       AS ASG_AM       /* 지정금액 */                
                ,D1.RQS_DT                                       AS RQS_DT       /* 요청일 */
                ,TO_CHAR(TO_DATE(D1.ASG_DT),'YYYY-MM-DD') AS ASG_DT                                       AS ASG_DT       /* 지정일 */                
                ,D1.RLS_DT                                       AS RLS_DT       /* 해제일 */                
                ,CASE WHEN D1.APV_STA_CD IS NULL THEN '미상신'
                      ELSE F_CODE_NM('1000603', D1.APV_STA_CD)
                  END                                            AS APV_STA_NM  /* 결재상태명               */                
                ,CASE WHEN NVL(D1.DTM_YN,'N')   != 'Y' 
                           AND D1.ASG_DT        IS NOT NULL                 
        	               AND D1.RLS_DT        IS NULL     THEN '지정X'
        	          WHEN NVL(D1.DTM_YN,'N')   = 'Y'                  
        	               AND D1.ASG_DT        IS NOT NULL                  
    	                   AND D1.RLS_DT        IS NULL     THEN '지정O'
    	              WHEN NVL(D1.DTM_YN,'N')  != 'Y'                 
    	                   AND D1.RLS_DT        IS NOT NULL THEN '해제X'
    	              WHEN NVL(D1.DTM_YN,'N')   = 'Y'                  
    	                   AND D1.RLS_DT        IS NOT NULL THEN '해제O'
    	             END                                         AS DVSN         /* 확정 */
           FROM TBBADFRE011M D1                   /* 특수관리기본 */
               ,TBBADEAR001M D2                   /* 처분요구사항기본 */
               ,TBBADDED001M T1
          WHERE 1=1
            AND D1.AUD_YR               = D2.AUD_YR    
        	AND D1.AUD_NO               = D2.AUD_NO     
        	AND D1.DSP_RQ_SNO           = D2.DSP_RQ_SNO   
            AND D1.AUD_YR               = T1.AUD_YR    
        	AND D1.AUD_NO               = T1.AUD_NO           	           
            AND D1.SLF_PRSS_STA_CD  &gt;= '71'
            AND NVL(D1.APV_STA_CD, '1') = '3'  /* 결재완료 상태 */
          
           		AND D1.SPV_BRDV_CD   IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#{cnb}, #{dptauth}, '', #{dptcd})))
           		
            <!-- 주관국과코드 -->    
		<if test='dptcd2 != null and dptcd2 != ""'>
                AND D1.SPV_BRDV_CD = #{dptcd2}
            </if> 
            
            <!-- 지정접수 -->
		<if test='spcnmngstacd == "1"'>
                AND NVL(D1.DTM_YN,'N') != 'Y'                           
        	    AND D1.ASG_DT IS NOT NULL                            
        	    AND D1.RLS_DT IS NULL
	        </if>     
            <!-- 지정확정 -->
		<if test='spcnmngstacd == "2"'>
                AND NVL(D1.DTM_YN,'N') = 'Y'                            
                AND D1.ASG_DT IS NOT NULL                            
                AND D1.RLS_DT IS NULL     
	        </if>                 
            <!-- 해제접수 -->
		<if test='spcnmngstacd == "3"'>
                AND NVL(D1.DTM_YN,'N') != 'Y'                           
                AND D1.RLS_DT IS NOT NULL     
	        </if>               
            <!-- 해제확정 -->
		<if test='spcnmngstacd == "4"'>
                AND NVL(D1.DTM_YN,'N') = 'Y'                           
                AND D1.RLS_DT IS NOT NULL     
	        </if>      
	        
			<!-- 검색어 -->
		<if test='schtxt != null and schtxt != ""'>
                AND ( (SELECT ORG_NM 
                         FROM TBDCMACM015M                                
        		        WHERE ORG_CD = D1.MNG_ORG_CD) LIKE  '%' || #{schtxt} || '%'
        		     OR D1.CPS_DRTR_NM  LIKE  '%' || #{schtxt} || '%'
        		     OR D2.TIT_TXT      LIKE  '%' || #{schtxt} || '%'
        		    )
            </if>
            
            <!-- 감사연번 -->
		<if test='audYr != null and audYr != ""'>
                AND D1.AUD_YR = #{audYr}
            </if>
		<if test='inqaudgrnno != null and inqaudgrnno != ""'>
                AND T1.AUD_GRN_NO = #{inqaudgrnno}
            </if>     
                   
		<if test='audYrNoKndCd != null and audYrNoKndCd != ""'>
		              /* 감사연번종류코드 - 2015.12.24 yyh */
					  AND SUBSTR(T1.AUD_KND_CD,3,1) = #{audYrNoKndCd} 
				</if>		
			                        
        ORDER BY D1.AUD_YR DESC 
               , D1.AUD_NO DESC
               , D1.DSP_RQ_SNO DESC
               , D1.RLTN_ORG_CD DESC
               , D1.MNG_SNO DESC               
	</select>	
	
	<!-- 특수관리기본변경이력 입력 BADFRE014EChgHstinsert -->
	<insert id="insertChgHst" parameterType="paramMap">
	/*  kr.go.bai.eip.aep.ewm.dao.AEPEWM005EMapper.insertChgHst  */
            INSERT INTO TBBADFRE027H           /* 특수관리기본변경이력           */
            (
                     CON_NO                    /* 연계번호                       */
                    ,AUD_YR                    /* 감사년도                       */
                    ,AUD_NO                    /* 감사번호                       */
                    ,DSP_RQ_SNO                /* 처분요구순번                   */
                    ,RLTN_ORG_CD               /* 관계기관코드                   */
                    ,MNG_SNO                   /* 관리순번                       */
                    ,SPV_BRDV_CD               /* 주관국과코드                   */
                    ,DTM_YN                    /* 확정여부                       */
                    ,MNG_ORG_CD                /* 관리기관코드                   */
                    ,ASG_DT                    /* 지정일                         */
                    ,ASG_AM                    /* 지정금액                       */
                    ,CPS_DRTR_NM               /* 변상책임자명                   */
                    ,CPS_DRTR_AD               /* 변상책임자주소                 */
                    ,RLS_DT                    /* 해제일                         */
                    ,RLS_RSN                   /* 해제사유                       */
                    ,RQR_ID                    /* 요청자ID                       */
                    ,RQS_DT                    /* 요청일                         */
                    ,RQS_RSN                   /* 요청사유                       */
                    ,APV_DOC_NO                /* 결재문서번호                   */
                    ,APV_STA_CD                /* 결재상태코드                   */
                    ,APV_STA_DT                /* 결재상태일                     */
                    ,MNG_YR                    /* 관리년도                       */
                    ,MNG_NO                    /* 관리번호                       */
                    ,SLF_PRSS_STA_CD           /* 자체진행상태코드               */
                    ,SLF_APV_DT                /* 자체결재일                     */
                    ,SLF_SEN_DT                /* 자체발송일                     */
                    ,SPCN_MNG_STA_CD           /* 특수관리상태코드               */
                    ,ASG_RSN                   /* 지정사유                       */
                    ,EXAM_RPT_FRM_ENFM_HIS     /* 검토보고서식집행내역           */
                    ,EXAM_RPT_FRM_ASG_RSN      /* 검토보고서식지정사유           */
                    ,EXAM_RPT_FRM_EXAM_OPIN    /* 검토보고서식검토의견           */
                    ,EXAM_RPT_FRM_APV_STA_CD   /* 검토보고서식결재상태코드       */
                    ,EXAM_RPT_FRM_APV_STA_DT   /* 검토보고서식결재상태일         */
                    ,EXAM_RPT_FRM_APV_DOC_NO   /* 검토보고서식결재문서번호       */
                    ,DOC_ID                    /* 문서ID                         */
                    ,DOC_TYP_CD                /* 문서유형코드                   */
                    ,USE_YN                    /* 사용여부                       */
                    ,CON_RTRN_CD               /* 연계반환코드                   */
                    ,FRT_USR_ID                /* 최초사용자ID                   */
                    ,FNL_USR_ID                /* 최종사용자ID                   */
                    ,FNL_DEAL_DPT_CD           /* 최종거래부서코드               */
                    ,FNL_MNU_ID                /* 최종메뉴ID                     */
                    ,FRT_REGI_DH               /* 최초등록일시                   */
                    ,FNL_MDF_DH                /* 최종수정일시                   */
            ) 
              SELECT                     
                     (SELECT NVL(MAX(CON_NO),0) + 1
                        FROM TBBADFRE027H)                                 
                    ,AUD_YR           
                    ,AUD_NO             
                    ,DSP_RQ_SNO       
                    ,RLTN_ORG_CD       
                    ,MNG_SNO           
                    ,SPV_BRDV_CD            
                    ,DTM_YN                 
                    ,MNG_ORG_CD             
                    ,ASG_DT                 
                    ,ASG_AM                 
                    ,CPS_DRTR_NM            
                    ,CPS_DRTR_AD            
                    ,RLS_DT                 
                    ,RLS_RSN                
                    ,RQR_ID                 
                    ,RQS_DT                 
                    ,RQS_RSN                
                    ,APV_DOC_NO             
                    ,APV_STA_CD             
                    ,APV_STA_DT             
                    ,MNG_YR                 
                    ,MNG_NO                 
                    ,SLF_PRSS_STA_CD        
                    ,SLF_APV_DT             
                    ,SLF_SEN_DT             
                    ,SPCN_MNG_STA_CD        
                    ,ASG_RSN                
                    ,EXAM_RPT_FRM_ENFM_HIS  
                    ,EXAM_RPT_FRM_ASG_RSN   
                    ,EXAM_RPT_FRM_EXAM_OPIN 
                    ,EXAM_RPT_FRM_APV_STA_CD
                    ,EXAM_RPT_FRM_APV_STA_DT
                    ,EXAM_RPT_FRM_APV_DOC_NO
                    ,DOC_ID                 
                    ,DOC_TYP_CD             
                    ,'N'           AS USE_YN            
                    ,''            AS CON_RTRN_CD  
                    ,#{fnlUsrId}       
                    ,#{fnlUsrId}       
                    ,#{fnlDealDptCd}  
                    ,#{fnlMnuId}       
                    ,SYSDATE            
                    ,SYSDATE            
                FROM TBBADFRE011M     /* 특수관리기본 */
               WHERE 1=1
                 AND AUD_YR         = #{audYr}
                 AND AUD_NO         = #{audNo}
                 AND DSP_RQ_SNO     = #{dspRqSno} 
                 AND RLTN_ORG_CD    = #{rltnOrgCd}
                 AND MNG_SNO        = #{mngSno}
	</insert>
	
	
		<!-- (출력물)특수관리사항확정 목록조회  BADFRE014EReportListselect-->
		<select id="selectReportList" parameterType="paramMap" resultType="resultMap">
		
		/* kr.go.bai.eip.aep.ewm.dao.AEPEWM006EMapper.selectReportList */
	      SELECT
	            <!-- 조회조건 -->
	             CASE WHEN #{spCnMngStaCd} = '1' THEN '지정접수' 
	                  WHEN #{spCnMngStaCd} = '2' THEN '지정확정'
	                  WHEN #{spCnMngStaCd} = '3' THEN '해제접수'
	                  WHEN #{spCnMngStaCd} = '4' THEN '해제확정' 
	                  ELSE                         '전체'
	              END                                            AS CND_ASG_DVSN      /* 지정구분 */
	            ,CASE WHEN #{upSpvBrdvCd} = '' THEN '전체' 
	                  ELSE F_DPT_INFO(#{upSpvBrdvCd},'1')  
	              END                                            AS CND_SPV_BRDV_NM   /* 주관국과 */
	            ,#{schTxt}                                     AS CND_SCH_TXT       /* 검색어 */
	      
                <!-- 목록 --> 
                /* ,F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || D1.DSP_RQ_SNO */
                ,NVL2(D2.ACT_DSP_NM,D2.ACT_DSP_NM, F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || D1.DSP_RQ_SNO   )
                                                                 AS DSP_RQ_NO       /* 처분요구번호(관리번호) */	  
 		     	, CASE WHEN D2.AUD_YR >= '2016' 
			                THEN SUBSTR(T1.AUD_KND_CD,3,1)
			           ELSE '' 
			       END                                           AS AUD_YR_NO_KND_CD /*감사연번호종류코드 추가 - 2015.12.24 yyh*/	                  
                ,F_ORG_INFO(D1.MNG_ORG_CD,'1') || '(' ||
                 D1.CPS_DRTR_NM || ')'                           AS ORG_DRTR_NM  /* 관리기관(책임자) */   	      
                ,D2.TIT_TXT                                      AS TIT_TXT      /* 제목내용 */
                ,F_DPT_INFO(D1.SPV_BRDV_CD,'1')                  AS SPV_BRDV_NM  /* 주관국과명 */                
                ,D1.ASG_AM                                       AS ASG_AM       /* 지정금액 */                
                ,D1.RQS_DT                                       AS RQS_DT       /* 요청일 */
                ,D1.ASG_DT                                       AS ASG_DT       /* 지정일 */                
                ,D1.RLS_DT                                       AS RLS_DT       /* 해제일 */                
                ,CASE WHEN D1.APV_STA_CD IS NULL THEN '미상신'
                      ELSE F_CODE_NM('1000603', D1.APV_STA_CD)
                  END                                            AS APV_STA_NM  /* 결재상태명               */                
                ,CASE WHEN NVL(D1.DTM_YN,'N')   != 'Y' 
                           AND D1.ASG_DT        IS NOT NULL                 
        	               AND D1.RLS_DT        IS NULL     THEN '지정X'
        	          WHEN NVL(D1.DTM_YN,'N')   = 'Y'                  
        	               AND D1.ASG_DT        IS NOT NULL                  
    	                   AND D1.RLS_DT        IS NULL     THEN '지정O'
    	              WHEN NVL(D1.DTM_YN,'N')  != 'Y'                 
    	                   AND D1.RLS_DT        IS NOT NULL THEN '해제X'
    	              WHEN NVL(D1.DTM_YN,'N')   = 'Y'                  
    	                   AND D1.RLS_DT        IS NOT NULL THEN '해제O'
    	             END                                         AS DVSN         /* 확정 */
           FROM TBBADFRE011M D1                   /* 특수관리기본 */
               ,TBBADEAR001M D2                   /* 처분요구사항기본 */
               ,TBBADDED001M T1
          WHERE 1=1
            AND D1.AUD_YR               = D2.AUD_YR    
        	AND D1.AUD_NO               = D2.AUD_NO     
        	AND D1.DSP_RQ_SNO           = D2.DSP_RQ_SNO   
            AND D1.AUD_YR               = T1.AUD_YR    
        	AND D1.AUD_NO               = T1.AUD_NO 

            AND D1.SPV_BRDV_CD   IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#{strCnb}, #{strDptAuth}, '', #{upSpvBrdvCd})))
            <!-- 주관국과코드 -->    
			<if test='spvBrdvCd != null and spvBrdvCd != ""'>
                AND D1.SPV_BRDV_CD = #{spvBrdvCd}
            </if> 
            
            <!-- 지정접수 -->
			<if test='spCnMngStaCd == "1"'>
                AND NVL(D1.DTM_YN,'N') != 'Y'                           
        	    AND D1.ASG_DT IS NOT NULL                            
        	    AND D1.RLS_DT IS NULL
	        </if>     
            <!-- 지정확정 -->
			<if test='spCnMngStaCd == "2"'>
                AND NVL(D1.DTM_YN,'N') = 'Y'                            
                AND D1.ASG_DT IS NOT NULL                            
                AND D1.RLS_DT IS NULL     
	        </if>                 
            <!-- 해제접수 -->
			<if test='spCnMngStaCd == "3"'>
                AND NVL(D1.DTM_YN,'N') != 'Y'                           
                AND D1.RLS_DT IS NOT NULL     
	        </if>               
            <!-- 해제확정 -->
			<if test='spCnMngStaCd == "4"'>
                AND NVL(D1.DTM_YN,'N') = 'Y'                           
                AND D1.RLS_DT IS NOT NULL     
	        </if>      
	        
			<!-- 검색어 -->
			<if test='schTxt != null and schTxt != ""'>
                AND ( (SELECT ORG_NM 
                         FROM TBDCMACM015M                                
        		        WHERE ORG_CD = D1.MNG_ORG_CD) LIKE  '%' || #{schTxt} || '%'
        		     OR D1.CPS_DRTR_NM  LIKE  '%' || #{schTxt} || '%'
        		     OR D2.TIT_TXT      LIKE  '%' || #{schTxt} || '%'
        		    )
            </if>
           
            <!-- 감사연번 -->
			<if test='audYr != null and audYr != ""'>
                AND D1.AUD_YR = #{audYr}
            </if>
			<if test='audGrnNo != null and audGrnNo != ""'>
                AND D4.AUD_GRN_NO = #{audGrnNo}
            </if>  
                       
			<if test='audYrNoKndCd != null and audYrNoKndCd != ""'>
	              /* 감사연번종류코드 - 2015.12.24 yyh */
				  AND SUBSTR(D4.AUD_KND_CD,3,1) = #{audYrNoKndCd} 
			</if>
			                       
        ORDER BY D1.AUD_YR DESC 
               , D1.AUD_NO DESC
               , D1.DSP_RQ_SNO DESC
               , D1.RLTN_ORG_CD DESC
               , D1.MNG_SNO DESC           
	</select>
</mapper> 
