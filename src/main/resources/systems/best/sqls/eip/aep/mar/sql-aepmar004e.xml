<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.mar.dao.AEPMAR004EMapper">
		<select id="selectMajorAudDocMngList" parameterType="paramMap" resultType="egovMap">
		/*kr.go.bai.eip.aep.mar.dao.AEPMAR004EMapper.selectMajorAudDocMngList*/
			<include refid="include.pageSelct" />
			<![CDATA[		
				SELECT F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, B.AUD_KND_CD, '-') AS AUD_YR_NO
					   	, C.AUD_SBJ_NM
					   	, F_ORG_INFO(C.AUD_RPST_ORG_CD, '1') AS AUD_RPST_ORG_NM
						, F_DPT_INFO(C.MNG_DPT_CD,'1') AS MNG_DPT_NM
						, F_CODE_NM('1000786',B.RPRT_CD) AS AUD_DOC_NM
						, B.RPRT_NM
						, F_DPT_INFO((SELECT DPT_CD FROM TBDCMACM001M WHERE USR_ID = A.RQS_ID),'1') AS REQ_DPT_NM	
						, F_USR_INFO_BY_ID(A.RQS_ID,'2') AS REQ_NM					
				 		, CASE WHEN A.READ_ST_DH IS NOT NULL AND A.READ_END_DH IS NOT NULL THEN TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || ' ~ ' || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
					   	   		   ELSE TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
				       	   END AS READ_DH
					 	, CASE WHEN A.PRSS_CD = '10' THEN '승인대기'
					  	   		 WHEN A.PRSS_CD = '20' THEN '취소'
					  	   		 WHEN A.PRSS_CD = '30' THEN '승인'
					  	   		 WHEN A.PRSS_CD = '40' THEN '반려'
					   	   END AS PRSS_NM
						, A.RET_RSN
						, A.SRNO
				    	, A.PRSS_CD
				    	, A.REF_DOC_ID
				    	, A.DOC_ID
				    	, A.RQS_ID
				    	, (SELECT DPT_CD FROM TBDCMACM001M WHERE USR_ID = A.RQS_ID) 			AS REQ_DPT_CD
				 		, TO_CHAR(A.READ_ST_DH,'YYYYMMDD') 		AS READ_ST_DH
				 		, TO_CHAR(A.READ_END_DH,'YYYYMMDD') 		AS READ_END_DH
				    	, A.AUD_YR
				    	, A.AUD_NO
				    	, A.AUD_STEP_CD
				    	, C.AUD_KND_CD
				    	, A.APV_RQS_ID
				    	, A.APV_STA_CD
						, B.RPRT_CD
						, A.RET_RSN
						, A.RQS_REGI_DT						
						, (CASE WHEN B.LINK_URL IS NULL             THEN ''
						      	  WHEN INSTR(B.LINK_URL,'hancom') = 0 THEN 'polaris' 
						      	  ELSE 'hancom' 
						   END ) AS DOC_TYPE								
				FROM TBAEPMAR001M A 
		 INNER JOIN TBBADDED001M C 
					ON A.AUD_YR = C.AUD_YR 
				  AND A.AUD_NO = C.AUD_NO
  LEFT OUTER JOIN TBBADDED103M B
				   ON A.AUD_YR = B.AUD_YR 
				  AND A.AUD_NO = B.AUD_NO
				  AND A.REF_DOC_ID = B.DOC_ID
				  AND A.AUD_STEP_CD = B.AUD_STEP_CD	   
			   WHERE 1=1
				]]>
		           <if test="schAudYr != null and schAudYr != ''">
		                    AND C.AUD_YR  = #{schAudYr}
		           </if>
		           <if test="schAudYrNoKndCd != null and schAudYrNoKndCd != ''">
		                    AND C.AUD_KND_CD = #{schAudYrNoKndCd}
		           </if>
		           <if test="schAudNo != null and schAudNo != ''">
		                    AND B.AUD_GRN_NO = #{schAudNo}
		           </if>
		           <if test="schAudSbjNm != null and schAudSbjNm != ''">
		                    AND C.AUD_SBJ_NM LIKE '%'|| #{schAudSbjNm} || '%'
		           </if>
		           <if test="schDeptCd != null and schDeptCd != ''">
		                    AND (SELECT DPT_CD FROM TBDCMACM001M WHERE USR_ID = A.RQS_ID) = #{schDeptCd}
		           </if>
		           <if test="schRprtNm != null and schRprtNm != ''">
		                    AND B.RPRT_NM LIKE '%' || #{schRprtNm} || '%'
		           </if>
		           <if test="schPrssCd != null and schPrssCd != ''">
		                    AND A.PRSS_CD = #{schPrssCd}
		           </if>
		           <if test="dptCd != null and dptCd != ''">
		                    AND C.MNG_DPT_CD  = #{dptCd}
		           </if>
			<![CDATA[	
	UNION ALL	/*2017년 이전 데이터*/
				SELECT F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, C.AUD_KND_CD, '-') AS AUD_YR_NO
					   	, C.AUD_SBJ_NM
					   	, F_ORG_INFO(C.AUD_RPST_ORG_CD, '1') AS AUD_RPST_ORG_NM
						, F_DPT_INFO(C.MNG_DPT_CD,'1') AS MNG_DPT_NM
						, F_CODE_NM('1000786',D.DOC_TYP_CD) AS AUD_DOC_NM
						, B.FILE_NAME AS RPRT_NM
						, F_DPT_INFO((SELECT DPT_CD FROM TBDCMACM001M WHERE USR_ID = A.RQS_ID),'1') AS REQ_DPT_NM	
						, F_USR_INFO_BY_ID(A.RQS_ID,'2') AS REQ_NM					
				 		, CASE WHEN A.READ_ST_DH IS NOT NULL AND A.READ_END_DH IS NOT NULL THEN TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || ' ~ ' || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
					   	   		   ELSE TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
				       	   END AS READ_DH
					 	, CASE WHEN A.PRSS_CD = '10' THEN '승인대기'
					  	   		 WHEN A.PRSS_CD = '20' THEN '취소'
					  	   		 WHEN A.PRSS_CD = '30' THEN '승인'
					  	   		 WHEN A.PRSS_CD = '40' THEN '반려'
					   	   END AS PRSS_NM
						, A.RET_RSN
						, A.SRNO
				    	, A.PRSS_CD
				    	, A.REF_DOC_ID
				    	, A.DOC_ID
				    	, A.RQS_ID
				    	, (SELECT DPT_CD FROM TBDCMACM001M WHERE USR_ID = A.RQS_ID) 			AS REQ_DPT_CD
				 		, TO_CHAR(A.READ_ST_DH,'YYYYMMDD') 		AS READ_ST_DH
				 		, TO_CHAR(A.READ_END_DH,'YYYYMMDD') 		AS READ_END_DH
				    	, A.AUD_YR
				    	, A.AUD_NO
				    	, A.AUD_STEP_CD
				    	, C.AUD_KND_CD
				    	, A.APV_RQS_ID
				    	, A.APV_STA_CD
						, D.DOC_TYP_CD AS RPRT_CD
						, A.RET_RSN
						, A.RQS_REGI_DT							
						, 'hancom' AS DOC_TYPE							
				FROM TBAEPMAR001M A 
		INNER JOIN UBKERAPP.ECM_FILE_LIST_VIEW2 B
				   ON A.DOC_ID = B.DOC_ID	  
		INNER JOIN TBBADDED001M C 
				   ON A.AUD_YR = C.AUD_YR 
				 AND A.AUD_NO = C.AUD_NO
		INNER JOIN TBBADDED021M	  D
				  ON A.AUD_YR = D.AUD_YR 
				AND A.AUD_NO = D.AUD_NO 
			   WHERE 1=1
				]]>
		           <if test="schAudYr != null and schAudYr != ''">
		                    AND C.AUD_YR  = #{schAudYr}
		           </if>
		           <if test="schAudYrNoKndCd != null and schAudYrNoKndCd != ''">
		                    AND C.AUD_KND_CD = #{schAudYrNoKndCd}
		           </if>
		           <if test="schAudNo != null and schAudNo != ''">
		                    AND D.AUD_NO = #{schAudNo}
		           </if>
		           <if test="schAudSbjNm != null and schAudSbjNm != ''">
		                    AND C.AUD_SBJ_NM LIKE '%'|| #{schAudSbjNm} || '%'
		           </if>
		           <if test="schDeptCd != null and schDeptCd != ''">
		                    AND C.MNG_DPT_CD = #{schDeptCd}
		           </if>
		           <if test="schRprtNm != null and schRprtNm != ''">
		                    AND B.FILE_NAME LIKE '%' || #{schRprtNm} || '%'
		           </if>
		           <if test="schPrssCd != null and schPrssCd != ''">
		                    AND A.PRSS_CD = #{schPrssCd}
		           </if>
		           <if test="dptCd != null and dptCd != ''">
		                    AND C.MNG_DPT_CD  = #{dptCd}
		           </if>		           
		   <![CDATA[	                 
		    	ORDER BY A.RQS_REGI_DT DESC
		    ]]>
		<include refid="include.pageOrder" />	
	</select>
	
	<select id="selectCopyMajorAudDocList" parameterType="paramMap" resultType="egovMap">
	/*kr.go.bai.eip.aep.mar.dao.AEPMAR001QMapper.selectCopyMajorAudDocList*/
	<![CDATA[
			 SELECT F_CODE_NM('1000786',B.RPRT_CD) AS AUD_DOC_NM
			     	 , B.RPRT_NM
				 	 , B.RPRT_CD 
			     	 , F_USR_INFO_BY_ID(A.FRT_USR_ID,'2') AS DOC_WRT_NM	
			     	 , CASE WHEN A.APV_STA_CD = '10' THEN '작성완료'
			     	 		WHEN A.APV_STA_CD = '20' THEN '결재요청'
			     	 		WHEN A.APV_STA_CD = '30' THEN '결재완료'
			     	 	END AS APV_STA_NM
			     	 , A.APV_RQS_ID
			     	 , A.APV_STA_CD
                     , (SELECT APV_USR_NM 
                    	 FROM (SELECT F_USR_INFO(APVR_CNB,'2') || DECODE(APV_DH,NULL,'','('||TO_CHAR(APV_DH,'YYYY-MM-DD')||')') AS APV_USR_NM,
                            			   APV_DOC_NO
                         		   FROM TBDCMACM023L
                         		  WHERE APVR_KND_CD = '3'
                              ORDER BY APV_SNO DESC)
                      WHERE ROWNUM = 1
                         AND APV_DOC_NO = B.APV_RQS_ID) AS APV_USR_NM				     	 
			     	 , A.DOC_ID
			    	 , A.AUD_YR
			     	 , A.AUD_NO
			    	 , A.AUD_STEP_CD
			    	 , C.AUD_KND_CD
			    	 , A.SRNO
			    	 , TO_CHAR(A.READ_ST_DH,'YYYYMMDD') 		AS READ_ST_DH
			    	 , TO_CHAR(A.READ_END_DH,'YYYYMMDD') 	AS READ_END_DH
					 , CASE WHEN A.PRSS_CD = '10' and A.APV_STA_CD = '10' THEN 'Y'
						      ELSE 'N'
					    END AS APV_YN					    	 
					, (CASE WHEN B.LINK_URL IS NULL             THEN ''
					      	  WHEN INSTR(B.LINK_URL,'hancom') = 0 THEN 'polaris' 
					      	  ELSE 'hancom' 
					   END ) AS DOC_TYPE				    	 
			  FROM TBAEPMAR001M A
		INNER JOIN TBBADDED001M C 
				ON A.AUD_YR = C.AUD_YR 
			   AND A.AUD_NO = C.AUD_NO 
   LEFT OUTER JOIN TBBADDED103M B
			    ON B.AUD_YR = A.AUD_YR 
			   AND B.AUD_NO = A.AUD_NO
			   AND B.DOC_ID = A.REF_DOC_ID
			   AND B.AUD_STEP_CD = A.AUD_STEP_CD
			 WHERE A.PRSS_CD = '10'
			   AND A.APV_STA_CD IN ('10','20','30')
		]]>
	           <if test="dptCd != null and dptCd != ''">
	                    AND C.MNG_DPT_CD  = #{dptCd}
	           </if>
		<![CDATA[
	UNION ALL	/*2017년 이전 데이터*/
			 SELECT F_CODE_NM('1000786',D.DOC_TYP_CD) AS AUD_DOC_NM
			     	 , B.FILE_NAME AS RPRT_NM
				 	 , D.DOC_TYP_CD AS RPRT_CD
			     	 , F_USR_INFO_BY_ID(A.FRT_USR_ID,'2') AS DOC_WRT_NM	
			     	 , CASE WHEN A.APV_STA_CD = '10' THEN '작성완료'
			     	 		WHEN A.APV_STA_CD = '20' THEN '결재요청'
			     	 		WHEN A.APV_STA_CD = '30' THEN '결재완료'
			     	 	END AS APV_STA_NM
			     	 , A.APV_RQS_ID
			     	 , A.APV_STA_CD
			     	 , '' AS APV_USR_NM
			     	 , A.DOC_ID
			    	 , A.AUD_YR
			     	 , A.AUD_NO
			    	 , A.AUD_STEP_CD
			    	 , C.AUD_KND_CD
			    	 , A.SRNO
			    	 , TO_CHAR(A.READ_ST_DH,'YYYYMMDD') 	AS READ_ST_DH
			    	 , TO_CHAR(A.READ_END_DH,'YYYYMMDD') 	AS READ_END_DH
					 , CASE WHEN A.PRSS_CD = '10' and A.APV_STA_CD = '10' THEN 'Y'
						      ELSE 'N'
					    END AS APV_YN					    	 
					 , 'hancom'  AS DOC_TYPE				    	 
			  FROM TBAEPMAR001M A
		INNER JOIN UBKERAPP.ECM_FILE_LIST_VIEW2 B
				ON A.DOC_ID = B.DOC_ID	  
		INNER JOIN TBBADDED001M C 
				ON A.AUD_YR = C.AUD_YR 
			   AND A.AUD_NO = C.AUD_NO
		INNER JOIN TBBADDED021M	  D
				ON A.AUD_YR = D.AUD_YR 
			   AND A.AUD_NO = D.AUD_NO 
			 WHERE A.PRSS_CD = '10'
			   AND A.APV_STA_CD IN ('10','20','30')
		]]>
        <if test="dptCd != null and dptCd != ''">
                 AND C.MNG_DPT_CD  = #{dptCd}
        </if>
		<![CDATA[
		  ORDER BY A.SRNO
		]]>
	</select>	
	
	<update id="saveCopyMajorAudDocDel">
			/*kr.go.bai.eip.aep.mar.dao.AEPMAR004EMapper.saveCopyMajorAudDocDel*/
			UPDATE TBAEPMAR001M
			   SET DOC_ID = NULL
			   	 , APV_STA_CD = NULL
			   	 , READ_ST_DH = NULL
			   	 , READ_END_DH = NULL
			 WHERE SRNO 	= #{srno}
			   AND AUD_YR 	= #{audYr}
			   AND AUD_NO 	= #{audNo}
	</update>	
	
	<delete id="deleteCopyMajorAudDoc">
			/*kr.go.bai.eip.aep.mar.dao.AEPMAR004EMapper.deleteCopyMajorAudDoc*/
			DELETE FROM TBBADDED103M
			 WHERE AUD_YR = #{audYr}
			   AND AUD_NO = #{audNo}
			   AND AUD_STEP_CD = #{audStepCd}
			   AND DOC_ID = #{docId}
	</delete>		
</mapper> 