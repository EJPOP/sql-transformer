<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.arp.dao.AEPARP005PMapper">

    <select id="selectAffList" 
        resultType="egovMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP005PMapper.selectAffList */
        <![CDATA[
            SELECT 
                   F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-')||'-'||AA.AFF_CD AS AFF_FULL_CD
                 , AA.TITLE_NM
                 , F_USR_INFO(AA.TRTM_EXAMER_CNB, '2') AS TRTM_EXAMER_NM
                 , F_USR_INFO(AA.TRTM_EXAMER_CNB, '2') AS TRTM_EXAMER_NAM
                 , AA.AUD_YR
                 , AA.AUD_NO
                 , AA.AUD_STEP_CD
                 , AA.DOC_ID
                 , AA.APVR_CD
                 , AA.AFF_SNO
                 , AA.AFF_CD
                 , AA.TRTM_EXAMER_CNB
                 , AA.RPRT_FILD_ID
                 , (
                    SELECT MIN(BB.RPRT_NM)
                      FROM TBBADDED103M BB
                     WHERE AA.AUD_YR = BB.AUD_YR
                       AND AA.AUD_NO = BB.AUD_NO
                       AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                       AND BB.RPRT_CD = 'A10600500'
                       AND BB.REF_ID = TO_CHAR(AA.AFF_SNO)
                   ) AS RPRT_NM
                 , NVL((
                        SELECT MIN(BB.DOC_ID)
                          FROM TBBADDED103M BB
                         WHERE AA.AUD_YR = BB.AUD_YR
                           AND AA.AUD_NO = BB.AUD_NO
                           AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                           AND BB.RPRT_CD = 'A10600500'
                           AND BB.REF_ID = TO_CHAR(AA.AFF_SNO)
                       ), (
                           SELECT MIN(DOC_ID)
                             FROM TBFDMADM002M
                            WHERE AUD_DOC_CD = 'A10600500'
                          )) AS TMP_ID
                 , DECODE((
                           SELECT MIN(BB.DOC_ID)
                             FROM TBBADDED103M BB
                            WHERE AA.AUD_YR = BB.AUD_YR
                              AND AA.AUD_NO = BB.AUD_NO
                              AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                              AND BB.RPRT_CD = 'A10600500'
                              AND BB.REF_ID = TO_CHAR(AA.AFF_SNO)
                           ), NULL, 'N', 'Y') AS WRT_YN
                  , (
                     SELECT DECODE(COUNT(CC.DOC_ID), 0, 'Y', 'N')
                       FROM TBBADDED103M CC
                      WHERE AA.AUD_YR = CC.AUD_YR
                        AND AA.AUD_NO = CC.AUD_NO
                        AND AA.AUD_STEP_CD = CC.AUD_STEP_CD
                        AND CC.RPRT_CD = 'A10600400'
                        AND CC.REF_ID = AA.DOC_ID 
                    ) AS DEL_YN
                  , (
                     SELECT MIN(BB.APV_STA_CD)
                       FROM TBBADDED103M BB
                      WHERE AA.AUD_YR = BB.AUD_YR
                        AND AA.AUD_NO = BB.AUD_NO
                        AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                        AND BB.RPRT_CD = 'A10600500'
                        AND BB.REF_ID = TO_CHAR(AA.AFF_SNO)
                    ) AS APV_STA_CD
                  , NVL((
                    SELECT MIN(F_CODE_NM('1000773',NVL(BB.APV_STA_CD,'10')))
                       FROM TBBADDED103M BB
                      WHERE AA.AUD_YR = BB.AUD_YR
                        AND AA.AUD_NO = BB.AUD_NO
                        AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                        AND BB.RPRT_CD = 'A10600500'
                        AND BB.REF_ID = TO_CHAR(AA.AFF_SNO)
                    ), ' ') AS APV_STA_NM
                  , (
                     SELECT (
                             SELECT MIN(APV_USR_NM) 
                             FROM (
                                 SELECT 
                                    F_USR_INFO(APVR_CNB,'2') || 
                                    DECODE(APV_DH,NULL,'','('||TO_CHAR(APV_DH,'YYYY-MM-DD')||')') AS APV_USR_NM,
                                    APV_DOC_NO
                                 FROM TBDCMACM023L
                                 WHERE  
                                  APVR_KND_CD = '3'
                                 ORDER BY APV_SNO DESC)
                             WHERE ROWNUM = 1
                             AND APV_DOC_NO = BB.APV_RQS_ID )
                       FROM TBBADDED103M BB
                      WHERE AA.AUD_YR = BB.AUD_YR
                        AND AA.AUD_NO = BB.AUD_NO
                        AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                        AND BB.RPRT_CD = 'A10600500'
                        AND BB.REF_ID = TO_CHAR(AA.AFF_SNO)
                    ) AS APV_USR_NM
                  , (
                     SELECT MIN(DECODE(BB.APV_RQS_ID, NULL, 'Y', 'N'))
                       FROM TBBADDED103M BB
                      WHERE AA.AUD_YR = BB.AUD_YR
                        AND AA.AUD_NO = BB.AUD_NO
                        AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                        and BB.RPRT_CD = 'A10600500'
                        AND BB.REF_ID = TO_CHAR(AA.AFF_SNO)
                    ) AS APV_YN
                , (SELECT APV_RQS_ID
                        FROM TBBADDED103M BB
                        WHERE AA.AUD_YR = BB.AUD_YR
                        AND AA.AUD_NO = BB.AUD_NO
                        AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                        AND BB.RPRT_CD = 'A10600500'
                        AND BB.REF_ID = TO_CHAR(AA.AFF_SNO)
                    ) AS APV_RQS_ID
                 , F_OPEN_EDIT(BB.LINK_URL) AS DOC_TYPE
              FROM TBBADDED145M AA
                 , TBBADDED111M BB
             WHERE AA.AUD_YR = #{audYr}
               AND AA.AUD_NO = #{audNo}
               AND AA.AUD_STEP_CD = #{audStepCd}
               AND AA.DOC_ID = #{docId}
               AND AA.APVR_CD = '0013600'
               AND AA.AUD_YR = BB.AUD_YR
               AND AA.AUD_NO = BB.AUD_NO
               AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
               AND AA.DOC_ID = BB.DOC_ID
               AND BB.DOC_STA_CD = '20'
             ORDER BY AA.DETL_DOC_NO
        ]]>
    </select>

    <update id="updateTrtmExamer">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP005PMapper.updateTrtmExamer */
        <![CDATA[
            UPDATE TBBADDED145M
            SET TRTM_EXAMER_CNB  = #{trtmExamerCnb}
            WHERE
            AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = #{audStepCd}
            AND DOC_ID = #{docId}
            AND APVR_CD = #{apvrCd}
            AND AFF_SNO = #{affSno}
        ]]>
    </update>
    
    <select id="selectAudInfo" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPARP005PMapper.selectAudInfo */
        <![CDATA[
             SELECT 
                AUD_YR
                , AUD_NO
                , F_MNG_KND_AUDYRNO(AUD_YR, AUD_NO, AUD_KND_CD, '-')   AS AUD_YR_NO                 /*감사연번호*/
                , AUD_SBJ_NM                                                                            AS AUD_SBJ_NM                   /*감사사항명*/
                , F_CODE_NM('1000007',AUD_KND_CD)                                           AS AUD_KND_NM                   /*감사종류*/
                , F_CODE_NM('1000751',BZT_BGT_DVSN_CD)                              AS BZT_BGT_DVSN_NM          /*예산종류*/
                , F_DPT_INFO(SPV_BRDV_CD,'1')                                                   AS SPV_BRDV_NM                  /*주관국과명*/
                , F_DPT_INFO(MNG_DPT_CD,'1')                                                    AS MNG_DPT_NM                   /*관리부서명*/
                , F_ORG_INFO(AUD_RPST_ORG_CD,'1')                                       AS AUD_RPST_ORG_NM      /*대표기관명*/
                , F_CODE_NM('1000027',AUD_SCL_CD)                                           AS AUD_SCL_CD                   /*감사규모코드*/
                , CASE 
                    WHEN AUD_TOT_DRTR_CNB IS NULL then ''
                    ELSE F_USR_INFO(AUD_TOT_DRTR_CNB,'2')||'('||F_DPT_INFO(TOT_DRTR_BRDV_CD,'1')||'|'||F_CODE_NM('1000173',TOT_DRTR_RANK_CD)||')'
                    END                                                                                         AS AUD_TOT_DRTR_NM          /*감사단장*/
            FROM TBBADDED001M
            WHERE AUD_YR= #{audYr}
            AND AUD_NO = #{audNo}
        ]]>
    </select>
    
    <select id="selectTrtmExamerCnt" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPARP005PMapper.selectTrtmExamerCnt */
        <![CDATA[
            SELECT AUD_YR
                 , AUD_NO
                 , DOC_ID
                 , TRTM_EXAMER_CNB
                 , COUNT(TRTM_EXAMER_CNB) AS DTB_CNT
              FROM TBBADDED145M
             WHERE 1=1
               AND AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND DOC_ID = #{docId}
               AND TRTM_EXAMER_CNB IS NOT NULL
             GROUP BY AUD_YR, AUD_NO, DOC_ID, TRTM_EXAMER_CNB
        ]]>
    </select>
    
    <update id="deleteTrtmExamerCnt">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP005PMapper.deleteTrtmExamerCnt */
        <![CDATA[
            DELETE FROM TBBADDED119M
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND DOC_ID = #{docId}
        ]]>
    </update>
    
    <update id="updateTrtmLeader">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP005PMapper.updateTrtmLeader */
        <![CDATA[
            UPDATE TBBADDED103M
               SET REF_ID = #{hTrtmLeaderCnb}
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND DOC_ID = #{docId}
        ]]>
    </update>
    
    <update id="insertTrtmExamerCnt">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP005PMapper.insertTrtmExamerCnt */
        <![CDATA[
            INSERT INTO TBBADDED119M
            (
               AUD_YR
             , AUD_NO
             , DOC_ID
             , TRTM_EXAMER_CNB
             , DTB_CNT
             , FRT_USR_ID
             , FNL_USR_ID
             , FNL_DEAL_DPT_CD
             , FNL_MNU_ID
             , FRT_REGI_DH
             , FNL_MDF_DH
            )
            VALUES
            (
               #{audYr}
             , #{audNo}
             , #{docId}
             , #{trtmExamerCnb}
             , #{dtbCnt}
             , #{frtUsrId}
             , #{fnlUsrId}
             , #{fnlDealDptCd}
             , #{fnlMnuId}
             , SYSDATE
             , SYSDATE
            )
        ]]>
    </update>
    
    
    <select id="selectTrtmLeaderExamerCnb" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPARP005PMapper.selectTrtmLeaderExamerCnb */
        <![CDATA[
            SELECT MAX(REF_ID) AS REF_ID
              FROM TBBADDED103M
             WHERE 1=1
               AND AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND DOC_ID = #{docId}
        ]]>
    </select>
</mapper> 
