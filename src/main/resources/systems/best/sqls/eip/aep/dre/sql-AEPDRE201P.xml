<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.dre.dao.AEPDRE201PMapper">
	
	
	<!-- 처분요구관리 조회 -->
	<select id="selectDetail" parameterType="paramMap" resultType="egovMap" >
	/* kr.go.bai.eip.aep.dre.dao.AEPDRE201PMapper.selectDetail */
        <![CDATA[
			SELECT D1.AUD_YR                         AS AUD_YR                          /*감사년도*/
			     , D1.AUD_NO                         AS AUD_NO                          /*감사번호*/
			     , D3.AUD_GRN_NO                     AS AUD_GRN_NO                      /*감사부여번호*/
			     , F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D3.AUD_KND_CD, '-') 
			                                         AS AUD_YR_NO                       /*감사연번호 수정 - 2015.12.22 yyh*/ 
			     , CASE WHEN D1.AUD_YR >= '2016' 
			                 THEN F_CODE_NM('1000739',D3.AUD_KND_CD)   
			            ELSE '-' 
			        END                              AS AUD_YR_NO_KND_NM                /*감사연번호종류코드명 추가 - 2015.12.22 yyh*/					                                         
			     , D3.SPV_BRDV_NM                    AS SPV_BRDV_NM                     /*주관국과명*/
			     , D3.AUD_SBJ_NM                     AS AUD_SBJ_NM                      /*감사사항*/
			     , D3.AUD_ORG_CNT                    AS AUD_ORG_CNT                     /*기관명*/
			     , D1.DSP_RQ_SNO                     AS DSP_RQ_SNO                      /*처분요구순번*/
			     /*  , F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D3.AUD_KND_CD, '-') ||'-'|| D1.DSP_RQ_SNO   AS DSP_RQ_SNO_NM                   처분요구순번DISP - 2015.12.22 yyh*/
                 , CASE WHEN D1.AUD_YR >= '2016' 
			            THEN F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D3.AUD_KND_CD, '-') ||'-'||'시'||D1.DSP_RQ_SNO  
			            ELSE F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D3.AUD_KND_CD, '-') ||'-'||D1.DSP_RQ_SNO   
			        END   							 AS DSP_RQ_SNO_NM                   /*시행번호*/
			     , D1.FRM_NO                         AS FRM_NO                          /*서식번호*/
			     , D1.RPRT_NO                        AS RPRT_NO                         /*보고서식번호*/
			     , D1.TIT_TXT                        AS TIT_TXT                         /*제목내용*/    
			     , D1.DSP_RQ_KND_CD                  AS DSP_RQ_KND_CD                   /*처분요구종류코드*/
			     , D1.ORG_DVSN_CD                    AS ORG_DVSN_CD                     /*기관구분코드*/
			     , D1.AUD_EPS_CD                     AS AUD_EPS_CD                      /*감사중점코드*/
			     , D2.DSP_RQ_SRNO                    AS DSP_RQ_SRNO                     /*처분요구일련번호*/
			     , TO_CHAR(TO_DATE(D2.ENF_DT),'YYYY-MM-DD') AS ENF_DT                   /*시행일*/
			     , TO_CHAR(TO_DATE(D2.HNDL_DDLN_DT),'YYYY-MM-DD')  AS HNDL_DDLN_DT      /*처리기한일*/
			     , D2.ENF_BRDV_CD                    AS ENF_BRDV_CD                     /*시행국과코드*/
			     , F_DPT_INFO(D2.ENF_BRDV_CD,'1')	 AS ENF_BRDV_NM                     /*시행국과명*/
			     , D2.DOC_SEN_NO                     AS DOC_SEN_NO                      /*문서발송코드*/
			     , D2.WRDO_CAU_CD                    AS WRDO_CAU_CD                     /*비위원인코드*/
			     , D2.ENFM_MNG_BRDV_CD               AS ENFM_MNG_BRDV_CD                /*집행관리국과코드*/    
			     , F_DPT_INFO(D2.ENFM_MNG_BRDV_CD, '1') AS ENFM_MNG_BRDV_NM
			     
			     , D2.DTM_YN                         AS DTM_YN                          /*확정여부*/
			     , D2.DTM_STA_CD                     AS DTM_STA_CD                      /*확정상태코드*/
			     , D2.HMP_OPEN_YN                    AS HMP_OPEN_YN                     /*홈페이지공개여부*/
			     , D2.DTY_OBV_UTL_YN                 AS DTY_OBV_UTL_YN                  /*직무관철활용여부*/
			     , D2.WRDO_TYP_CD                    AS WRDO_TYP_CD                     /*비위유형코드*/
			     , D2.DSP_RQ_APV_STA_CD              AS DSP_RQ_APV_STA_CD               /*처분요구결재상태코드*/
			     , D2.TSK_CAT_CD                     AS TSK_CAT_CD                      /*업무분류코드*/
			     , F_CODE_NM('1000121',D2.WRDO_TYP_CD) 
			                                         AS WRDO_TYP_NM                     /*비위유형코드명*/
			     
			     /* 가공된 비위유형, 코드 추가 - 2016.05.11 yyh */
			     , DECODE(SUBSTR(D2.WRDO_TYP_CD,1,1),'1','100000000','200000000')  
			                                         AS WRDO_TYP_CD1                    /*비위유형코드*/
			     , F_CODE_NM('1000121',DECODE(SUBSTR(D2.WRDO_TYP_CD,1,1),'1','100000000','200000000'))
			                                         AS WRDO_TYP_NM1                    /*비위유형코드명*/
			           
			     , F_CODE_NM('1000120',D2.TSK_CAT_CD)  AS TSK_CAT_NM                    /*업무분류명*/
			     , F_CODE_NM('1000002',D1.DSP_RQ_KND_CD )  AS DSP_RQ_KND_NM                    /*처분요구종류명*/
			     , F_CODE_NM('1000017',D2.DTM_STA_CD )  AS DTM_STA_NM                   /*결재상태명*/
			     ,  '예비 : '||D4.RSRV_CNT||'회('||D4.RSRV_NOP_CNT||'명, '|| D4.RSRV_AUD_DCN||'일)' 
			      ||'실지 : '||D4.FIELD_CNT||'회('||D4.FIELD_NOP_CNT||'명, '|| D4.FLD_AUD_EXEC_DCN||'일)' 
			      ||'추가 : '||D4.ADD_CNT||'회('||D4.ADD_NOP_CNT||'명, '|| D4.ADD_AUD_DCN||'일)' 
			      ||' = 총 '||D4.AUD_DCN||'일 연인원' ||D4.MAN_DAY	AS SITU /*출장상황*/
			     , NVL(D2.PNL_DRIN_PSVT_AM,0) + NVL(D2.RSR_AM,0) + NVL(D2.SPLP_AM,0) DISP_REQ_AM /*처분요구금액*/
			     , NVL(D2.BGT_RDC_AM, 0)+NVL(D2.INC_ICR_AM, 0)+NVL(D2.PPL_BDN_RDT_AM, 0) + NVL(D2.FRTN_INCR_AM, 0) + NVL(D2.EXPN_RTNL_AM, 0) EFT_AM /*기대효과금액*/
			     , '처분요구금액 : '||TO_CHAR(NVL(D2.PNL_DRIN_PSVT_AM,0) + NVL(D2.RSR_AM,0) + NVL(D2.SPLP_AM,0),'999,999,999,999,999')||'원			               '||'기대효과금액 : '|| TO_CHAR(NVL(D2.BGT_RDC_AM, 0)+NVL(D2.INC_ICR_AM, 0)+NVL(D2.PPL_BDN_RDT_AM, 0) + NVL(D2.FRTN_INCR_AM, 0) + NVL(D2.EXPN_RTNL_AM, 0),'999,999,999,999,999')||'원' AS DISP_REQ 
				 , D2.RLTN_ORG_CD AS REP_RLTN_ORG_CD
				 
				 /* 소관기관, 1차기관, 고발의뢰인원수, 인원수 추가 - 2015.05.04 yyh */
				 , CASE WHEN D2.RLTN_ORG_CD IS NOT NULL THEN F_ORG_INFO(D2.RLTN_ORG_CD,'1') ||'외 '|| (SELECT COUNT(1)-1  
                                                              FROM TBBADEAR006M
                                                             WHERE AUD_YR      = D2.AUD_YR
                                                               AND AUD_NO      = D2.AUD_NO
                                                               AND DSP_RQ_SNO  = D2.DSP_RQ_SNO) END AS DTL_RLTN_ORG_NM
				 , F_ORG_INFO(D2.COPT_OFI_CD,'1')                                               AS DTL_COPT_OFI_NM 
				 , D2.PSC_RQT_NOP_CNT		                                                    AS PSC_RQT_NOP_CNT	/*고발의뢰인원수*/
			     , D2.NOP_CNT                                                                   AS NOP_CNT          /*인원수*/
				 
				 , (
					   SELECT NVL(MAX(ST1.MNG_SNO), 0) AS MNG_SNO_MAX
					   FROM TBBADFRE011M ST1
					   WHERE ST1.AUD_YR = D1.AUD_YR
					   AND ST1.AUD_NO = D1.AUD_NO
					   AND ST1.DSP_RQ_SNO = D1.DSP_RQ_SNO
					   AND ST1.RLTN_ORG_CD = D2.RLTN_ORG_CD
				   ) AS MNG_SNO_MAX			
				 , (
					   SELECT DECODE(NVL(COUNT(1), 0), 0, '', '특수관리사항') AS SPCN_MNG
					   FROM TBBADFRE011M ST1
					   WHERE ST1.AUD_YR = D1.AUD_YR
					   AND ST1.AUD_NO = D1.AUD_NO
					   AND ST1.DSP_RQ_SNO = D1.DSP_RQ_SNO
				   ) AS SPCN_MNG
				   
				   /* 재심의사항 */	
				   ,(
					   SELECT AGGR_CONCAT(ST1.ACP_YR || '-' || DECODE(ST1.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') || '-' || ST1.ACP_SRNO, ',') AS JESIM_CNT
						 FROM TBBADFRE012M ST1
						WHERE ST1.AUD_YR = D1.AUD_YR
						  AND ST1.AUD_NO = D1.AUD_NO
						  AND ST1.DSP_RQ_SNO = D1.DSP_RQ_SNO
				   ) AS JESIM_CNT				
				   
				 /* 감사결정례 추가 - 2016.07.12 yyh */
				 , (
					   SELECT DECODE(NVL(COUNT(1), 0), 0, '', '감사결정례') AS JESIM_CNT
						 FROM TBBADEAR034M ST1
						WHERE ST1.AUD_YR = D1.AUD_YR
						  AND ST1.AUD_NO = D1.AUD_NO
						  AND ST1.DSP_RQ_SNO = D1.DSP_RQ_SNO
				   ) AS DCSEXP_CNT				   
				  
				 /* 실시구분 추가 - 2016.07.12 yyh */ 			  
				 ,Z1.DVSN_CD
				 ,(SELECT USR_DFN_TXT_1
				     FROM TBDCMACM013C
				    WHERE CMM_CD_DVSN_CD = '1000742'
				      AND CD             = Z1.DVSN_CD) AS DVSN_NM  
				 ,Z1.TSK_KEY1
				 ,Z1.TSK_KEY2
				 ,Z1.TSK_KEY3
				 ,Z1.TSK_KEY4  
				 ,D1.EXEC_DSP_NM                                          /* 시행번호 */
			  FROM TBBADEAR001M D1			     
			     , TBBADEAR002D D2
			     , TBBADEAR035L Z1
			     , (
			           SELECT D1.AUD_YR
			                , D1.AUD_NO
			                , D1.AUD_GRN_NO /* 감사부여번호 - 2016.05.31 yyh */
			                , D1.AUD_KND_CD 
			                , F_DPT_INFO(D1.SPV_BRDV_CD,'1')||'(반장 : '||F_USR_INFO(D1.AUD_TOT_DRTR_CNB,'2')||', 주관 : '||F_USR_INFO(D1.SPVR_CNB,'2')||')' AS SPV_BRDV_NM               
			                , '<'||F_CODE_NM('1000007',D1.AUD_KND_CD) ||'>'||D1.AUD_SBJ_NM AS AUD_SBJ_NM
			                , F_ORG_CNT_NM_AUD(D1.AUD_YR,D1.AUD_NO,'AUD') AS AUD_ORG_CNT
			            	, D1.SPV_BRDV_CD
			            FROM TBBADDED001M D1
			           WHERE 1=1
			             AND D1.SPV_BRDV_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#{cnb}, #{dptauth ,jdbcType=VARCHAR}, '', #{upspvbrdvcd ,jdbcType=VARCHAR})))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/
   
		]]>
		<if test='spvBrdvCd != null and spvBrdvCd != ""'>
			   			 AND D1.SPV_BRDV_CD = #{spvBrdvCd}
		</if>
        <![CDATA[       
			       ) D3
			     , (
				      	SELECT SITU.REL_AUD_YR , SITU.REL_AUD_NO
						     , MIN(SITU.AUD_STR_DT) AS AUD_STR_DT
						     , MAX(SITU.AUD_END_DT) AS AUD_END_DT
						     , SUM( CASE WHEN SITU.AUD_BZT_KND_CD = '01' THEN 1 ELSE 0 END) AS RSRV_CNT
						     , (SELECT COUNT(*)
						          FROM (SELECT DISTINCT AUD2.AUD_YR
						                     , AUD2.AUD_NO
						                     , TMA2.PCT_CNB
						                  FROM TBBADDED001M AUD2
						                     , TBBADDED005L TMA2
						                     , TBBADDED002M SITU2
						                 WHERE 1=1
						                   AND SITU2.REL_AUD_YR = AUD2.AUD_YR
						                   AND SITU2.REL_AUD_NO = AUD2.AUD_NO
						                   AND TMA2.BZT_YR = SITU2.BZT_YR
						                   AND TMA2.BZT_SNO = SITU2.BZT_SNO
						                   AND SITU2.REL_AUD_YR  = #{audYr}
						                   AND SITU2.REL_AUD_NO = #{audNo}
						                   AND SITU2.AUD_BZT_KND_CD = '01' ) PSON3 )                    AS RSRV_NOP_CNT
						     , SUM( CASE WHEN SITU.AUD_BZT_KND_CD = '01' THEN SITU.AUD_DCN  ELSE 0 END) AS RSRV_AUD_DCN
						     , SUM( CASE WHEN SITU.AUD_BZT_KND_CD = '02' THEN 1 ELSE 0 END)             AS FIELD_CNT 
						     , (SELECT COUNT(*)
						          FROM (SELECT DISTINCT AUD2.AUD_YR
						                     , AUD2.AUD_NO
						                     , TMA2.PCT_CNB
						                  FROM TBBADDED001M AUD2
						                     , TBBADDED005L TMA2
						                     , TBBADDED002M SITU2
						                 WHERE 1=1
						                   AND SITU2.REL_AUD_YR = AUD2.AUD_YR
						                   AND SITU2.REL_AUD_NO = AUD2.AUD_NO
						                   AND TMA2.BZT_YR = SITU2.BZT_YR
						                   AND TMA2.BZT_SNO = SITU2.BZT_SNO
						                   AND SITU2.REL_AUD_YR  = #{audYr}
						                   AND SITU2.REL_AUD_NO = #{audNo}
						                   AND SITU2.AUD_BZT_KND_CD = '02' ) PSON3 )                    AS FIELD_NOP_CNT
						     , SUM( CASE WHEN SITU.AUD_BZT_KND_CD = '02' THEN SITU.AUD_DCN ELSE 0 END)  AS FLD_AUD_EXEC_DCN
						     , SUM( CASE WHEN SITU.AUD_BZT_KND_CD = '03' THEN 1 ELSE 0 END)             AS ADD_CNT 
						      , (SELECT COUNT(*)
						          FROM (SELECT DISTINCT AUD2.AUD_YR
						                     , AUD2.AUD_NO
						                     , TMA2.PCT_CNB
						                  FROM TBBADDED001M AUD2
						                     , TBBADDED005L TMA2
						                     , TBBADDED002M SITU2
						                 WHERE 1=1
						                   AND SITU2.REL_AUD_YR = AUD2.AUD_YR
						                   AND SITU2.REL_AUD_NO = AUD2.AUD_NO
						                   AND TMA2.BZT_YR = SITU2.BZT_YR
						                   AND TMA2.BZT_SNO = SITU2.BZT_SNO
						                   AND SITU2.AUD_BZT_KND_CD = '03' 
						                   AND SITU2.REL_AUD_YR  = #{audYr}
						                   AND SITU2.REL_AUD_NO = #{audNo}
						                  ) PSON3 ) AS ADD_NOP_CNT
						     , SUM( CASE WHEN SITU.AUD_BZT_KND_CD = '03' THEN SITU.AUD_DCN ELSE 0 END) AS ADD_AUD_DCN
						     , SUM(SITU.AUD_DCN) AS AUD_DCN
						     , SUM(PSON.AUD_DCN) AS MAN_DAY
						  FROM TBBADDED002M SITU
						     , TBBADDED006L PSON
						 WHERE 1=1
						   AND SITU.BZT_DVSN_CD = '1'
						   AND PSON.BZT_YR = SITU.BZT_YR
						   AND PSON.BZT_SNO = SITU.BZT_SNO
						   AND SITU.REL_AUD_YR  = #{audYr}
						   AND SITU.REL_AUD_NO = #{audNo}
						 GROUP BY SITU.REL_AUD_YR , SITU.REL_AUD_NO 
			       ) D4
			 WHERE 1=1
			   AND D1.AUD_YR     = D2.AUD_YR
			   AND D1.AUD_NO     = D2.AUD_NO
			   AND D1.DSP_RQ_SNO = D2.DSP_RQ_SNO
			   AND D1.AUD_YR     = D3.AUD_YR
			   AND D1.AUD_NO     = D3.AUD_NO
			   AND D1.AUD_YR     = D4.REL_AUD_YR(+)
			   AND D1.AUD_NO     = D4.REL_AUD_NO(+)  
			   AND D1.AUD_YR     = Z1.AUD_YR(+)
			   AND D1.AUD_NO     = Z1.AUD_NO(+)
			   AND D1.DSP_RQ_SNO = Z1.DSP_RQ_SNO(+)			     
		]]>
		<if test='audYr != null and audYr != ""'>
			   AND D1.AUD_YR      = #{audYr}
		</if>
		<if test='audNo != null and audNo != ""'>
			   AND D1.AUD_NO      = #{audNo}
		</if>	
		<if test='dspRqSno != null and dspRqSno != ""'>
			   AND D1.DSP_RQ_SNO      = #{dspRqSno}
		</if>			
        <![CDATA[       
			  ORDER BY D1.AUD_YR , D1.AUD_NO DESC, D1.DSP_RQ_SNO DESC
        ]]>
	</select>	
	
</mapper> 
