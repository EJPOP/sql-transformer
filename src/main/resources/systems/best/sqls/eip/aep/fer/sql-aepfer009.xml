<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.fer.dao.AEPFER009QMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap" >
            /* kr.go.bai.eip.aep.fer.dao.AEPFER009QMapper.selectMainList */
            <![CDATA[
			SELECT ROWNUM AS NUM
				, AUD_YR
				, AUD_NO
				, AUD_YR_NO
				, AUD_DPT_FULL_NM
				, AUD_SBJ_NM
				, AFF_MPP_DVSN_CD
				, AFF_MPP_DVSN_NM
				, PRE_AFF_NO
				, AFF_NO
				, PRE_DSP_RQ_NM
				, DSP_RQ_NM
				, APVR_CD
				, APVR_NM
				, RMK
				FROM(
					SELECT B.AUD_YR
					      ,B.AUD_NO
					      ,F_MNG_KND_AUDYRNO(B.AUD_YR, B.AUD_NO, B.AUD_KND_CD, '-') AS AUD_YR_NO    --감사번호
					      ,(SELECT S1.DPT_NM FROM TBDCMACM002M S1
					         WHERE S1.DPT_CD = B.SPV_BRDV_CD) AS AUD_DPT_FULL_NM                    --주관국과명
					      ,B.AUD_SBJ_NM         --감사명
					      ,A.AFF_MPP_DVSN_CD    --매핑구문코드		      
					      ,(SELECT T1.CD_NM
							 FROM TBDCMACM013C T1
							WHERE T1.CMM_CD_DVSN_CD = '1000777'
							  AND T1.CD = A.AFF_MPP_DVSN_CD
							  AND ROWNUM = 1)	 AS AFF_MPP_DVSN_NM    --매핑구분명
					      ,A.PRE_AFF_NO         --전 사건번호
					      ,A.AFF_NO             --후 사건번호
					      ,( SELECT (SELECT T1.CD_NM
										 FROM TBDCMACM013C T1
										WHERE T1.CMM_CD_DVSN_CD = '1000002'
										  AND T1.CD = D.DSP_RQ_CD
										  AND ROWNUM = 1)
					           FROM TBBADDED145M C
					               ,TBBADDED146M D
					         WHERE C.AUD_YR      = D.AUD_YR
					           AND C.AUD_NO      = D.AUD_NO
					           AND C.AUD_STEP_CD = D.AUD_STEP_CD
					           AND C.DOC_ID      = D.DOC_ID
					           AND C.APVR_CD     = D.APVR_CD
					           AND C.AFF_SNO     = D.AFF_SNO
					           AND F_MNG_KND_AUDYRNO(C.AUD_YR, C.AUD_NO, C.AUD_KND_CD, '-')||'-'||C.AFF_CD||'-'||D.AFF_DSP_CD = A.PRE_AFF_NO
					           AND (CASE WHEN C.APVR_CD = '0010200' THEN '종료보고'
					                     WHEN C.APVR_CD = '0013600' THEN '과장'
					                     WHEN C.APVR_CD = '0015800' THEN '국장'
					                     WHEN C.APVR_CD = '0035100' THEN '국장'
					                     WHEN C.APVR_CD = '0058100' THEN '국장'
					                     WHEN C.APVR_CD = '0055600' THEN '차장'
					                     WHEN C.APVR_CD = '0045900' THEN '차장'
					                     WHEN C.APVR_CD = '0055700' THEN '총장'
					                     WHEN C.APVR_CD = '0010600' THEN '위원'
					                     WHEN C.APVR_CD = 'A1070'   THEN '부의결과'
					                     ELSE 'ERR'
					                      END) = (CASE WHEN A.APVR_CD = '0013600' THEN '종료보고'
					                                   WHEN A.APVR_CD = '0015800' THEN '과장'
					                                   WHEN A.APVR_CD = '0035100' THEN '과장'
					                                   WHEN A.APVR_CD = '0058100' THEN '과장'
					                                   WHEN A.APVR_CD = '0055600' THEN '국장'
					                                   WHEN A.APVR_CD = '0045900' THEN '국장'
					                                   WHEN A.APVR_CD = '0055700' THEN '차장'
					                                   WHEN A.APVR_CD = '0010600' THEN '총장'
					                                   WHEN A.APVR_CD = 'A1070'   THEN '위원'
					                                   ELSE 'ERR'
					                                    END)
					       ) AS PRE_DSP_RQ_NM   --전 처분요구명
					      ,( SELECT AGGR_CONCAT((SELECT T1.CD_NM
											  	   FROM TBDCMACM013C T1
												  WHERE T1.CMM_CD_DVSN_CD = '1000002'
													AND T1.CD = D.DSP_RQ_CD
													AND ROWNUM = 1),', ') AS DSP_RQ_NM
					           FROM TBBADDED145M C
					               ,TBBADDED146M D
					         WHERE C.AUD_YR      = D.AUD_YR
					           AND C.AUD_NO      = D.AUD_NO
					           AND C.AUD_STEP_CD = D.AUD_STEP_CD
					           AND C.DOC_ID      = D.DOC_ID
					           AND C.APVR_CD     = D.APVR_CD
					           AND C.AFF_SNO     = D.AFF_SNO
					           AND F_MNG_KND_AUDYRNO(C.AUD_YR, C.AUD_NO, C.AUD_KND_CD, '-')||'-'||C.AFF_CD||'-'||D.AFF_DSP_CD =  A.AFF_NO
					           AND C.AUD_YR = A.AUD_YR
					           AND C.AUD_NO = A.AUD_NO
					           AND C.APVR_CD     = A.APVR_CD
					       ) AS DSP_RQ_NM       --후 처분요구명
					      ,A.APVR_CD                --결재코드
					      ,(CASE WHEN A.APVR_CD = '0013600' THEN '과장'
					             WHEN A.APVR_CD = '0015800' THEN '국장'
					             WHEN A.APVR_CD = '0035100' THEN '단장'
					             WHEN A.APVR_CD = '0058100' THEN '실장'
					             WHEN A.APVR_CD = '0055600' THEN '차장'
					             WHEN A.APVR_CD = '0045900' THEN '본부장'
					             WHEN A.APVR_CD = '0055700' THEN '총장'
					             WHEN A.APVR_CD = '0010600' THEN '위원'
					             WHEN A.APVR_CD = 'A1070'   THEN '부의결과'
					             ELSE 'ERR'
					              END) AS APVR_NM   --결재명
					       ,DECODE(A.AFF_MPP_DVSN_CD,'D21',(SELECT (SELECT T1.CD_NM
																		 FROM TBDCMACM013C T1
																		WHERE T1.CMM_CD_DVSN_CD = '1000774'
																		  AND T1.CD = C.REFER_DVSN_CD
																		  AND ROWNUM = 1)
					                                          FROM TBBADDED145M C
					                                              ,TBBADDED146M D
					                                        WHERE C.AUD_YR      = D.AUD_YR
					                                          AND C.AUD_NO      = D.AUD_NO
					                                          AND C.AUD_STEP_CD = D.AUD_STEP_CD
					                                          AND C.DOC_ID      = D.DOC_ID
					                                          AND C.APVR_CD     = D.APVR_CD
					                                          AND C.AFF_SNO     = D.AFF_SNO
					                                          AND F_MNG_KND_AUDYRNO(C.AUD_YR, C.AUD_NO, C.AUD_KND_CD, '-')||'-'||C.AFF_CD||'-'||D.AFF_DSP_CD = A.AFF_NO
					                                          AND C.APVR_CD     = A.APVR_CD)||' (으)로 변경','') AS RMK --비고
					  FROM TBBADDED148M A
					      ,TBBADDED001M B
					 WHERE 1=1
					   AND A.AUD_YR = #{srcAudYr} --PARAM
					   AND A.AUD_STEP_CD <> 'A1050'     --종료보고매핑 제외
					   AND A.AFF_MPP_DVSN_CD <> 'D10'   --유지제외
					   AND A.AFF_MPP_DVSN_CD <> 'D51'   --현지조치제외
					   AND A.AUD_YR = B.AUD_YR
					   AND A.AUD_NO = B.AUD_NO
					 ORDER BY A.AUD_YR
					         ,A.AUD_NO
					         ,A.AUD_STEP_CD
					         ,(CASE WHEN A.APVR_CD = '0013600' THEN 01 --과장
					                WHEN A.APVR_CD = '0015800' THEN 02 --국장
					                WHEN A.APVR_CD = '0035100' THEN 03 --단장
					                WHEN A.APVR_CD = '0058100' THEN 04 --실장
					                WHEN A.APVR_CD = '0055600' THEN 05 --차장
					                WHEN A.APVR_CD = '0045900' THEN 06 --본부장
					                WHEN A.APVR_CD = '0055700' THEN 07 --총장
					                WHEN A.APVR_CD = '0010600' THEN 08 --위원
					                WHEN A.APVR_CD = 'A1070'   THEN 09 --부의결과
					                ELSE 99
					                 END)
					         ,(SELECT LPAD(C.SORT_SNO,2,0)||LPAD(D.SORT_SNO,2,0)
					             FROM TBBADDED145M C
					                 ,TBBADDED146M D
					            WHERE C.AUD_YR      = D.AUD_YR
					              AND C.AUD_NO      = D.AUD_NO
					              AND C.AUD_STEP_CD = D.AUD_STEP_CD
					              AND C.DOC_ID      = D.DOC_ID
					              AND C.APVR_CD     = D.APVR_CD
					              AND C.AFF_SNO     = D.AFF_SNO
					              AND F_MNG_KND_AUDYRNO(C.AUD_YR, C.AUD_NO, C.AUD_KND_CD, '-') =  A.AFF_NO
					              AND C.APVR_CD     = A.APVR_CD)
				)
         ]]>
    </select>
    
</mapper> 
