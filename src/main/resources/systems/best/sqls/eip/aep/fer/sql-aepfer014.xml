<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap" >
    /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.selectMainList */
        <include refid="include.pageSelct" />
        <![CDATA[
            SELECT (
                    SELECT MAX(T1.DOC_ID)
                      FROM TBBADDED103M T1
                     WHERE T1.AUD_YR = G1.AUD_YR
                       AND T1.AUD_NO = G1.AUD_NO
                       AND T1.AUD_STEP_CD = 'A1050'
                       AND T1.RPRT_CD = 'A10500200'
                   ) AS END_RPRT_DOC_ID
                 , G1.*
              FROM (
                    SELECT 
                        CASE
                       		 WHEN TOT_DHD_DVS_CD IS NOT NULL
                             THEN
		                          CASE
		                              WHEN PRSS_STEP_CD = '02' THEN TO_CHAR(SYSDATE,'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '03' THEN TO_CHAR(SYSDATE,'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '04' THEN TO_CHAR(NVL(TO_DATE(RPT_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '07' THEN TO_CHAR(NVL(TO_DATE(BRDV_HNDL_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '08' THEN TO_CHAR(NVL(TO_DATE(RVW_RM_APV_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '09' THEN TO_CHAR(NVL(TO_DATE(DHD_APV_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '10' THEN TO_CHAR(NVL(TO_DATE(PSD_APV_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '11' THEN TO_CHAR(NVL(TO_DATE(CHF_CMTR_APV_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              ELSE TO_CHAR(NVL(TO_DATE(ENF_APV_DDLN_DT), SYSDATE),'YYYY-MM-DD')
		                          END
                             ELSE
		                          CASE
		                              WHEN PRSS_STEP_CD = '02' THEN TO_CHAR(SYSDATE,'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '03' THEN TO_CHAR(SYSDATE,'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '04' THEN TO_CHAR(NVL(TO_DATE(RPT_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '07' THEN TO_CHAR(NVL(TO_DATE(BRDV_HNDL_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '08' THEN TO_CHAR(NVL(TO_DATE(RVW_RM_APV_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '09' THEN TO_CHAR(NVL(TO_DATE(TOT_DHD_APV_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              WHEN PRSS_STEP_CD = '10' THEN TO_CHAR(NVL(TO_DATE(CHF_CMTR_APV_DDLN_DT)+1, SYSDATE),'YYYY-MM-DD')
		                              ELSE TO_CHAR(NVL(TO_DATE(ENF_APV_DDLN_DT), SYSDATE),'YYYY-MM-DD')
		                          END
		                END AS NOW_STEP_DH
                        , AUD_YR
                        , AUD_NO
                        , AUD_KND_CD
                        , AUD_GRN_NO
                        , AUD_YR_NO
                        , AUD_KND_NM
                        , AUD_SBJ_NM
                        , MNG_DPT_NM
                        , TO_CHAR(TO_DATE(RSV_INSPC_LUNH_DT), 'YYYY-MM-DD') AS MTRL_CLC_STRT_DT
                        , TO_CHAR(TO_DATE(RTN_DT), 'YYYY-MM-DD') AS RTN_DT
                        , TO_CHAR(TO_DATE(HNDL_DDLN_DT), 'YYYY-MM-DD') AS STAD_HNDL_DT
                       , CASE
                       		 WHEN TOT_DHD_DVS_CD IS NOT NULL
                             THEN
		                          CASE
		                              WHEN SYSDATE <= RPT_DDLN_DT THEN '종료보고'
		                              WHEN SYSDATE <= BRDV_HNDL_DDLN_DT THEN '과장'
		                              WHEN SYSDATE <= RVW_RM_APV_DDLN_DT THEN '국장'
		                              WHEN SYSDATE <= DHD_APV_DDLN_DT THEN '차장'
		                              WHEN SYSDATE <= PSD_APV_DDLN_DT THEN '총장'
		                              WHEN SYSDATE <= CHF_CMTR_APV_DDLN_DT THEN '주심위원'
		                              WHEN SYSDATE <= ENF_APV_DDLN_DT THEN '시행'
		                              ELSE '시행'
		                          END
                             ELSE
		                          CASE
		                              WHEN SYSDATE <= RPT_DDLN_DT THEN '종료보고'
		                              WHEN SYSDATE <= BRDV_HNDL_DDLN_DT THEN '과장'
		                              WHEN SYSDATE <= RVW_RM_APV_DDLN_DT THEN '국장'
		                              WHEN SYSDATE <= TOT_DHD_APV_DDLN_DT THEN '총차장'
		                              WHEN SYSDATE <= CHF_CMTR_APV_DDLN_DT THEN '주심위원'
		                              WHEN SYSDATE <= ENF_APV_DDLN_DT THEN '시행'
		                              ELSE '시행'
		                          END
		               END AS STAD_STEP_NM
                       , CASE
                       		 WHEN TOT_DHD_DVS_CD IS NOT NULL
                             THEN
		                          CASE
		                              WHEN PRSS_STEP_CD = '02' THEN '출장'
		                              WHEN PRSS_STEP_CD = '03' THEN '종료보고'
		                              WHEN PRSS_STEP_CD = '04' THEN '과장'
		                              WHEN PRSS_STEP_CD = '07' THEN '국장'
		                              WHEN PRSS_STEP_CD = '08' THEN '차장'
		                              WHEN PRSS_STEP_CD = '09' THEN '총장'
		                              WHEN PRSS_STEP_CD = '10' THEN '주심위원'
		                              WHEN PRSS_STEP_CD = '11' THEN '시행'
		                          END
                             ELSE
		                          CASE
		                              WHEN PRSS_STEP_CD = '02' THEN '출장'
		                              WHEN PRSS_STEP_CD = '03' THEN '종료보고'
		                              WHEN PRSS_STEP_CD = '04' THEN '과장'
		                              WHEN PRSS_STEP_CD = '07' THEN '국장'
		                              WHEN PRSS_STEP_CD = '08' THEN '총차장'
		                              WHEN PRSS_STEP_CD = '09' THEN '주심위원'
		                              WHEN PRSS_STEP_CD = '10' THEN '시행'
		                          END
		               END AS NOW_STEP_NM
                       , CASE
                       		 WHEN  TOT_DHD_DVS_CD IS NOT NULL
                             THEN
		                          CASE
		                              WHEN PRSS_STEP_CD = '03' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(RPT_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(RPT_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '04' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(BRDV_HNDL_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(BRDV_HNDL_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '07' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(RVW_RM_APV_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(RVW_RM_APV_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '08' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(DHD_APV_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(DHD_APV_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '09' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(PSD_APV_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(PSD_APV_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '10' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(CHF_CMTR_APV_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(CHF_CMTR_APV_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '11' 
		                              THEN CASE 
		                                       WHEN ENF_APV_DT IS NULL
		                                       THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(ENF_APV_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(ENF_APV_DDLN_DT))
		                                       ELSE DECODE(SIGN(TO_DATE(ENF_APV_DDLN_DT) - TO_DATE(ENF_APV_DT)), -1, '0', TO_DATE(ENF_APV_DDLN_DT) - TO_DATE(ENF_APV_DT))
		                                   END
		                             ELSE '0'
		                          END
                             ELSE
		                          CASE
		                              WHEN PRSS_STEP_CD = '03' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(RPT_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(RPT_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '04' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(BRDV_HNDL_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(BRDV_HNDL_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '07' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(RVW_RM_APV_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(RVW_RM_APV_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '08' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(TOT_DHD_APV_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(TOT_DHD_APV_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '09' 
		                              THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(CHF_CMTR_APV_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(CHF_CMTR_APV_DDLN_DT))
		                              WHEN PRSS_STEP_CD = '10' 
		                              THEN CASE 
		                                       WHEN ENF_APV_DT IS NULL
		                                       THEN DECODE(SIGN(TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(ENF_APV_DDLN_DT)), -1, '0', TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(ENF_APV_DDLN_DT))
		                                       ELSE DECODE(SIGN(TO_DATE(ENF_APV_DDLN_DT) - TO_DATE(ENF_APV_DT)), -1, '0', TO_DATE(ENF_APV_DDLN_DT) - TO_DATE(ENF_APV_DT))
		                                   END
		                             ELSE '0'
		                          END
                         END AS DLAY_DCN
                        , GNR_HNDL_PLAN_YN
                        , EXTN_PRD_COFM_DT
                        , TOT_EXTN_PRD_DCN
                        , RPRT_YN
                        , DOC_ID
                        , DOC_TYPE
                        , AUD_YR_NO2
                        , CASE WHEN (SELECT MAX(ST.DVSN_CD) FROM TBBADDED030L ST WHERE ST.AUD_YR = A.AUD_YR AND ST.AUD_NO = A.AUD_NO AND ST.DVSN_CD = '4') IS NOT NULL THEN NVL(NTNL_ASMB_CNFM_YN,'N')
                               ELSE ''
                               END AS NTNL_ASMB_CNFM_YN
                    FROM (
                          SELECT T1.AUD_YR
                               , T1.AUD_NO
                               , T1.AUD_KND_CD
                               , T1.AUD_GRN_NO
                               , F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') AS AUD_YR_NO
                               , F_CODE_NM('1000007', T1.AUD_KND_CD) AS AUD_KND_NM
                               , T1.AUD_SBJ_NM
                               , F_DPT_INFO(T1.MNG_DPT_CD,'1') AS MNG_DPT_NM
                               , T2.RSV_INSPC_LUNH_DT
                               , T2.RTN_RPT_DT                               
                               , NVL(EXTN_HNDL_DDLN_DT, HNDL_DDLN_DT) AS HNDL_DDLN_DT -- (2019.04.05 LSR 수정)
                               , CASE
                               		 WHEN PSD_APV_DDLN_DT IS NOT NULL
                                     THEN
		                                CASE 
		                                     WHEN T1.PRSS_STEP_CD = 'A1010' 
		                                        OR T1.PRSS_STEP_CD = 'A1020' 
		                                        OR T1.PRSS_STEP_CD = 'A1030' 
		                                        OR T1.PRSS_STEP_CD = 'A1040' THEN '02'                                      /* 자료수집, 확인출장, 감사실시 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1050' THEN '03'                                         /* 종료보고 */
					                         WHEN T1.PRSS_STEP_CD = 'A1060' AND T2.OW_DHD_APV_DT IS NOT NULL THEN '09'         /* 총장 */
					                         WHEN T1.PRSS_STEP_CD = 'A1060' AND T2.JA_JDG_SSEC_APV_DT IS NOT NULL THEN '08'         /* 차장 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1060' AND T2.AUD_BRDV_APV_DT IS NOT NULL THEN '07'    /* 국장 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1060' THEN '04'       /* 과장 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1070' AND T2.SBCN_DT IS NULL AND T2.CHF_CMTR_APV_DT IS NULL THEN '10'       /* 주심위원 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1070' AND T2.CHF_CMTR_APV_DT IS NOT NULL THEN '11'            /* 부의 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1080' THEN '12'            /* 부의 */    
		                                     ELSE T1.PRSS_STEP_CD
		                                 END
		                       		 ELSE
		                                CASE 
		                                     WHEN T1.PRSS_STEP_CD = 'A1010' 
		                                        OR T1.PRSS_STEP_CD = 'A1020' 
		                                        OR T1.PRSS_STEP_CD = 'A1030' 
		                                        OR T1.PRSS_STEP_CD = 'A1040' THEN '02'                                      /* 자료수집, 확인출장, 감사실시 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1070' AND T2.CHF_CMTR_APV_DT IS NOT NULL THEN 'A1070'    /* 부의 (A1070, 주심위원 결재 후) */
		                                     WHEN T1.PRSS_STEP_CD = 'A1070' THEN '09'                                                                         /* A1070 단계 - 주심위원 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1060' AND T2.OW_DHD_APV_DT IS NOT NULL THEN '08'            /* 총장 (A1060, 차장 결재 후) */
		                                     WHEN T1.PRSS_STEP_CD = 'A1060' AND T2.JA_JDG_SSEC_APV_DT IS NOT NULL THEN '08'    /* 차장 (A1060, 국장 결재 후) */
		                                     WHEN T1.PRSS_STEP_CD = 'A1060' AND T2.AUD_BRDV_APV_DT IS NOT NULL THEN '07'         /* 국장 (A1060, 과장 결재 후) */
		                                     WHEN T1.PRSS_STEP_CD = 'A1060' THEN '04'                                                                        /* 과장 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1050' THEN '03'                                                                        /* 종료보고 */
		                                     WHEN T1.PRSS_STEP_CD = 'A1080' THEN '11'            /* 부의 */    
		                                     ELSE T1.PRSS_STEP_CD
		                                 END
		                       END AS PRSS_STEP_CD
                               , '1' AS DLAY_DCN
                               , NVL(EXTN_RPT_DDLN_DT, RPT_DDLN_DT) AS RPT_DDLN_DT								-- (2019.04.05 LSR 수정)
                               , NVL(EXTN_BRDV_HNDL_DDLN_DT, BRDV_HNDL_DDLN_DT) AS BRDV_HNDL_DDLN_DT			-- (2019.04.05 LSR 수정)
                               , NVL(EXTN_RVW_RM_APV_DDLN_DT, RVW_RM_APV_DDLN_DT) AS RVW_RM_APV_DDLN_DT			-- (2019.04.05 LSR 수정)
                               , NVL(EXTN_TOT_DHD_APV_DDLN_DT, TOT_DHD_APV_DDLN_DT) AS TOT_DHD_APV_DDLN_DT		-- (2019.04.05 LSR 수정)
                               , NVL(EXTN_DHD_APV_DDLN_DT, DHD_APV_DDLN_DT) AS DHD_APV_DDLN_DT					-- (2019.04.05 LSR 수정)
                               , NVL(EXTN_PSD_APV_DDLN_DT, PSD_APV_DDLN_DT) AS PSD_APV_DDLN_DT					-- (2019.04.05 LSR 수정)
                               , NVL(EXTN_CHF_CMTR_APV_DDLN_DT, CHF_CMTR_APV_DDLN_DT) AS CHF_CMTR_APV_DDLN_DT	-- (2019.04.05 LSR 수정)
                               , NVL(EXTN_ENF_APV_DDLN_DT, ENF_APV_DDLN_DT) AS ENF_APV_DDLN_DT					-- (2019.04.05 LSR 수정)
                               , PSD_APV_DDLN_DT AS TOT_DHD_DVS_CD												-- 총,차장 단계 분리 구분 (2019.04.18 LSR 수정)
                               , ENF_APV_DT
                               , RTN_DT
                               , DECODE(T2.GNR_HNDL_PLAN_YN, 'Y', '종합', '개별') AS GNR_HNDL_PLAN_YN  --종합처리안 여부
                               , NVL(T2.EXTN_PRD_COFM_DT, 0) AS EXTN_PRD_COFM_DT   --연장승인일
                               , NVL(DECODE(T2.GNR_HNDL_PLAN_YN, 'Y', NVL(F_GNR_HNDL_PLAN_EXTN_DCN(T1.AUD_YR, T1.AUD_NO), 0), 0), 0) + NVL(T2.EXTN_PRD_COFM_DT,0) AS TOT_EXTN_PRD_DCN  --총연장승인일 (2019.04.05 LSR 수정)
                                , CASE WHEN  (SELECT COUNT(1) FROM TBBADDED103M T3 
                                                   WHERE T1.AUD_YR = T3.AUD_YR
                                                  AND T1.AUD_NO = T3.AUD_NO
                                                  AND T3.RPRT_CD IN ( 'A10500300', 'A10602000')
                                                  AND T3.APV_STA_CD = '30') > 0 THEN '작성' ELSE '미작성' END AS RPRT_YN
                               , T3.DOC_ID      --감사처리 지연사유서 DOC_ID
                               , F_CODE_NM('1000894', T1.DOC_WRIT_KND_CD) AS DOC_TYPE
                               ,CASE WHEN T4.CNT > 1 THEN  T4.EXEC_NO || ' 외 ' || TO_CHAR(T4.CNT -1) ||'건' 
                                   ELSE T4.EXEC_NO END AS AUD_YR_NO2
                               , T1.NTNL_ASMB_CNFM_YN
                            FROM TBBADDED001M T1 
                                    INNER JOIN TBBADDED003M T2 
                                                                   ON T1.AUD_YR = T2.AUD_YR
                                                                  AND T1.AUD_NO = T2.AUD_NO
                                   LEFT OUTER JOIN TBBADDED103M T3 
                                                    ON T1.AUD_YR = T3.AUD_YR
                                                  AND T1.AUD_NO = T3.AUD_NO
                                                  AND T3.RPRT_CD IN ( 'A10500300', 'A10602000')
                                                  AND T3.APV_STA_CD = '30'
                                  LEFT OUTER JOIN ( SELECT  MAX(CASE WHEN DVSN_CD IN ('1','2','3') THEN (SELECT S1.ACP_YR||'-'||F_CODE_NM('1000740',S1.REQ_DVSN_CD)||'-'||S1.RM_CVPT_ACP_NO
                                                                                                                                FROM TBCSPDCP101M S1 WHERE T1.TSK_KEY1 = S1.ACP_YR AND T1.TSK_KEY2 = S1.REQ_DVSN_CD AND T1.TSK_KEY3 = S1.CVPT_ACP_NO)
                                                                                  WHEN DVSN_CD = '4' THEN T1.TSK_KEY1 ||'-국회-'|| T1.TSK_KEY3		/*국회 로직 추가 2017.01.11 전상철*/
                                                                                  WHEN DVSN_CD IN ('5','6','7') THEN (SELECT CASE WHEN S1.ACP_YR >= '2016' THEN S1.ACP_YR || '-' || DECODE(S1.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') || '-' || S1.ACP_SRNO
                                                                                                                                                 ELSE S1.ACP_YR || '-' || S1.ACP_DVSN_CD || '-' || S1.ACP_SRNO END FROM TBBADFRE012M S1
                                                                                                                                WHERE T1.TSK_KEY1 = S1.ACP_YR
                                                                                                                                   AND T1.TSK_KEY2 = S1.ACP_DVSN_CD
                                                                                                                                   AND T1.TSK_KEY3 = S1.ACP_SRNO
                                                                                                                                   AND T1.TSK_KEY4 = S1.DPT_CD)
                                                                                   WHEN DVSN_CD IN ('8','9') THEN (SELECT CASE WHEN S1.OGN_DVSN_CD = '6' THEN S1.YR||'-판청-'||S1.ACP_NO
                                                                                                                                                   ELSE S1.YR||'-손망-'||S1.ACP_NO END FROM TBBADGDA001M S1
                                                                                                                             WHERE T1.TSK_KEY1 = S1.ORG_CD
                                                                                                                                AND T1.TSK_KEY2 = S1.NTF_DVSN_CD
                                                                                                                                AND T1.TSK_KEY3 = S1.NNB)
                                                                                   WHEN DVSN_CD = '0' THEN TSK_KEY1 ||'-정보-'|| TSK_KEY2
                                                                                   WHEN DVSN_CD = 'A' THEN F_MNG_KND_AUDYRNO(TSK_KEY1, TSK_KEY2, (SELECT AUD_KND_CD 
                                                                                                                                                                                FROM TBBADDED001M 
                                                                                                                                                                                WHERE AUD_YR = TSK_KEY1 
                                                                                                                                                                                   AND AUD_NO = TSK_KEY2), '-') ||'-'|| TSK_KEY3 ||'-'|| F_ORG_INFO(TSK_KEY4,'1')
                                                                                   WHEN DVSN_CD = 'C' THEN TSK_KEY1 ||'-청금-'||(SELECT RM_CVPT_ACP_NO FROM TBDCPDCP101M WHERE 1=1 AND ACP_YR = TSK_KEY1 AND REQ_DVSN_CD = TSK_KEY2 AND CVPT_ACP_NO = TSK_KEY3)
																							                                                                                      /*청탁금지법 추가 2020.12.15 최성호*/
                                                                                   WHEN DVSN_CD = 'D' THEN TSK_KEY1 ||'-'||F_CODE_NM('1000742', 'D')||'-'||(SELECT RM_CVPT_ACP_NO FROM TBCORCOR101M WHERE 1=1 AND ACP_YR = TSK_KEY1 AND REQ_DVSN_CD = TSK_KEY2 AND CVPT_ACP_NO = TSK_KEY3)
																																	   											 /*부패방지법 추가 2020.12.15 최성호*/
                                                                                      ELSE '' END) AS EXEC_NO
                               , T1.AUD_YR , T1.AUD_NO , COUNT(1) AS CNT
                  FROM TBBADDED030L T1 
                  GROUP BY T1.AUD_YR, T1.AUD_NO ) T4 ON  T4.AUD_YR = T1.AUD_YR AND T4.AUD_NO  = T1.AUD_NO
                           WHERE 1=1
                             AND SUBSTR(T1.AUD_KND_CD, 3, 1) <> 5
                             AND EXISTS (
                                         SELECT 1
                                           FROM TBDCMACM002M S
                                          WHERE S.DPT_CD = T1.MNG_DPT_CD
                                            AND S.USE_YN = 'Y'
                                        )
        ]]>
            <if test="schAudYr != null and schAudYr != ''">
                    AND T1.AUD_YR  = #{schAudYr}
            </if>
            <if test="schAudYrNoKndCd != null and schAudYrNoKndCd != ''">
                    AND T1.AUD_KND_CD = #{schAudYrNoKndCd}
            </if>
            <if test="schAudNo != null and schAudNo != ''">
                    AND T1.AUD_GRN_NO = #{schAudNo}
            </if>
            <if test="schAudSbjNm != null and schAudSbjNm != ''">
                    AND T1.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
            </if>
            <if test="schPrssStepCd != null and schPrssStepCd != ''">
                <![CDATA[
                AND (
                CASE WHEN #{schAudYr} < 2017 THEN (CASE WHEN SUBSTR(T1.AUD_KND_CD,3) = '55' THEN ''
                                                        WHEN D3.AUD_EXEC_HNDL_STA_CD = '9'  THEN '10'
                                                   ELSE 
                                                        CASE WHEN TRIM(D3.ENF_APV_DT) IS NOT NULL THEN '10'
                                                             WHEN TRIM(D3.CHF_CMTR_APV_DT)IS NOT NULL THEN '09'
                                                             WHEN TRIM(D3.OW_DHD_APV_DT)  IS NOT NULL THEN '08'
                                                             WHEN TRIM(D3.JA_JDG_SSEC_APV_DT) IS NOT NULL THEN '07'
                                                             WHEN TRIM(D3.MDT_DDG_APV_DT) IS NOT NULL THEN '06'
                                                             WHEN TRIM(D3.MDT_OFER_APV_DT)IS NOT NULL THEN '05'
                                                             WHEN TRIM(D3.AUD_BRDV_APV_DT)IS NOT NULL THEN '04'
                                                             WHEN TRIM(D3.RTN_RPT_DT) IS NOT NULL THEN '03'
                                                        ELSE 
                                                            (CASE WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8'
                                                                              END) = '8' AND D3.RTN_RPT_DT IS NULL AND D3.FLD_AUD_END_DT IS NULL THEN '02'
                                                                  WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8'
                                                                              END) = '8' AND D3.RTN_RPT_DT IS NULL THEN '11'
                                                                  WHEN
                                                                        (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                              WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                              WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                              ELSE '8'
                                                                              END) = '7' THEN '02'
                                                                  END)
                                                        END
                                                   END)
                     ELSE (SELECT AUD_STEP_CD FROM TBBADDED101M WHERE AUD_YR = T1.AUD_YR AND AUD_NO = T1.AUD_NO AND AUD_STEP_CD = T1.PRSS_STEP_CD)
                     END
                  ) = #{schPrssStepCd}
                ]]>
            </if>
            <if test="schAudKndCd != null and schAudKndCd != ''">
                    AND T1.AUD_KND_CD  = #{schAudKndCd}
            </if>
            <if test="schSpvBrdvCd != null and schSpvBrdvCd != ''">
                    AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = T1.MNG_DPT_CD) = #{schSpvBrdvCd}
            </if>
            <if test="schDeptCd != null and schDeptCd != ''">
                    AND T1.MNG_DPT_CD = #{schDeptCd}
            </if>
            <if test="schReqDvsnCd != null and schReqDvsnCd != ''">
                    AND T1.REQ_DVSN_CD = #{schReqDvsnCd}
            </if>
            <if test="delayRsnRpt eq 2 " >
                     AND EXISTS (SELECT 1 FROM TBBADDED103M T4
                                     WHERE T1.AUD_YR = T4.AUD_YR
                                        AND T1.AUD_NO = T4.AUD_NO
                                        AND T4.RPRT_CD IN ( 'A10500300', 'A10602000')
                                        AND T4.APV_STA_CD = '30' )
            </if>
            <if test="delayRsnRpt eq  3 " >
                     AND NOT EXISTS (SELECT 1 FROM TBBADDED103M T4
                                     WHERE T1.AUD_YR = T4.AUD_YR
                                        AND T1.AUD_NO = T4.AUD_NO
                                        AND T4.RPRT_CD IN ( 'A10500300', 'A10602000')
                                        AND T4.APV_STA_CD = '30' )
            </if>
            <if test="audRprtType eq  2 " >
                    AND T2.GNR_HNDL_PLAN_YN = 'Y'
                    AND EXISTS (SELECT 1 FROM TBBADDED103M A 
                                         INNER JOIN TBDCMACM023H B 
                                                 ON A.APV_RQS_ID = B.APV_DOC_NO AND B.APVR_KND_CD = 1 AND B.APVR_STA_CD = '201' 
                              WHERE 1=1
                              AND A.AUD_YR = T1.AUD_YR
                                AND A.AUD_NO  = T1.AUD_NO
                                AND A.RPRT_CD = 'A10600200'
                                AND A.AUD_RPRT_DVSN_CD = '10'
                                AND A.AUD_STEP_CD = 'A1060') 
            </if>
             <if test="audRprtType eq  3 " >
                <![CDATA[
                    AND T2.GNR_HNDL_PLAN_YN <> 'Y'
                    ]]>
             </if>
                    ) A
                    ORDER BY AUD_YR, AUD_KND_CD, AUD_GRN_NO DESC
               ) G1
              WHERE 1=1
             
             <if test="extDurantion eq  2 " >
                  <![CDATA[
                    AND EXTN_PRD_COFM_DT <> 0
                    ]]>
            </if>
             <if test="extDurantion eq  3 " >
                    AND EXTN_PRD_COFM_DT = 0
             </if>
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectSubList1" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.selectSubList1 */
        <![CDATA[
            SELECT 
                F_CODE_NM ('1000030', AUD_BZT_KND_CD) AS AUD_BZT_KND_NM /*감사출장종류코드*/
                , TO_CHAR(TO_DATE(AUD_STR_DT),'YYYY-MM-DD') AS AUD_STR_DT
                , TO_CHAR(TO_DATE(AUD_END_DT),'YYYY-MM-DD') AS AUD_END_DT
                , AUD_DCN
                , (SELECT COUNT(1)
                FROM TBBADDED005L T2
                   WHERE T2.BZT_YR = T1.BZT_YR 
                     AND T2.BZT_SNO = T1.BZT_SNO) AS NOP_CNT
            FROM 
                TBBADDED002M T1
            WHERE REL_AUD_YR = #{audYr}
            AND REL_AUD_NO = #{audNo}
            UNION ALL
    SELECT 
                F_CODE_NM ('1000030', AUD_BZT_KND_CD) AS AUD_BZT_KND_NM /*감사출장종류코드*/
                , TO_CHAR(TO_DATE(AUD_STR_DT),'YYYY-MM-DD') AS AUD_STR_DT
                , TO_CHAR(TO_DATE(AUD_END_DT),'YYYY-MM-DD') AS AUD_END_DT
                , AUD_DCN
                , (SELECT COUNT(1)
                FROM TBBADDED005L T2
                   WHERE T2.BZT_YR = T1.BZT_YR 
                     AND T2.BZT_SNO = T1.BZT_SNO) AS NOP_CNT      
          FROM TBBADDED002M T1 INNER JOIN TBBADDED101L T2
              ON  T1.REL_AUD_YR = T2.REL_AUD_YR
            AND T1.REL_AUD_NO = T2.REL_AUD_NO
           WHERE T2.AUD_YR  = #{audYr}
              AND T2.AUD_NO = #{audNo}
            ORDER BY AUD_STR_DT 
         ]]>
    </select>
    
    <select id="selectExtnList" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.selectExtnList */
        <![CDATA[
          SELECT T2.AUD_YR
                   ,T2.AUD_NO
                   ,CASE WHEN T2.GNR_HNDL_PLAN_YN = 'Y' AND T2.CNT > 0 THEN 'Y'
                          ELSE 'N' END AS SYT_TRTM_YN
                   ,CASE WHEN T2.GNR_HNDL_PLAN_YN = 'Y' AND T2.CNT =0 THEN T2.TRTM_EXTN_PRD_DCN - 5 
                           WHEN T2.GNR_HNDL_PLAN_YN <> 'Y'  THEN T2.TRTM_EXTN_PRD_DCN
                             ELSE T2.TRTM_EXTN_PRD_DCN END AS TRTM_EXTN_PRD_DCN
                   ,T2.EXTN_PRD_DCN
                   ,CASE WHEN T2.GNR_HNDL_PLAN_YN = 'Y' AND T2.CNT =0 THEN T2.TOT_EXTN_PRD_DCN - 5 
                           WHEN T2.GNR_HNDL_PLAN_YN <> 'Y'  THEN T2.TOT_EXTN_PRD_DCN
                             ELSE T2.TOT_EXTN_PRD_DCN END AS TOT_EXTN_PRD_DCN      
           FROM
            ( SELECT T1.AUD_YR
                      , T1.AUD_NO
                      , DECODE(T1.GNR_HNDL_PLAN_YN, 'Y', NVL(F_GNR_HNDL_PLAN_EXTN_DCN(T1.AUD_YR, T1.AUD_NO) ,0) ,0) AS TRTM_EXTN_PRD_DCN								-- (2019.04.05 LSR 추가)
                      , NVL(T1.EXTN_PRD_COFM_DT, 0) AS EXTN_PRD_DCN
                      , DECODE(GNR_HNDL_PLAN_YN, 'Y', NVL(F_GNR_HNDL_PLAN_EXTN_DCN(T1.AUD_YR, T1.AUD_NO) ,0) ,0) + NVL(EXTN_PRD_COFM_DT,0) AS TOT_EXTN_PRD_DCN		-- (2019.04.05 LSR 추가)
                      , T1.GNR_HNDL_PLAN_YN
                      ,(SELECT COUNT(*) FROM TBBADDED103M A 
                                                     INNER JOIN TBDCMACM023H B 
                                                               ON A.APV_RQS_ID = B.APV_DOC_NO AND B.APVR_KND_CD = 1 AND B.APVR_STA_CD = '201' 
                       WHERE 1=1
                          AND A.AUD_YR = T1.AUD_YR
                          AND A.AUD_NO  = T1.AUD_NO
                          AND A.RPRT_CD = 'A10600200'
                          AND A.AUD_RPRT_DVSN_CD = '10'
                          AND A.AUD_STEP_CD = 'A1060') AS CNT
              FROM TBBADDED003M T1 
             WHERE T1.AUD_YR = #{audYr}
               AND T1.AUD_NO = #{audNo} ) T2
        ]]>
    </select>
    
     <update id="updateExtnData" parameterType="paramMap">
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.updateExtnData */
		CALL PRC_EXTN_HNDL_DDLN(#{audYr}, #{audNo}, #{extnPrdDcn}, #{sytTrtmYn}, #{usrId}, #{dptCd}, 'AEPFER014E')
    </update>
    
    <update id="updateDdlnDt" parameterType="paramMap">
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.updateDdlnDt */
        <![CDATA[
            UPDATE TBBADDED116M T1
    		SET LUNH_APT_DT = TO_CHAR(
    					  (SELECT TO_DATE(MAX(AUD_END_DT)) + 1 /* 귀청일자(실지감사단계 출장 종료일 + 1) */
    						 FROM TBBADDED002M T2
    						WHERE AUD_BZT_KND_CD IN ('02', '03', '04', 'A1030')
    						  AND T2.REL_AUD_YR = T1.AUD_YR
    						  AND T2.REL_AUD_NO = T1.AUD_NO
    					  )
    					  +
    					  (SELECT NVL(SUM(NVL(STAD_PRD_DCN,0))+SUM(NVL(EXTN_PRD_DCN,0)),0) /* 종료보고 이후~전단계의 기준일수 SUM */
    						 FROM TBBADDED116M T3
    						WHERE T3.AUD_YR = T1.AUD_YR
    						  AND T3.AUD_NO = T1.AUD_NO
    						  AND T3.AUD_PRSS_STEP_CD > '10004' /* 종료보고단계 이후 */
    						  AND T3.AUD_PRSS_STEP_CD < T1.AUD_PRSS_STEP_CD
    					  ), 'YYYYMMDD')
    		   , CMPT_DDLN_DT = TO_CHAR(
    					  (SELECT TO_DATE(MAX(AUD_END_DT)) + 1 /* 귀청일자(실지감사단계 출장 종료일 + 1) */
    						 FROM TBBADDED002M T2
    						WHERE AUD_BZT_KND_CD IN ('02', '03', '04', 'A1030')
    						  AND T2.REL_AUD_YR = T1.AUD_YR
    						  AND T2.REL_AUD_NO = T1.AUD_NO
    					  )
    					  +
    					  (SELECT NVL(SUM(NVL(STAD_PRD_DCN,0))+SUM(NVL(EXTN_PRD_DCN,0)),0) /* 종료보고 이후~현단계의 기준일수 SUM */
    						 FROM TBBADDED116M T3
    						WHERE T3.AUD_YR = T1.AUD_YR
    						  AND T3.AUD_NO = T1.AUD_NO
    						  AND T3.AUD_PRSS_STEP_CD > '10004' /* 종료보고단계 이후 */
    						  AND T3.AUD_PRSS_STEP_CD <= T1.AUD_PRSS_STEP_CD
    					  ), 'YYYYMMDD')
    		WHERE AUD_YR = #{audYr}
    		AND AUD_NO = #{audNo}
    		AND AUD_PRSS_STEP_CD > '10004'
        ]]>
    </update>
    
    
    <select id="selectDetailList" parameterType="paramMap" resultType="egovMap" >
            /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.selectDetailList */
            select 
				audNo
				, titNm
				, delay
				, mtrlDt
				, rsltDt
				, term 
			from(
			    select 
			        '2015-특정-001' as audNo
			        , '감사정보 수집 및 지역동향확인' as titNm
			        , '감사보고서 국장결재중 5일지연' as delay
			        , '2015-08-10' as mtrlDt
			        , '2015-10-30' as rsltDt
			        , '2016-01-17' as term
			    from dual
			) where 1 = 2
    </select>
    

    
    <select id="selectSubList2" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.selectSubList2 */

 <![CDATA[
            SELECT PRSS_STEP_NM
                 , TO_CHAR(TO_DATE(DDLN_DT), 'YYYY-MM-DD') AS DDLN_DT
                 , CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND NVL(EXTN_PRD_COFM_DT, 0)  = 0  THEN ''
                        WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND NVL(EXTN_PRD_COFM_DT, 0) <> 0 THEN TO_CHAR(TO_DATE(EXTN_DDLN_DT ) - 5, 'YYYY-MM-DD')
                        WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT > 0 AND NVL(EXTN_PRD_COFM_DT, 0) = 0 THEN TO_CHAR(TO_DATE(EXTN_DDLN_DT), 'YYYY-MM-DD')
                        WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT > 0 AND NVL(EXTN_PRD_COFM_DT, 0) <> 0 THEN TO_CHAR(TO_DATE(EXTN_DDLN_DT), 'YYYY-MM-DD')
                        WHEN GNR_HNDL_PLAN_YN <>'Y' AND NVL(EXTN_PRD_COFM_DT, 0) > 0  THEN TO_CHAR(TO_DATE(EXTN_DDLN_DT), 'YYYY-MM-DD')
                        ELSE ''
                        END  AS MDT_DT
                 , TO_CHAR(TO_DATE(APV_DT), 'YYYY-MM-DD') AS APV_DT
                 , CASE 
                       WHEN APV_DT IS NULL AND SYSDATE > TO_DATE(NVL((CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND PRSS_STEP_CD <> '03'  THEN TO_CHAR(TO_DATE(EXTN_DDLN_DT)  - 5 , 'YYYY-MM-DD')
                                                                                                     ELSE TO_CHAR(TO_DATE(EXTN_DDLN_DT), 'YYYY-MM-DD') END), DDLN_DT))
                       THEN TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD')) - TO_DATE(NVL((CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND PRSS_STEP_CD <> '03'  THEN TO_CHAR(TO_DATE(EXTN_DDLN_DT ) - 5 , 'YYYY-MM-DD')
                                                                                                                    ELSE TO_CHAR(TO_DATE(EXTN_DDLN_DT), 'YYYY-MM-DD') END), DDLN_DT))
                       WHEN APV_DT IS NOT NULL AND TO_DATE(APV_DT) > TO_DATE(NVL((CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND PRSS_STEP_CD <> '03'  THEN TO_CHAR(TO_DATE(EXTN_DDLN_DT ) - 5, 'YYYY-MM-DD')
                                                                                                                      ELSE TO_CHAR(TO_DATE(EXTN_DDLN_DT), 'YYYY-MM-DD') END), DDLN_DT))
                       THEN TO_DATE(APV_DT) - TO_DATE(NVL((CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND PRSS_STEP_CD <> '03'  THEN TO_CHAR(TO_DATE(EXTN_DDLN_DT ) - 5, 'YYYY-MM-DD')
                                                                                  ELSE TO_CHAR(TO_DATE(EXTN_DDLN_DT), 'YYYY-MM-DD') END), DDLN_DT))
                       ELSE 0
                   END AS DELAY_DT	-- (2019.04.05 LSR 수정)
              FROM (
                    
                   WITH BASE AS (SELECT '03' AS PRSS_STEP_CD, '종료보고' AS PRSS_STEP_NM, 'A' AS TOT_DHD_DVS_CD FROM DUAL UNION ALL
                                SELECT '06' AS PRSS_STEP_CD, '과장' AS PRSS_STEP_NM, 'A' AS TOT_DHD_DVS_CD FROM DUAL UNION ALL
                                SELECT '07' AS PRSS_STEP_CD, '국장' AS PRSS_STEP_NM, 'A' AS TOT_DHD_DVS_CD FROM DUAL UNION ALL
                                SELECT '08' AS PRSS_STEP_CD, '차총장' AS PRSS_STEP_NM, 'N' AS TOT_DHD_DVS_CD FROM DUAL UNION ALL
                                SELECT '09' AS PRSS_STEP_CD, '주심위원' AS PRSS_STEP_NM, 'N' AS TOT_DHD_DVS_CD FROM DUAL UNION ALL
                                SELECT '10' AS PRSS_STEP_CD, '시행' AS PRSS_STEP_NM, 'N' AS TOT_DHD_DVS_CD FROM DUAL UNION ALL
                                SELECT '08' AS PRSS_STEP_CD, '차장' AS PRSS_STEP_NM, 'Y' AS TOT_DHD_DVS_CD FROM DUAL UNION ALL
                                SELECT '09' AS PRSS_STEP_CD, '총장' AS PRSS_STEP_NM, 'Y' AS TOT_DHD_DVS_CD FROM DUAL UNION ALL
                                SELECT '10' AS PRSS_STEP_CD, '주심위원' AS PRSS_STEP_NM, 'Y' AS TOT_DHD_DVS_CD FROM DUAL UNION ALL
                                SELECT '11' AS PRSS_STEP_CD, '시행' AS PRSS_STEP_NM, 'Y' AS TOT_DHD_DVS_CD FROM DUAL)
                    SELECT T2.PRSS_STEP_NM
                         , T2.PRSS_STEP_CD
                         , CASE
                       	 		WHEN PSD_APV_DDLN_DT IS NOT NULL
                       	 		THEN
		                         	DECODE ( T2.PRSS_STEP_CD, '03', T1.RPT_DDLN_DT
		                                                   , '06', T1.BRDV_HNDL_DDLN_DT
		                                                   , '07', T1.RVW_RM_APV_DDLN_DT
		                                                   , '08', T1.DHD_APV_DDLN_DT
		                                                   , '09', T1.PSD_APV_DDLN_DT
		                                                   , '10', T1.CHF_CMTR_APV_DDLN_DT
		                                                   , '11', T1.ENF_APV_DDLN_DT )
                       	 		ELSE
		                         	DECODE ( T2.PRSS_STEP_CD, '03', T1.RPT_DDLN_DT
		                                                   , '06', T1.BRDV_HNDL_DDLN_DT
		                                                   , '07', T1.RVW_RM_APV_DDLN_DT
		                                                   , '08', T1.TOT_DHD_APV_DDLN_DT
		                                                   , '09', T1.CHF_CMTR_APV_DDLN_DT
		                                                   , '10', T1.ENF_APV_DDLN_DT )
                       	 	END AS DDLN_DT
                         , CASE
                       	 		WHEN PSD_APV_DDLN_DT IS NOT NULL
                       	 		THEN
		                         	DECODE ( T2.PRSS_STEP_CD, '03', T1.EXTN_RPT_DDLN_DT
		                                                   , '06', T1.EXTN_BRDV_HNDL_DDLN_DT
		                                                   , '07', T1.EXTN_RVW_RM_APV_DDLN_DT
		                                                   , '08', T1.EXTN_DHD_APV_DDLN_DT
		                                                   , '09', T1.EXTN_PSD_APV_DDLN_DT
		                                                   , '10', T1.EXTN_CHF_CMTR_APV_DDLN_DT
		                                                   , '11', T1.EXTN_ENF_APV_DDLN_DT )
                       	 		ELSE
		                         	DECODE ( T2.PRSS_STEP_CD, '03', T1.EXTN_RPT_DDLN_DT
		                                                   , '06', T1.EXTN_BRDV_HNDL_DDLN_DT
		                                                   , '07', T1.EXTN_RVW_RM_APV_DDLN_DT
		                                                   , '08', T1.EXTN_TOT_DHD_APV_DDLN_DT
		                                                   , '09', T1.EXTN_CHF_CMTR_APV_DDLN_DT
		                                                   , '10', T1.EXTN_ENF_APV_DDLN_DT )
                       	 	END AS EXTN_DDLN_DT
                         , CASE
                       	 		WHEN PSD_APV_DDLN_DT IS NOT NULL
                       	 		THEN
		                         	DECODE ( T2.PRSS_STEP_CD, '03',
																	(SELECT
																		TO_CHAR(MAX(DECODE(D2.APVR_PST_CD,'0055600',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
																							,DECODE(D2.APVR_PST_CD,'0045900',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),''))), 'YYYY-MM-DD') -- 사무차장, 본부장 결재일로 변경 2019.05.23 LSR
																	FROM TBBADDED103M D1
																	,TBDCMACM023L D2
																	WHERE 1=1
																	AND D1.APV_RQS_ID  = D2.APV_DOC_NO
																	AND D1.RPRT_CD     = 'A10500200' --종료보고서
																	AND D1.AUD_YR = T1.AUD_YR
																	AND D1.AUD_NO = T1.AUD_NO
																	GROUP BY D1.AUD_YR, D1.AUD_NO)
		                                                   , '06',
																	(SELECT
																	    MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0013600',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
   															                                                                                            ,DECODE(D2.APVR_PST_CD,'0057400',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),'')) END)
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4'))
		                                                   , '07',
																	(SELECT
																	    MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0015800',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
																	                              ,DECODE(D2.APVR_PST_CD,'0035100',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
																	                              ,DECODE(D2.APVR_PST_CD,'0058100',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),''))) END)	--국단실장결재일
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4'))
		                                                   , '08',
																	(SELECT
																	    MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0045900',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
																	                              ,DECODE(D2.APVR_PST_CD,'0055600',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),'')) END)	--사무차장결재일
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4'))
		                                                   , '09',
																	(SELECT
																	    MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0055700',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),'') END)	--사무총장결재일
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4'))
		                                                   , '10',
																	(SELECT
																	    TO_CHAR(MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN (SELECT MIN(D6.APV_DH)
																	                                                FROM TBDCMACM023H D6 
																	                                                    ,TBBADDED103M D7
																	                                               WHERE D6.APV_DOC_NO = D7.APV_RQS_ID
																	                                                 AND D6.APVR_KND_CD IN ('2','3','4')
																	                                                 AND D7.RPRT_CD = 'A10700100'
																	                                                 AND D7.APV_STA_CD = '30'
																	                                                 AND D6.APVR_PST_CD = '0010600'
																	                                                 AND D6.APVR_STA_CD <> '401'
																	                                                 AND REF_ID = D1.DOC_ID) END), 'YYYY-MM-DD')	--주심위원결재일
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4'))
		                                                   , '11', T1.ENF_APV_DT )
                       	 		ELSE
		                         	DECODE ( T2.PRSS_STEP_CD, '03',
																	(SELECT
																		TO_CHAR(MAX(DECODE(D2.APVR_PST_CD,'0055600',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
																							,DECODE(D2.APVR_PST_CD,'0045900',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),''))), 'YYYY-MM-DD') -- 사무차장, 본부장 결재일로 변경 2019.05.23 LSR
																	FROM TBBADDED103M D1
																	,TBDCMACM023L D2
																	WHERE 1=1
																	AND D1.APV_RQS_ID  = D2.APV_DOC_NO
																	AND D1.RPRT_CD     = 'A10500200' --종료보고서
																	AND D1.AUD_YR = T1.AUD_YR
																	AND D1.AUD_NO = T1.AUD_NO
																	GROUP BY D1.AUD_YR, D1.AUD_NO)
		                                                   , '06',
																	(SELECT
																	    MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0013600',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
   															                                                                                            ,DECODE(D2.APVR_PST_CD,'0057400',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),'')) END)
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4'))
		                                                   , '07',
																	(SELECT
																	    MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0015800',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
																	                              ,DECODE(D2.APVR_PST_CD,'0035100',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
																	                              ,DECODE(D2.APVR_PST_CD,'0058100',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),''))) END)	--국단실장결재일
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4'))
		                                                   , '08',
																	NVL((SELECT
																	    MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0055700',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),'') END)	--사무총장결재일
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4'))
																	,(SELECT
																	    MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0045900',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
																	                              ,DECODE(D2.APVR_PST_CD,'0055600',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),'')) END)	--사무차장결재일
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4')))
		                                                   , '09',
																	(SELECT
																	    TO_CHAR(MAX(CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN (SELECT MIN(D6.APV_DH)
																	                                                FROM TBDCMACM023H D6 
																	                                                    ,TBBADDED103M D7
																	                                               WHERE D6.APV_DOC_NO = D7.APV_RQS_ID
																	                                                 AND D6.APVR_KND_CD IN ('2','3','4')
																	                                                 AND D7.RPRT_CD = 'A10700100'
																	                                                 AND D7.APV_STA_CD = '30'
																	                                                 AND D6.APVR_STA_CD <> '401'
																	                                                 AND D6.APVR_PST_CD = '0010600'
																	                                                 AND REF_ID = D1.DOC_ID) END), 'YYYY-MM-DD')	--주심위원결재일
																	FROM TBBADDED103M D1
																	     ,TBDCMACM023L D2
																	WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
																	  AND D1.AUD_YR           = T1.AUD_YR
																	  AND D1.AUD_NO           = T1.AUD_NO
																	  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
																	  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
																	  AND D2.APVR_KND_CD IN ('1','2','3','4'))
		                                                   , '10', T1.ENF_APV_DT )
                       	 	END AS APV_DT
                         , T1.GNR_HNDL_PLAN_YN
                         , T1.EXTN_PRD_COFM_DT
                         ,(SELECT COUNT(*) FROM TBBADDED103M A 
                                         INNER JOIN TBDCMACM023H B 
                                                 ON A.APV_RQS_ID = B.APV_DOC_NO AND B.APVR_KND_CD = 1 AND B.APVR_STA_CD = '201' 
                              WHERE 1=1
                              AND A.AUD_YR = T1.AUD_YR
                                AND A.AUD_NO  = T1.AUD_NO
                                AND A.RPRT_CD = 'A10600200'
                                AND A.AUD_RPRT_DVSN_CD = '10'
                                AND A.AUD_STEP_CD = 'A1060') AS CNT
                      FROM TBBADDED003M T1, BASE T2
                     WHERE T1.AUD_YR = #{audYr}
                       AND T1.AUD_NO = #{audNo}
	                     AND (T2.TOT_DHD_DVS_CD = DECODE(T1.PSD_APV_DDLN_DT, NULL, 'N', 'Y') 
	                     		OR T2.TOT_DHD_DVS_CD = 'A')
                   ) 
          ]]>
	</select>
    
    <select id="selectSubList3" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.selectSubList3 */
        <![CDATA[
            SELECT CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 THEN TO_CHAR(TO_DATE(HNDL_DDLN_DT)  - 5, 'YYYY-MM-DD')
                        ELSE TO_CHAR(TO_DATE(HNDL_DDLN_DT), 'YYYY-MM-DD') END AS HNDL_DDLN_DT   
                 , ENF_DT
                 , STAD_HNDL_DT
                 , CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 THEN TO_CHAR(EXTN_PRD_COFM_DT  - 5)
                        ELSE TO_CHAR(EXTN_PRD_COFM_DT) END AS EXTN_PRD_COFM_DT
                 , CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND EXTN_PRD_COFM_DT1 = 0  THEN ''
                        WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND EXTN_PRD_COFM_DT1 <> 0 THEN TO_CHAR(EXTN_HNDL_DT  - 5)
                        ELSE TO_CHAR(EXTN_HNDL_DT) END AS EXTN_HNDL_DT
                 , CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 THEN TO_CHAR(REAL_HNDL_DT  - 5)
                        ELSE TO_CHAR(REAL_HNDL_DT) END AS REAL_HNDL_DT                
                 ,CASE WHEN  ((CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 THEN TO_CHAR(REAL_HNDL_DT  - 5)
                                   ELSE TO_CHAR(REAL_HNDL_DT) END) - 
                             (CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND EXTN_PRD_COFM_DT1 = 0  THEN ''
                                   WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND EXTN_PRD_COFM_DT1 <> 0 THEN TO_CHAR(EXTN_HNDL_DT  - 5)
                                    ELSE TO_CHAR(EXTN_HNDL_DT) END))  > 0 THEN ((CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 THEN TO_CHAR(REAL_HNDL_DT  - 5)
                                   ELSE TO_CHAR(REAL_HNDL_DT) END) - 
                             (CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND EXTN_PRD_COFM_DT1 = 0  THEN ''
                                   WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0 AND EXTN_PRD_COFM_DT1 <> 0 THEN TO_CHAR(EXTN_HNDL_DT  - 5)
                                    ELSE TO_CHAR(EXTN_HNDL_DT) END))
                         ELSE 0 END AS EXCS_DT
              FROM (
                    SELECT 
--                    	TO_CHAR(
--                                DECODE(T1.GNR_HNDL_PLAN_YN, 'N', TO_DATE(T1.HNDL_DDLN_DT) + NVL(T1.EXTN_PRD_COFM_DT, 0)
--                                                        , 'Y', 5 + TO_DATE(T1.HNDL_DDLN_DT) + NVL(T1.EXTN_PRD_COFM_DT, 0),'') , 'YYYY-MM-DD') AS HNDL_DDLN_DT
                         NVL(T1.EXTN_HNDL_DDLN_DT, T1.HNDL_DDLN_DT) AS HNDL_DDLN_DT			-- (2019.04.18 LSR 수정)
                         , TO_CHAR(TO_DATE(T1.ENF_APV_DT),'YYYY-MM-DD') AS ENF_DT
                         , NVL(T1.STAD_HNDL_DCN, 0) AS STAD_HNDL_DT
--                         , DECODE(T1.GNR_HNDL_PLAN_YN, 'N', NVL(T1.EXTN_PRD_COFM_DT, 0)
--                                                     , 'Y', 5 + NVL(T1.EXTN_PRD_COFM_DT, 0), '0') AS EXTN_PRD_COFM_DT
                         , DECODE(T1.GNR_HNDL_PLAN_YN, 'N', NVL(T1.EXTN_PRD_COFM_DT, 0)
                                                     , 'Y', NVL(F_GNR_HNDL_PLAN_EXTN_DCN(T1.AUD_YR, T1.AUD_NO), 0) + NVL(T1.EXTN_PRD_COFM_DT, 0), '0') AS EXTN_PRD_COFM_DT	-- (2019.04.18 LSR 수정)
--                         , NVL(T1.STAD_HNDL_DCN, 0)
--                           + DECODE(T1.GNR_HNDL_PLAN_YN, 'N', NVL(T1.EXTN_PRD_COFM_DT, 0)
--                                                     , 'Y', 5 + NVL(T1.EXTN_PRD_COFM_DT, 0), '0') AS EXTN_HNDL_DT
                         , NVL(T1.STAD_HNDL_DCN, 0)
                           + DECODE(T1.GNR_HNDL_PLAN_YN, 'N', NVL(T1.EXTN_PRD_COFM_DT, 0)
                                                     , 'Y', NVL(F_GNR_HNDL_PLAN_EXTN_DCN(T1.AUD_YR, T1.AUD_NO), 0) + NVL(T1.EXTN_PRD_COFM_DT, 0), '0') AS EXTN_HNDL_DT	-- (2019.04.18 LSR 수정)
--                         , NVL(NVL(TO_DATE(T1.ENF_APV_DT), TO_DATE(TO_CHAR(SYSDATE, 'YYYY/MM/DD'))) - (TO_DATE(T1.RTN_DT)-1), 0) AS REAL_HNDL_DT
                         , NVL(CASE WHEN NVL(T1.EXTN_PRD_COFM_DT, 0) > 0 OR NVL(T1.GNR_HNDL_PLAN_YN, 'N') = 'Y'
                         			THEN F_EXTN_HNDL_DT_CNT(T1.AUD_YR, T1.AUD_NO, TO_CHAR(TO_DATE(T1.RTN_DT)-1, 'YYYYMMDD'), NVL(T1.ENF_APV_DT, TO_CHAR(SYSDATE, 'YYYYMMDD')), '5', '9', 'T')
                         			ELSE F_HNDL_DT_CNT(T1.AUD_YR, T1.AUD_NO, TO_CHAR(TO_DATE(T1.RTN_DT)-1, 'YYYYMMDD'), NVL(T1.ENF_APV_DT, TO_CHAR(SYSDATE, 'YYYYMMDD')), '2', '9')
                         		END, 0) AS REAL_HNDL_DT	-- (2019.04.18 LSR 수정)
                         ,(SELECT COUNT(*) FROM TBBADDED103M A 
                                         INNER JOIN TBDCMACM023H B 
                                                 ON A.APV_RQS_ID = B.APV_DOC_NO AND B.APVR_KND_CD = 1 AND B.APVR_STA_CD = '201' 
                              WHERE 1=1
                              AND A.AUD_YR = T1.AUD_YR
                                AND A.AUD_NO  = T1.AUD_NO
                                AND A.RPRT_CD = 'A10600200'
                                AND A.AUD_RPRT_DVSN_CD = '10'
                                AND A.AUD_STEP_CD = 'A1060') AS CNT
                           , T1.GNR_HNDL_PLAN_YN
                          , NVL(T1.EXTN_PRD_COFM_DT, 0) AS EXTN_PRD_COFM_DT1
                      FROM TBBADDED003M T1
                     WHERE T1.AUD_YR = #{audYr}
                       AND T1.AUD_NO = #{audNo}
                    )
        ]]>
    </select>
    
    
    <select id="selectSubList4" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.selectSubList4 */
        <![CDATA[
           SELECT F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, A.AUD_KND_CD, '-') AS AUD_YR_NO,B.TSK_KEY2, B.EXEC_NO,
                    CASE WHEN B.TSK_KEY2 IN ( '2', '3') THEN NVL((SELECT MAX(TO_CHAR(TO_DATE(A9.EXAM_RPT_APV_DT),'YYYY-MM-DD')) AS EXAM_RPT_APV_DT
                                                                FROM TBCSPEAR001M A9
                                                                             WHERE  A9.ACP_YR  = B.TSK_KEY1
                                                                            AND A9.REQ_DVSN_CD = B.TSK_KEY2
                                                                            AND A9.CVPT_ACP_NO = B.TSK_KEY3), '결정일 미정')
                         WHEN B.TSK_KEY2 = '4' THEN NVL((SELECT  TO_CHAR(TO_DATE(A10.REQ_DT),'YYYY-MM-DD') FROM TBCSPEAR007M A10 WHERE A10.ACP_YR  = B.TSK_KEY1
                                                                                                                               AND A10.REQ_DVSN_CD = B.TSK_KEY2
                                                                                                                               AND A10.CVPT_ACP_NO = B.TSK_KEY3  ) , '결정일 미정')
                       ELSE '해당없음' END AS REQ_DT,
                    CASE WHEN B.TSK_KEY2 = '2'  THEN (SELECT CASE WHEN A10.EXAM_RPT_APV_DT IS NOT NULL AND A10.REQ_EXAM_RSLT_CD = '01' THEN TO_CHAR(TO_DATE(A10.EXAM_RPT_APV_DT)+59, 'YYYY-MM-DD')
                                                                  WHEN A10.EXAM_RPT_APV_DT IS NULL OR A10.REQ_EXAM_RSLT_CD <> '01' THEN ''
                                                             ELSE '' END
                                                        FROM TBCSPEAR001M A10
                                                       WHERE A10.ACP_YR  = B.TSK_KEY1
                                                         AND A10.REQ_DVSN_CD = B.TSK_KEY2
                                                         AND A10.CVPT_ACP_NO = B.TSK_KEY3  )
                         WHEN B.TSK_KEY2 = '3'  THEN (SELECT CASE WHEN A10.EXAM_RPT_APV_DT IS NOT NULL AND A10.REQ_EXAM_RSLT_CD = '01' THEN TO_CHAR(ADD_MONTHS(TO_DATE(A10.EXAM_RPT_APV_DT), 6),'YYYY-MM-DD')
                                                                  WHEN A10.EXAM_RPT_APV_DT IS NULL OR A10.REQ_EXAM_RSLT_CD <> '01' THEN ''
                                                                  ELSE '' END
                                                        FROM TBCSPEAR001M A10
                                                       WHERE A10.ACP_YR  = B.TSK_KEY1
                                                         AND A10.REQ_DVSN_CD = B.TSK_KEY2
                                                         AND A10.CVPT_ACP_NO = B.TSK_KEY3  )
                         WHEN B.TSK_KEY2 = '4' THEN (SELECT CASE WHEN A10.EXTN_YN = 'Y' THEN  TO_CHAR(TO_DATE(A10.EXTN_HNDL_DDLN_DT),'YYYY-MM-DD')
                                                                 ELSE A10.HNDL_DDLN_DT END
                                                       FROM TBCSPEAR007M A10
                                                      WHERE A10.ACP_YR  = B.TSK_KEY1
                                                        AND A10.REQ_DVSN_CD = B.TSK_KEY2
                                                        AND A10.CVPT_ACP_NO = B.TSK_KEY3  )
                          ELSE '해당없음' END  AS HNDL_DDLN_DT2
                       ,EXTN_YN
            FROM TBBADDED001M A
                 INNER JOIN (SELECT  CASE WHEN DVSN_CD IN ('1','2','3') THEN (SELECT S1.ACP_YR||'-'||F_CODE_NM('1000740',S1.REQ_DVSN_CD)||'-'||S1.RM_CVPT_ACP_NO
                                                                                                         FROM TBCSPDCP101M S1
                                                                                                        WHERE T1.TSK_KEY1 = S1.ACP_YR
                                                                                                          AND T1.TSK_KEY2 = S1.REQ_DVSN_CD
                                                                                                          AND T1.TSK_KEY3 = S1.CVPT_ACP_NO)
                                                                   WHEN DVSN_CD = '4'            THEN T1.TSK_KEY1 ||'-국회-'|| T1.TSK_KEY3 
                                                                   WHEN DVSN_CD IN ('5','6','7') THEN (SELECT CASE WHEN S1.ACP_YR >= '2016' THEN S1.ACP_YR || '-' || DECODE(S1.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') || '-' || S1.ACP_SRNO
                                                                                                                   ELSE S1.ACP_YR || '-' || S1.ACP_DVSN_CD || '-' || S1.ACP_SRNO END
                                                                                                         FROM TBBADFRE012M S1
                                                                                                        WHERE T1.TSK_KEY1 = S1.ACP_YR
                                                                                                          AND T1.TSK_KEY2 = S1.ACP_DVSN_CD
                                                                                                          AND T1.TSK_KEY3 = S1.ACP_SRNO
                                                                                                          AND T1.TSK_KEY4 = S1.DPT_CD)
                                                                   WHEN DVSN_CD IN ('8','9')     THEN (SELECT CASE WHEN S1.OGN_DVSN_CD = '6' THEN S1.YR||'-판청-'||S1.ACP_NO
                                                                                                                   ELSE S1.YR||'-손망-'||S1.ACP_NO END
                                                                                                         FROM TBBADGDA001M S1
                                                                                                        WHERE T1.TSK_KEY1 = S1.ORG_CD
                                                                                                          AND T1.TSK_KEY2 = S1.NTF_DVSN_CD
                                                                                                          AND T1.TSK_KEY3 = S1.NNB)
                                                                   WHEN DVSN_CD = '0'            THEN TSK_KEY1 ||'-정보-'|| TSK_KEY2
                                                                   WHEN DVSN_CD = 'A'            THEN F_MNG_KND_AUDYRNO(TSK_KEY1, TSK_KEY2, (SELECT AUD_KND_CD
                                                                                                                                               FROM TBBADDED001M
                                                                                                                                              WHERE AUD_YR = TSK_KEY1
                                                                                                                                                AND AUD_NO = TSK_KEY2), '-') ||'-'|| TSK_KEY3 ||'-'|| F_ORG_INFO(TSK_KEY4,'1')
                                                                   WHEN DVSN_CD = 'C'            THEN TSK_KEY1 ||'-청금-'||(SELECT RM_CVPT_ACP_NO FROM TBDCPDCP101M WHERE 1=1 AND ACP_YR = TSK_KEY1 AND REQ_DVSN_CD = TSK_KEY2 AND CVPT_ACP_NO = TSK_KEY3)
														                                                                                      /*청탁금지법 추가 2020.12.15 최성호*/
                                                                   WHEN DVSN_CD = 'D'           THEN TSK_KEY1 ||'-'||F_CODE_NM('1000742', 'D')||'-'||(SELECT RM_CVPT_ACP_NO FROM TBCORCOR101M WHERE 1=1 AND ACP_YR = TSK_KEY1 AND REQ_DVSN_CD = TSK_KEY2 AND CVPT_ACP_NO = TSK_KEY3)
																								   										    /*부패방지법 추가 2020.12.15 최성호*/
                                                                      ELSE '' END AS EXEC_NO
                                   , T1.AUD_YR , T1.AUD_NO , T1.TSK_KEY1, T1.TSK_KEY2, T1.TSK_KEY3
                                   ,CASE WHEN DVSN_CD = '4' THEN(SELECT  A10.EXTN_YN
                                                                                                         FROM TBCSPEAR007M A10
                                                                                                        WHERE A10.ACP_YR  = T1.TSK_KEY1
                                                                                                           AND A10.REQ_DVSN_CD = T1.TSK_KEY2
                                                                                                           AND A10.CVPT_ACP_NO = T1.TSK_KEY3) 
                                            ELSE '해당없음' END AS EXTN_YN
                              FROM TBBADDED030L T1 ) B
                         ON A.AUD_YR = B.AUD_YR
                        AND A.AUD_NO = B.AUD_NO
            WHERE A.AUD_YR = #{audYr}
            AND A.AUD_NO = #{audNo}
            AND A.AUD_KND_CD NOT LIKE '%5'
            ORDER BY A.AUD_YR, A.AUD_NO, B.TSK_KEY1, B.TSK_KEY2, B.TSK_KEY3
        ]]>
    </select>
    
    <select id="selectDlayRprt" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.selectDlayRprt */
        SELECT T1.DOC_ID, T1.RPRT_NM, T1.RPRT_CD, T1.AUD_STEP_CD , F_CODE_NM('1000894', T2.DOC_WRIT_KND_CD) AS DOC_TYPE
          FROM TBBADDED103M T1 
               INNER JOIN TBBADDED001M T2
                      ON T1.AUD_YR = T2.AUD_YR
                     AND T1.AUD_NO = T2.AUD_NO
         WHERE T1.AUD_YR = #{audYr}
           AND T1.AUD_NO = #{audNo}
           AND T1.RPRT_CD = #{rprtCd}
    </select>


  <select id="selectCalendar" parameterType="paramMap" resultType="egovMap" >
        <![CDATA[
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.selectCalendar */
	        SELECT DATATYP
	             , CMMCDNM
	             , STDT
	             , DECODE(STDT, ENDDT, ENDDT, TO_CHAR(TO_DATE(ENDDT)+1,'YYYY-MM-DD')) AS ENDDT
	          FROM (    
	            SELECT DECODE(AUD_BZT_KND_CD, '00', '1', '01', '2', '3') AS DATATYP
	                 , F_CODE_NM ('1000030', DECODE(AUD_BZT_KND_CD, '03', '02', AUD_BZT_KND_CD)) AS CMMCDNM
	                 , TO_CHAR(TO_DATE(MIN(AUD_STR_DT)),'YYYY-MM-DD') AS STDT
	                 , TO_CHAR(TO_DATE(MAX(AUD_END_DT)),'YYYY-MM-DD') AS ENDDT
	              FROM TBBADDED002M
	             WHERE REL_AUD_YR = #{audYr}
	               AND REL_AUD_NO = #{audNo}
	             GROUP BY AUD_BZT_KND_CD , REL_AUD_YR, REL_AUD_NO
	            HAVING AUD_BZT_KND_CD IN ('00','01','02','03')
	            UNION ALL
-- 총,차장 단계 분리로 인하여 코드 재정의 (2019.04.18 LSR 수정)	                   
	            SELECT DECODE(RNUM, 1, '4', '0') AS DATATYP
                     , CASE
                   	 		WHEN PSD_APV_DDLN_DT IS NOT NULL
                   	 		THEN
				                  DECODE(RNUM ,1, '귀청일'
				                               ,2, '종료보고기준일'
				                               ,3, '과장결재기준일'
				                               ,4, '국장결재기준일'
				                               ,5, '차장결재기준일'
				                               ,6, '총장결재기준일'
				                               ,7, '주심위원결재기준일'
				                               ,8, '시행기준일','')
                   	 		ELSE
				                  DECODE(RNUM ,1, '귀청일'
				                               ,2, '종료보고기준일'
				                               ,3, '과장결재기준일'
				                               ,4, '국장결재기준일'
				                               ,5, '총차장결재기준일'
				                               ,6, '주심위원결재기준일'
				                               ,7, '시행기준일','')
			         END AS CMMCDNM
                      ,DECODE(RNUM, 1, TO_CHAR(TO_DATE(STDT), 'YYYY-MM-DD'),
                                           2, TO_CHAR(TO_DATE(NVL(EXTN_STDT, STDT)), 'YYYY-MM-DD') ,
                                          CASE WHEN GNR_HNDL_PLAN_YN = 'Y' AND CNT = 0   THEN TO_CHAR(TO_DATE(NVL(EXTN_STDT, STDT)) - 5 , 'YYYY-MM-DD') 
                                                   ELSE TO_CHAR(TO_DATE(NVL(EXTN_STDT, STDT)), 'YYYY-MM-DD')
                                                   END ) AS STDT	-- (2019.04.05 LSR 수정)
	                  ,ENDDT
	              FROM (   
	                SELECT ROWNUM AS RNUM
                         , CASE
                       	 		WHEN PSD_APV_DDLN_DT IS NOT NULL
                       	 		THEN
				                      DECODE(ROWNUM, 1, RTN_DT
				                                    , 2, RPT_DDLN_DT
				                                    , 3, BRDV_HNDL_DDLN_DT
				                                    , 4, RVW_RM_APV_DDLN_DT
				                                    , 5, DHD_APV_DDLN_DT
				                                    , 6, PSD_APV_DDLN_DT
				                                    , 7, CHF_CMTR_APV_DDLN_DT
				                                    , 8, ENF_APV_DDLN_DT
				                                    ,'')
                       	 		ELSE
				                      DECODE(ROWNUM, 1, RTN_DT
				                                    , 2, RPT_DDLN_DT
				                                    , 3, BRDV_HNDL_DDLN_DT
				                                    , 4, RVW_RM_APV_DDLN_DT
				                                    , 5, TOT_DHD_APV_DDLN_DT
				                                    , 6, CHF_CMTR_APV_DDLN_DT
				                                    , 7, ENF_APV_DDLN_DT
				                                    ,'')
				         END AS STDT
                         , CASE
                       	 		WHEN PSD_APV_DDLN_DT IS NOT NULL
                       	 		THEN                
			                          DECODE(ROWNUM, 1, RTN_DT
			                                        , 2, EXTN_RPT_DDLN_DT
			                                        , 3, EXTN_BRDV_HNDL_DDLN_DT
			                                        , 4, EXTN_RVW_RM_APV_DDLN_DT
			                                        , 5, EXTN_DHD_APV_DDLN_DT
			                                        , 6, EXTN_PSD_APV_DDLN_DT
			                                        , 7, EXTN_CHF_CMTR_APV_DDLN_DT
			                                        , 8, EXTN_ENF_APV_DDLN_DT
			                                        ,'')
                       	 		ELSE
			                          DECODE(ROWNUM, 1, RTN_DT
			                                        , 2, EXTN_RPT_DDLN_DT
			                                        , 3, EXTN_BRDV_HNDL_DDLN_DT
			                                        , 4, EXTN_RVW_RM_APV_DDLN_DT
			                                        , 5, EXTN_TOT_DHD_APV_DDLN_DT
			                                        , 6, EXTN_CHF_CMTR_APV_DDLN_DT
			                                        , 7, EXTN_ENF_APV_DDLN_DT
			                                        ,'')
				         END AS EXTN_STDT
	                      ,'' AS ENDDT
	                      ,GNR_HNDL_PLAN_YN
	                      ,EXTN_PRD_COFM_DT
	                      ,PSD_APV_DDLN_DT
	                      ,(SELECT COUNT(*)
	                        FROM TBBADDED103M A 
                                    INNER JOIN TBDCMACM023H B 
                                              ON A.APV_RQS_ID = B.APV_DOC_NO AND B.APVR_KND_CD = 1 AND B.APVR_STA_CD = '201' 
                          WHERE 1=1
                             AND A.AUD_YR = T1.AUD_YR
                             AND A.AUD_NO  = T1.AUD_NO
                             AND A.RPRT_CD = 'A10600200'
                             AND A.AUD_RPRT_DVSN_CD = '10'
                             AND A.AUD_STEP_CD = 'A1060') AS CNT
	                  FROM (
	                        SELECT 1
	                          FROM DUAL
	                        CONNECT BY LEVEL <= (SELECT DECODE(PSD_APV_DDLN_DT, NULL, '7', '8') FROM TBBADDED003M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo})
	                       ), TBBADDED003M T1
	                 WHERE T1.AUD_YR = #{audYr}
	                    AND T1.AUD_NO = #{audNo})
	            UNION ALL
                  SELECT *
                  FROM (
                    SELECT
	                     CASE
	                   	 	 WHEN PSD_APV_DDLN_DT IS NOT NULL
	                   	 	 THEN
		                    	  DECODE(NO, 1, '5'
		                                    , 2, '6'
		                                    , 3, '7'
		                                    , 4, '8'
		                                    , 5, '9', '')
	                   	 	 ELSE
		                    	  DECODE(NO, 1, '5'
                                    		, 2, '6'
		                                    , 3, '7'
		                                    , 4, '8', '')
	                   	 END AS DATATYP
	                     , CASE
	                   	 	 WHEN PSD_APV_DDLN_DT IS NOT NULL
	                   	 	 THEN
		                          DECODE(NO, 1, '과장결재'
		                                    , 2, '국장결재'
		                                    , 3, '차장결재'
		                                    , 4, '총장결재'
		                                    , 5, '주심위원결재', '')
	                   	 	 ELSE
		                          DECODE(NO, 1, '과장결재'
		                                    , 2, '국장결재'
		                                    , 3, '총차장결재'
		                                    , 4, '주심위원결재', '')
	                   	 END AS CMMCDNM
	                     , CASE
	                   	 	 WHEN PSD_APV_DDLN_DT IS NOT NULL
	                   	 	 THEN
		                          DECODE(NO, 1, S5
		                                    , 2, E5
		                                    , 3, E6
		                                    , 4, E7
		                                    , 5, S8, '')
	                   	 	 ELSE
		                           DECODE(NO, 1, S5
		                                    , 2, E5
		                                    , 3, E6
		                                    , 4, S8, '')
	                   	 END AS STDT
	                     , CASE
	                   	 	 WHEN PSD_APV_DDLN_DT IS NOT NULL
	                   	 	 THEN
		                          DECODE(NO, 1, E5
		                                    , 2, E6
		                                    , 3, E7
		                                    , 4, E8
		                                    , 5, E9, '')
	                   	 	 ELSE
		                          DECODE(NO, 1, E5
		                                    , 2, E6
		                                    , 3, NVL(E8, E7)
		                                    , 4, E9, '')
	                   	 END AS ENDDT
                      FROM (
                        SELECT TO_CHAR(MIN(S5), 'YYYY-MM-DD') AS S5
                              ,TO_CHAR(TO_DATE(MIN(S8)), 'YYYY-MM-DD') AS S8
                              ,TO_CHAR(TO_DATE(MAX(E5)), 'YYYY-MM-DD') AS E5
                              ,TO_CHAR(TO_DATE(MAX(E6)), 'YYYY-MM-DD') AS E6
                              ,TO_CHAR(TO_DATE(MAX(E7)), 'YYYY-MM-DD') AS E7
               	 			  ,TO_CHAR(TO_DATE(MAX(E8)), 'YYYY-MM-DD') AS E8
	                       	  ,TO_CHAR(MAX(E9), 'YYYY-MM-DD') AS E9
	                       	  ,PSD_APV_DDLN_DT
                         FROM (
                               SELECT D1.AUD_YR
                                     ,D1.AUD_NO
                                     ,CASE WHEN D2.APVR_KND_CD = '1' AND D1.RPRT_CD = 'A10600200' THEN (SELECT MIN(D6.APV_DH) 
                                                                                FROM TBDCMACM023H D6 
                                                                                    ,TBBADDED103M D7
                                                                               WHERE D6.APV_DOC_NO = D7.APV_RQS_ID
                                                                                 AND D6.APVR_KND_CD = '1'
                                                                                 AND D7.RPRT_CD = 'A10600200'
                                                                                 AND D7.DOC_ID = D1.DOC_ID) END AS S5
                                    ,CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0013600',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
                                                              ,DECODE(D2.APVR_PST_CD,'0057400',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),'')) END                                AS E5   --과장결재일                               AS E5   --과장결재일
                                     ,CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0015800',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
                                                              ,DECODE(D2.APVR_PST_CD,'0035100',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
                                                              ,DECODE(D2.APVR_PST_CD,'0058100',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),''))) END                               AS E6   --국단실장결재일
                                     ,CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0045900',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB)
                                                              ,DECODE(D2.APVR_PST_CD,'0055600',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),'')) END                                AS E7   --사무차장결재일
                                     ,CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0055700',F_GET_FIRST_APVR_DH(D1.DOC_ID,D2.APVR_CNB),'') END                                 AS E8 --사무총장결재일
                                     ,CASE WHEN D2.APVR_KND_CD = '1' THEN (SELECT TO_CHAR(MIN(D6.APV_DH), 'YYYY-MM-DD') 
                                                                                FROM TBDCMACM023H D6 
                                                                                    ,TBBADDED103M D7
                                                                               WHERE D6.APV_DOC_NO = D7.APV_RQS_ID
                                                                                 AND D6.APVR_KND_CD = '1'
                                                                                 AND D7.RPRT_CD = 'A10700100'
                                                                                 AND D6.APVR_STA_CD <> '401'
                                                                                 AND REF_ID = D1.DOC_ID) END AS S8
                                     ,CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN (SELECT MIN(D6.APV_DH)
                                                                                FROM TBDCMACM023H D6 
                                                                                    ,TBBADDED103M D7
                                                                               WHERE D6.APV_DOC_NO = D7.APV_RQS_ID
                                                                                 AND D6.APVR_KND_CD IN ('2','3','4')
                                                                                 AND D7.RPRT_CD = 'A10700100'
                                                                                 AND D7.APV_STA_CD = '30'
                                                                                 AND D6.APVR_PST_CD = '0010600'
                                                                                 AND D6.APVR_STA_CD <> '401'
                                                                                 AND REF_ID = D1.DOC_ID) END                                AS E9    --주심위원결재일
                                     
                                     ,CASE WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10600200' THEN DECODE(D2.APVR_PST_CD,'0013600','5','0057400','5',
                                                                                      '0015800','6',
                                                                                      '0035100','6',
                                                                                      '0058100','6',
                                                                                      '0055600','7',
                                                                                      '0045900','7',
                                                                                      '0055700','7',
                                                                                      '')
                                           WHEN D2.APVR_KND_CD IN ('2','3','4') AND D1.RPRT_CD = 'A10700100' THEN DECODE(D2.APVR_PST_CD,'0010600','8',
                                                                                      '')
                                           WHEN D2.APVR_KND_CD = '1' THEN(DECODE(D1.RPRT_CD, 'A10600200', '5'
                                                                                           , 'A10700100', '8')) END AS APV_KND    --주심위원결재일
                                     ,D1.SYT_TRTM_DVSN_YN
                                     ,D3.PSD_APV_DDLN_DT
                                 FROM TBBADDED103M D1
                                     ,TBDCMACM023L D2
                                     ,TBBADDED003M D3
                                WHERE D1.APV_RQS_ID       = D2.APV_DOC_NO
                                  AND D1.AUD_YR = D3.AUD_YR(+)
                                  AND D1.AUD_NO = D3.AUD_NO(+)
                                  AND D1.AUD_YR           = #{audYr} --PARAM
                                  AND D1.AUD_NO           = #{audNo}
                                  AND D1.RPRT_CD          IN ('A10600200','A10700100') --감사보고서,주심위원설명자료
                                  AND D1.AUD_RPRT_DVSN_CD = '10'   --TEST (10:본안,20:우선,30:별도,40:재부의)
                                  AND D2.APVR_KND_CD IN ('1','2','3','4')
                                ORDER BY D1.AUD_YR,D1.AUD_NO,D1.RPRT_CD,D2.APV_SNO,D2.APVR_SEQ
                               ) D3
                            GROUP BY PSD_APV_DDLN_DT
                           ) D4 , (SELECT LEVEL NO FROM DUAL CONNECT BY LEVEL <= (SELECT DECODE(PSD_APV_DDLN_DT, NULL, '4', '5') FROM TBBADDED003M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo})) D5
                       )
                   WHERE STDT IS NOT NULL
	           UNION ALL
	           SELECT DATATYP
	                 , CMMCDNM
	                 , STDT
	                 , ENDDT
	              FROM (
	                SELECT '10' AS DATATYP
	                    , '시행일' CMMCDNM
	                    , TO_CHAR(TO_DATE(MIN(ENF_APV_DT)),'YYYY-MM-DD') AS STDT
	                    , '' AS ENDDT
	                 FROM TBBADDED003M
	                WHERE AUD_YR = #{audYr}
	                  AND AUD_NO = #{audNo}
	                GROUP BY AUD_YR, AUD_NO )
	             WHERE STDT IS NOT NULL
	           UNION ALL
	           SELECT '11' AS DATATYP
                      ,'종료보고' AS CMMCDNM
--                      ,TO_CHAR (MAX(DECODE(C1.APV_STA_CD,'30',C2.APV_DH,'')), 'YYYY-MM-DD')       AS STDT   --최종결재일
--                      ,TO_CHAR (MAX(DECODE(C1.APV_STA_CD,'30',C2.APV_DH,'')), 'YYYY-MM-DD')       AS ENDDT   --최종결재일
						, TO_CHAR(MAX(DECODE(C2.APVR_PST_CD,'0055600',F_GET_FIRST_APVR_DH(C1.DOC_ID,C2.APVR_CNB)
											,DECODE(C2.APVR_PST_CD,'0045900',F_GET_FIRST_APVR_DH(C1.DOC_ID,C2.APVR_CNB),''))), 'YYYY-MM-DD') AS STDT -- 사무차장, 본부장 결재일로 변경 2019.05.23 LSR
						, TO_CHAR(MAX(DECODE(C2.APVR_PST_CD,'0055600',F_GET_FIRST_APVR_DH(C1.DOC_ID,C2.APVR_CNB)
											,DECODE(C2.APVR_PST_CD,'0045900',F_GET_FIRST_APVR_DH(C1.DOC_ID,C2.APVR_CNB),''))), 'YYYY-MM-DD') AS ENDDT -- 사무차장, 본부장 결재일로 변경 2019.05.23 LSR
                  FROM TBBADDED103M C1
                      ,TBDCMACM023L C2
                 WHERE 1=1
                   AND C1.APV_RQS_ID  = C2.APV_DOC_NO
                   AND C1.RPRT_CD     = 'A10500200' --종료보고서
                   AND C1.AUD_YR = #{audYr}
                   AND C1.AUD_NO = #{audNo}
                 GROUP BY C1.AUD_YR, C1.AUD_NO )
	       WHERE STDT IS NOT NULL
	       ORDER BY TO_NUMBER(DATATYP)
	   ]]>
    </select>
    
    
    <update id="updateNtnlAsmbCnfmYn" parameterType="paramMap">
        /* kr.go.bai.eip.aep.fer.dao.AEPFER014EMapper.updateNtnlAsmbCnfmYn */
		UPDATE TBBADDED001M 
		   SET NTNL_ASMB_CNFM_YN = #{ntnlAsmbCnfmYn}
		 WHERE AUD_YR = #{audYr}
           AND AUD_NO = #{audNo}
    </update>
</mapper> 
