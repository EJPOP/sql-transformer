<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.mac.dao.AEPMAC013PMapper">
    
    <select id="selectMainList1" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC013PMapper.selectMainList1*/
			SELECT   CD,
                       CD_NM,                                                                                          /*서류명*/
                       DOC_ID,
                       TMP_ID,
                       RPRT_NM,                                                                                       /*문서명*/
                       RPRT_NM AS RPRT_NM1,                                                                                       /*문서명*/
                       NVL(APV_STA_NM,' ') AS APV_STA_NM, 
                       APV_STA_CD,                                                                                   /*결재상태*/
                       APV_RQS_ID,                                                                                    /*결재아이디*/     
                       AUD_YR,
                       AUD_NO
            FROM  ( SELECT  A.CD,
				                  A.CD_NM,
				                  B.DOC_ID,
				                  (SELECT C.HWP_DOC_ID 
				                   FROM TBFDMADM002M C
				                   WHERE C.AUD_DOC_CD = A.CD) AS TMP_ID, 
				                   B.RPRT_NM,
				                   F_CODE_NM('1000773',B.APV_STA_CD) AS APV_STA_NM, 
		                           B.APV_STA_CD,
		                           B.APV_RQS_ID,
		                           B.AUD_YR,
		                           B.AUD_NO
		               FROM   ( SELECT #{audYr} AS AUD_YR
		                                   ,#{audNo}  AS AUD_NO
		                                  , CD
		                                  , CD_NM
		                           FROM TBDCMACM013C
		                           WHERE CMM_CD_DVSN_CD = '1000786' 
		                           AND USR_DFN_TXT_4 = 'A106090' 
		                           AND USR_DFN_TXT_5 = '1') A                                                    /* USR_DFN_TXT_5 = '1' : 3.질문서 및 감사결과처리의견서 발급상황표   4.확인서 작성관리부   5.문답서작성관리부 */
		    LEFT JOIN TBBADDED103M B 
		    ON B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.RPRT_CD = A.CD
		    WHERE 1=1 
		    
		    AND A.AUD_YR =  #{audYr}
		    AND A.AUD_NO =  #{audNo}
		)
		ORDER BY CD     
    </select>
    
    <select id="selectMainList2" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC013PMapper.selectMainList2*/
        SELECT  A.CD, 
	              A.CD_NM, 
	              B.EVI_DCMB_SNO, 
	              B.AUD_DCM_DOC_ID, 
	              B.FILE_NM,
	              B.FILE_NM AS FILE_NM1
        FROM ( SELECT  #{audYr} AS AUD_YR
                          ,  #{audNo} AS AUD_NO
                          ,  CD
                          , CD_NM
                   FROM TBDCMACM013C
                   WHERE CMM_CD_DVSN_CD = '1000786' 
                   AND USR_DFN_TXT_4 = 'A106090' 
                   AND USR_DFN_TXT_5 = '2') A
         LEFT JOIN TBBADDED108D B ON B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.ANNEX_DVSN_CD = A.CD
         WHERE 1=1
		 AND A.AUD_YR = #{audYr} 
		 AND A.AUD_NO =  #{audNo}
		 ORDER BY CD
    </select>
    
    <select id="selectMainList3" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC013PMapper.selectMainList3*/
    SELECT CD
         , CD_NM
         , EVI_DCMB_SNO
         , AUD_DCM_DOC_ID
         , FILE_NM
	     , DOC_ID
	     , TMP_ID
	     , RPRT_NM
	     , APV_STA_NM
	     , APV_STA_CD
	     , APV_RQS_ID
	     , AUD_YR
	     , AUD_NO	 
	  FROM (
        SELECT  A.CD, 
	              A.CD_NM, 
	              B.EVI_DCMB_SNO, 
	              B.AUD_DCM_DOC_ID, 
	              B.FILE_NM,
	              NULL AS DOC_ID,
	              NULL AS TMP_ID,
	              NULL AS RPRT_NM,
	              NULL AS APV_STA_NM,
	              NULL AS APV_STA_CD,
	              NULL AS APV_RQS_ID,
	              A.AUD_YR,
	              A.AUD_NO	              
        FROM ( SELECT  #{audYr} AS AUD_YR
                          ,  #{audNo} AS AUD_NO
                          ,  CD
                          , CD_NM
                   FROM TBDCMACM013C
                   WHERE CMM_CD_DVSN_CD = '1000786' 
                   AND USR_DFN_TXT_4 = 'A106090' 
                   AND USR_DFN_TXT_5 = '2') A
         LEFT JOIN TBBADDED108D B ON B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.ANNEX_DVSN_CD = A.CD
         WHERE 1=1
		 AND A.AUD_YR = #{audYr} 
		 AND A.AUD_NO =  #{audNo}
        UNION ALL
        SELECT  A.CD,
				   A.CD_NM,
				   NULL AS EVI_DCMB_SNO,
				   NULL AS AUD_DCM_DOC_ID,
				   NULL AS FILE_NM,
				   B.DOC_ID,
				   (SELECT C.HWP_DOC_ID 
				      FROM TBFDMADM002M C
				     WHERE C.AUD_DOC_CD = A.CD) AS TMP_ID, 
				   B.RPRT_NM,
				   NVL(F_CODE_NM('1000773',B.APV_STA_CD), ' ') AS APV_STA_NM, 
		           B.APV_STA_CD,
		           B.APV_RQS_ID,
		           B.AUD_YR,
		           B.AUD_NO
		     FROM   ( SELECT #{audYr}  AS AUD_YR
		                    , #{audNo}  AS AUD_NO
		                    , CD
		                    , CD_NM
		                FROM TBDCMACM013C
		               WHERE CMM_CD_DVSN_CD = '1000786' 
		                 AND USR_DFN_TXT_4 = 'A106090' 
		                 AND USR_DFN_TXT_5 = '1') A                         /* USR_DFN_TXT_5 = '1' : 3.질문서 및 감사결과처리의견서 발급상황표   4.확인서 작성관리부   5.문답서작성관리부 */
		LEFT JOIN TBBADDED103M B 
		       ON B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.RPRT_CD = A.CD
		    WHERE 1=1 
		    
		      AND A.AUD_YR =  #{audYr}
		      AND A.AUD_NO =  #{audNo} 
	    )
	    ORDER BY CD
    </select>
    
    
    <select id="selectOldMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC013PMapper.selectOldMainList*/
        SELECT 
		    NULL AS CD,
			'기타증거서류' AS CD_NM,
			A.EVI_DCMB_SNO,
		    A.AUD_DCM_DOC_ID,
		    A.FILE_NM,
	        NULL AS DOC_ID,
		    NULL AS TMP_ID, 
			NULL AS RPRT_NM,
			NULL AS APV_STA_NM, 
		    NULL AS APV_STA_CD,
		    NULL AS APV_RQS_ID,
		    A.AUD_YR,
		    A.AUD_NO
        FROM TBBADDED108D A
       WHERE A.EVI_DCMB_DVSN_CD = '30'  /*감사서류구분코드 10 : 증거서류,30 : 실지감사부속서류*/
         AND A.AUD_YR = #{audYr}
         AND A.AUD_NO = #{audNo}
         AND A.EVI_DCMB_SNO = '9999999999'
    ORDER BY A.FRT_REGI_DH DESC, A.EVI_DCM_NO DESC
    </select>
    
    
    <delete id="deleteDoc" parameterType="paramMap">
      /*kr.go.bai.eip.aep.mac.dao.AEPMAC013PMapper.deleteDoc*/
        DELETE 
        FROM TBBADDED103M 
        WHERE DOC_ID= #{docId} 
    </delete>
    
       <select id="selectCmptYn" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.mac.dao.AEPMAC013PMapper.selectCmptYn */
            SELECT CMPT_YN
              FROM TBBADDED102M
             WHERE AUD_YR = #{audYr} 
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = #{audStepCd}
               AND AUD_MAIN_STEP_ID = #{audMainStepId}
      </select>
    
       <delete id="deleteDoc2" parameterType="paramMap">
      /*kr.go.bai.eip.aep.mac.dao.AEPMAC013PMapper.deleteDoc2*/
        DELETE 
        FROM TBBADDED108D
        WHERE AUD_YR = #{audYr}
        AND AUD_NO = #{audNo}
        AND AUD_DCM_DOC_ID = #{docId}
    </delete>
    
    <insert id="TBBADDED108DInsert" parameterType="paramMap">
        /*kr.go.bai.eip.aep.mac.dao.AEPMAC013PMapper.TBBADDED108DInsert*/
        /*증거서류 Insert*/
        INSERT INTO TBBADDED108D
        (
            AUD_YR /*감사년도 */
            ,AUD_NO /*감사번호*/ 
            ,EVI_DCMB_SNO	/*감사서류함순번 */
            ,AUD_DCM_DOC_ID	/*감사서류문서ID */
            ,AUD_KND_CD	/*감사종류코드 */
            ,AUD_GRN_NO	/*감사부여코드 */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,ISUE_DY	/*발부일자 */
            ,EVI_DCMB_DVSN_CD	/*감사서류구분코드 */
            ,AFF_SNO	/*사건순번 */
            ,AUD_DCM_CRE_ID	/*감사서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
            ,EVI_DCM_NO
            ,DOC_STA_CD
            ,EVI_DCM_GRP_SNO
            ,PERS_INF_INC_CD
            ,ANNEX_DVSN_CD
        )
        values
        (
            #{audYr}        /*감사년도 */
            ,#{audNo}       /*감사번호 */
            ,#{eviDcmbSno}  /*감사서류함순번 */
            ,#{audDcmDocId}  /*감사서류문서ID */
            ,#{audKndCd} /*감사종류코드 */
            ,#{audGrnNo} /*감사부여코드 */
            ,#{eviDcmDvsnCd}	/*증거서류구분코드 */
            ,#{fileNm}	/*파일명 */
            ,REPLACE(#{isueDy},'-')  /*발부일자 */
            ,#{eviDcmbDvsnCd}   /*감사서류구분코드 */
            ,#{affSno}	/*사건순번 */
            ,#{frtUsrId} /*감사서류생성자ID(최초사용자id) */
            ,(SELECT NVL(MAX(SORT_SNO),0)+1 
                 FROM TBBADDED108D
                  WHERE AUD_YR = #{audYr}
                  AND AUD_NO = #{audNo}
              )
            ,#{frtUsrId}  /*최초사용자id */
            ,#{fnlUsrId} /*최종사용자id */
            ,#{fnlDealDptCd}    /*최종거래부서코드 */
            ,#{fnlMnuId} /*최종메뉴id */
            ,SYSDATE    /*최초등록일시 */
            ,SYSDATE /*최종수정일시 */
            ,#{fileSize}
            ,(SELECT LPAD(NVL(MAX(TO_NUMBER(NVL(EVI_DCM_NO,0))),0)+1,4,'0')
                 FROM TBBADDED108D
                  WHERE AUD_YR = #{audYr}
                  AND AUD_NO = #{audNo}
                  AND EVI_DCM_DVSN_CD = #{eviDcmDvsnCd}
              )
            ,'Y'
            ,#{eviDcmGrpSnoVal}
            ,#{persInfIncCd}
            ,#{annexDvsnCd} /*보고서코드*/
        )
    </insert>
       
</mapper>