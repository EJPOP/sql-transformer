<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.aep.frs.dao.AEPFRS002EMapper">
    
    <!-- 포렌식 요청 목록 조회 -->
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap" >
        <![CDATA[
        /* kr.go.bai.eip.aep.frs.dao.AEPRLA002EMapper.selectMainList */
        SELECT T1.AUD_YR           /* 감사년도 */
              ,T1.AUD_NO           /* 감사번호 */
              ,F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, '', '-') AS AUD_YR_NO /* 분류번호 */
              ,T2.AUD_KND_CD       /* 감사종류 */
              ,T1.FRS_REQ_SRNO     /* 포렌식 요청 일련번호 */
              ,T1.AUD_STEP_CD      /* 감사단계코드 */
              ,T1.FRS_REQ_DVSN_CD  /* 포렌식 요청 구분 코드 */
              ,F_CODE_NM('1000798',FRS_REQ_DVSN_CD) AS FRS_REQ_DVSN_NM  /* 포렌식 요청 구분명 */
              ,T1.REQ_DPT_CD       /* 요청부서코드 */
              ,(SELECT E.DPT_NM
			          FROM TBDCMACM002M E
			         WHERE E.DPT_CD = T1.REQ_DPT_CD) AS REQ_DPT_NM      /* 요청부서명 */
              ,T1.REQ_DH           /* 요청일시 */
              ,TO_CHAR(T1.REQ_DH,'yyyy-MM-dd') AS REQ_DT /* 요청일자 */
              ,T1.REQ_CNB          /* 요청자전산번호 */
              ,(SELECT E.USR_NAM
			          FROM TBDCMACM001M E
			         WHERE E.CNB = T1.REQ_CNB) AS USR_NAM /* 요청자명 */
              ,T1.REQ_STAT_CD      /* 요청상태코드 */
              ,F_CODE_NM('1000994',T1.REQ_STAT_CD) AS REQ_STAT_NM /* 요청상태명 */
              ,(SELECT RPRT_NM
                  FROM TBBADDED103M A
				 WHERE A.AUD_YR = T1.AUD_YR
				   AND A.AUD_NO = T1.AUD_NO
				   AND A.RPRT_CD = 'A10610100'
				   AND A.REF_ID = T1.FRS_REQ_SRNO ) AS RPRT_NM /* 포렌식 요청 계획서명 */
              ,(SELECT F_CODE_NM('1000773',A.APV_STA_CD) 
                  FROM TBBADDED103M A
				 WHERE A.AUD_YR = T1.AUD_YR
				   AND A.AUD_NO = T1.AUD_NO
				   AND A.RPRT_CD = 'A10610100'
				   AND A.REF_ID = T1.FRS_REQ_SRNO ) AS REQ_DOC_APV_STA_NM /* 요청서 작성,결재상태 */
              ,(SELECT RCPT_DH
                  FROM TBBADDED111M A
				 WHERE A.AUD_YR = T1.AUD_YR
				   AND A.AUD_NO = T1.AUD_NO
				   AND A.RPRT_CD = 'A10610100'
				   AND A.REF_ID = T1.FRS_REQ_SRNO ) AS RCPT_DH /* 포렌식 요청 수신일시 */
              ,T1.ORG_CD	       /* 대상기관코드 */
              ,F_ORG_INFO(T1.ORG_CD, '1') AS ORG_NM /* 대상기관명 */
              ,T1.FRS_DPT_RCP_YN   /* 포렌식 법무부서 접수여부 */
              ,DECODE(T1.FRS_DPT_RCP_YN,'N','미접수','Y',(DECODE(T1.REV_OPT_OM_YN,'Y','완료','N','접수'))) AS RCP_NM
              ,T1.FRS_DPT_RCP_DH   /* 포렌식 법무부서 접수일시 */
              ,T1.REV_OPT_RCV_YN   /* 검토의견서 수신여부 */
              ,T1.REV_OPT_RCV_DH   /* 검토의견서 수신일시 */
              ,T1.REV_OPT_OM_YN    /* 검토의견서 발신여부 */
              ,T1.REV_OPT_OM_DH    /* 검토의견서 발신일시 */
              ,(SELECT F_CODE_NM('1000773',A.APV_STA_CD) 
                  FROM TBBADDED103M A
				 WHERE A.AUD_YR = T1.AUD_YR
				   AND A.AUD_NO = T1.AUD_NO
				   AND A.RPRT_CD = 'A10610200'
				   AND A.REF_ID = T1.FRS_REQ_SRNO ) AS REV_DOC_APV_STA_NM /* 의견서 작성,결재상태 */ 
              ,T1.HNDL_DH          /* 처리일시 */
              ,T1.HNDL_PEN_CNB     /* 처리자전산번호 */
              ,T1.HNDL_DPT_CD      /* 처리부서코드 */
              ,T1.HNDL_RPT_RCV_YN  /* 처리보고서 수신여부 */
              ,T1.HNDL_RPT_RCV_DH  /* 처리보고서 수신일시 */
              ,T1.HNDL_RPT_OM_YN   /* 처리보고서 발신여부 */
              ,(SELECT F_CODE_NM('1000773',A.APV_STA_CD) 
                  FROM TBBADDED103M A
				 WHERE A.AUD_YR = T1.AUD_YR
				   AND A.AUD_NO = T1.AUD_NO
				   AND A.RPRT_CD = 'A10610300'
				   AND A.REF_ID = T1.FRS_REQ_SRNO ) AS HNDL_DOC_APV_STA_NM /* 처리서 작성,결재상태 */ 
         FROM
        ]]>
               TBAEPFRS101M T1, TBBADDED001M T2 
        WHERE  
               T1.AUD_YR = T2.AUD_YR
          AND  T1.AUD_NO = T2.AUD_NO
          AND  (SELECT COUNT(*) FROM TBDCMACM023L 
                 WHERE APV_DOC_NO = (SELECT APV_RQS_ID
                                       FROM TBBADDED103M A
				                      WHERE A.AUD_YR = T1.AUD_YR
				                        AND A.AUD_NO = T1.AUD_NO
				                        AND A.RPRT_CD = 'A10610100'
				                        AND A.REF_ID = T1.FRS_REQ_SRNO) AND APVR_DPT_CD = '160100' AND APVR_STA_CD IS NOT NULL ) > 0
        <if test="schAudYr != null and schAudYr != ''">
          AND  T1.AUD_YR = #{schAudYr}
        </if>
        <if test="schAudYrNoKndCd != null and schAudYrNoKndCd != ''">
          AND  T2.AUD_KND_CD = #{schAudYrNoKndCd}
        </if>
        <if test="schAudGrnNo != null and schAudGrnNo != ''">
          AND  T2.AUD_GRN_NO = #{schAudGrnNo}
        </if>
        <if test="schAudSbjNm != null and schAudSbjNm != ''">
          AND  T2.AUD_SBJ_NM LIKE '%'||#{schAudSbjNm}||'%'
        </if>
        
        ORDER BY T1.REQ_DH DESC
        
    </select>
    
    <!-- 수신문서 목록 조회 -->
    <select id="selectRprtRcptList" parameterType="paramMap" resultType="egovMap">
    	/* kr.go.bai.eip.aep.frs.dao.AEPRLA002EMapper.selectRprtRcptList */
        <![CDATA[
        SELECT RPRT_NM
             , DOC_ID
             , F_DPT_INFO(SND_DPT_CD, 1) AS SND_DPT_NM
             , TO_CHAR(SND_DH, 'YYYY-MM-DD') AS SND_DT
             , '법률담당관' AS RCPT_DPT_NM
             , TO_CHAR(RCPT_DH, 'YYYY-MM-DD') AS RCPT_DT
             , SR_DOC_SNO
             , SUPPLM_REQ
             , DOC_STA_CD
             , F_OPEN_EDIT(LINK_URL) AS DOC_TYPE
             , AUD_YR
             , AUD_NO
             , F_MNG_KND_AUDYRNO(AUD_YR, AUD_NO, '', '-') AS AUD_YR_NO /* 분류번호 */
             , AUD_STEP_CD
          FROM TBBADDED111M
         WHERE 1=1
           AND AUD_YR      = #{audYr}
           AND AUD_NO      = #{audNo}
           AND RPRT_CD     = 'A10610100'
           AND REF_ID      = #{frsReqSrno}
        ]]>
    </select>    
    
    <!-- 포렌식 요청 목록 접수 -->
    <update id="updateAcp" parameterType="paramMap">
    /* kr.go.bai.eip.aep.frs.dao.AEPRLA002EMapper.updateAcp */
        <![CDATA[
        UPDATE TBAEPFRS101M
           SET REQ_STAT_CD      = '30'
             , FRS_DPT_RCP_YN = 'Y'
             , FRS_DPT_RCP_DH = SYSDATE
             , FNL_USR_ID       = #{usrId}
             , FNL_DEAL_DPT_CD  = #{dptCd}
             , FNL_MNU_ID       = #{mnuId}
             , FNL_MDF_DH       = SYSDATE
         WHERE 1=1
           AND AUD_YR         = #{audYr}
           AND AUD_NO         = #{audNo}
           AND FRS_REQ_SRNO   = #{frsReqSrno}
        ]]>
    </update>
    
    <update id="updateRcptDoc" parameterType="paramMap">
    /* kr.go.bai.eip.aep.frs.dao.AEPFRS002EMapper.updateRcptDoc */
        <![CDATA[
        UPDATE TBBADDED111M
           SET DOC_STA_CD      = '20'
             , RCNT_ID         = #{usrId}
             , RCPT_DH         = SYSDATE
             , FNL_USR_ID      = #{usrId}
             , FNL_DEAL_DPT_CD = #{dptCd}
             , FNL_MNU_ID      = #{mnuId}
             , FNL_MDF_DH      = SYSDATE
         WHERE 1=1
           AND AUD_YR      = #{audYr}
           AND AUD_NO      = #{audNo}
           AND REF_ID      = #{frsReqSrno}
           AND RPRT_CD     = 'A10610100'
        ]]>
    </update>
    
    <!-- 의견문서 목록 조회 -->
    <select id="selectDocList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.frs.dao.AEPFRS002EMapper.selectDocList */
        <![CDATA[
        SELECT G1.RPRT_NM
             , G1.RPRT_NM AS V_RPRT_NM
             , G1.APV_STA_CD
             , G1.APV_STA_NM
             , G1.DOC_ID
             , G1.APV_RQS_ID
             , MAX(G1.APV_INFO_1) AS APV_INFO_1
             , MAX(G1.APV_INFO_2) AS APV_INFO_2
             , MAX(G1.APV_INFO_3) AS APV_INFO_3
             , MAX(G1.APV_INFO_4) AS APV_INFO_4
             , MAX(G1.APV_INFO_5) AS APV_INFO_5
             , MAX(G1.APV_INFO_6) AS APV_INFO_6
             , MAX(G1.APV_INFO_7) AS APV_INFO_7
             , (SELECT DECODE(COUNT(1), 0, 'N', 'Y')
                  FROM TBBADDED111M T3
                 WHERE 1=1
                   AND T3.AUD_YR  = G1.AUD_YR
                   AND T3.AUD_NO  = G1.AUD_NO
                   AND T3.RPRT_CD = G1.RPRT_CD
                   AND T3.DOC_ID  = G1.DOC_ID)
                                    AS SEND_YN
             , G1.RPRT_CD
             , G1.DOC_TYPE
          FROM (SELECT AUD_YR
	                 , AUD_NO
	                 , RPRT_CD
	                 , RPRT_NM
	                 , APV_STA_CD
	                 , APV_STA_NM
	                 , DOC_ID
	                 , APV_RQS_ID
	                 , DOC_TYPE
	                 , DECODE(ROW_ID, 1, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_1
	                 , DECODE(ROW_ID, 2, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_2
	                 , DECODE(ROW_ID, 3, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_3
	                 , DECODE(ROW_ID, 4, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_4
	                 , DECODE(ROW_ID, 5, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_5
	                 , DECODE(ROW_ID, 6, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_6
	                 , DECODE(ROW_ID, 7, DECODE(APVR_NM, NULL, '', APV_DH || '/' || PST_NM || '/' || APVR_NM), '') AS APV_INFO_7
                  FROM (SELECT AUD_YR
		                     , AUD_NO
		                     , RPRT_CD
		                     , RPRT_NM
		                     , APV_STA_CD
		                     , APV_STA_NM
		                     , DOC_ID
		                     , APV_RQS_ID
		                     , PST_NM
		                     , APVR_NM
		                     , APV_DH
		                     , DOC_TYPE
		                     , ROW_NUMBER() OVER(PARTITION BY DOC_ID ORDER BY APV_SNO) AS ROW_ID 
                          FROM (SELECT T1.AUD_YR
			                         , T1.AUD_NO
			                         , T1.RPRT_CD
			                         , T1.RPRT_NM
			                         , T1.APV_STA_CD
			                         , F_CODE_NM('1000773', T1.APV_STA_CD) AS APV_STA_NM
			                         , T1.DOC_ID
			                         , T2.APV_SNO
			                         , T1.APV_RQS_ID
			                         , CASE WHEN APVR_PST_CD IS NULL
			                                THEN (SELECT MAX(ONR_PST_NM)
			                                        FROM TBDCMACM001M
			                                       WHERE 1=1
			                                         AND CNB = APVR_CNB)
			                                ELSE F_CODE_NM('1000176', T2.APVR_PST_CD)
			                            END                                AS PST_NM
			                         , F_USR_INFO(T2.APVR_CNB, '2')        AS APVR_NM
			                         , CASE WHEN SUBSTR(T2.APVR_STA_CD, 0, 1) = '2'
			                                THEN TO_CHAR(T2.APV_DH, 'YYYY-MM-DD')
			                                ELSE ''
			                            END                                AS APV_DH
			                         , F_OPEN_EDIT(T1.LINK_URL)            AS DOC_TYPE
                                  FROM TBBADDED103M T1
                       LEFT OUTER JOIN TBDCMACM023L T2 ON (T1.APV_RQS_ID   = T2.APV_DOC_NO
                                                       AND T2.APV_SNO     <> '1'
                                                       AND T2.APVR_KND_CD <> '4')
                                 WHERE 1=1
                                   AND T1.AUD_YR   = #{audYr}
			                       AND T1.AUD_NO   = #{audNo}
			                       AND T1.RPRT_CD IN ('A10610200','A10610210')
			                       AND T1.REF_ID   = #{frsReqSrno}
			                   )
                       )
                 WHERE 1=1
               ) AS G1
         WHERE 1=1
         GROUP BY G1.AUD_YR
                , G1.AUD_NO
                , G1.RPRT_CD
                , G1.RPRT_NM
                , G1.APV_STA_CD
                , G1.APV_STA_NM
                , G1.DOC_ID
                , G1.APV_RQS_ID 
                , G1.DOC_TYPE
        ]]>
    </select>        
    
    <update id="updateReqRcptDt">
    /* kr.go.bai.eip.aep.frs.dao.AEPFRS002EMapper.updateReqRcptDt */
            UPDATE TBBADDED111M SET
                    RCPT_DH = SYSDATE
                   ,RCNT_ID = #{usrId}
                   ,FNL_USR_ID = #{usrId}
                   ,FNL_DEAL_DPT_CD = #{dptCd}
                   ,FNL_MNU_ID = #{mnuId}
                   ,FNL_MDF_DH = SYSDATE
             WHERE
                    AUD_YR = #{audYr}
               AND  AUD_NO = #{audNo}
               AND  RPRT_CD = 'A10610100'
               AND  REF_ID = #{frsReqSrno}

    </update>	    
   
</mapper>