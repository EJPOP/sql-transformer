<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper">

    <select id="selectApvDocNo" parameterType="paramMap" resultType="java.lang.String">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.selectApvDocNo */
        <![CDATA[
            SELECT TO_CHAR(SYSDATE,'yyyymmddhh24miss')||LPAD(NVL(MAX(SUBSTR(APV_DOC_NO,15,20)), 0) + 1, 6, 0) AS APV_DOC_NO
              FROM TBDCMACM022L
        ]]>
    </select>
    
    <insert id="insertApvMaster" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.insertApvMaster */
        <![CDATA[
            INSERT INTO TBDCMACM022L (
                APV_DOC_NO
                , APV_DVSN_CD
                , APV_STA_CD
                , APV_TIT_NM
                , SBM_CNB
                , SBM_DH
                , FNL_APV_DH
                , FNL_MNU_ID
                , FRT_USR_ID
                , FNL_USR_ID
                , FNL_DEAL_DPT_CD
                , FRT_REGI_DH
                , FNL_MDF_DH
                , FNL_APV_CNB
                , APV_DOC_SEQ )
            VALUES (
                #{apvDocNo}
                , 'fieldAudit'
                , #{apvStaCd}
                , '보안감사' -- 결재제목명 추 후 수정
                , #{sbmCnb}
                , SYSDATE
                , SYSDATE
                , #{mnuId}
                , #{usrId}
                , #{usrId}
                , #{dptCd}
                , SYSDATE
                , SYSDATE
                , #{fnlApvCnb}
                , (SELECT TO_CHAR(SYSDATE,'yyyy') || '-' || #{dptNm} || '-' || (COUNT(*)+1) AS APV_DOC_SEQ
                     FROM TBDCMACM022L
                    WHERE SUBSTR(APV_DOC_SEQ, 0, INSTR(APV_DOC_SEQ,'-',1,2)-1) = TO_CHAR(SYSDATE,'yyyy') || '-' || #{dptNm}) )
        ]]>
    </insert>
    
    <insert id="insertApvDetail" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.insertApvDetail */
        <![CDATA[
            INSERT INTO TBDCMACM023L (
                APV_DOC_NO
                , APV_DVSN_CD
                , APVR_CNB
                , APVR_DPT_CD
                , APVR_RANK_CD
                , APVR_PST_CD
                , APVR_KND_CD
                , APV_SNO
                , APVR_STA_CD
                , APV_DH
                , FRT_USR_ID
                , FNL_USR_ID
                , FNL_DEAL_DPT_CD
                , FNL_MNU_ID
                , FRT_REGI_DH
                , FNL_MDF_DH
                , APVR_SEQ )
            VALUES (
                #{apvDocNo}
                , 'fieldAudit'
                , #{apvrCnb}
                , #{apvrDptCd}
                , #{apvrRankCd}
                , #{apvrPstCd}
                , #{apvrKndCd}
                , #{apvSno}
                , #{apvrStaCd}
                , TO_DATE(#{apvDh})
                , #{usrId}
                , #{usrId}
                , #{dptCd}
                , #{mnuId}
                , SYSDATE
                , SYSDATE
                , #{apvrSeq} )
        ]]>
    </insert>
    
    <insert id="insertApvHistory" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.insertApvHistory */
        <![CDATA[
            INSERT INTO TBDCMACM023H (
                SEQ
                , APV_DOC_NO
                , APV_DVSN_CD
                , APVR_CNB
                , APVR_DPT_CD
                , APVR_RANK_CD
                , APVR_PST_CD
                , APVR_KND_CD
                , APV_SNO
                , APVR_STA_CD
                , APV_DH
                , FRT_USR_ID
                , FNL_USR_ID
                , FNL_DEAL_DPT_CD
                , FNL_MNU_ID
                , FRT_REGI_DH
                , FNL_MDF_DH
                , APVR_SEQ )
            VALUES (
                (SELECT NVL(MAX(SEQ), 0) + 1 FROM TBDCMACM023H)
                , #{apvDocNo}
                , 'fieldAudit'
                , #{apvrCnb}
                , #{apvrDptCd}
                , #{apvrRankCd}
                , #{apvrPstCd}
                , #{apvrKndCd}
                , #{apvSno}
                , #{apvrStaCd}
                , TO_DATE(#{apvDh})
                , #{usrId}
                , #{usrId}
                , #{dptCd}
                , #{mnuId}
                , SYSDATE
                , SYSDATE
                , #{apvrSeq} )
        ]]>
    </insert>
    
    <update id="updateHndlPrdMngDt" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.updateHndlPrdMngDt */
            UPDATE TBBADDED003M
               SET FNL_USR_ID = #{usrId}
                 , FNL_DEAL_DPT_CD = #{dptCd} 
                 , FNL_MNU_ID = #{mnuId} 
                 , FNL_MDF_DH = SYSDATE
            <if test="rtnRptDt != null and rtnRptDt != '' and rprtCd eq 'A10500200'.toString() ">
                 , RTN_RPT_DT = #{rtnRptDt}
            </if>
            <if test="audBrdvApvDt != null and audBrdvApvDt != '' and rprtCd eq 'A10600200'.toString() and audRprtDvsnCd eq '10'.toString() ">
                 , AUD_BRDV_APV_DT = #{audBrdvApvDt}
            </if>
            <if test="jaJdgSsecApvDt != null and jaJdgSsecApvDt != '' and rprtCd eq 'A10600200'.toString() and audRprtDvsnCd eq '10'.toString() ">
                 , JA_JDG_SSEC_APV_DT = #{jaJdgSsecApvDt}
            </if>
            <if test="owDhdApvDt != null and owDhdApvDt != '' and rprtCd eq 'A10600200'.toString() and audRprtDvsnCd eq '10'.toString() ">
                 , OW_DHD_APV_DT = #{owDhdApvDt}
            </if>
            <if test="owPsdApvDt != null and owPsdApvDt != '' and rprtCd eq 'A10600200'.toString() and audRprtDvsnCd eq '10'.toString() ">
                 , OW_PSD_APV_DT = #{owPsdApvDt}
            </if>
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
    </update>
    
    
    <insert id="insertAffInfo" parameterType="paramMap">
    DECLARE
    	BEGIN
            INSERT INTO TBBADDED145H (
				   HST_DVSN_CD
				 , HST_SNO
				 , HST_DH
				 , HST_USR_ID	                
                , AUD_YR
                , AUD_NO
                , AUD_STEP_CD
                , DOC_ID
                , APVR_CD
                , AFF_SNO
                , AUD_KND_CD
                , AUD_GRN_NO
                , RPRT_FILD_ID
                , AFF_CD
                , LIST_NO
                , REFER_DVSN_CD
                , AFF_SPH
                , TITLE_NM
                , DP_TITLE_NM
                , QST_DOC_ISUE_YN
                , QST_DOC_ISUE_DY
                , AUDTOR
                , DETL_DOC_NO
                , MTRL_IPT_DVSN_CD
                , SYT_TRTM_DVSN_YN
                , SCRT_YN
                , SORT_SNO
                , TRTM_EXAMER_CNB
                , FNL_YN
                , FRT_USR_ID
                , FNL_USR_ID
                , FNL_DEAL_DPT_CD
                , FNL_MNU_ID
                , FRT_REGI_DH
                , FNL_MDF_DH
                , REF_DOC_ID )
		   SELECT 'C'
				 	 , TBBADDED145H_SEQ.NEXTVAL
				 	 , SYSDATE
				 	 , #{usrId}
					 , AUD_YR			
					 , AUD_NO			
					 , AUD_STEP_CD	
					 , DOC_ID			
					 , APVR_CD		
					 , AFF_SNO		
					 , AUD_KND_CD		
					 , AUD_GRN_NO		
					 , RPRT_FILD_ID	
					 , AFF_CD			
					 , LIST_NO		
					 , REFER_DVSN_CD	
					 , AFF_SPH		
					 , TITLE_NM		
					 , TITLE_NM	
					 , QST_DOC_ISUE_YN
					 , QST_DOC_ISUE_DY
					 , AUDTOR			
					 , DETL_DOC_NO	
					 , MTRL_IPT_DVSN_CD
					 , SYT_TRTM_DVSN_YN
					 , SCRT_YN		
					 , SORT_SNO		
					 , TRTM_EXAMER_CNB
					 , FNL_YN			
	                  , #{usrId}
	                  , #{usrId}
	                  , #{dptCd}
	                  , #{mnuId}
	                  , SYSDATE
	                  , SYSDATE
					 , REF_DOC_ID
			FROM(                 
	          SELECT T1.AUD_YR
	                  , T1.AUD_NO
	                  , DECODE(T2.LV, 4, 'A1070', 'A1060') AS AUD_STEP_CD
	                  , T1.DOC_ID
	                  , DECODE(T2.LV, 1, #{jaJdgSsecPstCd},
	                                  		2, #{owDhdPstCd},
	                                  		3, '0055700',
	                                  		4, '0010600') AS APVR_CD
	                  , T1.AFF_SNO
	                  , T1.AUD_KND_CD
	                  , T1.AUD_GRN_NO
	                  , T1.RPRT_FILD_ID
	                  , T1.AFF_CD
	                  , T1.LIST_NO
	                  , T1.REFER_DVSN_CD
	                  , T1.AFF_SPH
	                  , T1.TITLE_NM
	                  , T1.QST_DOC_ISUE_YN
	                  , T1.QST_DOC_ISUE_DY
	                  , T1.AUDTOR
	                  , T1.DETL_DOC_NO
	                  , T1.MTRL_IPT_DVSN_CD
	                  , T1.SYT_TRTM_DVSN_YN
	                  , T1.SCRT_YN
	                  , T1.SORT_SNO
	                  , T1.TRTM_EXAMER_CNB
	            <if test="owPsdApvDt != null and owPsdApvDt != ''">
	                  , DECODE(T2.LV, 3, 'Y', 'N') AS  FNL_YN	
	            </if>
	            <if test="owPsdApvDt == null or owPsdApvDt == ''">
	                  , DECODE(T2.LV, 2, 'Y', 'N') AS  FNL_YN	
	            </if>
	        <![CDATA[
	                  , T1.REF_DOC_ID
	             FROM TBBADDED145M T1
	              LEFT OUTER JOIN (SELECT LEVEL AS LV
	                                	 FROM DUAL
	                               	CONNECT BY LEVEL < 5) T2 ON 1=1
	            WHERE T1.AUD_YR = #{audYr}
	              AND T1.AUD_NO = #{audNo}
	              AND T1.DOC_ID = #{docId}
	              AND T1.APVR_CD = '0013600' )
	        ]]>
	        ;
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.insertAffInfo */
        <![CDATA[
            INSERT INTO TBBADDED145M (
                AUD_YR
                , AUD_NO
                , AUD_STEP_CD
                , DOC_ID
                , APVR_CD
                , AFF_SNO
                , AUD_KND_CD
                , AUD_GRN_NO
                , RPRT_FILD_ID
                , AFF_CD
                , LIST_NO
                , REFER_DVSN_CD
                , AFF_SPH
                , TITLE_NM
                , DP_TITLE_NM
                , QST_DOC_ISUE_YN
                , QST_DOC_ISUE_DY
                , AUDTOR
                , DETL_DOC_NO
                , MTRL_IPT_DVSN_CD
                , SYT_TRTM_DVSN_YN
                , SCRT_YN
                , SORT_SNO
                , TRTM_EXAMER_CNB
                , FNL_YN
                , FRT_USR_ID
                , FNL_USR_ID
                , FNL_DEAL_DPT_CD
                , FNL_MNU_ID
                , FRT_REGI_DH
                , FNL_MDF_DH
                , REF_DOC_ID )
          (
           SELECT T1.AUD_YR
                  , T1.AUD_NO
                  , DECODE(T2.LV, 4, 'A1070', 'A1060')
                  , T1.DOC_ID
                  , DECODE(T2.LV, 1, #{jaJdgSsecPstCd},
                                      2, #{owDhdPstCd},
                                      3, '0055700',
                                      4, '0010600')
                  , T1.AFF_SNO
                  , T1.AUD_KND_CD
                  , T1.AUD_GRN_NO
                  , T1.RPRT_FILD_ID
                  , T1.AFF_CD
                  , T1.LIST_NO
                  , T1.REFER_DVSN_CD
                  , T1.AFF_SPH
                  , T1.TITLE_NM
                  , T1.TITLE_NM
                  , T1.QST_DOC_ISUE_YN
                  , T1.QST_DOC_ISUE_DY
                  , T1.AUDTOR
                  , T1.DETL_DOC_NO
                  , T1.MTRL_IPT_DVSN_CD
                  , T1.SYT_TRTM_DVSN_YN
                  , T1.SCRT_YN
                  , T1.SORT_SNO
                  , T1.TRTM_EXAMER_CNB ]]>
            <if test="owPsdApvDt != null and owPsdApvDt != ''">
                  , DECODE(T2.LV, 3, 'Y', 'N')
            </if>
            <if test="owPsdApvDt == null or owPsdApvDt == ''">
                  , DECODE(T2.LV, 2, 'Y', 'N')
            </if>
        <![CDATA[
                  , #{usrId}
                  , #{usrId}
                  , #{dptCd}
                  , #{mnuId}
                  , SYSDATE
                  , SYSDATE
                  , T1.REF_DOC_ID
             FROM TBBADDED145M T1
              LEFT OUTER JOIN (SELECT LEVEL AS LV
                                 FROM DUAL
                               CONNECT BY LEVEL < 5) T2 ON 1=1
            WHERE T1.AUD_YR = #{audYr}
              AND T1.AUD_NO = #{audNo}
              AND T1.DOC_ID = #{docId}
              AND T1.APVR_CD = '0013600' )
        ]]>
        	;
        END;
    </insert>
    
  
    <insert id="insertDspInfo" parameterType="paramMap">
    DECLARE
    	BEGIN
    		INSERT INTO TBBADDED146H(
 				  HST_DVSN_CD
			  	, HST_SNO
			  	, HST_DH
			  	, HST_USR_ID
              	, AUD_YR
                , AUD_NO
                , AUD_STEP_CD
                , DOC_ID
                , APVR_CD
                , AFF_SNO
                , DSP_RQ_SNO
                , DP_DSP_RQ_SNO
                , AUD_KND_CD
                , AUD_GRN_NO
                , RPRT_FILD_ID
                , AFF_DSP_CD
                , RLTN_ORG_CD
                , HND_ORG_CD
                , REF_ORG_CD
                , DSP_RQ_CD
                , MTRL_IPT_DVSN_CD
                , NOP_AM_DVSN_CD
                , NOP_AM
                , SORT_SNO
                , ACCN_INSP_CD
                , FNL_YN
                , FRT_USR_ID
                , FNL_USR_ID
                , FNL_DEAL_DPT_CD
                , FNL_MNU_ID
                , FRT_REGI_DH
                , FNL_MDF_DH
                , NOP_SUM
                , HD_AUD_STEP_CD
                , HD_DOC_ID
                , HD_APVR_CD
                , HD_AFF_SNO
                , HD_DSP_RQ_SNO
                , REF_DOC_ID
                , DF_AUD_STEP_CD
                , DF_DOC_ID
                , DF_APVR_CD
                , DF_AFF_SNO
                , DF_DSP_RQ_SNO
			    , KYWD1
				, KYWD2
				, KYWD3
				, KYWD4
				, KYWD5 )
           SELECT  'C'
					  , TBBADDED146H_SEQ.NEXTVAL
					  , SYSDATE
				  	, #{usrId}
	              	, AUD_YR
	                , AUD_NO
	                , AUD_STEP_CD
	                , DOC_ID
	                , APVR_CD
	                , AFF_SNO
	                , DSP_RQ_SNO
	                , DSP_RQ_SNO
	                , AUD_KND_CD
	                , AUD_GRN_NO
	                , RPRT_FILD_ID
	                , AFF_DSP_CD
	                , RLTN_ORG_CD
	                , HND_ORG_CD
	                , REF_ORG_CD
	                , DSP_RQ_CD
	                , MTRL_IPT_DVSN_CD
	                , NOP_AM_DVSN_CD
	                , NOP_AM
	                , SORT_SNO
	                , ACCN_INSP_CD
	                , FNL_YN
                  , #{usrId}
                  , #{usrId}
                  , #{dptCd}
                  , #{mnuId}
                  , SYSDATE
                  , SYSDATE
	                , NOP_SUM
	                , HD_AUD_STEP_CD
	                , HD_DOC_ID
	                , HD_APVR_CD
	                , HD_AFF_SNO
	                , HD_DSP_RQ_SNO
	                , REF_DOC_ID
	                , DF_AUD_STEP_CD
	                , DF_DOC_ID
	                , DF_APVR_CD
	                , DF_AFF_SNO
	                , DF_DSP_RQ_SNO
	                , KYWD1
				    , KYWD2
					, KYWD3
					, KYWD4
					, KYWD5
           	FROM(     
	           SELECT T1.AUD_YR
	                  , T1.AUD_NO
	                  , DECODE(T2.LV, 4, 'A1070', 'A1060') 	AS AUD_STEP_CD
	                  , T1.DOC_ID
	                  , DECODE(T2.LV, 1, #{jaJdgSsecPstCd},
	                                  2, #{owDhdPstCd},
	                                  3, '0055700',
	                                  4, '0010600')				AS APVR_CD
	                  , T1.AFF_SNO
	                  , T1.DSP_RQ_SNO
	                  , T1.AUD_KND_CD
	                  , T1.AUD_GRN_NO
	                  , T1.RPRT_FILD_ID
	                  , T1.AFF_DSP_CD
	                  , T1.RLTN_ORG_CD
	                  , T1.HND_ORG_CD
	                  , T1.REF_ORG_CD
	                  , T1.DSP_RQ_CD
	                  , T1.MTRL_IPT_DVSN_CD
	                  , T1.NOP_AM_DVSN_CD
	                  , T1.NOP_AM
	                  , T1.SORT_SNO
	                  , T1.ACCN_INSP_CD
	            <if test="owPsdApvDt != null and owPsdApvDt != ''">
	                  , DECODE(T2.LV, 3, 'Y', 'N') AS FNL_YN
	            </if>
	            <if test="owPsdApvDt == null or owPsdApvDt == ''">
	                  , DECODE(T2.LV, 2, 'Y', 'N') AS FNL_YN
	            </if>
	        <![CDATA[
	                  , T1.NOP_SUM
	                  , T1.HD_AUD_STEP_CD
	                  , T1.HD_DOC_ID
	                  , T1.HD_APVR_CD
	                  , T1.HD_AFF_SNO
	                  , T1.HD_DSP_RQ_SNO
	                  , T1.REF_DOC_ID
	                  , T1.DF_AUD_STEP_CD
	                  , T1.DF_DOC_ID
	                  , T1.DF_APVR_CD
	                  , T1.DF_AFF_SNO
	                  , T1.DF_DSP_RQ_SNO
	                  , T1.KYWD1
					  , T1.KYWD2
					  , T1.KYWD3
					  , T1.KYWD4
					  , T1.KYWD5
	             FROM TBBADDED146M T1
	              LEFT OUTER JOIN (SELECT LEVEL AS LV
	                                 FROM DUAL
	                               CONNECT BY LEVEL < 5) T2 ON 1=1
	            WHERE T1.AUD_YR = #{audYr}
	              AND T1.AUD_NO = #{audNo}
	              AND T1.DOC_ID = #{docId}
	              AND T1.APVR_CD = '0013600' ) 
	        ]]>                
				;
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.insertDspInfo */
        <![CDATA[
            INSERT INTO TBBADDED146M (
                AUD_YR
                , AUD_NO
                , AUD_STEP_CD
                , DOC_ID
                , APVR_CD
                , AFF_SNO
                , DSP_RQ_SNO
                , DP_DSP_RQ_SNO
                , AUD_KND_CD
                , AUD_GRN_NO
                , RPRT_FILD_ID
                , AFF_DSP_CD
                , RLTN_ORG_CD
                , HND_ORG_CD
                , REF_ORG_CD
                , DSP_RQ_CD
                , MTRL_IPT_DVSN_CD
                , NOP_AM_DVSN_CD
                , NOP_AM
                , SORT_SNO
                , ACCN_INSP_CD
                , FNL_YN
                , FRT_USR_ID
                , FNL_USR_ID
                , FNL_DEAL_DPT_CD
                , FNL_MNU_ID
                , FRT_REGI_DH
                , FNL_MDF_DH
                , NOP_SUM
                , HD_AUD_STEP_CD
                , HD_DOC_ID
                , HD_APVR_CD
                , HD_AFF_SNO
                , HD_DSP_RQ_SNO
                , REF_DOC_ID
                , DF_AUD_STEP_CD
                , DF_DOC_ID
                , DF_APVR_CD
                , DF_AFF_SNO
                , DF_DSP_RQ_SNO
			    , KYWD1
				, KYWD2
				, KYWD3
				, KYWD4
				, KYWD5 )
          (
           SELECT T1.AUD_YR
                  , T1.AUD_NO
                  , DECODE(T2.LV, 4, 'A1070', 'A1060')
                  , T1.DOC_ID
                  , DECODE(T2.LV, 1, #{jaJdgSsecPstCd},
                                  2, #{owDhdPstCd},
                                  3, '0055700',
                                  4, '0010600')
                  , T1.AFF_SNO
                  , T1.DSP_RQ_SNO
                  , T1.DSP_RQ_SNO
                  , T1.AUD_KND_CD
                  , T1.AUD_GRN_NO
                  , T1.RPRT_FILD_ID
                  , T1.AFF_DSP_CD
                  , T1.RLTN_ORG_CD
                  , T1.HND_ORG_CD
                  , T1.REF_ORG_CD
                  , T1.DSP_RQ_CD
                  , T1.MTRL_IPT_DVSN_CD
                  , T1.NOP_AM_DVSN_CD
                  , T1.NOP_AM
                  , T1.SORT_SNO
                  , T1.ACCN_INSP_CD ]]>
            <if test="owPsdApvDt != null and owPsdApvDt != ''">
                  , DECODE(T2.LV, 3, 'Y', 'N')
            </if>
            <if test="owPsdApvDt == null or owPsdApvDt == ''">
                  , DECODE(T2.LV, 2, 'Y', 'N')
            </if>
        <![CDATA[
                  , #{usrId}
                  , #{usrId}
                  , #{dptCd}
                  , #{mnuId}
                  , SYSDATE
                  , SYSDATE
                  , T1.NOP_SUM
                  , T1.HD_AUD_STEP_CD
                  , T1.HD_DOC_ID
                  , T1.HD_APVR_CD
                  , T1.HD_AFF_SNO
                  , T1.HD_DSP_RQ_SNO
                  , T1.REF_DOC_ID
                  , T1.DF_AUD_STEP_CD
                  , T1.DF_DOC_ID
                  , T1.DF_APVR_CD
                  , T1.DF_AFF_SNO
                  , T1.DF_DSP_RQ_SNO
			      , KYWD1
				  , KYWD2
				  , KYWD3
				  , KYWD4
				  , KYWD5
             FROM TBBADDED146M T1
              LEFT OUTER JOIN (SELECT LEVEL AS LV
                                 FROM DUAL
                               CONNECT BY LEVEL < 5) T2 ON 1=1
            WHERE T1.AUD_YR = #{audYr}
              AND T1.AUD_NO = #{audNo}
              AND T1.DOC_ID = #{docId}
              AND T1.APVR_CD = '0013600' )
        ]]>
        		;
        	END;
    </insert>
    
    <insert id="insertAffMppInfo" parameterType="paramMap">
    DECLARE
    	BEGIN
        <![CDATA[    	
            INSERT INTO TBBADDED147H (
			    HST_DVSN_CD
			  , HST_SNO
			  , HST_DH
			  , HST_USR_ID	
    		  , AUD_YR		
			  , AUD_NO		
			  , AUD_STEP_CD	
			  , APVR_CD		
			  , AUD_KND_CD	
			  , AUD_GRN_NO	
			  , DOC_ID		
			  , RPRT_FILD_ID
			  , PRE_AFF_NO	
			  , AFF_NO		
			  , AFF_SNO		
			  , DSP_RQ_SNO	
			  , MPP_SEQ	
			  , SORT_SNO	
			  , FRT_USR_ID	
			  , FNL_USR_ID	
			  , FNL_DEAL_DPT_CD
			  , FNL_MNU_ID	
			  , FRT_REGI_DH	
			  , FNL_MDF_DH)
		SELECT  'C'
				  , TBBADDED147H_SEQ.NEXTVAL
				  , SYSDATE
				  , #{usrId}
	    		  , AUD_YR		
				  , AUD_NO		
				  , AUD_STEP_CD	
				  , APVR_CD		
				  , AUD_KND_CD	
				  , AUD_GRN_NO	
				  , DOC_ID		
				  , RPRT_FILD_ID
				  , AFF_NO	
				  , AFF_NO		
				  , AFF_SNO		
				  , DSP_RQ_SNO	
				  , SEQ_MPP.NEXTVAL
				  , SORT_SNO	
                  , #{usrId}
                  , #{usrId}
                  , #{dptCd}
                  , #{mnuId}
                  , SYSDATE
                  , SYSDATE
		FROM(SELECT AUD_YR
	                  , AUD_NO
					  , DECODE(LV, 4, 'A1070', 'A1060') 		AS AUD_STEP_CD
	                  , DECODE(LV, 1, #{jaJdgSsecPstCd},
	                                   2, #{owDhdPstCd},
	                                   3, '0055700',
	                                   4, '0010600')			AS APVR_CD
	                  , AUD_KND_CD
	                  , AUD_GRN_NO
	                  , DOC_ID
	                  , RPRT_FILD_ID
	                  , AFF_NO
	                  , AFF_SNO
	                  , DSP_RQ_SNO
					  , SORT_SNO
	           FROM(SELECT DISTINCT T1.AUD_YR 
									  , T2.LV
									  , T1.AUD_NO 
									  , T1.AUD_KND_CD 
									  , MAX(T1.AUD_GRN_NO) AS AUD_GRN_NO
									  , T1.DOC_ID 
									  , MAX(T1.RPRT_FILD_ID) AS RPRT_FILD_ID
									  , T1.AFF_NO 
									  , T1.AFF_SNO 
									  , T1.DSP_RQ_SNO 
									  , MIN(T1.SORT_SNO) AS SORT_SNO                 
			             FROM TBBADDED147M T1
			 LEFT OUTER JOIN (SELECT LEVEL AS LV
			                           FROM DUAL
			                         CONNECT BY LEVEL < 5) T2 ON 1=1
			 LEFT OUTER JOIN TBBADDED148M T3
						 	 ON T1.AUD_YR 		= T3.AUD_YR
							AND T1.AUD_NO 		= T3.AUD_NO
							AND T1.AUD_STEP_CD 	= T3.AUD_STEP_CD
							AND T1.DOC_ID 		= T3.DOC_ID
							AND T1.APVR_CD 		= T3.APVR_CD
							AND T1.AFF_SNO 		= T3.AFF_SNO
							AND T1.DSP_RQ_SNO 	= T3.DSP_RQ_SNO
							AND T1.MPP_SEQ 		= T3.MPP_SEQ	                
			            WHERE T1.AUD_YR = #{audYr}
			              AND T1.AUD_NO = #{audNo}
			              AND T1.DOC_ID = #{docId}
			              AND T1.APVR_CD = '0013600'
						  AND (T3.AFF_MPP_DVSN_CD IS NULL OR T3.AFF_MPP_DVSN_CD NOT IN('D90', 'D70', 'D80', 'D99' ) ) 
					  GROUP BY T1.AUD_YR 
								  , T1.AUD_NO 
								  , T1.AUD_KND_CD 
								  , T1.DOC_ID 
								  , T1.AFF_NO 
								  , T1.AFF_SNO 
								  , T1.DSP_RQ_SNO
								  , T2.LV ) )		  
        ]]>								  
    		;
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.insertAffMppInfo */
        <![CDATA[
            INSERT INTO TBBADDED147M (
			    AUD_YR		
			  , AUD_NO		
			  , AUD_STEP_CD	
			  , APVR_CD		
			  , AUD_KND_CD	
			  , AUD_GRN_NO	
			  , DOC_ID		
			  , RPRT_FILD_ID
			  , PRE_AFF_NO	
			  , AFF_NO		
			  , AFF_SNO		
			  , DSP_RQ_SNO	
			  , MPP_SEQ	
			  , SORT_SNO	
			  , FRT_USR_ID	
			  , FNL_USR_ID	
			  , FNL_DEAL_DPT_CD
			  , FNL_MNU_ID	
			  , FRT_REGI_DH	
			  , FNL_MDF_DH)
          (
           SELECT AUD_YR
                  , AUD_NO
				  , DECODE(LV, 4, 'A1070', 'A1060')
                  , DECODE(LV, 1, #{jaJdgSsecPstCd},
                                   2, #{owDhdPstCd},
                                   3, '0055700',
                                   4, '0010600')
                  , AUD_KND_CD
                  , AUD_GRN_NO
                  , DOC_ID
                  , RPRT_FILD_ID
                  , AFF_NO
                  , AFF_NO
                  , AFF_SNO
                  , DSP_RQ_SNO
			  	  , SEQ_MPP.NEXTVAL
				  , SORT_SNO
                  , #{usrId}
                  , #{usrId}
                  , #{dptCd}
                  , #{mnuId}
                  , SYSDATE
                  , SYSDATE
           FROM
				 (SELECT DISTINCT T1.AUD_YR 
								  , T2.LV
								  , T1.AUD_NO 
								  , T1.AUD_KND_CD 
								  , MAX(T1.AUD_GRN_NO) AS AUD_GRN_NO
								  , T1.DOC_ID 
								  , MAX(T1.RPRT_FILD_ID) AS RPRT_FILD_ID
								  , T1.AFF_NO 
								  , T1.AFF_SNO 
								  , T1.DSP_RQ_SNO 
								  , MIN(T1.SORT_SNO) AS SORT_SNO                 
		             FROM TBBADDED147M T1
		 LEFT OUTER JOIN (SELECT LEVEL AS LV
		                           FROM DUAL
		                         CONNECT BY LEVEL < 5) T2 ON 1=1
		 LEFT OUTER JOIN TBBADDED148M T3
					 	 ON T1.AUD_YR 		= T3.AUD_YR
						AND T1.AUD_NO 		= T3.AUD_NO
						AND T1.AUD_STEP_CD 	= T3.AUD_STEP_CD
						AND T1.DOC_ID 		= T3.DOC_ID
						AND T1.APVR_CD 		= T3.APVR_CD
						AND T1.AFF_SNO 		= T3.AFF_SNO
						AND T1.DSP_RQ_SNO 	= T3.DSP_RQ_SNO
						AND T1.MPP_SEQ 		= T3.MPP_SEQ	                
		            WHERE T1.AUD_YR = #{audYr}
		              AND T1.AUD_NO = #{audNo}
		              AND T1.DOC_ID = #{docId}
		              AND T1.APVR_CD = '0013600'
					  AND (T3.AFF_MPP_DVSN_CD IS NULL OR T3.AFF_MPP_DVSN_CD NOT IN('D90', 'D70', 'D80', 'D99' ) ) 
				  GROUP BY T1.AUD_YR 
							  , T1.AUD_NO 
							  , T1.AUD_KND_CD 
							  , T1.DOC_ID 
							  , T1.AFF_NO 
							  , T1.AFF_SNO 
							  , T1.DSP_RQ_SNO
							  , T2.LV ) )
        ]]>
        ;
        END;
    </insert>
    
    <update id="updateDocApvSta" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.updateDocApvSta */
            UPDATE TBBADDED103M
               SET FNL_USR_ID = #{usrId}
                   , FNL_DEAL_DPT_CD = #{dptCd} 
                   , FNL_MNU_ID = #{mnuId} 
                   , FNL_MDF_DH = SYSDATE
                   , APV_STA_CD = #{apvStaCd}
                   , APV_RQS_ID = #{apvDocNo}
                   , EDT_AUTH = 'N'
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND DOC_ID = #{docId}
    </update>
    
    <insert id="insertSendDoc" parameterType="paramMap">
        /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.insertSendDoc*/
        <![CDATA[
            INSERT INTO TBBADDED111M (
                   AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,SR_DOC_SNO
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM
                  ,RPRT_CD
                  ,LINK_URL
                  ,DOC_STA_CD
                  ,SND_DPT_CD
                  ,SNDR_ID
                  ,SND_DH
                  ,RCPT_DPT_CD
                  ,RCNT_ID
                  ,RCPT_DH
                  ,AUD_RPRT_DVSN_CD
                  ,DOC_KND_CD
                  ,REF_ID
                  ,REF_DY
                  ,SORT_SNO
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH )
           (SELECT AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID
                  ,(
                    SELECT NVL(MAX(TO_NUMBER(T2.SR_DOC_SNO)),0)+1
                      FROM TBBADDED111M T2
                     WHERE T2.AUD_YR = T1.AUD_YR
                       AND T2.AUD_NO = T1.AUD_NO
                       AND T2.DOC_ID = T1.DOC_ID
                   )
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM
                  ,RPRT_CD
                  ,LINK_URL
                  ,'10'
                  ,#{dptCd}
                  ,#{usrId}
                  ,SYSDATE
                  ,'160200'
                  ,''
                  ,SYSDATE
                  ,AUD_RPRT_DVSN_CD
                  ,DOC_KND_CD
                  ,REF_ID
                  ,REF_DY
                  ,SORT_SNO
                  ,#{usrId}
                  ,#{usrId}
                  ,#{dptCd}
                  ,#{mnuId}
                  ,SYSDATE
                  ,SYSDATE 
              FROM TBBADDED103M T1
             WHERE T1.AUD_YR       = #{audYr}
               AND T1.AUD_NO       = #{audNo}
               AND T1.DOC_ID       = #{docId}
             )
        ]]>
    </insert>
    
    <update id="updateCmptYn" parameterType="paramMap">
        /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.updateCmptYn*/
        <![CDATA[
            UPDATE TBBADDED102M 
               SET CMPT_YN = 'Y'
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = 'A1060'
               AND AUD_MAIN_STEP_ID IN ('600301', '600401', '600601')
               AND AUD_MAIN_STEP_SNO = 1
        ]]>
    </update>
    
    <select id="selectTrtmInsertYnByAudRprt" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.selectTrtmInsertYnByAudRprt*/
        SELECT 
            DECODE((SELECT COUNT(1) FROM TBBADDED112M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo}),0,'Y','N') AS TRTM_MAIN_INSERT_YN 
            , DECODE((SELECT COUNT(1) FROM TBBADDED112D WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND DOC_ID = #{docId}),0,'Y','N') AS TRTM_DTL_INSERT_YN
        FROM DUAL
    </select>
    
    <insert id="insertTrtmMainData" parameterType="paramMap">
        /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.insertTrtmMainData*/
      INSERT INTO TBBADDED112M(
                            AUD_YR,
                             AUD_NO,
                             AUD_KND_CD,
                             AUD_GRN_NO,
                             AUD_SBJ_NM,
                             SBCN_TRTM_REQ_DT,
                             SHARE_YN,
                             FRT_USR_ID,
                             FNL_USR_ID,
                             FNL_DEAL_DPT_CD,
                             FNL_MNU_ID,
                             FRT_REGI_DH,
                             FNL_MDF_DH)
                      VALUES(#{audYr},
                             #{audNo},
                             (SELECT AUD_KND_CD FROM TBBADDED001M
                                WHERE
                                    AUD_YR = #{audYr}
                                AND AUD_NO = #{audNo}),
                             (SELECT AUD_GRN_NO FROM TBBADDED001M
                                WHERE
                                    AUD_YR = #{audYr}
                                AND AUD_NO = #{audNo}),
                             (SELECT AUD_SBJ_NM FROM TBBADDED001M
                                WHERE
                                    AUD_YR = #{audYr}
                                AND AUD_NO = #{audNo}),
                             TO_CHAR(SYSDATE,'YYYYMMDD'),
                             'N',
                             #{usrId},
                             #{usrId},
                             #{dptCd},
                             #{mnuId},
                             SYSDATE,
                             SYSDATE)
    </insert>
    
    <insert id="insertTrtmDtlData" parameterType="paramMap">
        /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.insertTrtmDtlData*/
        INSERT INTO TBBADDED112D(AUD_YR,AUD_NO,SBCN_TRTM_DTL_SNO,DOC_ID,SORT_SNO,FRT_USR_ID,FNL_USR_ID,FNL_DEAL_DPT_CD,FNL_MNU_ID,
                    FRT_REGI_DH,FNL_MDF_DH)
      VALUES(#{audYr}, #{audNo}, 
             (SELECT 
                LPAD(NVL(MAX(TO_NUMBER(SBCN_TRTM_DTL_SNO)),0)+1,3,0) 
              FROM TBBADDED112D 
              WHERE 
                AUD_YR = #{audYr} 
              AND AUD_NO =#{audNo} ),
           #{docId},
             (SELECT 
                LPAD(NVL(MAX(TO_NUMBER(SBCN_TRTM_DTL_SNO)),0)+1,3,0) 
              FROM TBBADDED112D 
              WHERE 
                AUD_YR = #{audYr}  
              AND AUD_NO =#{audNo} ),
           #{usrId},#{usrId},#{dptCd},#{mnuId},SYSDATE,SYSDATE)
    </insert>
    
    <insert id="insertTrtmDtlPrcs" parameterType="paramMap">
        /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.insertTrtmDtlPrcs*/
    INSERT INTO TBBADDED102M
          (
            AUD_YR
            ,AUD_NO
            ,AUD_STEP_CD
            ,AUD_MAIN_STEP_ID
            ,AUD_MAIN_STEP_SNO
            ,AUD_MAIN_SEQ_W
            ,AUD_MAIN_SEQ_H
            ,AUD_DOC_CD
            ,CMPT_YN
            ,AUD_KND_CD
            ,AUD_GRN_NO
            ,MAIN_JOB_NM 
            ,LINK_TYPE
            ,LINK_URL
            ,SORT_SNO
            ,FRT_USR_ID
            ,FNL_USR_ID
            ,FNL_DEAL_DPT_CD
            ,FNL_MNU_ID
            ,FRT_REGI_DH
            ,FNL_MDF_DH
          )
          (SELECT 
                AUD_YR, 
                AUD_NO, 
                T3.AUD_STEP_CD,
                AUD_MAIN_STEP_ID,
                SBCN_TRTM_DTL_SNO AS AUD_MAIN_STEP_SNO,
                AUD_MAIN_SEQ_W,
                AUD_MAIN_SEQ_H,
                AUD_DOC_CD,
                CMPT_YN,
                T2.AUD_KND_CD,
                AUD_GRN_NO,
                AUD_MAIN_STEP_NM AS MAIN_JOB_NM,
                LINK_TYPE,
                LINK_URL,
                NULL AS SORT_SNO,
                #{usrId},
                #{usrId},
                #{dptCd},
                #{mnuId},
                SYSDATE,
                SYSDATE
            FROM 
                TBBADDED112D T1
                JOIN
                TBBADDED001M T2
                USING (AUD_YR, AUD_NO)
                JOIN
                TBBADDED102B T3
                ON SUBSTR(T2.AUD_KND_CD,-1) = T3.AUD_KND_CD
            WHERE 
                AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND T3.AUD_STEP_CD = 'A1070'
            AND SUBSTR(T3.AUD_MAIN_STEP_ID,0,2) = '70'
            AND SBCN_TRTM_DTL_SNO NOT IN (SELECT 
                                                DISTINCT AUD_MAIN_STEP_SNO 
                                          FROM TBBADDED102M 
                                          WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND SUBSTR(AUD_MAIN_STEP_ID,0,2) = '70')
           )
    </insert>
    
    
    <update id="AEPAFU001AfterProcessByChfDescRprt" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001AfterProcessByChfDescRprt*/
    <![CDATA[  
			 UPDATE TBBADDED102M
				SET CMPT_YN 		 = 'Y'
				WHERE AUD_YR 		 = #{audYr}
				AND AUD_NO		 	 = #{audNo}
				AND AUD_STEP_CD 	 = #{audStepCd}
				AND AUD_MAIN_STEP_ID = #{audMainStepId}
				AND AUD_MAIN_STEP_SNO = (SELECT T3.AUD_MAIN_STEP_SNO
				                        FROM 
				                            TBBADDED103M T1
				                            INNER JOIN TBBADDED112D T2
				                            ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO AND T1.REF_ID = T2.DOC_ID)
				                            INNER JOIN TBBADDED102M T3
				                            ON (T2.AUD_YR = T3.AUD_YR AND T2.AUD_NO = T3.AUD_NO AND T2.SBCN_TRTM_DTL_SNO = T3.AUD_MAIN_STEP_SNO AND T3.AUD_MAIN_STEP_ID = #{audMainStepId})
				                        WHERE 
				                            T1.AUD_YR = #{audYr}
				                        AND T1.AUD_NO = #{audNo}
				                        AND T1.AUD_STEP_CD = #{audStepCd}
				                        AND T1.DOC_ID = #{docId})
	]]>
    </update>
    
    
    <update id="AEPAFU001saveRvwRsq" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001saveRvwRsq*/
    		<![CDATA[
			UPDATE  TBBADDED112D
				SET     
							RVW_REQ_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
							,RVW_CMPT_YN = 'N'
							, FNL_USR_ID = #{usrId}
							, FNL_MNU_ID = #{mnuId}
							, FNL_MDF_DH = SYSDATE
							, FNL_DEAL_DPT_CD = #{dptCd}
				WHERE   
							AUD_YR = #{audYr}
				AND     AUD_NO  = #{audNo}
				AND     SBCN_TRTM_DTL_SNO  = (SELECT MAX(SBCN_TRTM_DTL_SNO) AS SBCN_TRTM_DTL_SNO
											FROM TBBADDED112D T2
											WHERE 
												AUD_YR = #{audYr}
											AND AUD_NO = #{audNo}
											AND DOC_ID = #{refId} )
			]]>
    </update>
    
    <update id="AEPAFU001updateSendRvwRsqDoc" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001updateSendRvwRsqDoc*/
        <![CDATA[
			UPDATE  TBBADDED111M
				SET DOC_STA_CD = '20'
					, RCNT_ID = #{usrId}
					, RCPT_DH = SYSDATE
		            , FNL_USR_ID = #{usrId}
		            , FNL_MNU_ID = #{mnuId}
		            , FNL_MDF_DH = SYSDATE
		            , FNL_DEAL_DPT_CD = #{dptCd}
				WHERE   
						AUD_YR = #{audYr}
				AND     AUD_NO  = #{audNo}
		        AND     AUD_STEP_CD = #{audStepCd}
		        AND     (DOC_ID = #{refId} OR REF_ID = #{refId})
				AND     RCPT_DPT_CD = '510000'
		]]>
    </update>
    
    
    <update id="AEPAFU001saveCmptRvwRsq" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001saveCmptRvwRsq*/
    		<![CDATA[
			UPDATE  TBBADDED112D
				SET     
							RVW_CMPT_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
							,RVW_CMPT_YN = 'Y'
							, FNL_USR_ID = #{usrId}
							, FNL_MNU_ID = #{mnuId}
							, FNL_MDF_DH = SYSDATE
							, FNL_DEAL_DPT_CD = #{dptCd}
				WHERE   
							AUD_YR = #{audYr}
				AND     AUD_NO  = #{audNo}
				AND     SBCN_TRTM_DTL_SNO  = (SELECT MAX(SBCN_TRTM_DTL_SNO) AS SBCN_TRTM_DTL_SNO
											FROM TBBADDED112D T2
											WHERE 
												AUD_YR = #{audYr}
											AND AUD_NO = #{audNo}
											AND DOC_ID = #{refId} )
			]]>
    </update>
    
    
    <select id="selectRefId" parameterType="paramMap" resultType="string">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.selectRefId*/
        SELECT REF_ID
          FROM TBBADDED103M
         WHERE AUD_YR = #{audYr}
           AND AUD_NO = #{audNo}
           AND AUD_STEP_CD = #{audStepCd}
           AND RPRT_CD = #{rprtCd}
           AND DOC_ID = #{docId}
    </select>
    
    <select id="AEPAFU001GetSbcnYn" parameterType="paramMap" resultType="string">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001GetSbcnYn*/
     <![CDATA[
        SELECT 
		    DECODE(SUM(DECODE(REFER_DVSN_CD,'D10',1,0)),0,'N','Y') AS SBCN_YN
		  FROM TBBADDED103M T1
		       INNER JOIN TBBADDED145M T2
		       ON (T1.AUD_YR = T2.AUD_YR
		           AND T1.AUD_NO = T2.AUD_NO
		           AND T1.DOC_ID = T2.DOC_ID)
		 WHERE T1.RPRT_CD = 'A10600200'
		   AND T1.DOC_ID = #{refId}
		   AND T2.FNL_YN = 'Y'
    ]]>
    </select>
    
    
    <insert id="AEPAFU001InsertCopyAudRprt" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001InsertCopyAudRprt*/
        INSERT INTO TBBADDED103M (
			       AUD_YR
			      ,AUD_NO
			      ,AUD_STEP_CD
			      ,DOC_ID 
			      ,AUD_KND_CD
			      ,AUD_GRN_NO
			      ,RPRT_NM
			      ,LINK_URL
			      ,NECES_YN
			      ,APV_STA_CD
			      ,RPRT_CD
			      ,APV_RQS_ID
			      ,SND_DOC_YN
			      ,DOC_KND_CD   
			      ,AUD_RPRT_DVSN_CD
			      ,REF_ID
			      ,REF_DY
			      ,RLTN_ORG_CD
			      ,SORT_SNO
			      ,SYT_TRTM_DVSN_YN
			      ,AUD_DOC_KND_CD
			      ,CON_PGM_CD
			      ,APV_WAY_CD
			      ,DOC_WRT_ID
			      ,ONR_HNDL_NO
			      ,FRT_USR_ID
			      ,FNL_USR_ID
			      ,FNL_DEAL_DPT_CD
			      ,FNL_MNU_ID
			      ,FRT_REGI_DH
			      ,FNL_MDF_DH
			      ,EDT_AUTH
			      ,FNL_BAI_RPRT_YN
			      ,TEMPLATE_DOC_ID
			      ,REF_DOC_ID
			)
			 SELECT AUD_YR
			      ,AUD_NO
			      ,'A1070'
			      ,#{copyAudRptId}
			      ,AUD_KND_CD
			      ,AUD_GRN_NO
			      ,RPRT_NM||'(최종)'
			      ,REPLACE(REPLACE(LINK_URL,'audStepCd=A1060','audStepCd=A1070'),'docId='||DOC_ID,'docId='||#{copyAudRptId})
			      ,NECES_YN
			      ,'30'
			      ,RPRT_CD
			      ,''
			      ,'N'
			      ,DOC_KND_CD   
			      ,TO_CHAR(TO_NUMBER(AUD_RPRT_DVSN_CD) + 1)
			      ,#{refId}
			      ,REF_DY
			      ,RLTN_ORG_CD
			      ,(SELECT MAX(SORT_SNO)+1 FROM TBBADDED103M B  WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND AUD_STEP_CD = #{audStepCd}) AS SORT_SNO
			      ,SYT_TRTM_DVSN_YN
			      ,AUD_DOC_KND_CD
			      ,CON_PGM_CD
			      ,APV_WAY_CD
			      ,DOC_WRT_ID
			      ,ONR_HNDL_NO
			      ,FRT_USR_ID
			      ,FNL_USR_ID
			      ,FNL_DEAL_DPT_CD
			      ,FNL_MNU_ID
			      ,SYSDATE
			      ,SYSDATE
			      ,''
			      ,'Y'
			      ,TEMPLATE_DOC_ID
			      ,#{refId}
			FROM TBBADDED103M A
			WHERE AUD_YR = #{audYr}
			 AND AUD_NO = #{audNo}
			 AND AUD_STEP_CD = 'A1060'
			 AND RPRT_CD = 'A10600200'
			 AND DOC_ID = #{refId}
    </insert>
        
    <update id="AEPAFU001UpdateAffFnlYnReSetByAudRprt" parameterType="paramMap">
    DECLARE
    	BEGIN
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001UpdateAffFnlYnReSetByAudRprt*/
            UPDATE TBBADDED145M
			   SET FNL_YN = 'N'
			 WHERE DOC_ID = #{refId}
			 ;
          INSERT INTO TBBADDED145H
					(
					   HST_DVSN_CD
					 , HST_SNO
					 , HST_DH
					 , HST_USR_ID	
					 , AUD_YR			
					 , AUD_NO			
					 , AUD_STEP_CD	
					 , DOC_ID			
					 , APVR_CD		
					 , AFF_SNO		
					 , AUD_KND_CD		
					 , AUD_GRN_NO		
					 , RPRT_FILD_ID	
					 , AFF_CD			
					 , LIST_NO		
					 , REFER_DVSN_CD	
					 , AFF_SPH		
					 , TITLE_NM		
					 , DP_TITLE_NM	
					 , QST_DOC_ISUE_YN
					 , QST_DOC_ISUE_DY
					 , AUDTOR			
					 , DETL_DOC_NO	
					 , MTRL_IPT_DVSN_CD
					 , SYT_TRTM_DVSN_YN
					 , SCRT_YN		
					 , SORT_SNO		
					 , TRTM_EXAMER_CNB
					 , FNL_YN			
					 , FRT_USR_ID		
					 , FNL_USR_ID		
					 , FNL_DEAL_DPT_CD
					 , FNL_MNU_ID		
					 , FRT_REGI_DH	
					 , FNL_MDF_DH		
					 , REF_DOC_ID		
					)
				SELECT 'U'
				 	 , TBBADDED145H_SEQ.NEXTVAL
				 	 , SYSDATE
				 	 , 'SYSTEM'
					 , AUD_YR			
					 , AUD_NO			
					 , AUD_STEP_CD	
					 , DOC_ID			
					 , APVR_CD		
					 , AFF_SNO		
					 , AUD_KND_CD		
					 , AUD_GRN_NO		
					 , RPRT_FILD_ID	
					 , AFF_CD			
					 , LIST_NO		
					 , REFER_DVSN_CD	
					 , AFF_SPH		
					 , TITLE_NM		
					 , DP_TITLE_NM	
					 , QST_DOC_ISUE_YN
					 , QST_DOC_ISUE_DY
					 , AUDTOR			
					 , DETL_DOC_NO	
					 , MTRL_IPT_DVSN_CD
					 , SYT_TRTM_DVSN_YN
					 , SCRT_YN		
					 , SORT_SNO		
					 , TRTM_EXAMER_CNB
					 , FNL_YN			
					 , FRT_USR_ID		
					 , FNL_USR_ID		
					 , FNL_DEAL_DPT_CD
					 , FNL_MNU_ID		
					 , FRT_REGI_DH	
					 , FNL_MDF_DH		
					 , REF_DOC_ID
				FROM TBBADDED145M
			 WHERE DOC_ID = #{refId}
				;
		END;		   
    </update>
    
    <update id="AEPAFU001UpdateDSpFnlYnReSetByAudRprt" parameterType="paramMap">
    DECLARE
    	BEGIN
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001UpdateDSpFnlYnReSetByAudRprt*/
        UPDATE TBBADDED146M
	       SET FNL_YN = 'N'
	     WHERE DOC_ID = #{refId}
	     ;
		INSERT INTO TBBADDED146H
				(
				    HST_DVSN_CD
				  , HST_SNO
				  , HST_DH
				  , HST_USR_ID	
				  , AUD_YR
				  , AUD_NO
				  , AUD_STEP_CD 	
				  , DOC_ID 			
				  , APVR_CD 		
				  , AFF_SNO 		
				  , DSP_RQ_SNO 		
				  , DP_DSP_RQ_SNO 	
				  , AUD_KND_CD 		
				  , AUD_GRN_NO 		
				  , RPRT_FILD_ID 	
				  , AFF_DSP_CD 		
				  , RLTN_ORG_CD 	
				  , HND_ORG_CD 		
				  , REF_ORG_CD 		
				  , DSP_RQ_CD 		
				  , MTRL_IPT_DVSN_CD
				  , NOP_AM_DVSN_CD 	
				  , NOP_AM 			
				  , SORT_SNO		
				  , ACCN_INSP_CD	
				  , FNL_YN 			
				  , FRT_USR_ID 		
				  , FNL_USR_ID 		
				  , FNL_DEAL_DPT_CD 
				  , FNL_MNU_ID 		
				  , FRT_REGI_DH		
				  , FNL_MDF_DH 		
				  , NOP_SUM 		
				  , HD_AUD_STEP_CD 	
				  , HD_DOC_ID		
				  , HD_APVR_CD		
				  , HD_AFF_SNO 		
				  , HD_DSP_RQ_SNO	
				  , REF_DOC_ID 		
				  , DF_AUD_STEP_CD 	
				  , DF_DOC_ID 		
				  , DF_APVR_CD 		
				  , DF_AFF_SNO		
				  , DF_DSP_RQ_SNO 	
				  , KYWD1			
				  , KYWD2 			
				  , KYWD3 			
				  , KYWD4			
				  , KYWD5			
				)
			SELECT 'U'
			 	 , TBBADDED146H_SEQ.NEXTVAL
			 	 , SYSDATE
			 	 , 'SYSTEM'
				 , AUD_YR
				 , AUD_NO
				 , AUD_STEP_CD 	
				 , DOC_ID 			
				 , APVR_CD 		
				 , AFF_SNO 		
				 , DSP_RQ_SNO 		
				 , DP_DSP_RQ_SNO 	
				 , AUD_KND_CD 		
				 , AUD_GRN_NO 		
				 , RPRT_FILD_ID 	
				 , AFF_DSP_CD 		
				 , RLTN_ORG_CD 	
				 , HND_ORG_CD 		
				 , REF_ORG_CD 		
				 , DSP_RQ_CD 		
				 , MTRL_IPT_DVSN_CD
				 , NOP_AM_DVSN_CD 	
				 , NOP_AM 			
				 , SORT_SNO		
				 , ACCN_INSP_CD	
				 , FNL_YN 			
				 , FRT_USR_ID 		
				 , FNL_USR_ID 		
				 , FNL_DEAL_DPT_CD 
				 , FNL_MNU_ID 		
				 , FRT_REGI_DH		
				 , FNL_MDF_DH 		
				 , NOP_SUM 		
				 , HD_AUD_STEP_CD 	
				 , HD_DOC_ID		
				 , HD_APVR_CD		
				 , HD_AFF_SNO 		
				 , HD_DSP_RQ_SNO	
				 , REF_DOC_ID 		
				 , DF_AUD_STEP_CD 	
				 , DF_DOC_ID 		
				 , DF_APVR_CD 		
				 , DF_AFF_SNO		
				 , DF_DSP_RQ_SNO 	
				 , KYWD1			
				 , KYWD2 			
				 , KYWD3 			
				 , KYWD4			
				 , KYWD5
			 FROM TBBADDED146M
	     WHERE DOC_ID = #{refId}
				;
		END;				     
    </update>

    <insert id="AEPAFU001InsertCmtrAffDataByAudRprt" parameterType="paramMap">
    DECLARE
    	BEGIN
    	INSERT INTO TBBADDED145H
    	(	 	HST_DVSN_CD
			  , HST_SNO
			  , HST_DH
			  , HST_USR_ID
    		  , AUD_YR
			  , AUD_NO
			  , AUD_STEP_CD
			  , DOC_ID
			  , APVR_CD
			  , AFF_SNO
			  , AUD_KND_CD
			  , AUD_GRN_NO
			  , RPRT_FILD_ID
			  , AFF_CD
			  , LIST_NO
			  , REFER_DVSN_CD
			  , AFF_SPH
			  , TITLE_NM
			  , DP_TITLE_NM
			  , QST_DOC_ISUE_YN
			  , QST_DOC_ISUE_DY
			  , AUDTOR
			  , DETL_DOC_NO
			  , MTRL_IPT_DVSN_CD
			  , SYT_TRTM_DVSN_YN
			  , SCRT_YN
			  , SORT_SNO
			  , TRTM_EXAMER_CNB 
			  , FRT_USR_ID 
			  , FNL_USR_ID
			  , FNL_DEAL_DPT_CD
			  , FNL_MNU_ID
			  , FRT_REGI_DH
			  , FNL_MDF_DH
			  , FNL_YN
			  , REF_DOC_ID	)
		   SELECT 'C'
			 	 , TBBADDED145H_SEQ.NEXTVAL
			 	 , SYSDATE
			 	 , 'SYSTEM'			  
			      , AUD_YR
				  , AUD_NO
				  , 'A1070'
				  , DOC_ID
				  , #{targetApvrCd}
				  , AFF_SNO
				  , AUD_KND_CD
				  , AUD_GRN_NO
				  , RPRT_FILD_ID
				  , AFF_CD
				  , LIST_NO
				  , REFER_DVSN_CD
				  , AFF_SPH
				  , TITLE_NM
				  , TITLE_NM
				  , QST_DOC_ISUE_YN
				  , QST_DOC_ISUE_DY
				  , AUDTOR
				  , DETL_DOC_NO
				  , MTRL_IPT_DVSN_CD
				  , SYT_TRTM_DVSN_YN
				  , SCRT_YN
				  , SORT_SNO
				  , TRTM_EXAMER_CNB 
				  , #{usrId}
				  , #{usrId}
				  , #{dptCd}
				  , #{mnuId}
				  , SYSDATE
				  , SYSDATE
				  , FNL_YN
				  , #{copyAudRptId}
		FROM(SELECT DISTINCT AA.AUD_YR
				  , AA.AUD_NO
				  , AA.DOC_ID
				  , AA.AFF_SNO
				  , AA.AUD_KND_CD
				  , AA.AUD_GRN_NO
				  , AA.RPRT_FILD_ID
				  , AA.AFF_CD
				  , AA.LIST_NO
				  , AA.REFER_DVSN_CD
				  , AA.AFF_SPH
				  , AA.TITLE_NM
				  , AA.QST_DOC_ISUE_YN
				  , AA.QST_DOC_ISUE_DY
				  , AA.AUDTOR
				  , AA.DETL_DOC_NO
				  , AA.MTRL_IPT_DVSN_CD
				  , AA.SYT_TRTM_DVSN_YN
				  , AA.SCRT_YN
				  , AA.SORT_SNO
				  , AA.TRTM_EXAMER_CNB
				  , AA.FNL_YN
		      FROM TBBADDED145M AA
	             , TBBADDED146M CC
		 	 WHERE AA.DOC_ID = #{refId} 
		       AND AA.APVR_CD = #{apvrCd}
	           AND AA.AUD_YR = CC.AUD_YR
	           AND AA.AUD_NO = CC.AUD_NO
	           AND AA.DOC_ID = CC.DOC_ID
	           AND AA.APVR_CD = CC.APVR_CD
	           AND AA.AFF_SNO = CC.AFF_SNO
	           AND NOT EXISTS (
	                           SELECT 1 
	                             FROM TBBADDED147M ZZ
				   LEFT OUTER JOIN TBBADDED148M YY
							 		 ON ZZ.AUD_YR 		= YY.AUD_YR
									AND ZZ.AUD_NO 		= YY.AUD_NO
									AND ZZ.AUD_STEP_CD = YY.AUD_STEP_CD
									AND ZZ.DOC_ID 		= YY.DOC_ID
									AND ZZ.APVR_CD 		= YY.APVR_CD
									AND ZZ.AFF_SNO 		= YY.AFF_SNO
									AND ZZ.DSP_RQ_SNO 	= YY.DSP_RQ_SNO
									AND ZZ.MPP_SEQ 		= YY.MPP_SEQ			   
	                            WHERE ZZ.AUD_YR = AA.AUD_YR
	                              AND ZZ.AUD_NO = AA.AUD_NO
	                              AND ZZ.DOC_ID = AA.DOC_ID
	                              AND ZZ.PRE_AFF_NO = F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || '-' || AA.AFF_CD || '-' || CC.AFF_DSP_CD
	                              AND ZZ.APVR_CD = #{targetApvrCd}
	                              AND YY.AFF_MPP_DVSN_CD IN ( 'D90', 'D70', 'D80', 'D99' )
	                          ) )
	                     ;
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001InsertCmtrAffDataByAudRprt*/
        INSERT INTO TBBADDED145M
			  ( AUD_YR
			  , AUD_NO
			  , AUD_STEP_CD
			  , DOC_ID
			  , APVR_CD
			  , AFF_SNO
			  , AUD_KND_CD
			  , AUD_GRN_NO
			  , RPRT_FILD_ID
			  , AFF_CD
			  , LIST_NO
			  , REFER_DVSN_CD
			  , AFF_SPH
			  , TITLE_NM
			  , DP_TITLE_NM
			  , QST_DOC_ISUE_YN
			  , QST_DOC_ISUE_DY
			  , AUDTOR
			  , DETL_DOC_NO
			  , MTRL_IPT_DVSN_CD
			  , SYT_TRTM_DVSN_YN
			  , SCRT_YN
			  , SORT_SNO
			  , TRTM_EXAMER_CNB 
			  , FRT_USR_ID 
			  , FNL_USR_ID
			  , FNL_DEAL_DPT_CD
			  , FNL_MNU_ID
			  , FRT_REGI_DH
			  , FNL_MDF_DH
			  , FNL_YN
			  , REF_DOC_ID)
		SELECT DISTINCT AA.AUD_YR
			  , AA.AUD_NO
			  , 'A1070'
			  , AA.DOC_ID
			  , #{targetApvrCd}
			  , AA.AFF_SNO
			  , AA.AUD_KND_CD
			  , AA.AUD_GRN_NO
			  , AA.RPRT_FILD_ID
			  , AA.AFF_CD
			  , AA.LIST_NO
			  , AA.REFER_DVSN_CD
			  , AA.AFF_SPH
			  , AA.TITLE_NM
			  , AA.TITLE_NM
			  , AA.QST_DOC_ISUE_YN
			  , AA.QST_DOC_ISUE_DY
			  , AA.AUDTOR
			  , AA.DETL_DOC_NO
			  , AA.MTRL_IPT_DVSN_CD
			  , AA.SYT_TRTM_DVSN_YN
			  , AA.SCRT_YN
			  , AA.SORT_SNO
			  , AA.TRTM_EXAMER_CNB
			  , #{usrId}
			  , #{usrId}
			  , #{dptCd}
			  , #{mnuId}
			  , SYSDATE
			  , SYSDATE
			  , AA.FNL_YN
			  , #{copyAudRptId}
	      FROM TBBADDED145M AA
             , TBBADDED146M CC
	 	 WHERE AA.DOC_ID = #{refId} 
	       AND AA.APVR_CD = #{apvrCd}
           AND AA.AUD_YR = CC.AUD_YR
           AND AA.AUD_NO = CC.AUD_NO
           AND AA.DOC_ID = CC.DOC_ID
           AND AA.APVR_CD = CC.APVR_CD
           AND AA.AFF_SNO = CC.AFF_SNO
           AND NOT EXISTS (
                           SELECT 1 
                             FROM TBBADDED147M ZZ
			   LEFT OUTER JOIN TBBADDED148M YY
						 		 ON ZZ.AUD_YR 		= YY.AUD_YR
								AND ZZ.AUD_NO 		= YY.AUD_NO
								AND ZZ.AUD_STEP_CD = YY.AUD_STEP_CD
								AND ZZ.DOC_ID 		= YY.DOC_ID
								AND ZZ.APVR_CD 		= YY.APVR_CD
								AND ZZ.AFF_SNO 		= YY.AFF_SNO
								AND ZZ.DSP_RQ_SNO 	= YY.DSP_RQ_SNO
								AND ZZ.MPP_SEQ 		= YY.MPP_SEQ			   
                            WHERE ZZ.AUD_YR = AA.AUD_YR
                              AND ZZ.AUD_NO = AA.AUD_NO
                              AND ZZ.DOC_ID = AA.DOC_ID
                              AND ZZ.PRE_AFF_NO = F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || '-' || AA.AFF_CD || '-' || CC.AFF_DSP_CD
                              AND ZZ.APVR_CD = #{targetApvrCd}
                              AND YY.AFF_MPP_DVSN_CD IN ( 'D90', 'D70', 'D80', 'D99' )
                          ) 
                          ;
                     END;
    </insert>
    
    <insert id="AEPAFU001InsertCmtrDspRqDataByAudRprt" parameterType="paramMap">
    DECLARE
    	BEGIN
   		INSERT INTO TBBADDED146H(
 				  HST_DVSN_CD
			  	, HST_SNO
			  	, HST_DH
			  	, HST_USR_ID
              	, AUD_YR
                , AUD_NO
                , AUD_STEP_CD
                , DOC_ID
                , APVR_CD
                , AFF_SNO
                , DSP_RQ_SNO
                , DP_DSP_RQ_SNO
                , AUD_KND_CD
                , AUD_GRN_NO
                , RPRT_FILD_ID
                , AFF_DSP_CD
                , RLTN_ORG_CD
                , HND_ORG_CD
                , REF_ORG_CD
                , DSP_RQ_CD
                , MTRL_IPT_DVSN_CD
                , NOP_AM_DVSN_CD
                , NOP_AM
                , SORT_SNO
                , ACCN_INSP_CD
                , FNL_YN
                , FRT_USR_ID
                , FNL_USR_ID
                , FNL_DEAL_DPT_CD
                , FNL_MNU_ID
                , FRT_REGI_DH
                , FNL_MDF_DH
                , NOP_SUM
                , HD_AUD_STEP_CD
                , HD_DOC_ID
                , HD_APVR_CD
                , HD_AFF_SNO
                , HD_DSP_RQ_SNO
                , REF_DOC_ID
                , DF_AUD_STEP_CD
                , DF_DOC_ID
                , DF_APVR_CD
                , DF_AFF_SNO
                , DF_DSP_RQ_SNO
			    , KYWD1
			    , KYWD2
			    , KYWD3
			    , KYWD4
			    , KYWD5 )
           SELECT  'C'
					  , TBBADDED146H_SEQ.NEXTVAL
					  , SYSDATE
				  	, #{usrId}
	              	, AUD_YR
	                , AUD_NO
	                , 'A1070'
	                , DOC_ID
	                , #{targetApvrCd}
	                , AFF_SNO
	                , DSP_RQ_SNO
	                , DSP_RQ_SNO
	                , AUD_KND_CD
	                , AUD_GRN_NO
	                , RPRT_FILD_ID
	                , AFF_DSP_CD
	                , RLTN_ORG_CD
	                , HND_ORG_CD
	                , REF_ORG_CD
	                , DSP_RQ_CD
	                , MTRL_IPT_DVSN_CD
	                , NOP_AM_DVSN_CD
	                , NOP_AM
	                , SORT_SNO
	                , ACCN_INSP_CD
	                , FNL_YN
                  , #{usrId}
                  , #{usrId}
                  , #{dptCd}
                  , #{mnuId}
                  , SYSDATE
                  , SYSDATE
	                , NOP_SUM
	                , HD_AUD_STEP_CD
	                , HD_DOC_ID
	                , HD_APVR_CD
	                , HD_AFF_SNO
	                , HD_DSP_RQ_SNO
	                , #{copyAudRptId}
	                , DF_AUD_STEP_CD
	                , DF_DOC_ID
	                , DF_APVR_CD
	                , DF_AFF_SNO
	                , DF_DSP_RQ_SNO
 					, KYWD1
					, KYWD2
					, KYWD3
					, KYWD4
					, KYWD5
           	FROM( SELECT
						AA.AUD_YR
					  , AA.AUD_NO
					  , AA.DOC_ID
					  , AA.AFF_SNO
					  , AA.DSP_RQ_SNO
					  , AA.AUD_KND_CD
					  , AA.AUD_GRN_NO
					  , AA.RPRT_FILD_ID
					  , AA.AFF_DSP_CD
					  , AA.RLTN_ORG_CD
					  , AA.HND_ORG_CD
					  , AA.REF_ORG_CD
					  , AA.DSP_RQ_CD
					  , AA.MTRL_IPT_DVSN_CD
					  , AA.NOP_AM_DVSN_CD
					  , AA.NOP_AM
					  , AA.SORT_SNO
					  , AA.FNL_YN
					  , AA.ACCN_INSP_CD
					  , AA.NOP_SUM
					  , AA.HD_AUD_STEP_CD	
					  , AA.HD_DOC_ID	
					  , AA.HD_APVR_CD	
					  , AA.HD_AFF_SNO	
					  , AA.HD_DSP_RQ_SNO
					  , AA.DF_AUD_STEP_CD
	                  , AA.DF_DOC_ID
	                  , AA.DF_APVR_CD
	                  , AA.DF_AFF_SNO
	                  , AA.DF_DSP_RQ_SNO
					  , AA.KYWD1
					  , AA.KYWD2
					  , AA.KYWD3
					  , AA.KYWD4
					  , AA.KYWD5
			      FROM TBBADDED146M AA
			         , TBBADDED145M CC
			 	 WHERE AA.DOC_ID = #{refId} 
			   	   AND AA.APVR_CD = #{apvrCd}
		           AND AA.AUD_YR = CC.AUD_YR
		           AND AA.AUD_NO = CC.AUD_NO
		           AND AA.DOC_ID = CC.DOC_ID
		           AND AA.APVR_CD = CC.APVR_CD
		           AND AA.AFF_SNO = CC.AFF_SNO
		           AND NOT EXISTS (
		                           SELECT 1 
		                             FROM TBBADDED147M ZZ
						     INNER JOIN TBBADDED148M YY
						                ON ZZ.AUD_YR 			= YY.AUD_YR
									  AND ZZ.AUD_NO 		= YY.AUD_NO
									  AND ZZ.AUD_STEP_CD 	= YY.AUD_STEP_CD
									  AND ZZ.DOC_ID 			= YY.DOC_ID
									  AND ZZ.APVR_CD 		= YY.APVR_CD
									  AND ZZ.AFF_SNO 		= YY.AFF_SNO
									  AND ZZ.DSP_RQ_SNO 	= YY.DSP_RQ_SNO
									  AND ZZ.MPP_SEQ 		= YY.MPP_SEQ    
		                            WHERE ZZ.AUD_YR = AA.AUD_YR
		                              AND ZZ.AUD_NO = AA.AUD_NO
		                              AND ZZ.DOC_ID 	= AA.DOC_ID
		                              AND ZZ.PRE_AFF_NO = F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || '-' || CC.AFF_CD || '-' || AA.AFF_DSP_CD
		                              AND ZZ.APVR_CD = #{targetApvrCd}
		                              
		                              AND YY.AFF_MPP_DVSN_CD IN ( 'D90', 'D70', 'D80', 'D99' )
		                          ) )           	 
           	;    	
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001InsertCmtrDspRqDataByAudRprt*/
        INSERT INTO TBBADDED146M
			  ( AUD_YR
			  , AUD_NO
			  , AUD_STEP_CD
			  , DOC_ID
			  , APVR_CD
			  , AFF_SNO
			  , DSP_RQ_SNO
			  , DP_DSP_RQ_SNO
			  , AUD_KND_CD
			  , AUD_GRN_NO
			  , RPRT_FILD_ID
			  , AFF_DSP_CD
			  , RLTN_ORG_CD
			  , HND_ORG_CD
			  , REF_ORG_CD
			  , DSP_RQ_CD
			  , MTRL_IPT_DVSN_CD
			  , NOP_AM_DVSN_CD
			  , NOP_AM
			  , SORT_SNO
			  , FRT_USR_ID
			  , FNL_USR_ID
			  , FNL_DEAL_DPT_CD
			  , FNL_MNU_ID
			  , FRT_REGI_DH
			  , FNL_MDF_DH
			  , FNL_YN
			  , ACCN_INSP_CD
			  , REF_DOC_ID
			  , NOP_SUM
			  , HD_AUD_STEP_CD	
			  , HD_DOC_ID	
			  , HD_APVR_CD	
			  , HD_AFF_SNO	
			  , HD_DSP_RQ_SNO
			  , KYWD1
			  , KYWD2
			  , KYWD3
			  , KYWD4
			  , KYWD5)
		( SELECT AA.AUD_YR
			  , AA.AUD_NO
			  , 'A1070'
			  , AA.DOC_ID
			  , #{targetApvrCd}
			  , AA.AFF_SNO
			  , AA.DSP_RQ_SNO
			  , AA.DSP_RQ_SNO
			  , AA.AUD_KND_CD
			  , AA.AUD_GRN_NO
			  , AA.RPRT_FILD_ID
			  , AA.AFF_DSP_CD
			  , AA.RLTN_ORG_CD
			  , AA.HND_ORG_CD
			  , AA.REF_ORG_CD
			  , AA.DSP_RQ_CD
			  , AA.MTRL_IPT_DVSN_CD
			  , AA.NOP_AM_DVSN_CD
			  , AA.NOP_AM
			  , AA.SORT_SNO
			  , #{usrId}
			  , #{usrId}
			  , #{dptCd}
			  , #{mnuId}
			  , SYSDATE
			  , SYSDATE
			  , AA.FNL_YN
			  , AA.ACCN_INSP_CD
			  , #{copyAudRptId}
			  , AA.NOP_SUM
			  , AA.HD_AUD_STEP_CD	
			  , AA.HD_DOC_ID	
			  , AA.HD_APVR_CD	
			  , AA.HD_AFF_SNO	
			  , AA.HD_DSP_RQ_SNO
			  , AA.KYWD1
			  , AA.KYWD2
			  , AA.KYWD3
			  , AA.KYWD4
			  , AA.KYWD5
	      FROM TBBADDED146M AA
	         , TBBADDED145M CC
	 	 WHERE AA.DOC_ID = #{refId} 
	   	   AND AA.APVR_CD = #{apvrCd}
           AND AA.AUD_YR = CC.AUD_YR
           AND AA.AUD_NO = CC.AUD_NO
           AND AA.DOC_ID = CC.DOC_ID
           AND AA.APVR_CD = CC.APVR_CD
           AND AA.AFF_SNO = CC.AFF_SNO
           AND NOT EXISTS (
                           SELECT 1 
                             FROM TBBADDED147M ZZ
				     INNER JOIN TBBADDED148M YY
				                ON ZZ.AUD_YR 			= YY.AUD_YR
							  AND ZZ.AUD_NO 		= YY.AUD_NO
							  AND ZZ.AUD_STEP_CD 	= YY.AUD_STEP_CD
							  AND ZZ.DOC_ID 			= YY.DOC_ID
							  AND ZZ.APVR_CD 		= YY.APVR_CD
							  AND ZZ.AFF_SNO 		= YY.AFF_SNO
							  AND ZZ.DSP_RQ_SNO 	= YY.DSP_RQ_SNO
							  AND ZZ.MPP_SEQ 		= YY.MPP_SEQ    
                            WHERE ZZ.AUD_YR = AA.AUD_YR
                              AND ZZ.AUD_NO = AA.AUD_NO
                              AND ZZ.DOC_ID 	= AA.DOC_ID
                              AND ZZ.PRE_AFF_NO = F_MNG_KND_AUDYRNO(AA.AUD_YR, AA.AUD_NO, AA.AUD_KND_CD, '-') || '-' || CC.AFF_CD || '-' || AA.AFF_DSP_CD
                              AND ZZ.APVR_CD = #{targetApvrCd}
                              
                              AND YY.AFF_MPP_DVSN_CD IN ( 'D90', 'D70', 'D80', 'D99' )
                          ) )
                          ;
                      END;
    </insert>
    
    <insert id="AEPAFU001InsertCmtrMppDataByAudRprt" parameterType="paramMap">
   DECLARE
    	BEGIN
    		INSERT INTO TBBADDED147H (
    			HST_DVSN_CD
			  , HST_SNO
			  , HST_DH
			  , HST_USR_ID	
    		  , AUD_YR		
			  , AUD_NO		
			  , AUD_STEP_CD	
			  , APVR_CD		
			  , AUD_KND_CD	
			  , AUD_GRN_NO	
			  , DOC_ID		
			  , RPRT_FILD_ID
			  , PRE_AFF_NO	
			  , AFF_NO		
			  , AFF_SNO		
			  , DSP_RQ_SNO	
			  , MPP_SEQ	
			  , SORT_SNO	
			  , FRT_USR_ID	
			  , FNL_USR_ID	
			  , FNL_DEAL_DPT_CD
			  , FNL_MNU_ID	
			  , FRT_REGI_DH	
			  , FNL_MDF_DH)
			SELECT  'C'
				  , TBBADDED147H_SEQ.NEXTVAL
				  , SYSDATE
				  , #{usrId}
	    		  , AUD_YR		
				  , AUD_NO		
				  , 'A1070' 
				  , #{targetApvrCd}
				  , AUD_KND_CD	
				  , AUD_GRN_NO	
				  , DOC_ID		
				  , RPRT_FILD_ID
				  , AFF_NO	
				  , AFF_NO		
				  , AFF_SNO		
				  , DSP_RQ_SNO	
				  , SEQ_MPP.NEXTVAL
				  , SORT_SNO	
                  , #{usrId}
                  , #{usrId}
                  , #{dptCd}
                  , #{mnuId}
                  , SYSDATE
                  , SYSDATE
		FROM( SELECT DISTINCT AA.AUD_YR 
						  , AA.AUD_NO 
						  , AA.AUD_KND_CD 
						  , MAX(AA.AUD_GRN_NO) AS AUD_GRN_NO
						  , AA.DOC_ID 
						  , MAX(AA.RPRT_FILD_ID) AS RPRT_FILD_ID
						  , AA.AFF_NO 
						  , AA.AFF_SNO 
						  , AA.DSP_RQ_SNO 
						  , MIN(AA.SORT_SNO) AS SORT_SNO 
				   FROM TBBADDED147M AA
	 LEFT OUTER JOIN TBBADDED148M BB	
		   			 ON AA.AUD_YR 		= BB.AUD_YR
					AND AA.AUD_NO 		= BB.AUD_NO
					AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
					AND AA.DOC_ID 		= BB.DOC_ID
					AND AA.APVR_CD 		= BB.APVR_CD
					AND AA.AFF_SNO 		= BB.AFF_SNO
					AND AA.DSP_RQ_SNO 	= BB.DSP_RQ_SNO
					AND AA.MPP_SEQ 		= BB.MPP_SEQ
		 	    WHERE AA.DOC_ID = #{refId} 
			   	   AND AA.APVR_CD = #{apvrCd}
			   	   AND (BB.AFF_MPP_DVSN_CD IS NULL OR BB.AFF_MPP_DVSN_CD NOT IN('D90', 'D70', 'D80', 'D99' ) )
		       GROUP BY AA.AUD_YR 
						  , AA.AUD_NO 
						  , AA.AUD_KND_CD 
						  , AA.DOC_ID 
						  , AA.AFF_NO 
						  , AA.AFF_SNO 
						  , AA.DSP_RQ_SNO )
						  ;
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001InsertCmtrMppDataByAudRprt*/
        INSERT INTO TBBADDED147M
			  ( AUD_YR		
			  , AUD_NO		
			  , AUD_STEP_CD	
			  , APVR_CD		
			  , AUD_KND_CD	
			  , AUD_GRN_NO	
			  , DOC_ID		
			  , RPRT_FILD_ID
			  , PRE_AFF_NO	
			  , AFF_NO		
			  , AFF_SNO		
			  , DSP_RQ_SNO	
			  , MPP_SEQ				  
			  , SORT_SNO	
			  , FRT_USR_ID	
			  , FNL_USR_ID	
			  , FNL_DEAL_DPT_CD
			  , FNL_MNU_ID	
			  , FRT_REGI_DH	
			  , FNL_MDF_DH)
	     ( SELECT AUD_YR 
				  , AUD_NO 
				  , 'A1070' 
				  , #{targetApvrCd}
				  , AUD_KND_CD 
				  , AUD_GRN_NO 
				  , DOC_ID 
				  , RPRT_FILD_ID 
				  , AFF_NO 
				  , AFF_NO 
				  , AFF_SNO 
				  , DSP_RQ_SNO
				  , SEQ_MPP.NEXTVAL
				  , SORT_SNO 
				  , #{usrId}
				  , #{usrId}
				  , #{dptCd}
				  , #{mnuId}
				  , SYSDATE
				  , SYSDATE
		FROM( SELECT DISTINCT AA.AUD_YR 
						  , AA.AUD_NO 
						  , AA.AUD_KND_CD 
						  , MAX(AA.AUD_GRN_NO) AS AUD_GRN_NO
						  , AA.DOC_ID 
						  , MAX(AA.RPRT_FILD_ID) AS RPRT_FILD_ID
						  , AA.AFF_NO 
						  , AA.AFF_SNO 
						  , AA.DSP_RQ_SNO 
						  , MIN(AA.SORT_SNO) AS SORT_SNO 
				   FROM TBBADDED147M AA
	 LEFT OUTER JOIN TBBADDED148M BB	
		   			 ON AA.AUD_YR 		= BB.AUD_YR
					AND AA.AUD_NO 		= BB.AUD_NO
					AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
					AND AA.DOC_ID 		= BB.DOC_ID
					AND AA.APVR_CD 		= BB.APVR_CD
					AND AA.AFF_SNO 		= BB.AFF_SNO
					AND AA.DSP_RQ_SNO 	= BB.DSP_RQ_SNO
					AND AA.MPP_SEQ 		= BB.MPP_SEQ
		 	    WHERE AA.DOC_ID = #{refId} 
			   	   AND AA.APVR_CD = #{apvrCd}
			   	   AND (BB.AFF_MPP_DVSN_CD IS NULL OR BB.AFF_MPP_DVSN_CD NOT IN('D90', 'D70', 'D80', 'D99' ) )
		       GROUP BY AA.AUD_YR 
						  , AA.AUD_NO 
						  , AA.AUD_KND_CD 
						  , AA.DOC_ID 
						  , AA.AFF_NO 
						  , AA.AFF_SNO 
						  , AA.DSP_RQ_SNO ) )
					;
				END;
    </insert>
    
    <update id="AEPAFU001UpdateAffFnlYnSetByParam" parameterType="paramMap">
    DECLARE
    	BEGIN
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001UpdateAffFnlYnSetByParam*/
        UPDATE TBBADDED145M
		   SET FNL_YN = 'Y'
		 WHERE DOC_ID = #{refId} 
		   AND APVR_CD = #{apvrCd}
		   ;
           INSERT INTO TBBADDED145H
					(
					   HST_DVSN_CD
					 , HST_SNO
					 , HST_DH
					 , HST_USR_ID	
					 , AUD_YR			
					 , AUD_NO			
					 , AUD_STEP_CD	
					 , DOC_ID			
					 , APVR_CD		
					 , AFF_SNO		
					 , AUD_KND_CD		
					 , AUD_GRN_NO		
					 , RPRT_FILD_ID	
					 , AFF_CD			
					 , LIST_NO		
					 , REFER_DVSN_CD	
					 , AFF_SPH		
					 , TITLE_NM		
					 , DP_TITLE_NM	
					 , QST_DOC_ISUE_YN
					 , QST_DOC_ISUE_DY
					 , AUDTOR			
					 , DETL_DOC_NO	
					 , MTRL_IPT_DVSN_CD
					 , SYT_TRTM_DVSN_YN
					 , SCRT_YN		
					 , SORT_SNO		
					 , TRTM_EXAMER_CNB
					 , FNL_YN			
					 , FRT_USR_ID		
					 , FNL_USR_ID		
					 , FNL_DEAL_DPT_CD
					 , FNL_MNU_ID		
					 , FRT_REGI_DH	
					 , FNL_MDF_DH		
					 , REF_DOC_ID		
					)
				SELECT 'U'
				 	 , TBBADDED145H_SEQ.NEXTVAL
				 	 , SYSDATE
				 	 , 'SYSTEM'
					 , AUD_YR			
					 , AUD_NO			
					 , AUD_STEP_CD	
					 , DOC_ID			
					 , APVR_CD		
					 , AFF_SNO		
					 , AUD_KND_CD		
					 , AUD_GRN_NO		
					 , RPRT_FILD_ID	
					 , AFF_CD			
					 , LIST_NO		
					 , REFER_DVSN_CD	
					 , AFF_SPH		
					 , TITLE_NM		
					 , DP_TITLE_NM	
					 , QST_DOC_ISUE_YN
					 , QST_DOC_ISUE_DY
					 , AUDTOR			
					 , DETL_DOC_NO	
					 , MTRL_IPT_DVSN_CD
					 , SYT_TRTM_DVSN_YN
					 , SCRT_YN		
					 , SORT_SNO		
					 , TRTM_EXAMER_CNB
					 , FNL_YN			
					 , FRT_USR_ID		
					 , FNL_USR_ID		
					 , FNL_DEAL_DPT_CD
					 , FNL_MNU_ID		
					 , FRT_REGI_DH	
					 , FNL_MDF_DH		
					 , REF_DOC_ID
				FROM TBBADDED145M
			 WHERE DOC_ID = #{refId} 
			   AND APVR_CD = #{apvrCd}
				;
		END;		   		   
    </update>
    
    
   	<update id="AEPAFU001UpdateDSpFnlYnSetByParam" parameterType="paramMap">
   	DECLARE
   		BEGIN
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001UpdateDSpFnlYnSetByParam*/
		<![CDATA[
			UPDATE TBBADDED146M
			   SET FNL_YN = 'Y'
			 WHERE DOC_ID = #{refId} 
			   AND APVR_CD = #{apvrCd}
			   ;
		INSERT INTO TBBADDED146H
				(
				    HST_DVSN_CD
				  , HST_SNO
				  , HST_DH
				  , HST_USR_ID	
				  , AUD_YR
				  , AUD_NO
				  , AUD_STEP_CD 	
				  , DOC_ID 			
				  , APVR_CD 		
				  , AFF_SNO 		
				  , DSP_RQ_SNO 		
				  , DP_DSP_RQ_SNO 	
				  , AUD_KND_CD 		
				  , AUD_GRN_NO 		
				  , RPRT_FILD_ID 	
				  , AFF_DSP_CD 		
				  , RLTN_ORG_CD 	
				  , HND_ORG_CD 		
				  , REF_ORG_CD 		
				  , DSP_RQ_CD 		
				  , MTRL_IPT_DVSN_CD
				  , NOP_AM_DVSN_CD 	
				  , NOP_AM 			
				  , SORT_SNO		
				  , ACCN_INSP_CD	
				  , FNL_YN 			
				  , FRT_USR_ID 		
				  , FNL_USR_ID 		
				  , FNL_DEAL_DPT_CD 
				  , FNL_MNU_ID 		
				  , FRT_REGI_DH		
				  , FNL_MDF_DH 		
				  , NOP_SUM 		
				  , HD_AUD_STEP_CD 	
				  , HD_DOC_ID		
				  , HD_APVR_CD		
				  , HD_AFF_SNO 		
				  , HD_DSP_RQ_SNO	
				  , REF_DOC_ID 		
				  , DF_AUD_STEP_CD 	
				  , DF_DOC_ID 		
				  , DF_APVR_CD 		
				  , DF_AFF_SNO		
				  , DF_DSP_RQ_SNO 	
				  , KYWD1			
				  , KYWD2 			
				  , KYWD3 			
				  , KYWD4			
				  , KYWD5			
				)
			SELECT 'U'
			 	 , TBBADDED146H_SEQ.NEXTVAL
			 	 , SYSDATE
			 	 , 'SYSTEM'
				 , AUD_YR
				 , AUD_NO
				 , AUD_STEP_CD 	
				 , DOC_ID 			
				 , APVR_CD 		
				 , AFF_SNO 		
				 , DSP_RQ_SNO 		
				 , DP_DSP_RQ_SNO 	
				 , AUD_KND_CD 		
				 , AUD_GRN_NO 		
				 , RPRT_FILD_ID 	
				 , AFF_DSP_CD 		
				 , RLTN_ORG_CD 	
				 , HND_ORG_CD 		
				 , REF_ORG_CD 		
				 , DSP_RQ_CD 		
				 , MTRL_IPT_DVSN_CD
				 , NOP_AM_DVSN_CD 	
				 , NOP_AM 			
				 , SORT_SNO		
				 , ACCN_INSP_CD	
				 , FNL_YN 			
				 , FRT_USR_ID 		
				 , FNL_USR_ID 		
				 , FNL_DEAL_DPT_CD 
				 , FNL_MNU_ID 		
				 , FRT_REGI_DH		
				 , FNL_MDF_DH 		
				 , NOP_SUM 		
				 , HD_AUD_STEP_CD 	
				 , HD_DOC_ID		
				 , HD_APVR_CD		
				 , HD_AFF_SNO 		
				 , HD_DSP_RQ_SNO	
				 , REF_DOC_ID 		
				 , DF_AUD_STEP_CD 	
				 , DF_DOC_ID 		
				 , DF_APVR_CD 		
				 , DF_AFF_SNO		
				 , DF_DSP_RQ_SNO 	
				 , KYWD1			
				 , KYWD2 			
				 , KYWD3 			
				 , KYWD4			
				 , KYWD5
			 FROM TBBADDED146M
			 WHERE DOC_ID = #{refId} 
			   AND APVR_CD = #{apvrCd}
				;
		END;						   
		]]>
	</update>
	
	
	<select id="AEPAFU001GetAudRprtDvsnCd" parameterType="paramMap" resultType="string">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001GetAudRprtDvsnCd*/
		SELECT MIN(AUD_RPRT_DVSN_CD) AS AUD_RPRT_DVSN_CD
		  FROM TBBADDED103M T1
		 WHERE T1.RPRT_CD = 'A10600200'
		   AND T1.DOC_ID = #{refId} 
    </select>
    
    
    <update id="AEPAFU001UpdatehndlPrdMngDt" parameterType="paramMap">
    /*kr.go.bai.eip.aep.rla.dao.AEPARP014PMapper.AEPAFU001UpdatehndlPrdMngDt*/
        UPDATE TBBADDED003M
           SET FNL_USR_ID = #{usrId}
             , FNL_DEAL_DPT_CD = #{dptCd} 
             , FNL_MNU_ID = #{mnuId} 
             , FNL_MDF_DH = SYSDATE
         <if test="rtnRptDt != null and rtnRptDt != ''">
             , RTN_RPT_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
         </if>
         <if test="audBrdvApvDt != null and audBrdvApvDt != ''">
             , AUD_BRDV_APV_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
         </if>
         <if test="jaJdgSsecApvDt != null and jaJdgSsecApvDt != ''">
             , JA_JDG_SSEC_APV_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
         </if>
         <if test="owDhdApvDt != null and owDhdApvDt != ''">
             , OW_DHD_APV_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
         </if>
         <if test="owPsdApvDt != null and owPsdApvDt != ''">
             , OW_PSD_APV_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
         </if>
         <if test="chfCmtrApvDt != null and chfCmtrApvDt != ''">
             , CHF_CMTR_APV_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
         </if>
		 <if test="audEndRsn != null and audEndRsn != '' ">
		 	,  AUD_END_RSN = #{audEndRsn}        
         </if>
         WHERE AUD_YR = #{audYr}
           AND AUD_NO = #{audNo}
    </update>
    
    
    <insert id="insertApvDoc" parameterType="paramMap">
        /* kr.go.bai.eip.aep.arp.dao.AEPARP014PMapper.insertApvDoc */
        <![CDATA[
            INSERT INTO TBBADDED109M (
                APV_RQS_ID
                , AUD_YR
                , AUD_NO
                , AUD_STEP_CD
                , DOC_ID
                , APV_DVSN_CD
                , APV_DOC_DVSN_CD
                , SORT_SNO
                , FRT_USR_ID
                , FNL_USR_ID
                , FNL_DEAL_DPT_CD
                , FNL_MNU_ID
                , FRT_REGI_DH
                , FNL_MDF_DH
            ) VALUES (
                #{apvDocNo}
                , #{audYr}
                , #{audNo}
                , SUBSTRING(#{rprtCd},1,5)
                , #{docId}
                , ''
                , '10'
                , 1
                , #{usrId}
                , #{usrId}
                , #{dptCd}
                , #{mnuId}
                , SYSDATE
                , SYSDATE
            )
        ]]>
    </insert>
</mapper> 
