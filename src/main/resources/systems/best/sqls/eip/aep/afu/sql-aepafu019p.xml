<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.afu.dao.AEPAFU019PMapper">

	<select id="selectIclsData" parameterType="paramMap" resultType="egovMap">
	/*kr.go.bai.eip.aep.afu.dao.AEPAFU019PMapper.selectIclsData*/
		SELECT A.AUD_KND_NM || A.REQ_DVSN_NM AS AUD_KND_DVSN_NM
			   , A.AUD_KND_CD 					/*감사종류코드*/
		 	   , A.REQ_DVSN_CD					/*청구구분코드*/
		       , A.RULE_SRNO						/*규정순번*/
		       , A.COL_1								/*실지감사종료보고*/
		       , A.COL_2								/*과장*/
		       , A.COL_5								/*국장*/
		       , A.COL_6								/*차장*/
		       , A.COL_7								/*총장*/
		       , A.COL_8								/*주심위원*/
		       , A.COL_9								/*시행*/
		       , A.AUD_HNDL_STEP_SNO
		       , A.SAT_ICLS
		       , A.SNDY_ICLS
		       , A.HLDY_ICLS
		       , A.TMP_HLDY_ICLS
		       , A.SBST_HLDY_ICLS
			   , B.EXTN_SAT_ICLS				/*토요일포함*/
			   , B.EXTN_SNDY_ICLS				/*일요일포함*/
			   , B.EXTN_HLDY_ICLS				/*공휴일포함*/
			   , B.EXTN_TMP_HLDY_ICLS		/*임시휴일포함*/
			   , B.EXTN_SBST_HLDY_ICLS		/*대체공휴일포함*/     
		 FROM	   
			   (SELECT CD_NM AS AUD_KND_NM
			   		 , CASE WHEN REQ_DVSN_CD = 0 THEN '(일반)'
							    WHEN REQ_DVSN_CD = 2 THEN '(국민)'
							    WHEN REQ_DVSN_CD = 3 THEN '(공익)'
							    WHEN REQ_DVSN_CD = 4 THEN '(국회)'
							END AS REQ_DVSN_NM
			   		 , AUD_KND_CD 										/*감사종류코드*/
				 	 , REQ_DVSN_CD										/*청구구분코드*/
				     , RULE_SRNO											/*규정순번*/
				     , MAX(COL_1) AS COL_1								/*실지감사종료보고*/
				     , MAX(COL_2) AS COL_2								/*과장*/
				     , MAX(COL_5) AS COL_5								/*국장*/
				     , MAX(COL_6) AS COL_6								/*차장*/
				     , MAX(COL_7) AS COL_7								/*총장*/
				     , MAX(COL_8) AS COL_8								/*주심위원*/
				     , MAX(COL_9) AS COL_9								/*시행*/
				     , LISTAGG(AUD_HNDL_STEP_SNO, '|') WITHIN GROUP (ORDER BY AUD_HNDL_STEP_SNO) AS AUD_HNDL_STEP_SNO
				     , LISTAGG(SAT_ICLS, '|') WITHIN GROUP (ORDER BY AUD_HNDL_STEP_SNO) SAT_ICLS
				     , LISTAGG(SNDY_ICLS, '|') WITHIN GROUP (ORDER BY AUD_HNDL_STEP_SNO) SNDY_ICLS
				     , LISTAGG(HLDY_ICLS, '|') WITHIN GROUP (ORDER BY AUD_HNDL_STEP_SNO) HLDY_ICLS
				     , LISTAGG(TMP_HLDY_ICLS, '|') WITHIN GROUP (ORDER BY AUD_HNDL_STEP_SNO) TMP_HLDY_ICLS
				     , LISTAGG(SBST_HLDY_ICLS, '|') WITHIN GROUP (ORDER BY AUD_HNDL_STEP_SNO) SBST_HLDY_ICLS
				  FROM (
						SELECT A.AUD_KND_CD
								 , A.REQ_DVSN_CD													/*감사종류코드*/
								 , A.AUD_HNDL_STEP_SNO											/*감사처리단계순번*/
								 , A.RULE_SRNO														/*규정순번*/
								 , DECODE(A.AUD_HNDL_STEP_SNO, 1, DDLN_DCN, NULL) COL_1			/*실지감사종료보고*/
								 , DECODE(A.AUD_HNDL_STEP_SNO, 2, DDLN_DCN, NULL) COL_2			/*과장*/
								 , DECODE(A.AUD_HNDL_STEP_SNO, 5, DDLN_DCN, NULL) COL_5			/*국장*/
								 , DECODE(A.AUD_HNDL_STEP_SNO, 6, DDLN_DCN, NULL) COL_6			/*차장*/
								 , DECODE(A.AUD_HNDL_STEP_SNO, 7, DDLN_DCN, NULL) COL_7			/*총장*/
								 , DECODE(A.AUD_HNDL_STEP_SNO, 8, DDLN_DCN, NULL) COL_8			/*주심위원*/
								 , DECODE(A.AUD_HNDL_STEP_SNO, 9, DDLN_DCN, NULL) COL_9			/*시행*/
								 , A.SAT_ICLS					/*토요일포함*/
								 , A.SNDY_ICLS					/*일요일포함*/
								 , A.HLDY_ICLS					/*공휴일포함*/
								 , A.TMP_HLDY_ICLS			/*임시휴일포함*/
								 , A.SBST_HLDY_ICLS			/*대체공휴일포함*/
                                 , C.CD_NM
						 FROM TBBADDED024B  A
                         INNER JOIN TBDCMACM013C C
				                 ON C.CMM_CD_DVSN_CD = '1000739'
				                AND C.CD = TO_CHAR(SYSDATE, 'YY')||A.AUD_KND_CD
						WHERE 1=1   
						  AND RULE_SRNO = #{ruleSrno}
						)
				  GROUP BY AUD_KND_CD, REQ_DVSN_CD, RULE_SRNO, CD_NM) A
				INNER JOIN TBBADDED025B B 
				        ON A.RULE_SRNO = B.RULE_SRNO  
			           AND A.AUD_KND_CD = B.AUD_KND_CD
		               AND A.REQ_DVSN_CD = B.REQ_DVSN_CD  
		 ORDER BY RULE_SRNO
				 , CASE WHEN AUD_KND_CD = 1 THEN 1
					    WHEN AUD_KND_CD = 2 THEN 3
					    WHEN AUD_KND_CD = 3 THEN 4
					    WHEN AUD_KND_CD = 4 THEN 2
		   			END
	 			 , REQ_DVSN_CD 
    </select>
    
   <update id="updateHndlDdlnDetailList" parameterType="paramMap">
   /*kr.go.bai.eip.aep.afu.dao.AEPAFU019PMapper.updateHndlDdlnDetailList*/
		UPDATE TBBADDED024B
		  	 SET DDLN_DCN 		= #{ddlnDcn}
			 	, SAT_ICLS 			= #{satIcls}
			 	, SNDY_ICLS 			= #{sndyIcls}
			 	, HLDY_ICLS 			= #{hldyIcls}
			 	, TMP_HLDY_ICLS 	= #{tmpHldyIcls}
			 	, SBST_HLDY_ICLS 	= #{sbstHldyIcls}
			 	, FNL_USR_ID			= #{fnlUsrId}
			 	, FNL_DEAL_DPT_CD	= #{fnlDealDptCd}
			 	, FNL_MNU_ID		= #{fnlMnuId}
			 	, FNL_MDF_DH 		= SYSDATE
		 WHERE RULE_SRNO = #{ruleSrno}
		    AND AUD_KND_CD = #{audKndCd}
		    AND REQ_DVSN_CD = #{reqDvsnCd}
		    AND AUD_HNDL_STEP_SNO = #{audHndlStepSno} 
    </update>
    
   <update id="updateHndlDdlnExList" parameterType="paramMap">
   /*kr.go.bai.eip.aep.afu.dao.AEPAFU019PMapper.updateHndlDdlnExList*/
		   UPDATE TBBADDED025B
		   		SET EXTN_SAT_ICLS 		= #{extnSatIcls}
			 	  , EXTN_SNDY_ICLS 		= #{extnSndyIcls}
			 	  , EXTN_HLDY_ICLS 		= #{extnHldyIcls}
			 	  , EXTN_TMP_HLDY_ICLS 	= #{extnTmpHldyIcls}
			 	  , EXTN_SBST_HLDY_ICLS 	= #{extnSbstHldyIcls}
			 	  , FNL_USR_ID			= #{fnlUsrId}
			 	  , FNL_DEAL_DPT_CD	= #{fnlDealDptCd}
			 	  , FNL_MNU_ID			= #{fnlMnuId}
			 	  , FNL_MDF_DH 		= SYSDATE
		 WHERE RULE_SRNO = #{ruleSrno}
		    AND AUD_KND_CD = #{audKndCd}
		    AND REQ_DVSN_CD = #{reqDvsnCd}
    </update>    
    
</mapper> 