<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.mar.dao.AEPMAR005PMapper">
		<select id="selectMajorAudDocMngDetail" parameterType="paramMap" resultType="egovMap">
		/*kr.go.bai.eip.aep.mar.dao.AEPMAR005PMapper.selectMajorAudDocMngDetail*/
			<![CDATA[		
				SELECT F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, B.AUD_KND_CD, '-') AS AUD_YR_NO
						, C.AUD_SBJ_NM
						, F_ORG_INFO(C.AUD_RPST_ORG_CD, '1') AS AUD_RPST_ORG_NM
					 	, F_DPT_INFO(C.MNG_DPT_CD,'1') 	AS MNG_DPT_NM
						, F_CODE_NM('1000786',B.RPRT_CD) 	AS AUD_DOC_NM
						, B.RPRT_NM
						, F_DPT_INFO((SELECT DPT_CD FROM TBDCMACM001M WHERE USR_ID = A.RQS_ID),'1') AS REQ_DPT_NM	
						, F_USR_INFO_BY_ID(A.RQS_ID,'2') 	AS REQ_NM							
					 	, CASE WHEN A.READ_ST_DH IS NOT NULL AND A.READ_END_DH IS NOT NULL THEN TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || ' ~ ' || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
						   	   ELSE TO_CHAR(A.READ_ST_DH,'YYYY.MM.DD') || TO_CHAR(A.READ_END_DH,'YYYY.MM.DD')
					       END AS READ_DH
						, CASE WHEN A.PRSS_CD = '10' THEN '승인대기'
						  	   WHEN A.PRSS_CD = '20' THEN '취소'
						  	   WHEN A.PRSS_CD = '30' THEN '승인'
						  	   WHEN A.PRSS_CD = '40' THEN '반려'
						   END AS PRSS_NM
						, A.RET_RSN
						, A.SRNO
					    , A.PRSS_CD
					    , A.REF_DOC_ID
					    , A.DOC_ID
					    , A.RQS_ID
					    , A.APV_STA_CD
					    , (SELECT DPT_CD FROM TBDCMACM001M WHERE USR_ID = A.RQS_ID) AS REQ_DPT_CD
					 	, TO_CHAR(A.READ_ST_DH,'YYYYMMDD') 		AS READ_ST_DH
					 	, TO_CHAR(A.READ_END_DH,'YYYYMMDD') 	AS READ_END_DH
					    , A.AUD_YR
					    , A.AUD_NO
						, B.RPRT_CD
						, A.RET_RSN
						, A.RQS_REGI_DT
						, (CASE WHEN B.LINK_URL IS NULL             THEN ''
						      	  WHEN INSTR(B.LINK_URL,'hancom') = 0 THEN 'polaris' 
						      	  ELSE 'hancom' 
						   END ) AS DOC_TYPE
				      FROM TBAEPMAR001M A 
			   INNER JOIN TBBADDED001M C 
						ON A.AUD_YR = C.AUD_YR 
					   AND A.AUD_NO = C.AUD_NO
		LEFT OUTER JOIN TBBADDED103M B
						ON A.AUD_YR = B.AUD_YR 
					   AND A.AUD_NO = B.AUD_NO
					   AND A.REF_DOC_ID = B.DOC_ID
					   AND A.AUD_STEP_CD = B.AUD_STEP_CD	   
				    WHERE 1=1
		               AND C.AUD_YR  = #{schAudYr}
		               AND C.AUD_NO = #{schAudNo}
		               AND A.REF_DOC_ID  = #{schDocId}
		               AND A.SRNO = #{schSrno}
		    ]]>
	</select>

	<update id="saveMajorAudDocReadConfirm">
			/*kr.go.bai.eip.aep.mar.dao.AEPMAR005PMapper.saveMajorAudDocReadConfirm*/
		   	UPDATE TBAEPMAR001M
		   		 SET READ_ST_DH	= #{startDate}
					, READ_END_DH	= #{endDate}
					, DOC_ID 			= #{cDocId}
					, APV_STA_CD	= '10'	/*작성중*/
					, FRT_USR_ID 	= #{usrId}
					, FRT_REGI_DH 	= SYSDATE
					, FNL_USR_ID		= #{usrId}
					, FNL_DEAL_DPT_CD	 = #{dptCd}
					, FNL_MNU_ID	= #{currentMenuId}
					, FNL_MDF_DH 	= SYSDATE
		   	  WHERE SRNO 	= #{srno}
		   		AND AUD_YR 	= #{audYr}
		        AND AUD_NO 	= #{audNo}
	</update>

    <insert id="insertCopyMajorAudDocRead" parameterType="paramMap">
        /*kr.go.bai.eip.aep.mar.dao.AEPMAR005PMapper.insertCopyMajorAudDocRead*/
        <![CDATA[
            INSERT INTO TBBADDED103M (
                 AUD_YR
                ,AUD_NO
                ,AUD_STEP_CD
                ,DOC_ID
                ,AUD_KND_CD
                ,AUD_GRN_NO
                ,RPRT_NM
                ,LINK_URL
                ,NECES_YN
                ,APV_STA_CD
                ,RPRT_CD
                ,REF_ID
                ,SYT_TRTM_DVSN_YN
                ,AUD_DOC_KND_CD
                ,CON_PGM_CD
                ,APV_WAY_CD
                ,DOC_WRT_ID
                ,ONR_HNDL_NO
                ,FRT_USR_ID
                ,FNL_USR_ID
                ,FNL_DEAL_DPT_CD
                ,FNL_MNU_ID
                ,FRT_REGI_DH
                ,FNL_MDF_DH
                ,EDT_AUTH
                ,SECU_RPT_YN
                ,TEMPLATE_DOC_ID
                )
           (SELECT 
	                 AUD_YR
	                ,AUD_NO
	                ,AUD_STEP_CD
	                ,#{cDocId}
	                ,AUD_KND_CD
	                ,AUD_GRN_NO
	                ,RPRT_NM
	                ,REPLACE(REPLACE(LINK_URL,'edit=Y','edit=N'),'docId='||DOC_ID,'docId='||#{cDocId})
	                ,NECES_YN
	                ,'10'		/*작성중*/
	                ,RPRT_CD
	                ,REF_ID
	                ,SYT_TRTM_DVSN_YN
	                ,AUD_DOC_KND_CD
	                ,CON_PGM_CD
	                ,APV_WAY_CD
	                ,#{usrId}
	                ,ONR_HNDL_NO
	                ,#{usrId}
	                ,#{usrId}
	                ,#{dptCd}
	                ,#{currentMenuId}
	                ,SYSDATE
	                ,SYSDATE
	                ,EDT_AUTH
	                ,SECU_RPT_YN
	                ,TEMPLATE_DOC_ID
              FROM TBBADDED103M
             WHERE AUD_YR       = #{audYr}
               AND AUD_NO       = #{audNo}
               AND DOC_ID       = #{docId}
             )
        ]]>
    </insert>
	
	<update id="saveMajorAudDocReadReturn">
			/*kr.go.bai.eip.aep.mar.dao.AEPMAR005PMapper.saveMajorAudDocReadReturn*/
		   	UPDATE TBAEPMAR001M
		   		 SET PRSS_CD = '40'
					, RET_RSN		= #{retRsn}
					, FRT_USR_ID 	= #{usrId}			
					, FNL_USR_ID		= #{usrId}
					, FNL_DEAL_DPT_CD	= #{dptCd}
					, FNL_MNU_ID	= #{currentMenuId}
					, FRT_REGI_DH	= SYSDATE
					, FNL_MDF_DH 	= SYSDATE
		   	  WHERE SRNO 	= #{srno}
		   		AND AUD_YR 	= #{audYr}
		        AND AUD_NO 	= #{audNo}
	</update>	
	
	<update id="saveMajorAudDocReadModify">
			/*kr.go.bai.eip.aep.mar.dao.AEPMAR005PMapper.saveMajorAudDocReadModify*/
			<![CDATA[				
		   	UPDATE TBAEPMAR001M
		   		 SET 
		   	]]>
		           	<if test="startDate != null and startDate != ''">
		              	READ_ST_DH	= #{startDate},
		           	</if>		 
		           	<if test="endDate != null and endDate != ''">  	
						READ_END_DH	= #{endDate},
					</if>	
					<if test="retRsn != null and retRsn != ''">
						RET_RSN		= #{retRsn},
					</if>	
			<![CDATA[		 
					 FNL_USR_ID		= #{usrId},
					 FNL_DEAL_DPT_CD	= #{dptCd},
					 FNL_MNU_ID	= #{currentMenuId},
					 FNL_MDF_DH 	= SYSDATE
		   	  WHERE SRNO 	= #{srno}
		   		AND AUD_YR 	= #{audYr}
		        AND AUD_NO 	= #{audNo}
		    ]]>
	</update>		
</mapper> 