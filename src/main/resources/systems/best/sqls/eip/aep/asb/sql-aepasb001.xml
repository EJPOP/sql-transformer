<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper">

    <insert id="insertTrtmData">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.insertSbcnData */
        <![CDATA[
        INSERT INTO TBBADDED112M(
                                AUD_YR,
                                 AUD_NO,
                                 AUD_KND_CD,
                                 AUD_GRN_NO,
                                 AUD_SBJ_NM,
                                 SBCN_TRTM_REQ_DT,
                                 SHARE_YN,
                                 FRT_USR_ID,
                                 FNL_USR_ID,
                                 FNL_DEAL_DPT_CD,
                                 FNL_MNU_ID,
                                 FRT_REGI_DH,
                                 FNL_MDF_DH)
                          VALUES(#{audYr},
                                 #{audNo},
                                 #{audKndCd},
                                 (SELECT AUD_GRN_NO FROM TBBADDED001M
                                    WHERE
                                        AUD_YR = #{audYr}
                                    AND AUD_NO = #{audNo}),
                                 (SELECT AUD_SBJ_NM FROM TBBADDED001M
                                    WHERE
                                        AUD_YR = #{audYr}
                                    AND AUD_NO = #{audNo}),
                                 TO_CHAR(SYSDATE,'YYYYMMDD'),
                                 'N',
                                 #{usrId},
                                 #{usrId},
                                 #{dptCd},
                                 'AEPASB001E',
                                 SYSDATE,
                                 SYSDATE)
        ]]>
    </insert>
    
    <select id="selectTrtmList" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectTrtmList */
        <![CDATA[
            SELECT 
                    F_MNG_KND_AUDYRNO(AUD_YR, AUD_NO, AUD_KND_CD, '-') AS AUD_YR_NO
                   ,AUD_SBJ_NM
                   ,F_CODE_NM('1000007', AUD_KND_CD) AS AUD_KND_NM
                   ,(SELECT F_DPT_INFO(MNG_DPT_CD,'1')
                    FROM TBBADDED001M 
                    WHERE
                        AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo})        AS MNG_DPT_NM
                   ,(SELECT DECODE(CHF_CMTR_CNB, NULL, '', F_USR_INFO(ST1.CHF_CMTR_CNB, '2')||DECODE(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1), 0, '', ' 외 ' || TO_CHAR(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1))) )
                      FROM TBBADDED116L ST1
                     WHERE ST1.AUD_YR = #{audYr} AND ST1.AUD_NO = #{audNo} AND ST1.TASK_DVSN_CD = '9'
                      AND ST1.DOC_ID = (SELECT DOC_ID
                                                      FROM (SELECT SST1.DOC_ID 
                                                              FROM TBBADDED103M SST1 
                                                             WHERE SST1.AUD_YR = #{audYr} AND SST1.AUD_NO = #{audNo} 
                                                               AND SST1.RPRT_CD = 'A10600200' AND NVL(SST1.FNL_BAI_RPRT_YN,'N') = 'N' 
                                                               AND EXISTS (SELECT 'O' FROM TBBADDED116L WHERE AUD_YR = SST1.AUD_YR AND AUD_NO = SST1.AUD_NO AND TASK_DVSN_CD = '9')
                                                               ORDER BY SST1.AUD_RPRT_DVSN_CD)
                                                     WHERE ROWNUM = 1)
                       AND ST1.SRNO = (SELECT MAX(SRNO) FROM TBBADDED116L WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND TASK_DVSN_CD = '9' AND DOC_ID = ST1.DOC_ID)) AS CHF_CMTR_NM
                   ,(SELECT CHF_CMTR_CNB AS CHF_CMTR_ID
                      FROM TBBADDED116L ST1
                     WHERE ST1.AUD_YR = #{audYr} AND ST1.AUD_NO = #{audNo} AND ST1.TASK_DVSN_CD = '9'
                      AND ST1.DOC_ID = (SELECT DOC_ID
                                                      FROM (SELECT SST1.DOC_ID 
                                                              FROM TBBADDED103M SST1 
                                                             WHERE SST1.AUD_YR = #{audYr} AND SST1.AUD_NO = #{audNo} 
                                                               AND SST1.RPRT_CD = 'A10600200' AND NVL(SST1.FNL_BAI_RPRT_YN,'N') = 'N' 
                                                               AND EXISTS (SELECT 'O' FROM TBBADDED116L WHERE AUD_YR = SST1.AUD_YR AND AUD_NO = SST1.AUD_NO AND TASK_DVSN_CD = '9')
                                                               ORDER BY SST1.AUD_RPRT_DVSN_CD)
                                                     WHERE ROWNUM = 1)
                       AND ST1.SRNO = (SELECT MAX(SRNO) FROM TBBADDED116L WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND TASK_DVSN_CD = '9' AND DOC_ID = ST1.DOC_ID)) AS CHF_CMTR_ID
                   ,(SELECT COUNT(1)
                    FROM 
                        TBBADDED145M
                        JOIN
                        TBBADDED146M
                        USING(AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID, APVR_CD, AFF_SNO)
                    WHERE 
                        AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND AUD_STEP_CD = 'A1070'
                    AND APVR_CD = '0010600'
                    AND REFER_DVSN_CD = 'D10') AS TOT_SBCN_CNT  /* 전체부의건수 */
                    ,(SELECT COUNT(1)
                    FROM 
                        TBBADDED145M
                        JOIN
                        TBBADDED146M
                        USING(AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID, APVR_CD, AFF_SNO)
                    WHERE 
                        AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND AUD_STEP_CD = 'A1070'
                    AND APVR_CD = '0010600'
                    AND REFER_DVSN_CD = 'E10') AS TOT_DLG_CNT  /* 전체위임건수 */
                    ,(SELECT COUNT(1)
                    FROM 
                        TBBADDED113M
                    WHERE 
                        AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND SBCN_VT_CD IS NOT NULL) AS HNDL_SBCN_CNT  /* 부의 처리건수 */
                    ,(SELECT COUNT(1)
                    FROM 
                        TBBADDED145M
                        JOIN
                        TBBADDED146M
                        USING(AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID, APVR_CD, AFF_SNO)
                    WHERE 
                        AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND AUD_STEP_CD = 'A1070'
                    AND APVR_CD = '0010600' /* 주심위원 결재코드 확인 필요 */
                    AND REFER_DVSN_CD = 'E10') AS HNDL_DLG_CNT  /* 위임 처리건수 */
                    , (SELECT SEC_AUD_YN FROM TBBADDED001M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo}) AS SEC_AUD_YN
            FROM TBBADDED112M
            WHERE 
                AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
        ]]>
    </select>
    
    <select id="selectNewTrtmDtlList" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectNewTrtmDtlList */
        <![CDATA[
            SELECT DISTINCT T1.AUD_YR, T1.AUD_NO, T1.DOC_ID
            FROM
                TBBADDED103M T1
                JOIN 
                TBBADDED145M T2
                ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO AND T1.AUD_STEP_CD = T2.AUD_STEP_CD AND T1.DOC_ID = T2.DOC_ID)
            WHERE
                T1.AUD_YR = #{audYr}
            AND T1.AUD_NO = #{audNo}
            AND T2.APVR_CD = '0055700'  /*총장결재 사건*/
            AND T1.APV_STA_CD = '30' /*결재완료*/
            AND T1.DOC_ID NOT IN (SELECT DOC_ID FROM TBBADDED112D WHERE AUD_YR = T1.AUD_YR AND AUD_NO = T1.AUD_NO)
        ]]>
    </select>
    
    <select id="chkAudRprtCnt" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.chkAudRprtCnt */
        <![CDATA[
            SELECT 
                COUNT(1) AS AUD_RPRT_CNT
            FROM (
                SELECT DISTINCT AUD_YR, AUD_NO, DOC_ID
                FROM
                    TBBADDED103M T1
                    JOIN 
                    TBBADDED145M T2
                    USING(AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID)
                    JOIN
                    TBDCMACM023L T3
                    ON (T1.APV_RQS_ID = T3.APV_DOC_NO 
                        AND SUBSTR(T3.APVR_STA_CD,-1) = '3') /* 승인완료 */
                WHERE
                    AUD_YR = #{audYr}
                AND AUD_NO = #{audNo}
                AND T1.APV_STA_CD = '30'
                AND RPRT_CD = 'A10600200'
            )
        ]]>
    </select>
    
    <select id="selectTrtmDtlList" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectTrtmDtlList */
        <![CDATA[
            SELECT T1.AUD_YR, T1.AUD_NO, T4.RPRT_NM, T4.DOC_ID, T1.SBCN_TRTM_DTL_SNO, 
                T6.PSD_APV_DY AS PSD_APV_DY,
                COUNT(DECODE(REFER_DVSN_CD,'D10',DECODE(T2.APVR_CD,'0055700',1))) AS TOT_DSVN_CNT, 
                COUNT(DECODE(REFER_DVSN_CD,'E10',DECODE(T2.APVR_CD,'0055700',1))) AS TOT_DLG_CNT,
                (SELECT TO_CHAR(MAX(APV_DH),'YYYY"-"MM"-"DD') /* 주심위원 결재일자 : 주심위원 설명자료 결재일자 */
                FROM TBDCMACM023L ST1 JOIN TBBADDED103M ST2 ON (ST1.APV_DOC_NO = ST2.APV_RQS_ID)
                WHERE 
                    ST2.AUD_YR = T1.AUD_YR
                AND ST2.AUD_NO = T1.AUD_NO
                AND ST2.AUD_STEP_CD = 'A1070'
                AND ST2.RPRT_CD = 'A10700100'
                AND ST2.REF_ID = T1.DOC_ID
                AND ST1.APVR_PST_CD = '0010600'
                AND ST2.APV_STA_CD = '30') AS CHF_APV_DY,
                COUNT(DECODE(REFER_DVSN_CD,'D10',DECODE(T2.APVR_CD,'0010600',1))) AS HNDL_DSVN_CNT,
                COUNT(DECODE(REFER_DVSN_CD,'E10',DECODE(T2.APVR_CD,'0010600',1))) AS HNDL_DLG_CNT,
                CASE 
                    WHEN MIN(SBCN_DY) IS NULL THEN ''
                    ELSE TO_CHAR(TO_DATE(MIN(NVL(SBCN_DY,'99991231'))),'YYYY"-"MM"-"DD')
                END  AS SBCN_DY,
                COUNT(DECODE(SBCN_VT_CD ,'10',1,'20',1,'30',1)) AS VT_CNT,
                COUNT(DECODE(SBCN_VT_CD ,'50',1)) AS UNW_CNT,
                COUNT(DECODE(SBCN_VT_CD ,'90',1)) AS DF_CNT,
                RPRT_CD,
                T4.AUD_RPRT_DVSN_CD,
                T4.RPRT_NM AS V_RPRT_NM,
                T1.REGI_NO,
                (SELECT DECODE(CHF_CMTR_CNB, NULL, '', F_USR_INFO(ST1.CHF_CMTR_CNB, '2')||DECODE(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1), 0, '', ' 외 ' || TO_CHAR(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1))) )
                  FROM TBBADDED116L ST1
                 WHERE ST1.AUD_YR = T1.AUD_YR AND ST1.AUD_NO = T1.AUD_NO AND ST1.TASK_DVSN_CD = '9'
                   AND ST1.DOC_ID = T1.DOC_ID
                   AND ST1.SRNO = (SELECT MAX(SRNO) FROM TBBADDED116L WHERE AUD_YR = T1.AUD_YR AND AUD_NO = ST1.AUD_NO AND TASK_DVSN_CD = '9' AND DOC_ID = ST1.DOC_ID)) AS CHF_CMTR_NM,
                (SELECT CHF_CMTR_CNB AS CHF_CMTR_ID
                  FROM TBBADDED116L ST1
                 WHERE ST1.AUD_YR = T1.AUD_YR AND ST1.AUD_NO = T1.AUD_NO AND ST1.TASK_DVSN_CD = '9'
                   AND ST1.DOC_ID = T1.DOC_ID
                   AND ST1.SRNO = (SELECT MAX(SRNO) FROM TBBADDED116L WHERE AUD_YR = ST1.AUD_YR AND AUD_NO = ST1.AUD_NO AND TASK_DVSN_CD = '9' AND DOC_ID = ST1.DOC_ID)) AS CHF_CMTR_ID
                , F_OPEN_EDIT(T4.LINK_URL) AS DOC_TYPE
            FROM 
                TBBADDED112D T1
                INNER JOIN
                TBBADDED103M T4
                ON (T1.AUD_YR = T4.AUD_YR AND T1.AUD_NO = T4.AUD_NO AND T1.DOC_ID = T4.DOC_ID)
                INNER JOIN
                TBBADDED145M T2
                ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO AND T1.DOC_ID = T2.DOC_ID AND (T2.APVR_CD = '0055700' OR T2.APVR_CD = '0010600'))
                INNER JOIN
                TBBADDED146M T3
                ON (T2.AUD_YR = T3.AUD_YR AND T2.AUD_NO = T3.AUD_NO AND T2.AUD_STEP_CD = T3.AUD_STEP_CD AND T2.DOC_ID = T3.DOC_ID AND T2.APVR_CD = T3.APVR_CD AND T2.AFF_SNO = T3.AFF_SNO)
                LEFT JOIN
                TBBADDED113M T5
                ON (T5.AUD_YR = T2.AUD_YR AND T5.AUD_NO = T2.AUD_NO AND T5.DOC_ID = T2.DOC_ID AND T5.APVR_CD = T2.APVR_CD AND T5.AFF_SNO = T2.AFF_SNO AND T5.DSP_RQ_SNO = T3.DSP_RQ_SNO)
                INNER JOIN (
                            SELECT 
                                ST1.AUD_YR, ST1.AUD_NO, ST1.DOC_ID
                                , MIN(DECODE(ST1.RPRT_CD,'A10600200',DECODE(ST2.APVR_PST_CD,'0055600',F_USR_INFO(ST2.APVR_CNB,'2') ,
                                                                                          DECODE(ST2.APVR_PST_CD,'0045900',F_USR_INFO(ST2.APVR_CNB,'2') ,'')),'')) AS AUD_RPRT_CHA  /* 0045900 : 본부장 추가 */
                                , MIN(DECODE(ST1.RPRT_CD,'A10600200',DECODE(ST2.APVR_PST_CD,'0055700',F_USR_INFO(ST2.APVR_CNB,'2'),''),'')) AS AUD_RPRT_CHONG
                                , MIN(DECODE(ST1.RPRT_CD,'A10600200',DECODE(ST2.APVR_PST_CD,'0055600',TO_CHAR(ST2.APV_DH,'YYYY"-"MM"-"DD" "HH24:MI') ,
                                                                                                  DECODE(ST2.APVR_PST_CD,'0045900',TO_CHAR(ST2.APV_DH,'YYYY"-"MM"-"DD" "HH24:MI') ,'')),'')) AS AUD_RPRT_CHA_DH  /* 0045900 : 본부장 추가 */
                                , MIN(DECODE(ST1.RPRT_CD,'A10600200',DECODE(ST2.APVR_PST_CD,'0055700',TO_CHAR(ST2.APV_DH,'YYYY"-"MM"-"DD" "HH24:MI'),''),'')) AS AUD_RPRT_CHONG_DH
                                , MIN(DECODE(ST1.RPRT_CD,'A10600200',DECODE(ST2.APVR_STA_CD,'203',TO_CHAR(ST2.APV_DH,'YYYY"-"MM"-"DD" "HH24:MI'),''),'')) AS PSD_APV_DY
                              FROM TBBADDED103M ST1 INNER JOIN TBDCMACM023H ST2
                                   ON (ST1.APV_RQS_ID = ST2.APV_DOC_NO AND ST2.APVR_STA_CD IN ('202','203'))
                             WHERE ST1.RPRT_CD = 'A10600200'
                             GROUP BY ST1.AUD_YR, ST1.AUD_NO, ST1.DOC_ID
                            ) T6
                ON (T1.AUD_YR = T6.AUD_YR AND T1.AUD_NO = T6.AUD_NO AND T1.DOC_ID = T6.DOC_ID)
            WHERE
                T1.AUD_YR = #{audYr} 
            AND T1.AUD_NO = #{audNo}
            GROUP BY T1.AUD_YR, T1.AUD_NO, T4.RPRT_NM, T4.DOC_ID, T1.SBCN_TRTM_DTL_SNO, T4.APV_RQS_ID, RPRT_CD, T4.AUD_RPRT_DVSN_CD, T1.DOC_ID, T1.REGI_NO, T4.LINK_URL, T6.PSD_APV_DY
            ORDER BY T4.AUD_RPRT_DVSN_CD, T1.SBCN_TRTM_DTL_SNO;

        ]]>
    </select>
    
    <!-- 부의사항 처리부 상세 목록 -->
    <select id="selectTrtmDtlEtcList" parameterType="paramMap" resultType="egovMap">
       /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectTrtmDtlEtcList */
	       SELECT T1.ACP_YR AS AUD_YR,T1.ACP_DVSN_CD AS AUD_KND_CD,T1.ACP_SRNO AS AUD_NO,
			        T2.RPRT_NM AS RPRT_NM,
			        T2.DOC_ID AS DOC_ID,
			        T2.REF_ID AS REF_ID,
			        T1.SBCN_TRTM_DTL_SNO,
	 				(SELECT decode(T2.apv_sta_cd,'30',TO_CHAR(MAX(APV_DH),'YYYY"-"MM"-"DD" "HH24:MI'),'')
	                FROM TBDCMACM023L ST1
	                WHERE ST1.APV_DOC_NO = T2.APV_RQS_ID
	                   ) AS PSD_APV_DY, /* 사무처 결재일자: 결정문 결재일자 */
	                (SELECT decode(COUNT(1),0,1,count(1))
	                  FROM TBBADFRE012M
	                 WHERE MG_ACP_YR = T1.ACP_YR
	                    AND MG_ACP_DVSN_CD = T1.ACP_DVSN_CD
	                    AND MG_ACP_SRNO = T1.ACP_SRNO
	                    AND DEL_YN IS NULL) AS TOT_DSVN_CNT, /*  사무처 부의건수 */
	                (SELECT decode(COUNT(1),0,1,count(1))
	                  FROM TBBADFRE012M
	                 WHERE MG_ACP_YR = T1.ACP_YR
	                    AND MG_ACP_DVSN_CD = T1.ACP_DVSN_CD
	                    AND MG_ACP_SRNO = T1.ACP_SRNO
	                    AND DEL_YN IS NULL) AS DSVN_CNT, /*  사무처 부의건수 */
	                '0' AS DLG_CNT, /*  */
	                '0' AS TOT_DLG_CNT, /*  */
	                '0' AS HNDL_DLG_CNT, /*  */
	                '0' AS TOT_HNDL_DLG_CNT, /*  */
	                (SELECT decode(ST2.apv_sta_cd,'30',TO_CHAR(MAX(APV_DH),'YYYY"-"MM"-"DD" "HH24:MI'),'')
	                  FROM TBDCMACM023L ST1 JOIN TBBADFRE103M ST2 ON (ST1.APV_DOC_NO = ST2.APV_RQS_ID)
	                WHERE ST2.ACP_YR = T1.ACP_YR
                       AND ST2.ACP_DVSN_CD = T1.ACP_DVSN_CD
	                   AND ST2.ACP_SRNO = T1.ACP_SRNO
	                   <if test='audKndCd == "1"'> /*  생략 */
	                   AND ST2.ACP_STEP_CD = 'D1030'
	                   AND ST2.RPRT_CD = 'D10300200'
	                   </if>
	                   <if test='audKndCd == "2"'>
	                      <if test='acpStepCd == "E1020" '>
	                    		AND ST2.ACP_STEP_CD = T2.acp_step_cd
	                   			AND ST2.RPRT_CD = 'E10300150'
			              </if>
		              	  <if test='acpStepCd == "E1040" '>
			              		AND ST2.ACP_STEP_CD = T2.acp_step_cd
	                   			AND ST2.RPRT_CD = 'E10500200'
			              </if>
	                   </if> 
	                   group by ST2.apv_sta_cd) AS CHF_APV_DY, /* 주심위원 결재일자: 주심위원 설명자료 결재일자 */
	                (SELECT decode(COUNT(1),0,1,count(1))
	                  FROM TBBADFRE012M
	                 WHERE MG_ACP_YR = T1.ACP_YR
	                    AND MG_ACP_DVSN_CD = T1.ACP_DVSN_CD
	                    AND MG_ACP_SRNO = T1.ACP_SRNO
	                    AND DEL_YN IS NULL) AS HNDL_DSVN_CNT, /*  주심의원 부의건수 */
	                CASE
	                    WHEN MIN(T3.SBCN_DY) IS NULL THEN ''
	                    
	                    ELSE TO_CHAR(MAX(SBCN_DY),'YYYY"-"MM"-"DD" "HH24:MI')
	                END  AS SBCN_DY, /* 감사위원회의 부의: 결재일자 */
	                COUNT(DECODE(T3.SBCN_VT_CD ,'10',1,'20',1,'30',1)) AS VT_CNT, /* 감사위원회의 부의: 의결 */
	                COUNT(DECODE(T3.SBCN_VT_CD ,'90',1)) AS DF_CNT, /* 감사위원회의 부의: 보류 */
	                COUNT(DECODE(T3.SBCN_VT_CD ,'40',1)) AS UNW_CNT,
	                T2.RPRT_CD,
	                T2.ACP_RPRT_DVSN_CD
	                
	                
	        FROM TBBADFRE112D T1
	 INNER JOIN TBBADFRE103M T2 ON (T1.ACP_YR = T2.ACP_YR
	                                         AND T1.ACP_DVSN_CD = T2.ACP_DVSN_CD
                                             AND T1.ACP_SRNO = T2.ACP_SRNO
                                             <!--<if test='acpDvsnCd == "1"'>
							                    AND T2.ACP_STEP_CD = 'D1020'
							                    AND T2.RPRT_CD = 'D10200200'
							                 </if>
							                 <if test='acpDvsnCd == "2" and acpStepCd == "E1030"'>
							                    AND T2.ACP_STEP_CD = 'E1030'
							                    AND T2.RPRT_CD = 'E10200200'
							                 </if>
							                 <if test='acpDvsnCd == "2" and acpStepCd == "E1050"'>
							                   AND T2.ACP_STEP_CD = 'E1050'
							                   AND T2.RPRT_CD = 'E10400200'
							                 </if> -->
                                             AND T1.DOC_ID = T2.DOC_ID)
	    LEFT JOIN TBBADFRE113M T3 ON (T3.ACP_YR = T2.ACP_YR
	                                         AND T2.ACP_DVSN_CD = T3.ACP_DVSN_CD
                                             AND T2.ACP_SRNO = T3.ACP_SRNO
	                                         AND T3.DOC_ID = T2.DOC_ID)
	       WHERE T1.ACP_YR = #{audYr}
	          AND T1.ACP_DVSN_CD = #{audKndCd}
	          AND T1.ACP_SRNO = #{audNo}
	          
	          <if test='audKndCd == "1"'> /*  생략 */
              	 AND T2.RPRT_CD = 'D10200200'
              </if>
              <if test='audKndCd == "2" '>/*  생략 */
	              
	              <if test='acpStepCd == "E1020" '>
	              	AND T2.RPRT_CD ='E10200200'
	              </if>
              	  <if test='acpStepCd == "E1040" '>
	              	AND T2.RPRT_CD ='E10400200'
	              </if>
              	
              </if>
	   GROUP BY T1.ACP_YR, T2.apv_sta_cd,T2.acp_step_cd,T2.rprt_cd, T1.ACP_DVSN_CD, T1.ACP_SRNO, T2.RPRT_NM, T2.DOC_ID, T2.REF_ID, T1.SBCN_TRTM_DTL_SNO, T2.APV_RQS_ID, T2.RPRT_CD, T2.ACP_RPRT_DVSN_CD
	   ORDER BY T1.SBCN_TRTM_DTL_SNO;
    </select>
    
    <insert id="insertTrtmDtlData">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.insertTrtmDtlData */
        <![CDATA[
        INSERT INTO TBBADDED112D(AUD_YR,AUD_NO,SBCN_TRTM_DTL_SNO,DOC_ID,SORT_SNO,FRT_USR_ID,FNL_USR_ID,FNL_DEAL_DPT_CD,FNL_MNU_ID,
                                                        FRT_REGI_DH,FNL_MDF_DH)
                                        VALUES(#{audYr}, #{audNo}, (SELECT 
                                        								 	LPAD(NVL(MAX(TO_NUMBER(SBCN_TRTM_DTL_SNO)),0)+1,3,0) 
                                        								 FROM TBBADDED112D 
                                        								 WHERE 
                                        								 		AUD_YR = #{audYr} 
                                        								 AND AUD_NO =#{audNo} ),
                                               #{docId},(SELECT 
                                        								 	LPAD(NVL(MAX(TO_NUMBER(SBCN_TRTM_DTL_SNO)),0)+1,3,0) 
                                        								 FROM TBBADDED112D 
                                        								 WHERE 
                                        								 		AUD_YR = #{audYr} 
                                        								 AND AUD_NO =#{audNo} ),
                                               #{usrId},#{usrId},#{dptCd},'AEPASB001E',SYSDATE,SYSDATE)
        ]]>
    </insert>

    <select id="selectSbcnRdPrcs" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbcnRdPrcs */
        <![CDATA[
            SELECT 
                AUD_YR, 
                AUD_NO, 
                T3.AUD_STEP_CD,
                AUD_MAIN_STEP_ID,
                SBCN_TRTM_DTL_SNO AS AUD_MAIN_STEP_SNO,
                AUD_MAIN_SEQ_W,
                AUD_MAIN_SEQ_H,
                AUD_DOC_CD,
                CMPT_YN,
                T2.AUD_KND_CD,
                AUD_GRN_NO,
                AUD_MAIN_STEP_NM AS MAIN_JOB_NM,
                LINK_TYPE,
                LINK_URL,
                NULL AS SORT_SNO
            FROM 
                TBBADDED112D T1
                JOIN
                TBBADDED001M T2
                USING (AUD_YR, AUD_NO)
                JOIN
                TBBADDED102B T3
                ON SUBSTR(T2.AUD_KND_CD,-1) = T3.AUD_KND_CD
            WHERE 
                AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND T3.AUD_STEP_CD = 'A1070'
            AND SUBSTR(T3.AUD_MAIN_STEP_ID,0,2) = '70'
            AND SBCN_TRTM_DTL_SNO NOT IN (SELECT 
                                                                            DISTINCT AUD_MAIN_STEP_SNO 
                                                                      FROM TBBADDED102M 
                                                                      WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo})
        ]]>
    </select>

    <insert id="insertSbcnRdPrcs">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.insertSbcnRdPrcs */
        <![CDATA[
            INSERT INTO TBBADDED102M  
                (AUD_YR,AUD_NO,AUD_STEP_CD,
                AUD_MAIN_STEP_ID,AUD_MAIN_STEP_SNO,AUD_MAIN_SEQ_W,
                AUD_MAIN_SEQ_H,AUD_DOC_CD, CMPT_YN,AUD_KND_CD,
                AUD_GRN_NO,MAIN_JOB_NM,LINK_TYPE,
                LINK_URL,SORT_SNO,
                FRT_USR_ID,FNL_USR_ID,FNL_DEAL_DPT_CD,
                FNL_MNU_ID,FRT_REGI_DH,FNL_MDF_DH)
            VALUES
                (#{audYr},#{audNo},#{audStepCd},
                #{audMainStepId},#{audMainStepSno}, #{audMainSeqW},
                 #{audMainSeqH}, #{audDocCd}, #{cmptYn}, #{audKndCd}, 
                #{audGrnNo}, #{mainJobNm}, #{linkType},
                #{linkUrl}, #{sortSno}, 
                #{usrId}, #{usrId},#{dptCd},
                'AEPASB001E',SYSDATE,SYSDATE)
        ]]>
    </insert>
    
    <select id="chkRdPrcs" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.chkRdPrcs */
        <![CDATA[
             SELECT * 
            FROM
                (
                SELECT AUD_MAIN_STEP_ID, CMPT_YN FROM TBBADDED102M
                WHERE AUD_YR = #{audYr}
                AND AUD_NO = #{audNo}
                AND AUD_MAIN_STEP_SNO = #{sbcnTrtmDtlSno}
                ) 
            PIVOT 
                (MAX(CMPT_YN) 
                    FOR AUD_MAIN_STEP_ID 
                    IN (
                            '700101' AS STEP1
                            ,'700201' AS STEP2
                            ,'700301' AS STEP3
                            ,'700401' AS STEP4
                            ,'700501' AS STEP5)
                 )
        ]]>
    </select>
    
    <select id="chkStrtPrcs" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.chkStrtPrcs */
        <![CDATA[
             SELECT * 
            FROM
                (
                SELECT AUD_MAIN_STEP_ID, CMPT_YN FROM TBBADDED102M
                WHERE AUD_YR = #{audYr}
                AND AUD_NO = #{audNo}
                AND AUD_MAIN_STEP_SNO = #{audMainStepSno}
                ) 
            PIVOT 
                (MAX(CMPT_YN) 
                    FOR AUD_MAIN_STEP_ID 
                    IN (
                            '720101' AS STEP1
                            ,'720201' AS STEP2
                            ,'720301' AS STEP3
                            ,'720401' AS STEP4
                            ,'720501' AS STEP5)
                 )
        ]]>
    </select>
    
    <update id="saveRvwRsq" parameterType="paramMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.saveRvwRsq */
        <![CDATA[
        UPDATE  TBBADDED112D
            SET     
                        RVW_REQ_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
                        ,RVW_CMPT_YN = 'N'
                        , FNL_USR_ID = #{usrId}
                        , FNL_MNU_ID = 'AEPASB001E'
                        , FNL_MDF_DH = SYSDATE
                        , FNL_DEAL_DPT_CD = #{dptCd}
            WHERE   
                        AUD_YR = #{audYr}
            AND     AUD_NO  = #{audNo}
            AND     SBCN_TRTM_DTL_SNO  = #{sbcnTrtmDtlSno}
        ]]>
    </update>
        
    <select id="selectRvwRsqDoc" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectRvwRsqData */
        <![CDATA[
            SELECT 
                AUD_YR
                ,AUD_NO
                ,DOC_ID
                ,AUD_KND_CD
                ,AUD_GRN_NO
                ,RPRT_NM
                ,RPRT_CD
                ,LINK_URL
                ,REF_ID
                ,REF_DY
            FROM TBBADDED103M
            WHERE AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND (DOC_ID = #{docId} OR REF_ID = #{docId})
            AND RPRT_CD IN ('A10600200','A10600300','A10600400','A10700100') /* 심의요청시 감사보고서, 주심위원 설명자료 발신 처리 */
        ]]>
    </select>
    
    <insert id="saveSendRvwRsqDoc">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.saveSendRvwRsqDoc */
        <![CDATA[
            INSERT INTO TBBADDED111M (AUD_YR,AUD_NO,AUD_STEP_CD,
                DOC_ID,SR_DOC_SNO,AUD_KND_CD,AUD_GRN_NO,RPRT_NM,RPRT_CD,
                LINK_URL,DOC_STA_CD,SND_DPT_CD,SNDR_ID,SND_DH,RCPT_DPT_CD,
                RCNT_ID,RCPT_DH,DOC_KND_CD,REF_ID,REF_DY,SORT_SNO,
                FRT_USR_ID,FNL_USR_ID,FNL_DEAL_DPT_CD,FNL_MNU_ID,FRT_REGI_DH,FNL_MDF_DH)
            VALUES (#{audYr},#{audNo},'A1070',
                #{docId}, (SELECT 
								 	LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0) 
								 FROM TBBADDED111M 
								 WHERE 
								 		AUD_YR = #{audYr} 
								 AND AUD_NO =#{audNo}
                                 AND AUD_STEP_CD ='A1070'
                                 AND DOC_ID = #{docId} ),
				#{audKndCd},#{audGrnNo},#{rprtNm},#{rprtCd},
                #{linkUrl},'S',#{dptCd},#{usrId},SYSDATE,'510000',
                NULL,NULL,NULL,#{refId},#{refDy},(SELECT 
								 	LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0) 
								 FROM TBBADDED111M 
								 WHERE 
								 		AUD_YR = #{audYr} 
								 AND AUD_NO =#{audNo}
                                 AND AUD_STEP_CD ='A1070'
                                 AND DOC_ID = #{docId} ),
                #{usrId},#{usrId},#{dptCd},'AEPASB001E',SYSDATE,SYSDATE)
        ]]>
    </insert>
    
    <select id="selectSendDocInfo" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSendDocInfo */
        <![CDATA[
            SELECT 
                AUD_YR
                ,AUD_NO
                ,AUD_STEP_CD
                ,DOC_ID
                ,AUD_KND_CD
                ,AUD_GRN_NO
                ,RPRT_NM
                ,RPRT_CD
                ,LINK_URL
                ,AUD_RPRT_DVSN_CD 
                ,DOC_KND_CD 
                ,REF_ID
                ,REF_DY
            FROM TBBADDED103M 
            WHERE AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = #{audStepCd}
            AND DOC_ID = #{docId}
        ]]>
    </select>
    
    <select id="selectSendSbcnDocInfo" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSendSbcnDocInfo */
        <![CDATA[
            SELECT 
                AUD_YR
                ,AUD_NO
                ,AUD_STEP_CD
                ,DOC_ID
                ,AUD_KND_CD
                ,AUD_GRN_NO
                ,RPRT_NM
                ,RPRT_CD
                ,LINK_URL
                ,AUD_RPRT_DVSN_CD 
                ,DOC_KND_CD 
                ,REF_ID
                ,REF_DY
            FROM TBBADDED103M 
            WHERE AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = #{audStepCd}
            AND (DOC_ID = #{docId} OR REF_ID = #{docId})
        ]]>
    </select>
    
    <select id="selectSendSbmtDocInfo" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSendSbmtDocInfo */
        <![CDATA[
            SELECT 
                AUD_YR
                ,AUD_NO
                ,AUD_STEP_CD
                ,DOC_ID
                ,AUD_KND_CD
                ,AUD_GRN_NO
                ,RPRT_NM
                ,RPRT_CD
                ,LINK_URL
                ,AUD_RPRT_DVSN_CD 
                ,DOC_KND_CD 
                ,REF_ID
                ,REF_DY
            FROM TBBADDED103M 
            WHERE AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = #{audStepCd}
            AND (DOC_ID = #{docId}  OR REF_DOC_ID = #{docId} ) /*소위원회 심의안, 소위원회 심의안요약(보고자용) 동시 발신*/
            AND RPRT_CD IN ('A10700200', 'A10700220', 'A10700230')
        ]]>
    </select>
    
    <select id="selectSbmtMainStepSno" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbmtMainStepSno */
        <![CDATA[
            SELECT MAX(AUD_MAIN_STEP_SNO) AS AUD_MAIN_STEP_SNO
              FROM TBBADDED114M
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND SBMT_SEQ = #{refDy}
               AND AFF_SNO = #{refId}
        ]]>
    </select>
    
    <insert id="saveSendDoc"> 
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.saveSendDoc */
        <![CDATA[
            INSERT INTO TBBADDED111M (AUD_YR,AUD_NO,AUD_STEP_CD,
                DOC_ID,SR_DOC_SNO,AUD_KND_CD,AUD_GRN_NO,RPRT_NM,RPRT_CD,
                LINK_URL,DOC_STA_CD,SND_DPT_CD,SNDR_ID,SND_DH,RCPT_DPT_CD,
                RCNT_ID,RCPT_DH,AUD_RPRT_DVSN_CD, DOC_KND_CD,REF_ID,REF_DY,SORT_SNO,
                FRT_USR_ID,FNL_USR_ID,FNL_DEAL_DPT_CD,FNL_MNU_ID,FRT_REGI_DH,FNL_MDF_DH)
            VALUES (#{audYr},#{audNo},#{audStepCd},
                #{docId}, (SELECT 
                                    LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0) 
                                 FROM TBBADDED111M 
                                 WHERE 
                                        AUD_YR = #{audYr} 
                                 AND AUD_NO =#{audNo}
                                 AND AUD_STEP_CD = #{audStepCd}
                                 AND DOC_ID = #{docId} ),
                #{audKndCd},#{audGrnNo},#{rprtNm},#{rprtCd},
                #{linkUrl},'10',#{dptCd},#{usrId},SYSDATE,#{rcptDptCd},
                NULL,NULL,#{audRprtDvsnCd},#{docKndCd},#{refId},#{refDy},(SELECT 
                                    LPAD(NVL(MAX(TO_NUMBER(SR_DOC_SNO)),0)+1,3,0) 
                                 FROM TBBADDED111M 
                                 WHERE 
                                        AUD_YR = #{audYr} 
                                 AND AUD_NO =#{audNo}
                                 AND AUD_STEP_CD =#{audStepCd}
                                 AND DOC_ID = #{docId} ),
                #{usrId},#{usrId},#{dptCd},'AEPASB001E',SYSDATE,SYSDATE)
        ]]>
    </insert>
    
    
    <update id="updateAudStep"> 
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.updateAudStep */
        <![CDATA[
       UPDATE TBBADDED102M
       SET CMPT_YN =  #{cmptYn}
            , FNL_USR_ID = #{usrId}
            , FNL_MNU_ID = 'AEPASB001E'
            , FNL_MDF_DH = SYSDATE
            , FNL_DEAL_DPT_CD = #{dptCd}
       WHERE
            AUD_YR = #{audYr}
       AND AUD_NO = #{audNo}
       AND AUD_STEP_CD = 'A1070'
       AND AUD_MAIN_STEP_ID =  #{audMainStepId}
       ]]>
        <if test="sbcnTrtmDtlSno != null and sbcnTrtmDtlSno != ''">
        AND AUD_MAIN_STEP_SNO  =  #{sbcnTrtmDtlSno}
        </if>
        <if test="audMainStepSno != null and audMainStepSno != ''">
        AND AUD_MAIN_STEP_SNO  =  #{audMainStepSno}
        </if>
        <if test="audMainStepId == '710201' ">
        AND AUD_MAIN_STEP_SNO  =  (SELECT AUD_MAIN_STEP_SNO FROM TBBADDED114M WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND AFF_SNO = #{refId} AND SBMT_SEQ = #{refDy})
        </if>
    </update>
    
    <select id="selectSendDoc" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSendDoc */
        <![CDATA[
        SELECT 
            CASE WHEN A.RPRT_CD = 'A10700500'     /*부의안 요약 + 부의안 한줄로 처리 */
                    THEN  A.RPRT_NM ||'/'|| (SELECT MAX(RPRT_NM)   
                                        FROM TBBADDED103M ST1
                                        WHERE ST1.AUD_YR = A.AUD_YR
                                        AND ST1.AUD_NO = A.AUD_NO
                                        AND ST1.AUD_STEP_CD = B.AUD_STEP_CD
                                        AND ST1.REF_DY  = B.REF_DY
                                        AND ST1.RPRT_CD = 'A10700600')
                    WHEN A.RPRT_CD = 'A10700200'     /*소위원회 심의안 + 소위원회 심의안 요약 한줄로 처리 */
                    THEN  A.RPRT_NM ||'/'|| (SELECT MAX(RPRT_NM)   
                                        FROM TBBADDED103M ST1
                                        WHERE ST1.AUD_YR = A.AUD_YR
                                        AND ST1.AUD_NO = A.AUD_NO
                                        AND ST1.AUD_STEP_CD = B.AUD_STEP_CD
                                        AND ST1.DOC_ID  = A.REF_DOC_ID
                                        AND ST1.RPRT_CD = 'A10700210')
                    ELSE A.RPRT_NM
            END AS RPRT_NM ,       /*보고서명 */
            F_CODE_NM('1000780',DOC_STA_CD) DOC_STA_NM, 
            NVL(F_DPT_INFO(RCPT_DPT_CD,'1'),(SELECT  '위원실'||SUBSTR(ST1.RAL_BLT_DIV_CD,5,1) AS RAL_BLT_DIV_NM
              FROM TBDCMACM001M ST1
             WHERE 1=1
               AND SUBSTR(ST1.RAL_BLT_DIV_CD,0,4) = '5105'
               AND ST1.DPT_CD = '510000'
               AND ST1.WOK_DVSN_CD = 'AAA'
               AND ST1.RAL_BLT_DIV_CD = B.RCPT_DPT_CD) ) AS RCPT_DPT_NM,
            TO_CHAR(RCPT_DH,'YYYY"-"MM"-"DD') AS RCPT_DH,
            TO_CHAR(SND_DH ,'YYYY"-"MM"-"DD') AS SND_DH ,
            A.AUD_YR, 
            A.AUD_NO, 
            A.DOC_ID,
            A.RPRT_CD,
            F_OPEN_EDIT(A.LINK_URL) AS DOC_TYPE
        FROM 
            TBBADDED103M A 
            JOIN  TBBADDED111M B
            ON (A.AUD_YR = B.AUD_YR AND A.AUD_NO = B.AUD_NO AND A.DOC_ID = B.DOC_ID AND A.RPRT_CD = B.RPRT_CD)
        WHERE
            A.AUD_YR =  #{audYr}
        AND A.AUD_NO = #{audNo}
        AND B.AUD_STEP_CD = #{audStepCd}
        ]]>
        <if test="sbmtDoc != null and sbmtDoc != ''" >
        	AND B.REF_DY = #{refDy}
        	AND A.REF_ID = #{refId}
            AND (A.RPRT_CD IN ('A10700200','A10700300','A10700220','A10700230')) 
        </if>
        <if test="audMainStepDsvnCd eq '70'.toString()">
            AND A.RPRT_CD IN ('A10700100')
            AND SUBSTR(NVL(A.AUD_RPRT_DVSN_CD,'00'),2,1) != '1'
        </if>
        <if test="audMainStepDsvnCd eq '72'.toString()">
            AND B.REF_DY = #{refDy}
            AND A.REF_DOC_ID = #{refDocId}
            AND A.RPRT_CD NOT IN ('A10700600')
            AND RCPT_DPT_CD = '160100'
        </if>
        <if test="sndDptCd != null and sndDptCd != ''">
            AND B.SND_DPT_CD  = #{sndDptCd}
        </if>
        <if test="rcptDptCd != null and rcptDptCd != ''">
            AND B.RCPT_DPT_CD   = #{rcptDptCd}
        </if>
        ORDER BY A.RPRT_CD
    </select>
        
    <select id="selectDocId" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectDocId */
        <![CDATA[
        SELECT 
                    NVL(MAX(DOC_ID),'') AS DOC_ID
        FROM TBFDMADM002M
        WHERE AUD_DOC_CD = #{rprtCd}
        ]]>
    </select>
    
    <select id="selectAudInfo" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectAudInfo */
        <![CDATA[
             SELECT 
                AUD_YR
                , AUD_NO
                , F_MNG_KND_AUDYRNO(AUD_YR, AUD_NO, AUD_KND_CD, '-')   AS AUD_YR_NO                 /*감사연번호*/
                , AUD_SBJ_NM                                                                            AS AUD_SBJ_NM                   /*감사사항명*/
                , F_CODE_NM('1000007',AUD_KND_CD)                                           AS AUD_KND_NM                   /*감사종류*/
                , F_CODE_NM('1000751',BZT_BGT_DVSN_CD)                              AS BZT_BGT_DVSN_NM          /*예산종류*/
                , F_DPT_INFO(SPV_BRDV_CD,'1')                                                   AS SPV_BRDV_NM                  /*주관국과명*/
                , F_DPT_INFO(MNG_DPT_CD,'1')                                                    AS MNG_DPT_NM                   /*관리부서명*/
                , F_ORG_INFO(AUD_RPST_ORG_CD,'1')                                       AS AUD_RPST_ORG_NM      /*대표기관명*/
                , F_CODE_NM('1000027',AUD_SCL_CD)                                           AS AUD_SCL_CD                   /*감사규모코드*/
                , CASE 
                    WHEN AUD_TOT_DRTR_CNB IS NULL then ''
                    ELSE F_USR_INFO(AUD_TOT_DRTR_CNB,'2')||'('||F_DPT_INFO(TOT_DRTR_BRDV_CD,'1')||'|'||F_CODE_NM('1000173',TOT_DRTR_RANK_CD)||')'
                    END                                                                                         AS AUD_TOT_DRTR_NM          /*감사단장*/
            FROM TBBADDED001M
            WHERE AUD_YR= #{audYr}
            AND AUD_NO = #{audNo}
        ]]>
    </select>
    
    <select id="selectDocBoxList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectDocBoxList */
        <![CDATA[
        
        SELECT 
            CASE 
                WHEN A.RPRT_CD IN ('A10700400','A10700500','A10700600')
                            /* 문서함에서 발신하는 문서 : 처리안검토보고서, 부의안, 부의안요약문 */
                            THEN DECODE(1, (
                                          SELECT 1
                                            FROM DUAL
                                           WHERE EXISTS (
                                                        SELECT 1
                                                          FROM TBBADDED111M B
                                                         WHERE B.AUD_YR = A.AUD_YR
                                                           AND B.AUD_NO = A.AUD_NO
                                                           AND B.AUD_STEP_CD = A.AUD_STEP_CD
                                                           AND B.DOC_ID = A.DOC_ID
                                                        )
                                          ), 'N', 'Y')
                ELSE ''
            END AS SEND_YN       /* 발신여부 */
            , A.RPRT_NM       /*보고서명 */
            , A.RPRT_CD       /* 보고서 코드 */
            , A.APV_STA_CD    /*결재상태코드 */
            , F_CODE_NM('1000773',NVL(A.APV_STA_CD,'10')) AS APV_STA_NM
            , A.SORT_SNO      /*보고서순번  */
            , A.DOC_ID        /*결재문서번호 */
            , A.REF_ID        /*참조ID */
            , A.REF_DY        /*참조일자 */
            , A.APV_RQS_ID    /*결재요청ID */
        FROM 
            TBBADDED103M A
        WHERE 
            A.AUD_YR = #{audYr}
        AND A.AUD_NO = #{audNo}
        AND A.AUD_STEP_CD = #{audStepCd}
        AND A.AUD_KND_CD = #{audKndCd}
        
        ]]>
        <if test="refId != null and refId != ''">
            AND A.REF_ID = #{refId}
        </if>
        <if test="refDy != null and refDy != ''">
            AND A.REF_DY  = #{refDy}
        </if>
        ORDER BY A.SORT_SNO
    </select>
    
    <select id="selectDocBoxApvList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectDocBoxList */
        <![CDATA[
        SELECT 
            RPRT_NM,
            F_CODE_NM('1000773',NVL(APV_STA_CD,10)) AS APV_STA_CD,
            APV_RQS_ID,
            DOC_ID,
            APV_SRNO,
            PST_NM,
            APVR_NM,
            APV_DH ,
            CASE
                WHEN ROW_NUMBER() OVER(PARTITION BY APV_RQS_ID ORDER BY APV_SRNO) = 1 THEN COUNT(*) OVER(PARTITION BY APV_RQS_ID)
                ELSE 0
            END ROWSPAN_CNT
        FROM (
            SELECT 
                A.RPRT_NM ,       /*보고서명 */
                A.APV_STA_CD ,    /*결재상태코드 */
                A.DOC_ID ,        /*결재문서번호 */
                A.APV_RQS_ID,     /*결재요청ID */
                B.APV_SRNO ,      /*결재순번 */
                B.PST_NM ,        /*결재자직위코드 */
                B.APVR_NM ,       /*결재자전산번호 */
                B.APV_DH          /*결재일시 */   
            FROM TBBADDED103M A,
                (
                    SELECT 
                        APV_DOC_NO AS APV_RQS_ID ,
                        APV_SNO AS APV_SRNO ,
                        F_CODE_NM('1000176', APVR_PST_CD) AS PST_NM ,
                        F_USR_INFO(APVR_CNB, '2') AS APVR_NM ,
                        TO_CHAR(APV_DH, 'YYYY-MM-DD') AS APV_DH
                    FROM TBDCMACM023L
                    WHERE APV_SNO <> '0'
                    UNION ALL
                    SELECT 
                        DH1.APV_RQS_ID,
                        DH1.APV_SRNO,
                        (SELECT 
                            H2.PST_NM AS PST_NM
                        FROM 
                            TBDCMACM111H H1,
                            TBDCMACM112H H2
                        WHERE 1=1
                        AND H1.RCPT_DT = H2.RCPT_DT
                        AND H1.RCPT_ID = H2.RCPT_ID
                        AND H1.ONR_DOC_MNG_CRD_ID = DH1.APV_RQS_ID
                        AND H2.APVR_ID = DH1.APVR_ID
                        GROUP BY H2.PST_NM ) AS PST_NM,
                        DH1.APVR_NM,
                        DH1.APV_DH
                    FROM 
                        (SELECT 
                            ONR_DOC_MNG_CRD_ID AS APV_RQS_ID,
                            APV_HIS_SRNO AS APV_SRNO,
                            APVR_ID,
                            APVR_NM AS APVR_NM,
                            TO_CHAR(APV_DH, 'YYYY-MM-DD') AS APV_DH
                        FROM TBDCMACM102L D2
                        WHERE 1=1
                        AND ONR_APV_DVSN_CD <> '10' --(기안자 제외)
                        AND NVL(ONR_APV_RSLT_CD,'hh') <>'50'
                        ORDER BY APV_RQS_ID,APV_SRNO
                        ) DH1 
                ) B
            WHERE A.AUD_YR = #{audYr}
            AND A.AUD_NO = #{audNo}
            AND A.AUD_STEP_CD = #{audStepCd}
            AND A.AUD_KND_CD = #{audKndCd}
            AND B.APV_RQS_ID = A.APV_RQS_ID 
        ]]>
        <if test="refId != null and refId != ''">
            AND A.REF_ID = #{refId}
        </if>
        <if test="refDy != null and refDy != ''">
            AND A.REF_DY  = #{refDy}
        </if>
        ORDER BY A.SORT_SNO
        )
    </select>
    
    
    <select id="selectAffList" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectAffList */
        <include refid="include.pageSelct" />
            <![CDATA[
            SELECT T1.REFER_DVSN_CD,
                   F_CODE_NM('1000774',T1.REFER_DVSN_CD) AS REFER_DVSN_NM,
                   T2.RLTN_ORG_CD, /*관계기관*/
                   F_ORG_INFO(T2.RLTN_ORG_CD,'1') AS RLTN_ORG_NM,
                   T2.HND_ORG_CD, /*조치기관*/
                   F_ORG_INFO(T2.HND_ORG_CD,'1') AS HND_ORG_NM,
                   T2.REF_ORG_CD, /*참고기관*/
                   F_ORG_INFO(T2.REF_ORG_CD,'1') AS REF_ORG_NM,
                   DECODE(T2.AFF_DSP_CD, '00', '', 
                       F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-')||'-'||T1.AFF_CD||'-'||T2.AFF_DSP_CD) AS A,
                   T1.TITLE_NM,
                   T2.DSP_RQ_CD,
                   F_CODE_NM('1000002',T2.DSP_RQ_CD ) AS DSP_RQ_NM,
                   T2.AUD_YR,
                   T2.AUD_NO,
                   T2.AUD_STEP_CD,
                   T2.DOC_ID,
                   T3.AUD_RPRT_DVSN_CD,
                   F_CODE_NM('1000788', T3.AUD_RPRT_DVSN_CD) AS AUD_RPRT_DVSN_NM,
                   T2.APVR_CD,
                   T2.AFF_SNO,
                   T2.DSP_RQ_SNO,
                   T2.ACCN_INSP_CD
                   ]]>
                   <if test="apvrCd == '0010600'">
                   ,(SELECT DECODE(MAX(APV_STA_CD),'30','N','Y') FROM TBBADDED103M ST1 
                   WHERE ST1.AUD_YR = T1.AUD_YR 
                     AND ST1.AUD_NO = T1.AUD_NO
                     AND ST1.AUD_STEP_CD = T1.AUD_STEP_CD
                     AND ST1.REF_ID = T3.DOC_ID
                     AND ST1.RPRT_CD = 'A10700100') AS EDIT_YN
                   </if>
                   <if test="apvrCd == 'A1070'">
                   ,DECODE(T2.FNL_YN,'Y','N','Y') AS EDIT_YN
                   </if>
                   , T2.KYWD1
                   , T2.KYWD2
                   , T2.KYWD3
                   , T2.KYWD4
                   , T2.KYWD5 
              FROM TBBADDED145M AS T1
        INNER JOIN TBBADDED146M AS T2 ON T1.AUD_YR = T2.AUD_YR
                                     AND T1.AUD_NO = T2.AUD_NO
                                     AND T1.AUD_STEP_CD = T2.AUD_STEP_CD
                                     AND T1.DOC_ID = T2.DOC_ID
                                     AND T1.APVR_CD = T2.APVR_CD
                                     AND T1.AFF_SNO = T2.AFF_SNO
        INNER JOIN TBBADDED103M AS T3 ON T1.AUD_YR = T3.AUD_YR
                                     AND T1.AUD_NO = T3.AUD_NO
                                     AND T1.DOC_ID = T3.DOC_ID
             WHERE T1.AUD_YR      = #{audYr}
               AND T1.AUD_NO      = #{audNo}
               AND T1.AUD_STEP_CD = #{audStepCd}
               AND T1.APVR_CD     = #{apvrCd}
          ORDER BY AFF_CD, AFF_DSP_CD, AFF_SNO, DSP_RQ_SNO
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectCmptSbcnYn" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectCmptSbcnYn */
        <![CDATA[
            SELECT 
                CASE 
                    WHEN TOT_SBCN_CNT <= SBCN_REGI_REQ_CNT THEN 'Y'
                    ELSE 'N'
                END AS SBCN_CMPT_YN
            FROM 
                (SELECT 
                    (SELECT COUNT(1)
                    FROM 
                        TBBADDED145M
                        JOIN
                        TBBADDED146M
                        USING(AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID, APVR_CD, AFF_SNO)
                    WHERE 
                        AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND AUD_STEP_CD = 'A1070'
                    AND APVR_CD = '0010600'
                    AND REFER_DVSN_CD = 'D10') AS TOT_SBCN_CNT, 
                    (SELECT COUNT(1)
                    FROM TBBADDED113M
                    WHERE AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}) AS SBCN_REGI_REQ_CNT
                FROM DUAL)
        ]]>
    </select>
    
    <select id="selectSbcnRegiReqList" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbcnRegiReqList */
        <![CDATA[
            SELECT * 
                FROM (
                    SELECT
                        AUD_YR
                        ,AUD_NO
                        ,APVR_CD
                        ,AUD_YRNO
                        ,AUD_SBJ_NM
                        ,MNG_DPT_NM
                        ,REGI_NO
                        ,CHF_CMTR_NM
                        ,SBCN_REGI_REQ_DT
                        ,SBCN_NBC
                        ,SBCN_DY
                        ,SBCN_PAGE_CNT  
                        ,TOT_SBCN_CNT
                        , COUNT(1) AS SBCN_REGI_REQ_CNT
                        , AUD_MAIN_STEP_SNO
                        , SBCN_RPTR
                        , SBCN_PRSS_DPT_NM
                        , DOC_ID
                        , (SELECT RPRT_NM 
                             FROM TBBADDED103M ST1
                            WHERE ST1.DOC_ID = A.DOC_ID) AS RPRT_NM
                       , (SELECT ST1.SORT_SNO 
                          FROM TBBADDED103M ST1
                         WHERE ST1.DOC_ID = A.DOC_ID) AS SORT_SNO
                       , MNG_DPT_CD
                       , SEC_AUD_YN
                    FROM 
                        (SELECT 
                            T1.AUD_YR, T1.AUD_NO, T1.APVR_CD
                            ,F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') AS AUD_YRNO
                            ,T2.AUD_SBJ_NM
                            ,F_DPT_INFO(MNG_DPT_CD,'1') AS MNG_DPT_NM
                            ,REGI_NO
                            ,(SELECT DECODE(CHF_CMTR_CNB, NULL, '', F_USR_INFO(ST1.CHF_CMTR_CNB, '2')||DECODE(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1), 0, '', ' 외 ' || TO_CHAR(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1))) )
                               FROM TBBADDED116L ST1
                              WHERE ST1.AUD_YR = #{audYr} AND ST1.AUD_NO = #{audNo} AND ST1.TASK_DVSN_CD = '9'
                                AND ST1.DOC_ID = T1.DOC_ID
                                AND ST1.SRNO = (SELECT MAX(SRNO) FROM TBBADDED116L WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND TASK_DVSN_CD = '9' AND DOC_ID = ST1.DOC_ID)) AS CHF_CMTR_NM
                            ,TO_CHAR(TO_DATE(SBCN_REGI_REQ_DT),'YYYY"-"MM"-"DD') AS SBCN_REGI_REQ_DT
                            ,SBCN_NBC
                            ,TO_CHAR(TO_DATE(SBCN_DY),'YYYY"-"MM"-"DD') AS SBCN_DY
                            ,SBCN_PAGE_CNT  
                            ,(SELECT COUNT(1)
                                FROM 
                                    TBBADDED145M
                                    JOIN
                                    TBBADDED146M
                                    USING(AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID, APVR_CD, AFF_SNO)
                                WHERE 
                                    AUD_YR = T1.AUD_YR
                                AND AUD_NO = T1.AUD_NO
                                AND AUD_STEP_CD = 'A1070'
                                AND DOC_ID = T1.DOC_ID
                                AND APVR_CD = '0010600'
                                AND REFER_DVSN_CD = 'D10') AS TOT_SBCN_CNT
                            , AUD_MAIN_STEP_SNO 
                            , T1.SBCN_RPTR
                            , T1.SBCN_PRSS_DPT_NM
                            , T1.DOC_ID
                            , T2.MNG_DPT_CD
                            , T2.SEC_AUD_YN
                        FROM 
                            TBBADDED113M T1
                            INNER JOIN TBBADDED001M T2 
                            ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO)
                            INNER JOIN TBBADDED112D T3
                            ON (T1.AUD_YR = T3.AUD_YR AND T1.AUD_NO = T3.AUD_NO AND T1.DOC_ID = T3.DOC_ID)
                        WHERE
                            T1.AUD_YR = #{audYr}
                        AND T1.AUD_NO = #{audNo}
                    ) A
                    GROUP BY AUD_YR, AUD_NO, APVR_CD, AUD_YRNO, AUD_SBJ_NM, MNG_DPT_NM, REGI_NO, DOC_ID,
                             CHF_CMTR_NM, SBCN_REGI_REQ_DT, SBCN_NBC, SBCN_DY, SBCN_PAGE_CNT, TOT_SBCN_CNT, AUD_MAIN_STEP_SNO, SBCN_RPTR, SBCN_PRSS_DPT_NM, MNG_DPT_CD, SEC_AUD_YN
                    ]]>
                    )
                ORDER BY SBCN_REGI_REQ_DT, SORT_SNO
    </select>
    
    
    <select id="selectSbcnRegiInfo" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbcnRegiInfo */
        SELECT 
            (SELECT COUNT(1)
              FROM TBBADDED145M JOIN TBBADDED146M
                   USING(AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID, APVR_CD, AFF_SNO)
            WHERE 
                AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = 'A1070'
            AND APVR_CD = '0010600' /* 주심위원 결재본 */
            AND REFER_DVSN_CD = 'D10') AS SBCN_CNT,
            (SELECT COUNT(1)
               FROM TBBADDED113M
              WHERE AUD_YR = #{audYr}
                AND AUD_NO = #{audNo}
                AND APVR_CD = '0010600') AS REGI_CNT
         FROM DUAL
    </select>
    
    
    
    <select id="selectSbcnRegiReqDtlList" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbcnRegiReqDtlList */
        <![CDATA[
            SELECT 
             AUD_YR
            , AUD_NO
            , DOC_ID
            , APVR_CD
            , AFF_SNO
            , DSP_RQ_SNO
            , T3.AUD_KND_CD
            , T3.AUD_GRN_NO
            , T3.AFF_DSP_CD
            , T3.DSP_RQ_CD
            , F_MNG_KND_AUDYRNO(AUD_YR, AUD_NO, T1.AUD_KND_CD, '-')  
            ||'-'|| AFF_CD 
            ||'-'|| T3.AFF_DSP_CD AS DSP_RQ_SNO_NM
            , TITLE_NM
            , T3.DSP_RQ_CD
            , F_CODE_NM('1000002',T3.DSP_RQ_CD ) AS DSP_RQ_NM
            , RLTN_ORG_CD
            , CASE WHEN RLTN_ORG_CD IS NOT NULL THEN F_ORG_INFO(RLTN_ORG_CD,'1') ELSE '' END COPT_OFI_NM
            , AFF_CD
            , AUD_STEP_CD
            , RLTN_ORG_CD
            , SBCN_REGI_REQ_DT
            , (SELECT DECODE(CHF_CMTR_CNB, NULL, '', F_USR_INFO(ST1.CHF_CMTR_CNB, '2')||DECODE(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1), 0, '', ' 외 ' || TO_CHAR(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1))) )
                   FROM TBBADDED116L ST1
                  WHERE ST1.AUD_YR = #{audYr} AND ST1.AUD_NO = #{audNo} AND ST1.TASK_DVSN_CD = '9'
                    AND ST1.DOC_ID = #{refDocId}
                    AND ST1.SRNO = (SELECT MAX(SRNO) FROM TBBADDED116L WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND TASK_DVSN_CD = '9' AND DOC_ID = ST1.DOC_ID)) AS CHF_CMTR_NM
            , TO_CHAR(TO_DATE(SBCN_DY),'YYYY"-"MM"-"DD') AS SBCN_DY
            , AUD_SBJ_NM
            , F_MNG_KND_AUDYRNO(AUD_YR, AUD_NO, T1.AUD_KND_CD, '-') AUD_YR_NO
            , F_CODE_NM('1000772', SBCN_VT_CD) AS SBCN_VT_NM 
            , SBCN_NBC
        FROM 
            TBBADDED145M T1
            JOIN
            TBBADDED146M T2
            USING(AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID, APVR_CD, AFF_SNO)
            JOIN
            TBBADDED113M T3
            USING(AUD_YR, AUD_NO, DOC_ID, APVR_CD, AFF_SNO, DSP_RQ_SNO)
            JOIN
            TBBADDED112M T4
            USING(AUD_YR, AUD_NO)
        WHERE
            AUD_YR =  #{audYr}
        AND AUD_NO =  #{audNo}
        AND AUD_STEP_CD = 'A1070'
        AND APVR_CD = '0010600'
        AND DOC_ID = #{refDocId}
        AND SBCN_REGI_REQ_DT = #{sbcnRegiReqDt}
        ORDER BY T1.SORT_SNO,T2.SORT_SNO, AFF_CD, AFF_DSP_CD
          ]]>
    </select>
    
    <select id="selectSbmtAgdList" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbmtAgdList */
            SELECT 
                F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-')||'-'||T1.AFF_CD AS AFF_CD_NM
                , T2.TITLE_NM
                , AGGR_CONCAT(T3.DSP_RQ_NM||DECODE(T3.DSP_RQ_CNT,1,'',T3.DSP_RQ_CNT), ',')  AS DSP_RQ_NM
                , (SELECT DECODE(CHF_CMTR_CNB, NULL, '', F_USR_INFO(ST1.CHF_CMTR_CNB, '2')||DECODE(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1), 0, '', ' 외 ' || TO_CHAR(DECODE(ST1.CHF_CMTR1_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR2_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR3_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR4_CNB, NULL, 0, 1) + DECODE(ST1.CHF_CMTR5_CNB, NULL, 0, 1))) )
                       FROM TBBADDED116L ST1
                      WHERE ST1.AUD_YR = #{audYr} AND ST1.AUD_NO = #{audNo} AND ST1.TASK_DVSN_CD = '9'
                        AND ST1.DOC_ID = T1.DOC_ID
                        AND ST1.SRNO = (SELECT MAX(SRNO) FROM TBBADDED116L WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND TASK_DVSN_CD = '9' AND DOC_ID = ST1.DOC_ID)) AS CHF_CMTR_NM
                , T1.SBMT_DVSN_NO||'소위' AS SBMT_DVSN_NM
                , TO_CHAR(TO_DATE(T1.SBMT_PLAN_DT),'YYYY"-"MM"-"DD') AS SBMT_PLAN_DT
                , T1.SBMT_REL_CON
                , (SELECT NVL(SUM(DECODE(ATTEN_NAME,NULL,0,1)+DECODE(AGT_NAME,NULL,0,1)),0)
                     FROM TBBADDED114D ST1
                    WHERE ST1.AUD_YR = T1.AUD_YR
                      AND ST1.AUD_NO = T1.AUD_NO
                      AND ST1.AUD_STEP_CD = T1.AUD_STEP_CD
                      AND ST1.DOC_ID = T1.DOC_ID
                      AND ST1.APVR_CD = T1.APVR_CD
                      AND ST1.AFF_SNO = T1.AFF_SNO
                      AND ST1.SBMT_SEQ = T1.SBMT_SEQ
                      AND ST1.SBMT_DTL_DVSN NOT IN ('90')) AS SBMT_REL_PER
                , (SELECT NVL(SUM(DECODE(SBMT_FILE_SEQ,NULL,0,1)),0)
                     FROM TBBADDED114L ST2
                    WHERE ST2.AUD_YR = T1.AUD_YR
                      AND ST2.AUD_NO = T1.AUD_NO
                      AND ST2.AUD_STEP_CD = T1.AUD_STEP_CD
                      AND ST2.DOC_ID = T1.DOC_ID
                      AND ST2.APVR_CD = T1.APVR_CD
                      AND ST2.AFF_SNO = T1.AFF_SNO
                      AND ST2.SBMT_SEQ = T1.SBMT_SEQ
                   ) AS SBMT_REL_DOC         
                , NVL(TO_CHAR(T1.SBMT_REQ_DT,'YYYY"-"MM"-"DD'),'미요청') AS SBMT_REQ_DT
                , T1.SBMT_NO
                , NVL(TO_CHAR(TO_DATE(T1.SBMT_FIX_DT),'YYYY"-"MM"-"DD'),'미확정') AS SBMT_FIX_DT
                , DECODE(T1.SBMT_FIX_DH,NULL,'미확정',REPLACE(T1.SBMT_FIX_DH,':','시')||'분') AS SBMT_FIX_DH
                , F_CODE_NM('1000808', T1.SBMT_STA_CD) AS SBMT_STA_NM
                , T1.AUD_YR 
                , T1.AUD_NO 
                , T1.AUD_STEP_CD 
                , T1.DOC_ID 
                , T1.APVR_CD 
                , T1.AFF_SNO 
                , T1.SBMT_SEQ 
                , T1.AUD_MAIN_STEP_SNO
                , DECODE(T1.SBMT_REQ_DT, NULL, 'N', 'Y') AS SBMT_REQ_YN
                , T1.SBMT_PLAN_DH
                , (SELECT AA.MNG_DPT_CD
				     FROM TBBADDED001M AA
					WHERE AA.AUD_YR = T1.AUD_YR 
					  AND AA.AUD_NO = T1.AUD_NO  ) AS MNG_DPT_CD
              FROM TBBADDED114M T1
                   INNER JOIN TBBADDED145M T2
                   ON (T1.AUD_YR = T2.AUD_YR
                       AND T1.AUD_NO = T2.AUD_NO
                       AND T1.AUD_STEP_CD = T2.AUD_STEP_CD
                       AND T1.DOC_ID = T2.DOC_ID
                       AND T1.APVR_CD = T2.APVR_CD
                       AND T1.AFF_SNO = T2.AFF_SNO)
                   INNER JOIN ( SELECT 
                                    ST1.AUD_YR
                                   , ST1.AUD_NO
                                   , ST1.AUD_STEP_CD
                                   , ST1.DOC_ID
                                   , ST1.APVR_CD
                                   , ST1.AFF_SNO
                                   , ST1.SBMT_SEQ
                                   , F_CODE_NM('1000002', ST2.DSP_RQ_CD) AS DSP_RQ_NM
                                   , COUNT(ST2.DSP_RQ_CD) AS DSP_RQ_CNT
                                 FROM TBBADDED114D ST1
                                      INNER JOIN TBBADDED146M ST2
                                      ON (ST1.AUD_YR = ST2.AUD_YR
                                          AND ST1.AUD_NO = ST2.AUD_NO
                                          AND ST1.AUD_STEP_CD = ST2.AUD_STEP_CD
                                          AND ST1.DOC_ID = ST2.DOC_ID
                                          AND ST1.APVR_CD = ST2.APVR_CD
                                          AND ST1.AFF_SNO = ST2.AFF_SNO
                                          AND ST1.DSP_RQ_SNO = ST2.DSP_RQ_SNO)
                                GROUP BY ST1.AUD_YR, ST1.AUD_NO, ST1.AUD_STEP_CD, ST1.DOC_ID, ST1.APVR_CD
                                        , ST1.AFF_SNO, ST1.SBMT_SEQ, ST2.DSP_RQ_CD
                                ) T3
                   ON (T1.AUD_YR = T3.AUD_YR
                       AND T1.AUD_NO = T3.AUD_NO
                       AND T1.AUD_STEP_CD = T3.AUD_STEP_CD
                       AND T1.DOC_ID = T3.DOC_ID
                       AND T1.APVR_CD = T3.APVR_CD
                       AND T1.AFF_SNO = T3.AFF_SNO
                       AND T1.SBMT_SEQ = T3.SBMT_SEQ)
                   INNER JOIN TBBADDED112M T4
                   ON (T1.AUD_YR = T4.AUD_YR
                       AND T1.AUD_NO = T4.AUD_NO)
             WHERE 1=1
                  AND T1.AUD_YR = #{audYr}
                  AND T1.AUD_NO = #{audNo}
             GROUP BY T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, T1.AFF_CD, T2.TITLE_NM, T4.CHF_CMTR_ID, T1.SBMT_PLAN_DT, T1.SBMT_FIX_DH
                , T1.SBMT_REL_CON, T1.SBMT_REL_PER, T1.SBMT_REQ_DT, T1.SBMT_NO, T1.SBMT_STA_CD, T1.AUD_YR ,T1.SBMT_PLAN_DH, T1.SBMT_DVSN_NO
                , T1.AUD_NO, T1.AUD_STEP_CD, T1.DOC_ID, T1.APVR_CD, T1.AFF_SNO, T1.SBMT_SEQ, T1.SBMT_FIX_DT, T1.AUD_MAIN_STEP_SNO
             ORDER BY SBMT_FIX_DT DESC, SBMT_NO, SBMT_SEQ
    </select>
    
    <update id="saveSbmtList" parameterType="paramMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.saveSbmtList */
        <![CDATA[
        UPDATE TBBADDED114M
        SET 
            SBMT_PLAN_DT = REPLACE(#{sbmtPlanDt},'-'),
            SBMT_REL_CON = #{sbmtRelCon},
            SBMT_PLAN_DH = #{sbmtPlanDh},
            FNL_USR_ID  = #{usrId},
            FNL_DEAL_DPT_CD = #{dptCd},
            FNL_MDF_DH = SYSDATE,
            FNL_MNU_ID = #{menuNo}
        WHERE 
                AUD_YR = #{audYr}
        AND AUD_NO = #{audNo}
        AND AUD_STEP_CD = #{audStepCd}
        AND DOC_ID = #{docId} 
        AND APVR_CD = #{apvrCd}
        AND AFF_SNO = #{affSno}
        AND SBMT_SEQ = #{sbmtSeq}
        ]]>
    </update>
    
    <update id="saveSbcnRptr" parameterType="paramMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.saveSbcnRptr */
        <![CDATA[
        UPDATE TBBADDED113M
        SET 
            SBCN_RPTR = #{sbcnRptr},
            SBCN_PRSS_DPT_NM = #{sbcnPrssDptNm},
            FNL_USR_ID  = #{usrId},
            FNL_DEAL_DPT_CD = #{dptCd},
            FNL_MDF_DH = SYSDATE,
            FNL_MNU_ID = #{menuNo}
        WHERE 
                AUD_YR = #{audYr}
        AND AUD_NO = #{audNo}
        AND DOC_ID = #{docId}
        AND SBCN_REGI_REQ_DT = REPLACE(#{sbcnRegiReqDt},'-')
        ]]>
    </update>
    
    <update id="updateSbmtStaCd" parameterType="paramMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.updateSbmtStaCd */
        UPDATE TBBADDED114M
        SET 
            SBMT_STA_CD = #{sbmtStaCd},
            FNL_USR_ID  = #{usrId},
            FNL_DEAL_DPT_CD = #{dptCd},
            FNL_MDF_DH = SYSDATE,
            FNL_MNU_ID = #{menuNo}
        WHERE 
                AUD_YR = #{audYr}
        AND AUD_NO = #{audNo}
        AND TO_CHAR(AFF_SNO) = #{refId}
        AND SBMT_SEQ = #{refDy}
    </update>
    
    <update id="updateSbmtStaCdEtc" parameterType="paramMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.updateSbmtStaCdEtc */
        UPDATE TBBADFRE114M
        SET 
            SBMT_STA_CD = #{sbmtStaCd},
            FNL_USR_ID  = #{usrId},
            FNL_DEAL_DPT_CD = #{dptCd},
            FNL_MDF_DH = SYSDATE,
            FNL_MNU_ID = #{menuNo}
        WHERE 
                ACP_YR = #{audYr}
                AND ACP_DVSN_CD=#{acpDvsnCd}
        AND ACP_SRNO = #{audNo}
        AND SBMT_SEQ= (SELECT T1.REF_ID FROM TBBADFRE103M T1 WHERE T1.DOC_ID = (SELECT T2.REF_ID FROM TBBADFRE103M T2 WHERE T2.DOC_ID = #{docId}) )
    </update>
    
    <update id="saveSbmtReq" parameterType="paramMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.saveSbmtReq */
        <![CDATA[
        UPDATE TBBADDED114M
        SET 
            SBMT_REQ_DT = SYSDATE,
            SBMT_STA_CD = 20,
            FNL_USR_ID  = #{usrId},
            FNL_DEAL_DPT_CD = #{dptCd},
            FNL_MDF_DH = SYSDATE,
            FNL_MNU_ID = #{menuNo}
        WHERE 
                AUD_YR = #{audYr}
        AND AUD_NO = #{audNo}
        AND AUD_STEP_CD = #{audStepCd}
        AND DOC_ID = #{docId} 
        AND APVR_CD = #{apvrCd}
        AND AFF_SNO = #{affSno}
        AND SBMT_SEQ = #{sbmtSeq}
        ]]>
    </update>
    
    <delete id="deleteSbmtList">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.deleteSbmtList */
        DECLARE
            BEGIN
                /* 소위안건 삭제 */
                DELETE TBBADDED114M
                WHERE 
                        AUD_YR = #{audYr}
                AND AUD_NO = #{audNo}
                AND AUD_STEP_CD = #{audStepCd}
                AND DOC_ID = #{docId} 
                AND APVR_CD = #{apvrCd}
                AND AFF_SNO = #{affSno}
                AND SBMT_SEQ = #{sbmtSeq};
                
                /* 소위 처분요구, 참석자 삭제 */
                DELETE TBBADDED114D
                WHERE 
                    AUD_YR = #{audYr}
                AND AUD_NO =  #{audNo}
                AND AUD_STEP_CD =  #{audStepCd}
                AND DOC_ID =  #{docId}
                AND APVR_CD =  #{apvrCd}
                AND AFF_SNO =  #{affSno}
                AND SBMT_SEQ =  #{sbmtSeq};
                
                /* 소위 서면의견 파일 삭제 */
                DELETE TBBADDED114L
                WHERE 
                    AUD_YR = #{audYr}
                AND AUD_NO =  #{audNo}
                AND AUD_STEP_CD =  #{audStepCd}
                AND DOC_ID =  #{docId}
                AND APVR_CD =  #{apvrCd}
                AND AFF_SNO =  #{affSno}
                AND SBMT_SEQ =  #{sbmtSeq};
                
                /* 주요 업무프로세스 삭제 */
                DELETE TBBADDED102M
                WHERE 
                    AUD_YR = #{audYr}
                AND AUD_NO =  #{audNo}
                AND AUD_STEP_CD =  #{audStepCd}
                AND SUBSTR(AUD_MAIN_STEP_ID,0,2) = '71'
                AND AUD_MAIN_STEP_SNO = #{audMainStepSno};
                
                 /* 심의안, 심의안요약 삭제 */
                DELETE TBBADDED103M
                WHERE 
                    AUD_YR = #{audYr}
                AND AUD_NO =  #{audNo}
                AND AUD_STEP_CD =  #{audStepCd}
                AND REF_ID =  #{refId}
                AND REF_DY =  #{refDy}
                AND RPRT_CD IN ('A10700200','A10700210','A10700220','A10700300');
            END;
            
    </delete>
    
    <select id="getSysdate" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.getSysdate */
        <![CDATA[
        SELECT TO_CHAR(SYSDATE,'YYYYMMDD') AS SYS_DATE FROM DUAL
        ]]>
    </select>

    <select id="selectTskDescTxt" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectTskDescTxt */
        <![CDATA[
            SELECT 
                TSK_DESC, 
                CASE
                    WHEN CHF_CMTR_CNB IS NULL THEN '미지정'
                    ELSE F_USR_INFO(CHF_CMTR_CNB,'2')
                END CHF_CMTR_NM
            FROM 
                TBBADDED101M T1
                JOIN
                TBBADDED001M T2
                USING(AUD_YR, AUD_NO)
            WHERE 
                    AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND T1.AUD_STEP_CD = #{audStepCd}
        ]]>
    </select>
    
    
    <select id="selectSbcnRegiCnt" parameterType="paramMap"
        resultType="egovMap">
         /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbcnRegiCnt */
        <![CDATA[
            SELECT COUNT(1) AS SBCN_REGI_CNT
            FROM TBBADDED113M
            WHERE AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
        ]]>
    </select>
    
    <select id="selectSbcnRprtParam" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbcnRprtParam */
        <![CDATA[
            SELECT 
                (
                    SELECT DOC_ID /* 전용 브라우저 파라메터 > refTmpId로 : 감사보고서 DOC ID */
                    FROM 
                        (SELECT C.DOC_ID, COUNT(C.DOC_ID) AS SBCN_AGD_CNT
                            FROM TBBADDED113M C
                            WHERE
                                C.AUD_YR = #{audYr}
                            AND C.AUD_NO = #{audNo}
                            AND C.AUD_MAIN_STEP_SNO = #{audMainStepSno}
                            GROUP BY C.DOC_ID
                            ORDER BY COUNT(C.DOC_ID) DESC)
                    WHERE ROWNUM = 1
                ) AS REF_TMP_ID,
                (
                    SELECT MAX(DOC_ID) /* 전용 브라우저 파라메터 > refId : 부의안 DOC ID */
                    FROM TBBADDED103M
                    WHERE
                        AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND RPRT_CD = 'A10700500'
                    AND REF_DOC_ID = #{refDocId}
                    AND REF_DY = #{sbcnRegiReqDt}
                ) AS REF_ID,
                (
                    SELECT MAX(DOC_ID) /* 전용 브라우저 파라메터 > docId : 부의안요약 DOC ID */
                    FROM TBBADDED103M
                    WHERE
                        AUD_YR = #{audYr}
                    AND AUD_NO = #{audNo}
                    AND RPRT_CD = 'A10700600'
                    AND REF_DOC_ID = #{refDocId}
                    AND REF_DY = #{sbcnRegiReqDt}
                ) AS DOC_ID,
                (
                    SELECT NVL(MAX(DOC_ID),'') /* 전용 브라우저 파라메터 > tmpId : 부의안요약 TMP ID */
                    FROM TBFDMADM002M
                    WHERE AUD_DOC_CD = 'A10700600'
                ) AS TMP_ID
            FROM DUAL
        ]]>
    </select>
    
        <select id="selectSbmtRprtParam" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbmtRprtParam */
        <![CDATA[
            SELECT 
                (
                    SELECT NVL(MAX(DOC_ID),'') /* 전용 브라우저 파라메터 > refTmpId : 심의안 tmp id */
                    FROM TBFDMADM002M
                    WHERE AUD_DOC_CD = 'A10700200'
                ) AS REF_TMP_ID,
                (
                    SELECT NVL(MAX(DOC_ID),'') /* 전용 브라우저 파라메터 > tmpId : 심의안요약 TMP ID */
                    FROM TBFDMADM002M
                    WHERE AUD_DOC_CD = 'A10700210'
                ) AS TMP_ID
                ]]>
                <if test='docId != null and docId != ""and rprtCd == "A10700200"'>
                   ,(
                        SELECT MAX(DOC_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700210'
                        AND REF_DOC_ID =  #{docId}
                    ) AS DOC_ID,    /*심의안 요약문 DOC_ID*/
                    (
                        SELECT MAX(DOC_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700200'
                        AND DOC_ID = #{docId}
                    ) AS REF_ID     /*심의안 DOC_ID*/
                    ,(
                        SELECT MAX(REF_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700210'
                        AND REF_DOC_ID =  #{docId}
                    ) AS AFF_SNO
                </if>
                <if test='docId != null and docId != ""and rprtCd == "A10700220"'>
                   ,(
                        SELECT MAX(DOC_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700220'
                        AND DOC_ID =  #{docId}
                    ) AS DOC_ID,     /*심의안 요약문 DOC_ID*/
                    (
                        SELECT MAX(REF_DOC_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700220'
                        AND DOC_ID =  #{docId}
                    ) AS REF_ID     /*심의안 DOC_ID*/
                    ,(
                        SELECT MAX(REF_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700220'
                        AND DOC_ID =  #{docId}
                    ) AS AFF_SNO
                </if>
                <if test='docId != null and docId != ""and rprtCd == "A10700230"'>
                   ,(
                        SELECT MAX(DOC_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700230'
                        AND DOC_ID =  #{docId}
                    ) AS DOC_ID,     /*심의안 요약문 DOC_ID*/
                    (
                        SELECT MAX(REF_DOC_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700230'
                        AND DOC_ID =  #{docId}
                    ) AS REF_ID     /*심의안 DOC_ID*/
                    ,(
                        SELECT MAX(REF_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700230'
                        AND DOC_ID =  #{docId}
                    ) AS AFF_SNO
                </if>
                <if test='docId != null and docId != ""and rprtCd == "A10700210"'>
                   ,(
                        SELECT MAX(DOC_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700210'
                        AND DOC_ID =  #{docId}
                    ) AS DOC_ID,     /*심의안 요약문 DOC_ID*/
                    (
                        SELECT MAX(REF_DOC_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700210'
                        AND DOC_ID =  #{docId}
                    ) AS REF_ID     /*심의안 DOC_ID*/
                    ,(
                        SELECT MAX(REF_ID) 
                        FROM TBBADDED103M
                        WHERE
                            AUD_YR = #{audYr}
                        AND AUD_NO = #{audNo}
                        AND RPRT_CD = 'A10700210'
                        AND DOC_ID =  #{docId}
                    ) AS AFF_SNO
                </if>
            FROM DUAL
        
    </select>
    
    <select id="selectAudRprtDocId" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectAudRprtDocId */
        <![CDATA[
            SELECT DOC_ID 
                FROM 
                    (SELECT C.DOC_ID, COUNT(C.DOC_ID) AS SBCN_AGD_CNT
                        FROM TBBADDED113M C
                        WHERE
                            C.AUD_YR = #{audYr}
                        AND C.AUD_NO = #{audNo}
                        AND C.AUD_MAIN_STEP_SNO = #{audMainStepSno}
                        GROUP BY C.DOC_ID
                        ORDER BY COUNT(C.DOC_ID) DESC)
                WHERE ROWNUM = 1
        ]]>
    </select>
    
    <select id="selectChfRprtParam" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectAudRprtDocId */
        <![CDATA[
            SELECT 
                T1.REF_ID 
               , (SELECT AUD_RPRT_DVSN_CD FROM TBBADDED103M WHERE DOC_ID = T1.REF_ID) AS AUD_RPRT_DVSN_CD
              FROM TBBADDED103M T1
            WHERE T1.DOC_ID = #{docId}
        ]]>
    </select>
    
    
    <select id="selectRqsRvwParam" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectRqsRvwParam */
        <![CDATA[
            SELECT DOC_ID, RPRT_NM, APV_RQS_ID
            FROM TBBADDED103M
            WHERE AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = 'A1070'
            AND RPRT_CD = 'A10700100'
            AND REF_ID = #{refId}
            AND ROWNUM = 1
        ]]>
    </select>
    
    <select id="getApvStaCd" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.getApvStaCd */
        <![CDATA[
            SELECT APV_STA_CD
            FROM TBBADDED103M
            WHERE DOC_ID = #{docId}
        ]]>
    </select>
    
    <select id="selectChfInfo" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectChfInfo */
        <![CDATA[
           SELECT CHF_CMTR_CNB AS CHF_CMTR_ID, F_USR_INFO(CHF_CMTR_CNB,'2') AS CHF_CMTR_NM
            FROM TBBADDED103M T1
                 INNER JOIN TBBADDED116L T2
                 ON (T1.AUD_YR = T2.AUD_YR AND T1.AUD_NO = T2.AUD_NO AND T2.TASK_DVSN_CD = '9'
                    AND T2.DOC_ID = T1.REF_ID
                    AND T2.SRNO = (SELECT MAX(ST1.SRNO) FROM TBBADDED116L ST1 WHERE ST1.AUD_YR = T1.AUD_YR AND ST1.AUD_NO = T1.AUD_NO AND ST1.TASK_DVSN_CD = '9' AND ST1.DOC_ID = T2.DOC_ID))
            WHERE T1.DOC_ID = #{docId}
        ]]>
    </select>
    
    
    
    <select id="selectMppChk" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectMppChk */
		
		SELECT 
			COUNT(*) AS MppCnt
		FROM (
		      SELECT DISTINCT  
		          A1050.AFF_NO AS A1050
		         
		         , PKG_MPP.F_D50_CHK(A1050.AUD_YR, A1050.AUD_NO, A1050.AUD_STEP_CD, A1050.APVR_CD, A1050.AFF_SNO, A1050.DSP_RQ_SNO, A1050.MPP_SEQ) AS A1050_PRE_MPP
		         , PKG_MPP.F_AFF_MPP(A1050.AUD_YR, A1050.AUD_NO, A1050.AUD_STEP_CD, A1050.APVR_CD, A1050.AFF_SNO, A1050.DSP_RQ_SNO, A1050.MPP_SEQ) AS A1050_AFF_MPP
		         , PKG_MPP.F_MID_MPP_TYPE_CHG(A1050.AUD_YR, A1050.AUD_NO, A1050.AUD_STEP_CD, A1050.APVR_CD, A1050.AFF_SNO, A1050.DSP_RQ_SNO, A1050.MPP_SEQ) AS A1050_MID_MPP1
		         , PKG_MPP.F_D30_D40_CHK(A1050.AUD_YR, A1050.AUD_NO, A1050.AUD_STEP_CD, A1050.APVR_CD, A1050.AFF_SNO, A1050.DSP_RQ_SNO, A1050.MPP_SEQ, A10601.AFF_NO) AS A1050_MID_MPP2
		      	 
		         , A10601.AFF_NO AS A10601
		         
		         , PKG_MPP.F_D50_CHK(A10601.AUD_YR, A10601.AUD_NO, A10601.AUD_STEP_CD, A10601.APVR_CD, A10601.AFF_SNO, A10601.DSP_RQ_SNO, A10601.MPP_SEQ) AS A10601_PRE_MPP
		         , PKG_MPP.F_AFF_MPP(A10601.AUD_YR, A10601.AUD_NO, A10601.AUD_STEP_CD, A10601.APVR_CD, A10601.AFF_SNO, A10601.DSP_RQ_SNO, A10601.MPP_SEQ) AS A10601_AFF_MPP
		         , PKG_MPP.F_MID_MPP_TYPE_CHG(A10601.AUD_YR, A10601.AUD_NO, A10601.AUD_STEP_CD, A10601.APVR_CD, A10601.AFF_SNO, A10601.DSP_RQ_SNO, A10601.MPP_SEQ) AS A10601_MID_MPP1
		         , PKG_MPP.F_D30_D40_CHK(A10601.AUD_YR, A10601.AUD_NO, A10601.AUD_STEP_CD, A10601.APVR_CD, A10601.AFF_SNO, A10601.DSP_RQ_SNO, A10601.MPP_SEQ, A10602.AFF_NO) AS A10601_MID_MPP2
		         
		         , A10602.AFF_NO AS A10602
		
		         , PKG_MPP.F_D50_CHK(A10602.AUD_YR, A10602.AUD_NO, A10602.AUD_STEP_CD, A10602.APVR_CD, A10602.AFF_SNO, A10602.DSP_RQ_SNO, A10602.MPP_SEQ) AS A10602_PRE_MPP
		         , PKG_MPP.F_AFF_MPP(A10602.AUD_YR, A10602.AUD_NO, A10602.AUD_STEP_CD, A10602.APVR_CD, A10602.AFF_SNO, A10602.DSP_RQ_SNO, A10602.MPP_SEQ) AS A10602_AFF_MPP
		         , PKG_MPP.F_MID_MPP_TYPE_CHG(A10602.AUD_YR, A10602.AUD_NO, A10602.AUD_STEP_CD, A10602.APVR_CD, A10602.AFF_SNO, A10602.DSP_RQ_SNO, A10602.MPP_SEQ) AS A10602_MID_MPP1
		         , PKG_MPP.F_D30_D40_CHK(A10602.AUD_YR, A10602.AUD_NO, A10602.AUD_STEP_CD, A10602.APVR_CD, A10602.AFF_SNO, A10602.DSP_RQ_SNO, A10602.MPP_SEQ, A10603.AFF_NO) AS A10602_MID_MPP2
		        
		         , A10603.AFF_NO AS A10603
		         
		         , PKG_MPP.F_D50_CHK(A10603.AUD_YR, A10603.AUD_NO, A10603.AUD_STEP_CD, A10603.APVR_CD, A10603.AFF_SNO, A10603.DSP_RQ_SNO, A10603.MPP_SEQ) AS A10603_PRE_MPP
		         , PKG_MPP.F_AFF_MPP(A10603.AUD_YR, A10603.AUD_NO, A10603.AUD_STEP_CD, A10603.APVR_CD, A10603.AFF_SNO, A10603.DSP_RQ_SNO, A10603.MPP_SEQ) AS A10603_AFF_MPP
		         , PKG_MPP.F_MID_MPP_TYPE_CHG(A10603.AUD_YR, A10603.AUD_NO, A10603.AUD_STEP_CD, A10603.APVR_CD, A10603.AFF_SNO, A10603.DSP_RQ_SNO, A10603.MPP_SEQ) AS A10603_MID_MPP1
		         , PKG_MPP.F_D30_D40_CHK(A10603.AUD_YR, A10603.AUD_NO, A10603.AUD_STEP_CD, A10603.APVR_CD, A10603.AFF_SNO, A10603.DSP_RQ_SNO, A10603.MPP_SEQ, A10604.AFF_NO) AS A10603_MID_MPP2
		         
		         , A10604.AFF_NO AS A10604
		         
		         , PKG_MPP.F_D50_CHK(A10604.AUD_YR, A10604.AUD_NO, A10604.AUD_STEP_CD, A10604.APVR_CD, A10604.AFF_SNO, A10604.DSP_RQ_SNO, A10604.MPP_SEQ) AS A10604_PRE_MPP
		         , PKG_MPP.F_AFF_MPP(A10604.AUD_YR, A10604.AUD_NO, A10604.AUD_STEP_CD, A10604.APVR_CD, A10604.AFF_SNO, A10604.DSP_RQ_SNO, A10604.MPP_SEQ) AS A10604_AFF_MPP
		         , PKG_MPP.F_MID_MPP_TYPE_CHG(A10604.AUD_YR, A10604.AUD_NO, A10604.AUD_STEP_CD, A10604.APVR_CD, A10604.AFF_SNO, A10604.DSP_RQ_SNO, A10604.MPP_SEQ) AS A10604_MID_MPP1
		         , PKG_MPP.F_D30_D40_CHK(A10604.AUD_YR, A10604.AUD_NO, A10604.AUD_STEP_CD, A10604.APVR_CD, A10604.AFF_SNO, A10604.DSP_RQ_SNO, A10604.MPP_SEQ, A10701.AFF_NO) AS A10604_MID_MPP2
		       
                 , A10701.AFF_NO AS A10701
                 
                 , PKG_MPP.F_D50_CHK(A10701.AUD_YR, A10701.AUD_NO, A10701.AUD_STEP_CD, A10701.APVR_CD, A10701.AFF_SNO, A10701.DSP_RQ_SNO, A10701.MPP_SEQ) AS A10701_PRE_MPP
                 , PKG_MPP.F_AFF_MPP(A10701.AUD_YR, A10701.AUD_NO, A10701.AUD_STEP_CD, A10701.APVR_CD, A10701.AFF_SNO, A10701.DSP_RQ_SNO, A10701.MPP_SEQ) AS A10701_AFF_MPP
                 , PKG_MPP.F_MID_MPP_TYPE_CHG(A10701.AUD_YR, A10701.AUD_NO, A10701.AUD_STEP_CD, A10701.APVR_CD, A10701.AFF_SNO, A10701.DSP_RQ_SNO, A10701.MPP_SEQ) AS A10701_MID_MPP1
                 , PKG_MPP.F_D30_D40_CHK(A10701.AUD_YR, A10701.AUD_NO, A10701.AUD_STEP_CD, A10701.APVR_CD, A10701.AFF_SNO, A10701.DSP_RQ_SNO, A10701.MPP_SEQ, A10702.AFF_NO) AS A10701_MID_MPP2
                
                 , A10702.AFF_NO AS A10702

                 , PKG_MPP.F_D50_CHK(A10702.AUD_YR, A10702.AUD_NO, A10702.AUD_STEP_CD, A10702.APVR_CD, A10702.AFF_SNO, A10702.DSP_RQ_SNO, A10702.MPP_SEQ) AS A10702_PRE_MPP
                 , PKG_MPP.F_AFF_MPP(A10702.AUD_YR, A10702.AUD_NO, A10702.AUD_STEP_CD, A10702.APVR_CD, A10702.AFF_SNO, A10702.DSP_RQ_SNO, A10702.MPP_SEQ) AS A10702_AFF_MPP
                 , PKG_MPP.F_MID_MPP_TYPE_CHG(A10702.AUD_YR, A10702.AUD_NO, A10702.AUD_STEP_CD, A10702.APVR_CD, A10702.AFF_SNO, A10702.DSP_RQ_SNO, A10702.MPP_SEQ) AS A10702_MID_MPP1
                 , PKG_MPP.F_D30_D40_CHK(A10702.AUD_YR, A10702.AUD_NO, A10702.AUD_STEP_CD, A10702.APVR_CD, A10702.AFF_SNO, A10702.DSP_RQ_SNO, A10702.MPP_SEQ, A10703.AFF_NO) AS A10702_MID_MPP2
                 
                 , A10703.AFF_NO AS A10703
                 
                 , PKG_MPP.F_D50_CHK(A10703.AUD_YR, A10703.AUD_NO, A10703.AUD_STEP_CD, A10703.APVR_CD, A10703.AFF_SNO, A10703.DSP_RQ_SNO, A10703.MPP_SEQ) AS A10703_PRE_MPP
                 , PKG_MPP.F_AFF_MPP(A10703.AUD_YR, A10703.AUD_NO, A10703.AUD_STEP_CD, A10703.APVR_CD, A10703.AFF_SNO, A10703.DSP_RQ_SNO, A10703.MPP_SEQ) AS A10703_AFF_MPP
                 , PKG_MPP.F_MID_MPP_TYPE_CHG(A10703.AUD_YR, A10703.AUD_NO, A10703.AUD_STEP_CD, A10703.APVR_CD, A10703.AFF_SNO, A10703.DSP_RQ_SNO, A10703.MPP_SEQ) AS A10703_MID_MPP1
                 , PKG_MPP.F_D30_D40_CHK(A10703.AUD_YR, A10703.AUD_NO, A10703.AUD_STEP_CD, A10703.APVR_CD, A10703.AFF_SNO, A10703.DSP_RQ_SNO, A10703.MPP_SEQ, '') AS A10703_MID_MPP2
		         
		      FROM (
		      
		      		SELECT AA.AUD_YR
						 , AA.AUD_NO
						 , AA.AUD_STEP_CD
						 , CC.DOC_ID
						 , AA.APVR_CD
						 , BB.AFF_SNO
						 , CC.DSP_RQ_SNO
						 , AA.MPP_SEQ
						 , 0 AS AFF_DVSN_SEQ
						 , AA.PRE_AFF_NO
		                 , AA.AFF_NO
		              FROM TBBADDED147M AA
		                 , TBBADDED145M BB
		                 , TBBADDED146M CC
		             WHERE AA.AUD_YR =  #{audYr}
		               AND AA.AUD_NO = #{audNo}
		               AND AA.AUD_STEP_CD = 'A1050'
		               AND AA.AUD_YR = BB.AUD_YR
		               AND AA.AUD_YR = CC.AUD_YR
		               AND AA.AUD_NO = BB.AUD_NO
		               AND AA.AUD_NO = CC.AUD_NO
		               AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
		               AND AA.AUD_STEP_CD = CC.AUD_STEP_CD
					   AND AA.APVR_CD = BB.APVR_CD
		               AND AA.APVR_CD = CC.APVR_CD
		               AND AA.AFF_SNO = BB.AFF_SNO
		               AND AA.AFF_SNO = CC.AFF_SNO
		               AND AA.DSP_RQ_SNO = CC.DSP_RQ_SNO
		          ) AS A1050
		         
		          FULL OUTER JOIN (
		          	SELECT AA.AUD_YR
		          	  	 , AA.AUD_NO
		          	  	 , AA.AUD_STEP_CD
		          	  	 , CC.DOC_ID
		          	  	 , AA.APVR_CD
		          	  	 , BB.AFF_SNO
		          	  	 , CC.DSP_RQ_SNO
		          	  	 , AA.MPP_SEQ
		          	  	 , 0 AS AFF_DVSN_SEQ
		          	  	 , AA.PRE_AFF_NO
		                 , AA.AFF_NO
		              FROM TBBADDED147M AA
		                 , TBBADDED145M BB
		                 , TBBADDED146M CC
		            WHERE AA.AUD_YR =  #{audYr}
		               AND AA.AUD_NO = #{audNo}
		               AND AA.AUD_STEP_CD = 'A1060' 
		               AND AA.APVR_CD = '0013600'
		               AND AA.AUD_YR = BB.AUD_YR
		               AND AA.AUD_YR = CC.AUD_YR
		               AND AA.AUD_NO = BB.AUD_NO
		               AND AA.AUD_NO = CC.AUD_NO
		               AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
		               AND AA.AUD_STEP_CD = CC.AUD_STEP_CD
					   AND AA.APVR_CD = BB.APVR_CD
		               AND AA.APVR_CD = CC.APVR_CD
		               AND AA.AFF_SNO = BB.AFF_SNO
		               AND AA.AFF_SNO = CC.AFF_SNO
		               AND AA.DSP_RQ_SNO = CC.DSP_RQ_SNO
		             ) AS A10601 ON A1050.AFF_NO = A10601.PRE_AFF_NO
		        
		          FULL OUTER JOIN (
		          SELECT AA.AUD_YR
		          	  	 , AA.AUD_NO
		          	  	 , AA.AUD_STEP_CD
		          	  	 , CC.DOC_ID
		          	  	 , AA.APVR_CD
		          	  	 , BB.AFF_SNO
		          	  	 , CC.DSP_RQ_SNO
		          	  	 , AA.MPP_SEQ
		          	  	 , 0 AS AFF_DVSN_SEQ
		          	  	 , AA.PRE_AFF_NO
		                 , AA.AFF_NO
		              FROM TBBADDED147M AA
		                 , TBBADDED145M BB
		                 , TBBADDED146M CC
		            WHERE AA.AUD_YR =  #{audYr}
		               AND AA.AUD_NO = #{audNo}
		               AND AA.AUD_STEP_CD = 'A1060' 
		               AND AA.APVR_CD IN ('0015800', '0035100', '0058100')
		               AND AA.AUD_YR = BB.AUD_YR
		               AND AA.AUD_YR = CC.AUD_YR
		               AND AA.AUD_NO = BB.AUD_NO
		               AND AA.AUD_NO = CC.AUD_NO
		               AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
		               AND AA.AUD_STEP_CD = CC.AUD_STEP_CD
					   AND AA.APVR_CD = BB.APVR_CD
		               AND AA.APVR_CD = CC.APVR_CD
		               AND AA.AFF_SNO = BB.AFF_SNO
		               AND AA.AFF_SNO = CC.AFF_SNO
		               AND AA.DSP_RQ_SNO = CC.DSP_RQ_SNO
		           ) AS A10602 ON A10601.AFF_NO = A10602.PRE_AFF_NO
		          
		          FULL OUTER JOIN (
		          	SELECT AA.AUD_YR
		          	  	 , AA.AUD_NO
		          	  	 , AA.AUD_STEP_CD
		          	  	 , CC.DOC_ID
		          	  	 , AA.APVR_CD
		          	  	 , BB.AFF_SNO
		          	  	 , CC.DSP_RQ_SNO
		          	  	 , AA.MPP_SEQ
		          	  	 , 0 AS AFF_DVSN_SEQ
		          	  	 , AA.PRE_AFF_NO
		                 , AA.AFF_NO
		              FROM TBBADDED147M AA
		                 , TBBADDED145M BB
		                 , TBBADDED146M CC
		            WHERE AA.AUD_YR =  #{audYr}
		               AND AA.AUD_NO = #{audNo}
		               AND AA.AUD_STEP_CD = 'A1060' 
		               AND AA.APVR_CD IN ('0055600','0045900') 
		               AND AA.AUD_YR = BB.AUD_YR
		               AND AA.AUD_YR = CC.AUD_YR
		               AND AA.AUD_NO = BB.AUD_NO
		               AND AA.AUD_NO = CC.AUD_NO
		               AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
		               AND AA.AUD_STEP_CD = CC.AUD_STEP_CD
					   AND AA.APVR_CD = BB.APVR_CD
		               AND AA.APVR_CD = CC.APVR_CD
		               AND AA.AFF_SNO = BB.AFF_SNO
		               AND AA.AFF_SNO = CC.AFF_SNO
		               AND AA.DSP_RQ_SNO = CC.DSP_RQ_SNO
		            ) AS A10603 ON A10602.AFF_NO = A10603.PRE_AFF_NO
		         
		          FULL OUTER JOIN (
		          SELECT AA.AUD_YR
		          	  	 , AA.AUD_NO
		          	  	 , AA.AUD_STEP_CD
		          	  	 , CC.DOC_ID
		          	  	 , AA.APVR_CD
		          	  	 , BB.AFF_SNO
		          	  	 , CC.DSP_RQ_SNO
		          	  	 , AA.MPP_SEQ
		          	  	 , 0 AS AFF_DVSN_SEQ
		          	  	 , AA.PRE_AFF_NO
		                 , AA.AFF_NO
		              FROM TBBADDED147M AA
		                 , TBBADDED145M BB
		                 , TBBADDED146M CC
		            WHERE AA.AUD_YR =  #{audYr}
		               AND AA.AUD_NO = #{audNo}
		               AND AA.AUD_STEP_CD = 'A1060' 
		               AND AA.APVR_CD = '0055700'
		               AND AA.AUD_YR = BB.AUD_YR
		               AND AA.AUD_YR = CC.AUD_YR
		               AND AA.AUD_NO = BB.AUD_NO
		               AND AA.AUD_NO = CC.AUD_NO
		               AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
		               AND AA.AUD_STEP_CD = CC.AUD_STEP_CD
					   AND AA.APVR_CD = BB.APVR_CD
		               AND AA.APVR_CD = CC.APVR_CD
		               AND AA.AFF_SNO = BB.AFF_SNO
		               AND AA.AFF_SNO = CC.AFF_SNO
		               AND AA.DSP_RQ_SNO = CC.DSP_RQ_SNO
		            ) AS A10604 ON A10603.AFF_NO = A10604.PRE_AFF_NO
		          
		          FULL OUTER JOIN (
		          SELECT AA.AUD_YR
		          	  	 , AA.AUD_NO
		          	  	 , AA.AUD_STEP_CD
		          	  	 , CC.DOC_ID
		          	  	 , AA.APVR_CD
		          	  	 , BB.AFF_SNO
		          	  	 , CC.DSP_RQ_SNO
		          	  	 , AA.MPP_SEQ
		          	  	 , 0 AS AFF_DVSN_SEQ
		          	  	 , AA.PRE_AFF_NO
		                 , AA.AFF_NO
		              FROM TBBADDED147M AA
		                 , TBBADDED145M BB
		                 , TBBADDED146M CC
		            WHERE AA.AUD_YR =  #{audYr}
		               AND AA.AUD_NO = #{audNo}
		               AND AA.AUD_STEP_CD = 'A1070' 
		               AND AA.APVR_CD = '0010600'
		               AND AA.AUD_YR = BB.AUD_YR
		               AND AA.AUD_YR = CC.AUD_YR
		               AND AA.AUD_NO = BB.AUD_NO
		               AND AA.AUD_NO = CC.AUD_NO
		               AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
		               AND AA.AUD_STEP_CD = CC.AUD_STEP_CD
					   AND AA.APVR_CD = BB.APVR_CD
		               AND AA.APVR_CD = CC.APVR_CD
		               AND AA.AFF_SNO = BB.AFF_SNO
		               AND AA.AFF_SNO = CC.AFF_SNO
		               AND AA.DSP_RQ_SNO = CC.DSP_RQ_SNO
		            ) AS A10701 ON A10604.AFF_NO = A10701.PRE_AFF_NO
		            
		            FULL OUTER JOIN (
                  SELECT AA.AUD_YR
                  	  	 , AA.AUD_NO
                  	  	 , AA.AUD_STEP_CD
                  	  	 , CC.DOC_ID
                  	  	 , AA.APVR_CD
                  	  	 , BB.AFF_SNO
                  	  	 , CC.DSP_RQ_SNO
                  	  	 , AA.MPP_SEQ
                  	  	 , 0 AS AFF_DVSN_SEQ
                  	  	 , AA.PRE_AFF_NO
                         , AA.AFF_NO
                      FROM TBBADDED147M AA
                         , TBBADDED145M BB
                         , TBBADDED146M CC
                    WHERE AA.AUD_YR =  #{audYr}
                       AND AA.AUD_NO = #{audNo}
                       AND AA.AUD_STEP_CD = 'A1070' 
                       AND AA.APVR_CD = 'A107001'
                       AND AA.AUD_YR = BB.AUD_YR
                       AND AA.AUD_YR = CC.AUD_YR
                       AND AA.AUD_NO = BB.AUD_NO
                       AND AA.AUD_NO = CC.AUD_NO
                       AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                       AND AA.AUD_STEP_CD = CC.AUD_STEP_CD
					   AND AA.APVR_CD = BB.APVR_CD
                       AND AA.APVR_CD = CC.APVR_CD
                       AND AA.AFF_SNO = BB.AFF_SNO
                       AND AA.AFF_SNO = CC.AFF_SNO
                       AND AA.DSP_RQ_SNO = CC.DSP_RQ_SNO
                 ) AS A10702 ON A10701.AFF_NO = A10702.PRE_AFF_NO
                 
                 FULL OUTER JOIN (
                  	SELECT AA.AUD_YR
                  	  	 , AA.AUD_NO
                  	  	 , AA.AUD_STEP_CD
                  	  	 , CC.DOC_ID
                  	  	 , AA.APVR_CD
                  	  	 , BB.AFF_SNO
                  	  	 , CC.DSP_RQ_SNO
                  	  	 , AA.MPP_SEQ
                  	  	 , 0 AS AFF_DVSN_SEQ
                  	  	 , AA.PRE_AFF_NO
                         , AA.AFF_NO
                      FROM TBBADDED147M AA
                         , TBBADDED145M BB
                         , TBBADDED146M CC
                     WHERE AA.AUD_YR =  #{audYr}
                       AND AA.AUD_NO = #{audNo}
                       AND AA.AUD_STEP_CD = 'A1070' 
                       AND AA.APVR_CD = 'A1070'
                       AND AA.AUD_YR = BB.AUD_YR
                       AND AA.AUD_YR = CC.AUD_YR
                       AND AA.AUD_NO = BB.AUD_NO
                       AND AA.AUD_NO = CC.AUD_NO
                       AND AA.AUD_STEP_CD = BB.AUD_STEP_CD
                       AND AA.AUD_STEP_CD = CC.AUD_STEP_CD
					   AND AA.APVR_CD = BB.APVR_CD
                       AND AA.APVR_CD = CC.APVR_CD
                       AND AA.AFF_SNO = BB.AFF_SNO
                       AND AA.AFF_SNO = CC.AFF_SNO
                       AND AA.DSP_RQ_SNO = CC.DSP_RQ_SNO
                     ) AS A10703 ON A10702.AFF_NO = A10703.PRE_AFF_NO
		          
				WHERE 1=1
				ORDER BY A1050
					, A10601
		            , A10602
		            , A10603
		            , A10604
		            , A10701
		            , A10702
		            , A10703
		            ) AS AAA
		WHERE 
			A1050_PRE_MPP = '11|입력|입력'        
			OR A1050_AFF_MPP = '10|입력|입력'
			OR A1050_MID_MPP2 = '08|입력|입력'
			OR (A1050_MID_MPP2 IS NULL AND A1050_MID_MPP1 = '12|입력|입력')
			
			OR A10601_PRE_MPP = '11|입력|입력'        
			OR A10601_AFF_MPP = '10|입력|입력'
			OR A10601_MID_MPP2 = '08|입력|입력'
			OR (A10601_MID_MPP2 IS NULL AND A10601_MID_MPP1 = '12|입력|입력')
			
			OR A10602_PRE_MPP = '11|입력|입력'        
			OR A10602_AFF_MPP = '10|입력|입력'
			OR A10602_MID_MPP2 = '08|입력|입력'
			OR (A10602_MID_MPP2 IS NULL AND A10602_MID_MPP1 = '12|입력|입력')
			
			OR A10603_PRE_MPP = '11|입력|입력'        
			OR A10603_AFF_MPP = '10|입력|입력'
			OR A10603_MID_MPP2 = '08|입력|입력'
			OR (A10603_MID_MPP2 IS NULL AND A10603_MID_MPP1 = '12|입력|입력')
			
			OR A10604_PRE_MPP = '11|입력|입력'        
			OR A10604_AFF_MPP = '10|입력|입력'
			OR A10604_MID_MPP2 = '08|입력|입력'
			OR (A10604_MID_MPP2 IS NULL AND A10604_MID_MPP1 = '12|입력|입력') 
			
			OR A10701_PRE_MPP = '11|입력|입력'        
			OR A10701_AFF_MPP = '10|입력|입력'
			OR A10701_MID_MPP2 = '08|입력|입력'
			OR (A10701_MID_MPP2 IS NULL AND A10701_MID_MPP1 = '12|입력|입력') 
			
			OR A10702_PRE_MPP = '11|입력|입력'        
			OR A10702_AFF_MPP = '10|입력|입력'
			OR A10702_MID_MPP2 = '08|입력|입력'
			OR (A10702_MID_MPP2 IS NULL AND A10702_MID_MPP1 = '12|입력|입력') 
			
			OR A10703_PRE_MPP = '11|입력|입력'        
			OR A10703_AFF_MPP = '10|입력|입력'
			OR A10703_MID_MPP2 = '08|입력|입력'
			OR (A10703_MID_MPP2 IS NULL AND A10703_MID_MPP1 = '12|입력|입력') 
		
    </select>
    
    
    
    
    
    <select id="selectMainTskPrcsList" parameterType="paramMap" resultType="egovMap" >
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectMainTskPrcsList */
        /*실지감사 주요업무 프로세스 sql*/
        SELECT A.AUD_MAIN_STEP_ID  /*주요업무코드*/
             , A.AUD_STEP_CD /*감사단계코드*/
             , A.AUD_MAIN_STEP_SNO  /*주요업무순번 */
             , A.AUD_MAIN_SEQ_W /*주요업무순서_가로 */
             , A.AUD_MAIN_SEQ_H /*주요업무순서_세로 */
             , CASE WHEN AUD_MAIN_STEP_ID = '720401' THEN  
                    CASE WHEN (SELECT TO_DATE(MIN(SBCN_DY))     /* 부의실시의 경우 부의일자가 현재 이전일때 Y */ 
                                 FROM TBBADDED113M ST1
                                 WHERE ST1.AUD_YR = A.AUD_YR
                                 AND ST1.AUD_NO =  A.AUD_NO
                                 AND ST1.AUD_MAIN_STEP_SNO = A.AUD_MAIN_STEP_SNO) <![CDATA[<]]> SYSDATE THEN 'Y' ELSE 'N' END
                    ELSE A.CMPT_YN
             END AS CMPT_YN /*완료여부*/
             , A.AUD_GRN_NO  /*감사부여번호*/
             , A.AUD_DOC_CD /*문서ID*/
             , TRIM(A.MAIN_JOB_NM) AS MAIN_JOB_NM /*주요업무명*/
             , TRIM(A.LINK_TYPE) AS LINK_TYPE/*링크유형*/
             , DECODE(TRIM(A.LINK_TYPE), 'NAN', ''
                                 , 'POP', A.LINK_URL
                                 , 'FNC', A.LINK_URL
                                 , (SELECT DOC_ID
                                      FROM TBFDMADM002M B
                                     WHERE A.AUD_DOC_CD = B.AUD_DOC_CD
                                       AND B.DOC_KND_CD = DECODE(A.LINK_TYPE, 'DOC', '10', '20')
                                       AND NVL(AUD_RPRT_TYPE_CD, SUBSTR(A.AUD_KND_CD, 3, 3)) = SUBSTR(A.AUD_KND_CD, 3, 3)
                                   <if test='audStepCd == "A1050"'>
                                       AND B.DTIL_AUD_DOC_NO = DECODE(B.AUD_DOC_CD,'A10500100','162',
                                                                    (SELECT CASE WHEN T1.REQ_DVSN_CD IN ('2', '3') THEN '394'
                                                                            ELSE '163'
                                                                       END
                                                                  FROM TBBADDED001M T1
                                                                 WHERE T1.AUD_YR = #{audYr}
                                                                   AND T1.AUD_NO = #{audNo}
                                                                  ))
                                   </if>
                                   )
                     ) AS LINK_URL /*링크주소*/
          FROM TBBADDED102M A
         WHERE 1=1
        <if test='audYr != null and audYr != ""'>
           AND A.AUD_YR = #{audYr} /* PARAM : 감사년도 */
        </if>
        <if test='audNo != null and audNo != ""'>
           AND A.AUD_NO = #{audNo}/* PARAM : 감사연번(내부  pk 번호) */
        </if>
        <if test='audKndCd != null and audKndCd != ""'>
           AND A.AUD_KND_CD = #{audKndCd}
        </if>
        <if test='audStepCd != null and audStepCd != ""'>
           AND A.AUD_STEP_CD = #{audStepCd} /* PARAM : 감사단계코드  */
        </if>
        <if test='audMainStepSno != null and audMainStepSno != ""'>
           AND A.AUD_MAIN_STEP_SNO = #{audMainStepSno} /* PARAM : 주요업무 순번  */
        </if>
        <if test='audMainStepDsvnCd != null and audMainStepDsvnCd != ""'>
           AND SUBSTR(A.AUD_MAIN_STEP_ID,0,2) = #{audMainStepDsvnCd} /* PARAM : 주요업무구분코드(AUD_MAIN_STEP_ID 앞 2자리) */
        </if>
         ORDER BY A.AUD_MAIN_STEP_SNO, A.AUD_MAIN_SEQ_W ASC
    </select>
    
    <select id="selectApvStaCd" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectApvStaCd */
        <![CDATA[
            SELECT NVL(MAX(APV_STA_CD),0) AS APV_STA_CD
            FROM TBBADDED103M
            WHERE DOC_ID = #{docId}
        ]]>
    </select>
    
    <select id="selectSbcnRprtInfo" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbcnRprtInfo */
        SELECT 
            DOC_ID AS SBCN_RPT_DOC_ID
            , (SELECT DOC_ID
                 FROM (
                       SELECT ST2.DOC_ID, ST2.AUD_RPRT_DVSN_CD
                         FROM TBBADDED113M ST1
                              INNER JOIN TBBADDED103M ST2
                              ON (ST1.AUD_YR = ST2.AUD_YR
                                  AND ST1.AUD_NO = ST2.AUD_NO
                                  AND ST1.DOC_ID = ST2.DOC_ID)
                        WHERE ST1.AUD_YR = #{audYr}
                          AND ST1.AUD_NO = #{audNo}
                          AND ST1.DOC_ID = #{refDocId}
                          AND ST1.SBCN_REGI_REQ_DT = #{sbcnRegiReqDt}
                        ORDER BY AUD_RPRT_DVSN_CD 
                       )
                WHERE ROWNUM = 1) AS AUD_RPT_DOC_ID
          FROM TBBADDED103M
         WHERE AUD_YR = #{audYr}
           AND AUD_NO =  #{audNo}
           AND REF_DOC_ID = #{refDocId}
           AND RPRT_CD = 'A10700500'
           AND REF_DY= #{sbcnRegiReqDt}
    </select>
    
    <select id="validFnlAudRprt" parameterType="paramMap"
        resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.validFnlAudRprt */
        SELECT 
            DECODE(COUNT(1),0,'N',MAX(NVL(CMT_END_YN,'N'))) AS CMT_END_YN, 
            (SELECT DECODE(COUNT(1),0,'N','Y') AS FNL_AUD_RPRT_EXIST_YN
              FROM TBBADDED103M
             WHERE AUD_YR = #{audYr}
               AND AUD_NO = #{audNo}
               AND AUD_STEP_CD = 'A1070'
               AND RPRT_CD = 'A10600200'
               AND SUBSTR(AUD_RPRT_DVSN_CD,2,1) = '1'
               AND REF_DOC_ID = #{refDocId}
               AND REF_DY = #{sbcnRegiReqDt}) AS FNL_AUD_RPRT_EXIST_YN
            , NVL((SELECT APV_STA_CD 
                          FROM TBBADDED103M
                         WHERE AUD_YR = #{audYr}
                           AND AUD_NO = #{audNo}
                           AND AUD_STEP_CD = 'A1070'
                           AND RPRT_CD = 'A10600200'
                           AND SUBSTR(AUD_RPRT_DVSN_CD,2,1) = '1'
                           AND REF_DOC_ID = #{refDocId}
                           AND REF_DY = #{sbcnRegiReqDt}),'10') AS FNL_AUD_RPRT_APV_STA_CD
          FROM TBBADDED113M T1
               INNER JOIN TBBADDED120M T2
               ON (T1.SBCN_DY = T2.CMT_DY)
         WHERE AUD_YR = #{audYr}
           AND AUD_NO = #{audNo}
           AND T1.DOC_ID = #{refDocId}
           AND SBCN_REGI_REQ_DT = #{sbcnRegiReqDt}
    </select>
        
    <select id="selectChgRprtDocId" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectDocId */
        <![CDATA[
        SELECT 
            NVL(MAX(T1.DOC_ID),'') AS TMP_ID
            , MAX(T2.DOC_ID) AS DOC_ID
            , NVL(MAX(T2.REF_ID), (SELECT ST1.DOC_ID 
                        FROM TBBADDED103M ST1
                       WHERE ST1.AUD_YR = #{audYr}
                         AND ST1.AUD_NO = #{audNo}
                         AND ST1.RPRT_CD = 'A10700500'
                         AND ST1.REF_DY = #{sbcnRegiReqDt}
                         AND ST1.REF_DOC_ID = #{refDocId})) AS REF_ID
                         ,T2.APV_STA_CD AS APV_STA_CD
        FROM TBFDMADM002M T1
             LEFT OUTER JOIN TBBADDED103M T2
             ON (T2.AUD_YR = #{audYr}
                 AND T2.AUD_NO = #{audNo}
                 AND T2.RPRT_CD = T1.AUD_DOC_CD
                 AND T2.REF_DOC_ID = #{refDocId}
                 AND T2.REF_DY = #{sbcnRegiReqDt})
        WHERE T1.AUD_DOC_CD = #{rprtCd}
        GROUP BY T1.AUD_DOC_CD ,T2.APV_STA_CD
        ]]>
    </select>
    
    <insert id="insertFnlAudRpt">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.insertFnlAudRpt */
        <![CDATA[
        INSERT INTO TBBADDED103M (
                   AUD_YR
                  ,AUD_NO
                  ,AUD_STEP_CD
                  ,DOC_ID 
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM
                  ,LINK_URL
                  ,NECES_YN
                  ,APV_STA_CD
                  ,RPRT_CD
                  ,APV_RQS_ID
                  ,SND_DOC_YN
                  ,DOC_KND_CD   
                  ,AUD_RPRT_DVSN_CD
                  ,REF_ID
                  ,REF_DY
                  ,RLTN_ORG_CD
                  ,SORT_SNO
                  ,SYT_TRTM_DVSN_YN
                  ,AUD_DOC_KND_CD
                  ,CON_PGM_CD
                  ,APV_WAY_CD
                  ,DOC_WRT_ID
                  ,ONR_HNDL_NO
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH
                  ,EDT_AUTH
                  ,FNL_BAI_RPRT_YN
                  ,REF_DOC_ID
                  ,TEMPLATE_DOC_ID
            )
             SELECT AUD_YR
                  ,AUD_NO
                  ,'A1070'
                  ,#{copySbcnRptId}
                  ,AUD_KND_CD
                  ,AUD_GRN_NO
                  ,RPRT_NM||'(최종)'
                  ,REPLACE(REPLACE(REPLACE(LINK_URL,'docId='||DOC_ID,'docId='||#{copySbcnRptId}),'&rprtCd=A10600200',''),'audStepCd=A1060','audStepCd=A1070&rprtCd=A10600200')
                  ,NECES_YN
                  ,'10'
                  ,RPRT_CD
                  ,''
                  ,'N'
                  ,DOC_KND_CD   
                  ,AUD_RPRT_DVSN_CD + 1
                  ,#{audRptDocId}
                  ,#{sbcnRegiReqDt}
                  ,RLTN_ORG_CD
                  ,(SELECT MAX(SORT_SNO)+1 FROM TBBADDED103M B  WHERE AUD_YR = #{audYr} AND AUD_NO = #{audNo} AND AUD_STEP_CD = 'A1070') AS SORT_SNO
                  ,SYT_TRTM_DVSN_YN
                  ,AUD_DOC_KND_CD
                  ,CON_PGM_CD
                  ,APV_WAY_CD
                  ,DOC_WRT_ID
                  ,ONR_HNDL_NO
                  ,FRT_USR_ID
                  ,FNL_USR_ID
                  ,FNL_DEAL_DPT_CD
                  ,FNL_MNU_ID
                  ,FRT_REGI_DH
                  ,FNL_MDF_DH
                  ,'Y'
                  ,'Y'
                  ,#{audRptDocId}
                  ,TEMPLATE_DOC_ID
            FROM TBBADDED103M A
            WHERE AUD_YR = #{audYr}
             AND AUD_NO = #{audNo}
             AND AUD_STEP_CD = 'A1060'
             AND RPRT_CD = 'A10600200'
             AND DOC_ID = #{audRptDocId}
        ]]>
    </insert>
    
    <update id="updateAffRqsRefDocId" parameterType="paramMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.updateAffRqsRefDocId */
        <![CDATA[
        DECLARE
            BEGIN
                MERGE INTO TBBADDED146M T1
                USING (SELECT DISTINCT AUD_YR, AUD_NO, DOC_ID
                         FROM TBBADDED113M
                        WHERE AUD_YR = #{audYr}
                          AND AUD_NO = #{audNo}
                          AND DOC_ID = #{audRptDocId}
                          AND SBCN_REGI_REQ_DT = #{sbcnRegiReqDt}) T2
                   ON (     
                        T1.AUD_YR = T2.AUD_YR
                       AND T1.AUD_NO = T2.AUD_NO
                       AND T1.DOC_ID = T2.DOC_ID
                       AND T1.APVR_CD = 'A1070'
                      ) 
                 WHEN MATCHED THEN 
                    UPDATE 
                       SET REF_DOC_ID   = #{copySbcnRptId};
                       
                 MERGE INTO TBBADDED145M T1
                    USING (SELECT DISTINCT AUD_YR, AUD_NO, DOC_ID
                             FROM TBBADDED113M
                            WHERE AUD_YR = #{audYr}
                              AND AUD_NO = #{audNo}
                              AND DOC_ID = #{audRptDocId}
                              AND SBCN_REGI_REQ_DT = #{sbcnRegiReqDt}) T2
                       ON (     
                            T1.AUD_YR = T2.AUD_YR
                           AND T1.AUD_NO = T2.AUD_NO
                           AND T1.DOC_ID = T2.DOC_ID
                           AND T1.APVR_CD = 'A1070'
                          ) 
                             WHEN MATCHED THEN 
                                UPDATE 
                                   SET REF_DOC_ID   = #{copySbcnRptId};
             END;
        ]]>
    </update>
    
    <insert id="sendChfMsg">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.sendChfMsg */
    <![CDATA[
        INSERT INTO
            TBDCMACM026L
            (
              MSG_SNO
            , TSK_CAT_CD
            , FUNC_CAT_CD
            , SEND_ID
            , MSG_TP_YN
            , MSG_TXT_2
            , RCNT_CNT
            , RCNT_HIS
            , MSG_REGI_DH
            , FRT_USR_ID
            , FNL_USR_ID
            , FNL_DEAL_DPT_CD
            , FNL_MNU_ID
            , FRT_REGI_DH
            , FNL_MDF_DH    
            )
            VALUES
            (
              (SELECT NVL(MAX(MSG_SNO),'0')+1 AS MSG_SNO FROM TBDCMACM026L)
            , 'CM'
            , 'CM'
            , 'SYSTEM'
            , '0'
            ,(SELECT '('||F_MNG_KND_AUDYRNO(ST1.AUD_YR, ST1.AUD_NO, ST1.AUD_KND_CD, '-')||') '||ST1.AUD_SBJ_NM||CHR(13)||CHR(10)||
                    ST2.RPRT_NM||' 문서가 도착 하였습니다.'||CHR(13)||CHR(10)||
                    '해당 문서는 주심위원설명자료-감사보고서 우측의 감사사항참고 패널에서 확인 하실 수 있습니다.'
              FROM TBBADDED001M ST1
                   INNER JOIN TBBADDED103M ST2
                   ON (ST1.AUD_YR = ST2.AUD_YR AND ST1.AUD_NO = ST2.AUD_NO)
             WHERE ST2.DOC_ID = #{docId})
            ,(SELECT 
                 DECODE(CHF_CMTR_CNB,NULL,0,1)
                 + DECODE(CHF_CMTR1_CNB,NULL,0,1)
                 + DECODE(CHF_CMTR2_CNB,NULL,0,1)
                 + DECODE(CHF_CMTR3_CNB,NULL,0,1)
                 + DECODE(CHF_CMTR4_CNB,NULL,0,1)
                 + DECODE(CHF_CMTR5_CNB,NULL,0,1)
               FROM TBBADDED116L ST1
              WHERE ST1.AUD_YR = #{audYr}
                AND ST1.AUD_NO = #{audNo}
                AND ST1.DOC_ID = (SELECT REF_ID FROM TBBADDED103M WHERE DOC_ID = #{docId})
                AND ST1.SRNO = (SELECT MAX(SRNO) FROM TBBADDED116L WHERE AUD_YR = ST1.AUD_YR AND AUD_NO = ST1.AUD_NO AND DOC_ID = ST1.DOC_ID))
            ,(SELECT CHF_CMTR_CNB||CHF_CMTR1_CNB||CHF_CMTR2_CNB||CHF_CMTR3_CNB||CHF_CMTR4_CNB||CHF_CMTR5_CNB
               FROM TBBADDED116L ST1
              WHERE ST1.AUD_YR = #{audYr}
                AND ST1.AUD_NO = #{audNo}
                AND ST1.DOC_ID = (SELECT REF_ID FROM TBBADDED103M WHERE DOC_ID = #{docId})
                AND ST1.SRNO = (SELECT MAX(SRNO) FROM TBBADDED116L WHERE AUD_YR = ST1.AUD_YR AND AUD_NO = ST1.AUD_NO AND DOC_ID = ST1.DOC_ID))
            , SYSDATE 
            , #{usrId}
            , #{usrId}
            , #{dptCd}
            , 'AEPASB012E'
            , SYSDATE
            , SYSDATE 
            )
        ]]>
    </insert>
    
    
    <select id="selectSbmtInfoForMsg" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbmtInfoForMsg */
        <![CDATA[
            SELECT F_DPT_INFO(B.MNG_DPT_CD, '1') AS MNG_DPT_NM
                 , F_MNG_KND_AUDYRNO(B.AUD_YR, B.AUD_NO, B.AUD_KND_CD, '-') AS AUD_YR_NO
                 , B.AUD_SBJ_NM
                 , A.TITLE_NM AS TITLE_NM 
                 , (SELECT AGGR_CONCAT(ST.CNB,'')
				      FROM (
							  SELECT ST.USR_DFN_TXT_1 AS DPT_CD
							     , SUBSTR(REGEXP_REPLACE(ST.USR_DFN_TXT_2, '[^[:digit:]]'), (LEVEL - 1) * 4 + 1, 4) AS CNB
							    FROM (
									SELECT USR_DFN_TXT_1, USR_DFN_TXT_2
									  FROM TBDCMACM013C 
									 WHERE CMM_CD_DVSN_CD = '1000917'
									   AND CD = '10'
								    ) ST
				          CONNECT BY SUBSTR(REGEXP_REPLACE(ST.USR_DFN_TXT_2, '[^[:digit:]]'), (LEVEL - 1) * 4 + 1, 4) > 0
					       ) ST 
				INNER JOIN TBDCMACM001M ST2 ON ST2.DPT_CD = ST.DPT_CD AND ST2.CNB = ST.CNB) AS RCPT_USR_CNB
                 , (SELECT ST.USR_DFN_TXT_3 FROM TBDCMACM013C ST WHERE ST.CMM_CD_DVSN_CD = '1000917' AND ST.CD = '10') AS RCPT_USR_CNT
            FROM TBBADDED114M A 
      INNER JOIN TBBADDED001M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO)
           WHERE A.AUD_YR = #{audYr}
             AND A.AUD_NO = #{audNo}
             AND A.AFF_SNO = #{refId}
             AND A.SBMT_SEQ = #{refDy}
        ]]>
    </select>
    
    
    <select id="selectSbcnInfoForMsg" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.selectSbcnInfoForMsg */
        <![CDATA[
            SELECT F_DPT_INFO(A.MNG_DPT_CD, '1') AS MNG_DPT_NM
                 , F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, A.AUD_KND_CD, '-') AS AUD_YR_NO
                 , A.AUD_SBJ_NM
                 , C.RPRT_NM || '(' || F_CODE_NM('1000788',C.AUD_DOC_KND_CD) || ')' AS RPRT_NM
                 , (SELECT AGGR_CONCAT(ST.CNB,'')
				      FROM (
							  SELECT ST.USR_DFN_TXT_1 AS DPT_CD
							     , SUBSTR(REGEXP_REPLACE(ST.USR_DFN_TXT_2, '[^[:digit:]]'), (LEVEL - 1) * 4 + 1, 4) AS CNB
							    FROM (
									SELECT USR_DFN_TXT_1, USR_DFN_TXT_2
									  FROM TBDCMACM013C 
									 WHERE CMM_CD_DVSN_CD = '1000917'
									   AND CD = '10'
								    ) ST
				          CONNECT BY SUBSTR(REGEXP_REPLACE(ST.USR_DFN_TXT_2, '[^[:digit:]]'), (LEVEL - 1) * 4 + 1, 4) > 0
					       ) ST 
				INNER JOIN TBDCMACM001M ST2 ON ST2.DPT_CD = ST.DPT_CD AND ST2.CNB = ST.CNB) AS RCPT_USR_CNB
                 , (SELECT ST.USR_DFN_TXT_3 FROM TBDCMACM013C ST WHERE ST.CMM_CD_DVSN_CD = '1000917' AND ST.CD = '10') AS RCPT_USR_CNT
            FROM TBBADDED001M A 
      INNER JOIN TBBADDED103M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO)
      INNER JOIN TBBADDED103M C ON (C.AUD_YR = B.AUD_YR AND C.AUD_NO = B.AUD_NO AND C.DOC_ID = B.REF_DOC_ID AND C.AUD_STEP_CD = 'A1060' AND C.RPRT_CD = 'A10600200')
           WHERE A.AUD_YR = #{audYr}
             AND A.AUD_NO = #{audNo}
             AND B.RPRT_CD = #{rprtCd}
             AND B.DOC_ID = #{docId}
        ]]>
    </select>
    
    <select id="validFnRprt" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.validFnRprt */
        SELECT 
            MIN(NVL(APV_STA_CD,0)) AS APV_STA_CD
          FROM TBBADDED103M
         WHERE AUD_YR  = #{audYr}
           AND AUD_NO  = #{audNo}
           AND RPRT_CD IN ('A10700500', 'A10700700', 'A10700800')
    </select>
    
    <select id="chkSbmtCnt" parameterType="paramMap"
        resultType="int">
        /* kr.go.bai.eip.aep.asb.dao.AEPASB001EMapper.chkSbmtCnt */
        <![CDATA[
            SELECT COUNT(*) 
            FROM TBBADDED103M
            WHERE 1=1
            AND AUD_YR = #{audYr}
            AND AUD_NO = #{audNo}
            AND AUD_STEP_CD = #{audStepCd}
            AND AUD_KND_CD = #{audKndCd}
            AND REF_ID = #{affSno}
            AND REF_DY = #{sbmtSeq}
        ]]>
    </select>
    
</mapper> 
