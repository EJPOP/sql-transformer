<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.mac.dao.AEPMAC016PMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC016PMapper.selectMainList*/
    <![CDATA[
        SELECT A.AUD_YR
             , A.AUD_NO
             , A.AUD_STEP_CD
             , A.DOC_ID
             , A.APVR_CD
             , A.AFF_SNO
             , B.DSP_RQ_SNO
             , C.CNDIDAT_SRNO
             , A.TITLE_NM
             , (SELECT ST.AUD_SBJ_NM FROM TBBADDED001M ST WHERE ST.AUD_YR = A.AUD_YR AND ST.AUD_NO = A.AUD_NO) AS AUD_SBJ_NM
             , B.DSP_RQ_CD
             , F_CODE_NM('1000002', B.DSP_RQ_CD) AS DSP_RQ_NM
             , B.RLTN_ORG_CD
             , F_ORG_INFO(B.RLTN_ORG_CD, '1') AS RLTN_ORG_NM
             , C.CNDIDT_NM
		     , TO_CHAR(TO_DATE(C.CNDIDT_YMD),'YYYY-MM-DD') AS CNDIDT_YMD
		     , C.CNDIDT_RANK_CD
		     , F_CODE_NM('1000173', C.CNDIDT_RANK_CD) AS CNDIDT_RANK_NM
		     , C.CNDIDT_ORG_CD
		     , F_ORG_INFO(C.CNDIDT_ORG_CD, '1') AS CNDIDT_ORG_NM
		     , C.CNDIDT_DPT_NM
             , (SELECT COUNT(DISTINCT F_MNG_KND_AUDYRNO(ST.AUD_YR, ST.AUD_NO, ST2.AUD_KND_CD, '-'))
		          FROM TBBADDED146D ST
		    INNER JOIN TBBADDED001M ST2 ON (ST2.AUD_YR = ST.AUD_YR AND ST2.AUD_NO = ST.AUD_NO)
		    INNER JOIN TBBADDED146M ST3 ON (ST3.AUD_YR = ST.AUD_YR AND ST3.AUD_NO = ST.AUD_NO AND ST3.AUD_STEP_CD = ST.AUD_STEP_CD AND ST3.DOC_ID = ST.DOC_ID AND ST3.APVR_CD = ST.APVR_CD AND ST3.AFF_SNO = ST.AFF_SNO AND ST3.DSP_RQ_SNO = ST.DSP_RQ_SNO)
		         WHERE ST.CNDIDT_NM = C.CNDIDT_NM
		           AND ST.CNDIDT_YMD = C.CNDIDT_YMD
		           AND NOT(ST.AUD_YR = A.AUD_YR AND ST.AUD_NO = A.AUD_NO)
		        ) || '건' AS REL_AUD_CNT
          FROM TBBADDED145M A
    INNER JOIN TBBADDED146M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.AUD_STEP_CD = A.AUD_STEP_CD AND B.DOC_ID = A.DOC_ID AND B.APVR_CD = A.APVR_CD AND B.AFF_SNO = A.AFF_SNO)
    INNER JOIN TBBADDED146D C ON (C.AUD_YR = B.AUD_YR AND C.AUD_NO = B.AUD_NO AND C.AUD_STEP_CD = B.AUD_STEP_CD AND C.DOC_ID = B.DOC_ID AND C.APVR_CD = B.APVR_CD AND C.AFF_SNO = B.AFF_SNO AND C.DSP_RQ_SNO = B.DSP_RQ_SNO)
         WHERE A.AUD_YR      = #{audYr}
           AND A.AUD_NO      = #{audNo}
           AND A.AUD_STEP_CD = #{audStepCd}
           AND A.DOC_ID      = #{docId}
           AND A.APVR_CD     = #{apvrCd}
           ]]>
           <if test='affSno != null and affSno != ""'>
           AND B.AFF_SNO     = #{affSno}
           </if>
           <if test='dspRqSno != null and dspRqSno != ""'>
           AND B.DSP_RQ_SNO  = #{dspRqSno}
           </if>
           <if test='cndidatSrno != null and cndidatSrno != ""'>
           AND C.CNDIDAT_SRNO = #{cndidatSrno}
           </if>
           ORDER BY A.SORT_SNO ASC, B.DSP_RQ_SNO ASC
    </select>
       
    <select id="selectSubList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC016PMapper.selectSubList*/
    <![CDATA[
        	    SELECT A.AUD_YR
		             , A.AUD_NO
		             , A.AUD_STEP_CD
		             , A.DOC_ID
		             , A.APVR_CD
		             , A.AFF_SNO
		             , A.DSP_RQ_SNO
		             , A.CNDIDAT_SRNO
		             , A.CNDIDT_NM
		             , TO_CHAR(TO_DATE(A.CNDIDT_YMD),'YYYY-MM-DD') AS CNDIDT_YMD
		             , A.CNDIDT_RANK_CD
		             , F_CODE_NM('1000173', A.CNDIDT_RANK_CD) AS CNDIDT_RANK_NM
		             , A.CNDIDT_ORG_CD
		             , F_ORG_INFO(A.CNDIDT_ORG_CD, '1') AS CNDIDT_ORG_NM
		             , A.CNDIDT_DPT_NM
		             , '[' || F_MNG_KND_AUDYRNO(C.AUD_YR, C.AUD_NO, C.AUD_KND_CD, '-') || '] ' || C.AUD_SBJ_NM AS AUD_SBJ_NM
		             , CASE WHEN A.AUD_STEP_CD = 'A1060' THEN F_CODE_NM('1000176', A.APVR_CD)
		                    WHEN A.AUD_STEP_CD = 'A1070' AND A.APVR_CD = 'A107001' THEN '부의결과'
		                    ELSE F_CODE_NM('1000785',A.AUD_STEP_CD) END AS AUD_STEP_NM 
		             , C.MNG_DPT_CD
		             , F_DPT_INFO(C.MNG_DPT_CD,'1') AS MNG_DPT_NM
		             , (SELECT ST.TITLE_NM FROM TBBADDED145M ST WHERE ST.AUD_YR = A.AUD_YR AND ST.AUD_NO = A.AUD_NO AND ST.AUD_STEP_CD = A.AUD_STEP_CD AND ST.DOC_ID = A.DOC_ID AND ST.APVR_CD = A.APVR_CD AND ST.AFF_SNO = A.AFF_SNO) AS TITLE_NM
		             , F_CODE_NM('1000002', B.DSP_RQ_CD) AS DSP_RQ_NM
		             , F_ORG_INFO(B.RLTN_ORG_CD, '1') AS RLTN_ORG_NM
		             , (SELECT  AGGR_CONCAT(F_USR_INFO(ST.CNB,'2'),',')
				          FROM TBBADDED031L ST
				         WHERE ST.AUD_YR = A.AUD_YR
				           AND ST.AUD_NO = A.AUD_NO
				           AND ST.AUDTOR_DVSN_CD = '1') AS SPVR_NM
				     , (SELECT  AGGR_CONCAT(F_USR_INFO(ST.CNB,'2'),',')
				          FROM TBBADDED031L ST
				         WHERE ST.AUD_YR = A.AUD_YR
				           AND ST.AUD_NO = A.AUD_NO
				           AND ST.AUDTOR_DVSN_CD = '2') AS AST_NM
				     , (SELECT F_CODE_NM('1000777', MAX(ST.AFF_MPP_DVSN_CD)) 
				          FROM TBBADDED148M ST
				         WHERE ST.AUD_YR = A.AUD_YR
				           AND ST.AUD_NO = A.AUD_NO
				           AND ST.AUD_STEP_CD = A.AUD_STEP_CD
				           AND ST.DOC_ID = A.DOC_ID
				           AND ST.APVR_CD = A.APVR_CD
				           AND ST.AFF_SNO = A.AFF_SNO
				           AND ST.DSP_RQ_SNO = A.DSP_RQ_SNO) AS ETC
		          FROM TBBADDED146D A
		    INNER JOIN TBBADDED146M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.AUD_STEP_CD = A.AUD_STEP_CD AND B.DOC_ID = A.DOC_ID AND B.APVR_CD = A.APVR_CD AND B.AFF_SNO = A.AFF_SNO AND B.DSP_RQ_SNO = A.DSP_RQ_SNO)
		    INNER JOIN TBBADDED001M C ON (C.AUD_YR = A.AUD_YR AND C.AUD_NO = A.AUD_NO)
                 WHERE A.CNDIDT_NM = #{cndidtNm}
                   AND A.CNDIDT_YMD = TO_CHAR(TO_DATE(#{cndidtYmd}),'YYYYMMDD')
                   AND NOT (A.AUD_YR = #{audYr} AND A.AUD_NO = #{audNo})
                   ORDER BY A.AUD_YR, A.AUD_NO, A.AUD_STEP_CD, A.AFF_SNO, A.DSP_RQ_SNO, DECODE(A.APVR_CD,'0010200','1','0013600','2','0057400','3','0015800','4','0035100','5','0058100','6','0055600','7','0045900','8','0055700','9','0010600','10','A107001','11','A1070','12','13')
         ]]>
    </select>
    
    
</mapper>