<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.mac.dao.AEPMAC005PMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.aep.mac.dao.AEPMAC005PMapper.selectMainList*/
            SELECT 
                AUD_YR	        /*감사년도*/
                ,AUD_NO	        /*감사번호*/
                ,AUD_STEP_CD	/*감사단계코드 */
                ,DOC_ID	        /*문서ID */
                ,APVR_CD	    /*결재자코드*/ 
                ,AFF_SNO	    /*사건순번 */
                ,USR_ID	        /*사용자ID */
                ,SORT_SNO	    /*정렬순번 */
                ,FRT_USR_ID	    /*최초사용자ID */
                ,FNL_USR_ID	    /*최종사용자ID */
                ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
                ,FNL_MNU_ID	    /*최종메뉴ID */
                ,FRT_REGI_DH	/*최초등록일시 */
                ,FNL_MDF_DH	    /*최종수정일시 */
                ,( SELECT USR_NAM FROM TBDCMACM001M WHERE USR_ID = A.USR_ID) AS USR_NAM
                ,( SELECT RANK_CD FROM TBDCMACM001M WHERE USR_ID = A.USR_ID) AS RANK_CD
                ,( SELECT F_CODE_NM('1000173', RANK_CD) FROM TBDCMACM001M WHERE USR_ID = A.USR_ID) AS RANK_NM
                FROM TBBADDED117M A
                WHERE AUD_YR = #{audYr}
                <if test='audNo != null and audNo != ""'>
                    AND AUD_NO = #{audNo}
                </if>
                <if test='audStepCd != null and audStepCd != ""'>
                    AND AUD_STEP_CD = #{audStepCd}
                </if>
                <if test='affSno != null and affSno != ""'>
                    AND AFF_SNO = #{affSno}
                </if>
            ORDER BY SORT_SNO ASC
    </select>
    
    <insert id="TBBADDED117MInsert" parameterType="paramMap">
        /*kr.go.bai.eip.aep.mac.dao.AEPMAC005PMapper.TBBADDED117MInsert*/
        INSERT INTO TBBADDED117M 
            (
              AUD_YR,
              AUD_NO,
              AUD_STEP_CD,
              DOC_ID,
              APVR_CD,
              AFF_SNO,
              USR_ID,
              SORT_SNO,
              FRT_USR_ID,
              FNL_USR_ID,
              FNL_DEAL_DPT_CD,
              FNL_MNU_ID,
              FRT_REGI_DH,
              FNL_MDF_DH
            )
        VALUES 
            (
              #{audYr},
              #{audNo},
              #{audStepCd},
              (SELECT MAX(DOC_ID)  /* DOC ID가 없으면 템플릿 ID를 넣어주도록 변경 */
                      FROM TBFDMADM002M
                     WHERE AUD_DOC_CD = 'A10500200'),
              (SELECT NVL(F_USR_INFO_BY_ID(#{frtUsrId}, '4'), '0010200') AS CD_NM FROM DUAL),
              #{affSno},
              #{usrId},
              (SELECT NVL(MAX(SORT_SNO),0)+1 
                 FROM TBBADDED117M
                WHERE AUD_YR = #{audYr}
                  AND AUD_NO = #{audNo}
                  AND AUD_STEP_CD = #{audStepCd}
                  AND AFF_SNO = #{affSno}
              )
              ,#{frtUsrId}  /*최초사용자id */
              ,#{fnlUsrId} /*최종사용자id */
              ,#{fnlDealDptCd}    /*최종거래부서코드 */
              ,#{fnlMnuId} /*최종메뉴id */
              ,SYSDATE    /*최초등록일시 */
              ,SYSDATE /*최종수정일시 */
            )
    </insert>
    
    <delete id="TBBADDED117MDelete" parameterType="paramMap">
    /*kr.go.bai.eip.aep.mac.dao.AEPMAC005PMapper.TBBADDED117MDelete*/
        DELETE 
          FROM TBBADDED117M
         WHERE AUD_YR = #{audYr}
           AND AUD_NO = #{audNo}
           AND AUD_STEP_CD = #{audStepCd}
            <if test='affSno != null and affSno != ""'>
                AND AFF_SNO = #{affSno}
            </if>
            <if test='usrId != null and usrId != ""'>
                <!-- AND USR_ID = #{usrId}  -->
            </if>
    </delete>
    
    <update id="TBBADDED145MUpdate" parameterType="paramMap">
        /*kr.go.bai.eip.aep.mac.dao.AEPMAC005PMapper.TBBADDED145MUpdate*/
        UPDATE TBBADDED145M
           SET 
             FNL_USR_ID = #{fnlUsrId} /*최종사용자ID */
            ,FNL_DEAL_DPT_CD = #{fnlDealDptCd} /*최종거래부서코드 */
            ,FNL_MNU_ID = #{fnlMnuId} /*최종메뉴ID */
            ,FNL_MDF_DH = SYSDATE /*최종수정일시 */
            <if test='audtor != null and audtor != ""'>
                ,AUDTOR                =#{audtor}/*감사자 */
            </if>
            <if test='audtor == null or audtor == ""'>
                ,AUDTOR                =NULL
            </if>
         WHERE 1=1
            <if test='audYr != null and audYr != ""'>
                AND AUD_YR = #{audYr}
            </if>
            <if test='audNo != null and audNo != ""'>
                AND AUD_NO = #{audNo}
            </if>
            <if test='audStepCd != null and audStepCd != ""'>
                AND AUD_STEP_CD = #{audStepCd}
            </if>
            <if test='affSno != null and affSno != ""'>
                AND AFF_SNO = #{affSno}
            </if>
    </update>
    
    <select id="TBBADDED117chkUsrId" parameterType="paramMap" resultType="Integer">
        /*kr.go.bai.eip.aep.mac.dao.AEPMAC005PMapper.TBBADDED117chkUsrId*/
        SELECT COUNT(*) CNT FROM TBBADDED117M
        WHERE AUD_YR = #{audYr}
            <if test='audNo != null and audNo != ""'>
                AND AUD_NO = #{audNo}
            </if>
            <if test='audStepCd != null and audStepCd != ""'>
                AND AUD_STEP_CD = #{audStepCd}
            </if>
            <if test='affSno != null and affSno != ""'>
                AND AFF_SNO = #{affSno}
            </if>
            <if test='usrId != null and usrId != ""'>
                AND USR_ID = #{usrId}
            </if>
    </select>
</mapper>
