<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.afu.dao.AEPAFU012QMapper">
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.afu.dao.AEPAFU012QMapper.selectMainList*/
        <include refid="include.pageSelct" />
            <![CDATA[
     SELECT APV_DOC_NO, APV_DVSN_CD,TSK_KY_TXT,APV_STA_CD,APV_STA_NM,APV_TIT_NM,SBM_CNB,SBM_CNB_NM,SBM_DH,FNL_APV_CNB,AUD_YR_NO,FNL_APV_DH,AUD_KND_NM
         ,AUD_YR_KND_NM,AUD_SBJ_NM,AUD_DOC_NM,MNG_DPT_NM,APV_RQS_ID,AUD_KND_CD,AUD_YR,AUD_NO,CPR_TIT_CD,V_CPR_OPIN,EDT_YN,APV_STA_NM2
     FROM (
            SELECT G1.APV_DOC_NO,
                   G1.APV_DVSN_CD,
                   G1.TSK_KY_TXT,
                   G1.APV_STA_CD,
                   G1.APV_STA_NM,      /*결재상태*/
                   G1.APV_TIT_NM,            /*제목*/
                   G1.SBM_CNB,
                   G1.SBM_CNB_NM,   /*기안자*/
                   G1.SBM_DH,      /*상신일자*/
                   G1.FNL_APV_CNB,
                   G1.AUD_YR_NO,
                   G1.FNL_APV_DH,     /*마지막결재일자*/
                   G1.AUD_KND_NM,       /*감사종류*/
                   G1.AUD_YR_KND_NM,
                   G1.AUD_SBJ_NM,      /*감사사항명*/
                   G1.AUD_DOC_NM,      /*문서명*/
                   G1.MNG_DPT_NM,      /*관리부서*/
                   G1.APV_RQS_ID,
                   G1.AUD_KND_CD,
                   G1.AUD_YR,
                   G1.AUD_NO,
                   G1.CPR_TIT_CD,
                   G1.V_CPR_OPIN,
                   DECODE((
                    SELECT MAX(APVR_STA_CD)
                      FROM TBDCMACM023L ST1
                     WHERE ST1.APV_DOC_NO = G1.APV_DOC_NO
                       AND ST1.APV_SNO = G1.APV_SNO
                   ), '104', 'Y', '102', 'Y', 'N') AS EDT_YN, /* 20171226 SHC 검토요청 추가 */
                   F_CODE_NM ('1000348',(
                    SELECT MAX(APVR_STA_CD)
                      FROM TBDCMACM023L ST1
                     WHERE ST1.APV_DOC_NO = G1.APV_DOC_NO
                       AND ST1.APV_SNO = G1.APV_SNO
                   )) AS APV_STA_NM2 /* 20171226 SHC 검토, 협조 상태 */
              FROM (
                    SELECT MAX(T23.APV_SNO) AS APV_SNO,
                           T22.APV_DOC_NO,
                           T22.APV_DVSN_CD,
                           T22.TSK_KY_TXT,
                           T22.APV_STA_CD,
                           F_CODE_NM ('1000773', AD.APV_STA_CD) AS APV_STA_NM,      /*결재상태*/
                           T22.APV_TIT_NM,            /*제목*/
                           T22.SBM_CNB,
                           F_USR_INFO (SBM_CNB, '2') AS SBM_CNB_NM,   /*기안자*/
                           TO_CHAR(T22.SBM_DH, 'YYYY-MM-DD') AS SBM_DH,      /*상신일자*/
                           T22.FNL_APV_CNB,
                           F_MNG_KND_AUDYRNO(AD.AUD_YR, AD.AUD_NO, AD.AUD_KND_CD, '-') AS AUD_YR_NO,
                           TO_CHAR(T22.FNL_APV_DH, 'YYYY-MM-DD') AS FNL_APV_DH,     /*마지막결재일자*/
                           AD.AUD_KND_NM,       /*감사종류*/
                           AD.AUD_YR_KND_NM,
                           AD.AUD_SBJ_NM,      /*감사사항명*/
                           AD.AUD_DOC_NM,      /*문서명*/
                           AD.MNG_DPT_NM,      /*관리부서*/
                           AD.APV_RQS_ID,
                           AD.AUD_KND_CD,
                           AD.AUD_YR,
                           AD.AUD_NO,
                           T30.CPR_TIT_CD,
                           REPLACE(T30.CPR_OPIN , CHR(10), CHR(32)) AS V_CPR_OPIN
                      FROM (
                            SELECT ST2.APV_SNO,
                                   ST2.APV_DOC_NO,
                                   ST2.APV_DVSN_CD,
                                   ST2.APVR_CNB,
                                   ST2.APVR_STA_CD,
                                   ST2.APVR_DPT_CD AS DPT_CD
                              FROM TBDCMACM023L ST2,
                                   (
                                    SELECT MAX(APV_SNO) AS APV_SNO,
                                           D3.APV_DOC_NO
                                      FROM ( SELECT B.APV_SNO,
                                                    B.APV_DOC_NO,
                                                    B.APV_DVSN_CD,
                                                    B.APVR_CNB,
                                                    B.APVR_STA_CD,
                                                    --(SELECT A.DPT_CD FROM TBDCMACM001M A WHERE A.CNB = B.APVR_CNB) AS DPT_CD
                                                    B.APVR_DPT_CD AS DPT_CD
                                               FROM TBDCMACM023L B
                                              WHERE B.APVR_STA_CD IN ('102', '202', '104', '204')
                                                AND B.APVR_DPT_CD = '160200' ) D3
                                     GROUP BY D3.APV_DOC_NO ) ST3
                             WHERE ST2.APV_DOC_NO = ST3.APV_DOC_NO
                               AND ST2.APV_SNO = ST3.APV_SNO ) T23,
                           TBDCMACM022L T22,
                           TBDCMACM030L T30,
                           ( SELECT A.AUD_YR,
                                     A.AUD_NO,
                                     C.AUD_GRN_NO,
                                     C.AUD_KND_CD,
                                     F_CODE_NM ('1000007', C.AUD_KND_CD) AS AUD_KND_NM,
                                     F_CODE_NM('1000739', C.AUD_KND_CD) AS AUD_YR_KND_NM,
                                     C.AUD_SBJ_NM AS AUD_SBJ_NM,
                                     AGGR_CONCAT (CASE WHEN RPRT_CD = 'A10600100' THEN '개별처분요구안' WHEN RPRT_CD = 'A10951200' THEN '조사개시통보' WHEN RPRT_CD = 'A10951300' THEN '조사종료통보' WHEN RPRT_CD = 'A10600200' THEN '감사보고서' WHEN RPRT_CD = 'A10920100' THEN '검토의견/보고서' WHEN RPRT_CD = 'A10500200' THEN '실지감사종료보고서' ELSE ( SELECT AGGR_CONCAT (DTIL_AUD_DOC_NM, ',') AS DTIL_AUD_DOC_NM FROM TBFDMADM002M WHERE AUD_DOC_CD = A.RPRT_CD GROUP BY AUD_DOC_CD) END,
                                     ',') AS AUD_DOC_NM,
                                     F_DPT_INFO (C.MNG_DPT_CD,
                                     '1') AS MNG_DPT_NM,
                                     A.APV_RQS_ID,
                                     C.AUD_CTRL_CD,
                                     A.APV_STA_CD
                                FROM TBBADDED103M A LEFT OUTER JOIN TBBADDED001M C ON (A.AUD_YR = C.AUD_YR
                                 AND A.AUD_NO = C.AUD_NO)
                               WHERE A.APV_RQS_ID IS NOT NULL
                               GROUP BY A.AUD_YR,
                                     A.AUD_NO,
                                     C.AUD_GRN_NO,
                                     C.AUD_KND_CD,
                                     C.AUD_SBJ_NM,
                                     C.MNG_DPT_CD,
                                     A.APV_RQS_ID,
                                     C.AUD_CTRL_CD,
                                     A.APV_STA_CD) AD
                     WHERE T22.APV_DOC_NO =T23.APV_DOC_NO
                       AND T22.APV_DVSN_CD = T23.APV_DVSN_CD
                       AND T22.APV_DOC_NO = AD.APV_RQS_ID
                       AND T22.APV_DVSN_CD IN('fieldAudit')
                       AND T23.DPT_CD = '160200'  /*심의지원부서*/
                       AND T23.APVR_STA_CD IN ('104', '204', '102', '202') /* 20171226 SHC 검토요청, 검토완료 추가 */
                       AND T22.APV_DOC_NO = T30.APV_DOC_NO (+)
                       AND T22.APV_DVSN_CD = T30.APV_DVSN_CD (+)
                ]]>
                <if test="audSbjNm != null and audSbjNm != ''">
                       AND AD.AUD_SBJ_NM LIKE '%' || #{audSbjNm} || '%' /*감사사항명*/
                </if>
                <if test="deptCd != null and deptCd != ''">
                       AND T23.DPT_CD = #{deptCd} /*관리부서*/
                </if>
                <if test="rprtNm != null and rprtNm != ''">
                       AND T22.APV_TIT_NM LIKE '%' || #{rprtNm} || '%' /*문서제목*/
                </if>
                <if test="apvSta != null and apvSta != '' and apvSta eq '20'.toString()">
                       AND T22.APV_STA_CD <![CDATA[<>]]> '3' /*결재중*/
                </if>
                <if test="apvSta != null and apvSta != '' and apvSta eq '30'.toString()">
                       AND T22.APV_STA_CD = '3' /*결재완료*/
                </if>
                       AND T22.SBM_DH BETWEEN TO_DATE( NVL(REPLACE(#{startDate},'-',''),'19000101')||'000000', 'YYYYMMDDHH24MISS')   AND  TO_DATE(NVL(REPLACE(#{endDate},'-',''),'99991231')||'235959' , 'YYYYMMDDHH24MISS') 
                <if test="audYr != null and audYr != '' "> 
                       AND AD.AUD_YR = #{audYr}  /*감사년도*/
                </if>
                <if test="audYrNoKndCd != null and audYrNoKndCd != ''">
                       AND AD.AUD_KND_CD = #{audYrNoKndCd}
                </if>
                <if test="audGrnNo != null and audGrnNo != '' ">
                       AND AD.AUD_GRN_NO = #{audGrnNo}  /*감사번호*/
                </if>
           
                     GROUP BY T22.APV_DOC_NO,
                              T22.APV_DVSN_CD,
                              T22.TSK_KY_TXT,
                              T22.APV_TIT_NM,            /*제목*/
                              T22.SBM_CNB,
                              T22.SBM_DH,      /*상신일자*/
                              T22.FNL_APV_CNB,
                              T22.FNL_APV_DH,
                              AD.AUD_KND_NM,     
                              AD.AUD_YR_KND_NM,
                              AD.AUD_SBJ_NM,    
                              AD.AUD_DOC_NM,   
                              AD.MNG_DPT_NM,  
                              T23.APVR_STA_CD,
                              AD.APV_RQS_ID,
                              AD.AUD_KND_CD,
                              AD.AUD_YR,
                              AD.AUD_NO,
                              AD.APV_STA_CD,
                              T30.CPR_TIT_CD,
                              T30.CPR_OPIN,
                              T22.APV_STA_CD
                     ORDER BY T22.APV_STA_CD, APV_DOC_NO DESC ) AS G1
          UNION ALL
       <![CDATA[
          SELECT APV_DOC_NO, APV_DVSN_CD,TSK_KY_TXT,APV_STA_CD,APV_STA_NM,APV_TIT_NM,SBM_CNB,SBM_CNB_NM,SBM_DH,FNL_APV_CNB,AUD_YR_NO,FNL_APV_DH,AUD_KND_NM
         ,AUD_YR_KND_NM,AUD_SBJ_NM,AUD_DOC_NM,MNG_DPT_NM,APV_RQS_ID,AUD_KND_CD,AUD_YR,AUD_NO,CPR_TIT_CD,V_CPR_OPIN,EDT_YN,APV_STA_NM2
     FROM
            (       
            SELECT T22.APV_DOC_NO,
                   T22.APV_DVSN_CD,
                   T22.TSK_KY_TXT,
                   T22.APV_STA_CD,
                   F_CODE_NM ('1000773', AD.APV_STA_CD) AS APV_STA_NM,      /*결재상태*/
                   T22.APV_TIT_NM,            /*제목*/
                   T22.SBM_CNB,
                   F_USR_INFO (SBM_CNB, '2') AS SBM_CNB_NM,   /*기안자*/
                   TO_CHAR(T22.SBM_DH, 'YYYY-MM-DD') AS SBM_DH,      /*상신일자*/
                   T22.FNL_APV_CNB,
                   AD.AUD_YR || '-' || DECODE(AD.AUD_KND_CD,'1','심사','2','재심','3','재심판정') || '-' || DECODE(AD.ORG_ACP_SRNO, null, AD.AUD_NO, AD.ORG_ACP_SRNO) AS AUD_YR_NO,
                   TO_CHAR(T22.FNL_APV_DH, 'YYYY-MM-DD') AS FNL_APV_DH,     /*마지막결재일자*/
                   AD.AUD_KND_NM,       /*감사종류*/
                   AD.AUD_YR_KND_NM,
                   AD.AUD_SBJ_NM,      /*감사사항명*/
                   AD.AUD_DOC_NM,      /*문서명*/
                   AD.MNG_DPT_NM,      /*관리부서*/
                   DECODE(MAX(T23.APVR_STA_CD), '104', 'Y', '102', 'Y', 'N') AS EDT_YN,
                   F_CODE_NM('1000348',MAX(T23.APVR_STA_CD)) AS APV_STA_NM2,  /*협조상태*/
                   AD.APV_RQS_ID,
                   AD.AUD_KND_CD,
                   AD.AUD_YR,
                   AD.AUD_NO,
                   T30.CPR_TIT_CD,
                   REPLACE(T30.CPR_OPIN , CHR(10), CHR(32)) AS V_CPR_OPIN
              FROM ( 
                            SELECT ST2.APV_SNO,
                                   ST2.APV_DOC_NO,
                                   ST2.APV_DVSN_CD,
                                   ST2.APVR_CNB,
                                   ST2.APVR_STA_CD,
                                   ST2.APVR_DPT_CD AS DPT_CD
                              FROM TBDCMACM023L ST2,
                                   (
                                    SELECT MAX(APV_SNO) AS APV_SNO,
                                           D3.APV_DOC_NO
                                      FROM ( SELECT B.APV_SNO,
                                                    B.APV_DOC_NO,
                                                    B.APV_DVSN_CD,
                                                    B.APVR_CNB,
                                                    B.APVR_STA_CD,
                                                    --(SELECT A.DPT_CD FROM TBDCMACM001M A WHERE A.CNB = B.APVR_CNB) AS DPT_CD
                                                    B.APVR_DPT_CD AS DPT_CD
                                               FROM TBDCMACM023L B
                                              WHERE B.APVR_STA_CD IN ('102', '202', '104', '204')
                                                AND B.APVR_DPT_CD = '160200' ) D3
                                     GROUP BY D3.APV_DOC_NO ) ST3
                             WHERE ST2.APV_DOC_NO = ST3.APV_DOC_NO
                               AND ST2.APV_SNO = ST3.APV_SNO ) T23,
                   TBDCMACM022L T22,
                   TBDCMACM030L T30,
                   (  SELECT A.ACP_YR AS AUD_YR,
                             TO_CHAR(A.ACP_SRNO) AS AUD_NO,
                             C.ACP_DVSN_CD AS AUD_KND_CD,
                             DECODE(C.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') AS AUD_KND_NM,
                             DECODE(C.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') AS AUD_YR_KND_NM,
                             C.TIT_NM AS AUD_SBJ_NM,
                             AGGR_CONCAT (CASE WHEN RPRT_CD = 'D10400300' THEN '시행문(중앙부처)' WHEN RPRT_CD = 'D10400400' THEN '시행문(청구인)' WHEN RPRT_CD = 'E10600200' THEN '시행문(중앙부처)' ELSE ( SELECT AGGR_CONCAT (DTIL_AUD_DOC_NM, ',') AS DTIL_AUD_DOC_NM FROM TBFDMADM002M WHERE AUD_DOC_CD = A.RPRT_CD GROUP BY AUD_DOC_CD) END,
                             ',') AS AUD_DOC_NM,
                             F_DPT_INFO (C.DPT_CD,
                             '1') AS MNG_DPT_NM,
                             A.APV_RQS_ID,
                             A.APV_STA_CD,
                             C.ORG_ACP_SRNO AS ORG_ACP_SRNO
                        FROM TBBADFRE103M A LEFT OUTER JOIN TBBADFRE012M C ON (A.ACP_YR = C.ACP_YR
                         AND A.ACP_SRNO = C.ACP_SRNO
                         AND A.ACP_DVSN_CD = C.ACP_DVSN_CD)
                       WHERE A.APV_RQS_ID IS NOT NULL
                       GROUP BY A.ACP_YR,
                             A.ACP_SRNO,
                             C.ACP_DVSN_CD,
                             C.TIT_NM,
                             C.DPT_CD,
                             A.APV_RQS_ID,
                             A.APV_STA_CD,
                             C.ACP_YR,
                             C.ORG_ACP_SRNO,
                             C.ACP_SRNO) AD
             WHERE T22.APV_DOC_NO =T23.APV_DOC_NO
               AND T22.APV_DVSN_CD = T23.APV_DVSN_CD
               AND T22.APV_DOC_NO = AD.APV_RQS_ID
               AND T22.APV_DVSN_CD IN('requestAudit5','requestAudit6')
               AND T23.DPT_CD = '160200'  /*심의지원*/
               AND T23.APVR_STA_CD IN ('104', '204', '102', '202')
               AND T22.APV_DOC_NO = T30.APV_DOC_NO (+)
               AND T22.APV_DVSN_CD = T30.APV_DVSN_CD (+)
             GROUP BY T22.APV_DOC_NO,
                      T22.APV_DVSN_CD,
                      T22.TSK_KY_TXT,
                      T22.APV_TIT_NM,            /*제목*/
                      T22.SBM_CNB,
                      T22.SBM_DH,      /*상신일자*/
                      T22.FNL_APV_CNB,
                      T22.FNL_APV_DH,
                      AD.AUD_KND_NM,     
                      AD.AUD_YR_KND_NM,
                      AD.AUD_SBJ_NM,    
                      AD.AUD_DOC_NM,   
                      AD.MNG_DPT_NM,  
                      T23.APVR_STA_CD,
                      T23.APVR_STA_CD,
                      AD.APV_RQS_ID,
                      AD.AUD_KND_CD,
                      AD.AUD_YR,
                      AD.AUD_NO,
                      AD.APV_STA_CD,
                      AD.ORG_ACP_SRNO,
                      T30.CPR_TIT_CD,
                      T30.CPR_OPIN,
                      T22.APV_STA_CD
             )
             ]]>
             WHERE 1=1
                <if test="audSbjNm != null and audSbjNm != ''">
                       AND AUD_SBJ_NM LIKE '%' || #{audSbjNm} || '%' /*감사사항명*/
                </if>
                <if test="deptCd != null and deptCd != ''">
                       AND DPT_CD = #{deptCd} /*관리부서*/
                </if>
                <if test="rprtNm != null and rprtNm != ''">
                       AND APV_TIT_NM LIKE '%' || #{rprtNm} || '%' /*문서제목*/
                </if>
                <if test="apvSta != null and apvSta != '' and apvSta eq '20'.toString()">
                       AND APV_STA_CD <![CDATA[<>]]> '3' /*결재중*/
                </if>
                <if test="apvSta != null and apvSta != '' and apvSta eq '30'.toString()">
                       AND APV_STA_CD = '3' /*결재완료*/
                </if>
                       AND SBM_DH BETWEEN TO_DATE( NVL(REPLACE(#{startDate},'-',''),'19000101')||'000000', 'YYYYMMDDHH24MISS')   AND  TO_DATE(NVL(REPLACE(#{endDate},'-',''),'99991231')||'235959' , 'YYYYMMDDHH24MISS') 
                <if test="audYr != null and audYr != '' "> 
                       AND AUD_YR = #{audYr}  /*심사청구년도*/
                </if>
                <if test="audYrNoKndCd != null and audYrNoKndCd != ''">
                       AND AUD_KND_CD = #{audYrNoKndCd}
                </if>
                <if test="audGrnNo != null and audGrnNo != '' ">
                       AND AUD_NO = #{audGrnNo}  /*심사청구번호*/
                </if>
         )
         ORDER BY APV_STA_CD, APV_DOC_NO DESC
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectCurrDate" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.afu.dao.AEPAFU012QMapper.selectCurrDate*/
            SELECT TO_CHAR(SYSDATE, 'YYYY') || '-01-01' AS START_DATE
                  ,TO_CHAR(SYSDATE, 'YYYY-MM-DD') AS END_DATE
              FROM DUAL
    </select>
    
    <update id="updateCpr" parameterType="paramMap">
    /*kr.go.bai.eip.aep.cam.dao.AEPAFU012QMapper.updateCpr*/
            MERGE INTO  TBDCMACM030L T1
                    USING   (   SELECT  '1'
                                FROM    DUAL
                            ) T2
                    ON  (   T1.APV_DOC_NO = #{apvDocNo}
                        AND T1.APV_DVSN_CD = #{apvDvsnCd}
                        )
                WHEN    MATCHED THEN
                    UPDATE
                    SET     
                            FNL_USR_ID = #{usrId}
                           ,FNL_DEAL_DPT_CD = #{dptCd}
                           ,FNL_MNU_ID = #{usrId}
                           ,FNL_MDF_DH = SYSDATE
                       <if test="cprTitCd != null and cprTitCd != ''">
                           ,CPR_TIT_CD = #{cprTitCd}
                       </if>
                WHEN    NOT MATCHED THEN
                    INSERT  (
                              APV_DOC_NO        
                             ,APV_DVSN_CD       
                       <if test="cprTitCd != null and cprTitCd != ''">
                             ,CPR_TIT_CD       
                       </if> 
                             ,FRT_USR_ID        
                             ,FNL_USR_ID        
                             ,FNL_DEAL_DPT_CD   
                             ,FNL_MNU_ID        
                             ,FRT_REGI_DH       
                             ,FNL_MDF_DH        
                            )
                    VALUES  (
                             #{apvDocNo}
                            ,#{apvDvsnCd}
                       <if test="cprTitCd != null and cprTitCd != ''">
                            ,#{cprTitCd}
                       </if> 
                            ,#{usrId}
                            ,#{usrId}
                            ,#{dptCd}
                            ,#{mnuId}
                            ,SYSDATE
                            ,SYSDATE
                            )
    </update>
    
</mapper>