<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.aep.osm.dao.AEPOSM007PMapper">
    
    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.osm.dao.AEPOSM007PMapper.selectMainList*/
        <include refid="include.pageSelct" />
           <![CDATA[
            SELECT T.TITLE
            ,T.SBCN_PAGE_CNT
            ,T.DTL_CNT
            ,T.MNG_DPT_NM
            ,T.MNG_DPT_NM
            ,T.ADD_YN_NM
            ,T.ADD_YN
            ,T.CMT_DY
            ,T.CMT_DVSN_CD
            ,T.CMT_SQ
            ,T.CMT_SBJ_DVSN_CD
            ,T.CMT_SBJ_SNO
            ,T.CNT
            ,T.N_CNT
            ,T.T_CNT
            ,T.AUD_YR
            ,T.AUD_NO
      FROM (  SELECT D.AUD_SBJ_NM||'('||F_MNG_KND_AUDYRNO(D.AUD_YR, D.AUD_NO, D.AUD_KND_CD, '-')||')' AS TITLE,
                         A.SBCN_PAGE_CNT                                  AS SBCN_PAGE_CNT,
                         COUNT(A.SBCN_PAGE_CNT)||'건'                      AS DTL_CNT,
                         F_DPT_INFO(D.MNG_DPT_CD,'1')                     AS MNG_DPT_NM,
                         ''                                               AS ADD_YN_NM,
                         'N'                                              AS ADD_YN,
                         ''                                               AS CMT_DY,
                         ''                                               AS CMT_DVSN_CD,
                         ''                                               AS CMT_SQ,
                         ''                                             AS CMT_SBJ_DVSN_CD,
                         ''                                               AS CMT_SBJ_SNO,
                         COUNT(A.SBCN_VT_CD)||'/'||COUNT(A.SBCN_PAGE_CNT) AS CNT,
                         COUNT(A.SBCN_VT_CD)                              AS N_CNT,
                         COUNT(A.SBCN_PAGE_CNT)                           AS T_CNT,
                         D.AUD_YR                                         AS AUD_YR,
                         D.AUD_NO                                         AS AUD_NO
                    FROM TBBADDED113M AS A
              INNER JOIN TBBADDED145M AS D1 ON A.AUD_YR  = D1.AUD_YR
                                           AND A.AUD_NO  = D1.AUD_NO
                                           AND A.APVR_CD = D1.APVR_CD
                                           AND A.AFF_SNO = D1.AFF_SNO
              INNER JOIN TBBADDED146M AS D3 ON A.AUD_YR  = D3.AUD_YR
                                           AND A.AUD_NO  = D3.AUD_NO
                                           AND A.APVR_CD = D3.APVR_CD
                                           AND A.AFF_SNO = D3.AFF_SNO
                                           AND A.DSP_RQ_SNO = D3.DSP_RQ_SNO
              INNER JOIN TBBADDED001M AS D ON A.AUD_YR   = D.AUD_YR AND A.AUD_NO = D.AUD_NO
                   WHERE A.SBCN_DY   = REPLACE(#{cmtDy},'-')
                     AND A.SBCN_DY IS NOT NULL
                GROUP BY D.AUD_YR, D.AUD_NO, D.AUD_KND_CD, D.AUD_GRN_NO, D.AUD_SBJ_NM, D.MNG_DPT_CD, A.SBCN_PAGE_CNT 
               UNION ALL
                  SELECT A.CMT_SBJ_TIT                    AS TITLE,
                         A.SBCN_SNO                       AS SBCN_PAGE_CNT,
                         COUNT(B.CMT_SBJ_DTL_SNO)||'건'    AS DTL_CNT,
                         F_DPT_INFO(A.REL_DPT_CD,'1')     AS MNG_DPT_NM,
                         '안건추가'                          AS ADD_YN_NM,
                         'Y'                              AS ADD_YN,
                         A.CMT_DY                         AS CMT_DY,
                         A.CMT_DVSN_CD                    AS CMT_DVSN_CD,
                         TO_CHAR(A.CMT_SQ)                AS CMT_SQ,
                         A.CMT_SBJ_DVSN_CD                AS CMT_SBJ_DVSN_CD,
                         TO_CHAR(A.CMT_SBJ_SNO)           AS CMT_SBJ_SNO,
                         COUNT(B.SBCN_VT_CD)||'/'||COUNT(B.CMT_SBJ_DTL_SNO) AS CNT,
                         COUNT(B.CMT_SBJ_DTL_SNO)         AS N_CNT,
                         1                                AS T_CNT,
                         ''                               AS AUD_YR,
                         ''                               AS AUD_NO
                    FROM TBBADDED121M AS A
         LEFT OUTER JOIN TBBADDED122M AS B ON A.CMT_DY = B.CMT_DY
                                          AND A.CMT_DVSN_CD = B.CMT_DVSN_CD
                                          AND A.CMT_SQ = B.CMT_SQ
                                          AND A.CMT_SBJ_DVSN_CD = B.CMT_SBJ_DVSN_CD
                                          AND A.CMT_SBJ_SNO = B.CMT_SBJ_SNO
                   WHERE A.CMT_DY = REPLACE(#{cmtDy},'-')
                     AND A.CMT_DVSN_CD = #{cmtDvsnCd}
                     AND A.CMT_SQ = ${cmtSq}
                GROUP BY A.CMT_DY, A.CMT_DVSN_CD, A.CMT_SQ, A.CMT_SBJ_DVSN_CD, A.CMT_SBJ_SNO, A.CMT_SBJ_TIT, A.REL_DPT_CD, A.SBCN_SNO
                ) T
                 WHERE T.CMT_DVSN_CD = #{cmtDvsnCd}
          ]]>
        <include refid="include.pageOrder" />
    </select>
    
    
    <select id="selectSubList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.osm.dao.AEPOSM007PMapper.selectSubList*/
        <include refid="include.pageSelct" />
             <![CDATA[
                       SELECT   A.CMT_SBJ_DTL_TIT
                           ,NVL(A.DOC_ID,'-') AS DOC_ID
                          ,A.CMT_SBJ_DTL_SNO
                          ,A.SBCN_VT_CD                  
                          ,A.SBCN_VT_TXT
                          ,A.CMT_DY
                          ,A.CMT_DVSN_CD
                          ,A.CMT_SQ
                          ,A.CMT_SBJ_DVSN_CD
                          ,A.CMT_SBJ_SNO
                          ,A.FILE_NM
                          ,SUM(DECODE(B.CMTR_SBCN_YN, 'Y' , 1, 0)) AS Y_CNT
                          ,SUM(DECODE(B.CMTR_SBCN_YN, 'N' , 1, 0)) AS N_CNT
                     FROM TBBADDED122M A LEFT OUTER JOIN TBBADDED123M B
                       ON A.CMT_DY = B.CMT_DY
                      AND A.CMT_DVSN_CD = B.CMT_DVSN_CD
                      AND A.CMT_SQ = A.CMT_SQ
                      AND A.CMT_SBJ_DVSN_CD = B.CMT_SBJ_DVSN_CD
                      AND A.CMT_SBJ_DTL_SNO  =B.CMT_SBJ_DTL_SNO
                    WHERE A.CMT_DY = REPLACE(#{cmtDy},'-')
                      AND A.CMT_DVSN_CD = #{cmtDvsnCd}
                      AND A.CMT_SQ = ${cmtSq}
                      AND A.CMT_SBJ_DVSN_CD = #{cmtSbjDvsnCd}
                      AND A.CMT_SBJ_SNO = #{cmtSbjSno}
                   GROUP BY A.CMT_SBJ_DTL_TIT, A.DOC_ID, A.CMT_SBJ_DTL_SNO, A.SBCN_VT_CD, A.SBCN_VT_TXT, A.CMT_DY, A.CMT_DVSN_CD, A.CMT_SQ, A.CMT_SBJ_DVSN_CD, A.CMT_SBJ_SNO, A.FILE_NM
                   ORDER BY A.CMT_SBJ_DTL_SNO            
               ]]>
        <include refid="include.pageOrder" />
    </select>
    
    <select id="selectSubByAddList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.aep.osm.dao.AEPOSM007PMapper.selectSubByAddList*/
        <include refid="include.pageSelct" />
             <![CDATA[
            /*조회 SQL*/
             SELECT C.NO
                    ,C.CMT_DY
                    ,C.CMT_SQ
                    ,C.CMT_DVSN_CD
                    ,C.CMT_SBJ_DVSN_CD
                    ,C.CMT_SBJ_SNO
                    ,C.CMT_SBJ_DTL_SNO
                    ,C.CMT_END_YN
                    ,F_CODE_NM('1000176' ,F_USR_INFO_BY_ID(C.ID, '4')) AS CNB_NM /*직급먕*/
                    ,F_USR_INFO_BY_ID(C.ID, '2') AS CMTR_NM   /*성원명*/
                    ,D.CMTR_SBCN_YN
                    ,DECODE(D.CMTR_SBCN_YN, 'Y', '가', 'N', '부', '미정') AS CMTR_SBCN_NM /*의결여부 명*/
                    ,C.ID
                    ,D.CMTR_SNO
                    ,D.SBCN_VT_TXT    /*비고*/
               FROM
             (SELECT A.NO
                   ,A.CMT_DY
                   ,A.CMT_DVSN_CD
                   ,A.CMT_SQ
                   ,A.CMT_END_YN
                   ,A.ID
                   ,B.CMT_SBJ_DVSN_CD
                   ,B.CMT_SBJ_SNO
                   ,B.CMT_SBJ_DTL_SNO
             FROM (SELECT N.NO
                          ,T.CMT_SQ
                          ,T.CMT_DY
                          ,T.CMT_DVSN_CD
                          ,DECODE(N.NO,1,T.CHF_CMTR_ID, 2, T.CMTR1_ID, 3, T.CMTR2_ID, 4, T.CMTR3_ID, 5, T.CMTR4_ID, 6, T.CMTR5_ID, 7, T.CMTR6_ID) AS  ID
                          ,T.CMT_END_YN
                      FROM TBBADDED120M AS T,
                      (SELECT LEVEL NO FROM DUAL CONNECT BY LEVEL <= 7) N
                     WHERE 1=1
                       AND T.CMT_DVSN_CD = #{cmtDvsnCd}
                       AND T.CMT_SQ = #{cmtSq}) A INNER JOIN TBBADDED122M B
                      ON A.CMT_DY  =B.CMT_DY
                     AND A.CMT_DVSN_CD = B.CMT_DVSN_CD
                     AND A.CMT_SQ = B.CMT_SQ
             WHERE A.ID IS NOT NULL ) C LEFT OUTER JOIN TBBADDED123M D
                ON C.CMT_DY = D.CMT_DY                  
               AND C.CMT_DVSN_CD = D.CMT_DVSN_CD        
               AND C.CMT_SQ = D.CMT_SQ                  
               AND C.ID = D.CMTR_ID                          
               AND C.CMT_SBJ_DVSN_CD = D.CMT_SBJ_DVSN_CD
               AND C.CMT_SBJ_SNO = D.CMT_SBJ_SNO        
               AND C.CMT_SBJ_DTL_SNO = D.CMT_SBJ_DTL_SNO
             WHERE C.CMT_DY =  #{cmtDy} /*PARAM 회의일자*/
               AND C.CMT_SBJ_SNO = #{cmtSbjSno}    /*PARAM 회의안건순번*/
               AND C.CMT_SBJ_DTL_SNO = #{cmtSbjDtlSno}    /*PARAM 회의상세안건 순번*/
             ORDER BY C.NO
             ]]>
        <include refid="include.pageOrder" />
    </select>
    
    <update id="updateBADDED120M" parameterType="paramMap">
    /*kr.go.bai.eip.aep.osm.dao.AEPOSM007PMapper.updateBADDED120M*/
       <![CDATA[
                   UPDATE TBBADDED120M SET CMT_END_YN = 'Y',
                       CMT_END_DH = SYSDATE,
                       FNL_USR_ID = #{usrId},
                       FNL_DEAL_DPT_CD = #{dptCd},
                       FNL_MNU_ID = #{menuNo},
                       FNL_MDF_DH = SYSDATE
                   WHERE CMT_DY = REPLACE(#{cmtDy},'-')
                   AND CMT_DVSN_CD = #{cmtDvsnCd}
                   AND CMT_SQ = ${cmtSq}
         ]]>
    </update>
    
</mapper>