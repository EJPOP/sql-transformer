<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">   
<mapper namespace="kr.go.bai.eip.fdm.adm.dao.FDMADM006EMapper">	

    <select id="selectTskStepList" parameterType="paramMap" resultType="egovMap" >
	<![CDATA[
			/* kr.go.bai.eip.fdm.adm.dao.FDMADM006EMapper.selectTskStepList*/
				SELECT CMM_CD_DVSN_CD,
				 	   CD,
				 	   CD_NM
			      FROM TBDCMACM013C
			     WHERE 1 = 1
			       AND CD <> '000000000'
			       AND CMM_CD_DVSN_CD = #{tskKndCdDvsnCd}		       
			       AND USR_DFN_TXT_1 = #{cmmCdDvsnCd}
		]]>
			       <if test="tskKndCd != null and tskKndCd != ''">
			       AND USR_DFN_TXT_2 = #{tskKndCd}
			       </if>
	  	      ORDER BY CMM_CD_DVSN_CD, CD, CD_NM	
		</select>

		<select id="selectTskDocList" parameterType="paramMap" resultType="egovMap" >
		<![CDATA[
			/* kr.go.bai.eip.fdm.adm.dao.FDMADM006EMapper.selectTskDocList*/			
				       WITH TBTSKDOCGRPS AS (SELECT AUD_DOC_CD ,
				               F_CODE_NM('1000786', AUD_DOC_CD) AS AUD_DOC_NM ,
				               TSK_KND_CD ,
				               F_CODE_NM('1000787', TSK_KND_CD) AS TSK_KND_NM ,
				               AUD_STEP_CD ,
				               F_CODE_NM('1000785', AUD_STEP_CD) AS AUD_STEP_NM ,
				               MNT_CHO_CD ,
				               F_CODE_NM('1000768', MNT_CHO_CD) AS MNT_CHO_NM ,
				               APV_WAY_CD ,
				               F_CODE_NM('1000767', APV_WAY_CD) AS APV_WAY_NM ,
				               AUD_DOC_KND_CD ,
				               F_CODE_NM('1000769', AUD_DOC_KND_CD) AS AUD_DOC_KND_NM ,
				               TRNM_POSS_YN ,
				               DECODE(TRNM_POSS_YN, 'Y', '가능', '불가능') AS TRNM_POSS_YN_NM ,
				               DOC_PRD_DPT_CD ,
				               F_CODE_NM('1000771', DOC_PRD_DPT_CD) AS DOC_PRD_DPT_NM ,
				               CON_PGM_CD ,
				               F_CODE_NM('1000790', CON_PGM_CD) AS CON_PGM_NM
				          FROM TBFDMADM001M
				         WHERE 1=1 )
				SELECT AUD_DOC_NM AS TSK_DOC_NM,
				         AUD_DOC_CD AS TSK_DOC_CD
				  FROM TBTSKDOCGRPS A --업무별문서그룹
				 WHERE 1=1
				    AND A.AUD_STEP_CD != 'A0000' --문서작성기제외(필수)
		]]>
				<if test="tskKndCd != null and tskKndCd != ''">
				   AND A.TSK_KND_CD = #{tskKndCd} --업무구분
				</if>
				<if test="tskStepCd != null and tskStepCd != ''">
				   AND A.AUD_STEP_CD = #{tskStepCd} --업무단계
				</if>
				   AND A.AUD_DOC_NM IS NOT NULL
				 ORDER BY A.TSK_KND_CD ,
				       A.AUD_STEP_CD ,
				       A.AUD_DOC_CD
		</select>
		
		<select id="selectRuleFormUseCntList" parameterType="paramMap" resultType="egovMap" >
			/* kr.go.bai.eip.fdm.adm.dao.FDMADM006EMapper.selectRuleFormUseCntList*/
			SELECT T1.TSK_KND_CD
			     , F_CODE_NM('1000787',T1.TSK_KND_CD)  AS TSK_KND_NM
			     , T1.TSK_STEP_CD
			     , F_CODE_NM('1000785',T1.TSK_STEP_CD) AS TSK_STEP_NM
			     , T1.TSK_DOC_CD
			     , F_CODE_NM('1000786',T1.TSK_DOC_CD)  AS TSK_DOC_NM
			     , T1.USE_YR
			     , NVL(T1.RULE_FORM_USE_CNT, 0)        AS RULE_FORM_USE_CNT
			     , NVL(T1.RULE_FORM_CHG_USE_CNT, 0)    AS RULE_FORM_CHG_USE_CNT
			  FROM TBFDMADM006M T1
			 WHERE 1 = 1
			   AND T1.TSK_STEP_CD != 'A0000' /* 문서작성기 조회제거 */
			<if test="tskKndCd != null and tskKndCd != ''">
			   AND T1.TSK_KND_CD   = #{tskKndCd} --업무종류
			</if>
			<if test="tskStepCd != null and tskStepCd != ''">
			   AND T1.TSK_STEP_CD  = #{tskStepCd} --업무단계
			</if>
			<if test="tskDocCd != null and tskDocCd != ''">
			   AND T1.TSK_DOC_CD   = #{tskDocCd} --업무문서
			</if>
			<if test="useYr != null and useYr != ''">
	           AND T1.USE_YR       = #{useYr} --사용년도
	        </if>
			ORDER BY T1.USE_YR DESC
			       , T1.TSK_KND_CD
			       , T1.TSK_STEP_CD
			       , T1.TSK_DOC_CD
		</select>
		
		<select id="selectExsRuleFormUseCntList" parameterType="paramMap" resultType="egovMap" >
            /* kr.go.bai.eip.fdm.adm.dao.FDMADM006EMapper.selectExsRuleFormUseCntList*/
            SELECT T1.TSK_KND_CD
                 , F_CODE_NM('1000787',T1.TSK_KND_CD)   AS TSK_KND_NM
                 , T1.TSK_STEP_CD
                 , F_CODE_NM('1000785',T1.TSK_STEP_CD)  AS TSK_STEP_NM
                 , T1.TSK_DOC_CD
                 , F_CODE_NM('1000786',T1.TSK_DOC_CD)   AS TSK_DOC_NM
                 , T1.USE_YR
                 , NVL(T1.EXS_RULE_FORM_USE_CNT, 0)     AS EXS_RULE_FORM_USE_CNT
                 , NVL(T1.EXS_RULE_FORM_CHG_USE_CNT, 0) AS EXS_RULE_FORM_CHG_USE_CNT
              FROM TBFDMADM006M T1
             WHERE 1 = 1
               AND T1.TSK_STEP_CD != 'A0000' /* 문서작성기 조회제거 */
               AND (T1.EXS_RULE_FORM_USE_CNT != 0 OR T1.EXS_RULE_FORM_CHG_USE_CNT != 0)
            <if test="tskKndCd != null and tskKndCd != ''">
               AND T1.TSK_KND_CD   = #{tskKndCd} --업무종류
            </if>
            <if test="tskStepCd != null and tskStepCd != ''">
               AND T1.TSK_STEP_CD  = #{tskStepCd} --업무단계
            </if>
            <if test="tskDocCd != null and tskDocCd != ''">
               AND T1.TSK_DOC_CD   = #{tskDocCd} --업무문서
            </if>
            <if test="useYr != null and useYr != ''">
               AND T1.USE_YR       = #{useYr} --사용년도
            </if>
            ORDER BY T1.USE_YR DESC
                   , T1.TSK_KND_CD
                   , T1.TSK_STEP_CD
                   , T1.TSK_DOC_CD
        </select>
		
		<update id="mergeFormUseCnt" parameterType="paramMap">
		 MERGE INTO TBFDMADM006M 
		 USING DUAL
		    ON (    TSK_KND_CD   = #{tskKndCd}
		        AND TSK_STEP_CD  = #{tskStepCd}
		        AND TSK_DOC_CD   = #{tskDocCd}
		        AND USE_YR       = TO_CHAR(SYSDATE, 'YYYY'))
		  WHEN MATCHED THEN
		UPDATE
		   SET RULE_FORM_USE_CNT         = DECODE( #{useType}, 'FORM', DECODE((SELECT DISTINCT 1 FROM TBFDMADM003M WHERE 1=1 AND AUD_DOC_CD = #{tskDocCd}), 1, NVL(RULE_FORM_USE_CNT,0)+1, RULE_FORM_USE_CNT), RULE_FORM_USE_CNT)
             , RULE_FORM_CHG_USE_CNT     = DECODE( #{useType}, 'META', DECODE((SELECT DISTINCT 1 FROM TBFDMADM003M WHERE 1=1 AND AUD_DOC_CD = #{tskDocCd} AND EXISTS (SELECT 1 FROM TBFDMADM004M WHERE 1=1 AND ADM_YN != 'Y' AND TSK_DOC_CD = AUD_DOC_CD)), 1, NVL(RULE_FORM_CHG_USE_CNT,0)+1, RULE_FORM_CHG_USE_CNT), RULE_FORM_CHG_USE_CNT)
             , EXS_RULE_FORM_USE_CNT     = DECODE( #{useType}, 'META', DECODE((SELECT DISTINCT 1 FROM TBFDMADM004M WHERE 1=1 AND ADM_YN = 'Y'  AND TSK_DOC_CD = #{tskDocCd}), 1, NVL(EXS_RULE_FORM_USE_CNT,0)+1, EXS_RULE_FORM_USE_CNT), EXS_RULE_FORM_USE_CNT)
             , EXS_RULE_FORM_CHG_USE_CNT = DECODE( #{useType}, 'META', DECODE((SELECT DISTINCT 1 FROM TBFDMADM004M WHERE 1=1 AND ADM_YN != 'Y' AND TSK_DOC_CD = #{tskDocCd} AND NOT EXISTS (SELECT 1 FROM TBFDMADM003M WHERE 1=1 AND AUD_DOC_CD = TSK_DOC_CD)), 1, NVL(EXS_RULE_FORM_CHG_USE_CNT,0)+1, EXS_RULE_FORM_CHG_USE_CNT), EXS_RULE_FORM_CHG_USE_CNT)
		     , FNL_USR_ID       = #{usrId}
		     , FNL_DEAL_DPT_CD  = #{dptCd}
		     , FNL_MNU_ID       = #{mnuId}
		     , FNL_MDF_DH       = SYSDATE
		  WHEN NOT MATCHED THEN
		INSERT (
		         TSK_KND_CD
		       , TSK_STEP_CD
		       , TSK_DOC_CD
		       , USE_YR
		       , RULE_FORM_USE_CNT
               , RULE_FORM_CHG_USE_CNT
               , EXS_RULE_FORM_USE_CNT
               , EXS_RULE_FORM_CHG_USE_CNT 
		       , FRT_USR_ID
		       , FNL_USR_ID
		       , FNL_DEAL_DPT_CD
		       , FNL_MNU_ID
		       , FRT_REGI_DH
		       , FNL_MDF_DH
		) VALUES (
		         #{tskKndCd}
		       , #{tskStepCd}
		       , #{tskDocCd}
		       , TO_CHAR(SYSDATE, 'YYYY')
		       , DECODE( #{useType}, 'FORM', DECODE((SELECT DISTINCT 1 FROM TBFDMADM003M WHERE 1=1 AND AUD_DOC_CD = #{tskDocCd}), 1, 1, 0), 0)
			   , DECODE( #{useType}, 'META', DECODE((SELECT DISTINCT 1 FROM TBFDMADM003M WHERE 1=1 AND AUD_DOC_CD = #{tskDocCd} AND EXISTS (SELECT 1 FROM TBFDMADM004M WHERE 1=1 AND ADM_YN != 'Y' AND TSK_DOC_CD = AUD_DOC_CD)), 1, 1, 0), 0)
			   , DECODE( #{useType}, 'META', DECODE((SELECT DISTINCT 1 FROM TBFDMADM004M WHERE 1=1 AND ADM_YN = 'Y'  AND TSK_DOC_CD = #{tskDocCd}), 1, 1, 0), 0)
			   , DECODE( #{useType}, 'META', DECODE((SELECT DISTINCT 1 FROM TBFDMADM004M WHERE 1=1 AND ADM_YN != 'Y' AND TSK_DOC_CD = #{tskDocCd} AND NOT EXISTS (SELECT 1 FROM TBFDMADM003M WHERE 1=1 AND AUD_DOC_CD = TSK_DOC_CD)), 1, 1, 0), 0)
		       , #{usrId}
		       , #{usrId}
		       , #{dptCd}
		       , #{mnuId}
		       , SYSDATE
		       , SYSDATE
		)
		</update>
		
</mapper>
