<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.csp.ear.dao.CSPEAR003Mapper">
 	<select id="CSPEAR003EMainSelect" parameterType="paramMap"
		resultType="egovMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR003Mapper.CSPEAR003QMainSelect */
		<include refid="include.pageSelct" /> 
		<![CDATA[
		SELECT REQ_DVSN_CD
					,ACP_YR
   					,CVPT_ACP_NO
   					,ACP_NO
   					,CVPTR_NM
   					,TIT_NM
   					,ACP_DH
   					,REQR_DVSN_CD
   					,REQR_DVSN_NM
   					,CVPT_HNDL_STA_CD
   					,CVPT_HNDL_STA_NM
   					,HNDL_CHGR_NM
   					,TRNF_YN
   					,HNDL_DPT_NM
   					,HNDL_CHGR_ID
   					,HNDL_DPT_CD
                    , CASE WHEN ACP_STEP_NM IS NOT NULL AND CVPT_HNDL_STA_CD <> '170' THEN ACP_STEP_NM ELSE CVPT_HNDL_STA_NM END AS ACP_STEP_NM
            FROM (
				SELECT	A.REQ_DVSN_CD
						,A.ACP_YR
	   					,A.CVPT_ACP_NO
	   					,A.ACP_YR||'-'||F_CODE_NM('1000740',A.REQ_DVSN_CD)||'-'||substring(A.CVPT_ACP_NO, 3, 3) AS ACP_NO
	   					,A.CVPTR_NM
	   					,A.TIT_NM
	   					,TO_CHAR(A.ACP_DH,'YYYY-MM-DD HH24:MI') AS ACP_DH
	   					,B.REQR_DVSN_CD
	   					,F_CODE_NM('1000080',B.REQR_DVSN_CD) AS REQR_DVSN_NM
	   					,A.CVPT_HNDL_STA_CD
	   					,F_CODE_NM('1000361',A.CVPT_HNDL_STA_CD) AS CVPT_HNDL_STA_NM
	   					,F_USR_INFO_BY_ID(B.HNDL_CHGR_ID,'2') AS HNDL_CHGR_NM
	   					,B.TRNF_YN
	   					,(	SELECT	S1.DPT_NM
   						FROM 	TBDCMACM002M S1
   						WHERE 	S1.DPT_CD = B.HNDL_DPT_CD
   						) AS HNDL_DPT_NM
	   					,B.HNDL_CHGR_ID
	   					,B.HNDL_DPT_CD AS HNDL_DPT_CD
	   					, (	SELECT	ACP_STEP_NM
				      		FROM	TBCSPDCP601M S3
				      		WHERE	(S3.REQ_DVSN_CD, S3.ACP_YR, S3.CVPT_ACP_NO, ACP_STEP_CD ) IN (	SELECT	S4.REQ_DVSN_CD,S4.ACP_YR,S4.CVPT_ACP_NO,MAX(ACP_STEP_CD)
				      																		FROM	TBCSPDCP601M S4
				      																		WHERE	A.REQ_DVSN_CD = S4.REQ_DVSN_CD
				      																		AND		A.ACP_YR = S4.ACP_YR
				      																		AND		A.CVPT_ACP_NO = S4.CVPT_ACP_NO
	                                                                                        AND     S4.STEP_CMPT_YN = 'P'
				      																		GROUP BY S4.REQ_DVSN_CD,S4.ACP_YR,S4.CVPT_ACP_NO
				      																	))  AS    ACP_STEP_NM
	   			FROM	TBCSPDCP101M A
	   					,TBCSPEAR001M B
	   			WHERE	1=1
	   			AND		A.REQ_DVSN_CD = B.REQ_DVSN_CD(+)
	   			AND		A.ACP_YR = B.ACP_YR(+)
	   			AND		A.CVPT_ACP_NO = B.CVPT_ACP_NO(+)
	   			AND		A.CVPT_HNDL_STA_CD NOT IN ('10','21')
		]]>
			<if test='reqDvsnCd != null and reqDvsnCd != ""'>
				AND	A.REQ_DVSN_CD = #{reqDvsnCd}
			</if>
			<if test='reqDvsnCd == null or reqDvsnCd == ""'>
				AND	A.REQ_DVSN_CD IN ('2','3')
			</if>
			<if test='acpDhs != null and acpDhs != ""'>
				AND	TO_CHAR(A.ACP_DH,'YYYYMMDD') &gt;= #{acpDhs}
			</if>
			<if test='acpDhe != null and acpDhe != ""'>
				AND	TO_CHAR(A.ACP_DH,'YYYYMMDD') &lt;= #{acpDhe}
			</if>
			<if test='titNm != null and titNm != ""'>
				AND	A.TIT_NM LIKE '%'||#{titNm}||'%'
			</if>
			<if test='acpYr != null and acpYr != ""'>
				AND	A.ACP_YR = #{acpYr}
			</if>
			<if test='cvptAcpNo != null and cvptAcpNo != ""'>
				AND	A.CVPT_ACP_NO = #{cvptAcpNo}
			</if>
			<if test='dtbYn == "Y"'>
				AND	(B.HNDL_DPT_CD IS NOT NULL)
			</if>
			<if test='dtbYn == "N"'>
				AND	(B.HNDL_DPT_CD IS NULL)
			</if>
			<if test='cvptrNm != null and cvptrNm != ""'>
				AND	(A.CVPTR_NM LIKE '%'||#{cvptrNm}||'%' OR A.RPST_PEN_NM LIKE '%'||#{cvptrNm}||'%')
			</if>
			<![CDATA[ 
				ORDER BY A.ACP_DH DESC
			]]>
			)
		<include refid="include.pageOrder" />
	</select>
	
	<select id="CSPEAR003EBruDptSelect" parameterType="paramMap"
		resultType="egovMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR003Mapper.CSPEAR003EBruDptSelect */
		<![CDATA[
			SELECT 	DPT_CD
					, DPT_NM 
			FROM	TBDCMACM002M 
			WHERE 	DPT_CD LIKE '%000' 
			AND 	USE_YN = 'Y'
		]]>
	</select>
	
	<select id="CSPEAR003EDptSelect" parameterType="paramMap"
		resultType="egovMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR003Mapper.CSPEAR003EDptSelect */
		<![CDATA[
			SELECT 	DPT_CD
					, DPT_NM
					, HIRK_DPT_CD AS BRU_DPT_CD 
			FROM	TBDCMACM002M 
			WHERE 	DPT_CD NOT LIKE '%000' 
			AND 	USE_YN = 'Y'
		]]>
	</select>
	
	<select id="CSPEAR003EUsrSelect" parameterType="paramMap"
		resultType="egovMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR003Mapper.CSPEAR003EUsrSelect */
		<![CDATA[
			SELECT 	USR_ID
					, USR_NAM
					, DPT_CD 
			FROM	TBDCMACM001M 
		]]>
	</select>
	
	<update id="CSPEAR003EEAR001Update" parameterType="paramMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR003Mapper.CSPEAR003EEAR001Update */
		<![CDATA[
			UPDATE	TBCSPEAR001M
			SET		HNDL_DPT_CD = #{hndlDptCd}
					,HNDL_CHGR_ID = #{hndlChgrId}
					,AUD_EXEC_DCS_DPT_CD = #{hndlDptCd}
         			,AUD_EXEC_DCS_CHGR_ID = #{hndlChgrId}
					,FNL_USR_ID = #{fnlUsrId}
   					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
   					,FNL_MNU_ID = #{fnlMnuId}
   					,FNL_MDF_DH = SYSDATE
			WHERE	REQ_DVSN_CD = #{reqDvsnCd}
			AND		ACP_YR = #{acpYr}
			AND		CVPT_ACP_NO = #{cvptAcpNo}
		]]>
	</update>
</mapper> 