<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.csp.dcp.dao.CSPDCP819Mapper">

 	<resultMap type="java.util.HashMap" id="CSPDCP819PMainSelect">
			<result property="sttmDvsnCd" 			 column="STTM_DVSN_CD" 			     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="acpYr" 						 column="ACP_YR" 						     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="sttmAcpNo" 			 column="STTM_ACP_NO" 			     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="acpNo" 			 column="ACP_NO" 			     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="acpDt" 				 column="ACP_DT" 				     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="nam" 			 column="NAM" 			     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="jbNm" 	 column="JB_NM" 	     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="ad" 	 column="AD" 	     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="tnb" 							 column="TNB" 							     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="titNm" 							 column="TIT_NM" 							     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="docDvsnCd" 		 column="DOC_DVSN_CD" 						     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="docDvsnCd2" 	 column="DOC_DVSN_CD2" 								     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="docDvsnCd3"  column="DOC_DVSN_CD3" 							     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="docDvsnCd4" 	 column="DOC_DVSN_CD4" 								     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="docTxt" 						 column="DOC_TXT" 						     jdbcType="CLOB" javaType="java.lang.String" />
			<result property="docTxt2" 					column="DOC_TXT2" 						     jdbcType="CLOB" javaType="java.lang.String" />
			<result property="docTxt3" 					column="DOC_TXT3" 						     jdbcType="CLOB" javaType="java.lang.String" />
			<result property="docTxt4" 					column="DOC_TXT4" 						     jdbcType="CLOB" javaType="java.lang.String" />
			<result property="opmApvHndlStaCd" 		 column="OPM_APV_HNDL_STA_CD" 						     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="opmSrno" 			 column="OPM_SRNO" 						     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="onrDocMngCrdId" 		 column="ONR_DOC_MNG_CRD_ID" 		     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="hndlDvsnCd" 			 column="HNDL_DVSN_CD" 			     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="onrApvCmptDh" 			 column="ONR_APV_CMPT_DH" 			     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="acpRutNm" 					 column="ACP_RUT_NM" 					     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="acpDptNm" 			 column="ACP_DPT_NM" 			     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="hndlDptNm" 					 column="HNDL_DPT_NM" 					     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="rsltNtfWayNm" 				 column="RSLT_NTF_WAY_NM" 				     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="trnfDptNm" 			 column="TRNF_DPT_NM" 			     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="trnfOrgNm" 	 column="TRNF_ORG_NM" 	     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="jebocnt" 						 column="JEBOCNT" 						     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="title" 				 column="TITLE" 				     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="fnlHndlDh" 				 column="FNL_HNDL_DH" 				     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="flRutNm" 			 column="FL_RUT_NM" 			     jdbcType="VARCHAR" javaType="java.lang.String" />
			<result property="sysFlNm" 			 column="SYS_FL_NM" 			     jdbcType="VARCHAR" javaType="java.lang.String" />

	</resultMap>
 	<select id="CSPDCP819PMainSelect" parameterType="paramMap" resultMap="CSPDCP819PMainSelect">
		<![CDATA[
			SELECT	T1.STTM_DVSN_CD
					,T1.ACP_YR
					,T1.STTM_ACP_NO
					,DECODE(T1.RM_STTM_ACP_NO,NULL,NULL,T1.ACP_YR||'-'||'청금-'||T1.RM_STTM_ACP_NO) AS ACP_NO
					,TO_CHAR(T1.ACP_DH,'YYYY.MM.DD') AS ACP_DT
					,T1.NAM
					,T1.JB_NM
					,T1.AD
					,T1.TNB
					,T1.TIT_NM
					, '101' AS DOC_DVSN_CD
   					, '102' AS DOC_DVSN_CD2
   					, '103' AS DOC_DVSN_CD3
   					, '104' AS DOC_DVSN_CD4
   					, (	SELECT 	S1.DOC_TXT
   						FROM	TBCSPDCP817M S1
   						WHERE	T1.STTM_DVSN_CD = S1.STTM_DVSN_CD
						AND		T1.ACP_YR = S1.ACP_YR
						AND		T1.STTM_ACP_NO = S1.STTM_ACP_NO
						AND		S1.DOC_DVSN_CD = '101') AS DOC_TXT
					, (	SELECT 	S1.DOC_TXT
   						FROM	TBCSPDCP817M S1
   						WHERE	T1.STTM_DVSN_CD = S1.STTM_DVSN_CD
						AND		T1.ACP_YR = S1.ACP_YR
						AND		T1.STTM_ACP_NO = S1.STTM_ACP_NO
						AND		S1.DOC_DVSN_CD = '102') AS DOC_TXT2
					, (	SELECT 	S1.DOC_TXT
   						FROM	TBCSPDCP817M S1
   						WHERE	T1.STTM_DVSN_CD = S1.STTM_DVSN_CD
						AND		T1.ACP_YR = S1.ACP_YR
						AND		T1.STTM_ACP_NO = S1.STTM_ACP_NO
						AND		S1.DOC_DVSN_CD = '103') AS DOC_TXT3
					, (	SELECT 	S1.DOC_TXT
   						FROM	TBCSPDCP817M S1
   						WHERE	T1.STTM_DVSN_CD = S1.STTM_DVSN_CD
						AND		T1.ACP_YR = S1.ACP_YR
						AND		T1.STTM_ACP_NO = S1.STTM_ACP_NO
						AND		S1.DOC_DVSN_CD = '104') AS DOC_TXT4
					,T4.OPM_APV_HNDL_STA_CD
					,T4.OPM_SRNO
					,T4.ONR_DOC_MNG_CRD_ID
					,T3.HNDL_DVSN_CD
					,TO_CHAR(T4.ONR_APV_CMPT_DH,'YYYY.MM.DD') AS ONR_APV_CMPT_DH
					,F_CODE_NM('1000056',T1.ACP_RUT_CD) AS ACP_RUT_NM
					,F_DPT_INFO(T1.ACP_DPT_CD,'1') AS ACP_DPT_NM
					,F_DPT_INFO(T2.HNDL_DPT_CD,'1') AS HNDL_DPT_NM
					,'홈페이지' AS RSLT_NTF_WAY_NM
					,F_DPT_INFO(T3.TRNF_DPT_CD,'1') AS TRNF_DPT_NM
					,(	SELECT	F_ORG_INFO(MIN(S1.ORG_CD),'1') AS ORG_NM
   						FROM	TBCSPDCP816L S1
   						WHERE	T3.STTM_DVSN_CD = S1.STTM_DVSN_CD
   						AND		T3.ACP_YR = S1.ACP_YR
   						AND		T3.STTM_ACP_NO = S1.STTM_ACP_NO
   						AND		T3.SRNO = S1.SRNO
   					) AS TRNF_ORG_NM
   					,(	SELECT	COUNT(*)
   						FROM	TBCSPDCP811M S1
   						WHERE	S1.STTM_DVSN_CD = '1'
   						AND		S1.EIN = T1.EIN
   					) AS JEBOCNT
   					,F_CODE_NM('1000765','10')||' (제'||T1.ACP_YR||'-청금-'||T1.RM_STTM_ACP_NO||'호) 보고' AS TITLE
   					,TO_CHAR(T2.FNL_HNDL_DH,'YYYY.MM.DD') AS FNL_HNDL_DH
   					,(	SELECT	FL_RUT_NM
   						FROM	TBDCMACM103L S1
   						WHERE	T4.ONR_DOC_MNG_CRD_ID = S1.ONR_DOC_MNG_CRD_ID
   						AND		S1.ONR_APV_FL_DVSN_CD(+) = 'A'
   					) AS FL_RUT_NM
   					,(	SELECT	SYS_FL_NM
   						FROM	TBDCMACM103L S1
   						WHERE	T4.ONR_DOC_MNG_CRD_ID = S1.ONR_DOC_MNG_CRD_ID
   						AND		S1.ONR_APV_FL_DVSN_CD(+) = 'A'
   					) AS SYS_FL_NM
			FROM	TBCSPDCP811M T1
					,TBCSPDCP813M T2
					,TBCSPDCP815L T3
					,TBCSPDCP818M T4
			WHERE	T1.STTM_DVSN_CD = T2.STTM_DVSN_CD
			AND		T1.ACP_YR = T2.ACP_YR
			AND		T1.STTM_ACP_NO = T2.STTM_ACP_NO
			AND		T1.STTM_DVSN_CD = #{sttmDvsnCd}
			AND		T1.ACP_YR = #{acpYr}
			AND		T1.STTM_ACP_NO = #{sttmAcpNo}
			AND		T1.STTM_DVSN_CD = T3.STTM_DVSN_CD
			AND		T1.ACP_YR = T3.ACP_YR
			AND		T1.STTM_ACP_NO = T3.STTM_ACP_NO
			AND		(T3.STTM_DVSN_CD, T3.ACP_YR, T3.STTM_ACP_NO, T3.SRNO) IN (	SELECT	Z.STTM_DVSN_CD, Z.ACP_YR, Z.STTM_ACP_NO, MIN(Z.SRNO) AS SRNO
																			FROM	TBCSPDCP815L Z
																			WHERE	T1.STTM_DVSN_CD = Z.STTM_DVSN_CD
																			AND		T1.ACP_YR = Z.ACP_YR
																			AND		T1.STTM_ACP_NO = Z.STTM_ACP_NO
																			GROUP BY Z.STTM_DVSN_CD, Z.ACP_YR, Z.STTM_ACP_NO
																		)
			AND		T1.STTM_DVSN_CD = T4.STTM_DVSN_CD(+)
			AND		T1.ACP_YR = T4.ACP_YR(+)
			AND		T1.STTM_ACP_NO = T4.STTM_ACP_NO(+)
			AND		T4.IFM_DVSN_CD(+) = '10'
		]]>
	</select>


	<insert id="CSPDCP819PTBCSPDCP817MMerge" parameterType="paramMap">
        <![CDATA[
        	MERGE INTO 	TBCSPDCP817M A
        	USING 	(	SELECT 	#{sttmDvsnCd} AS STTM_DVSN_CD
        						,#{acpYr} AS ACP_YR
        						,#{sttmAcpNo} AS STTM_ACP_NO
        						,'101' AS DOC_DVSN_CD
        				FROM DUAL
        			) B
        	ON		(	A.STTM_DVSN_CD = B.STTM_DVSN_CD
        				AND	A.ACP_YR = B.ACP_YR
        				AND A.STTM_ACP_NO = B.STTM_ACP_NO
        				AND A.DOC_DVSN_CD = B.DOC_DVSN_CD
        			)
        	WHEN MATCHED THEN
        			UPDATE
        			SET		DOC_TXT = #{docTxt}
        					,FNL_USR_ID = #{fnlUsrId}
        					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
        					,FNL_MNU_ID = #{fnlMnuId}
        					,FNL_MDF_DH = SYSDATE
        	WHEN NOT MATCHED THEN
		        	INSERT 		(	STTM_DVSN_CD
		        					,ACP_YR
		        					,STTM_ACP_NO
		        					,DOC_SRNO
		        					,DOC_DVSN_CD
		        					,DOC_TXT
		        					,FRT_USR_ID
		        					,FNL_USR_ID
		        					,FNL_DEAL_DPT_CD
		        					,FNL_MNU_ID
		        					,FRT_REGI_DH
		        					,FNL_MDF_DH
		        				)
		        		VALUES	(	#{sttmDvsnCd}
									,#{acpYr}
									,#{sttmAcpNo}
									,(	SELECT	NVL(MAX(DOC_SRNO),0)+1
										FROM	TBCSPDCP817M
										WHERE	STTM_DVSN_CD = #{sttmDvsnCd}
										AND		ACP_YR = #{acpYr}
										AND		STTM_ACP_NO = #{sttmAcpNo}
									)
		        					,'101'
		        					,#{docTxt}
									,#{frtUsrId}
									,#{fnlUsrId}
									,#{fnlDealDptCd}
									,#{fnlMnuId}
									,SYSDATE
									,SYSDATE
								)
        ]]>
	</insert>

	<insert id="CSPDCP819PTBCSPDCP817MMerge2" parameterType="paramMap">
        <![CDATA[
        	MERGE INTO 	TBCSPDCP817M A
        	USING 	(	SELECT 	#{sttmDvsnCd} AS STTM_DVSN_CD
        						,#{acpYr} AS ACP_YR
        						,#{sttmAcpNo} AS STTM_ACP_NO
        						,'102' AS DOC_DVSN_CD
        				FROM DUAL
        			) B
        	ON		(	A.STTM_DVSN_CD = B.STTM_DVSN_CD
        				AND	A.ACP_YR = B.ACP_YR
        				AND A.STTM_ACP_NO = B.STTM_ACP_NO
        				AND A.DOC_DVSN_CD = B.DOC_DVSN_CD
        			)
        	WHEN MATCHED THEN
        			UPDATE
        			SET		DOC_TXT = #{docTxt2}
        					,FNL_USR_ID = #{fnlUsrId}
        					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
        					,FNL_MNU_ID = #{fnlMnuId}
        					,FNL_MDF_DH = SYSDATE
        	WHEN NOT MATCHED THEN
		        	INSERT 		(	STTM_DVSN_CD
		        					,ACP_YR
		        					,STTM_ACP_NO
		        					,DOC_SRNO
		        					,DOC_DVSN_CD
		        					,DOC_TXT
		        					,FRT_USR_ID
		        					,FNL_USR_ID
		        					,FNL_DEAL_DPT_CD
		        					,FNL_MNU_ID
		        					,FRT_REGI_DH
		        					,FNL_MDF_DH
		        				)
		        		VALUES	(	#{sttmDvsnCd}
									,#{acpYr}
									,#{sttmAcpNo}
									,(	SELECT	NVL(MAX(DOC_SRNO),0)+1
										FROM	TBCSPDCP817M
										WHERE	STTM_DVSN_CD = #{sttmDvsnCd}
										AND		ACP_YR = #{acpYr}
										AND		STTM_ACP_NO = #{sttmAcpNo}
									)
		        					,'102'
		        					,#{docTxt2}
									,#{frtUsrId}
									,#{fnlUsrId}
									,#{fnlDealDptCd}
									,#{fnlMnuId}
									,SYSDATE
									,SYSDATE
								)
        ]]>
	</insert>

	<insert id="CSPDCP819PTBCSPDCP817MMerge3" parameterType="paramMap">
        <![CDATA[
        	MERGE INTO 	TBCSPDCP817M A
        	USING 	(	SELECT 	#{sttmDvsnCd} AS STTM_DVSN_CD
        						,#{acpYr} AS ACP_YR
        						,#{sttmAcpNo} AS STTM_ACP_NO
        						,'103' AS DOC_DVSN_CD
        				FROM DUAL
        			) B
        	ON		(	A.STTM_DVSN_CD = B.STTM_DVSN_CD
        				AND	A.ACP_YR = B.ACP_YR
        				AND A.STTM_ACP_NO = B.STTM_ACP_NO
        				AND A.DOC_DVSN_CD = B.DOC_DVSN_CD
        			)
        	WHEN MATCHED THEN
        			UPDATE
        			SET		DOC_TXT = #{docTxt3}
        					,FNL_USR_ID = #{fnlUsrId}
        					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
        					,FNL_MNU_ID = #{fnlMnuId}
        					,FNL_MDF_DH = SYSDATE
        	WHEN NOT MATCHED THEN
		        	INSERT 		(	STTM_DVSN_CD
		        					,ACP_YR
		        					,STTM_ACP_NO
		        					,DOC_SRNO
		        					,DOC_DVSN_CD
		        					,DOC_TXT
		        					,FRT_USR_ID
		        					,FNL_USR_ID
		        					,FNL_DEAL_DPT_CD
		        					,FNL_MNU_ID
		        					,FRT_REGI_DH
		        					,FNL_MDF_DH
		        				)
		        		VALUES	(	#{sttmDvsnCd}
									,#{acpYr}
									,#{sttmAcpNo}
									,(	SELECT	NVL(MAX(DOC_SRNO),0)+1
										FROM	TBCSPDCP817M
										WHERE	STTM_DVSN_CD = #{sttmDvsnCd}
										AND		ACP_YR = #{acpYr}
										AND		STTM_ACP_NO = #{sttmAcpNo}
									)
		        					,'103'
		        					,#{docTxt3}
									,#{frtUsrId}
									,#{fnlUsrId}
									,#{fnlDealDptCd}
									,#{fnlMnuId}
									,SYSDATE
									,SYSDATE
								)
        ]]>
	</insert>

	<insert id="CSPDCP819PTBCSPDCP817MMerge4" parameterType="paramMap">
        <![CDATA[
        	MERGE INTO 	TBCSPDCP817M A
        	USING 	(	SELECT 	#{sttmDvsnCd} AS STTM_DVSN_CD
        						,#{acpYr} AS ACP_YR
        						,#{sttmAcpNo} AS STTM_ACP_NO
        						,'104' AS DOC_DVSN_CD
        				FROM DUAL
        			) B
        	ON		(	A.STTM_DVSN_CD = B.STTM_DVSN_CD
        				AND	A.ACP_YR = B.ACP_YR
        				AND A.STTM_ACP_NO = B.STTM_ACP_NO
        				AND A.DOC_DVSN_CD = B.DOC_DVSN_CD
        			)
        	WHEN MATCHED THEN
        			UPDATE
        			SET		DOC_TXT = #{docTxt4}
        					,FNL_USR_ID = #{fnlUsrId}
        					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
        					,FNL_MNU_ID = #{fnlMnuId}
        					,FNL_MDF_DH = SYSDATE
        	WHEN NOT MATCHED THEN
		        	INSERT 		(	STTM_DVSN_CD
		        					,ACP_YR
		        					,STTM_ACP_NO
		        					,DOC_SRNO
		        					,DOC_DVSN_CD
		        					,DOC_TXT
		        					,FRT_USR_ID
		        					,FNL_USR_ID
		        					,FNL_DEAL_DPT_CD
		        					,FNL_MNU_ID
		        					,FRT_REGI_DH
		        					,FNL_MDF_DH
		        				)
		        		VALUES	(	#{sttmDvsnCd}
									,#{acpYr}
									,#{sttmAcpNo}
									,(	SELECT	NVL(MAX(DOC_SRNO),0)+1
										FROM	TBCSPDCP817M
										WHERE	STTM_DVSN_CD = #{sttmDvsnCd}
										AND		ACP_YR = #{acpYr}
										AND		STTM_ACP_NO = #{sttmAcpNo}
									)
		        					,'104'
		        					,#{docTxt4}
									,#{frtUsrId}
									,#{fnlUsrId}
									,#{fnlDealDptCd}
									,#{fnlMnuId}
									,SYSDATE
									,SYSDATE
								)
        ]]>
	</insert>

	<insert id="CSPDCP819POnrTBCSPDCP818MMerge" parameterType="paramMap">
		<![CDATA[
			MERGE INTO 	TBCSPDCP818M A
        	USING 	(	SELECT 	#{sttmDvsnCd} AS STTM_DVSN_CD
        						,#{acpYr} AS ACP_YR
        						,#{sttmAcpNo} AS STTM_ACP_NO
        						,#{opmSrno} AS OPM_SRNO
        				FROM DUAL
        			) B
        	ON		(	A.STTM_DVSN_CD = B.STTM_DVSN_CD
        				AND	A.ACP_YR = B.ACP_YR
        				AND A.STTM_ACP_NO = B.STTM_ACP_NO
        				AND A.OPM_SRNO = B.OPM_SRNO
        			)
        	WHEN MATCHED THEN
        			UPDATE
        			SET		OPM_APV_HNDL_STA_CD = '10'
        					,ADMN_INF_HNDL_NO = #{admnInfHndlNo}
        					,ONR_DOC_MNG_CRD_ID = #{onrDocMngCrdId}
        					,FNL_USR_ID = #{fnlUsrId}
        					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
        					,FNL_MNU_ID = #{fnlMnuId}
        					,FNL_MDF_DH = SYSDATE
        	WHEN NOT MATCHED THEN
				INSERT 	(	STTM_DVSN_CD
							,ACP_YR
							,STTM_ACP_NO
							,OPM_SRNO
							,IFM_DVSN_CD
	       					,OPM_APV_HNDL_STA_CD
	       					,ADMN_INF_HNDL_NO
	       					,ONR_DOC_MNG_CRD_ID
	       					,FRT_USR_ID
	       					,FNL_USR_ID
	       					,FNL_DEAL_DPT_CD
	       					,FNL_MNU_ID
	       					,FRT_REGI_DH
	       					,FNL_MDF_DH
	       				)
	       		VALUES	(	#{sttmDvsnCd}
							,#{acpYr}
							,#{sttmAcpNo}
							,(SELECT 	NVL(MAX(TO_NUMBER(OPM_SRNO)),0)+1
								FROM 	TBCSPDCP818M
								WHERE 	STTM_DVSN_CD = #{sttmDvsnCd}
										AND		ACP_YR = #{acpYr}
										AND		STTM_ACP_NO = #{sttmAcpNo})
							,'10'
	       					,'10'
	       					,#{admnInfHndlNo}
	       					,#{onrDocMngCrdId}
	       					,#{frtUsrId}
	       					,#{fnlUsrId}
	       					,#{fnlDealDptCd}
	       					,#{fnlMnuId}
	       					,SYSDATE
	       					,SYSDATE
	       				)
		]]>
	</insert>

	<update id="CSPDCP819PTBCSPDCP811MANS_TXTUpdate" parameterType="paramMap">
		<![CDATA[
			UPDATE	TBCSPDCP811M
			SET		ANS_TXT = #{ansTxt}
			WHERE	STTM_DVSN_CD = #{sttmDvsnCd}
			AND		ACP_YR = #{acpYr}
			AND		STTM_ACP_NO = #{sttmAcpNo}
		]]>
	</update>
</mapper>
