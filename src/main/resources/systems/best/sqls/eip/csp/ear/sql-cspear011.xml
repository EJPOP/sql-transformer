<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.csp.ear.dao.CSPEAR011Mapper">
 	<select id="CSPEAR011EMainSelect" parameterType="paramMap"
		resultType="egovMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR011Mapper.CSPEAR011EMainSelect */
		<![CDATA[
			SELECT	A.REQ_DVSN_CD
					,A.ACP_YR
					,A.CVPT_ACP_NO
					,A.ACP_YR||'-'||F_CODE_NM('1000740',A.REQ_DVSN_CD)||'-'||substring(A.CVPT_ACP_NO, 3, 3) AS ACP_NO
					,A.REQ_DT
					,A.HNDL_DDLN_CD
					,A.AUD_REQ_TIT_NM
					,A.NTAS_REQ_SBT
					,A.HNDL_DPT_CD
					,(	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD =A.HNDL_DPT_CD
   					)  AS HNDL_DPT_NM
					,A.PMN_CMT_NM
					,A.SGS_ASBM_NM
					,A.HNDL_DDLN_DT
					,NVL(A.EXTN_YN,'N') AS EXTN_YN
					,A.EXTN_HNDL_DDLN_DT
					,A.CPLT_DT
					,A.DOC_ID
					,A.EXTN_RSN
					,A.REL_BAS_DOC_NO
					,A.REL_BAS_ENF_DT
					,DECODE(A.CPLT_DT,NULL,'',TO_DATE(A.CPLT_DT)-TO_DATE(A.REQ_DT)) AS HNDL_DDLN_DT_CNT
					,A.CHGR_NM
					,A.HNDL_STT_TXT
					,F_CODE_NM('1000376', A.HNDL_DDLN_CD) AS HNDL_DDLN_NM
					,DECODE(C.AUD_YR,NULL,NULL,F_MNG_KND_AUDYRNO(C.AUD_YR, C.AUD_NO, C.AUD_KND_CD, '-')) AS AUD_YR_N0
					,B.AUD_YR
					,B.AUD_NO
			FROM	TBCSPEAR007M A
					,TBBADDED030L B
					,TBBADDED001M C
			WHERE	1=1
			AND		A.REQ_DVSN_CD = B.TSK_KEY2(+)
			AND     A.ACP_YR = B.TSK_KEY1(+)
			AND     A.CVPT_ACP_NO = B.TSK_KEY3(+)
			AND		B.AUD_YR = C.AUD_YR(+)
			AND		B.AUD_NO = C.AUD_NO(+)
		]]>
		<if test='acpYr != null and acpYr != ""'>
				AND	A.ACP_YR = #{acpYr}
			</if>
		<if test='cvptAcpNo != null and cvptAcpNo != ""'>
				AND	A.CVPT_ACP_NO = #{cvptAcpNo}
			</if>
		<if test='reqDts != null and reqDts != ""'>
				AND	A.REQ_DT &gt;= #{reqDts}
			</if>
		<if test='reqDte != null and reqDte != ""'>
				AND	A.REQ_DT &lt;= #{reqDte}
			</if>
		<if test='audReqTitNm != null and audReqTitNm != ""'>
				AND	A.AUD_REQ_TIT_NM LIKE '%'||#{audReqTitNm}||'%'
			</if>
		<if test='hndlDdlnCd != null and hndlDdlnCd != ""'>
				AND	A.HNDL_DDLN_CD = #{hndlDdlnCd}
			</if>
		<if test='sgsAsbmNm != null and sgsAsbmNm != ""'>
				AND	A.SGS_ASBM_NM LIKE '%'||#{sgsAsbmNm}||'%'
			</if>

		<![CDATA[
			ORDER BY A.ACP_YR DESC,  A.CVPT_ACP_NO DESC
		]]>
	</select>


	<select id="CSPEAR011EKeySelect" parameterType="paramMap"
		resultType="egovMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR011Mapper.CSPEAR011EKeySelect */
		<![CDATA[
			SELECT	LPAD(TO_CHAR(NVL(MAX(TO_NUMBER(CVPT_ACP_NO)),0)+1),3,0) AS CVPT_ACP_NO
			FROM	TBCSPEAR007M
			WHERE	REQ_DVSN_CD ='4'
			AND		ACP_YR = #{acpYr}
		]]>
	</select>

	<insert id="CSPEAR011EMainInsert" parameterType="paramMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR011Mapper.CSPEAR011EMainInsert */
		<![CDATA[
			INSERT INTO	TBCSPEAR007M
					(	REQ_DVSN_CD
						,ACP_YR
						,CVPT_ACP_NO
						,REQ_DT
						,HNDL_DDLN_CD
						,AUD_REQ_TIT_NM
						,NTAS_REQ_SBT
						,HNDL_DPT_CD
						,PMN_CMT_NM
						,SGS_ASBM_NM
						,HNDL_DDLN_DT
						,EXTN_YN
						,EXTN_HNDL_DDLN_DT
						,CPLT_DT
						,DOC_ID
						,EXTN_RSN
						,REL_BAS_DOC_NO
						,REL_BAS_ENF_DT
						,CHGR_NM
						,HNDL_STT_TXT
						,FRT_USR_ID
       					,FNL_USR_ID
       					,FNL_DEAL_DPT_CD
       					,FNL_MNU_ID
       					,FRT_REGI_DH
       					,FNL_MDF_DH
					)
			VALUES	(	'4'
						,#{acpYr}
						,#{cvptAcpNo}
						,#{reqDt}
						,(	SELECT 	CASE WHEN #{extnYn} = 'Y' AND #{cpltDt} IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),5),'YYYYMMDD') < #{cpltDt} THEN '2'
										WHEN #{extnYn} = 'N' AND #{cpltDt} IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),3),'YYYYMMDD') < #{cpltDt} THEN '2'
											WHEN #{cpltDt} IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),3),'YYYYMMDD') >= #{cpltDt}  THEN '1'
											WHEN #{extnYn} = 'Y' AND #{cpltDt} IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),5),'YYYYMMDD') >= #{cpltDt}  THEN '1'
											ELSE '' END FROM DUAL)
						,#{audReqTitNm}
						,#{ntasReqSbt}
						,#{hndlDptCd}
						,#{pmnCmtNm}
						,#{sgsAsbmNm}
						,TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),3),'YYYYMMDD')
						,#{extnYn}
						,DECODE(#{extnYn},'Y',TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),5),'YYYYMMDD'),'')
						,#{cpltDt}
						,#{docId}
						,#{extnRsn}
						,#{relBasDocNo}
						,#{relBasEnfDt}
						,#{chgrNm}
						,#{hndlSttTxt}
						,#{frtUsrId}
       					,#{fnlUsrId}
       					,#{fnlDealDptCd}
       					,#{fnlMnuId}
       					,SYSDATE
       					,SYSDATE
       				)
		]]>
	</insert>

	<update id="CSPEAR011EMainUpdate" parameterType="paramMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR011Mapper.CSPEAR011EMainUpdate */
		<![CDATA[
			UPDATE	TBCSPEAR007M
			SET		REQ_DT = #{reqDt}
					,HNDL_DDLN_CD = (	SELECT 	CASE WHEN #{extnYn} = 'Y' AND #{cpltDt} IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),5),'YYYYMMDD') < #{cpltDt} THEN '2'
										WHEN #{extnYn} = 'N' AND #{cpltDt} IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),3),'YYYYMMDD') < #{cpltDt} THEN '2'
											WHEN #{cpltDt} IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),3),'YYYYMMDD') >= #{cpltDt}  THEN '1'
											WHEN #{extnYn} = 'Y' AND #{cpltDt} IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),5),'YYYYMMDD') >= #{cpltDt}  THEN '1'
											ELSE '' END FROM DUAL)
					,AUD_REQ_TIT_NM = #{audReqTitNm}
					,NTAS_REQ_SBT = #{ntasReqSbt}
					,HNDL_DPT_CD = #{hndlDptCd}
					,PMN_CMT_NM = #{pmnCmtNm}
					,SGS_ASBM_NM = #{sgsAsbmNm}
					,HNDL_DDLN_DT = TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),3),'YYYYMMDD')
					,EXTN_YN = #{extnYn}
					,EXTN_HNDL_DDLN_DT = DECODE(#{extnYn},'Y',TO_CHAR(ADD_MONTHS(TO_DATE(#{reqDt}),5),'YYYYMMDD'),'')
					,CPLT_DT = #{cpltDt}
					,DOC_ID = #{docId}
					,EXTN_RSN = #{extnRsn}
					,REL_BAS_DOC_NO = #{relBasDocNo}
					,REL_BAS_ENF_DT = #{relBasEnfDt}
					,CHGR_NM = #{chgrNm}
					,HNDL_STT_TXT = #{hndlSttTxt}
					,FNL_USR_ID = #{fnlUsrId}
   					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
   					,FNL_MNU_ID = #{fnlMnuId}
   					,FNL_MDF_DH = SYSDATE
			WHERE	REQ_DVSN_CD = '4'
			AND		ACP_YR = #{acpYr}
			AND		CVPT_ACP_NO = #{cvptAcpNo}
		]]>
	</update>


	<delete id="CSPEAR011EMainDelete" parameterType="paramMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR011Mapper.CSPEAR011EMainDelete */
		<![CDATA[
			DELETE
			FROM	TBCSPEAR007M
			WHERE	REQ_DVSN_CD = '4'
			AND		ACP_YR = #{acpYr}
			AND		CVPT_ACP_NO = #{cvptAcpNo}
		]]>
	</delete>
</mapper>
