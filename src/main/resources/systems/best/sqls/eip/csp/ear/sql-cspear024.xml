<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.csp.ear.dao.CSPEAR024Mapper">
 	
 	<resultMap type="java.util.HashMap" id="CSPEAR024">
 		<result property="reqDvsnCd" column="REQ_DVSN_CD"                   jdbcType="VARCHAR" javaType="java.lang.String" />
		<result property="acpYr" column="ACP_YR"                             jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="cvptAcpNo" column="CVPT_ACP_NO"                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpNo" column="ACP_NO"                             jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="reqrKndCd" column="REQR_KND_CD"                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="cvptrNm" column="CVPTR_NM"                         jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="btdt" column="BTDT"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="jbNm" column="JB_NM"                               jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="rpstPenNm" column="RPST_PEN_NM"                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="bzn" column="BZN"                                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="cpnmNm" column="CPNM_NM"                           jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="zcd" column="ZCD"                                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="ad" column="AD"                                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="dtlAd" column="DTL_AD"                             jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="tnb" column="TNB"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="tnb1" column="TNB1"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="tnb2" column="TNB2"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="tnb3" column="TNB3"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="hpn" column="HPN"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="hpn1" column="HPN1"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="hpn2" column="HPN2"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="hpn3" column="HPN3"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="emlId" column="EML_ID"                             jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="emlDmiNm" column="EML_DMI_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="titNm" column="TIT_NM"                             jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpDptCd" column="ACP_DPT_CD"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpDptNm" column="ACP_DPT_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="rcepId" column="RCEP_ID"                           jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="rcepNm" column="RCEP_NM"                           jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpDh" column="ACP_DH"                             jdbcType="VARCHAR" javaType="java.lang.String" />
		<result property="cvptHndlStaCd" column="CVPT_HNDL_STA_CD"         jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="cvptTxt" column="CVPT_TXT"                         jdbcType="CLOB"      javaType="java.lang.String" />
		<result property="cvptSbt" column="CVPT_SBT"                         jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="docId" column="DOC_ID"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="reqrCnt" column="REQR_CNT"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="reqrDvsnCd" column="REQR_DVSN_CD"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="ognzPsoCnt" column="OGNZ_PSO_CNT"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpDt" column="ACP_DT"                     jdbcType="VARCHAR"  javaType="java.lang.String" />

		<result property="audExecDcsDptNm" column="AUD_EXEC_DCS_DPT_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="audExecDcsDptCd" column="AUD_EXEC_DCS_DPT_CD"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="audExecDcsChgrNm" column="AUD_EXEC_DCS_CHGR_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="audExecDcsChgrId" column="AUD_EXEC_DCS_CHGR_ID"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="audDptCd" column="AUD_DPT_CD"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="audDptNm" column="AUD_DPT_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="audChgrNm" column="AUD_CHGR_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="audChgrId" column="AUD_CHGR_ID"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="audExecDcsDdln" column="AUD_EXEC_DCS_DDLN"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="audRsltHndlDdln" column="AUD_RSLT_HNDL_DDLN"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpRutNm" column="ACP_RUT_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="vrfYn" column="VRF_YN"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="reqDvsnNm" column="REQ_DVSN_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="reqrDvsnCd" column="REQR_DVSN_CD"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="reqrDvsnNm" column="REQR_DVSN_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="cvptHndlStaNm" column="CVPT_HNDL_STA_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="homeStaCd" column="HOME_STA_CD"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="homeStaNm" column="HOME_STA_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="sndApvDocNo" column="SND_APV_DOC_NO"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="sndStaCd" column="SND_STA_CD"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
 	</resultMap>
	<select id="CSPEAR024PDtlSelect" parameterType="paramMap"
		resultMap="CSPEAR024">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR004Mapper.CSPEAR024PDtlSelect */
		<![CDATA[
			SELECT	A.REQ_DVSN_CD
					,F_CODE_NM('1000740',A.REQ_DVSN_CD)||'감사청구' AS REQ_DVSN_NM
                    ,A.HPN AS HPN
                    ,A.TNB AS TNB
                    ,C.REQR_DVSN_CD
                    ,F_CODE_NM('1000080',C.REQR_DVSN_CD) AS REQR_DVSN_NM
					,A.ACP_YR
   					,A.CVPT_ACP_NO
   					,A.ACP_YR||'-'||F_CODE_NM('1000740',A.REQ_DVSN_CD)||'-'||substring(A.CVPT_ACP_NO, 3, 3) AS ACP_NO
   					,F_CODE_NM('1000361',A.CVPT_HNDL_STA_CD) AS CVPT_HNDL_STA_NM
   					,A.REQR_KND_CD
   					,A.CVPTR_NM
   					,A.BTDT
   					,A.JB_NM
   					,A.RPST_PEN_NM
   					,A.BZN
   					,A.CPNM_NM
   					,A.ZCD
   					,A.AD
   					,A.DTL_AD
   					,A.TNB
   					,A.HPN
   					,DECODE(A.TNB,NULL,'',SUBSTR(A.TNB,1,INSTR(A.TNB,'-',1,1)-1)) TNB1
   					,DECODE(A.TNB,NULL,'',SUBSTR(A.TNB,INSTR(A.TNB,'-',1,1)+1,INSTR(A.TNB,'-',1,2)-INSTR(A.TNB,'-',1,1)-1)) AS TNB2
   					,DECODE(A.TNB,NULL,'',SUBSTR(A.TNB,INSTR(A.TNB,'-',1,2)+1)) TNB3
   					,DECODE(A.HPN,NULL,'',SUBSTR(HPN,1,INSTR(HPN,'-',1,1)-1)) HPN1
   					,DECODE(A.HPN,NULL,'',SUBSTR(A.HPN,INSTR(A.HPN,'-',1,1)+1,INSTR(A.HPN,'-',1,2)-INSTR(A.HPN,'-',1,1)-1)) AS HPN2
   					,DECODE(A.HPN,NULL,'',SUBSTR(A.HPN,INSTR(A.HPN,'-',1,2)+1)) HPN3
   					,A.EML_ID
   					,A.EML_DMI_NM
   					,A.TIT_NM
   					,A.ACP_DPT_CD
   					,(	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = A.ACP_DPT_CD
   					) AS ACP_DPT_NM
   					,A.RCEP_ID
   					,F_USR_INFO_BY_ID(A.RCEP_ID,'2') AS RCEP_NM
   					,A.ACP_DH
   					,A.CVPT_HNDL_STA_CD
   					,A.CVPT_HNDL_STA_CD AS HOME_STA_CD
   					,F_CODE_NM('1000361',A.CVPT_HNDL_STA_CD) AS HOME_STA_NM
   					,B.CVPT_TXT
   					,B.CVPT_SBT
   					,A.DOC_ID
   					,C.REQR_CNT
   					,C.REQR_DVSN_CD
   					,C.OGNZ_PSO_CNT
   					,TO_CHAR(A.ACP_DH,'YYYYMMDD') AS ACP_DT
   					,DECODE(C.AUD_EXEC_DCS_DPT_CD,NULL,
	   					(	SELECT	S1.DPT_NM
	   						FROM	TBDCMACM002M S1
	   						WHERE	S1.DPT_CD = C.HNDL_DPT_CD
	   					)
	   					,(	SELECT	S1.DPT_NM
	   						FROM	TBDCMACM002M S1
	   						WHERE	S1.DPT_CD = C.AUD_EXEC_DCS_DPT_CD
	   					)
   					) AS AUD_EXEC_DCS_DPT_NM
   					,NVL(C.AUD_EXEC_DCS_DPT_CD,C.HNDL_DPT_CD) AS AUD_EXEC_DCS_DPT_CD
   					,DECODE(C.AUD_EXEC_DCS_CHGR_ID,NULL,F_USR_INFO_BY_ID(C.HNDL_CHGR_ID,'2'),F_USR_INFO_BY_ID(C.AUD_EXEC_DCS_CHGR_ID,'2')) AS AUD_EXEC_DCS_CHGR_NM
   					,NVL(C.AUD_EXEC_DCS_CHGR_ID,C.HNDL_CHGR_ID) AS AUD_EXEC_DCS_CHGR_ID
   					,C.AUD_DPT_CD
   					,(	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = C.AUD_DPT_CD
   					)  AS AUD_DPT_NM
   					,F_USR_INFO_BY_ID(C.AUD_CHGR_ID,'2') AS AUD_CHGR_NM
   					,C.AUD_CHGR_ID
   					,CASE WHEN C.REQ_DVSN_CD = '2' THEN TO_CHAR(A.ACP_DH+30+F_SPMT_RQ_DAY_COUNT(C.REQ_DVSN_CD,C.ACP_YR,C.CVPT_ACP_NO)+NVL(D.BZT_DCN,0),'YYYY-MM-DD')
   						ELSE TO_CHAR(ADD_MONTHS(A.ACP_DH ,1)+F_SPMT_RQ_DAY_COUNT(C.REQ_DVSN_CD,C.ACP_YR,C.CVPT_ACP_NO)+NVL(D.BZT_DCN,0),'YYYY-MM-DD') END AUD_EXEC_DCS_DDLN
   					,CASE
				         WHEN C.REQ_DVSN_CD IN ('2','3') AND EXAM_RPT_APV_DT IS NULL  THEN '해당사항 없음'
				         WHEN C.REQ_DVSN_CD = '2' THEN TO_CHAR(TO_DATE(EXAM_RPT_APV_DT)+60, 'YYYY-MM-DD')
				         ELSE TO_CHAR(ADD_MONTHS(TO_DATE(EXAM_RPT_APV_DT) , 6), 'YYYY-MM-DD')
				       END AS AUD_RSLT_HNDL_DDLN
				    ,TO_CHAR(A.CVPT_WDW_DH,'YYYYMMDD') AS CVPT_WDW_DH
				    ,F_CODE_NM('1000056', A.ACP_RUT_CD) AS ACP_RUT_NM
				    ,C.VRF_YN AS VRF_YN
				    ,C.SND_APV_DOC_NO
				    ,C.SND_STA_CD
   			FROM	TBCSPDCP101M A
   				   ,TBCSPDCP102M B
   				   ,TBCSPEAR001M C
				   ,( SELECT sum(nvl(AUD_DCN,0)) BZT_DCN, D.TSK_KEY1, D.TSK_KEY2, D.TSK_KEY3
						FROM TBBADDED001M A
					    LEFT OUTER JOIN TBBADDED101L B
					            ON A.AUD_YR = B.AUD_YR
					           AND A.AUD_NO = B.AUD_NO
					           AND B.AUD_STEP_CD != 'A1030'                          
					    INNER JOIN TBBADDED002M C
					            ON A.AUD_YR  = C.REL_AUD_YR
					           AND A.AUD_NO = C.REL_AUD_NO
					    INNER JOIN TBBADDED030L D ON A.AUD_YR = D.AUD_YR AND A.AUD_NO = D.AUD_NO  
					    LEFT OUTER JOIN TBCSPDCP101M E
                                ON D.TSK_KEY1 = E.ACP_YR
                                AND D.TSK_KEY2 = E.REQ_DVSN_CD
                                AND D.TSK_KEY3 = E.CVPT_ACP_NO
                        LEFT OUTER JOIN TBCSPEAR001M F
                                ON E.ACP_YR = F.ACP_YR
                                AND E.REQ_DVSN_CD = F.REQ_DVSN_CD
                                AND E.CVPT_ACP_NO = F.CVPT_ACP_NO
                        WHERE 
                             NVL(CASE WHEN F.AUD_RSLT_CD = '08' THEN TO_CHAR(E.CVPT_WDW_DH,'YYYY-MM-DD')        
                                ELSE  
                                    CASE WHEN E.REQ_DVSN_CD = '3' 
                                         THEN NVL(TO_CHAR(TO_DATE(F.EXAM_RPT_APV_DT),'YYYY-MM-DD'),( 
                                            SELECT TO_CHAR(MAX(C1.APV_DH),'YYYY-MM-DD') 
                                                FROM TBBADDED030L A1,TBBADDED103M B1, TBDCMACM023L C1
                                                 WHERE A1.TSK_KEY1(+)=E.ACP_YR 
                                                    AND A1.TSK_KEY2(+)=E.REQ_DVSN_CD 
                                                    AND A1.TSK_KEY3(+) =E.CVPT_ACP_NO
                                                    AND A1.AUD_YR=B1.AUD_YR 
                                                    AND A1.AUD_NO=B1.AUD_NO 
                                                    AND B1.APV_RQS_ID = C1.APV_DOC_NO 
                                                    AND B1.RPRT_CD = 'A10300100' 
                                                    AND B1.APV_STA_CD ='30' 
                                            )
                                         )    
                                     ELSE (SELECT TO_CHAR(TO_DATE(MAX(B.CMT_OEN_DT)),'YYYY-MM-DD') 
                                                FROM TBCSPEAR011M A , TBCSPEAR010M B 
                                                    WHERE A.ACP_YR(+) = E.ACP_YR 
                                                        AND A.REQ_DVSN_CD(+) = E.REQ_DVSN_CD  
                                                        AND A.CVPT_ACP_NO(+) = E.CVPT_ACP_NO 
                                                        AND A.CMT_DVSN_CD = B.CMT_DVSN_CD 
                                                        AND A.CMT_OEN_YE = B.CMT_OEN_YE 
                                                        AND A.CMT_DGE = B.CMT_DGE
                                                        AND A.CMT_RSLT_CD != '09'
                                                        )  
                                    END
                                END,'9999-99-99') > TO_CHAR(TO_DATE(C.AUD_STR_DT),'YYYY-MM-DD')
					    GROUP BY D.TSK_KEY1, D.TSK_KEY2, D.TSK_KEY3 ) D
   			WHERE	1=1
   			AND		A.REQ_DVSN_CD = #{reqDvsnCd}
   			AND		A.ACP_YR = #{acpYr}
   			AND		A.CVPT_ACP_NO = #{cvptAcpNo}
   			AND		A.REQ_DVSN_CD = B.REQ_DVSN_CD
   			AND		A.ACP_YR = B.ACP_YR
   			AND		A.CVPT_ACP_NO = B.CVPT_ACP_NO
   			AND		A.REQ_DVSN_CD = C.REQ_DVSN_CD(+)
   			AND		A.ACP_YR = C.ACP_YR(+)
   			AND		A.CVPT_ACP_NO = C.CVPT_ACP_NO(+)
            AND		A.ACP_YR = D.TSK_KEY1(+) 
            AND		A.REQ_DVSN_CD = D.TSK_KEY2(+) 
            AND		A.CVPT_ACP_NO = D.TSK_KEY3(+)  			
		]]>

	</select>
</mapper> 
