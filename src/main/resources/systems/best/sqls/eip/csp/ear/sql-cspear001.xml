<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.csp.ear.dao.CSPEAR001Mapper">
 	<select id="CSPEAR001EMainSelect" parameterType="paramMap"
		resultType="egovMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR001Mapper.CSPEAR001EMainSelect */
		<![CDATA[
			SELECT	A.REQ_DVSN_CD
					,A.ACP_YR
   					,A.CVPT_ACP_NO
   					,A.ACP_YR||'-'||F_CODE_NM('1000740',A.REQ_DVSN_CD)||'-'||A.CVPT_ACP_NO AS ACP_NO
   					,DECODE(A.REQR_KND_CD,'1',A.CVPTR_NM,'2',A.RPST_PEN_NM,'3',A.RPST_PEN_NM,'4',A.CVPTR_NM) AS CVPTR_NM
   					,A.TIT_NM
   					,A.ACP_DH
   					,B.REQR_DVSN_CD
   					,A.CVPT_HNDL_STA_CD
   					,(	SELECT CASE WHEN COUNT(*) > 1 THEN  F_ORG_INFO(MIN(AUD_TG_ORG_CD),'1')||'외 '|| TO_CHAR(COUNT(*)-1)||'건' 
   								ELSE F_ORG_INFO(MIN(AUD_TG_ORG_CD),'1') END 
   						FROM	TBCSPDCP104L Z
   						WHERE	A.REQ_DVSN_CD = Z.REQ_DVSN_CD
   						AND		A.ACP_YR = Z.ACP_YR
   						AND		A.CVPT_ACP_NO = Z.CVPT_ACP_NO
					) AS AUD_TG_ORG_NM
   			FROM	TBCSPDCP101M A
   					,TBCSPEAR001M B
   			WHERE	1=1
   			AND		A.REQ_DVSN_CD = B.REQ_DVSN_CD(+)
   			AND		A.ACP_YR = B.ACP_YR(+)
   			AND		A.CVPT_ACP_NO = B.CVPT_ACP_NO(+)
		]]>
		<if test='reqDvsnCd != null and reqDvsnCd != ""'>
				AND	A.REQ_DVSN_CD = #{reqDvsnCd}
			</if>
		<if test='reqDvsnCd == null or reqDvsnCd == ""'>
				AND	A.REQ_DVSN_CD IN ('2','3')
			</if>
		<if test='acpDhs != null and acpDhs != ""'>
				AND	A.ACP_DH &gt;= #{acpDhs}
			</if>
		<if test='acpDhe != null and acpDhe != ""'>
				AND	A.ACP_DH &lt;= #{acpDhe}
			</if>
		<if test='titNm != null and titNm != ""'>
				AND	A.TIT_NM LIKE '%'||#{titNm}||'%'
			</if>
		<if test='acpYr != null and acpYr != ""'>
				AND	A.ACP_YR = #{acpYr}
			</if>
		<if test='cvptAcpNo != null and cvptAcpNo != ""'>
				AND	A.CVPT_ACP_NO = #{cvptAcpNo}
			</if>
		<if test='cvptHndlStaCd != null and cvptHndlStaCd != ""'>
				AND	A.CVPT_HNDL_STA_CD = #{cvptHndlStaCd}
			</if>
		<if test='cvptrNm != null and cvptrNm != ""'>
				AND	(A.CVPTR_NM LIKE '%'||#{cvptrNm}||'%' OR A.RPST_PEN_NM LIKE '%'||#{cvptrNm}||'%')
			</if>
		<![CDATA[
			ORDER BY A.ACP_YR DESC, A.CVPT_ACP_NO DESC
		]]>
	</select>
	
	<resultMap type="java.util.HashMap" id="CSPEAR002">
 		<result property="reqDvsnCd" column="REQ_DVSN_CD"                   jdbcType="VARCHAR" javaType="java.lang.String" />
		<result property="acpYr" column="ACP_YR"                             jdbcType="VARCHAR"  javaType="java.lang.String" /> 
		<result property="cvptAcpNo" column="CVPT_ACP_NO"                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpNo" column="ACP_NO"                             jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="reqrKndCd" column="REQR_KND_CD"                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="cvptrNm" column="CVPTR_NM"                         jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="btdt" column="BTDT"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="jbNm" column="JB_NM"                               jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="rpstPenNm" column="RPST_PEN_NM"                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="bzn" column="BZN"                                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="cpnmNm" column="CPNM_NM"                           jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="zcd" column="ZCD"                                   jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="ad" column="AD"                                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="dtlAd" column="DTL_AD"                             jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="tnb1" column="TNB1"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="tnb2" column="TNB2"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="tnb3" column="TNB3"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="hpn1" column="HPN1"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="hpn2" column="HPN2"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="hpn3" column="HPN3"                                 jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="emlId" column="EML_ID"                             jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="emlDmiNm" column="EML_DMI_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="titNm" column="TIT_NM"                             jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpDptCd" column="ACP_DPT_CD"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpDptNm" column="ACP_DPT_NM"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="rcepId" column="RCEP_ID"                           jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="rcepNm" column="RCEP_NM"                           jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="acpDh" column="ACP_DH"                             jdbcType="VARCHAR" javaType="java.lang.String" />
		<result property="cvptHndlStaCd" column="CVPT_HNDL_STA_CD"         jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="cvptTxt" column="CVPT_TXT"                         jdbcType="CLOB"      javaType="java.lang.String" />
		<result property="cvptSbt" column="CVPT_SBT"                         jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="docId" column="DOC_ID"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="reqrCnt" column="REQR_CNT"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="reqrDvsnCd" column="REQR_DVSN_CD"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		<result property="ognzPsoCnt" column="OGNZ_PSO_CNT"                     jdbcType="VARCHAR"  javaType="java.lang.String" />
		
 	</resultMap>
	<select id="CSPEAR002EMainSelect" parameterType="paramMap"
		resultMap="CSPEAR002">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR001Mapper.CSPEAR002EMainSelect */
		<![CDATA[
			SELECT	A.REQ_DVSN_CD
					,A.ACP_YR
   					,A.CVPT_ACP_NO
   					,A.ACP_YR||'-'||F_CODE_NM('1000740',A.REQ_DVSN_CD)||'-'||substring(A.CVPT_ACP_NO, 3, 3) AS ACP_NO
   					,A.REQR_KND_CD
   					,A.CVPTR_NM
   					,A.BTDT
   					,A.JB_NM
   					,A.RPST_PEN_NM
   					,A.BZN
   					,A.CPNM_NM
   					,A.ZCD
   					,A.AD
   					,A.DTL_AD
   					,DECODE(A.TNB,NULL,'',SUBSTR(A.TNB,1,INSTR(A.TNB,'-',1,1)-1)) TNB1
   					,DECODE(A.TNB,NULL,'',SUBSTR(A.TNB,INSTR(A.TNB,'-',1,1)+1,INSTR(A.TNB,'-',1,2)-INSTR(A.TNB,'-',1,1)-1)) AS TNB2
   					,DECODE(A.TNB,NULL,'',SUBSTR(A.TNB,INSTR(A.TNB,'-',1,2)+1)) TNB3
   					,DECODE(A.HPN,NULL,'',SUBSTR(HPN,1,INSTR(HPN,'-',1,1)-1)) HPN1
   					,DECODE(A.HPN,NULL,'',SUBSTR(A.HPN,INSTR(A.HPN,'-',1,1)+1,INSTR(A.HPN,'-',1,2)-INSTR(A.HPN,'-',1,1)-1)) AS HPN2
   					,DECODE(A.HPN,NULL,'',SUBSTR(A.HPN,INSTR(A.HPN,'-',1,2)+1)) HPN3
   					,A.EML_ID
   					,A.EML_DMI_NM
   					,A.TIT_NM
   					,A.ACP_DPT_CD
   					,(	SELECT	S1.DPT_NM
   						FROM 	TBDCMACM002M S1
   						WHERE 	S1.DPT_CD = A.ACP_DPT_CD
   						)  AS ACP_DPT_NM
   					,A.RCEP_ID
   					,F_USR_INFO_BY_ID(A.RCEP_ID,'2') AS RCEP_NM
   					,A.ACP_DH
   					,A.CVPT_HNDL_STA_CD
   					,B.CVPT_TXT
   					,B.CVPT_SBT
   					,A.DOC_ID
   					,C.REQR_CNT
   					,C.REQR_DVSN_CD
   					,C.OGNZ_PSO_CNT
   			FROM	TBCSPDCP101M A
   					,TBCSPDCP102M B
   					,TBCSPEAR001M C
   			WHERE	1=1
   			AND		A.REQ_DVSN_CD = #{reqDvsnCd}
   			AND		A.ACP_YR = #{acpYr}
   			AND		A.CVPT_ACP_NO = #{cvptAcpNo}
   			AND		A.REQ_DVSN_CD = B.REQ_DVSN_CD
   			AND		A.ACP_YR = B.ACP_YR
   			AND		A.CVPT_ACP_NO = B.CVPT_ACP_NO
   			AND		A.REQ_DVSN_CD = C.REQ_DVSN_CD(+)
   			AND		A.ACP_YR = C.ACP_YR(+)
   			AND		A.CVPT_ACP_NO = C.CVPT_ACP_NO(+)
		]]>
			
	</select>
	
	<update id="CSPEAR002EDCP101MainUpdate" parameterType="paramMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR001Mapper.CSPEAR002EDCP101MainUpdate */
        <![CDATA[
        	UPDATE	TBCSPDCP101M
        	SET		CVPTR_NM = #{cvptrNm}
   					,BTDT = #{btdt}
   					,JB_NM = #{jbNm}
   					,RPST_PEN_NM = #{rpstPenNm}
   					,BZN = #{bzn}
   					,CPNM_NM = #{cpnmNm}
   					,ZCD = #{zcd}
   					,AD = #{ad}
   					,DTL_AD = #{dtlAd}
   					,TNB = DECODE(#{tnb1},NULL,'',#{tnb1}||'-'||#{tnb2}||'-'||#{tnb3})
   					,HPN = DECODE(#{hpn1},NULL,'',#{hpn1}||'-'||#{hpn2}||'-'||#{hpn3})
   					,EML_ID = #{emlId}
   					,EML_DMI_NM = #{emlDmiNm}
   					,TIT_NM = #{titNm}
   					,DOC_ID = #{docId}
   					,DOC_TYP_CD = #{docTypCd}
   					,FNL_USR_ID = #{fnlUsrId}
   					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
   					,FNL_MNU_ID = #{fnlMnuId}
   					,FNL_MDF_DH = SYSDATE
   			WHERE	REQ_DVSN_CD = #{reqDvsnCd}
   			AND		ACP_YR = #{acpYr}
   			AND		CVPT_ACP_NO = #{cvptAcpNo}
       	]]>
	</update>
	
	<insert id="CSPEAR002EEAR001Merge" parameterType="paramMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR001Mapper.CSPEAR002EEAR001Merge */
        <![CDATA[
        	MERGE INTO 	TBCSPEAR001M A
        	USING 	(	SELECT 	#{reqDvsnCd} AS REQ_DVSN_CD 
        						,#{acpYr} AS ACP_YR
        						,#{cvptAcpNo} AS CVPT_ACP_NO
        				FROM DUAL
        			) B
        	ON		(	A.REQ_DVSN_CD = B.REQ_DVSN_CD
        				AND	A.ACP_YR = B.ACP_YR
        				AND A.CVPT_ACP_NO = B.CVPT_ACP_NO
        			)
        	WHEN MATCHED THEN
        			UPDATE	
        			SET		REQR_DVSN_CD = #{reqrDvsnCd}
        					,REQR_CNT = #{reqrCnt}
        					,OGNZ_PSO_CNT = #{ognzPsoCnt}
        					,FNL_USR_ID = #{fnlUsrId}
        					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
        					,FNL_MNU_ID = #{fnlMnuId}
        					,FNL_MDF_DH = SYSDATE
        	WHEN NOT MATCHED THEN
		        	INSERT 		(	REQ_DVSN_CD
		        					,ACP_YR
		        					,CVPT_ACP_NO
		        					,REQR_DVSN_CD
		        					,REQR_CNT
		        					,OGNZ_PSO_CNT
		        					,FRT_USR_ID
		        					,FNL_USR_ID
		        					,FNL_DEAL_DPT_CD
		        					,FNL_MNU_ID
		        					,FRT_REGI_DH
		        					,FNL_MDF_DH
		        				)
		        		VALUES	(	#{reqDvsnCd}
									,#{acpYr}
									,#{cvptAcpNo}
									,#{reqrDvsnCd}
		        					,#{reqrCnt}
		        					,#{ognzPsoCnt}
		        					,F_USR_INFO(#{sCnb},'1')
									,#{fnlUsrId}
									,#{fnlDealDptCd}
									,#{fnlMnuId}
									,SYSDATE
									,SYSDATE
								)
        ]]>
	</insert>
	
	<update id="CSPEAR002EDCP101DtmAcpUpdate" parameterType="paramMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR001Mapper.CSPEAR002EDCP101DtmAcpUpdate */
        <![CDATA[
        	UPDATE	TBCSPDCP101M
        	SET		CVPT_HNDL_STA_CD = '20'
   					,FNL_USR_ID = #{fnlUsrId}
   					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
   					,FNL_MNU_ID = #{fnlMnuId}
   					,FNL_MDF_DH = SYSDATE
 		]]>
		<if test='cvptHndlStaCd == "10"'>
   				,RCEP_ID = #{fnlUsrId}
   				,ACP_DPT_CD = #{fnlDealDptCd}
   			</if>
   			<![CDATA[
   			WHERE	REQ_DVSN_CD = #{reqDvsnCd}
   			AND		ACP_YR = #{acpYr}
   			AND		CVPT_ACP_NO = #{cvptAcpNo}
       	]]>
	</update>
	
	<update id="CSPEAR002EDCP101DtmUpdate" parameterType="paramMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR001Mapper.CSPEAR002EDCP101DtmUpdate */
        <![CDATA[
        	UPDATE	TBCSPDCP101M
        	SET		CVPT_HNDL_STA_CD = #{cvptHndlStaCd}
   					,FNL_USR_ID = #{fnlUsrId}
   					,FNL_DEAL_DPT_CD = #{fnlDealDptCd}
   					,FNL_MNU_ID = #{fnlMnuId}
   					,FNL_MDF_DH = SYSDATE
   			WHERE	REQ_DVSN_CD = #{reqDvsnCd}
   			AND		ACP_YR = #{acpYr}
   			AND		CVPT_ACP_NO = #{cvptAcpNo}
       	]]>
	</update>
	
	<update id="CSPEAR002EEAR006Insert" parameterType="paramMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR001Mapper.CSPEAR002EEAR006Insert */
        <![CDATA[
        	INSERT INTO	TBCSPEAR006H
        				(	REQ_DVSN_CD
        					, ACP_YR
        					, CVPT_ACP_NO
        					, SRNO
        					, DTB_DPT_CD
        					, DTB_PEN_ID
        					, CVPT_HNDL_STA_CD
        					, HNDL_DPT_CD
        					, HNDL_CHGR_ID
        					, FRT_USR_ID
        					, FNL_USR_ID
        					, FNL_DEAL_DPT_CD
        					, FNL_MNU_ID
        					, FRT_REGI_DH
        					, FNL_MDF_DH
        				)
        		VALUES	(	#{reqDvsnCd}
        					, #{acpYr}
        					, #{cvptAcpNo}
        					, (	SELECT 	NVL(MAX(SRNO),0)+1
        						FROM	TBCSPEAR006H
        						WHERE	REQ_DVSN_CD = #{reqDvsnCd}
					   			AND		ACP_YR = #{acpYr}
					   			AND		CVPT_ACP_NO = #{cvptAcpNo} )
					   		, F_USR_INFO(#{sCnb}, '5')
					   		, F_USR_INFO(#{sCnb}, '1')
        					, #{cvptHndlStaCd}
        					, #{hndlDptCd}
        					, #{hndlChgrId}
        					, F_USR_INFO(#{sCnb}, '1')
        					, #{fnlUsrId}
        					, #{fnlDealDptCd}
        					, #{fnlMnuId}
        					, SYSDATE
        					, SYSDATE
        				)
       	]]>
	</update>
	
	<select id="CSPEAR002EDCP101Check" parameterType="paramMap"
		resultType="egovMap">
		/* kr.go.bai.eip.csp.ear.dao.CSPEAR001Mapper.CSPEAR002EDCP101Check */
		<![CDATA[
			SELECT	CVPT_HNDL_STA_CD	/*진행상태*/
					,F_CODE_NM('1000361',A.CVPT_HNDL_STA_CD) AS CVPT_HNDL_STA_NM
			FROM	TBCSPDCP101M A
			WHERE	REQ_DVSN_CD = #{reqDvsnCd}
			AND		ACP_YR = #{acpYr}
			AND		CVPT_ACP_NO = #{cvptAcpNo}
		]]>
	</select>
	
</mapper> 