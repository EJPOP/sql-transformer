<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.csp.ear.dao.CSPEAR016Mapper">

	<!--감사사항관리 조회 -->
	<select id="CSPEAR016PMainSelect" parameterType="paramMap" resultType="egovMap">
        <![CDATA[     
	    SELECT T1.AUD_YR           		AS AUD_YR           		/*감사년도*/
	         , T1.AUD_NO           		AS AUD_NO           		/*감사번호*/
	         , T1.AUD_GRN_NO       		AS AUD_GRN_NO         		/*감사부여번호 - 2016.05.25 yyh*/
	         , T1.AUD_YR_N0        		AS AUD_YR_N0        		/*감사년번호*/
	         , T1.AUD_YR_NO_KND_CD      AS AUD_YR_NO_KND_CD         /*감사연번호종류코드*/
	         , T1.AUD_YR_NO_KND_NM      AS AUD_YR_NO_KND_NM         /*감사연번호종류코드명*/
	         , T1.AUD_DTL_NO    		AS AUD_DTL_NO    		    /*세부연번호*/
	         , T1.AUD_TASK_CD      		AS AUD_TASK_CD      		/*감사과제코드*/
             , T1.AUD_TASK_NM      		AS AUD_TASK_NM      		
	         , T1.ORG_DVSN_CD      		AS ORG_DVSN_CD      		/*기관구분코드*/
	         , T1.AUD_KND_CD       		AS AUD_KND_CD       		/*감사종류코드*/
             , T1.AUD_KND_NM       		AS AUD_KND_NM       		
	         , T1.SPV_BRDV_CD      		AS SPV_BRDV_CD      		/*주관국과코드*/
	         , T1.SPV_BRDV_NM  			AS SPV_BRDV_NM  			/*주관국과명*/
	         , T1.AUD_WAY_CD       		AS AUD_WAY_CD       		/*감사방법코드*/
             , T1.AUD_WAY_NM       		AS AUD_WAY_NM       		
	         , T1.AUD_SBJ_NM       		AS AUD_SBJ_NM       		/*감사사항명*/
	         , T1.AUD_SCL_CD       		AS AUD_SCL_CD       		/*감사규모코드*/
	         , T1.TSK_CAT_CD       		AS TSK_CAT_CD       		/*업무분류코드*/
	         , T1.TSK_CAT_NM       		AS TSK_CAT_NM       		
	         , T1.EPS_TASK_CD      		AS EPS_TASK_CD      		/*중점과제코드*/
             , T1.EPS_TASK_NM      		AS EPS_TASK_NM      		
	         , T1.AUD_TOT_DRTR_CNB 		AS AUD_TOT_DRTR_CNB 		/*감사총책임자전산번호*/
	         , T1.TOT_DRTR_RANK_CD 		AS TOT_DRTR_RANK_CD 		/*총책임자직급코드*/
	         , T1.TOT_DRTR_BRDV_CD 		AS TOT_DRTR_BRDV_CD 		/*총책임자국과코드*/
	         , T1.AUD_RPST_ORG_CD  		AS AUD_RPST_ORG_CD  		/*감사대표기관코드*/
	         , T1.AUD_RPST_ORG_NM  		AS AUD_RPST_ORG_NM  		
	         , T1.SPVR_CNB         		AS SPVR_CNB         		/*주관자전산번호*/
	         , T1.SPVR_BRDV_CD     		AS SPVR_BRDV_CD     		/*주관자국과코드*/
	         , T1.SPVR_RANK_CD     		AS SPVR_RANK_CD     		/*주관자직급코드*/
	         , T1.AST_CNB          		AS AST_CNB          		/*보조자전산번호*/    
	         , T1.AST_BRDV_CD      		AS AST_BRDV_CD      		/*보조자국과코드*/
	         , T1.AST_RANK_CD      		AS AST_RANK_CD      		/*보조자직급코드*/
	         , T1.MNG_DPT_CD       		AS MNG_DPT_CD       		/*관리부서코드*/
	         , T1.MNG_DPT_NM			AS MNG_DPT_NM			    		         
		     , T1.ACP_YR 				AS ACP_YR 				    /*청구연도*/
		     , T1.CVPT_ACP_NO 			AS CVPT_ACP_NO 			    /*청구일련번호*/
		     , T1.REQ_DVSN_CD 			AS REQ_DVSN_CD 			    /*청구구분코드*/
		     , T1.TIT_NM 				AS TIT_NM 				    /*청구제목*/
	         , T1.AUD_TOT_DRTR_NM       AS AUD_TOT_DRTR_NM          
	         , T1.AUD_TOT_DRTR_BRDV_NM  AS AUD_TOT_DRTR_BRDV_NM     
	         , T1.AUD_TOT_DRTR_RANK_NM  AS AUD_TOT_DRTR_RANK_NM     
	         , T1.SPVR_NM               AS SPVR_NM                  
	         , T1.SPVR_BRDV_NM          AS SPVR_BRDV_NM             
	         , T1.SPVR_RANK_NM          AS SPVR_RANK_NM             
	         , T1.AST_NM                AS AST_NM                   
	         , T1.AST_BRDV_NM           AS AST_BRDV_NM              
	         , T1.AST_RANK_NM           AS AST_RANK_NM              

             , T1.PRSS_STEP_CD          AS PRSS_STEP_CD             /*진행단계코드*/
			 , F_CODE_NM('1000475',T1.PRSS_STEP_CD)  
		       || 
		       (CASE WHEN SUBSTR(T1.AUD_KND_CD,3) != '55' AND T1.PRSS_STEP_CD = '02'
		                 THEN 
						     (SELECT '/'|| F_CODE_NM('1000030',AUD_BZT_KND_CD)
						        FROM TBBADDED002M 
						       WHERE BZT_YR || BZT_SNO = (SELECT MAX(BZT_YR || BZT_SNO)
												            FROM TBBADDED002M
												           WHERE REL_AUD_YR = T1.AUD_YR
												             AND REL_AUD_NO = T1.AUD_NO
												          )
							 )
				   END) AS PRSS_STEP_NM     		                /*진행단계코드명*/
		     , T1.GKM_CNT 				AS GKM_CNT 				    /*감사지식갯수*/
		     , T1.BZT_CNT				AS BZT_CNT
		     , T1.DVS_AUD_YR            AS DVS_AUD_YR               /*분할감사년도 - 2015.07.13 yyh*/
		     , T1.DVS_AUD_NO            AS DVS_AUD_NO               /*분할감사번호 - 2015.07.13 yyh*/
		     , T1.DVS_AUD_SBJ_NM        AS DVS_AUD_SBJ_NM           /*분할감사사항명 - 2015.07.13 yyh*/
		     , T1.REF_AUD_INFO          AS REF_AUD_INFO  			/*해당건을 분리전 감사사항으로 사용하는 건 - 2015.07.13 yyh */
		     
		     , T1.ITGT_AUD_YR           AS ITGT_AUD_YR              /*통합감사년도 - 2015.09.15 yyh*/
		     , T1.ITGT_AUD_NO           AS ITGT_AUD_NO              /*통합감사번호 - 2015.09.15 yyh*/
		     , T1.ITGT_AUD_SBJ_NM       AS ITGT_AUD_SBJ_NM          /*통합감사사항명 - 2015.09.15 yyh*/
		     , T1.ITGT_AUD_INFO         AS ITGT_AUD_INFO            /*해당건을 통합 감사사항으로 사용하는 건 - 2015.09.15 yyh*/
		     
		     , T1.DVS_AUD_YR_NO_KND_CD  AS DVS_AUD_YR_NO_KND_CD
		     , T1.ITGT_AUD_YR_NO_KND_CD AS ITGT_AUD_YR_NO_KND_CD
		     
  		     /* 다건의 주관자, 보조자 추가 - 2016.05.03 yyh*/
		     , F_USR_INFO(T1.AUDTOR1_CNB1,'2') AS AUDTOR1_CNB1
			 , F_USR_INFO(T1.AUDTOR1_CNB2,'2') AS AUDTOR1_CNB2
			 , F_USR_INFO(T1.AUDTOR1_CNB3,'2') AS AUDTOR1_CNB3
			 , F_USR_INFO(T1.AUDTOR2_CNB1,'2') AS AUDTOR2_CNB1
			 , F_USR_INFO(T1.AUDTOR2_CNB2,'2') AS AUDTOR2_CNB2
			 , F_USR_INFO(T1.AUDTOR2_CNB3,'2') AS AUDTOR2_CNB3
		     
          FROM (
          
			    SELECT D1.AUD_YR                   	AS AUD_YR           /*감사년도*/
			         , D1.AUD_NO                   	AS AUD_NO           /*감사번호*/
			         , D1.AUD_GRN_NO                AS AUD_GRN_NO       /*감사부여번호*/
			         , F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D1.AUD_KND_CD, '-')
			                                        AS AUD_YR_N0        /*감사년번호 - 수정(2015.12.17-yyh)*/
			         , CASE WHEN D1.AUD_YR >= '2016' 
			                     THEN SUBSTR(D1.AUD_KND_CD,3,1)
			                ELSE '' 
			            END                         AS AUD_YR_NO_KND_CD /*감사연번호종류코드 추가 - 2015.12.18 yyh*/
			         , CASE WHEN D1.AUD_YR >= '2016' 
			                     THEN F_CODE_NM('1000739',D1.AUD_KND_CD)   
			                ELSE '-' 
			            END                         AS AUD_YR_NO_KND_NM /*감사연번호종류코드명 추가 - 2015.12.22 yyh*/			            
			         , D1.AUD_YR||'-'||SUBSTR(D1.AUD_TASK_CD,-1)||'-'||D1.ORG_DVSN_CD||'-'||SUBSTR(D1.AUD_KND_CD,-1)
			         ||'-'||SUBSTR(D1.SPV_BRDV_CD,1,2)||SUBSTR(D1.SPV_BRDV_CD,4,2)||'-'||SUBSTR(D1.AUD_WAY_CD,-1)||'-'||D1.AUD_NO AS AUD_DTL_NO    /*세부연번호*/
			         , D1.AUD_TASK_CD              	AS AUD_TASK_CD      /*감사과제코드*/
                     , F_CODE_NM_YEAR('1000008', D1.AUD_TASK_CD, D1.AUD_YR) AS AUD_TASK_NM 
			         , D1.ORG_DVSN_CD              	AS ORG_DVSN_CD      /*기관구분코드*/
			         , D1.AUD_KND_CD               	AS AUD_KND_CD       /*감사종류코드*/
                     , F_CODE_NM_YEAR('1000007', D1.AUD_KND_CD, D1.AUD_YR) AS AUD_KND_NM 
			         , D1.SPV_BRDV_CD              	AS SPV_BRDV_CD      /*주관국과코드*/
			         , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D1.SPV_BRDV_CD
   					) AS SPV_BRDV_NM  /*주관국과명*/
			         , D1.AUD_WAY_CD               	AS AUD_WAY_CD       /*감사방법코드*/
                     , F_CODE_NM_YEAR('1000009', D1.AUD_WAY_CD, D1.AUD_YR) AS AUD_WAY_NM 
			         , D1.AUD_SBJ_NM               	AS AUD_SBJ_NM       /*감사사항명*/
			         , D1.AUD_SCL_CD               	AS AUD_SCL_CD       /*감사규모코드*/
			         , D1.TSK_CAT_CD               	AS TSK_CAT_CD       /*업무분류코드*/
			         , F_CODE_NM('1000120',D1.TSK_CAT_CD) AS TSK_CAT_NM
			         , D1.EPS_TASK_CD             	AS EPS_TASK_CD      /*중점과제코드*/
                     , F_CODE_NM_YEAR('1000005', D1.EPS_TASK_CD, D1.AUD_YR) AS EPS_TASK_NM 
			         , D1.AUD_TOT_DRTR_CNB         	AS AUD_TOT_DRTR_CNB /*감사총책임자전산번호*/
			         , D1.TOT_DRTR_RANK_CD         	AS TOT_DRTR_RANK_CD /*총책임자직급코드*/
			         , D1.TOT_DRTR_BRDV_CD         	AS TOT_DRTR_BRDV_CD /*총책임자국과코드*/
			         , D1.AUD_RPST_ORG_CD          	AS AUD_RPST_ORG_CD  /*감사대표기관코드*/
			         , F_ORG_INFO(D1.AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM
			         , D1.SPVR_CNB                 	AS SPVR_CNB         /*주관자전산번호*/
			         , D1.SPVR_BRDV_CD             	AS SPVR_BRDV_CD     /*주관자국과코드*/
			         , D1.SPVR_RANK_CD            	AS SPVR_RANK_CD     /*주관자직급코드*/
			         , D1.AST_CNB                  	AS AST_CNB          /*보조자전산번호*/    
			         , D1.AST_BRDV_CD              	AS AST_BRDV_CD      /*보조자국과코드*/
			         , D1.AST_RANK_CD              	AS AST_RANK_CD      /*보조자직급코드*/
			         , D1.MNG_DPT_CD               	AS MNG_DPT_CD       /*관리부서코드*/
			         , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D1.MNG_DPT_CD
   					) 	AS MNG_DPT_NM			         
				     , D1.ACP_YR 					AS ACP_YR 			/*청구연도*/
				     , D1.CVPT_ACP_NO 				AS CVPT_ACP_NO 		/*청구일련번호*/
				     , D1.REQ_DVSN_CD 				AS REQ_DVSN_CD 		/*청구구분코드*/
				     , D2.TIT_NM  					AS TIT_NM 			/*청구제목*/
			         , F_USR_INFO(D1.AUD_TOT_DRTR_CNB,'2')		AS AUD_TOT_DRTR_NM
			         , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D1.TOT_DRTR_BRDV_CD
   					) 	AS AUD_TOT_DRTR_BRDV_NM  
			         , F_CODE_NM('1000173',D1.TOT_DRTR_RANK_CD)	AS AUD_TOT_DRTR_RANK_NM
			         , F_USR_INFO(D1.SPVR_CNB,'2')              AS SPVR_NM
			         , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D1.SPVR_BRDV_CD
   					)        AS SPVR_BRDV_NM
			         , F_CODE_NM('1000173',D1.SPVR_RANK_CD)     AS SPVR_RANK_NM
			         , F_USR_INFO(D1.AST_CNB,'2')             	AS AST_NM
			         , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D1.AST_BRDV_CD
   					)       	AS AST_BRDV_NM
			         , F_CODE_NM('1000173',D1.AST_RANK_CD)      AS AST_RANK_NM
			         
 					 , /*실국배정은 NULL로 표기 2015.05.18 yyh*/
		               CASE WHEN SUBSTR(D1.AUD_KND_CD,3) = '55' THEN '' 
		                    WHEN D3.AUD_EXEC_HNDL_STA_CD = '9'  THEN '10' /* 국과별처리현황에 감사실시처리상태코드가 종료(9)면 감사실시처리상태코드를 종료(10)으로- 2015.05.20 yyh*/
	                    
		               /*실국배정 이외 */
		               ELSE 
 					 
	 					   CASE WHEN TRIM(D3.ENF_APV_DT)         IS NOT NULL THEN '10'  /*종료*/
					            WHEN TRIM(D3.CHF_CMTR_APV_DT)    IS NOT NULL THEN '09'  /*주심위원*/
					            WHEN TRIM(D3.OW_DHD_APV_DT)      IS NOT NULL THEN '08'  /*총차장*/
					            WHEN TRIM(D3.JA_JDG_SSEC_APV_DT) IS NOT NULL THEN '07'  /*심의실장*/
					            WHEN TRIM(D3.MDT_DDG_APV_DT)     IS NOT NULL THEN '06'  /*조정담당관*/
					            WHEN TRIM(D3.MDT_OFER_APV_DT)    IS NOT NULL THEN '05'  /*조정담당자*/
					            WHEN TRIM(D3.AUD_BRDV_APV_DT)    IS NOT NULL THEN '04'  /*감사국과*/
					            WHEN TRIM(D3.RTN_RPT_DT)         IS NOT NULL THEN '03'  /*귀청보고*/
					        
					        ELSE 
	                            /* 실지감사중을 출장단계과 귀청보고 준비중으로 분리함 - 2015.05.15 yyh*/				       
					           (CASE 
					                 WHEN 
					                 (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
								           WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
								           ELSE '8'
								       END) = '8' AND D3.RTN_RPT_DT IS NULL AND D3.FLD_AUD_END_DT IS NULL THEN '02'    /*출장단계*/
								       					           
					                 WHEN 
					                 (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
								           WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
								           ELSE '8'
								       END) = '8' AND D3.RTN_RPT_DT IS NULL     THEN '11'    /*귀청보고준비중*/
					                 
					                 WHEN      
					                 (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
								           WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
								           ELSE '8'
								       END) = '7' THEN '02'    /*출장단계*/
					             END) 				                 
				       		END 	
				     END               PRSS_STEP_CD     /*진행단계코드*/         
				     
				   , (SELECT COUNT(1) CNT  
					    FROM TBAEPGKM001M
					   WHERE 1=1
					     AND AUD_YR = D1.AUD_YR
					     AND AUD_NO = D1.AUD_NO
					  )                               AS GKM_CNT /*감사지식갯수*/
				   , (SELECT COUNT(1)
				        FROM TBBADDED002M 
				       WHERE REL_AUD_YR = D1.AUD_YR
				         AND REL_AUD_NO = D1.AUD_NO
				      ) AS BZT_CNT
				   , D1.DVS_AUD_YR                    AS DVS_AUD_YR      /* 분할감사년도 - 2015.07.13 yyh */
				   , D1.DVS_AUD_NO                    AS DVS_AUD_NO      /* 분할감사번호 - 2015.07.13 yyh */
				   , (SELECT CASE WHEN MAX(AUD_YR) >= '2016' 
				                       THEN SUBSTR(MAX(AUD_KND_CD),3,1)
				                  ELSE ''
				              END 
				        FROM TBBADDED001M
				       WHERE AUD_YR = D1.DVS_AUD_YR
				         AND AUD_NO = D1.DVS_AUD_NO)  AS DVS_AUD_YR_NO_KND_CD /* 분리전 감사사항 감사연번호종류코드 - 2015.12.28 yyh */
				   , (SELECT MAX(AUD_SBJ_NM)
				        FROM TBBADDED001M 
				       WHERE AUD_YR = D1.DVS_AUD_YR
				         AND AUD_NO = D1.DVS_AUD_NO)  AS DVS_AUD_SBJ_NM  /* 분할감사사항명 - 2015.07.13 yyh */
				   , (SELECT MAX('(' || AUD_YR || '-' || AUD_NO || ')' || AUD_SBJ_NM) 
				        FROM TBBADDED001M 
				       WHERE DVS_AUD_YR = D1.AUD_YR
				         AND DVS_AUD_NO = D1.AUD_NO)  AS REF_AUD_INFO  /* 해당건을 분리전 감사사항으로 사용하는 건 - 2015.07.13 yyh */
				         
				         
				   , D1.ITGT_AUD_YR                   AS ITGT_AUD_YR     /* 통합감사년도 - 2015.09.15 yyh */
				   , D1.ITGT_AUD_NO                   AS ITGT_AUD_NO     /* 통합감사번호 - 2015.09.15 yyh */	
				   , (SELECT CASE WHEN MAX(AUD_YR) >= '2016' 
				                       THEN SUBSTR(MAX(AUD_KND_CD),3,1)
				                  ELSE ''
				              END 
				        FROM TBBADDED001M
				       WHERE AUD_YR = D1.ITGT_AUD_YR
				         AND AUD_NO = D1.ITGT_AUD_NO)  AS ITGT_AUD_YR_NO_KND_CD /* 통합처리 감사사항 감사연번호종류코드 - 2015.12.28 yyh */				   
				   , (SELECT MAX(AUD_SBJ_NM)
				        FROM TBBADDED001M 
				       WHERE AUD_YR = D1.ITGT_AUD_YR
				         AND AUD_NO = D1.ITGT_AUD_NO)  AS ITGT_AUD_SBJ_NM  /* 통합감사사항명 - 2015.09.15 yyh */
				   , (SELECT MAX('(' || AUD_YR || '-' || AUD_NO || ')' || AUD_SBJ_NM) 
				        FROM TBBADDED001M 
				       WHERE ITGT_AUD_YR = D1.AUD_YR
				         AND ITGT_AUD_NO = D1.AUD_NO)  AS ITGT_AUD_INFO  /* 해당건을 통합전 감사사항으로 사용하는 건 - 2015.09.15 yyh */	
				   
				   , D4.AUDTOR1_CNB1
				   , D4.AUDTOR1_CNB2
				   , D4.AUDTOR1_CNB3
				   , D4.AUDTOR2_CNB1
				   , D4.AUDTOR2_CNB2
				   , D4.AUDTOR2_CNB3
				   		         
				FROM TBBADDED001M D1
			       , TBCSPDCP101M D2
      			   , TBBADDED003M D3
      			   , (SELECT AUD_YR
                            ,AUD_NO 
                            ,MAX(CASE WHEN (AUDTOR_DVSN_CD = '1' AND AUDTOR_SNO = '1') THEN CNB ELSE '' END) AS AUDTOR1_CNB1  /*주관자1*/
                            ,MAX(CASE WHEN (AUDTOR_DVSN_CD = '1' AND AUDTOR_SNO = '2') THEN CNB ELSE '' END) AS AUDTOR1_CNB2  /*주관자2*/
                            ,MAX(CASE WHEN (AUDTOR_DVSN_CD = '1' AND AUDTOR_SNO = '3') THEN CNB ELSE '' END) AS AUDTOR1_CNB3  /*주관자3*/
                            ,MAX(CASE WHEN (AUDTOR_DVSN_CD = '2' AND AUDTOR_SNO = '1') THEN CNB ELSE '' END) AS AUDTOR2_CNB1  /*보조자1*/
                            ,MAX(CASE WHEN (AUDTOR_DVSN_CD = '2' AND AUDTOR_SNO = '2') THEN CNB ELSE '' END) AS AUDTOR2_CNB2  /*보조자2*/
                            ,MAX(CASE WHEN (AUDTOR_DVSN_CD = '2' AND AUDTOR_SNO = '3') THEN CNB ELSE '' END) AS AUDTOR2_CNB3  /*보조자3*/
                        FROM TBBADDED031L 
                       WHERE 1=1
                       GROUP BY AUD_YR, AUD_NO) D4
			   WHERE 1=1
			     AND D1.ACP_YR        = D2.ACP_YR(+)
			     AND D1.CVPT_ACP_NO   = D2.CVPT_ACP_NO(+)
			     AND D1.REQ_DVSN_CD   = D2.REQ_DVSN_CD(+)
			     AND D1.AUD_YR 		  = D3.AUD_YR(+)
			     AND D1.AUD_NO 		  = D3.AUD_NO(+)
			     AND D1.AUD_YR 		  = D4.AUD_YR(+)
			     AND D1.AUD_NO 		  = D4.AUD_NO(+)			     
			     
		         /*AND D1.AUD_NO NOT LIKE '9%' 서면모니터링을 걸러내야하므로*/
		         AND D1.SPV_BRDV_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#{cnb}, #{dptAuth}, '', #{upSpvBrdvCd})))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/   		
		]]>
		<if test='audYr != null and audYr != ""'>
			     AND D1.AUD_YR      = #{audYr}    
		</if>
		
		<if test='audYrNoKndCd != null and audYrNoKndCd != ""'>
	                 /* 감사연번종류코드 - 2015.12.17 yyh */
				     AND SUBSTR(D1.AUD_KND_CD,3,1) = #{audYrNoKndCd} 
			</if>
		
		<if test='audNo != null and audNo != ""'>
			     AND D1.AUD_NO = #{audNo}
		</if>
		<if test='audSbjNm != null and audSbjNm != ""'>
			     AND D1.AUD_SBJ_NM LIKE '%'||#{audSbjNm}||'%'
		</if>
		
		<if test='prssStepCd != null and prssStepCd != ""'>
		    <![CDATA[       
                 AND ( CASE WHEN SUBSTR(D1.AUD_KND_CD,3) = '55' THEN ''   /* 실국배정은 NULL로 표기 2015.05.18 yyh */ 
                            WHEN D3.AUD_EXEC_HNDL_STA_CD = '9'  THEN '10' /* 국과별처리현황에 감사실시처리상태코드가 종료(9)면 감사실시처리상태코드를 종료(10)으로- 2015.05.20 yyh*/
	                    
		               /*실국배정 이외 */
		               ELSE 
 					 
	 					   CASE WHEN TRIM(D3.ENF_APV_DT)         IS NOT NULL THEN '10'  /*종료*/
					            WHEN TRIM(D3.CHF_CMTR_APV_DT)    IS NOT NULL THEN '09'  /*주심위원*/
					            WHEN TRIM(D3.OW_DHD_APV_DT)      IS NOT NULL THEN '08'  /*총차장*/
					            WHEN TRIM(D3.JA_JDG_SSEC_APV_DT) IS NOT NULL THEN '07'  /*심의실장*/
					            WHEN TRIM(D3.MDT_DDG_APV_DT)     IS NOT NULL THEN '06'  /*조정담당관*/
					            WHEN TRIM(D3.MDT_OFER_APV_DT)    IS NOT NULL THEN '05'  /*조정담당자*/
					            WHEN TRIM(D3.AUD_BRDV_APV_DT)    IS NOT NULL THEN '04'  /*감사국과*/
					            WHEN TRIM(D3.RTN_RPT_DT)         IS NOT NULL THEN '03'  /*귀청보고*/
					        
					        ELSE 
	                            /* 실지감사중을 출장단계과 귀청보고 준비중으로 분리함 - 2015.05.15 yyh*/				       
					           (CASE 
					                 WHEN 
					                 (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
								           WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
								           ELSE '8'
								       END) = '8' AND D3.RTN_RPT_DT IS NULL AND D3.FLD_AUD_END_DT IS NULL THEN '02'    /*출장단계*/
								       					           
					                 WHEN 
					                 (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
								           WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
								           ELSE '8'
								       END) = '8' AND D3.RTN_RPT_DT IS NULL     THEN '11'    /*귀청보고준비중*/
					                 
					                 WHEN      
					                 (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
								           WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) )THEN '8'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(NVL(D3.EXTN_HNDL_DDLN_DT, D3.HNDL_DDLN_DT)),'99991231') < TO_DATE(SYSDATE) THEN '6'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
								           WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
								           ELSE '8'
								       END) = '7' THEN '02'    /*출장단계*/
					             END) 				                 
				       		END 	
				     END) = #{prssStepCd}
		    ]]>
		</if>
		
		<if test='audKndCd != null and audKndCd != ""'>
			     AND D1.AUD_KND_CD  = #{audKndCd}
		</if>
		<if test='spvBrdvCd != null and spvBrdvCd != ""'>
			     AND D1.SPV_BRDV_CD = #{spvBrdvCd}
		</if>   
		<if test='reqDvsnCd != null and reqDvsnCd != ""'>
			     AND D1.REQ_DVSN_CD = #{reqDvsnCd}
		</if>     
		<if test='isPop != null and isPop != ""'>
			 <![CDATA[  
			     /*감사사항검색팝업의 경우 서면/모니터링 감사의 경우 통제가 해제된 건에 대해서만 조회되어야 한다. */
				 AND NOT EXISTS (
		                        SELECT 1
		                          FROM TBBADDED001M 
		                         WHERE 1=1
		                           AND AUD_YR = D1.AUD_YR
		                           AND AUD_NO = D1.AUD_NO
		                           AND SUBSTR(AUD_KND_CD,3,1) = '9' 
		                           AND NVL(SUBSTR(AUD_WAY_CD,3,1),' ') <> '4'
		                       )  
			]]>
		</if>
		
        <![CDATA[ 
        	) T1      
 			ORDER BY DECODE(SUBSTR(T1.AUD_NO,1,1),'9',2,1),T1.AUD_NO DESC 
        ]]>
	</select>
	
	<select id="CSPEAR016PSubSelect" parameterType="paramMap" resultType="egovMap">
		<![CDATA[       
			SELECT F_MNG_KND_AUDYRNO(D2.AUD_YR, D2.AUD_NO, D2.AUD_KND_CD, '-') 
			       ||'('|| D1.AUD_STEP_SNO || ')'       AS AUD_YR_NO            /*감사년번호 - 수정(2015.12.17-yyh)*/		
			     , CASE WHEN D2.AUD_YR >= '2016' 
			                 THEN SUBSTR(D2.AUD_KND_CD,3,1)
			            ELSE '' 
			        END                                 AS AUD_YR_NO_KND_CD /*감사연번호종류코드 추가 - 2015.12.18 yyh*/			       	
			     , D1.BZT_YR							AS BZT_YR				/*출장년도*/
			     , D1.BZT_SNO                           AS BZT_SNO              /*출장순번*/
			     , D2.AUD_KND_CD                        AS AUD_KND_CD           /*감사종류코드*/    
			     , F_CODE_NM('1000007',D2.AUD_KND_CD)   AS AUD_KND_NM           /*감사종류명*/
			     , D1.BZT_DVSN_CD                       AS BZT_DVSN_CD          /*출장구분코드*/
			     , D1.AUD_BZT_KND_CD                    AS AUD_BZT_KND_CD       /*감사출장종류코드*/
			     , F_CODE_NM('1000030',D1.AUD_BZT_KND_CD) AS AUD_BZT_KND_NM     /*감사출장종류코드*/
			     , D1.BZT_TL_CNB                        AS BZT_TL_CNB           /*출장반장전산번호*/
			     , D1.BZT_TL_BRDV_CD                    AS BZT_TL_BRDV_CD       /*출장반장국과코드*/    
			     , D1.BZT_TL_RANK_CD                    AS BZT_TL_RANK_CD       /*출장반장직급코드*/
			     , F_USR_INFO(D1.BZT_TL_CNB,'2')        AS BZT_TL_CNB_NM        /*출장반장명*/    
			     , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D1.BZT_TL_BRDV_CD
   					)   AS BZT_TL_BRDV_NM       /*출장반장국과명*/
			     , F_CODE_NM('1000173',D1.BZT_TL_RANK_CD)   AS BZT_TL_RANK_NM   /*출장반장직급명*/
			     , D1.TIT_TXT                           AS TIT_TXT              /*제목내용*/
			     , D1.BZT_BRDV_CD                       AS BZT_BRDV_CD          /*출장국과코드*/
			     , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D1.BZT_BRDV_CD
   					)      AS BZT_BRDV_NM          /*출장국과명*/
			     , D1.HLDY_ACTV_DVSN_CD                 AS HLDY_ACTV_DVSN_CD    /*휴일활동구분코드*/
			     , F_CODE_NM('1000019',D1.HLDY_ACTV_DVSN_CD)                 AS HLDY_ACTV_DVSN_NM    /*휴일활동구분코드*/
			     , D1.REL_AUD_YR                        AS REL_AUD_YR           /*관련감사년도*/
			     , D1.REL_AUD_NO                        AS REL_AUD_NO           /*관련감사번호*/
			     , D2.AUD_GRN_NO                        AS AUD_GRN_NO           /*감사부여번호 - 2016.05.27 yyh*/
			     , D1.AUD_STEP_SNO                      AS AUD_STEP_SNO         /*감사단계순번*/
			     , D1.BZT_TXT                           AS BZT_TXT              /*출장내용*/
			     , D1.CTRL_YN                           AS CTRL_YN              /*통제여부*/
			     , D1.BZT_YR ||'-'||D1.SPRT_NO          AS SPRT_NM              /*지원번호*/
			     , D1.SPRT_NO                           AS SPRT_NO              /*지원번호*/
			     , D1.GEN_BZT_KND_CD                    AS GEN_BZT_KND_CD       /*일반출장구분코드*/
			     , D1.REGI_DT                           AS REGI_DT              /*등록일*/
			     , D1.AUD_STR_DT                        AS AUD_STR_DT           /*감사시작일*/
			     , D1.AUD_END_DT                        AS AUD_END_DT           /*감사종료일*/
			     , D1.AUD_DCN                           AS AUD_DCN              /*감사일수*/
			     , D1.LEAD_EXS_PMT_YN                   AS LEAD_EXS_PMT_YN      /*지휘비지급여부*/
			     , D1.CTRL_TG_YN                        AS CTRL_TG_YN           /*통제대상여부*/
			     , D1.CTRL_DT                           AS CTRL_DT              /*통제일*/
			     , D1.SND_YN                            AS SND_YN               /*송부여부*/
			     , D1.SND_DT                            AS SND_DT               /*송부일*/
			     , D1.FLD_AUD_STEP_NO                   AS FLD_AUD_STEP_NO      /*실지감사단계번호*/
			     , D2.AUD_YR                            AS AUD_YR               /*감사년도*/
			     , D2.AUD_NO                            AS AUD_NO               /*감사번호*/   
			     , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D2.SPV_BRDV_CD
   					)      AS SPV_BRDV_NM          /*주관부서명*/
				 , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D2.MNG_DPT_CD
   					)       AS MNG_DPT_NM           /*관리부서명*/			     
			     , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = (SELECT S2.HIRK_DPT_CD FROM TBDCMACM002M S2 WHERE S2.DPT_CD = D2.SPV_BRDV_CD)
   					) AS SPV_BRDV_UP_NM  /*주관부서명(국)*/
			     , TO_CHAR(TO_DATE(D1.AUD_STR_DT),'YYYY-MM-DD')||'~'|| TO_CHAR(TO_DATE(D1.AUD_END_DT),'YYYY-MM-DD')    AS AUD_ST_END_DT        /*실시기간*/
			     , D2.AUD_SBJ_NM					   AS AUD_SBJ_NM			/*감사사항명*/
                 , CASE WHEN NVL(D1.CTRL_TG_YN,'N') = 'N' THEN '-'
                        WHEN NVL(D1.CTRL_TG_YN,'N') = 'Y' AND NVL(D1.CTRL_YN,'N') = 'Y' THEN 'O' 
                        WHEN NVL(D1.CTRL_TG_YN,'N') = 'Y' AND NVL(D1.CTRL_YN,'N') = 'N' THEN 'X'
                    END AS CTRL_YN_DISP
                 , CASE WHEN NVL(D1.SND_YN,'N') = 'Y' THEN 'O' ELSE 'X' END AS SND_YN_DISP	
                 , (SELECT CASE WHEN COUNT(1)>0 THEN 'Y' ELSE 'N' END  
                      FROM TBBADDED011L
                     WHERE 1=1
                       AND BZT_YR  = D1.BZT_YR
                       AND BZT_SNO = D1.BZT_SNO
                    )  	AS EXP_YN 		/*수정가능여부를 판단하기 위함.*/	 
                 , '' 	AS SEL_YN		/*선택여부를 판단하기위함.(통제화면)*/        
                 , NVL(D3.IN_PSON_CNT,0)    AS IN_PSON_CNT
			     , NVL(D3.EXT_PSON_CNT,0)   AS EXT_PSON_CNT
			     , NVL(D3.IN_PSON_CNT,0)+ NVL(D3.EXT_PSON_CNT,0) AS PSON_CNT
			     , NVL(D3.IN_PSON_CNT,0)||'/'||NVL(D3.EXT_PSON_CNT,0)||'/'||(NVL(D3.IN_PSON_CNT,0)+ NVL(D3.EXT_PSON_CNT,0)) AS ALL_PSON_CNT 
			     , F_ORG_CNT_NM_AUD(D1.BZT_YR,D1.BZT_SNO,'BZT') AS ORG_CNT_NM
                 , (SELECT CASE WHEN COUNT(1)>0 THEN 'Y' ELSE 'N' END  
                      FROM TBBADDED004L
                     WHERE 1=1
                       AND BZT_YR  = D1.BZT_YR
                       AND BZT_SNO = D1.BZT_SNO
                    )  	AS TEAM_YN
                
                , TO_CHAR(TO_DATE(D1.AUD_STR_DT),'YYYY-MM-DD')||'~'|| TO_CHAR(TO_DATE(D1.AUD_END_DT),'YYYY-MM-DD') 
                  || '(' || D1.AUD_DCN || ')'                                                                      AS AUD_ST_END_DT_DCN  /*실시기간+일수 - 2015.06.02 yyh*/
                
                /* 출장예산구분 추가 - 2016.05.27 yyh */
                , D2.BZT_BGT_DVSN_CD                      AS BZT_BGT_DVSN_CD
                , F_CODE_NM('1000751',D2.BZT_BGT_DVSN_CD) AS BZT_BGT_DVSN_NM
			  FROM TBBADDED002M D1
			     , TBBADDED001M D2
			     , (
			        SELECT BZT_YR
			             , BZT_SNO
			             , SUM( CASE WHEN A.STF_DVSN_CD = '0' THEN 1 ELSE 0 END) AS IN_PSON_CNT  /*내부인원*/
			             , SUM( CASE WHEN A.STF_DVSN_CD = '0' THEN 0 ELSE 1 END) AS EXT_PSON_CNT /*외부인원*/
			          FROM (SELECT DISTINCT BZT_YR
			                     , BZT_SNO
			                     , PCT_CNB
			                     , STF_DVSN_CD
			                  FROM TBBADDED005L) A
			         GROUP BY BZT_YR, BZT_SNO 
			     ) D3			     
			WHERE 1=1
			  AND D1.BZT_DVSN_CD = '1' /*감사출장*/
			  AND D1.REL_AUD_YR = D2.AUD_YR
			  AND D1.REL_AUD_NO = D2.AUD_NO
			  AND D1.BZT_YR     = D3.BZT_YR(+)
			  AND D1.BZT_SNO    = D3.BZT_SNO(+)
			  AND D2.MNG_DPT_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#{cnb}, #{dptauth}, '', #{upspvbrdvcd})))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/   		
		]]>			 
		<if test='spvBrdvCd != null and spvBrdvCd != ""'>
			  AND D2.MNG_DPT_CD  = #{spvBrdvCd}
		</if>      
		<if test='bztDvsnCd != null and bztDvsnCd != ""'>
			  AND D1.BZT_DVSN_CD = #{bztDvsnCd}
		</if>	  
		<if test='audYr != null and audYr != ""'>
			  AND D1.REL_AUD_YR      = #{audYr}
		</if>
		<if test='audNo != null and audNo != ""'>
			  AND D1.REL_AUD_NO      = #{audNo}
		</if>
		
		<if test='audYrNoKndCd != null and audYrNoKndCd != ""'>
	              /* 감사연번종류코드 - 2015.12.18 yyh */
				  AND SUBSTR(D2.AUD_KND_CD,3,1) = #{audYrNoKndCd} 
		</if>		
		
		<if test='audGrnNo != null and audGrnNo != ""'>
			  /* 감사부여번호 추가 - 2016.05.27 yyh */	 	
			  AND D2.AUD_GRN_NO      = #{audGrnNo}
		</if>	
				
		<if test='audSbjNm != null and audSbjNm != ""'>
			  AND D2.AUD_SBJ_NM LIKE '%'||#{audSbjNm}||'%'
		</if>
		<if test='audKndCd != null and audKndCd != ""'>
			  AND D2.AUD_KND_CD  = #{audKndCd}		/*감사종류코드*/ 
		</if>
		<if test='bztKndCd != null and bztKndCd != ""'>
			  AND D1.AUD_BZT_KND_CD  = #{bztKndCd}		/*출장종류코드*/ 
		</if>
		<if test='spvBrdvCd != null and spvBrdvCd != ""'>
			  AND D1.BZT_BRDV_CD = #{spvBrdvCd}		 /*출장국과코드*/
		</if>   
		<if test='ctrlYn == "Y"'>
			  AND D1.CTRL_YN = 'Y'
		</if>
		<if test='ctrlYn == "N"'>
			  AND NVL(D1.CTRL_YN,'N') = 'N'
		</if>	
		<if test='sndYn == "Y"'>
			  AND D1.SND_YN = 'Y'
		</if>
		<if test='sndYn == "N"'>
			  AND NVL(D1.SND_YN,'N') = 'N'
		</if>					
		<if test='bztSno != null and bztSno != ""'>
			  AND D1.BZT_SNO = #{bztSno}
		</if>		
		<if test='bztYr != null and bztYr != ""'>
			  AND D1.BZT_YR = #{bztYr}
		</if>	
		<if test='masterYn == "MASTER"'>
			 AND D1.CTRL_TG_YN = 'Y'
			 AND D1.SND_YN = 'Y'
		</if>
		<if test='titTxt != null and titTxt != ""'>
			 AND D1.TIT_TXT LIKE #{titTxt}||'%'
		</if>
        <![CDATA[       
			 ORDER BY D1.REL_AUD_NO DESC , D1.AUD_STEP_SNO DESC
        ]]>
	</select>
	
	<select id="CSPEAR016PBztSelect" parameterType="paramMap" resultType="egovMap">
	<![CDATA[       
			SELECT D1.AUD_YR                         AS AUD_YR                          /*감사년도*/
			     , D1.AUD_NO                         AS AUD_NO                          /*감사번호*/
			     , D3.AUD_GRN_NO                     AS AUD_GRN_NO                      /*감사부여번호 - 2016.05.31 yyh*/
			     , D1.AUD_YR||D1.AUD_NO              AS AUD_YR_NO   
			     , D3.SPV_BRDV_NM                    AS SPV_BRDV_NM                     /*주관국과명*/
			     , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D3.SPV_BRDV_CD
   					)    AS SPV_BRDV_CD
			     , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D3.MNG_DPT_CD
   					)     AS MNG_DPT_CD                      /*관리부서 - 2016.03.08 yyh*/
			     , D3.AUD_SBJ_NM                     AS AUD_SBJ_NM                      /*감사사항*/
			     , D3.AUD_ORG_CNT                    AS AUD_ORG_CNT                     /*기관명*/
			     , D1.DSP_RQ_SNO                     AS DSP_RQ_SNO                      /*처분요구순번*/
			     , F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D3.AUD_KND_CD, '-') ||'-'|| D1.DSP_RQ_SNO 
			                                         AS DSP_RQ_SNO_NM                   /*처분요구순번DISP*/
			     , CASE WHEN D1.AUD_YR >= '2016' 
			                 THEN SUBSTR(D3.AUD_KND_CD,3,1)
			            ELSE '' 
			        END                              AS AUD_YR_NO_KND_CD /*감사연번호종류코드 추가 - 2015.12.18 yyh*/				                                         
			     , D1.FRM_NO                         AS FRM_NO                          /*서식번호*/
			     , D1.RPRT_NO                        AS RPRT_NO                         /*보고서식번호*/
			     , D1.TIT_TXT                        AS TIT_TXT                         /*제목내용*/    
			     , D1.DSP_RQ_KND_CD                  AS DSP_RQ_KND_CD                   /*처분요구종류코드*/
			     , D1.ORG_DVSN_CD                    AS ORG_DVSN_CD                     /*기관구분코드*/
			     , D1.AUD_EPS_CD                     AS AUD_EPS_CD                      /*감사중점코드*/
			     , D2.DSP_RQ_SRNO                    AS DSP_RQ_SRNO                     /*처분요구일련번호*/
			     , D2.ENF_DT                         AS ENF_DT                          /*시행일*/
			     , D2.HNDL_DDLN_DT                   AS HNDL_DDLN_DT                    /*처리기한일*/
			     , D2.ENF_BRDV_CD                    AS ENF_BRDV_CD                     /*시행국과코드*/
			     , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D2.ENF_BRDV_CD
   					) 	 AS ENF_BRDV_NM                     /*시행국과명*/
			     , D2.DOC_SEN_NO                     AS DOC_SEN_NO                      /*문서발송코드*/
			     , D2.WRDO_CAU_CD                    AS WRDO_CAU_CD                     /*비위원인코드*/
			     , D2.ENFM_MNG_BRDV_CD               AS ENFM_MNG_BRDV_CD                /*집행관리국과코드*/    
			     , D2.DTM_YN                         AS DTM_YN                          /*확정여부*/
			     , D2.DTM_STA_CD                     AS DTM_STA_CD                      /*확정상태코드*/
			     , D2.HMP_OPEN_YN                    AS HMP_OPEN_YN                     /*홈페이지공개여부*/
			     , D2.DTY_OBV_UTL_YN                 AS DTY_OBV_UTL_YN                  /*직무관철활용여부*/
			     , CASE WHEN SUBSTR(D2.WRDO_TYP_CD,1,1) = '1' THEN '100000000'
			            WHEN SUBSTR(D2.WRDO_TYP_CD,1,1) = '2' THEN '200000000'    
			            ELSE ''
			         END                             AS WRDO_TYP_CD                     /*비위유형코드 - 수정 2016.05.11 yyh*/
			     , D2.DSP_RQ_APV_STA_CD              AS DSP_RQ_APV_STA_CD               /*처분요구결재상태코드*/
			     , D2.TSK_CAT_CD                     AS TSK_CAT_CD                      /*업무분류코드*/
			     , F_CODE_NM('1000121',D2.WRDO_TYP_CD) AS WRDO_TYP_NM                   /*비위유형코드명*/      
			     , F_CODE_NM('1000120',D2.TSK_CAT_CD)  AS TSK_CAT_NM                    /*업무분류명*/
			     , F_CODE_NM('1000002',D1.DSP_RQ_KND_CD )  AS DSP_RQ_KND_NM                    /*처분요구종류명*/
			     , F_CODE_NM('1000017',D2.DTM_STA_CD )  AS DTM_STA_NM                   /*결재상태명*/
			     , CASE WHEN NVL(D4.CNT,0)>0 THEN 'Y' ELSE 'N' END  AS FRE_CNT			/*집행전말입력여부*/
				 , D2.PSC_RQT_NOP_CNT													/*고발인원*/
			     , D2.NOP_CNT 															/*인원*/
			     , CASE WHEN RLTN_ORG_CD IS NOT NULL THEN F_ORG_INFO(D2.RLTN_ORG_CD,'1')||'외 '||D5.CNT  ELSE '' END RLTN_ORG_NM /*관계기관*/
			     , CASE WHEN COPT_OFI_CD IS NOT NULL THEN F_ORG_INFO(D2.COPT_OFI_CD,'1')|| DECODE(D7.CNT,0,'','외 '||D7.CNT) ELSE '' END COPT_OFI_NM /*소관청*/
			     , COPT_OFI_CD AS COPT_OFI_CD /* 추가 - 2016.04.28 yyh*/
			     
			     /* 처분요구사항실시내역 추가 - 2016.02.24 yyh */
			     , Z1.DVSN_CD                AS DVSN_CD    /* 구분코드 */
			     , Z1.TSK_KEY1               AS TSK_KEY1   /* 업무키1 */
			     , Z1.TSK_KEY2               AS TSK_KEY2   /* 업무키2 */
			     , Z1.TSK_KEY3               AS TSK_KEY3   /* 업무키3 */
			     , Z1.TSK_KEY4               AS TSK_KEY4   /* 업무키4 */
			     , CASE WHEN Z1.DVSN_CD IN ('1','2','3') THEN (SELECT S1.ACP_YR||'-'||F_CODE_NM('1000740',S1.REQ_DVSN_CD)||'-'||S1.RM_CVPT_ACP_NO
			     									  		     FROM TBCSPDCP101M S1
			      											    WHERE Z1.TSK_KEY1 = S1.ACP_YR
			      									  		      AND Z1.TSK_KEY2 = S1.REQ_DVSN_CD
			      											      AND Z1.TSK_KEY3 = S1.CVPT_ACP_NO)
			      												
			            WHEN Z1.DVSN_CD = '4'            THEN ''
			            WHEN Z1.DVSN_CD IN ('5','6','7') THEN (SELECT CASE WHEN S1.ACP_YR >= '2016' 
		 	                                                                 THEN S1.ACP_YR || '-' || DECODE(S1.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') || '-' || S1.ACP_SRNO
		 	                                                            ELSE 
		 	                                                                      S1.ACP_YR || '-' || S1.ACP_DVSN_CD || '-' || S1.ACP_SRNO
		 	                                                             END
			                                                  FROM TBBADFRE012M S1 
			                                                 WHERE Z1.TSK_KEY1 = S1.ACP_YR   
			                                                   AND Z1.TSK_KEY2 = S1.ACP_DVSN_CD
			                                                   AND Z1.TSK_KEY3 = S1.ACP_SRNO
			                                                   AND Z1.TSK_KEY4 = S1.DPT_CD)
                        WHEN Z1.DVSN_CD IN ('8','9')     THEN (SELECT CASE WHEN S1.OGN_DVSN_CD = '6' 
					                                                                 THEN S1.YR||'-판청-'||S1.ACP_NO
					                                                            ELSE S1.YR||'-손망-'||S1.ACP_NO
					                                                        END 
					                                                  FROM TBBADGDA001M S1
					                                                 WHERE Z1.TSK_KEY1 = S1.ORG_CD   
					                                                   AND Z1.TSK_KEY2 = S1.NTF_DVSN_CD
					                                                   AND Z1.TSK_KEY3 = S1.NNB)	
					    WHEN Z1.DVSN_CD = '0'            THEN Z1.TSK_KEY1 ||'-정보-'|| Z1.TSK_KEY2
					    WHEN Z1.DVSN_CD = 'A'            THEN F_MNG_KND_AUDYRNO(Z1.TSK_KEY1, Z1.TSK_KEY2, (SELECT AUD_KND_CD 
					                                                                                         FROM TBBADDED001M 
					                                                                                        WHERE AUD_YR = Z1.TSK_KEY1 
					                                                                                          AND AUD_NO = Z1.TSK_KEY2), '-')  ||'-'|| 
					                                          Z1.TSK_KEY3                                                                      ||'-'|| 
					                                          F_ORG_INFO(Z1.TSK_KEY4,'1')
			            ELSE ''
			        END                      AS TSK_KEY_NO /* 실시번호 */
			      ,D2.AUD_YR || '-' || D2.AUD_NO || '-' || D2.DSP_RQ_SNO AS AUD_YR_NO_FOCUS /* 저장 후 ROW위치 지정 */
			  FROM TBBADEAR001M D1
			     , TBBADEAR002D D2
			     , TBBADEAR035L Z1
			     , (
			           SELECT D1.AUD_YR
			                , D1.AUD_NO
			                , D1.AUD_GRN_NO
			                , D1.AUD_KND_CD 
			                , (	SELECT	S1.DPT_NM
   						FROM	TBDCMACM002M S1
   						WHERE	S1.DPT_CD = D1.SPV_BRDV_CD
   					) ||'(단장 : '||F_USR_INFO(D1.AUD_TOT_DRTR_CNB,'2')||', 주관 : '||F_USR_INFO(D1.SPVR_CNB,'2')||')' AS SPV_BRDV_NM               
			                , '<'||F_CODE_NM('1000007',D1.AUD_KND_CD) ||'>'||D1.AUD_SBJ_NM AS AUD_SBJ_NM
			                , F_ORG_CNT_NM_AUD(D1.AUD_YR,D1.AUD_NO,'AUD') AS AUD_ORG_CNT
			            	, D1.SPV_BRDV_CD
			            	, D1.MNG_DPT_CD
			            FROM TBBADDED001M D1
			           WHERE 1=1
			             AND D1.MNG_DPT_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#{cnb}, #{dptAuth}, '', #{upSpvBrdvCd})))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/
		]]>			             
           			             
		<if test='audYrNoKndCd != null and audYrNoKndCd != ""'>
			             /* 감사연번종류코드 - 2015.12.18 yyh */
						 AND SUBSTR(D1.AUD_KND_CD,3,1) = #{audYrNoKndCd} 
		</if>		

		<if test='spvBrdvCd != null and spvBrdvCd != ""'>
			   			 AND D1.MNG_DPT_CD = #{spvBrdvCd}
		</if>

		<!-- 감사부여번호 조건 추가 - 2016.05.31 yyh -->
		<if test='audGrnNo != null and audGrnNo != ""'>
	         			AND D1.AUD_GRN_NO = #{audGrnNo}
		</if>
		
        <![CDATA[       
			       ) D3
			     , (
			         SELECT AUD_YR
				          , AUD_NO
				          , DSP_RQ_SNO 
				          , COUNT(1) CNT 
				       FROM TBBADFRE001M
				      GROUP BY AUD_YR
				             , AUD_NO
				             , DSP_RQ_SNO    
			     ) D4
			     , (/*관계기관*/
			        SELECT AUD_YR, AUD_NO, DSP_RQ_SNO , COUNT(1)-1 CNT 
			          FROM TBBADEAR006M
			         GROUP BY AUD_YR, AUD_NO, DSP_RQ_SNO 
			       ) D5
			     , (/*소관청*/
			        SELECT AUD_YR, AUD_NO, DSP_RQ_SNO , COUNT(1)-1 CNT 
			          FROM TBBADEAR008M
			         GROUP BY AUD_YR, AUD_NO, DSP_RQ_SNO 
			       ) D7     			     
			 WHERE 1=1
			   AND D1.AUD_YR     = D2.AUD_YR
			   AND D1.AUD_NO     = D2.AUD_NO
			   AND D1.DSP_RQ_SNO = D2.DSP_RQ_SNO
			   AND D1.AUD_YR     = D3.AUD_YR
			   AND D1.AUD_NO     = D3.AUD_NO   
			   AND D1.AUD_YR     = D4.AUD_YR(+)
			   AND D1.AUD_NO     = D4.AUD_NO(+)
			   AND D1.DSP_RQ_SNO = D4.DSP_RQ_SNO(+)
			   AND D1.AUD_YR     = D5.AUD_YR(+)
			   AND D1.AUD_NO     = D5.AUD_NO(+)
			   AND D1.DSP_RQ_SNO = D5.DSP_RQ_SNO(+)
			   AND D1.AUD_YR     = D7.AUD_YR(+)
			   AND D1.AUD_NO     = D7.AUD_NO(+)
			   AND D1.DSP_RQ_SNO = D7.DSP_RQ_SNO(+)
			   
			   /* 처분요구사항실시내역 추가 - 2016.02.24 yyh */
			   AND D1.AUD_YR     = Z1.AUD_YR(+)
			   AND D1.AUD_NO     = Z1.AUD_NO(+)
			   AND D1.DSP_RQ_SNO = Z1.DSP_RQ_SNO(+)
		]]>

		<if test='enfYr != null and enfYr != ""'>
			   AND D2.ENF_DT     LIKE #{enfYr}||'%'
		</if>
		<if test='dtmStaCd != null and dtmStaCd != ""'>
			   AND D2.DTM_STA_CD  = #{dtmStaCd}
		</if>
		<if test='dspRqKndCd != null and dspRqKndCd != ""'>
			   AND D1.DSP_RQ_KND_CD = #{dspRqKndCd}
		</if>
		<if test='audYr != null and audYr != ""'>
			   AND D1.AUD_YR      = #{audYr}
		</if>
		<if test='audNo != null and audNo != ""'>
			   AND D1.AUD_NO      = #{audNo}
		</if>
		<if test='dspRqSno != null and dspRqSno != ""'>
			   AND D1.DSP_RQ_SNO      = #{dspRqSno}
		</if>			
		<if test='titTxt != null and titTxt != ""'>
			   AND D1.TIT_TXT LIKE '%'||#{titTxt}||'%'
		</if>
		<if test='reqPgmId == "BADEAR003E"'>
			 ORDER BY D1.AUD_YR DESC , D1.AUD_NO DESC, D1.DSP_RQ_SNO DESC 			
		</if>
		<if test='reqPgmId == "BADEAR010E"'>
			 ORDER BY D1.AUD_YR DESC , D1.AUD_NO DESC, D1.DSP_RQ_SNO 
		</if>	
	</select>
</mapper> 