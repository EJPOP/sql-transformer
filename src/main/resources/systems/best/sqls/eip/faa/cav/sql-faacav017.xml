<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.faa.cav.dao.FAACAV017QMapper">
    
    <select id="selectLoadSttcList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV017QMapper.selectLoadSttcList */
        <![CDATA[
            WITH BASE AS ( 
                SELECT T2.AUD_YR 
                      ,T2.AUD_NO
                      ,T3.DSP_RQ_SNO
                      ,SUBSTR(T2.ENF_DT,0,4)                                AS ENF_DT_YR
                      ,T4.HND_RQ_KND_CD
                      ,T5.ENFM_SHP_CD
                      ,(CASE WHEN T5.ENFM_SHP_CD = '210' THEN 1 ELSE 0 END) AS COUNT_1  /* 파면 */
                      ,(CASE WHEN T5.ENFM_SHP_CD = '220' THEN 1 ELSE 0 END) AS COUNT_2  /* 해임 */
                      ,(CASE WHEN T5.ENFM_SHP_CD = '225' THEN 1 ELSE 0 END) AS COUNT_3  /* 강등 */
                      ,(CASE WHEN T5.ENFM_SHP_CD = '230' THEN 1 ELSE 0 END) AS COUNT_4  /* 정직 */
                      ,(CASE WHEN T5.ENFM_SHP_CD = '260' THEN 1 ELSE 0 END) AS COUNT_5  /* 감봉 */
                      ,(CASE WHEN T5.ENFM_SHP_CD = '270' THEN 1 ELSE 0 END) AS COUNT_6  /* 견책 */
                      ,(CASE WHEN T5.ENFM_SHP_CD IN ('271','281','282','283','284','285','780','899') THEN 1 ELSE 0 END)
                                                                            AS COUNT_7  /* 경고 등 징계미만 */
                      ,(CASE WHEN T5.ENFM_SHP_CD IN ('240','286','490','495','910','920','990','530') THEN 1 ELSE 0 END)  /* 기타건 인대 사망이라 종결로*/
                                                                            AS COUNT_8  /* 종결 */
                      ,(CASE WHEN T5.ENFM_SHP_CD IN ('290','360','480','900') THEN 1 ELSE 0 END)
                                                                            AS COUNT_9  /* 이행중 */
                      ,(CASE WHEN T5.ENFM_SHP_CD IS NULL THEN 1 ELSE 0 END) AS COUNT_10 /* 관계자이행상황미입력 */
                  FROM TBBADEAR001M T1
                      ,TBBADEAR002D T2
                      ,TBBADEAR006M T3
                      ,TBBADEAR007M T4
                      ,(SELECT S1.AUD_YR
                              ,S1.AUD_NO
                              ,S1.DSP_RQ_SNO
                              ,S1.RLTN_ORG_CD
                              ,S1.DFNT_SNO
                              ,S1.ENFM_SNO
                              ,S1.ENFM_SHP_CD
                         FROM TBBADFRE008M S1
                        WHERE S1.ENFM_SNO = (SELECT MAX(ENFM_SNO)
                                               FROM TBBADFRE008M
                                              WHERE AUD_YR      = S1.AUD_YR
                                                AND AUD_NO      = S1.AUD_NO
                                                AND DSP_RQ_SNO  = S1.DSP_RQ_SNO
                                                AND RLTN_ORG_CD = S1.RLTN_ORG_CD
                                                AND DFNT_SNO    = S1.DFNT_SNO)
                        ) T5
                 WHERE 1=1
                   AND T1.AUD_YR      = T2.AUD_YR
                   AND T1.AUD_NO      = T2.AUD_NO
                   AND T1.DSP_RQ_SNO  = T2.DSP_RQ_SNO
                   AND T1.AUD_YR      = T3.AUD_YR
                   AND T1.AUD_NO      = T3.AUD_NO
                   AND T1.DSP_RQ_SNO  = T3.DSP_RQ_SNO
                   AND T3.AUD_YR      = T4.AUD_YR
                   AND T3.AUD_NO      = T4.AUD_NO
                   AND T3.DSP_RQ_SNO  = T4.DSP_RQ_SNO
                   AND T3.RLTN_ORG_CD = T4.RLTN_ORG_CD
                   AND T4.AUD_YR      = T5.AUD_YR(+)
                   AND T4.AUD_NO      = T5.AUD_NO(+)
                   AND T4.DSP_RQ_SNO  = T5.DSP_RQ_SNO(+)
                   AND T4.RLTN_ORG_CD = T5.RLTN_ORG_CD(+)
                   AND T4.DFNT_SNO    = T5.DFNT_SNO(+)
                   AND T2.DTM_STA_CD    IN ('1','2')  
                   AND T2.ENF_DT        BETWEEN TO_DATE(TO_CHAR(ADD_MONTHS(#{proStadDt}, -49), 'YYYY')||'-01-01') AND LAST_DAY(ADD_MONTHS(#{proStadDt}, -1))
                   AND T2.ENFM_MNG_BRDV_CD IS NOT NULL
                   AND T4.HND_RQ_KND_CD IN ('001','002','003','004','013')
            )
                SELECT ENF_DT_YR AS AUD_YR
                      ,HND_RQ_KND_CD AS ROW_KND_CD
                      ,STTC_TIT1
                      ,STTC_COL1
                      ,STTC_COL2
                      ,STTC_COL3
                      ,STTC_COL4
                      ,STTC_COL5
                      ,STTC_COL6
                      ,STTC_COL7
                      ,STTC_COL8
                      ,STTC_COL9
                      ,STTC_COL10
                     /* ,STTC_COL11 */
                      ,CASE WHEN ENF_DT_YR = 'SUM' THEN 'Y'
                            WHEN ENF_DT_YR = 'TOT' THEN 'Y'
                            WHEN SUBSTR(ADD_MONTHS(#{proStadDt}, -1), 0, 4) - 1 > ENF_DT_YR THEN 'N'
                            ELSE 'Y'
                       END VIEW_YN
                  FROM (
                     SELECT CASE WHEN HND_RQ_KND_CD IS NULL THEN 'TOT'
                                 ELSE 'SUM' 
                            END AS ENF_DT_YR
                            ,HND_RQ_KND_CD
                            ,CASE WHEN HND_RQ_KND_CD IS NULL THEN '합계(5년간)'
                                 WHEN HND_RQ_KND_CD = '001' THEN '파면'
                                 WHEN HND_RQ_KND_CD = '002' THEN '해임(면직)'
                                 WHEN HND_RQ_KND_CD = '013' THEN '강등'
                                 WHEN HND_RQ_KND_CD = '003' THEN '정직'
                                 WHEN HND_RQ_KND_CD = '004' THEN '경징계 이상'
                             END                                 AS STTC_TIT1
                           ,SUM(COUNT_1) + SUM(COUNT_2) + SUM(COUNT_3) + 
                            SUM(COUNT_4) + SUM(COUNT_5) + SUM(COUNT_6) + 
                            SUM(COUNT_7) + SUM(COUNT_8) + SUM(COUNT_9) + SUM(COUNT_10)
                                                                 AS STTC_COL1
                           ,SUM(COUNT_1)                         AS STTC_COL2
                           ,SUM(COUNT_2)                         AS STTC_COL3
                           ,SUM(COUNT_3)                         AS STTC_COL4
                           ,SUM(COUNT_4)                         AS STTC_COL5
                           ,SUM(COUNT_5)                         AS STTC_COL6
                           ,SUM(COUNT_6)                         AS STTC_COL7
                           ,SUM(COUNT_7)                         AS STTC_COL8
                           ,SUM(COUNT_8)                         AS STTC_COL9
                           ,SUM(COUNT_9)                         AS STTC_COL10
                           ,SUM(COUNT_10)                        AS STTC_COL11
                       FROM BASE
                      GROUP BY ROLLUP(HND_RQ_KND_CD)
                      UNION ALL
                     SELECT ENF_DT_YR                AS 시행년도
                           ,HND_RQ_KND_CD
                           ,CASE WHEN ENF_DT_YR     IS NULL THEN '총계'
                                 WHEN HND_RQ_KND_CD IS NULL THEN ENF_DT_YR || '년 계'
                                 WHEN HND_RQ_KND_CD = '001' THEN '파면'
                                 WHEN HND_RQ_KND_CD = '002' THEN '해임(면직)'
                                 WHEN HND_RQ_KND_CD = '013' THEN '강등'
                                 WHEN HND_RQ_KND_CD = '003' THEN '정직'
                                 WHEN HND_RQ_KND_CD = '004' THEN '경징계 이상'
                             END                                 AS STTC_TIT1
                           ,SUM(COUNT_1) + SUM(COUNT_2) + SUM(COUNT_3) + 
                            SUM(COUNT_4) + SUM(COUNT_5) + SUM(COUNT_6) + 
                            SUM(COUNT_7) + SUM(COUNT_8) + SUM(COUNT_9) + SUM(COUNT_10)
                                                                 AS STTC_COL1
                           ,SUM(COUNT_1)                         AS STTC_COL2
                           ,SUM(COUNT_2)                         AS STTC_COL3
                           ,SUM(COUNT_3)                         AS STTC_COL4
                           ,SUM(COUNT_4)                         AS STTC_COL5
                           ,SUM(COUNT_5)                         AS STTC_COL6
                           ,SUM(COUNT_6)                         AS STTC_COL7
                           ,SUM(COUNT_7)                         AS STTC_COL8
                           ,SUM(COUNT_8)                         AS STTC_COL9
                           ,SUM(COUNT_9)                         AS STTC_COL10
                           ,SUM(COUNT_10)                        AS STTC_COL11
                       FROM BASE
                      GROUP BY ROLLUP(ENF_DT_YR,  HND_RQ_KND_CD)
                      )
                  WHERE ENF_DT_YR IS NOT NULL
                  ORDER BY ENF_DT_YR DESC
                          ,CASE WHEN ENF_DT_YR IS NULL     THEN 1
                                WHEN HND_RQ_KND_CD IS NULL THEN 2
                                WHEN HND_RQ_KND_CD = '001' THEN 3
                                WHEN HND_RQ_KND_CD = '002' THEN 4
                                WHEN HND_RQ_KND_CD = '013' THEN 5
                                WHEN HND_RQ_KND_CD = '003' THEN 6
                                WHEN HND_RQ_KND_CD = '004' THEN 7
                            END
        ]]>
    </select>
    
    <select id="selectComboList" parameterType="paramMap" resultType="egovMap">
        <![CDATA[
        /* kr.go.bai.eip.aep.arp.dao.FAACAV017QMapper.selectAffComboList */
            SELECT STTC_TYP_SEQ AS CD,
                   STTC_YR || '년 ' || STTC_STR_MON || '월' || DECODE(STTC_END_MON, '01', '', ' ~ ' || STTC_END_MON || '월') AS CD_NM
              FROM TWFAACAV200M 
             WHERE STTC_TYP_CD = '10'
               AND STTC_CLSF_CD = '017'
        ]]>
        <if test='mngDptYn != "Y"'>
               AND STTC_DTM_DY IS NOT NULL
        </if>
        <![CDATA[
        	ORDER BY STTC_TYP_SEQ DESC
        ]]>
    </select>
    
    <select id="selectSttcList" parameterType="paramMap" resultType="egovMap">
        <![CDATA[
        /* kr.go.bai.eip.aep.arp.dao.FAACAV017QMapper.selectSttcList */
            SELECT T1.RMK
                  ,T1.ADM_OPIN
                  ,TO_CHAR(T1.STTC_PROD_STAD_DY,'YYYY-MM-DD') AS STTC_PROD_STAD_DY
                  ,CASE WHEN T1.STTC_DTM_DY IS NULL THEN 'N'
                        ELSE 'Y'
                   END AS STTC_DTM_YN
                  ,T2.STTC_TYP_CD
                  ,T2.STTC_CLSF_CD
                  ,T2.STTC_TYP_SEQ
                  ,T2.STTC_DATA_SNO
                  ,T2.STTC_TIT1
                  ,T2.STTC_COL1
                  ,T2.STTC_COL2
                  ,T2.STTC_COL3
                  ,T2.STTC_COL4
                  ,T2.STTC_COL5
                  ,T2.STTC_COL6
                  ,T2.STTC_COL7
                  ,T2.STTC_COL8
                  ,T2.STTC_COL9
                  ,T2.STTC_COL10
                  ,T2.STTC_COL11
                  ,CASE WHEN T2.AUD_YR = 'TOT' THEN 'Y'
                        WHEN T2.AUD_YR = 'SUM' THEN 'Y'
                        ELSE
                            CASE WHEN T1.STTC_YR - 1 > T2.AUD_YR THEN 'N'
                                 ELSE 'Y'
                            END                         
                   END VIEW_YN
                  ,T2.AUD_YR
                  ,T2.ROW_KND_CD
                  ,NVL(TO_CHAR(T1.STTC_DTM_DY,'YYYY"-"MM"-"DD'),'미확정') AS STTC_DTM_DY
              FROM TWFAACAV200M T1
             INNER JOIN TWFAACAV200D T2 ON (
                        T1.STTC_TYP_CD = T2.STTC_TYP_CD
                    AND T1.STTC_CLSF_CD = T2.STTC_CLSF_CD
                    AND T1.STTC_TYP_SEQ = T2.STTC_TYP_SEQ )
             WHERE T1.STTC_CLSF_CD = '017'
               AND T1.STTC_TYP_SEQ = #{sttcTypSeq}
             ORDER BY STTC_DATA_SNO
        ]]>
    </select>
    
    <insert id="insertMaster">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV017QMapper.insertMaster */
        <![CDATA[
            INSERT INTO TWFAACAV200M (
                 STTC_TYP_CD
                ,STTC_CLSF_CD
                ,STTC_TYP_SEQ
                ,STTC_YR
                ,STTC_STR_MON
                ,STTC_END_MON
                ,STTC_PROD_STAD_DY
                ,STTC_DTM_DY
                ,RMK
                ,ADM_OPIN
                ,FRT_USR_ID
                ,FNL_USR_ID
                ,FNL_DEAL_DPT_CD
                ,FNL_MNU_ID
                ,FRT_REGI_DH
                ,FNL_MDF_DH )
            VALUES (
                 '10'
                ,'017'
                ,( SELECT NVL(MAX(STTC_TYP_SEQ), 0) + 1
                     FROM TWFAACAV200M
                    WHERE STTC_TYP_CD = '10'
                      AND STTC_CLSF_CD = '017' )
                ,SUBSTR(ADD_MONTHS(#{proStadDt}, -1), 0, 4)
                ,'01'
                ,TO_CHAR(TO_DATE(ADD_MONTHS(#{proStadDt}, -1)), 'MM')
                ,#{proStadDt}
                ,''
                ,#{rmk}
                ,#{admOpin}
                ,#{usrId}
                ,#{usrId}
                ,#{dptCd}
                ,#{mnuId}
                ,SYSDATE
                ,SYSDATE )
        ]]>
    </insert>
    
    <insert id="insertDetail">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV017QMapper.insertDetail */
        <![CDATA[
            INSERT INTO TWFAACAV200D (
                 STTC_TYP_CD
                ,STTC_CLSF_CD
                ,STTC_TYP_SEQ
                ,STTC_DATA_SNO
                ,STTC_TIT1
                ,STTC_COL1
                ,STTC_COL2
                ,STTC_COL3
                ,STTC_COL4
                ,STTC_COL5
                ,STTC_COL6
                ,STTC_COL7
                ,STTC_COL8
                ,STTC_COL9
                ,STTC_COL10
                ,STTC_COL11
                ,AUD_YR
                ,ROW_KND_CD
                ,FRT_USR_ID
                ,FNL_USR_ID
                ,FNL_DEAL_DPT_CD
                ,FNL_MNU_ID
                ,FRT_REGI_DH
                ,FNL_MDF_DH )
            VALUES (
                 '10'
                ,'017'
                ,( SELECT NVL(MAX(STTC_TYP_SEQ), 0)
                     FROM TWFAACAV200M
                    WHERE STTC_TYP_CD = '10'
                      AND STTC_CLSF_CD = '017' )
                ,( SELECT NVL(MAX(STTC_DATA_SNO), 0) + 1
                     FROM TWFAACAV200D
                    WHERE STTC_TYP_CD = '10'
                      AND STTC_CLSF_CD = '017' 
                      AND STTC_TYP_SEQ = ( SELECT NVL(MAX(STTC_TYP_SEQ), 0)
                                             FROM TWFAACAV200M
                                            WHERE STTC_TYP_CD = '10'
                                              AND STTC_CLSF_CD = '017' ))
                ,#{sttcTit1}
                ,#{sttcCol1}
                ,#{sttcCol2}
                ,#{sttcCol3}
                ,#{sttcCol4}
                ,#{sttcCol5}
                ,#{sttcCol6}
                ,#{sttcCol7}
                ,#{sttcCol8}
                ,#{sttcCol9}
                ,#{sttcCol10}
                ,#{sttcCol11}
                ,#{audYr}
                ,#{rowKndCd}
                ,#{usrId}
                ,#{usrId}
                ,#{dptCd}
                ,#{mnuId}
                ,SYSDATE
                ,SYSDATE )
        ]]>
    </insert>
    
    <insert id="updateMaster">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV017QMapper.updateMaster */
        <![CDATA[
            UPDATE TWFAACAV200M
               SET RMK = #{rmk}
                  ,ADM_OPIN = #{admOpin}
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
        ]]>
    </insert>
    
    <insert id="updateDetail">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV017QMapper.updateDetail */
        <![CDATA[
            UPDATE TWFAACAV200D
               SET STTC_COL1 = #{sttcCol1}
                  ,STTC_COL2 = #{sttcCol2}
                  ,STTC_COL3 = #{sttcCol3}
                  ,STTC_COL4 = #{sttcCol4}
                  ,STTC_COL5 = #{sttcCol5}
                  ,STTC_COL6 = #{sttcCol6}
                  ,STTC_COL7 = #{sttcCol7}
                  ,STTC_COL8 = #{sttcCol8}
                  ,STTC_COL9 = #{sttcCol9}
                  ,STTC_COL10 = #{sttcCol10}
                  ,STTC_COL11 = #{sttcCol11}
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
               AND STTC_DATA_SNO = #{sttcDataSno}
        ]]>
    </insert>
    
    <insert id="updateMasterDtmDy">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV017QMapper.updateMasterDtmDy */
        <![CDATA[
            UPDATE TWFAACAV200M
               SET STTC_DTM_DY = SYSDATE
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
        ]]>
    </insert>
    
</mapper>