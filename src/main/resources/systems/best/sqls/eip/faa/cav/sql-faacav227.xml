<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper">
    
    <select id="selectLoadSttcList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper.selectLoadSttcList */
        <![CDATA[
				SELECT  CASE WHEN SUBSTR(ADD_MONTHS(#{proStadDt}, -1),6,2) = '12' THEN TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1),0,4)) 
							  ELSE TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1),0,4)-1) 
						END AS AUD_YR
						,'0' AS ROW_KND_CD
						,'Y' AS VIEW_YN 
						,'Y' AS CHART_VIEW_YN
						,CASE WHEN SUBSTR(ADD_MONTHS(#{proStadDt}, -1),6,2) = '12' THEN TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1),0,4)) 
							  ELSE TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1),0,4)-1) 
						END || '년' AS STTC_TIT1
						,TO_NUMBER('0') AS STTC_COL1
						,'20' AS STTC_TYP_CD
	                  	,'227' AS STTC_CLSF_CD
	                  	,(SELECT MAX(T3.STTC_TYP_SEQ)+1
							FROM TWFAACAV200M T3
							WHERE T3.STTC_CLSF_CD = '227') AS STTC_TYP_SEQ
	                  	,TO_NUMBER('1') AS STTC_DATA_SNO 
					FROM DUAL
			UNION ALL
	            SELECT T2.AUD_YR
	                  ,T2.ROW_KND_CD
	                  ,CASE WHEN T1.STTC_YR > T2.AUD_YR THEN 'N'
	                        ELSE 'Y'
	                 	END VIEW_YN 
	                   ,CASE WHEN T1.STTC_YR - 4 > T2.AUD_YR THEN 'N'
	                        ELSE 'Y'
	                   END CHART_VIEW_YN	                  
	            	  ,T2.STTC_TIT1
	                  ,NVL((SELECT COUNT(AUD_YR) 
	                  		FROM TWFAACAV201D 
	                  			WHERE AUD_YR = T2.AUD_YR
	                  				AND STTC_CLSF_CD = '227' 
	                  			GROUP BY AUD_YR),0) 	AS STTC_COL1
		              ,T2.STTC_TYP_CD
	                  ,T2.STTC_CLSF_CD
                  	  ,(SELECT MAX(T3.STTC_TYP_SEQ)+1
						  FROM TWFAACAV200M T3
						  WHERE T3.STTC_CLSF_CD = '227') AS STTC_TYP_SEQ
	                  ,(T2.STTC_DATA_SNO + 1) AS STTC_DATA_SNO
	              FROM TWFAACAV200M T1
	             INNER JOIN TWFAACAV200D T2 ON (
	                        T1.STTC_TYP_CD = T2.STTC_TYP_CD
	                    AND T1.STTC_CLSF_CD = T2.STTC_CLSF_CD
	                    AND T1.STTC_TYP_SEQ = T2.STTC_TYP_SEQ )
				 WHERE T1.STTC_CLSF_CD = '227'
		               AND T2.STTC_TYP_SEQ = (SELECT MAX(T3.STTC_TYP_SEQ) 
												FROM TWFAACAV200M  T3
												WHERE T3.STTC_CLSF_CD = '227' 
													AND T3.STTC_DTM_DY IS NOT NULL)
	 				   AND T2.AUD_YR NOT IN(SELECT NVL(MIN(T4.AUD_YR) ,0)
													  FROM TWFAACAV200D T4
													 WHERE T4.STTC_CLSF_CD = '227' 
													    AND T4.AUD_YR < T1.STTC_YR - 4
													    AND T4.STTC_TYP_SEQ = (SELECT MAX(T5.STTC_TYP_SEQ) 
																						 FROM TWFAACAV200M T5
																						WHERE T5.STTC_CLSF_CD = '227' 
																						   AND T5.STTC_DTM_DY IS NOT NULL))			               								  														
						ORDER BY AUD_YR DESC, ROW_KND_CD		
									
        ]]>
    </select>
    
    <select id="selectComboList" parameterType="paramMap" resultType="egovMap">
        <![CDATA[
        /* kr.go.bai.eip.aep.arp.dao.FAACAV227QMapper.selectAffComboList */
            SELECT STTC_TYP_SEQ AS CD,
                   STTC_YR || '년 ' || STTC_STR_MON || '월' || DECODE(STTC_END_MON, '01', '', ' ~ ' || STTC_END_MON || '월') AS CD_NM
              FROM TWFAACAV200M 
             WHERE STTC_TYP_CD = '20'
               AND STTC_CLSF_CD = '227'
        ]]>
        <if test='mngDptYn != "Y"'>
               AND STTC_DTM_DY IS NOT NULL
        </if>
        <![CDATA[
        	ORDER BY STTC_TYP_SEQ DESC
        ]]>
    </select>
    
    <select id="selectSttcList" parameterType="paramMap" resultType="egovMap">
        <![CDATA[
        /* kr.go.bai.eip.aep.arp.dao.FAACAV227QMapper.selectSttcList */
            SELECT T1.RMK
                  ,T1.ADM_OPIN
                  ,TO_CHAR(T1.STTC_PROD_STAD_DY,'YYYY-MM-DD') AS STTC_PROD_STAD_DY
                  ,CASE WHEN T1.STTC_DTM_DY IS NULL THEN 'N'
                        ELSE 'Y'
                   END AS STTC_DTM_YN
                  ,T2.STTC_TYP_CD
                  ,T2.STTC_CLSF_CD
                  ,T2.STTC_TYP_SEQ
                  ,T2.STTC_DATA_SNO
                  ,T2.STTC_TIT1
                  ,NVL((SELECT COUNT(AUD_YR) 
                  		FROM TWFAACAV201D 
                  			WHERE AUD_YR = T2.AUD_YR
                  				AND STTC_CLSF_CD = '227' 
                  			GROUP BY AUD_YR),0) 	AS STTC_COL1
                  ,CASE WHEN T2.STTC_DATA_SNO > 2 THEN 'N' 
                          ELSE 'Y' END VIEW_YN
                  ,'Y' AS CHART_VIEW_YN
                  ,T2.AUD_YR
                  ,T2.ROW_KND_CD
                  ,NVL(TO_CHAR(T1.STTC_DTM_DY,'YYYY"-"MM"-"DD'),'미확정') AS STTC_DTM_DY
              FROM TWFAACAV200M T1
             INNER JOIN TWFAACAV200D T2 ON (
                        T1.STTC_TYP_CD = T2.STTC_TYP_CD
                    AND T1.STTC_CLSF_CD = T2.STTC_CLSF_CD
                    AND T1.STTC_TYP_SEQ = T2.STTC_TYP_SEQ )
             WHERE T1.STTC_CLSF_CD = '227'
               AND T1.STTC_TYP_SEQ = #{sttcTypSeq}
             ORDER BY STTC_DATA_SNO
        ]]>
    </select>
    
    <insert id="insertMaster">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper.insertMaster */
        <![CDATA[
            INSERT INTO TWFAACAV200M (
                 STTC_TYP_CD
                ,STTC_CLSF_CD
                ,STTC_TYP_SEQ
                ,STTC_YR
                ,STTC_STR_MON
                ,STTC_END_MON
                ,STTC_PROD_STAD_DY
                ,STTC_DTM_DY
                ,RMK
                ,ADM_OPIN
                ,FRT_USR_ID
                ,FNL_USR_ID
                ,FNL_DEAL_DPT_CD
                ,FNL_MNU_ID
                ,FRT_REGI_DH
                ,FNL_MDF_DH )
            VALUES (
                 '20'
                ,'227'
                ,( SELECT NVL(MAX(STTC_TYP_SEQ), 0) + 1
                     FROM TWFAACAV200M
                    WHERE STTC_TYP_CD = '20'
                      AND STTC_CLSF_CD = '227' )
                 ,SUBSTR(ADD_MONTHS(#{proStadDt}, -12), 0, 4)
                ,'01'
                ,'12'
                ,#{proStadDt}
                ,''
                ,#{rmk}
                ,#{admOpin}
                ,#{usrId}
                ,#{usrId}
                ,#{dptCd}
                ,#{mnuId}
                ,SYSDATE
                ,SYSDATE )
        ]]>
    </insert>
    
    <insert id="insertDetail">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper.insertDetail */
        <![CDATA[
            INSERT INTO TWFAACAV200D (
                 STTC_TYP_CD
                ,STTC_CLSF_CD
                ,STTC_TYP_SEQ
                ,STTC_DATA_SNO
                ,STTC_TIT1
                ,STTC_COL1
                ,AUD_YR
                ,ROW_KND_CD
                ,FRT_USR_ID
                ,FNL_USR_ID
                ,FNL_DEAL_DPT_CD
                ,FNL_MNU_ID
                ,FRT_REGI_DH
                ,FNL_MDF_DH )
            VALUES (
                 '20'
                ,'227'
                ,( SELECT NVL(MAX(STTC_TYP_SEQ), 0)
                     FROM TWFAACAV200M
                    WHERE STTC_TYP_CD = '20'
                      AND STTC_CLSF_CD = '227' )
                ,( SELECT NVL(MAX(STTC_DATA_SNO), 0) + 1
                     FROM TWFAACAV200D
                    WHERE STTC_TYP_CD = '20'
                      AND STTC_CLSF_CD = '227' 
                      AND STTC_TYP_SEQ = ( SELECT NVL(MAX(STTC_TYP_SEQ), 0)
                                             FROM TWFAACAV200M
                                            WHERE STTC_TYP_CD = '20'
                                              AND STTC_CLSF_CD = '227' ))
                ,#{sttcTit1}
                ,#{sttcCol1}
                ,#{audYr}
                ,#{rowKndCd}
                ,#{usrId}
                ,#{usrId}
                ,#{dptCd}
                ,#{mnuId}
                ,SYSDATE
                ,SYSDATE )
        ]]>
    </insert>
    
    <insert id="updateMaster">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper.updateMaster */
        <![CDATA[
            UPDATE TWFAACAV200M
               SET RMK = #{rmk}
                  ,ADM_OPIN = #{admOpin}
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
        ]]>
    </insert>
    
    <insert id="updateDetail">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper.updateDetail */
        <![CDATA[
            UPDATE TWFAACAV200D
               SET STTC_COL1 = #{sttcCol1}
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
               AND STTC_DATA_SNO = #{sttcDataSno}
        ]]>
    </insert>
    
    <insert id="updateMasterDtmDy">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper.updateMasterDtmDy */
        <![CDATA[
            UPDATE TWFAACAV200M
               SET STTC_DTM_DY = SYSDATE
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
        ]]>
    </insert>
    
    <select id="selectRsrcPrjList" parameterType="paramMap" resultType="egovMap">
      	/* kr.go.bai.eip.aep.arp.dao.FAACAV227QMapper.selectRsrcPrjList */
        <![CDATA[
            SELECT STTC_TYP_CD
				  ,STTC_CLSF_CD
				  ,STTC_TYP_SEQ
				  ,STTC_DATA_SNO
				  ,AUD_YR
				  ,ROW_KND_CD
				  ,STTC_COL1
				  ,STTC_COL2 
				FROM TWFAACAV201D
				WHERE STTC_TYP_CD = #{sttcTypCd}
				  AND STTC_CLSF_CD = #{sttcClsfCd}
			      AND AUD_YR = #{audYr}                                                                                                       
				ORDER BY STTC_TYP_SEQ, TO_NUMBER(ROW_KND_CD)
        ]]>
    </select>
    
    <insert id="insertRsrcPrjList">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper.insertRsrcPrjList */
        <![CDATA[
            INSERT INTO TWFAACAV201D (
			     STTC_TYP_CD
			    ,STTC_CLSF_CD
			    ,STTC_TYP_SEQ
			    ,STTC_DATA_SNO
			    ,STTC_COL1
			    ,STTC_COL2
			    ,AUD_YR
			    ,ROW_KND_CD
			    ,FRT_USR_ID
			    ,FNL_USR_ID
			    ,FNL_DEAL_DPT_CD
			    ,FNL_MNU_ID
			    ,FRT_REGI_DH
			    ,FNL_MDF_DH)
			VALUES (
			     '20' 
			    ,'227' 
			    ,#{sttcTypSeq}
			    ,#{sttcDataSno}
			    ,#{sttcCol1}
			    ,''
			    ,#{audYr} 
			    ,( SELECT NVL(MAX(TO_NUMBER(ROW_KND_CD)), 0) + 1
			         FROM TWFAACAV201D
			        WHERE STTC_TYP_CD = '20'
			          AND STTC_CLSF_CD = '227' 
			          AND STTC_TYP_SEQ = #{sttcTypSeq}
					  AND STTC_DATA_SNO = #{sttcDataSno}
					  AND AUD_YR = #{audYr}) 
			    ,#{usrId}
                ,#{usrId}
			    ,#{dptCd}
			    ,#{mnuId}
			    ,SYSDATE
			    ,SYSDATE)
        ]]>
    </insert>    
    
    <delete id="deleteRsrcPrjList">
    /* kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper.deleteRsrcPrjList */
    <![CDATA[
			DELETE TWFAACAV201D
				WHERE STTC_TYP_CD = '20'
				  AND STTC_CLSF_CD = '227'
			      AND STTC_TYP_SEQ = #{sttcTypSeq}
			      AND STTC_DATA_SNO = #{sttcDataSno}
			      AND AUD_YR = #{audYr}
			      AND ROW_KND_CD = #{rowKndCd}
    ]]>
    </delete>    
    
    <insert id="updateRsrcPrjList">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV227QMapper.updateRsrcPrjList */
        <![CDATA[
            UPDATE TWFAACAV201D
			   SET STTC_COL1 = #{sttcCol1}
			   	  ,STTC_COL2 = ''
			      ,FNL_USR_ID = #{usrId}
			      ,FNL_DEAL_DPT_CD = #{dptCd}
			      ,FNL_MDF_DH = SYSDATE
			 	WHERE STTC_TYP_CD = '20'
				  AND STTC_CLSF_CD = '227'
			      AND STTC_TYP_SEQ = #{sttcTypSeq}
			      AND STTC_DATA_SNO = #{sttcDataSno}
			      AND AUD_YR = #{audYr}
			      AND ROW_KND_CD = #{rowKndCd}
        ]]>
    </insert>      
</mapper>