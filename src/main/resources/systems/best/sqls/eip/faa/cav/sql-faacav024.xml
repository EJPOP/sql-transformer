<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.faa.cav.dao.FAACAV024QMapper">
    
    <select id="selectLoadSttcList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV024QMapper.selectLoadSttcList */
        <![CDATA[
			WITH DATA AS (
				SELECT T1.CVPT_KND_CD ,
				               T1.CVPT_HNDL_STA_CD ,
				               T2.CVPT_HNDL_DVSN_CD
				          FROM TBDCPDCP101M T1 ,
				               (SELECT T2.*
				                  FROM TBDCPDCP205L T2
				                 WHERE (T2.REQ_DVSN_CD,
				                               T2.ACP_YR,
				                               T2.CVPT_ACP_NO ,
				                               T2.SRNO ) IN (SELECT S1.REQ_DVSN_CD,
				                               S1.ACP_YR,
				                               S1.CVPT_ACP_NO ,
				                               MIN(S1.SRNO)
				                          FROM TBDCPDCP205L S1
				                         GROUP BY S1.REQ_DVSN_CD,
				                               S1.ACP_YR,
				                               S1.CVPT_ACP_NO ) )T2
				         WHERE T1.REQ_DVSN_CD = T2.REQ_DVSN_CD(+)
				           AND T1.ACP_YR = T2.ACP_YR(+)
				           AND T1.CVPT_ACP_NO = T2.CVPT_ACP_NO(+)
				           AND T1.CVPT_HNDL_STA_CD <> '1'
				           AND TO_CHAR(T1.ACP_DH, 'YYYYMMDD') BETWEEN TO_CHAR(ADD_MONTHS(#{proStadDt}, -1), 'YYYY')||'0101' AND TO_CHAR(LAST_DAY(ADD_MONTHS(#{proStadDt}, -1)), 'YYYYMMDD') )
				           
				SELECT AUD_YR ,
				       TO_CHAR(ROW_KND_CD) AS ROW_KND_CD ,
				       STTC_TIT1 ,
				       NVL(TO_NUMBER(STTC_COL1),0) AS STTC_COL1 ,
				       NVL(TO_NUMBER(STTC_COL2),0) AS STTC_COL2 ,
				       NVL(TO_NUMBER(STTC_COL3),0) AS STTC_COL3 ,
				       NVL(TO_NUMBER(STTC_COL4),0) AS STTC_COL4 ,
				       NVL(TO_NUMBER(STTC_COL5),0) AS STTC_COL5 ,
				       NVL(TO_NUMBER(STTC_COL6),0) AS STTC_COL6 ,
				       NVL(TO_NUMBER(STTC_COL7),0) AS STTC_COL7 ,
				       NVL(TO_NUMBER(STTC_COL8),0) AS STTC_COL8 ,
				       NVL(TO_NUMBER(STTC_COL9),0) AS STTC_COL9
				  FROM (SELECT TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1), 0, 4)) AS AUD_YR ,
				               0 AS ROW_KND_CD ,
				               TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1), 0, 4)) || '년 합계' AS STTC_TIT1 ,
				               COUNT(*) AS STTC_COL1 ,
				               COUNT(1) AS STTC_COL2 ,
				               0 AS STTC_COL3 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_HNDL_STA_CD ='60' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL4 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD IN ('20',
				                               '30') THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL5 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD ='50' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL6 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD ='10' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL7 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD ='40' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL8 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_HNDL_STA_CD <> '10' AND CVPT_HNDL_STA_CD < '60' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL9
				          FROM DATA
				         
				         UNION ALL
				SELECT TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1), 0, 4)) AS AUD_YR ,
				               1 AS ROW_KND_CD ,
				               '제3자신고' AS STTC_TIT1 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '1' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL1 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '1' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL2 ,
				               0 AS STTC_COL3 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '1'
				                   AND CVPT_HNDL_STA_CD ='60' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL4 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '1'
				                   AND CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD IN ('20',
				                               '30') THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL5 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '1'
				                   AND CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD ='50' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL6 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '1'
				                   AND CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD ='10' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL7 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '1'
				                   AND CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD ='40' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL8 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '1' AND CVPT_HNDL_STA_CD <> '10' AND CVPT_HNDL_STA_CD < '60' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL9
				          FROM DATA				         
				         UNION ALL
				SELECT TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1), 0, 4)) AS AUD_YR ,
				               2 AS ROW_KND_CD ,
				               '자진신고' AS STTC_TIT1 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '2' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL1 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '2' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL2 ,
				               0 AS STTC_COL3 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '2'
				                   AND CVPT_HNDL_STA_CD ='60' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL4 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '2'
				                   AND CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD IN ('20',
				                               '30') THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL5 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '2'
				                   AND CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD ='50' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL6 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '2'
				                   AND CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD ='10' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL7 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '2'
				                   AND CVPT_HNDL_STA_CD ='60'
				                   AND CVPT_HNDL_DVSN_CD ='40' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL8 ,
				               SUM(
				                                       CASE
				                                         WHEN CVPT_KND_CD = '2' AND CVPT_HNDL_STA_CD <> '10' AND CVPT_HNDL_STA_CD < '60' THEN 1
				                                         ELSE 0
				                                       END) AS STTC_COL9
				          FROM DATA				         
				         UNION ALL
				SELECT TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1), 0, 4)) AS AUD_YR ,
				               3 AS ROW_KND_CD ,
				               '이의신청' AS STTC_TIT1 ,
				               0 AS STTC_COL1 ,
				               0 AS STTC_COL2 ,
				               0 AS STTC_COL3 ,
				               0 AS STTC_COL4 ,
				               0 AS STTC_COL5 ,
				               0 AS STTC_COL6 ,
				               0 AS STTC_COL7 ,
				               0 AS STTC_COL8 ,
				               0 AS STTC_COL9
				          FROM DUAL )
				 UNION ALL
				SELECT T2.AUD_YR ,
				       ROW_KND_CD ,
				       STTC_TIT1 ,
				       STTC_COL1 ,
				       STTC_COL2 ,
				       STTC_COL3 ,
				       STTC_COL4 ,
				       STTC_COL5 ,
				       STTC_COL6 ,
				       STTC_COL7 ,
				       STTC_COL8 ,
				       STTC_COL9
				  FROM TWFAACAV200M T1 INNER JOIN TWFAACAV200D T2 ON ( T1.STTC_TYP_CD = T2.STTC_TYP_CD
				           AND T1.STTC_CLSF_CD = T2.STTC_CLSF_CD
				           AND T1.STTC_TYP_SEQ = T2.STTC_TYP_SEQ )
				 WHERE T1.STTC_CLSF_CD = '024'
				   AND T2.STTC_TYP_SEQ = (SELECT MAX(T3.STTC_TYP_SEQ)
				          FROM TWFAACAV200M T3
				         WHERE T3.STTC_CLSF_CD = '024'
				           AND T3.STTC_DTM_DY IS NOT NULL)
				   AND T2.AUD_YR BETWEEN SUBSTR(ADD_MONTHS(#{proStadDt}, -13), 0, 4) AND SUBSTR(ADD_MONTHS(#{proStadDt}, -13), 0, 4)                   														
        ]]>
    </select>
    
    <select id="selectComboList" parameterType="paramMap" resultType="egovMap">
        <![CDATA[
        /* kr.go.bai.eip.aep.arp.dao.FAACAV024QMapper.selectAffComboList */
            SELECT STTC_TYP_SEQ AS CD,
                   STTC_YR || '년 ' || STTC_STR_MON || '월' || DECODE(STTC_END_MON, '01', '', ' ~ ' || STTC_END_MON || '월') AS CD_NM
              FROM TWFAACAV200M 
             WHERE STTC_TYP_CD = '10'
               AND STTC_CLSF_CD = '024'
        ]]>
        <if test='mngDptYn != "Y"'>
               AND STTC_DTM_DY IS NOT NULL
        </if>
        <![CDATA[
        	ORDER BY STTC_TYP_SEQ DESC
        ]]>
    </select>
    
    <select id="selectSttcList" parameterType="paramMap" resultType="egovMap">
        <![CDATA[
        /* kr.go.bai.eip.aep.arp.dao.FAACAV024QMapper.selectSttcList */
            SELECT T1.RMK
                  ,T1.ADM_OPIN
                  ,TO_CHAR(T1.STTC_PROD_STAD_DY,'YYYY-MM-DD') AS STTC_PROD_STAD_DY
                  ,CASE WHEN T1.STTC_DTM_DY IS NULL THEN 'N'
                        ELSE 'Y'
                   END AS STTC_DTM_YN
                  ,T2.STTC_TYP_CD
                  ,T2.STTC_CLSF_CD
                  ,T2.STTC_TYP_SEQ
                  ,T2.STTC_DATA_SNO
                  ,T2.STTC_TIT1
                  ,T2.STTC_COL1
                  ,T2.STTC_COL2
                  ,T2.STTC_COL3
                  ,T2.STTC_COL4
                  ,T2.STTC_COL5
                  ,T2.STTC_COL6
                  ,T2.STTC_COL7
                  ,T2.STTC_COL8
                  ,T2.STTC_COL9
                  ,CASE WHEN T1.STTC_YR - 1 > T2.AUD_YR THEN 'N'
                        ELSE 'Y'
                   END VIEW_YN
                  ,T2.AUD_YR
                  ,T2.ROW_KND_CD
                  ,NVL(TO_CHAR(T1.STTC_DTM_DY,'YYYY"-"MM"-"DD'),'미확정') AS STTC_DTM_DY
              FROM TWFAACAV200M T1
             INNER JOIN TWFAACAV200D T2 ON (
                        T1.STTC_TYP_CD = T2.STTC_TYP_CD
                    AND T1.STTC_CLSF_CD = T2.STTC_CLSF_CD
                    AND T1.STTC_TYP_SEQ = T2.STTC_TYP_SEQ )
             WHERE T1.STTC_CLSF_CD = '024'
               AND T1.STTC_TYP_SEQ = #{sttcTypSeq}
             ORDER BY STTC_DATA_SNO
        ]]>
    </select>
    
    <insert id="insertMaster">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV024QMapper.insertMaster */
        <![CDATA[
            INSERT INTO TWFAACAV200M (
                 STTC_TYP_CD
                ,STTC_CLSF_CD
                ,STTC_TYP_SEQ
                ,STTC_YR
                ,STTC_STR_MON
                ,STTC_END_MON
                ,STTC_PROD_STAD_DY
                ,STTC_DTM_DY
                ,RMK
                ,ADM_OPIN
                ,FRT_USR_ID
                ,FNL_USR_ID
                ,FNL_DEAL_DPT_CD
                ,FNL_MNU_ID
                ,FRT_REGI_DH
                ,FNL_MDF_DH )
            VALUES (
                 '10'
                ,'024'
                ,( SELECT NVL(MAX(STTC_TYP_SEQ), 0) + 1
                     FROM TWFAACAV200M
                    WHERE STTC_TYP_CD = '10'
                      AND STTC_CLSF_CD = '024' )
                ,SUBSTR(ADD_MONTHS(#{proStadDt}, -1), 0, 4)
                ,'01'
                ,TO_CHAR(TO_DATE(ADD_MONTHS(#{proStadDt}, -1)), 'MM')
                ,#{proStadDt}
                ,''
                ,#{rmk}
                ,#{admOpin}
                ,#{usrId}
                ,#{usrId}
                ,#{dptCd}
                ,#{mnuId}
                ,SYSDATE
                ,SYSDATE )
        ]]>
    </insert>
    
    <insert id="insertDetail">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV024QMapper.insertDetail */
        <![CDATA[
            INSERT INTO TWFAACAV200D (
                 STTC_TYP_CD
                ,STTC_CLSF_CD
                ,STTC_TYP_SEQ
                ,STTC_DATA_SNO
                ,STTC_TIT1
                ,STTC_COL1
                ,STTC_COL2
                ,STTC_COL3
                ,STTC_COL4
                ,STTC_COL5
                ,STTC_COL6
                ,STTC_COL7
               	,STTC_COL8
                ,STTC_COL9
                ,AUD_YR
                ,ROW_KND_CD
                ,FRT_USR_ID
                ,FNL_USR_ID
                ,FNL_DEAL_DPT_CD
                ,FNL_MNU_ID
                ,FRT_REGI_DH
                ,FNL_MDF_DH )
            VALUES (
                 '10'
                ,'024'
                ,( SELECT NVL(MAX(STTC_TYP_SEQ), 0)
                     FROM TWFAACAV200M
                    WHERE STTC_TYP_CD = '10'
                      AND STTC_CLSF_CD = '024' )
                ,( SELECT NVL(MAX(STTC_DATA_SNO), 0) + 1
                     FROM TWFAACAV200D
                    WHERE STTC_TYP_CD = '10'
                      AND STTC_CLSF_CD = '024' 
                      AND STTC_TYP_SEQ = ( SELECT NVL(MAX(STTC_TYP_SEQ), 0)
                                             FROM TWFAACAV200M
                                            WHERE STTC_TYP_CD = '10'
                                              AND STTC_CLSF_CD = '024' ))
                ,#{sttcTit1}
                ,#{sttcCol1}
                ,#{sttcCol2}
                ,#{sttcCol3}
                ,#{sttcCol4}
                ,#{sttcCol5}
                ,#{sttcCol6}
                ,#{sttcCol7}
                ,#{sttcCol8}
                ,#{sttcCol9}
                ,#{audYr}
                ,#{rowKndCd}
                ,#{usrId}
                ,#{usrId}
                ,#{dptCd}
                ,#{mnuId}
                ,SYSDATE
                ,SYSDATE )
        ]]>
    </insert>
    
    <insert id="updateMaster">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV024QMapper.updateMaster */
        <![CDATA[
            UPDATE TWFAACAV200M
               SET RMK = #{rmk}
                  ,ADM_OPIN = #{admOpin}
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
        ]]>
    </insert>
    
    <insert id="updateDetail">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV024QMapper.updateDetail */
        <![CDATA[
            UPDATE TWFAACAV200D
               SET STTC_COL1 = #{sttcCol1}
                  ,STTC_COL2 = #{sttcCol2}
                  ,STTC_COL3 = #{sttcCol3}
                  ,STTC_COL4 = #{sttcCol4}
                  ,STTC_COL5 = #{sttcCol5}
                  ,STTC_COL6 = #{sttcCol6}
                  ,STTC_COL7 = #{sttcCol7}
                  ,STTC_COL8 = #{sttcCol8}
                  ,STTC_COL9 = #{sttcCol9}                
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
               AND STTC_DATA_SNO = #{sttcDataSno}
        ]]>
    </insert>
    
    <insert id="updateMasterDtmDy">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV024QMapper.updateMasterDtmDy */
        <![CDATA[
            UPDATE TWFAACAV200M
               SET STTC_DTM_DY = SYSDATE
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
        ]]>
    </insert>
    
</mapper>