<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.bai.eip.faa.cav.dao.FAACAV229QMapper">
    
    <select id="selectLoadSttcList" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV229QMapper.selectLoadSttcList */
        <![CDATA[
        SELECT AUD_YR 
             ,ROW_KND_CD
             ,CHART_VIEW_YN
             ,STTC_TIT1
             ,STTC_COL1
			 ,STTC_COL2
			 ,STTC_COL3
		   	 ,STTC_COL4
			 ,STTC_COL5
			 ,STTC_COL6
			 ,STTC_COL7
        FROM (  
		   SELECT TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1),0,4)) AS AUD_YR
					  , '0' AS ROW_KND_CD
					  , 'Y' AS VIEW_YN 
					  ,	'Y' AS CHART_VIEW_YN
					  , SUBSTR(TO_CHAR(ADD_MONTHS(#{proStadDt}, -1)),6,2) || '월' AS STTC_TIT1
					  ,'0' AS STTC_COL1
					  ,'0' AS STTC_COL2
					  ,'0' AS STTC_COL3
					  ,'0' AS STTC_COL4
					  ,'0' AS STTC_COL5
					  ,'0' AS STTC_COL6
					  ,'0' AS STTC_COL7
					FROM DUAL

	)
          UNION ALL
          	SELECT T2.AUD_YR
		             ,ROW_KND_CD
                     ,CASE WHEN SUBSTR(ADD_MONTHS(#{proStadDt}, -1),6,2) = '01' AND T2.AUD_YR = (SELECT TO_CHAR(MAX(T2.AUD_YR)-1) 
              																		FROM TWFAACAV200D T2
																				   WHERE T2.STTC_CLSF_CD = '229' 
																					 AND T2.STTC_TYP_SEQ = (SELECT MAX(T3.STTC_TYP_SEQ) 
																												FROM TWFAACAV200M T3
																												WHERE T3.STTC_CLSF_CD = '229' )) THEN 'N' 
	                  		WHEN TO_CHAR(SUBSTR(ADD_MONTHS(#{proStadDt}, -1),0,4)) - 4 > T2.AUD_YR THEN 'N'
	                        ELSE 'Y'
	                   END CHART_VIEW_YN  
		             ,STTC_TIT1
		             ,TO_CHAR(STTC_COL1)
					 ,TO_CHAR(STTC_COL2)
					 ,TO_CHAR(STTC_COL3)
				   	 ,TO_CHAR(STTC_COL4)
					 ,TO_CHAR(STTC_COL5)    
					 ,TO_CHAR(STTC_COL6)    
					 ,TO_CHAR(STTC_COL7)    
              FROM TWFAACAV200M T1
             INNER JOIN TWFAACAV200D T2 ON (
                        T1.STTC_TYP_CD = T2.STTC_TYP_CD
                    AND T1.STTC_CLSF_CD = T2.STTC_CLSF_CD
                    AND T1.STTC_TYP_SEQ = T2.STTC_TYP_SEQ )
			 WHERE T1.STTC_CLSF_CD = '229'
				               AND T2.STTC_TYP_SEQ = (SELECT MAX(T3.STTC_TYP_SEQ) 
											FROM TWFAACAV200M  T3
											WHERE T3.STTC_CLSF_CD = '229' 
												AND T3.STTC_DTM_DY IS NOT NULL)
 		    AND T2.AUD_YR NOT IN(SELECT CASE WHEN SUBSTR(ADD_MONTHS(#{proStadDt}, -1),0,4) = (SELECT MAX(T4.AUD_YR) 
																											FROM TWFAACAV200D T4
																											WHERE T4.STTC_CLSF_CD = '229' 
																											 AND T4.STTC_TYP_SEQ = (SELECT MAX(T5.STTC_TYP_SEQ) 
																																		FROM TWFAACAV200M T5
																																		WHERE T5.STTC_CLSF_CD = '229' 
																																			AND T5.STTC_DTM_DY IS NOT NULL))
	   													THEN (SELECT MAX(T4.AUD_YR) 
																FROM TWFAACAV200D T4
																WHERE T4.STTC_CLSF_CD = '229' 
																 AND T4.STTC_TYP_SEQ = (SELECT MAX(T5.STTC_TYP_SEQ) 
																							FROM TWFAACAV200M T5
																							WHERE T5.STTC_CLSF_CD = '229' 
																								AND T5.STTC_DTM_DY IS NOT NULL))
		               								  	ELSE (SELECT MIN(T4.AUD_YR) 
			               								  		FROM TWFAACAV200D T4
																WHERE T4.STTC_CLSF_CD = '229' 
																 AND T4.STTC_TYP_SEQ = (SELECT MAX(T5.STTC_TYP_SEQ) 
																							FROM TWFAACAV200M T5
																							WHERE T5.STTC_CLSF_CD = '229' 
																								AND T5.STTC_DTM_DY IS NOT NULL))
												END FROM DUAL) 
        ]]>
    </select>
    
    <select id="selectComboList" parameterType="paramMap" resultType="egovMap">
        <![CDATA[
        /* kr.go.bai.eip.aep.arp.dao.FAACAV229QMapper.selectAffComboList */
            SELECT MAX(A.STTC_TYP_SEQ) AS CD,
           		  A.AUD_YR || '년 ' || MIN(A.STTC_TIT1) || ' ~ ' || MAX(A.STTC_TIT1) AS CD_NM
              FROM TWFAACAV200D A , TWFAACAV200M B
             WHERE A.STTC_TYP_CD = '20'
               AND A.STTC_CLSF_CD = '229'
               AND A.STTC_TYP_CD = B.STTC_TYP_CD
               AND A.STTC_CLSF_CD = B.STTC_CLSF_CD
               AND A.STTC_TYP_SEQ = B.STTC_TYP_SEQ
        ]]>    
        <if test='mngDptYn != "Y"'>
               AND B.STTC_DTM_DY IS NOT NULL
        </if>    
        <![CDATA[
        	GROUP BY AUD_YR 
            ORDER BY MAX(A.STTC_TYP_SEQ) DESC
        ]]>
    </select>
    
    <select id="selectSttcList" parameterType="paramMap" resultType="egovMap">
        <![CDATA[
        /* kr.go.bai.eip.aep.arp.dao.FAACAV229QMapper.selectSttcList */
            SELECT * FROM 
				(SELECT 
						     '' AS RMK
						     ,'' AS ADM_OPIN 
						     ,'' AS STTC_PROD_STAD_DY
                             ,min(CASE WHEN STTC_DTM_DY IS NULL THEN 'N'
                                    ELSE 'Y'
                               END) AS STTC_DTM_YN
						     ,max(NVL(TO_CHAR(STTC_DTM_DY,'YYYY"-"MM"-"DD'),'미확정')) AS STTC_DTM_DY
						     ,'1' AS STTC_TYP_CD
						     ,'229' AS STTC_CLSF_CD
						     ,0 AS STTC_TYP_SEQ
						     ,1 AS STTC_DATA_SNO
                             , '합계' STTC_TIT1
                             , SUM(STTC_COL1) AS STTC_COL1
                             , SUM(STTC_COL2) AS STTC_COL2
                             , SUM(STTC_COL3) AS STTC_COL3
                             , SUM(STTC_COL4) AS STTC_COL4
                             , SUM(STTC_COL5) AS STTC_COL5
                             , SUM(STTC_COL6) AS STTC_COL6
                             , SUM(STTC_COL7) AS STTC_COL7
                             , 'Y' AS VIEW_YN
                             , 'Y' AS CHART_VIEW_YN
                             , AUD_YR
                             , '0' AS ROW_KND_CD
                        FROM TWFAACAV200M T1
             INNER JOIN TWFAACAV200D T2 ON (
                        T1.STTC_TYP_CD = T2.STTC_TYP_CD
                    AND T1.STTC_CLSF_CD = T2.STTC_CLSF_CD
                    AND T1.STTC_TYP_SEQ = T2.STTC_TYP_SEQ )
                    
                    WHERE AUD_YR=(SELECT AUD_YR FROM TWFAACAV200D WHERE STTC_CLSF_CD = '229' AND STTC_TYP_SEQ = #{sttcTypSeq})
                        AND T1.STTC_TYP_CD='20' AND T1.STTC_CLSF_CD='229'  
            ]]>            
                    <if test='mngDptYn != "Y"'>
               		AND T1.STTC_DTM_DY IS NOT NULL
        			</if>  
        	<![CDATA[ 
        			GROUP BY AUD_YR
        			
                    UNION ALL
            
            
            SELECT T1.RMK
                  ,T1.ADM_OPIN
                  ,TO_CHAR(T1.STTC_PROD_STAD_DY,'YYYY-MM-DD') AS STTC_PROD_STAD_DY
                  ,CASE WHEN T1.STTC_DTM_DY IS NULL THEN 'N'
                        ELSE 'Y'
                   END AS STTC_DTM_YN
                  ,NVL(TO_CHAR(T1.STTC_DTM_DY,'YYYY"-"MM"-"DD'),'미확정') AS STTC_DTM_DY
                  ,T2.STTC_TYP_CD
                  ,T2.STTC_CLSF_CD
                  ,T2.STTC_TYP_SEQ
                  ,T2.STTC_DATA_SNO
                  ,T2.STTC_TIT1
                  ,T2.STTC_COL1
                  ,T2.STTC_COL2
                  ,T2.STTC_COL3
                  ,T2.STTC_COL4
                  ,T2.STTC_COL5
                  ,T2.STTC_COL6
                  ,T2.STTC_COL7
                  ,CASE WHEN T1.STTC_YR - 5 > T2.AUD_YR THEN 'N'
                        ELSE 'Y'
                   END VIEW_YN
                   ,CASE WHEN T1.STTC_YR - 4 > T2.AUD_YR THEN 'N'
                        ELSE 'Y'
                   END CHART_VIEW_YN
                  ,T2.AUD_YR
                  ,T2.ROW_KND_CD
              FROM TWFAACAV200M T1
             INNER JOIN TWFAACAV200D T2 ON (
                        T1.STTC_TYP_CD = T2.STTC_TYP_CD
                    AND T1.STTC_CLSF_CD = T2.STTC_CLSF_CD
                    AND T1.STTC_TYP_SEQ = T2.STTC_TYP_SEQ )
             WHERE T1.STTC_CLSF_CD = '229'
               AND T1.STTC_YR =  (SELECT AUD_YR FROM TWFAACAV200D WHERE STTC_CLSF_CD = '229' AND STTC_TYP_SEQ = #{sttcTypSeq})
           ]]>
            <if test='mngDptYn != "Y"'>
               AND T1.STTC_DTM_DY IS NOT NULL
        </if> 
        <![CDATA[ 
		) ORDER BY STTC_TYP_SEQ 
         ]]>
    </select>
    
    <insert id="insertMaster">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV229QMapper.insertMaster */
        <![CDATA[
            INSERT INTO TWFAACAV200M (
                 STTC_TYP_CD
                ,STTC_CLSF_CD
                ,STTC_TYP_SEQ
                ,STTC_YR
                ,STTC_STR_MON
                ,STTC_PROD_STAD_DY
                ,STTC_DTM_DY
                ,RMK
                ,ADM_OPIN
                ,FRT_USR_ID
                ,FNL_USR_ID
                ,FNL_DEAL_DPT_CD
                ,FNL_MNU_ID
                ,FRT_REGI_DH
                ,FNL_MDF_DH )
            VALUES (
                 '20'
                ,'229'
                ,( SELECT NVL(MAX(STTC_TYP_SEQ), 0) + 1
                     FROM TWFAACAV200M
                    WHERE STTC_TYP_CD = '20'
                      AND STTC_CLSF_CD = '229' )
                ,SUBSTR(ADD_MONTHS(#{proStadDt}, -1), 0, 4)
                ,TO_CHAR(TO_DATE(ADD_MONTHS(#{proStadDt}, -1)), 'MM')
                ,#{proStadDt}                
                ,''
                ,#{rmk}
                ,#{admOpin}
                ,#{usrId}
                ,#{usrId}
                ,#{dptCd}
                ,#{mnuId}
                ,SYSDATE
                ,SYSDATE )
        ]]>
    </insert>
    
    <insert id="insertDetail">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV229QMapper.insertDetail */
        <![CDATA[
            INSERT INTO TWFAACAV200D (
                 STTC_TYP_CD
                ,STTC_CLSF_CD
                ,STTC_TYP_SEQ
                ,STTC_DATA_SNO
                ,STTC_TIT1
                ,STTC_COL1
                ,STTC_COL2
                ,STTC_COL3
                ,STTC_COL4
                ,STTC_COL5
                ,STTC_COL6
                ,STTC_COL7
                ,AUD_YR
                ,ROW_KND_CD
                ,FRT_USR_ID
                ,FNL_USR_ID
                ,FNL_DEAL_DPT_CD
                ,FNL_MNU_ID
                ,FRT_REGI_DH
                ,FNL_MDF_DH )
            VALUES (
                 '20'
                ,'229'
                ,( SELECT NVL(MAX(STTC_TYP_SEQ), 0)
                     FROM TWFAACAV200M
                    WHERE STTC_TYP_CD = '20'
                      AND STTC_CLSF_CD = '229' )
                ,( SELECT NVL(MAX(STTC_DATA_SNO), 0) + 1
                     FROM TWFAACAV200D
                    WHERE STTC_TYP_CD = '20'
                      AND STTC_CLSF_CD = '229' 
                      AND STTC_TYP_SEQ = ( SELECT NVL(MAX(STTC_TYP_SEQ), 0)
                                             FROM TWFAACAV200M
                                            WHERE STTC_TYP_CD = '20'
                                              AND STTC_CLSF_CD = '229' ))
                ,#{sttcTit1}
                ,#{sttcCol1}
                ,#{sttcCol2}
                ,#{sttcCol3}
                ,#{sttcCol4}
                ,#{sttcCol5}
                ,#{sttcCol6}
                ,NVL(#{sttcCol7},0)
                ,#{audYr}
                ,#{rowKndCd}
                ,#{usrId}
                ,#{usrId}
                ,#{dptCd}
                ,#{mnuId}
                ,SYSDATE
                ,SYSDATE )
        ]]>
    </insert>
    
    <insert id="updateMaster">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV229QMapper.updateMaster */
        <![CDATA[
            UPDATE TWFAACAV200M
               SET RMK = #{rmk}
                  ,ADM_OPIN = #{admOpin}
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
        ]]>
    </insert>
    
    <insert id="updateDetail">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV229QMapper.updateDetail */
        <![CDATA[
            UPDATE TWFAACAV200D
               SET STTC_COL1 = #{sttcCol1}
                  ,STTC_COL2 = #{sttcCol2}
                  ,STTC_COL3 = #{sttcCol3}
                  ,STTC_COL4 = #{sttcCol4}
                  ,STTC_COL5 = #{sttcCol5}
                  ,STTC_COL6 = #{sttcCol6}
                  ,STTC_COL7 = #{sttcCol7}                
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_TYP_SEQ = #{sttcTypSeq}
               AND STTC_DATA_SNO = #{sttcDataSno}
        ]]>
    </insert>
    
    <insert id="updateMasterDtmDy">
        /* kr.go.bai.eip.faa.cav.dao.FAACAV229QMapper.updateMasterDtmDy */
        <![CDATA[
             UPDATE TWFAACAV200M
               SET STTC_DTM_DY = SYSDATE
                  ,FNL_USR_ID = #{usrId}
                  ,FNL_DEAL_DPT_CD = #{dptCd}
                  ,FNL_MDF_DH = SYSDATE
             WHERE STTC_TYP_CD = #{sttcTypCd}
               AND STTC_CLSF_CD = #{sttcClsfCd}
               AND STTC_YR =  (SELECT AUD_YR FROM TWFAACAV200D WHERE STTC_CLSF_CD = '229' AND STTC_TYP_SEQ = #{sttcTypSeq})
        ]]>
    </insert>
    
</mapper>