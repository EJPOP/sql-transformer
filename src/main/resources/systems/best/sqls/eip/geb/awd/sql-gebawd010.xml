<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper">

    <select id="selectAudGrnNo" parameterType="paramMap" resultType="egovMap">
        <![CDATA[
        /* kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper.selectAudGrnNo */
        SELECT A1.LINK_URL
          FROM TBBADDED131M AS A1
         WHERE AUD_PLAN_YR = #{audPlanYr}
           AND DPT_CD = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
           AND DOC_ID = #{docId}
        ]]>
    </select>
    
    <select id="getAudPlanMgrDocInfo" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper.getAudPlanMgrDocInfo*/
        SELECT AUD_PLAN_YR
               , DPT_CD
               , AUD_PLAN_SNO
               , DOC_ID
               , RPRT_NM
               , LINK_URL
               , APV_STA_CD
               , RPRT_CD
               , APV_RQS_ID
               , APV_WAY_CD
               , APV_STA_CD
               , DOC_WRT_ID
               , F_USR_INFO_BY_ID( DOC_WRT_ID, '2' ) AS DOC_WRT_NM
        FROM TBBADDED131M
         WHERE 1=1
           AND AUD_PLAN_YR = #{audPlanYr}
           <if test=" dptCd != null and dptCd != '' ">
           AND DPT_CD = #{dptCd}
           </if>
           <if test=" audPlanSno != null and audPlanSno != '' ">
           AND AUD_PLAN_SNO = #{audPlanSno}
           </if>
           AND DOC_ID = #{docId}
    </select>
    
    <select id="selectMaxAudPlanSno" parameterType="paramMap" resultType="java.lang.String">
        /* kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper.selectMaxAudPlanSno*/
        SELECT NVL(MAX(AUD_PLAN_SNO),0)+1
          FROM TBBADDED131M 
        WHERE AUD_PLAN_YR =  #{audPlanYr}
           AND DPT_CD = #{dptCd}
    </select>
    
	<insert id="insertBADDED131M" parameterType="paramMap">
		/* kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper.insertBADDED131M */
		INSERT INTO TBBADDED131M (
                    AUD_PLAN_YR
                    , DPT_CD
                    , AUD_PLAN_SNO
                    , DOC_ID
                    , RPRT_NM
                    , LINK_URL
                    , NECES_YN
                    , APV_STA_CD
                    , RPRT_CD
                    , APV_RQS_ID
                    , SND_DOC_YN
                    , DOC_KND_CD
                    , AUD_RPRT_DVSN_CD
                    , REF_ID
                    , REF_DY
                    , RLTN_ORG_CD
                    , SORT_SNO
                    <if test="sytTrtmDvsnYn != null and sytTrtmDvsnYn != ''">
                    , SYT_TRTM_DVSN_YN
                    </if>
                    , AUD_DOC_KND_CD
                    , CON_PGM_CD
                    , APV_WAY_CD
                    , DOC_WRT_ID
                    , ONR_HNDL_NO
                    , SECU_RPT_YN
                    , FNL_RPRT_CRE_YN
                    , FNL_BAI_RPRT_YN
                    , REF_DOC_ID
                    , TEMPLATE_DOC_ID
                    , RCPT_DPT_CD
                    , SND_DH
                    , EDT_AUTH
                    , FRT_USR_ID
                    , FNL_USR_ID
                    , FNL_DEAL_DPT_CD
                    , FNL_MNU_ID
                    , FRT_REGI_DH
                    , FNL_MDF_DH
			) VALUES (
                      #{audPlanYr}
                    , #{dptCd}
                    <if test=" audPlanSno != null and audPlanSno != '' ">
                    , #{audPlanSno}
                    </if>
                    <if test =" audPlanSno == null or audPlanSno == '' " >
                    , #{maxAudPlanSno}
                    </if>
                    , #{docId}
                    , #{rprtNm}
                    <if test=" maxLinkUrl != null and maxLinkUrl != '' ">
                    , #{maxLinkUrl}
                    </if>
                    <if test=" maxLinkUrl == null and maxLinkUrl == '' ">
                    , #{linkUrl}
                    </if>
                    , #{necesYn}
                    , #{apvStaCd}
                    , #{rprtCd}
                    , #{apvRqsId}
                    , #{sndDocYn}
                    , #{docKndCd}
                    , #{audRprtDvsnCd}
                    , #{refId}
                    , #{refDy}
                    , #{rltnOrgCd}
                    , (SELECT NVL(MAX(SORT_SNO),0)+1
		   		        FROM TBBADDED131M
		   		       WHERE AUD_PLAN_YR = #{audPlanYr}
                          AND DPT_CD = #{dptCd}
                         <if test=" audPlanSno != null and audPlanSno != '' ">
                         AND AUD_PLAN_SNO = #{audPlanSno}
                         </if>
                         <if test =" audPlanSno == null or audPlanSno == '' " >
                         AND AUD_PLAN_SNO = #{maxAudPlanSno}
                         </if>
                          AND DOC_ID = #{docId} )
                    <if test="sytTrtmDvsnYn != null and sytTrtmDvsnYn != ''">
                     , #{sytTrtmDvsnYn}
                     </if>
                    , #{audDocKndCd}
                    , #{conPgmCd}
                    , #{apvWayCd}
                    , #{usrId}
                    , #{onrHndlNo}
                    , #{secuRptYn}
                    , #{fnlRprtCreYn}
                    , #{fnlBaiRprtYn}
                    , #{refDocId}
                    , #{templateDocId}
                    , #{rcptDptCd}
                    , #{sndDh}
                    , #{edtAuth}
                    , #{usrId}
                    , #{usrId}
                    , #{usrDptCd}
                    , #{menuNo}
                    , SYSDATE
                    , SYSDATE
            )
	</insert>

	<update id="updateBADDED131M" parameterType="paramMap">
		/* kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper.updateBADDED131M*/
		UPDATE TBBADDED131M
		   SET FNL_MDF_DH = SYSDATE
               ,FNL_USR_ID = #{usrId}
               ,FNL_DEAL_DPT_CD =#{usrDptCd}
		   	   <if test="rprtNm != null and rprtNm != ''">
		   	   , RPRT_NM = #{rprtNm}
		   	   </if>
		   	   <if test="linkUrl != null and linkUrl != ''">
		   	   , LINK_URL = #{linkUrl}
		   	   </if>
		   	   <if test="apvStaCd != null and apvStaCd != ''">
		   	   , APV_STA_CD = #{apvStaCd}
		   	   </if>
		   	   <if test="apvRqsId != null and apvRqsId != ''">
		   	   , APV_RQS_ID = #{apvRqsId}
		   	   </if>
               <if test="refId != null and refId != ''">
               , REF_ID = #{refId}
               </if>
               <if test="onrHndlNo != null and onrHndlNo != ''">
               , ONR_HNDL_NO = #{onrHndlNo}
               </if>
               <if test="secuRptYn != null and secuRptYn != ''">
               , SECU_RPT_YN = #{secuRptYn}
               </if>
               <if test="refDocId != null and refDocId != ''">
               , REF_DOC_ID = #{refDocId}
               </if>
               <if test="sytTrtmDvsnYn != null and sytTrtmDvsnYn != ''">
                , SYT_TRTM_DVSN_YN = #{sytTrtmDvsnYn}
                </if>
		 WHERE AUD_PLAN_YR = #{audPlanYr}
           AND DPT_CD = #{dptCd}
           AND AUD_PLAN_SNO = #{audPlanSno}
           AND DOC_ID = #{docId}
	</update>

    <update id="updateAudRprtNm" parameterType="paramMap">
        <![CDATA[
        /* kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper.updateAudRprtNm */
          UPDATE TBBADDED131M
             SET RPRT_NM = #{rprtNm}
           WHERE 1=1
             AND AUD_PLAN_YR = #{audPlanYr}
             AND DPT_CD = #{dptCd}
             AND AUD_PLAN_SNO = #{audPlanSno}
             AND DOC_ID = #{docId}
        ]]>
    </update>
    
    <select id="getAudPlanMgrAllList" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper.getAudPlanMgrAllList */
    <![CDATA[
        SELECT
		    QUARTER,
		    NVL(H_1,'재정경제감사국') AS H_1
		   , NVL(H_2,'산업금융감사국') AS H_2
		   , NVL(H_3,'국토해양감사국') AS H_3
		   , NVL(H_4,'공공기관감사국') AS H_4
		   , NVL(H_5,'사회복지감사국') AS H_5
		   , NVL(H_6,'행정안전감사국') AS H_6
		   , NVL(H_7,'지방행정감사1국') AS H_7
		   , NVL(H_8,'지방행정감사2국') AS H_8
		   , NVL(H_9,'국방감사단') AS H_9
		   , NVL(H_10,'민원조사단') AS H_10
		   , NVL(H_11,'감사청구조사단') AS H_11
		   , NVL(H_12,'공공감사운영단') AS H_12
		   , NVL(H_13,'특별조사국') AS H_13
		   , NVL(H_14,'전략감사단') AS H_14
		   , NVL(H_15,'SOC시설안전감사단') AS H_15
		   , NVL(H_16,'IT감사단') AS H_16
		FROM(
	    
	    /* 감사실적 및 계획 총괄1 */
		SELECT '구분' AS QUARTER
		      , MAX(CASE WHEN E.GUK_CD = '010' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_1
		      , MAX(CASE WHEN E.GUK_CD = '020' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_2
		      , MAX(CASE WHEN E.GUK_CD = '030' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_3
		      , MAX(CASE WHEN E.GUK_CD = '090' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_4
              , MAX(CASE WHEN E.GUK_CD = '040' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_5
		      , MAX(CASE WHEN E.GUK_CD = '050' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_6
		      , MAX(CASE WHEN E.GUK_CD = '061' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_7
		      , MAX(CASE WHEN E.GUK_CD = '062' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_8
              , MAX(CASE WHEN E.GUK_CD = '0G0' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_9
              , MAX(CASE WHEN E.GUK_CD = '071' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_10
		      , MAX(CASE WHEN E.GUK_CD = '081' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_11
		      , MAX(CASE WHEN E.GUK_CD = '180' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_12
		      , MAX(CASE WHEN E.GUK_CD = '070' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_13
		      , MAX(CASE WHEN E.GUK_CD = '0A0' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_14
		      , MAX(CASE WHEN E.GUK_CD = '0A1' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_15
		      , MAX(CASE WHEN E.GUK_CD = '0H0' THEN F_DPT_INFO(E.GUK_CD||'000','1')||E.AUD_CNT_GUK||'<br>'||AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') ELSE '' END) AS H_16
		 
          FROM (
		        SELECT C.GUK_CD
		              ,'('||(SELECT COUNT(*)
		                       FROM TBBADDED128M D
		                      WHERE D.AUD_PLAN_YR = #{audPlanYr}
		                        AND SUBSTR(D.DPT_CD,0,3) = C.GUK_CD)||')' AS AUD_CNT_GUK
		              ,C.AUD_KND_CD
		              ,COUNT(*) AS AUD_CNT
		              ,CASE WHEN C.AUD_KND_CD = '1' OR C.AUD_KND_CD = '4' THEN '('||SUM(C.ORG_CNT)||')' ELSE NULL END AS ORG_CNT
		          FROM (
		                SELECT A.AUD_PLAN_YR
		                      ,SUBSTR(A.DPT_CD,0,3) AS GUK_CD
		                      ,A.AUD_PLAN_SNO
		                      ,A.AUD_KND_CD
		                      ,COUNT(B.ORG_CD) AS ORG_CNT
		                  FROM TBBADDED128M A, TBBADDED130M B
		                 WHERE A.AUD_PLAN_YR  = B.AUD_PLAN_YR(+)
		                   AND A.DPT_CD       = B.DPT_CD(+)
		                   AND A.AUD_PLAN_SNO = B.AUD_PLAN_SNO(+)
		                   AND A.AUD_PLAN_YR = #{audPlanYr}
		                   AND A.ACTU_AUD_STR_DY IS NOT NULL
    ]]>
                       <if test="quarter != null and quarter != ''">
                           AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') IN (${quarter})
                       </if>
                       <if test="month != null and month != ''">
                           AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'MM') IN (${month})
                       </if>
    	                 GROUP BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.AUD_KND_CD
		                 ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.AUD_KND_CD
		               ) C
		          GROUP BY C.AUD_PLAN_YR,C.GUK_CD,C.AUD_KND_CD
		       ) E
		 GROUP BY E.GUK_CD,E.AUD_CNT_GUK
		)QQ 
        
		UNION ALL
		
		/* 감사실적 및 계획 총괄2 */
		
		    SELECT 
            <if test="month == null or month == ''">
                Z.QUARTER||'/4 분기'||CHR(13)||CHR(10)||'계획('||SUM(Z.AUD_CNT)||')' AS QUARTER
            </if>
            <if test="month != null and month != ''">
                Z.MONTH ||'월 계획('||SUM(Z.AUD_CNT)||')' AS MONTH
            </if>
		          , MAX(Z.AUD_INFO_010) AS H_1
		          , MAX(Z.AUD_INFO_020) AS H_2
		          , MAX(Z.AUD_INFO_030) AS H_3
		          , MAX(Z.AUD_INFO_090) AS H_4
		          , MAX(Z.AUD_INFO_040) AS H_5
		          , MAX(Z.AUD_INFO_050) AS H_6
		          , MAX(Z.AUD_INFO_061) AS H_7
		          , MAX(Z.AUD_INFO_062) AS H_8
		          , MAX(Z.AUD_INFO_0G0) AS H_9
		          , MAX(Z.AUD_INFO_071) AS H_10
		          , MAX(Z.AUD_INFO_081) AS H_11
		          , MAX(Z.AUD_INFO_180) AS H_12
		          , MAX(Z.AUD_INFO_070) AS H_13
		          , MAX(Z.AUD_INFO_0A0) AS H_14
		          , MAX(Z.AUD_INFO_0A1) AS H_15
		          , MAX(Z.AUD_INFO_0H0) AS H_16
		      FROM (
		            SELECT 
                    <if test="month == null or month == ''">
                        TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') AS QUARTER
                    </if>
                    <if test="month != null and month != ''">
                        SUBSTR(A.ACTU_AUD_STR_DY,5,2) AS MONTH
                    </if>
    <![CDATA[
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '010' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'010',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                             ELSE '' END AS AUD_INFO_010
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '020' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'020',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_020
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '030' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'030',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_030
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '040' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'040',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_040
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '050' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'050',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_050
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '061' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'061',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_061
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '062' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'062',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_062
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '070' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'070',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_070
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '071' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'071',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_071
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '081' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'081',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_081
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '090' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'090',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_090
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '0A0' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'0A0',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_0A0
		                   ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '0A1' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'0A1',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_0A1
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '0G0' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'0G0',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_0G0
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '0H0' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'0H0',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_0H0
		                  ,CASE WHEN SUBSTR(A.DPT_CD,0,3) = '180' THEN AGGR_CONCAT(DECODE(A.AUD_KND_CD,'1','○','2','□','3','▣','4','◎')||' '||A.AUD_SBJ_NM||
                                             '('||DECODE(SUBSTR(A.DPT_CD,0,3),'180',F_DPT_INFO(A.DPT_CD,'4'),SUBSTR(F_DPT_INFO(A.DPT_CD,'4'),3,1)||'과')||'-'
		                                        ||F_CODE_NM('1000739', A.AUD_KND_CD)||'-'||SUBSTR(A.ACTU_AUD_STR_DY,5,2)||'월)'||CHR(13)||CHR(10), '' ORDER BY A.AUD_KND_CD,A.DPT_CD,A.ACTU_AUD_STR_DY)
		                        ELSE '' END AS AUD_INFO_180
		                  ,COUNT(*) AS AUD_CNT
		              FROM TBBADDED128M A
		             WHERE 1=1
		               AND A.AUD_PLAN_YR = #{audPlanYr}
		               AND A.ACTU_AUD_STR_DY IS NOT NULL
		               AND SUBSTR(A.DPT_CD,0,3) IN ('010','020','030','040','050','061','062','070','071','081','090','0A0','0A1','0G0','0H0','180')
                       ]]>
                       <if test="quarter != null and quarter != ''">
                       AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') IN (${quarter})
                       </if>
                       <if test="month != null and month != ''">
                       AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'MM') IN (${month})
                       </if>
                       <if test="month == null or month == ''">
		               GROUP BY TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q'), SUBSTR(A.DPT_CD,0,3)
                       </if>
                       <if test="month != null and month != ''">
                       GROUP BY SUBSTR(A.ACTU_AUD_STR_DY,5,2) , SUBSTR(A.DPT_CD,0,3)
                       </if>
		             ORDER BY SUBSTR(A.DPT_CD,0,3)
		           ) Z
         <if test="month == null or month == ''">
         GROUP BY Z.QUARTER 
         </if>
         <if test="month != null and month != ''">
          GROUP BY Z.MONTH
         </if>
    </select>
    
    <select id="getAudPlanMgrCntList" parameterType="paramMap" resultType="egovMap">
    /* kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper.getAudPlanMgrCntList*/
    SELECT '계 : '||SUM(TT.AUD_KND_CNT)||'사항('|| SUM(TT.ORG_SUM) ||'개 기관)' AS TOT_TXT
              , AGGR_CONCAT(TT.CNT_TXT, ',') AS CNT_TXT
      FROM (
         SELECT CASE WHEN T.AUD_KND_CD IN ('1','4') THEN T.AUD_KND_NM ||'감사 : '||T.AUD_KND_CNT||'개('||T.ORG_SUM||'개 기관)' 
                              ELSE T.AUD_KND_NM ||'감사 : '||T.AUD_KND_CNT||'개 사항' END AS CNT_TXT, T.*
          FROM (
            SELECT AUD_KND_CNT
                      , AUD_PLAN_YR
                      , AUD_KND_CD
                      , F_CODE_NM('1000739', AUD_KND_CD) AS AUD_KND_NM
                      , SUM(DECODE(AUD_KND_CD, 1, ORG_CNT, 4, ORG_CNT ,0)) AS ORG_SUM
             FROM (
                    SELECT COUNT(A.AUD_PLAN_YR) OVER (PARTITION BY A.AUD_PLAN_YR, A.AUD_KND_CD) AS AUD_KND_CNT
                             , A.AUD_PLAN_YR
                             , A.AUD_KND_CD
                             , A.DPT_CD
                             , A.AUD_PLAN_SNO
                             , (SELECT COUNT(ST1.ORG_CD) FROM TBBADDED130M ST1 WHERE ST1.AUD_PLAN_YR = A.AUD_PLAN_YR AND ST1.DPT_CD = A.DPT_CD AND ST1.AUD_PLAN_SNO = A.AUD_PLAN_SNO) AS ORG_CNT
                      FROM TBBADDED128M A 
                    WHERE A.AUD_PLAN_YR = #{audPlanYr}
                        AND SUBSTR(A.DPT_CD,0,3) IN ('010','020','030','040','050','061','062','070','071','081','090','0A0','0A1','0G0','0H0','180')
                    <if test="quarter != null and quarter != ''">
                        AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') IN (${quarter})
                    </if>
                    <if test="month != null and month != ''">
                        AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'MM') IN (${month})
                    </if>
                    )
                GROUP BY AUD_PLAN_YR, AUD_KND_CD, AUD_KND_CNT 
        ) T
  ) TT 
    </select>
    
    <select id="getAudPlanMgrCnt2List" parameterType="paramMap" resultType="egovMap">
    <![CDATA[
    /* kr.go.bai.eip.geb.awd.dao.GEBAWD010EMapper.getAudPlanMgrCnt2List */
    SELECT CASE WHEN SUM(AUD_CNT) >0 
                        THEN '민원/감청/공감'||'('||SUM(AUD_CNT)||')' ||'<br>'|| AGGR_CONCAT(F_CODE_NM('1000739', E.AUD_KND_CD)||E.AUD_CNT||E.ORG_CNT,',') 
               ELSE '민원/감청/공감' END AS H_10_12
     FROM (
          SELECT '('||  COUNT(1)  ||')' AS AUD_CNT_GUK
                     , C.AUD_KND_CD
                     , COUNT(*) AS AUD_CNT
                     , CASE WHEN C.AUD_KND_CD = '1' OR C.AUD_KND_CD = '4' THEN '('||SUM(C.ORG_CNT)||')' ELSE NULL END AS ORG_CNT
            FROM (
                  SELECT A.AUD_PLAN_YR 
                            , A.AUD_PLAN_SNO
                            , A.AUD_KND_CD
                            , COUNT(B.ORG_CD) AS ORG_CNT
                    FROM TBBADDED128M A, TBBADDED130M B
                  WHERE A.AUD_PLAN_YR  = B.AUD_PLAN_YR(+)
                     AND A.DPT_CD       = B.DPT_CD(+)
                     AND A.AUD_PLAN_SNO = B.AUD_PLAN_SNO(+)
                     AND A.AUD_PLAN_YR = #{audPlanYr}
                     AND A.ACTU_AUD_STR_DY IS NOT NULL
                     AND SUBSTR(A.DPT_CD,0,3) IN ('071','081','180')
]]>         
                 <if test="quarter != null and quarter != ''">
                     AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'Q') IN (${quarter})
                 </if>
                 <if test="month != null and month != ''">
                     AND TO_CHAR(TO_DATE(A.ACTU_AUD_STR_DY),'MM') IN (${month})
                 </if>
                  GROUP BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.AUD_KND_CD
                  ORDER BY A.AUD_PLAN_YR,A.DPT_CD,A.AUD_PLAN_SNO,A.AUD_KND_CD
                    ) C
              GROUP BY C.AUD_PLAN_YR,C.AUD_KND_CD
              ORDER BY C.AUD_PLAN_YR,C.AUD_KND_CD 
            )  E
    </select>
        <select id="selectAprvIds" parameterType="paramMap" resultType="egovMap">
        /* kr.go.bai.eip.bad.ded.dao.GEBAWD003EMapper.selectAprvIds */
        SELECT F_USR_INFO(APVR_CNB, '1') AS APVR_ID
                , F_USR_INFO(APVR_CNB, '2') AS APVR_NM
               , APVR_PST_CD --결재자 직위 코드
               , F_CODE_NM('1000350', APVR_KND_CD) AS APVR_CD
          FROM TBDCMACM023L
         WHERE 1=1
           AND APV_DOC_NO = ( SELECT APV_RQS_ID
                                FROM TBBADDED131M
                               WHERE AUD_PLAN_YR = #{audPlanYr}
                                 AND DPT_CD = #{dptCd}
                                 AND AUD_PLAN_SNO = #{audPlanSno}
                                 AND DOC_ID = #{docId} )
         ORDER BY APV_SNO
    </select>
    
</mapper>