<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.bad.ded.dao.BADDED015PMapper">

    <insert id="save" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.save*/
            <![CDATA[
            MERGE INTO TBBADDED135M
			USING DUAL
			   ON (     
			            AUD_YR      = #{audYr}
			        AND AUD_NO      = #{audNo}
			        AND AUD_IMPL_DCS_SRNO  = #{audImplDcsSrno} 
			      ) 
			 WHEN MATCHED THEN 
			    UPDATE 
			       SET AUD_IMPL_DCS_DY      = #{audImplDcsDy}
			         , AUD_IMPL_DCS_TITLE   = #{audImplDcsTitle}
			         , AUD_IMPL_DCS_RES_CD  = #{audImplDcsResCd}
			         , AUD_IMPL_DCS_END_YN  = #{audImplDcsEndYn}
			         , AUD_IMPL_DCS_END_DH  = #{audImplDcsEndDh}
			         , AUD_IMPL_DCS_END_RSLT = #{audImplDcsEndRslt}
			         , FNL_USR_ID           = #{usrId}
			         , FNL_DEAL_DPT_CD      = #{dptCd}
			         , FNL_MDF_DH           = SYSDATE
			 WHEN NOT MATCHED THEN   
			    INSERT( 
                      AUD_YR
                    , AUD_NO
                    , AUD_IMPL_DCS_SRNO
                    , AUD_IMPL_DCS_DY
                    , AUD_IMPL_DCS_TITLE
                    , AUD_IMPL_DCS_RES_CD
                    , AUD_IMPL_DCS_END_YN
                    , AUD_IMPL_DCS_END_DH
                    , AUD_IMPL_DCS_END_RSLT
                    , FRT_USR_ID
                    , FNL_USR_ID
                    , FNL_DEAL_DPT_CD
                    , FNL_MNU_ID
                    , FRT_REGI_DH
                    , FNL_MDF_DH
			    ) VALUES ( 
			  	      #{audYr}
                    , #{audNo}
                    , (SELECT NVL(MAX(AUD_IMPL_DCS_SRNO), 0) + 1 FROM TBBADDED135M)
                    , #{audImplDcsDy}
                    , #{audImplDcsTitle}
                    , #{audImplDcsResCd}
                    , #{audImplDcsEndYn}
                    , #{audImplDcsEndDh}
                    , #{audImplDcsEndRslt}
                    , #{usrId}
                    , #{usrId}
                    , #{dptCd}
                    , #{menuNo}
                    , SYSDATE
                    , SYSDATE
			    ) 
            ]]>
    </insert>
    
    
    
    <select id="selectMain" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.selectMain*/
        <![CDATA[
           SELECT   A.AUD_YR
                  , A.AUD_NO
                  , A.AUD_IMPL_DCS_SRNO
                  , TO_CHAR(TO_DATE(A.AUD_IMPL_DCS_DY),'YYYY-MM-DD') AS AUD_IMPL_DCS_DY
                  , A.AUD_IMPL_DCS_TITLE
                  , A.AUD_IMPL_DCS_RES_CD
                  , F_CODE_NM('1000866', A.AUD_IMPL_DCS_RES_CD) AS AUD_IMPL_DCS_RES_NM
                  , A.AUD_IMPL_DCS_END_YN
                  , A.AUD_IMPL_DCS_END_DH
                  , AUD_IMPL_DCS_END_RSLT
                  , (SELECT COUNT(1) FROM TBBADDED135L ST WHERE ST.WRK_YR = A.AUD_YR AND ST.WRK_NO = A.AUD_NO AND WRK_DVSN_CD = 'A10') AS AUD_IMPL_DCS_DOC_INFO
                  , CASE WHEN B.AUD_IMPL_DCS_USR_NM IS NULL THEN '' 
                         ELSE B.AUD_IMPL_DCS_USR_NM || CASE WHEN DCS_USR_CNT > 1 THEN ' 외 ' || TO_CHAR(DCS_USR_CNT - 1) || '명' 
                                                            ELSE '' END END AS AUD_IMPL_DCS_USR_INFO
             FROM TBBADDED135M A
           LEFT OUTER JOIN (SELECT   AUD_YR
                                   , AUD_NO, F_USR_INFO(AUD_IMPL_DCS_CNB, '2') AS AUD_IMPL_DCS_USR_NM
                                   , (SELECT COUNT(1) 
                                        FROM TBBADDED135D 
                                       WHERE AUD_YR = #{audYr}
                                         AND AUD_NO = #{audNo}) AS DCS_USR_CNT
                              FROM TBBADDED135D
                             WHERE AUD_YR      = #{audYr}
			                   AND AUD_NO      = #{audNo}
                               AND AUD_IMPL_DCS_SORT_SNO IN (SELECT MIN(AUD_IMPL_DCS_SORT_SNO) 
                                                               FROM TBBADDED135D
                                                              WHERE AUD_YR      = #{audYr}
			                                                    AND AUD_NO      = #{audNo})) B ON (B.AUD_YR = A.AUD_YR
                                                                                                AND B.AUD_NO = A.AUD_NO)
            WHERE A.AUD_YR      = #{audYr}
			  AND A.AUD_NO      = #{audNo}
        ]]>
   </select>
   
   
   <select id="selectLinkedMain" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.selectLinkedMain*/
        <![CDATA[
           SELECT   A.AUD_YR
                  , A.AUD_NO
                  , A.AUD_IMPL_DCS_SRNO
                  , TO_CHAR(TO_DATE(A.AUD_IMPL_DCS_DY),'YYYY-MM-DD') AS AUD_IMPL_DCS_DY
                  , A.AUD_IMPL_DCS_TITLE
                  , A.AUD_IMPL_DCS_RES_CD
                  , F_CODE_NM('1000866', A.AUD_IMPL_DCS_RES_CD) AS AUD_IMPL_DCS_RES_NM
                  , A.AUD_IMPL_DCS_END_YN
                  , A.AUD_IMPL_DCS_END_DH
                  , AUD_IMPL_DCS_END_RSLT
                  , (SELECT COUNT(1) FROM TBBADDED135L ST WHERE ST.WRK_YR = A.AUD_YR AND ST.WRK_NO = A.AUD_NO AND WRK_DVSN_CD = 'A10') AS AUD_IMPL_DCS_DOC_INFO
                  , CASE WHEN COUNT(B.AUD_IMPL_DCS_PART_SRNO) = 0 THEN '' 
                         WHEN COUNT(B.AUD_IMPL_DCS_PART_SRNO) = 1 THEN (SELECT F_USR_INFO(AUD_IMPL_DCS_CNB, '2') 
                                                                          FROM TBBADDED135D 
                                                                         WHERE AUD_YR = B.AUD_YR 
                                                                           AND AUD_NO = B.AUD_NO)
                         ELSE (SELECT F_USR_INFO(AUD_IMPL_DCS_CNB, '2') 
                                 FROM TBBADDED135D 
                                WHERE AUD_YR = B.AUD_YR 
                                  AND AUD_NO = B.AUD_NO 
                                  AND AUD_IMPL_DCS_SRNO = B.AUD_IMPL_DCS_SRNO 
                                  AND AUD_IMPL_DCS_PART_SRNO = (SELECT MIN(AUD_IMPL_DCS_PART_SRNO) 
                                                                  FROM TBBADDED135D 
                                                                 WHERE AUD_YR = B.AUD_YR 
                                                                   AND AUD_NO = B.AUD_NO 
                                                                   AND AUD_IMPL_DCS_SRNO = B.AUD_IMPL_DCS_SRNO)) || ' 외 ' || TO_CHAR(COUNT(B.AUD_IMPL_DCS_PART_SRNO) - 1)  || '명' 
                         END AS AUD_IMPL_DCS_USR_INFO
             FROM TBBADDED135M A
  LEFT OUTER JOIN TBBADDED135D B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO)
       INNER JOIN TBBADDED101L C ON (C.REL_AUD_YR = A.AUD_YR AND C.REL_AUD_NO = A.AUD_NO)
            WHERE C.AUD_YR      = #{audYr}
			  AND C.AUD_NO      = #{audNo}
              GROUP BY A.AUD_YR
                  , A.AUD_NO
                  , A.AUD_IMPL_DCS_SRNO
                  , A.AUD_IMPL_DCS_DY
                  , A.AUD_IMPL_DCS_TITLE
                  , A.AUD_IMPL_DCS_RES_CD
                  , A.AUD_IMPL_DCS_END_YN
                  , A.AUD_IMPL_DCS_END_DH
                  , AUD_IMPL_DCS_END_RSLT
                  , B.AUD_YR 
                  , B.AUD_NO
                  , B.AUD_IMPL_DCS_SRNO
        ]]>
   </select>
   
   <select id="selectDcsDocList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.selectDcsDocList*/
        <![CDATA[
           SELECT   UPLOAD_FILE_SNO
                      , WRK_DVSN_CD
                      , WRK_YR
                      , WRK_NO
                      , DETL_WRK_DVSN_SRNO
                      , DETL_WRK_DVSN_CD
                      , WRK_STEP_CD
                      , UPLOAD_FILE_NM
                      , DOC_ID
                      , UPLOAD_FILE_SORT_SNO
                      , USE_YN
                      , TO_CHAR(FRT_REGI_DH,'YYYY-MM-DD HH24:MI:SS') AS FRT_REGI_DH
             FROM TBBADDED135L
            WHERE WRK_YR      = #{audYr}
			  AND WRK_NO      = #{audNo}
			  AND WRK_DVSN_CD = 'A10'
			ORDER BY UPLOAD_FILE_SORT_SNO
        ]]>
   </select>
   
   
    <select id="selectDcsUsrList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.selectDcsUsrList*/
        <![CDATA[
           SELECT   AUD_YR
                  , AUD_NO
                  , AUD_IMPL_DCS_SRNO
                  , AUD_IMPL_DCS_PART_SRNO
                  , AUD_IMPL_DCS_CNB
                  , F_USR_INFO(AUD_IMPL_DCS_CNB, '2') AS AUD_IMPL_DCS_USR_NAM
                  , AUD_IMPL_DCS_PST_CD
                  , F_CODE_NM('1000176',AUD_IMPL_DCS_PST_CD) AS AUD_IMPL_DCS_PST_NM
                  , AUD_IMPL_DCS_RANK_CD
                  , AUD_IMPL_DCS_DPT_CD
                  , F_DPT_INFO(AUD_IMPL_DCS_DPT_CD, '1') AS AUD_IMPL_DCS_DPT_NM
                  , AUD_IMPL_DCS_SORT_SNO
                  , (SELECT USR_ID FROM TBDCMACM001M WHERE CNB = AUD_IMPL_DCS_CNB) AS AUD_IMPL_DCS_USR_ID
                  , F_CODE_NM('1000173', AUD_IMPL_DCS_RANK_CD) AS AUD_IMPL_DCS_RANK_NM
             FROM TBBADDED135D
            WHERE AUD_YR      = #{audYr}
			  AND AUD_NO      = #{audNo}
			  AND AUD_IMPL_DCS_SRNO = #{audImplDcsSrno}
			ORDER BY AUD_IMPL_DCS_SORT_SNO
        ]]>
   </select>
   
   
   <insert id="saveDcsDoc" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.saveDcsDoc*/
            <![CDATA[
			    INSERT INTO TBBADDED135L( 
                        UPLOAD_FILE_SNO
                      , WRK_DVSN_CD
                      , WRK_YR
                      , WRK_NO
                      , DETL_WRK_DVSN_SRNO
                      , DETL_WRK_DVSN_CD
                      , WRK_STEP_CD
                      , UPLOAD_FILE_NM
                      , DOC_ID
                      , UPLOAD_FILE_SORT_SNO
                      , USE_YN
                      , FRT_USR_ID
                      , FNL_USR_ID
                      , FNL_DEAL_DPT_CD
                      , FNL_MNU_ID
                      , FRT_REGI_DH
                      , FNL_MDF_DH
			    ) VALUES ( 
			           (SELECT NVL(MAX(UPLOAD_FILE_SNO), 0) + 1 FROM TBBADDED135L)
			  	    , #{wrkDvsnCd}
                    , #{wrkYr}
                    , #{wrkNo}
                    , #{detlWrkDvsnSrno}
                    , #{detlWrkDvsnCd}
                    , #{wrkStepCd}
                    , #{uploadFileNm}
                    , #{docId}
                    , (SELECT NVL(MAX(UPLOAD_FILE_SORT_SNO), 0) + 1 
                         FROM TBBADDED135L 
                        WHERE WRK_DVSN_CD = #{wrkDvsnCd} 
                          AND WRK_YR = #{wrkYr} 
                          AND WRK_NO = #{wrkNo} 
                          AND DETL_WRK_DVSN_SRNO = #{detlWrkDvsnSrno})
                    , 'Y'
                    , #{usrId}
                    , #{usrId}
                    , #{dptCd}
                    , #{menuNo}
                    , SYSDATE
                    , SYSDATE
			    ) 
            ]]>
    </insert>
    
    <delete id="deleteDcsDoc" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.deleteDcsDoc*/
        DELETE 
          FROM TBBADDED135L
         WHERE 1=1
           <if test="uploadFileSno != null and uploadFileSno != ''">
           AND UPLOAD_FILE_SNO = #{uploadFileSno}
           </if>
           AND WRK_DVSN_CD = 'A10'
           AND WRK_YR = NVL(#{wrkYr}, #{audYr})
           AND WRK_NO = NVL(#{wrkNo}, #{audNo})
           <if test="docId != null and docId != ''">
           AND DOC_ID = #{docId}
           </if>
    </delete>
    
    <delete id="deleteDcsData" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.deleteDcsData*/
        DELETE 
          FROM TBBADDED135M
         WHERE AUD_YR      = #{audYr}
		   AND AUD_NO      = #{audNo}
		   AND AUD_IMPL_DCS_SRNO  = #{audImplDcsSrno} 
    </delete>
    
    
    <insert id="insertDcsUsr" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.insertDcsUsr*/
            <![CDATA[
			    INSERT INTO TBBADDED135D( 
                        AUD_YR
                      , AUD_NO
                      , AUD_IMPL_DCS_SRNO
                      , AUD_IMPL_DCS_PART_SRNO
                      , AUD_IMPL_DCS_CNB
                      , AUD_IMPL_DCS_PST_CD
                      , AUD_IMPL_DCS_RANK_CD
                      , AUD_IMPL_DCS_DPT_CD
                      , AUD_IMPL_DCS_SORT_SNO
                      , FRT_USR_ID
                      , FNL_USR_ID
                      , FNL_DEAL_DPT_CD
                      , FNL_MNU_ID
                      , FRT_REGI_DH
                      , FNL_MDF_DH
			    ) VALUES ( 
			          #{audYr}
                    , #{audNo}
                    , #{audImplDcsSrno}
                    , (SELECT NVL(MAX(AUD_IMPL_DCS_PART_SRNO), 0) + 1 
                         FROM TBBADDED135D 
                        WHERE AUD_YR = #{audYr}
                          AND AUD_NO = #{audNo}
                          AND AUD_IMPL_DCS_SRNO = #{audImplDcsSrno})
                    , #{audImplDcsCnb}
                    , #{audImplDcsPstCd}
                    , #{audImplDcsRankCd}
                    , #{audImplDcsDptCd}
                    , (SELECT NVL(MAX(AUD_IMPL_DCS_SORT_SNO), 0) + 1 
                         FROM TBBADDED135D 
                        WHERE AUD_YR = #{audYr}
                          AND AUD_NO = #{audNo}
                          AND AUD_IMPL_DCS_SRNO = #{audImplDcsSrno})
                    , #{usrId}
                    , #{usrId}
                    , #{dptCd}
                    , #{menuNo}
                    , SYSDATE
                    , SYSDATE
			    ) 
            ]]>
    </insert>
    
    <delete id="deleteDcsUsr" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED015PMapper.deleteDcsUsr*/
        DELETE 
          FROM TBBADDED135D
         WHERE 1=1
           AND AUD_YR      = #{audYr}
		   AND AUD_NO      = #{audNo}
		   <if test="audImplDcsSrno != null and audImplDcsSrno != ''">
		   AND AUD_IMPL_DCS_SRNO      = #{audImplDcsSrno}
		   </if>
		   <if test="audImplDcsPartSrno != null and audImplDcsPartSrno != ''">
           AND AUD_IMPL_DCS_PART_SRNO = #{audImplDcsPartSrno}
           </if>
    </delete>
</mapper> 