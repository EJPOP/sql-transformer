<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.bad.fre.dao.BADFRE007EMapper">

    <select id="selectMainList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.fre.dao.BADFRE007EMapper.selectMainList*/
        <include refid="include.pageSelct" />
            <![CDATA[    
			SELECT T1.ACP_YR || '-' || DECODE(T1.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') || '-' || DECODE(T1.ORG_ACP_SRNO, null, T1.ACP_SRNO, T1.ORG_ACP_SRNO)
					|| ' ' || (CASE WHEN T1.MG_ACP_YR IS NULL THEN ''
		                        	WHEN T1.MG_DIV_CD = '10' THEN '병합(' || (SELECT COUNT(MG_ACP_YR)
		                                                                   		FROM TBBADFRE012M
		                                                                  		WHERE MG_ACP_YR = T1.MG_ACP_YR
		                                                                    		AND MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
		                                                                    		AND MG_ACP_SRNO = T1.MG_ACP_SRNO) || ')'
		                        	WHEN T1.MG_DIV_CD = '20' THEN '병행(' || (SELECT COUNT(MG_ACP_YR)
		                                                                  		FROM TBBADFRE012M
		                                                                  		WHERE MG_ACP_YR = T1.MG_ACP_YR
		                                                                    		AND MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
		                                                                    		AND MG_ACP_SRNO = T1.MG_ACP_SRNO) || ')'
		                   			ELSE '병합(' || (SELECT COUNT(T4.MG_ACP_YR)
		                                     			 FROM TBBADFRE012M T4
		                                    			 WHERE T4.MG_ACP_YR = T1.MG_ACP_YR
		                                       				AND T4.MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
		                                       				AND T4.MG_ACP_SRNO = T1.MG_ACP_SRNO
		                                       				AND T4.MG_DPT_CD = T1.MG_DPT_CD) || ')' END) AS ACP_YR_NO
				, TIT_NM	 
				, T1.ACP_HNDL_STA_CD /* 진행단계코드 */
			    , F_CODE_NM('1000807', T1.ACP_HNDL_STA_CD) AS ACP_STEP_NM	 /* 진행단계명 */	
				, (SELECT AGGR_CONCAT(DTIL_AUD_DOC_NM,',') AS CD_NM
					  FROM (SELECT AUD_DOC_CD
					            , DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1)) AS DTIL_AUD_DOC_NM
					          FROM TBFDMADM002M
			]]>
						<if test="acpDvsnCd == 1"> 
					        	WHERE SUBSTR(AUD_DOC_CD,0,1) = 'D'
					        	GROUP BY AUD_DOC_CD, DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1))
					        	UNION ALL SELECT 'D10400600' , '공개문' FROM DUAL
					   	</if> 
					    <if test="acpDvsnCd == 2"> 
					        	WHERE SUBSTR(AUD_DOC_CD,0,1) = 'E'
					        	GROUP BY AUD_DOC_CD, DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1))
					        	UNION ALL SELECT 'E10600300' , '공개문' FROM DUAL
					   	</if> 
			<![CDATA[
					        )
					  WHERE AUD_DOC_CD = T2.RPRT_CD 
					 GROUP BY AUD_DOC_CD) AS RPRT_KND_NM
				, (CASE WHEN T1.MG_ACP_YR IS NULL THEN ''
                        WHEN T1.MG_DIV_CD = '10' THEN '병합(' || (SELECT COUNT(MG_ACP_YR)
                                                                   FROM TBBADFRE012M
                                                                  WHERE MG_ACP_YR = T1.MG_ACP_YR
                                                                    AND MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
                                                                    AND MG_ACP_SRNO = T1.MG_ACP_SRNO) || ')'
                        WHEN T1.MG_DIV_CD = '20' THEN '병행(' || (SELECT COUNT(MG_ACP_YR)
                                                                   FROM TBBADFRE012M
                                                                  WHERE MG_ACP_YR = T1.MG_ACP_YR
                                                                    AND MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
                                                                    AND MG_ACP_SRNO = T1.MG_ACP_SRNO) || ')'
                   ELSE '병합(' || (SELECT COUNT(T4.MG_ACP_YR)
                                      FROM TBBADFRE012M T4
                                     WHERE T4.MG_ACP_YR = T1.MG_ACP_YR
                                       AND T4.MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
                                       AND T4.MG_ACP_SRNO = T1.MG_ACP_SRNO
                                       AND T4.MG_DPT_CD = T1.MG_DPT_CD) || ')' END) AS MG_COUNT 
				, (SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD = T1.DPT_CD) AS DPT_NM
				, T1.HNDL_CHGR_NM	 
				, T2.RPRT_CD
				, T2.RPRT_NM
                , T2.RPRT_NM AS RPRT_REAL_NM
			    , F_CODE_NM('1000773', T2.APV_STA_CD) AS APV_STA_NM
			    , F_USR_INFO_BY_ID(DOC_WRT_ID,'2') AS DOC_WRT_NM
			    , TO_CHAR(T2.FRT_REGI_DH,'YYYY"-"MM"-"DD" "HH24:MI') AS REGI_DH 
			    ,(CASE WHEN TO_DATE(SYSDATE) >= TO_DATE(T3.EDT_END_DT)+1  THEN 'N'   /*현재날짜가 종료일+1보다 클떄 */
			             ELSE NVL(T2.EDT_AUTH,'N')
				         END) EDT_AUTH
				, (CASE WHEN TO_DATE(SYSDATE) >= TO_DATE(T3.EDT_END_DT)+1 THEN '편집불가'  /*현재날짜가 종료일+1보다 클떄 */
				         WHEN T2.APV_STA_CD = '10' THEN '편집가능'
				         WHEN T2.APV_STA_CD != '10' AND T2.EDT_AUTH IS NULL THEN '편집불가'
				         ELSE DECODE(T2.EDT_AUTH,'N','편집불가','편집가능')
				         END) AS EDT_AUTH_NM 
			    , T2.ACP_YR
			    , T2.ACP_SRNO
			    , T2.ACP_STEP_CD
			    , T2.DOC_ID
			    , T2.APV_STA_CD
			    , T2.APV_RQS_ID
			    , T2.ACP_DVSN_CD
			    , CURR_APV.APVR_NM AS CURR_APV_USR_NM
			    , FNL_APV.APVR_NM AS FNL_APV_USR_NM  
			    ,(SELECT AGGR_CONCAT(ACP_YR || '-' || DECODE(ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') || '-' || DECODE(ORG_ACP_SRNO, null, ACP_SRNO, ORG_ACP_SRNO), ', ')
				 			   FROM TBBADFRE012M 
				 			  WHERE MG_ACP_YR = T1.MG_ACP_YR
				 			  AND MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
				 			  AND MG_ACP_SRNO = T1.MG_ACP_SRNO 
				 			  AND ROWNUM < 200
				 ) AS MG_ALL  
				 ,F_OPEN_EDIT(T2.LINK_URL) AS DOC_TYPE
				 ,(SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END
			       FROM TBDCMACM018H 
			      WHERE DOC_ID = T2.DOC_ID
			         AND CFM_PEN_CFM_YN = 'Y') AS Y_CNT
				 , T4.CFM_PEN_CFM_YN
			     , T4.SEQ
			     , T2.REF_ID
			     ,(SELECT APV_STA_CD
                                  FROM TBBADFRE103M
                                 WHERE 1=1
                                   AND DOC_ID = T2.REF_ID) AS APV_STA_CD2
			  FROM TBBADFRE012M T1
			       INNER JOIN TBBADFRE103M T2
			       ON (T1.ACP_YR = T2.ACP_YR AND T1.ACP_SRNO = T2.ACP_SRNO AND T1.ACP_DVSN_CD = T2.ACP_DVSN_CD)
			       INNER JOIN TBFDMADM001M T5
                   ON(T2.RPRT_CD = T5.AUD_DOC_CD AND T5.APV_WAY_CD = '10')
			 		 LEFT OUTER JOIN (
									SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
									     , DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
									  FROM TBDCMACM023L M
				]]>
								<if test="acpDvsnCd == 1"> 
									 WHERE M.APV_DVSN_CD = 'requestAudit5'
								</if>
								<if test="acpDvsnCd == 2"> 
									 WHERE M.APV_DVSN_CD = 'requestAudit6'
								</if>
				<![CDATA[ 
									   AND SUBSTR(M.APVR_STA_CD,1,1) = '1'
									   AND M.APVR_KND_CD <> '6'
									 GROUP BY M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD, M.APVR_CNB) CURR_APV
			 		ON (T2.APV_RQS_ID = CURR_APV.APV_DOC_NO)
					LEFT OUTER JOIN (
									SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
  										  ,DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
									  FROM TBDCMACM023L M
									  	   ,(
											SELECT APV_DOC_NO, APV_DVSN_CD, MAX(APVR_SEQ) AS MAX_APVR_SEQ
											  FROM TBDCMACM023L
											 GROUP BY APV_DOC_NO, APV_DVSN_CD
											) SUB
					]]>
								<if test="acpDvsnCd == 1">
									 WHERE M.APV_DOC_NO = SUB.APV_DOC_NO
									   AND M.APV_DVSN_CD = SUB.APV_DVSN_CD
									   AND M.APVR_SEQ = SUB.MAX_APVR_SEQ
									   AND M.APV_DVSN_CD = 'requestAudit5' ) FNL_APV
								</if>
								<if test="acpDvsnCd == 2">
									 WHERE M.APV_DOC_NO = SUB.APV_DOC_NO
									   AND M.APV_DVSN_CD = SUB.APV_DVSN_CD
									   AND M.APVR_SEQ = SUB.MAX_APVR_SEQ
									   AND M.APV_DVSN_CD = 'requestAudit6' ) FNL_APV
								</if>
					<![CDATA[
			 	   ON (T2.APV_RQS_ID = FNL_APV.APV_DOC_NO)	
			  LEFT OUTER JOIN TBDCMACM018M T3
			 	   ON (T2.ACP_YR = T3.AUD_YR AND TO_CHAR(T2.ACP_SRNO) = T3.AUD_NO AND T2.ACP_STEP_CD = T3.AUD_STEP_CD AND T2.DOC_ID = T3.DOC_ID)
			  LEFT OUTER JOIN ( 
                                    SELECT M.AUD_YR, M.AUD_NO, M.AUD_STEP_CD, M.DOC_ID, M.CFM_PEN_CFM_YN, M.SEQ
                                      FROM TBDCMACM018H M,
                                          (SELECT AUD_YR
                                                 , AUD_NO
                                                 , AUD_STEP_CD
                                                 , DOC_ID
                                                 , MAX(SEQ) AS SEQ
                                              FROM TBDCMACM018H
                                            WHERE CFM_PEN_CFM_YN = 'N'
                                            GROUP BY AUD_YR, AUD_NO, AUD_STEP_CD, DOC_ID
                                            ) SUB
                                      WHERE M.AUD_YR = SUB.AUD_YR 
                                        AND M.AUD_NO = SUB.AUD_NO 
                                        AND M.AUD_STEP_CD = SUB.AUD_STEP_CD 
                                        AND M.DOC_ID = SUB.DOC_ID 
                                        AND M.SEQ = SUB.SEQ) T4
                  ON(T4.AUD_YR = T2.ACP_YR AND T4.AUD_NO = TO_CHAR(T2.ACP_SRNO) AND T4.AUD_STEP_CD = T2.ACP_STEP_CD AND T4.DOC_ID = T2.DOC_ID)	   
			 WHERE 1=1
			 	/*섬란전,온나라 문서,처리기간 관리 제외*/
			 	AND T2.RPRT_CD NOT IN('D10100300','D10100001','D10100002','D10600100','D10600200','D10700100','D10700200','E10100300','E10100001','E10100002','E10700100','E10702100','E10800100','E10800200')
			 	AND T1.ACP_YR = #{schAudYr}
			]]>
			<if test="schCfmPenCfmYn != null and schCfmPenCfmYn != '' ">
				AND T4.CFM_PEN_CFM_YN = #{schCfmPenCfmYn}
			</if>
			<if test="acpDvsnCd != null and acpDvsnCd != '' "> 
			 	AND T1.ACP_DVSN_CD = #{acpDvsnCd}
			</if>
			<if test="schAudYrNoKndCd != null and schAudYrNoKndCd != '' "> 
			 	AND T2.ACP_KND_CD = #{schAudYrNoKndCd}
			</if>
			<if test="schAudGrnNo != null and schAudGrnNo != '' "> 
				AND (NVL(T1.ORG_ACP_SRNO,T1.ACP_SRNO) = #{schAudGrnNo})
 			</if>
 			<if test="schDeptCd != null and schDeptCd != '' "> 
				 AND T1.DPT_CD = #{schDeptCd}
			</if>
			<if test="schSpvBrdvCd != null and schSpvBrdvCd != '' "> 
				 AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = T1.DPT_CD) =#{schSpvBrdvCd}
			</if>
			<if test="hndlChgrNm != null and hndlChgrNm != '' "> 
				 AND T1.HNDL_CHGR_NM =#{hndlChgrNm}
			</if>
			<if test="schAudSbjNm != null and schAudSbjNm != '' "> 
				 AND T1.TIT_NM LIKE '%'||#{schAudSbjNm}||'%'
			</if>
			<if test="schApvStaCd != null and schApvStaCd != '' "> 
				 AND T2.APV_STA_CD = #{schApvStaCd}
			</if>
			<if test="schPrssStepCd != null and schPrssStepCd != ''  and schPrssStepCd neq  'A1095'.toString()">  
				 AND T2.ACP_STEP_CD = #{schPrssStepCd}
			</if>
			<if test="schRprtCd != null and schRprtCd != '' "> 
				 AND T2.RPRT_CD = #{schRprtCd}
			</if>
			<if test="schRprtNm != null and schRprtNm != '' "> 
				 AND T2.RPRT_NM LIKE '%'||#{schRprtNm}||'%'
			</if>
			<if test="acpHndlStaCd != null and acpHndlStaCd != '' "> 
				 AND T1.ACP_HNDL_STA_CD = #{acpHndlStaCd}
			</if>
			<if test="schEdtAuth != null and schEdtAuth != '' "> 
				 AND NVL(T2.EDT_AUTH,'N') = #{schEdtAuth}
			</if>
			<if test="schCurrApvr != null and schCurrApvr != '' ">
				<choose>
					<when test="schCurrApvr eq '1'.toString()">
						AND CURR_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
					</when>
					<when test="schCurrApvr eq '2'.toString()">
						AND CURR_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
					</when>
					<when test="schCurrApvr eq '3'.toString()">
						AND CURR_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
					</when>
					<when test="schCurrApvr eq '4'.toString()">
						AND CURR_APV.APVR_PST_CD = '0055700'						/*최종결재자가 총장 단계*/				
					</when>
					<when test="schCurrApvr eq '5'.toString()">
						AND CURR_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
					</when>
					<when test="schCurrApvr eq '6'.toString()">
						AND CURR_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
					</when>
				</choose>
			</if>
			<if test="schFnlApvr != null and schFnlApvr != '' ">
				<choose>
					<when test="schFnlApvr eq '1'.toString()">
						AND FNL_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
					</when>
					<when test="schFnlApvr eq '2'.toString()">
						AND FNL_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
					</when>
					<when test="schFnlApvr eq '3'.toString()">
						AND FNL_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
					</when>
					<when test="schFnlApvr eq '4'.toString()">
						AND FNL_APV.APVR_PST_CD = '0055700'							/*최종결재자가 총장 단계*/				
					</when>
					<when test="schFnlApvr eq '5'.toString()">
						AND FNL_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
					</when>
					<when test="schFnlApvr eq '6'.toString()">
						AND FNL_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
					</when>
				</choose>
			</if>
			ORDER BY T1.ACP_YR, T1.ACP_SRNO DESC,T2.ACP_KND_CD, T2.ACP_GRN_NO DESC, REGI_DH DESC, T2.ACP_STEP_CD, T2.RPRT_CD
			 
		<include refid="include.pageOrder" />
    </select>
    
   	<update id="saveModifyEdtAuth">
        /* kr.go.bai.eip.bad.fre.dao.BADFRE007EMapper.saveModifyEdtAuth */
       UPDATE TBBADFRE103M
       		SET EDT_AUTH =  #{edtAuth}
	        WHERE
	             ACP_YR = #{acpYr}
	        AND ACP_SRNO = #{acpSrno}
	        AND DOC_ID = #{docId}
    </update>
    
     <update id="deleteDocRqsId" parameterType="paramMap">
    /* kr.go.bai.eip.bad.fre.dao.BADFRE007EMapper.deleteDocRqsId*/
    DECLARE
         BEGIN
           UPDATE TBBADFRE103M
           SET APV_RQS_ID = ''
           WHERE
                ACP_YR = #{acpYr}
           AND ACP_DVSN_CD = #{acpDvsnCd}
           AND ACP_SRNO = #{acpSrno}
           AND APV_RQS_ID = #{apvRqsId}
            ;
            DELETE 
              FROM PTL_ORDER_NOTI
              WHERE seq in (SELECT SEQ
                          FROM PTL_ORDER_LIST
                         WHERE DOC_No  = #{apvRqsId}) 
            ;
            DELETE
              FROM PTL_ORDER_RECEIVE_LIST
             WHERE seq in (SELECT SEQ
                          FROM PTL_ORDER_LIST
                         WHERE DOC_No  = #{apvRqsId})
            ;
            DELETE
              from PTL_ORDER_LIST
             where seq in (SELECT SEQ
                          FROM PTL_ORDER_LIST
                         WHERE DOC_No  = #{apvRqsId})
            ;
            delete
              FROM TBBADFRE109M A
             WHERE A.APV_RQS_ID = #{apvRqsId}
            ;
            delete
              from TBDCMACM023H
             where apv_doc_no = #{apvRqsId}
           <if test="acpDvsnCd == 1"> 
             and apv_dvsn_cd = 'fieldAudit5'
           </if>
           <if test="acpDvsnCd == 2"> 
             and apv_dvsn_cd = 'fieldAudit6'
           </if>
             ; 
            delete
              from TBDCMACM022H
             where apv_doc_no = #{apvRqsId}
           <if test="acpDvsnCd == 1"> 
             and apv_dvsn_cd = 'fieldAudit5'
           </if>
           <if test="acpDvsnCd == 2"> 
             and apv_dvsn_cd = 'fieldAudit6'
           </if>
             ;
            delete
              from TBDCMACM023L
             where apv_doc_no = #{apvRqsId}
             ;
            delete
              from TBDCMACM022L
             where apv_doc_no = #{apvRqsId}
             ;
         END;
    </update>  
    	<select id="selectExcelExport" parameterType="paramMap" resultType="egovMap">
		<![CDATA[  
		/* kr.go.bai.eip.bad.fre.dao.BADFRE007EMapper.selectExcelExport*/
		SELECT ROWNUM
			  ,ACP_YR_NO 
		      ,TIT_NM
		      ,DPT_NM
		      ,ACP_STEP_NM
		      ,HNDL_CHGR_NM
		      ,RPRT_KND_NM
		      ,RPRT_NM
		      ,APV_STA_NM
		      ,DOC_WRT_NM
		      ,REGI_DH
		      ,CURR_APV_USR_NM
		      ,FNL_APV_USR_NM
		      ,EDT_AUTH_NM
		  FROM ( 
			SELECT T1.ACP_YR || '-' || DECODE(T1.ACP_DVSN_CD,'1','심사','2','재심','3','재심판정') || '-' || DECODE(T1.ORG_ACP_SRNO, null, T1.ACP_SRNO, T1.ORG_ACP_SRNO) AS ACP_YR_NO
				, TIT_NM	 
				, T1.ACP_HNDL_STA_CD /* 진행단계코드 */
			    , F_CODE_NM('1000807', T1.ACP_HNDL_STA_CD) AS ACP_STEP_NM	 /* 진행단계명 */	
				, (SELECT AGGR_CONCAT(DTIL_AUD_DOC_NM,',') AS CD_NM
					  FROM (SELECT AUD_DOC_CD
					            , DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1)) AS DTIL_AUD_DOC_NM
					          FROM TBFDMADM002M
			]]>
						<if test="acpDvsnCd == 1"> 
					        	WHERE SUBSTR(AUD_DOC_CD,0,1) = 'D'
					        	GROUP BY AUD_DOC_CD, DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1))
					        	UNION ALL SELECT 'D10400600' , '공개문' FROM DUAL
					        	UNION ALL SELECT 'D10100002' , '선람전 (과)' FROM DUAL
                          		UNION ALL SELECT 'D10100001' , '선람전 (국)' FROM DUAL
					   	</if> 
					    <if test="acpDvsnCd == 2"> 
					        	WHERE SUBSTR(AUD_DOC_CD,0,1) = 'E'
					        	GROUP BY AUD_DOC_CD, DECODE(INSTR(DTIL_AUD_DOC_NM,'('),0,DTIL_AUD_DOC_NM,SUBSTR(DTIL_AUD_DOC_NM,0,INSTR(DTIL_AUD_DOC_NM,'(')-1))
					        	UNION ALL SELECT 'E10600300' , '공개문' FROM DUAL
					        	UNION ALL SELECT 'E10100002' , '선람전 (과)' FROM DUAL
                          		UNION ALL SELECT 'E10100001' , '선람전 (국)' FROM DUAL
					   	</if> 
			<![CDATA[
					        )
					  WHERE AUD_DOC_CD = T2.RPRT_CD 
					 GROUP BY AUD_DOC_CD) AS RPRT_KND_NM
				, (CASE WHEN T1.MG_ACP_YR IS NULL THEN ''
                        WHEN T1.MG_DIV_CD = '10' THEN '병합(' || (SELECT COUNT(MG_ACP_YR)
                                                                   FROM TBBADFRE012M
                                                                  WHERE MG_ACP_YR = T1.MG_ACP_YR
                                                                    AND MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
                                                                    AND MG_ACP_SRNO = T1.MG_ACP_SRNO) || ')'
                        WHEN T1.MG_DIV_CD = '20' THEN '병행(' || (SELECT COUNT(MG_ACP_YR)
                                                                   FROM TBBADFRE012M
                                                                  WHERE MG_ACP_YR = T1.MG_ACP_YR
                                                                    AND MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
                                                                    AND MG_ACP_SRNO = T1.MG_ACP_SRNO) || ')'
                   ELSE '병합(' || (SELECT COUNT(T4.MG_ACP_YR)
                                      FROM TBBADFRE012M T4
                                     WHERE T4.MG_ACP_YR = T1.MG_ACP_YR
                                       AND T4.MG_ACP_DVSN_CD = T1.MG_ACP_DVSN_CD
                                       AND T4.MG_ACP_SRNO = T1.MG_ACP_SRNO
                                       AND T4.MG_DPT_CD = T1.MG_DPT_CD) || ')' END) AS MG_COUNT 
				, (SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD = T1.DPT_CD) AS DPT_NM
				, T1.HNDL_CHGR_NM	 
				, T2.RPRT_CD
				, T2.RPRT_NM
                , T2.RPRT_NM AS RPRT_REAL_NM
			    , F_CODE_NM('1000773', T2.APV_STA_CD) AS APV_STA_NM
			    , F_USR_INFO_BY_ID(DOC_WRT_ID,'2') AS DOC_WRT_NM
			    , TO_CHAR(T2.FRT_REGI_DH,'YYYY"-"MM"-"DD" "HH24:MI') AS REGI_DH 
			    , DECODE(NVL(EDT_AUTH,'N'),'N','편집불가','편집가능') AS EDT_AUTH_NM
                , NVL(EDT_AUTH,'N') AS EDT_AUTH
			    , T2.ACP_YR
			    , T2.ACP_SRNO
			    , T2.ACP_STEP_CD
			    , T2.DOC_ID
			    , T2.APV_STA_CD
			    , T2.APV_RQS_ID
			    , T2.ACP_DVSN_CD
			    , CURR_APV.APVR_NM AS CURR_APV_USR_NM
			    , FNL_APV.APVR_NM AS FNL_APV_USR_NM    
			  FROM TBBADFRE012M T1
			       INNER JOIN TBBADFRE103M T2
			       ON (T1.ACP_YR = T2.ACP_YR AND T1.ACP_SRNO = T2.ACP_SRNO AND T1.ACP_DVSN_CD = T2.ACP_DVSN_CD)
			 		 LEFT OUTER JOIN (
									SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
									     , DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
									  FROM TBDCMACM023L M
				]]>
								<if test="acpDvsnCd == 1"> 
									 WHERE M.APV_DVSN_CD = 'requestAudit5'
								</if>
								<if test="acpDvsnCd == 2"> 
									 WHERE M.APV_DVSN_CD = 'requestAudit6'
								</if>
				<![CDATA[ 
									   AND SUBSTR(M.APVR_STA_CD,1,1) = '1'
									   AND M.APVR_KND_CD <> '6'
									 GROUP BY M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD, M.APVR_CNB) CURR_APV
			 		ON (T2.APV_RQS_ID = CURR_APV.APV_DOC_NO)
					LEFT OUTER JOIN (
									SELECT M.APV_DOC_NO, M.APV_DVSN_CD, M.APVR_PST_CD
  										  ,DECODE(M.APVR_PST_CD, '','','(' || F_CODE_NM('1000176', M.APVR_PST_CD) || ')') || ' ' || F_USR_INFO(M.APVR_CNB,2) AS APVR_NM
									  FROM TBDCMACM023L M
									  	   ,(
											SELECT APV_DOC_NO, APV_DVSN_CD, MAX(APVR_SEQ) AS MAX_APVR_SEQ
											  FROM TBDCMACM023L
											 GROUP BY APV_DOC_NO, APV_DVSN_CD
											) SUB
					]]>
								<if test="acpDvsnCd == 1">
									 WHERE M.APV_DOC_NO = SUB.APV_DOC_NO
									   AND M.APV_DVSN_CD = SUB.APV_DVSN_CD
									   AND M.APVR_SEQ = SUB.MAX_APVR_SEQ
									   AND M.APV_DVSN_CD = 'requestAudit5' ) FNL_APV
								</if>
								<if test="acpDvsnCd == 2">
									 WHERE M.APV_DOC_NO = SUB.APV_DOC_NO
									   AND M.APV_DVSN_CD = SUB.APV_DVSN_CD
									   AND M.APVR_SEQ = SUB.MAX_APVR_SEQ
									   AND M.APV_DVSN_CD = 'requestAudit6' ) FNL_APV
								</if>
					<![CDATA[
			 	   ON (T2.APV_RQS_ID = FNL_APV.APV_DOC_NO)	 	   			
			 WHERE 1=1
			 	 AND T1.ACP_YR = #{schAudYr}
			]]>
			<if test="acpDvsnCd != null and acpDvsnCd != '' "> 
			 	AND T1.ACP_DVSN_CD = #{acpDvsnCd}
			</if>
			<if test="schAudYrNoKndCd != null and schAudYrNoKndCd != '' "> 
			 	AND T2.ACP_KND_CD = #{schAudYrNoKndCd}
			</if>
			<if test="schAudGrnNo != null and schAudGrnNo != '' "> 
 				AND T2.ACP_GRN_NO = #{schAudGrnNo}
 			</if>
 			<if test="schDeptCd != null and schDeptCd != '' "> 
				 AND T1.DPT_CD = #{schDeptCd}
			</if>
			<if test="schSpvBrdvCd != null and schSpvBrdvCd != '' "> 
				 AND (SELECT HIRK_DPT_CD FROM TBDCMACM002M WHERE DPT_CD = T1.DPT_CD) =#{schSpvBrdvCd}
			</if>
			<if test="hndlChgrNm != null and hndlChgrNm != '' "> 
				 AND T1.HNDL_CHGR_NM =#{hndlChgrNm}
			</if>
			<if test="schAudSbjNm != null and schAudSbjNm != '' "> 
				 AND T1.TIT_NM LIKE '%'||#{schAudSbjNm}||'%'
			</if>
			<if test="schApvStaCd != null and schApvStaCd != '' "> 
				 AND T2.APV_STA_CD = #{schApvStaCd}
			</if>
			<if test="schPrssStepCd != null and schPrssStepCd != ''  and schPrssStepCd neq  'A1095'.toString()">  
				 AND T2.ACP_STEP_CD = #{schPrssStepCd}
			</if>
			<if test="schRprtCd != null and schRprtCd != '' "> 
				 AND T2.RPRT_CD = #{schRprtCd}
			</if>
			<if test="schRprtNm != null and schRprtNm != '' "> 
				 AND T2.RPRT_NM LIKE '%'||#{schRprtNm}||'%'
			</if>
			<if test="acpHndlStaCd != null and acpHndlStaCd != '' "> 
				 AND T1.ACP_HNDL_STA_CD = #{acpHndlStaCd}
			</if>
			<if test="schEdtAuth != null and schEdtAuth != '' "> 
				 AND NVL(T2.EDT_AUTH,'N') = #{schEdtAuth}
			</if>
			<if test="schCurrApvr != null and schCurrApvr != '' ">
				<choose>
					<when test="schCurrApvr eq '1'.toString()">
						AND CURR_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
					</when>
					<when test="schCurrApvr eq '2'.toString()">
						AND CURR_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
					</when>
					<when test="schCurrApvr eq '3'.toString()">
						AND CURR_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
					</when>
					<when test="schCurrApvr eq '4'.toString()">
						AND CURR_APV.APVR_PST_CD = '0055700'						/*최종결재자가 총장 단계*/				
					</when>
					<when test="schCurrApvr eq '5'.toString()">
						AND CURR_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
					</when>
					<when test="schCurrApvr eq '6'.toString()">
						AND CURR_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
					</when>
				</choose>
			</if>
			<if test="schFnlApvr != null and schFnlApvr != '' ">
				<choose>
					<when test="schFnlApvr eq '1'.toString()">
						AND FNL_APV.APVR_PST_CD = '0013600'						/*최종결재자가 과장 단계*/				
					</when>
					<when test="schFnlApvr eq '2'.toString()">
						AND FNL_APV.APVR_PST_CD IN ('0015800','0035100','0058100')	/*최종결재자가 국장 단계*/				
					</when>
					<when test="schFnlApvr eq '3'.toString()">
						AND FNL_APV.APVR_PST_CD IN ('0055600','0045900')			/*최종결재자가 차장 단계*/				
					</when>
					<when test="schFnlApvr eq '4'.toString()">
						AND FNL_APV.APVR_PST_CD = '0055700'							/*최종결재자가 총장 단계*/				
					</when>
					<when test="schFnlApvr eq '5'.toString()">
						AND FNL_APV.APVR_PST_CD = '0010600'						/*최종결재자가 위원 단계*/				
					</when>
					<when test="schFnlApvr eq '6'.toString()">
						AND FNL_APV.APVR_PST_CD = '0067400'						/*최종결재자가 원장 단계*/				
					</when>
				</choose>
			</if>
			ORDER BY T1.ACP_YR, T1.ACP_SRNO DESC,T2.ACP_KND_CD, T2.ACP_GRN_NO DESC, T2.ACP_STEP_CD, T2.RPRT_CD
		  )
	</select>

</mapper> 