<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.bad.ded.dao.BADDED016PMapper">

	<!-- 출장여비 기본정보 조회 -->
    <select id="selectBassInfo" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.kr.go.bai.eip.bad.ded.dao.BADDED016PMapper.selectBassInfo*/
        <![CDATA[
            SELECT distinct 
                   D2.AUD_YR||'-'||D2.AUD_KND_CD||'-'||D2.AUD_NO                                      AS AUD_YR_KND_NO        /*감사년번호*/
                  , F_MNG_KND_AUDYRNO(D2.AUD_YR, D2.AUD_NO, D2.AUD_KND_CD, '-')||'('|| D1.AUD_STEP_SNO || ')'  AS AUD_YR_KND_NO_NM2   /*감사년번호*/
                 ,  F_MNG_KND_AUDYRNO(D2.AUD_YR, D2.AUD_NO, D2.AUD_KND_CD, '-')    AS AUD_YR_KND_NO_NM     /*감사년번호*/
                 , D2.AUD_YR                                                AS AUD_YR                /*감사년도*/
                 , D1.BZT_YR                                                AS BZT_YR                /*출장년도*/
                 , D2.AUD_NO                                                AS AUD_NO                /*감사순번*/
                 , D2.AUD_GRN_NO                                            AS AUD_GRN_NO            /*감사부여번호*/
                 , D2.AUD_KND_CD                                            AS AUD_KND_CD            /*감사종류*/
                 , F_CODE_NM('1000739', D2.AUD_KND_CD)          AS AUD_YR_KND_NM         /*감사종류*/
                 , D2.AUD_SBJ_NM                                            AS AUD_SBJ_NM            /*감사사항명*/
                 , F_DPT_INFO(D2.MNG_DPT_CD,'1')                            AS MNG_DPT_NM            /*관리부서명*/
                 , D2.AUD_KND_CD                                            AS AUD_KND_CD            /*감사종류코드*/
                 , F_CODE_NM('1000007',D2.AUD_KND_CD)                       AS AUD_KND_NM            /*감사종류명*/
                 , D1.AUD_BZT_KND_CD                                        AS AUD_BZT_KND_CD        /*감사출장종류코드*/
                 , F_CODE_NM('1000030',D1.AUD_BZT_KND_CD)                   AS AUD_BZT_KND_NM        /*감사출장종류코드명*/
                 , D1.TIT_TXT                                               AS TIT_TXT               /*제목*/
                 , TO_CHAR(TO_DATE(D1.AUD_STR_DT),'YYYY-MM-DD')             AS AUD_STR_DT            /*실시시작일*/
                 , TO_CHAR(TO_DATE(D1.AUD_END_DT),'YYYY-MM-DD')             AS AUD_END_DT            /*실시종료일*/
                 , (SELECT F_CODE_NM('1000173',PCT_RANK_CD) FROM TBBADDED005L WHERE BZT_YR = D1.BZT_YR AND BZT_SNO = D1.BZT_SNO AND PCT_CNB = #{pctCnb}) AS PCT_RANK_NM /*직급*/
              FROM TBBADDED002M AS D1
        INNER JOIN TBBADDED001M AS D2 ON D1.REL_AUD_YR = D2.AUD_YR AND D1.REL_AUD_NO = D2.AUD_NO
   LEFT OUTER JOIN (SELECT BZT_YR
                         , BZT_SNO
                         , SUM( CASE WHEN A.STF_DVSN_CD = '0' THEN 1 ELSE 0 END) AS IN_PSON_CNT  /*내부인원*/
                         , SUM( CASE WHEN A.STF_DVSN_CD = '0' THEN 0 ELSE 1 END) AS EXT_PSON_CNT /*외부인원*/
                     FROM (SELECT DISTINCT BZT_YR
                                , BZT_SNO
                                , PCT_CNB
                                , STF_DVSN_CD
                             FROM TBBADDED005L) AS A
                         GROUP BY BZT_YR, BZT_SNO
                          ) AS D3 ON D1.BZT_YR = D3.BZT_YR AND D1.BZT_SNO = D3.BZT_SNO
        INNER JOIN TBBADDED011L AS D4 ON D1.BZT_YR = D4.BZT_YR AND D1.BZT_SNO = D4.BZT_SNO AND D4.CALC_YN = 'Y' AND D4.PCT_CNB = #{pctCnb} 
             WHERE D1.BZT_YR = #{bztYr}
               AND D1.BZT_SNO = #{bztSno}
               AND D1.BZT_DVSN_CD = '1'
           
        ]]>
   
   </select>

	<!-- 출장여비 총금액 조회 -->
    <select id="selectTotamt" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.kr.go.bai.eip.bad.ded.dao.BADDED016PMapper.selectTotamt*/
        <![CDATA[
	      SELECT PCT_NM
	           , RANK_NM
	           , SUM(DT_EXS)             AS DT_EXS
	           , SUM(LDC)                AS LDC
	           , SUM(FDEX)               AS FDEX
	           , SUM(SPM_XPN)            AS SPM_XPN
	           , SUM(RL_CPRG_FR_EXS)     AS RL_CPRG_FR_EXS
	           , SUM(RL_FR_EXS)          AS RL_FR_EXS
	           , SUM(CPRG_FR_EXS)        AS CPRG_FR_EXS
	           , LEAD_EXS
	           , AUD_ACTV_RCV_EXS
	           , SUM(SUM_COST)           AS SUM_COST
	           , SUM(ALL_COST)+LEAD_EXS+AUD_ACTV_RCV_EXS           AS ALL_COST
	        FROM
	           (
	        	SELECT D1.PCT_NM                                           AS PCT_NM                 /*출장자명*/
	                 , F_CODE_NM('1000173', D1.PCT_RANK_CD)                AS RANK_NM                /*직급명*/
	                 , NVL(D3.DT_EXS,0)                                    AS DT_EXS                 /*일비*/
	                 , NVL(D3.LDC,0)                                       AS LDC                    /*숙박비*/
	                 , NVL(D3.FDEX,0)                                      AS FDEX                   /*식비*/
	                 , NVL(D3.SPM_XPN,0)                                   AS SPM_XPN                /*보충경비*/
	                 , NVL(D5.RL_FR_EXS,0)/2 + NVL(D3.CPRG_FR_EXS,0)         AS RL_CPRG_FR_EXS         /*철도운임비 + 수도권운임비 - 2015.05.11 yyh*/
	                 , NVL(D5.RL_FR_EXS,0)/2                                 AS RL_FR_EXS              /*철도운임비*/
	                 , NVL(D3.CPRG_FR_EXS,0)                               AS CPRG_FR_EXS            /*수도권운임비*/
	                 , CASE WHEN D2.BZT_TL_CNB = D1.PCT_CNB THEN NVL(D4.LEAD_EXS,0)
	                        ELSE 0 END                                     AS LEAD_EXS               /*지휘비*/
	                 , CASE WHEN D2.BZT_TL_CNB = D1.PCT_CNB THEN NVL(D4.AUD_ACTV_RCV_EXS,0)
	                        ELSE 0  END                                    AS AUD_ACTV_RCV_EXS       /*감사활동수용비*/
	                 , NVL(D3.SUM_COST,0)                                  AS SUM_COST               /*국내여비*/
	                 , NVL(D3.SUM_COST,0) + NVL(D5.RL_FR_EXS,0)/2 + NVL(D3.SPM_XPN,0) + NVL(D3.CPRG_FR_EXS,0) /* 수도권운임비 추가 */
	                   AS ALL_COST                    /*합계*/
	              FROM 
                   TBBADDED010L D1 /*출장수령자내역*/
                 , (
                     SELECT #{bztYr} AS BZT_YR
                          , #{bztSno} AS BZT_SNO
                          , F_LEAD_EXS_RCV_EXS_RCIT_CNB(#{bztYr},#{bztSno}) AS BZT_TL_CNB
                      FROM DUAL
                  ) D2 /*지휘비수령자를 확인하기 위함.*/
                , (
                    SELECT D1.BZT_YR
                         , D1.BZT_SNO
                         , D1.PCT_CNB
                         , D1.LODG_DCN
                         , D1.ORG_CD
                         , D1.RGN_CD
                         , TO_CHAR(TO_DATE(D1.BZT_STR_DT),'YYYY-MM-DD') AS BZT_STR_DT
                         , TO_CHAR(TO_DATE(D1.BZT_END_DT),'YYYY-MM-DD') AS BZT_END_DT
                         , SUM(NVL(D1.DT_EXS,0))      AS DT_EXS       /*일비*/
                         , SUM(NVL(D1.LDC,0))         AS LDC          /*숙박비*/
                         , SUM(NVL(D1.FDEX,0))        AS FDEX         /*식비*/
                         , SUM(NVL(D1.DT_EXS,0)) + SUM(NVL(D1.LDC,0)) + SUM(NVL(D1.FDEX,0)) AS SUM_COST /*합계*/
                         , SUM(NVL(D1.SPM_XPN,0))     AS SPM_XPN      /*보충경비*/
                         , SUM(NVL(D1.BZT_DCN,0))     AS BZT_DCN      /*출장일수*/
                         , SUM(NVL(D1.CPRG_FR_EXS,0)) AS CPRG_FR_EXS  /*수도권운임비*/
                      FROM 
                           TBBADDED011L D1
                     WHERE 
                           BZT_YR = #{bztYr}
                       AND BZT_SNO = #{bztSno}
                       AND CALC_YN = 'N'
                  GROUP BY 
                           BZT_YR
                         , BZT_SNO
                         , PCT_CNB 
                         , LODG_DCN
                         , ORG_CD
                         , RGN_CD    
                         , BZT_STR_DT
                         , BZT_END_DT                    
                  ) D3  /*일반경비*/
                , (
                    SELECT D1.BZT_YR
                         , D1.BZT_SNO
                         , SUM(NVL(D1.LEAD_EXS,0))         AS LEAD_EXS          /*지휘비*/
                         , SUM(NVL(D1.AUD_ACTV_RCV_EXS,0)) AS AUD_ACTV_RCV_EXS  /*감사활동수용비*/
                      FROM 
                           TBBADDED011L D1
                     WHERE 
                           D1.BZT_YR  = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                       AND D1.CALC_YN = 'N'
                  GROUP BY 
                           D1.BZT_YR
                         , D1.BZT_SNO
                  ) D4 /*지휘비, 감사활동비*/
                , (
                    SELECT D1.BZT_YR
                         , D1.BZT_SNO
                         , D1.PCT_CNB
                         , SUM(NVL(D1.RL_FR_EXS,0)) AS RL_FR_EXS
                      FROM 
                           TBBADDED017L D1
                     WHERE 
                           1=1
                       AND D1.BZT_YR = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                       AND D1.CALC_YN = 'N'
                  GROUP BY 
                           D1.BZT_YR
                         , D1.BZT_SNO
                         , D1.PCT_CNB
                  ) D5 /*철도운임비*/
                , (
                    SELECT BZT_YR
                         , BZT_SNO
                         , PCT_CNB
                         , MAX(AJT_DGE) AS AJT_DGE
                      FROM 
                           TBBADDED019H
                  GROUP BY 
                           BZT_YR
                         , BZT_SNO
                         , PCT_CNB 
                  ) D6    
                , (
                    SELECT DISTINCT BZT_YR ,BZT_SNO, PCT_CNB
                      FROM (
                             SELECT BZT_YR
                                  , BZT_SNO 
                                  , BZT_TL_CNB AS PCT_CNB
                               FROM 
                                    TBBADDED002M
                              WHERE 
                                    1=1
                                AND BZT_YR  = #{bztYr}
                                AND BZT_SNO = #{bztSno}
                          UNION ALL
                             SELECT BZT_YR
                                  , BZT_SNO 
                                  , PCT_CNB 
                               FROM 
                                    TBBADDED005L
                              WHERE 
                                    BZT_YR  = #{bztYr}
                                AND BZT_SNO = #{bztSno}
                           )
                  ) D7
             
              WHERE D1.BZT_YR  = D2.BZT_YR
                AND D1.BZT_SNO = D2.BZT_SNO
                AND D1.BZT_YR  = D3.BZT_YR(+)
                AND D1.BZT_SNO = D3.BZT_SNO(+)
                AND D1.PCT_CNB = D3.PCT_CNB(+)
                AND D1.BZT_YR  = D4.BZT_YR(+)
                AND D1.BZT_SNO = D4.BZT_SNO(+)
                AND D1.BZT_YR  = D5.BZT_YR(+)
                AND D1.BZT_SNO = D5.BZT_SNO(+)
                AND D1.PCT_CNB = D5.PCT_CNB(+)
                AND D1.BZT_YR  = D6.BZT_YR(+)
                AND D1.BZT_SNO = D6.BZT_SNO(+)
                AND D1.PCT_CNB = D6.PCT_CNB(+)
                AND D1.BZT_YR  = D7.BZT_YR(+)
                AND D1.BZT_SNO = D7.BZT_SNO(+)
                AND D1.PCT_CNB = D7.PCT_CNB(+)
                AND D1.BZT_YR  = #{bztYr}
                AND D1.BZT_SNO = #{bztSno}
                AND D1.PCT_CNB = #{pctCnb}
           
           ORDER BY D1.PCT_CNB
           
           )
           
     GROUP BY PCT_NM, RANK_NM, LEAD_EXS, AUD_ACTV_RCV_EXS
           
        ]]>
   
    </select>
   
   	<!-- 예외일자 조회 -->
    <select id="selectExDt" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.kr.go.bai.eip.bad.ded.dao.BADDED016PMapper.selectExDt*/
        <![CDATA[
        	SELECT TO_CHAR(TO_DATE(BZT_EX_STR_DT),'yyyyMMdd') AS BZT_EX_STR_DT /* 예외시작일자 */
                 , TO_CHAR(TO_DATE(BZT_EX_END_DT),'yyyyMMdd') AS BZT_EX_END_DT /* 예외종료일자 */   
                 , F_CODE_NM('1000833', BZT_EX_KND_CD)        AS BZT_EX_KND_NM /* 예외명 */
              FROM 
                   TBBADDED032L        
             WHERE 
                   BZT_YR  = #{bztYr}
               AND BZT_SNO = #{bztSno}
               AND PCT_CNB = #{pctCnb}
           
        ]]>
   
    </select>
    
    <!-- 교통비정보 조회 -->
    <select id="selectTraffic" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.kr.go.bai.eip.bad.ded.dao.BADDED016PMapper.selectTraffic*/
            <![CDATA[
            SELECT D1.PCT_CNB                                AS PCT_CNB                  /*출장자전산번호*/
                 , D1.BZT_EXS_SNO                            AS BZT_EXS_SNO              /*출장비순번*/
                 , D1.CALC_YN                                AS CALC_YN                  /*계산여부*/
                 , D1.RL_SCO_SNO                             AS RL_SCO_SNO               /*철도구간순번*/
                 , D1.BZT_SNO                                AS BZT_SNO                  /*출장순번*/
                 , D1.BZT_YR                                 AS BZT_YR                   /*출장년도*/
                 , TO_CHAR(TO_DATE(D1.RID_DT),'YYYY-MM-DD')  AS RID_DT                   /*승차일*/
                 , D1.TRIN_KND_CD                            AS TRIN_KND_CD              /*열차종류코드*/
                 , F_CODE_NM('1000025',D1.TRIN_KND_CD)       AS TRAIN_TYPE_NM            /*열차종류명*/
                 , D1.CHRG_DVSN_CD                           AS CHRG_DVSN_CD             /*요금구분코드*/
                 , F_CODE_NM('1000026',D1.CHRG_DVSN_CD)      AS CHRG_DVSN_NM             /*요금구분명*/
                 , D1.DEP_STN_NM                             AS DEP_STN_NM               /*출발역명*/
                 , D1.ARV_STN_NM                             AS ARV_STN_NM               /*도착역명*/
                 , D1.FNL_YN                                 AS FNL_YN                   /*최종여부*/
                 , D1.RL_FR_EXS                              AS RL_FR_EXS                /*철도운임비*/
                 , D1.STND_CHRG_YN                           AS STND_CHRG_YN             /*표준요금여부*/
                 , D2.ORG_CD                                 AS ORG_CD
                 , F_ORG_INFO(D2.ORG_CD,'1')                 AS ORG_NM
                 , D2.RGN_CD                                 AS RGN_CD                   /*지역코드*/
                 , F_ORG_INFO(D2.ORG_CD,'1')||'('||
                 F_CODE_NM('1000001',D2.RGN_CD)||')'         AS RGN_NM                   /*지역명*/
              FROM TBBADDED017L AS D1
        INNER JOIN TBBADDED011L AS D2 ON D1.BZT_YR = D2.BZT_YR AND D1.BZT_SNO = D2.BZT_SNO AND D1.PCT_CNB = D2.PCT_CNB AND D1.BZT_EXS_SNO = D2.BZT_EXS_SNO AND D1.CALC_YN = D2.CALC_YN
             WHERE 1=1
               AND D1.BZT_YR        = #{bztYr}
               AND D1.BZT_SNO       = #{bztSno}
               AND D1.PCT_CNB       = #{pctCnb}
          ORDER BY D1.RID_DT, D1.RL_SCO_SNO
            ]]>
    </select> 
    
    <!-- 출장여비 변경 전후 차액 조회 -->
    <select id="selectDffnnt" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.kr.go.bai.eip.bad.ded.dao.BADDED016PMapper.selectDffnnt*/
        <![CDATA[
        SELECT BZT_YR
             , BZT_SNO
             , PCT_CNB
             , PCT_NM
             , RANK_NM AS POS_CLASS_NM
             , BLT_BRDV_NM AS BLT_BRDV_NM
             , FDEX
             , DT_EXS
             , LDC
             , CPRG_FR_EXS
             , NVL(FDEX, 0) + NVL(DT_EXS, 0) + NVL(LDC, 0) AS IN_EXP
             , SPM_XPN
             , BZT_DCN
             , RL_FR_EXS
             , LEAD_EXS
             , AUD_ACTV_RCV_EXS
             , ALL_COST AS SUM_ALL
             , '' AS SORTER
             , NVL(FDEX, 0) + NVL(DT_EXS, 0)                                   AS IN_EXP_1     /* 식비 + 일비 추가 - 2018.01.17 yyh */
             , NVL(FDEX, 0) + NVL(DT_EXS, 0) + NVL(LDC, 0) + NVL(RL_FR_EXS, 0) AS IN_EXP_SUM   /* 숙박비 + 식비 + 일비 + 교통비 추가 - 2018.01.19 yyh */
            FROM (
            SELECT D1.BZT_YR                                      AS BZT_YR
                 , D1.BZT_SNO                                     AS BZT_SNO
                 , D1.PCT_CNB                                     AS PCT_CNB
                 , D1.PCT_NM                                      AS PCT_NM
                 , D1.RANK_NM                                     AS RANK_NM
                 , F_DPT_INFO(D1.BLT_BRDV_CD, '4')                AS BLT_BRDV_NM
                 , NVL(D1.DT_EXS,0) - NVL(D2.DT_EXS,0)            AS DT_EXS           /*일비*/
                 , NVL(D1.LDC,0) - NVL(D2.LDC,0)                  AS LDC              /*숙박비*/              
                 , NVL(D1.FDEX,0) - NVL(D2.FDEX,0)                AS FDEX             /*식비*/
                 , NVL(D1.CPRG_FR_EXS,0) - NVL(D2.CPRG_FR_EXS,0)  AS CPRG_FR_EXS      /*수도권운임 - 2015.05.06 yyh*/                 
                 , NVL(D1.SPM_XPN,0) - NVL(D2.SPM_XPN,0)          AS SPM_XPN          /*보충경비*/
                 , NVL(D1.BZT_DCN,0) - NVL(D2.BZT_DCN,0)          AS BZT_DCN          /*출장일수*/
                 , NVL(D1.RL_FR_EXS,0) - NVL(D2.RL_FR_EXS,0)      AS RL_FR_EXS        /*철도운임비*/
                 , NVL(D1.LEAD_EXS,0) - NVL(D2.LEAD_EXS,0)        AS LEAD_EXS         /*지휘비*/
                 , NVL(D1.AUD_ACTV_RCV_EXS,0) - NVL(D2.AUD_ACTV_RCV_EXS,0) AS AUD_ACTV_RCV_EXS   /*감사활동수용비*/
                 , NVL(D1.SUM_COST,0) - NVL(D2.SUM_COST,0)        AS SUM_COST         /*국내여비*/
                 , NVL(D1.ALL_COST,0) - NVL(D2.ALL_COST,0)        AS ALL_COST         /*합계*/
                 , ''                                             AS AJT_YN           /*정산완료처리에 flag로 사용*/
                 , D1.MAX_SNO                                     AS MAX_SNO          /*이력변경번호*/
                 , D1.AJT_CHG_RSN                                 AS AJT_CHG_RSN      /*정산사유*/
              FROM (
                    SELECT D2.*
                         , MAX_SNO
                         , AJT_CHG_RSN 
                      FROM (
                                SELECT BZT_YR
                                     , BZT_SNO
                                     , PCT_CNB
                                     , MAX(BZT_AJT_SNO) MAX_SNO
                                     , MAX(AJT_CHG_RSN) AJT_CHG_RSN
                                  FROM TBBADDED019H
                                 WHERE BZT_YR  = #{bztYr}
                                   AND BZT_SNO = #{bztSno}
                                   AND PCT_CNB = #{pctCnb}
                                   AND NVL(AJT_YN,'N') = 'N'
                                 GROUP BY BZT_YR , BZT_SNO , PCT_CNB  
                          ) D1
                        , VADED001 D2
                     WHERE 1=1
                       AND D1.BZT_YR  = D2.BZT_YR
                       AND D1.BZT_SNO = D2.BZT_SNO
                       AND D1.PCT_CNB = D2.PCT_CNB
                       AND D1.MAX_SNO = D2.BZT_AJT_SNO 
                       AND D1.BZT_YR  = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                       AND D1.PCT_CNB = #{pctCnb}
                  ) D1
                , (
                    SELECT D2.* 
                      FROM (
                                SELECT BZT_YR
                                     , BZT_SNO
                                     , PCT_CNB
                                     , MAX(BZT_AJT_SNO) MAX_SNO
                                  FROM TBBADDED019H
                                 WHERE BZT_YR  = #{bztYr}
                                   AND BZT_SNO = #{bztSno}
                                   AND PCT_CNB = #{pctCnb}
                                   AND NVL(AJT_YN,'N') = 'Y'
                                 GROUP BY BZT_YR , BZT_SNO , PCT_CNB  
                          ) D1
                        , VADED001 D2
                     WHERE 1=1
                       AND D1.BZT_YR  = D2.BZT_YR
                       AND D1.BZT_SNO = D2.BZT_SNO
                       AND D1.PCT_CNB = D2.PCT_CNB
                       AND D1.MAX_SNO = D2.BZT_AJT_SNO 
                       AND D1.BZT_YR  = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                       AND D1.PCT_CNB = #{pctCnb}
                  ) D2
            WHERE 1=1
              AND D1.BZT_YR  = D2.BZT_YR(+)
              AND D1.BZT_SNO = D2.BZT_SNO(+)
              AND D1.PCT_CNB = D2.PCT_CNB(+)
            )     
            WHERE 1=1
                AND DT_EXS <>0 OR LDC<>0 OR FDEX<>0 OR SPM_XPN<>0 OR BZT_DCN<>0 OR RL_FR_EXS<>0 OR LEAD_EXS<>0 OR AUD_ACTV_RCV_EXS<>0 OR SUM_COST<>0 OR ALL_COST<>0
                    OR CPRG_FR_EXS <> 0
               ORDER BY PCT_CNB 
        ]]>
    </select> 
    
   	<!-- 출장여비 수정 후 조회 -->
    <select id="selectAfTrexp" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.kr.go.bai.eip.bad.ded.dao.BADDED016PMapper.selectAfTrexp*/
            <![CDATA[
                SELECT D1.BZT_YR                        AS BZT_YR                 /*출장년도*/
                 , D1.BZT_SNO                           AS BZT_SNO                /*출장순번*/
                 , D1.PCT_CNB                           AS PCT_CNB                /*출장자전산번호*/
                 , D1.PCT_NM                            AS PCT_NM                 /*출장자명*/
                 , D1.PCT_NM||'('||D1.PCT_CNB||')'      AS PCT_NM_DISP            /*출장자명*/
                 , D1.PCT_RANK_CD                       AS PCT_RANK_CD            /*직급코드*/
                 , F_CODE_NM('1000173', D1.PCT_RANK_CD) AS RANK_NM                /*직급명*/
                 , D1.STF_DVSN_CD                       AS STF_DVSN_CD            /*직원구분코드*/
                 , D1.DEP_RGN_CD                        AS DEP_RGN_CD             /*출발지역코드*/
                 , D1.BLT_BRDV_CD                       AS BLT_BRDV_CD            /*소속국과코드*/
                 , F_DPT_INFO(D1.BLT_BRDV_CD,'1')       AS BLT_BRDV_NM            /*소속국과명*/
                 , D1.BNK_CD                            AS BNK_CD                 /*은행코드*/
                 , D1.EAN                               AS EAN                    /*계좌번호*/
                 , D1.LEAD_EXS_RCV_EXS_RCIT_PEN_YN      AS LEAD_EXS_RCV_EXS_RCIT_PEN_YN    /*지휘비및 수용비수령자여부*/
                 , NVL(D3.DT_EXS,0)                            AS DT_EXS                 /*일비*/
                 , NVL(D3.LDC,0)                               AS LDC                    /*숙박비*/
                 , NVL(D3.FDEX,0)                              AS FDEX                   /*식비*/
                 , NVL(D3.SPM_XPN,0)                           AS SPM_XPN                /*보충경비*/
                 , NVL(D3.BZT_DCN,0)                           AS BZT_DCN                /*출장일수*/
                 , NVL(D5.RL_FR_EXS,0) + NVL(D3.CPRG_FR_EXS,0) AS RL_FR_EXS       /*철도운임비 + 수도권운임비 - 2015.05.11 yyh*/
                 , CASE WHEN D2.BZT_TL_CNB = D1.PCT_CNB 
                        THEN D4.LEAD_EXS ELSE 0 
                    END                                 AS LEAD_EXS               /*지휘비*/
                 , CASE WHEN D2.BZT_TL_CNB = D1.PCT_CNB 
                          THEN D4.AUD_ACTV_RCV_EXS ELSE 0 
                      END                               AS AUD_ACTV_RCV_EXS       /*감사활동수용비*/
                 , NVL(D3.SUM_COST,0)                          AS SUM_COST               /*국내여비*/
                 , NVL(D3.SUM_COST,0) + NVL(D5.RL_FR_EXS,0) + NVL(D3.SPM_XPN,0) + NVL(D3.CPRG_FR_EXS,0) /* 수도권운임비 추가 */
                   + CASE WHEN D2.BZT_TL_CNB = D1.PCT_CNB THEN NVL(D4.AUD_ACTV_RCV_EXS,0)
                   + NVL(D4.LEAD_EXS,0) ELSE 0 END AS ALL_COST                 /*합계*/
                   , D1.PCT_OCP_CD
                   , D1.EXTL_ORG_CD
                   , D1.EXTL_ORG_NM
                   , CASE WHEN D6.AJT_DGE IS NOT NULL THEN D6.AJT_DGE||'차' ELSE '' END  AS AJT_DGE
                   , CASE WHEN D7.PCT_CNB IS NULL THEN 'Y' ELSE 'N' END AS DEL_YN    /*수정가능여부*/
              FROM TBBADDED010L D1 /*출장수령자내역*/
                 , (
                    SELECT #{bztYr} AS BZT_YR
                         , #{bztSno} AS BZT_SNO
                         , F_LEAD_EXS_RCV_EXS_RCIT_CNB(#{bztYr},#{bztSno}) AS BZT_TL_CNB
                      FROM DUAL
                  ) D2 /*지휘비수령자를 확인하기 위함.*/
                , (
                    SELECT D1.BZT_YR
                         , D1.BZT_SNO
                         , D1.PCT_CNB
                         , SUM(NVL(D1.DT_EXS,0))      AS DT_EXS       /*일비*/
                         , SUM(NVL(D1.LDC,0))         AS LDC          /*숙박비*/
                         , SUM(NVL(D1.FDEX,0))        AS FDEX         /*식비*/
                         , SUM(NVL(D1.DT_EXS,0)) + SUM(NVL(D1.LDC,0)) + SUM(NVL(D1.FDEX,0)) AS SUM_COST /*합계*/
                         , SUM(NVL(D1.SPM_XPN,0))     AS SPM_XPN      /*보충경비*/
                         , SUM(NVL(D1.BZT_DCN,0))     AS BZT_DCN      /*출장일수*/
                         , SUM(NVL(D1.CPRG_FR_EXS,0)) AS CPRG_FR_EXS  /*수도권운임비*/
                      FROM TBBADDED011L D1
                     WHERE BZT_YR = #{bztYr}
                       AND BZT_SNO = #{bztSno}
                       AND CALC_YN = 'Y'
                    GROUP BY BZT_YR
                           , BZT_SNO
                           , PCT_CNB 
                  ) D3  /*일반경비*/
                , (
                     SELECT D1.BZT_YR
                         , D1.BZT_SNO
                         , SUM(NVL(D1.LEAD_EXS,0))           AS LEAD_EXS             /*지휘비*/
                         , SUM(NVL(D1.AUD_ACTV_RCV_EXS,0))     AS AUD_ACTV_RCV_EXS  /*감사활동수용비*/
                      FROM TBBADDED011L D1
                     WHERE D1.BZT_YR = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                       AND D1.CALC_YN = 'Y'
                    GROUP BY D1.BZT_YR
                           , D1.BZT_SNO
                  ) D4 /*지휘비, 감사활동비*/
                , (
                    SELECT D1.BZT_YR
                         , D1.BZT_SNO
                         , D1.PCT_CNB
                         , SUM(NVL(D1.RL_FR_EXS,0)) AS RL_FR_EXS
                      FROM TBBADDED017L D1
                     WHERE 1=1
                       AND D1.BZT_YR = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                       AND D1.CALC_YN = 'Y'
                    GROUP BY D1.BZT_YR
                           , D1.BZT_SNO
                           , D1.PCT_CNB
                  ) D5 /*철도운임비*/
                 , (
                     SELECT BZT_YR
                          , BZT_SNO
                          , PCT_CNB
                          , MAX(AJT_DGE) AS AJT_DGE
                       FROM TBBADDED019H
                      GROUP BY BZT_YR
                             , BZT_SNO
                             , PCT_CNB 
                  ) D6    
                 , (
                     SELECT DISTINCT BZT_YR ,BZT_SNO, PCT_CNB
                         FROM (
                               SELECT BZT_YR
                                    , BZT_SNO 
                                    , BZT_TL_CNB AS PCT_CNB
                                 FROM TBBADDED002M
                                WHERE 1=1
                                  AND BZT_YR  = #{bztYr}
                                  AND BZT_SNO = #{bztSno}
                                UNION ALL
                                SELECT BZT_YR
                                     , BZT_SNO 
                                     , PCT_CNB 
                                  FROM TBBADDED005L
                                 WHERE BZT_YR  = #{bztYr}
                                   AND BZT_SNO = #{bztSno}
                              )
                  ) D7
             WHERE D1.BZT_YR  = D2.BZT_YR
               AND D1.BZT_SNO = D2.BZT_SNO
               AND D1.BZT_YR  = D3.BZT_YR(+)
               AND D1.BZT_SNO = D3.BZT_SNO(+)
               AND D1.PCT_CNB = D3.PCT_CNB(+)
               AND D1.BZT_YR  = D4.BZT_YR(+)
               AND D1.BZT_SNO = D4.BZT_SNO(+)
               AND D1.BZT_YR  = D5.BZT_YR(+)
               AND D1.BZT_SNO = D5.BZT_SNO(+)
               AND D1.PCT_CNB = D5.PCT_CNB(+)
               AND D1.BZT_YR  = D6.BZT_YR(+)
               AND D1.BZT_SNO = D6.BZT_SNO(+)
               AND D1.PCT_CNB = D6.PCT_CNB(+)
               AND D1.BZT_YR  = D7.BZT_YR(+)
               AND D1.BZT_SNO = D7.BZT_SNO(+)
               AND D1.PCT_CNB = D7.PCT_CNB(+)
               AND D1.BZT_YR  = #{bztYr}
               AND D1.BZT_SNO = #{bztSno}
               AND D1.PCT_CNB = #{pctCnb}
          ORDER BY D1.PCT_CNB
            ]]>
   
    </select>              
    

</mapper> 