<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.bad.ded.dao.BADDED007PMapper">
    
    <select id="selectList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED007PMapper.selectList*/
        <include refid="include.pageSelct" />
        <![CDATA[
            SELECT M.BZT_YR
                 , M.BZT_SNO
                 , M.PCT_CNB PCT_CNB
                 , M.PCT_RANK_CD
                 , M.PCT_NM
                 , NVL(A.DT_EXS_STAD_AM, (SELECT BZT_STAD_AM FROM TBBADDED180B B1
                                                       INNER JOIN TBBADDED018B B2 ON B1.BZT_SRNO = B2.BZT_SRNO
                                           WHERE B2.RGN_DVSN_CD  = '0'
                                             AND B2.RANK_DVSN_CD = '00'
                                             AND B2.TREXP_CLU_CD = '02'
                                             AND B1.BZT_DVSN_CD  = #{bztDvsnCd}
                                             AND B1.STAD_STR_DT <= REPLACE(#{audStrDt},'-','') 
                                             AND B1.STAD_END_DT >= REPLACE(#{audStrDt},'-',''))) DT_EXS_STAD_AM
              FROM (SELECT BZT_YR
                         , BZT_SNO
                         , PCT_CNB
                         , MAX(PCT_NM) PCT_NM
                         , MAX(PCT_RANK_CD) PCT_RANK_CD
                      FROM TBBADDED005L
                     WHERE BZT_YR = #{bztYr}
                       AND BZT_SNO = #{bztSno}
                       AND STF_DVSN_CD = '3' /*전문가코드*/
                     GROUP BY BZT_YR, BZT_SNO, PCT_CNB) AS M
    LEFT OUTER JOIN TBBADDED007B AS A ON M.BZT_YR = A.BZT_YR AND M.BZT_SNO = A.BZT_SNO AND M.PCT_CNB = A.PCT_CNB
    ]]>
    <include refid="include.pageOrder" />
    </select>
    
    <update id="updateBADDED007B" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED007PMapper.updateBADDED007B*/
        MERGE INTO TBBADDED007B
            USING DUAL
               ON (     
                        BZT_YR  = #{bztYr}
                    AND BZT_SNO = #{bztSno}
                    AND PCT_CNB = #{pctCnb}
                  ) 
             WHEN MATCHED THEN 
                UPDATE 
                   SET DT_EXS_STAD_AM     = #{dtExsStadAm}
                     , FNL_USR_ID       = #{usrId}
                     , FNL_DEAL_DPT_CD  = #{dptCd}
                     , FNL_MNU_ID       = #{menuNo}
                     , FNL_MDF_DH       = SYSDATE
             WHEN NOT MATCHED THEN   
                INSERT( 
                       BZT_YR
                     , BZT_SNO
                     , PCT_CNB
                     , DT_EXS_STAD_AM
                     , FRT_USR_ID
                     , FNL_USR_ID
                     , FNL_DEAL_DPT_CD
                     , FNL_MNU_ID
                     , FRT_REGI_DH
                     , FNL_MDF_DH )
                VALUES( 
                       #{bztYr}
                     , #{bztSno}
                     , #{pctCnb}
                     , #{dtExsStadAm}
                     , #{usrId}
                     , #{usrId}
                     , #{dptCd}
                     , #{menuNo}
                     , SYSDATE
                     , SYSDATE
                ) 
    </update>
    
</mapper> 