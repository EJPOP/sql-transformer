<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--   -->
<mapper namespace="kr.go.bai.eip.bad.fre.dao.BADFRE511Mapper">

	<select id="BADFRE511QMainselect" parameterType="paramMap" resultType="egovMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE511Mapper.BADFRE511QMainselect */
		<include refid="include.pageSelct" />
		<![CDATA[
		SELECT 
	        A.AUD_YR			/*감사년도*/
	        , A.AUD_NO		/*감사번호*/
	        , A.AUD_GRN_NO
	        , A.AUD_KND_CD	/*감사종류코드*/
	        , A.DSP_RQ_SNO	/*처분요구순번*/
	        , A.ACP_CNT
            , A.ACP_NO
            , A.ACP_NO AS ACP_NO_HID
	        , A.DSP_RQ_SNO_NM		/*처분요구번호*/
	        , A.ENF_DT			/*시행일*/
	        , A.ENF_BRDV_CD		/*시행국과코드*/
	        , A.ENF_BRDV_NM		/*시행국과명*/
	        , A.AUD_ORG_CNT		/*관련기관명*/
	        , A.TIT_TXT			/*제목내용*/
	        , A.DTM_STA_CD		/*이행상태*/
	        , A.DTM_STA_NM		/*이행상태*/
	        , A.BAI_DSP_DIV_CD	/*원처분과코드 */
	        , A.BAI_DSP_DIV_NM	/*원처분과코드 */
	        , A.DPT_CD			/*발신부서(의견요청부서)*/
        	, A.DPT_NM
        	, A.ORG_DSP_KWA_OPIN_SRCH_STEP_CD
            , CASE WHEN A.ORG_DSP_KWA_OPIN_SRCH_STEP_CD > 1 THEN '접수' ELSE '' END AS ORG_DSP_KWA_OPIN_SRCH_STEP_NM
	        , A.ORG_DSP_KWA_OPIN_SRCH_DT	/* 발신일 */
	        , A.ORG_DSP_KWA_OPIN_RCPT_DT	/* 수신일 */
	        , A.ACP_YR
            , A.ACP_DVSN_CD
            , A.ACP_SRNO
            , A.TIT_NM                    /*청구내용*/
            , A.MG_ACP_YR
            , A.MG_ACP_DVSN_CD
            , A.MG_ACP_SRNO
            , A.MG_DIV_CD
            , (CASE WHEN A.ORG_DSP_KWA_OPIN_RCPT_DT IS NOT NULL AND A.APV_STA_CD IS NULL THEN '결재완료' 
                    WHEN A.ORG_DSP_KWA_OPIN_RCPT_DT IS NULL AND A.APV_STA_CD IS NULL THEN '미작성'
                    ELSE F_CODE_NM('1000773',A.APV_STA_CD) END) AS DOC_YN
            , A.APV_STA_CD
            , (CASE WHEN A.SND_DOC_CNT > 0 AND A.ORG_DSP_KWA_OPIN_RCPT_DT IS NULL THEN 'Y' 
                    WHEN A.SND_DOC_CNT > 1 THEN 'Y' 
                    ELSE 'N' END) AS RE_OPIN_YN
            , A.SND_DOC_CNT
            , A.DOC_TYPE
            , TO_CHAR(TO_DATE(A.ORG_DSP_KWA_OPIN_DDLN_DT),'YYYY-MM-DD') AS ORG_DSP_KWA_OPIN_DDLN_DT --처리기한
	    FROM (
	        SELECT  
	             T1.AUD_YR
	             , T1.AUD_NO
	             , T1.AUD_GRN_NO
	             , T1.AUD_KND_CD
	             , D1.DSP_RQ_SNO
	             , A.ACP_YR || '-' || DECODE(A.ACP_DVSN_CD, '1', '심사', '2', '재심', '3', '재심판정') || '-' || DECODE(A.ORG_ACP_SRNO, null, A.ACP_SRNO, A.ORG_ACP_SRNO) AS ACP_NO
                 , F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || D1.DSP_RQ_SNO AS DSP_RQ_SNO_NM /*처분요구순번DISP*/
	             , to_char(to_date(D2.ENF_DT), 'YYYY-MM-DD') AS ENF_DT /*시행일*/
	             , D2.ENF_BRDV_CD AS ENF_BRDV_CD /*시행국과코드*/
	             , (SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD = D2.ENF_BRDV_CD) AS ENF_BRDV_NM /*시행국과명*/
	             , (SELECT F_ORG_CNT_NM_AUD(D1.AUD_YR,D1.AUD_NO,'AUD') FROM DUAL ) AS AUD_ORG_CNT /*기관명*/
	             , D1.TIT_TXT AS TIT_TXT /*제목내용*/
	             , D2.DTM_STA_CD
	             , F_CODE_NM('1000017',D2.DTM_STA_CD ) AS DTM_STA_NM /*결재상태명*/
	             , A.BAI_DSP_DIV_CD AS BAI_DSP_DIV_CD /* 원처분과코드 */
	             , (SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD = A.BAI_DSP_DIV_CD) AS BAI_DSP_DIV_NM /* 원처분과명 */
	             , A.DPT_CD AS DPT_CD /* 발신부서 */
             	 , (SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD = A.DPT_CD) AS DPT_NM /* 발신부서 */
             	 , A.ORG_DSP_KWA_OPIN_SRCH_STEP_CD
	             , to_char(to_date(A.ORG_DSP_KWA_OPIN_SRCH_DT), 'YYYY-MM-DD') AS ORG_DSP_KWA_OPIN_SRCH_DT /* 발신일 */
	             , to_char(to_date(A.ORG_DSP_KWA_OPIN_RCPT_DT), 'YYYY-MM-DD') AS ORG_DSP_KWA_OPIN_RCPT_DT /* 수신일 */
	             , A.ACP_YR
                 , A.ACP_DVSN_CD
                 , A.ACP_SRNO
                 , A.TIT_NM         /*청구내용*/
                 , A.MG_ACP_YR
                 , A.MG_ACP_DVSN_CD
                 , A.MG_ACP_SRNO
                 , A.MG_DIV_CD
                 , (CASE WHEN A.MG_ACP_YR IS NOT NULL
                         THEN (SELECT COUNT(TA.ACP_YR)
                             FROM TBBADFRE012M TA
                            WHERE 1=1
                               AND TA.MG_ACP_DVSN_CD = A.MG_ACP_DVSN_CD
                               AND TA.MG_ACP_YR  = A.MG_ACP_YR
                               AND TA.MG_ACP_SRNO = A.MG_ACP_SRNO
                               AND TA.AUD_YR = A.AUD_YR
                               AND TA.AUD_NO = A.AUD_NO
                               AND TA.DSP_RQ_SNO = A.DSP_RQ_SNO
                               AND TA.ORG_DSP_KWA_OPIN_SRCH_DT IS NOT NULL
                         )
                         ELSE 1 END) AS ACP_CNT	/*관련심사청구건수*/
                 , (WITH SUBTABLE AS ( SELECT ACP_YR, ACP_DVSN_CD, ACP_SRNO, ACP_STEP_CD, REF_ID, DOC_ID FROM TBBADFRE103M WHERE RPRT_CD IN ('D10100100', 'E10100100') ORDER BY ACP_YR, ACP_DVSN_CD, ACP_SRNO, REF_ID, ACP_STEP_CD, RPRT_CD, APV_STA_CD ASC )
                    SELECT ST.DOC_ID 
                    FROM SUBTABLE ST
                    WHERE ST.ACP_YR = A.ACP_YR
                    AND ST.ACP_DVSN_CD = A.ACP_DVSN_CD
                    AND ST.ACP_SRNO = A.ACP_SRNO
                    AND ST.REF_ID = A.AUD_YR || '-' || A.AUD_NO || '-' || TO_CHAR(A.DSP_RQ_SNO)
                    AND ROWNUM = 1) AS DOC_NO
                 , (SELECT MAX(APV_STA_CD) FROM TBBADFRE103M ST WHERE ST.ACP_YR = A.ACP_YR AND ST.ACP_DVSN_CD = A.ACP_DVSN_CD AND ST.ACP_SRNO = A.ACP_SRNO AND ST.REF_ID = A.AUD_YR || '-' || A.AUD_NO || '-' || TO_CHAR(A.DSP_RQ_SNO) AND ST.RPRT_CD IN ('D10100100', 'E10100100') GROUP BY ST.ACP_YR, ST.ACP_DVSN_CD, ST.ACP_SRNO, ST.REF_ID, ST.RPRT_CD) AS APV_STA_CD
                 , (SELECT COUNT(ACP_YR) FROM TBBADFRE103M ST WHERE ST.ACP_YR = A.ACP_YR AND ST.ACP_DVSN_CD = A.ACP_DVSN_CD AND ST.ACP_SRNO = A.ACP_SRNO AND ST.REF_ID = A.AUD_YR || '-' || A.AUD_NO || '-' || TO_CHAR(A.DSP_RQ_SNO) AND ST.RPRT_CD IN ('D10100100', 'E10100100') GROUP BY ST.ACP_YR, ST.ACP_DVSN_CD, ST.ACP_SRNO, ST.REF_ID, ST.RPRT_CD) AS SND_DOC_CNT
                 , F_CODE_NM('1000894', A.DOC_WRIT_KND_CD) AS DOC_TYPE -- 편집기구분
                 , A.ORG_DSP_KWA_OPIN_DDLN_DT --처리기한
             FROM  (SELECT 
                        AUD_YR, AUD_NO, DSP_RQ_SNO, ACP_YR, ACP_DVSN_CD, ACP_SRNO, MG_ACP_YR, MG_ACP_DVSN_CD, MG_ACP_SRNO, MG_DIV_CD, ORG_ACP_SRNO, ORG_DSP_KWA_OPIN_SRCH_STEP_CD, ORG_DSP_KWA_OPIN_SRCH_DT, ORG_DSP_KWA_OPIN_RCPT_DT, TIT_NM, DEL_YN, BAI_DSP_DIV_CD, DPT_CD, DOC_WRIT_KND_CD, ORG_DSP_KWA_OPIN_DDLN_DT
                    FROM (
                        SELECT 1 AS RNUM, 
                        	AUD_YR, AUD_NO, DSP_RQ_SNO, ACP_YR, ACP_DVSN_CD, ACP_SRNO, MG_ACP_YR, MG_ACP_DVSN_CD, MG_ACP_SRNO, MG_DIV_CD, ORG_ACP_SRNO, ORG_DSP_KWA_OPIN_SRCH_STEP_CD, ORG_DSP_KWA_OPIN_SRCH_DT, ORG_DSP_KWA_OPIN_RCPT_DT, TIT_NM, DEL_YN, BAI_DSP_DIV_CD, DPT_CD, DOC_WRIT_KND_CD, ORG_DSP_KWA_OPIN_DDLN_DT
                        FROM TBBADFRE012M 
                        WHERE ORG_DSP_KWA_OPIN_SRCH_DT IS NOT NULL
                        AND MG_ACP_YR IS NULL
                        UNION ALL
                        SELECT ROW_NUMBER() OVER(PARTITION BY AUD_YR, AUD_NO, DSP_RQ_SNO, MG_ACP_YR, MG_ACP_DVSN_CD, MG_ACP_SRNO ORDER BY ORG_DSP_KWA_OPIN_SRCH_DT ASC) AS RNUM,
                        	AUD_YR, AUD_NO, DSP_RQ_SNO, ACP_YR, ACP_DVSN_CD, ACP_SRNO, MG_ACP_YR, MG_ACP_DVSN_CD, MG_ACP_SRNO, MG_DIV_CD, ORG_ACP_SRNO, ORG_DSP_KWA_OPIN_SRCH_STEP_CD, ORG_DSP_KWA_OPIN_SRCH_DT, ORG_DSP_KWA_OPIN_RCPT_DT, TIT_NM, DEL_YN, BAI_DSP_DIV_CD, DPT_CD, DOC_WRIT_KND_CD, ORG_DSP_KWA_OPIN_DDLN_DT
                        FROM TBBADFRE012M 
                        WHERE ORG_DSP_KWA_OPIN_SRCH_DT IS NOT NULL 
                        AND MG_ACP_YR IS NOT NULL
                        ORDER BY AUD_NO,AUD_YR,DSP_RQ_SNO
                    	) WHERE RNUM = 1
                     ) A   /*심사심의접수기본*/
			         , TBBADEAR001M D1  /*처분요구사항기본*/
			         , TBBADEAR002D D2  /*처분요구사항상세*/
			         , TBBADDED001M T1  /*감사사항기본*/
		     WHERE A.AUD_YR = D1.AUD_YR 
			   AND A.AUD_NO = D1.AUD_NO
			   AND A.DSP_RQ_SNO = D1.DSP_RQ_SNO
			   AND D1.AUD_YR = D2.AUD_YR
			   AND D1.AUD_NO = D2.AUD_NO
			   AND D1.DSP_RQ_SNO = D2.DSP_RQ_SNO
			   AND D1.AUD_YR = T1.AUD_YR
			   AND D1.AUD_NO = T1.AUD_NO
			   
	    ) A, TBBADFRE104L B, TBBADEAR004M C
	     WHERE 1=1
	     AND A.ACP_YR = B.ACP_YR(+)
         AND A.ACP_DVSN_CD = B.ACP_DVSN_CD(+)
         AND A.ACP_SRNO = B.ACP_SRNO(+)
         AND A.AUD_YR = B.AUD_YR(+)
         AND A.AUD_NO = B.AUD_NO(+)
         AND A.DSP_RQ_SNO = B.DSP_RQ_SNO(+)
         AND A.AUD_YR = C.AUD_YR(+)
         AND A.AUD_NO = C.AUD_NO(+)
         AND A.DSP_RQ_SNO = C.DSP_RQ_SNO(+) 
	    ]]>
	    
	    <if test='maintenanceRoleYn != "Y" '>
	        AND (A.BAI_DSP_DIV_CD IN (SELECT T1.DPT_CD
                                                              FROM TBDCMACM002M T1
                                                             WHERE 1=1
                                                               AND T1.USE_YN = 'Y'
                                                             CONNECT BY PRIOR T1.DPT_CD = T1.HIRK_DPT_CD START WITH T1.DPT_CD IN ( #{dptCd}, #{subDptCd})
                                                             )  OR B.HNDL_CHGR_CD = #{cnb} OR C.ETR_PEN_ID = #{cnb})
	    </if>
	     <if test='acpYr != null and acpYr != ""'>
	        AND A.ACP_YR = #{acpYr}
	    </if>
	     <if test='acpSrno != null and acpSrno != ""'>
	        AND A.ACP_SRNO = #{acpSrno}
	    </if>
	    <if test='schAudYr != null and schAudYr != ""'>
	        AND A.AUD_YR = #{schAudYr}
	    </if>
	    <if test='schAudYrNoKndCd != null and schAudYrNoKndCd != ""'>
	        AND A.AUD_KND_CD = #{schAudYrNoKndCd}
	    </if>
	      <if test='schAudNo != null and schAudNo != ""'>
	        AND A.AUD_GRN_NO = #{schAudNo} 
	    </if>
	    <if test='dtmStaCd != null and dtmStaCd != ""'>
	        AND A.DTM_STA_CD = #{dtmStaCd}
        </if>
        <if test='apvStaCd != null and apvStaCd != ""'>
        	<if test='apvStaCd != 0'>
        	AND A.APV_STA_CD = #{apvStaCd}
        	</if>
        	<if test='apvStaCd == 0'>
        	AND A.APV_STA_CD IS NULL
        	</if>
        </if>
        	AND A.ACP_DVSN_CD = #{acpDvsnCd}
       	<![CDATA[
	        GROUP BY A.AUD_YR, A.AUD_NO  , A.AUD_GRN_NO,  A.AUD_KND_CD, A.DSP_RQ_SNO, A.DSP_RQ_SNO_NM, A.ENF_DT, A.ENF_BRDV_CD, A.ENF_BRDV_NM
	                , A.AUD_ORG_CNT, A.TIT_TXT, A.DTM_STA_CD, A.DTM_STA_NM, A.BAI_DSP_DIV_CD, A.BAI_DSP_DIV_NM, A.APV_STA_CD
	                , A.DPT_CD, A.DPT_NM, A.ORG_DSP_KWA_OPIN_SRCH_DT, A.ORG_DSP_KWA_OPIN_RCPT_DT, A.ACP_DVSN_CD, A.ACP_NO, A.TIT_NM, A.DOC_NO
                    , A.MG_ACP_SRNO, A.MG_ACP_YR, A.MG_ACP_DVSN_CD, A.MG_DIV_CD, A.ACP_CNT, A.ACP_YR, A.ACP_SRNO
                    , A.SND_DOC_CNT, A.ORG_DSP_KWA_OPIN_SRCH_STEP_CD,A.DOC_TYPE, A.ORG_DSP_KWA_OPIN_DDLN_DT
	        ORDER BY A.ORG_DSP_KWA_OPIN_SRCH_DT DESC, A.ACP_NO DESC
        ]]>
        <include refid="include.pageOrder" />
	</select>
</mapper>
