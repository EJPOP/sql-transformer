<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.bad.ded.dao.BADDED010PMapper">
    
    <select id="selectList" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.selectList*/
        <include refid="include.pageSelct" />
            <![CDATA[
            SELECT *
            FROM (
            SELECT D1.BZT_YR                                               AS BZT_YR
                 , D1.BZT_SNO                                              AS BZT_SNO
                 , D1.PCT_CNB                                              AS PCT_CNB
                 , D1.PCT_NM_DISP                                          AS PCT_NM_DISP
                 , D1.RANK_NM                                              AS RANK_NM
                 , NVL(D1.DT_EXS,0) - NVL(D2.DT_EXS,0)                     AS DT_EXS           /*일비*/
                 , NVL(D1.LDC,0) - NVL(D2.LDC,0)                           AS LDC              /*숙박비*/
                 , NVL(D1.FDEX,0) - NVL(D2.FDEX,0)                         AS FDEX             /*식비*/
                 , NVL(D1.CPRG_FR_EXS,0) - NVL(D2.CPRG_FR_EXS,0)           AS CPRG_FR_EXS      /*수도권운임*/
                 , NVL(D1.SPM_XPN,0) - NVL(D2.SPM_XPN,0)                   AS SPM_XPN          /*보충경비*/
                 , NVL(D1.BZT_DCN,0) - NVL(D2.BZT_DCN,0)                   AS BZT_DCN          /*출장일수*/
                 , NVL(D1.RL_FR_EXS,0) - NVL(D2.RL_FR_EXS,0)               AS RL_FR_EXS        /*철도운임비*/
                 , NVL(D1.LEAD_EXS,0) - NVL(D2.LEAD_EXS,0)                 AS LEAD_EXS         /*지휘비*/
                 , NVL(D1.AUD_ACTV_RCV_EXS,0) - NVL(D2.AUD_ACTV_RCV_EXS,0) AS AUD_ACTV_RCV_EXS /*감사활동수용비*/
                 , NVL(D1.SUM_COST,0) - NVL(D2.SUM_COST,0)                 AS SUM_COST         /*국내여비*/
                 , NVL(D1.ALL_COST,0) - NVL(D2.ALL_COST,0)                 AS ALL_COST         /*합계*/
                 , ''                                                      AS AJT_YN           /*정산완료처리에 flag로 사용*/
                 , D1.MAX_SNO                                              AS MAX_SNO          /*이력변경번호*/
                 , D1.AJT_CHG_RSN                                          AS AJT_CHG_RSN      /*정산사유*/
                 , D3.REL_AUD_YR                                           AS REL_AUD_YR
                    , D3.REL_AUD_NO                                        AS REL_AUD_NO
                 , D3.AUD_STEP_SNO                                         AS AUD_STEP_SNO
                 , D1.STF_DVSN_CD                                          AS STF_DVSN_CD      /*직원구분코드*/
              FROM (SELECT D2.*
                         , MAX_SNO
                         , AJT_CHG_RSN 
                      FROM (    SELECT BZT_YR
                                     , BZT_SNO
                                     , PCT_CNB
                                     , MAX(BZT_AJT_SNO) MAX_SNO
                                     , MAX(AJT_CHG_RSN) AJT_CHG_RSN
                                  FROM TBBADDED019H
                                 WHERE BZT_YR  = #{bztYr}
                                   AND BZT_SNO = #{bztSno}
                                   AND NVL(AJT_YN,'N') = 'N'
                                 GROUP BY BZT_YR , BZT_SNO , PCT_CNB ) D1
                        , (SELECT *
                                     FROM VADED001
                                    WHERE BZT_YR  = #{bztYr}
                                      AND BZT_SNO = #{bztSno}
                                      AND BZT_AJT_SNO = (SELECT MAX(BZT_AJT_SNO) MAX_SNO
                                                           FROM TBBADDED019H
                                                          WHERE BZT_YR  = #{bztYr}
                                                            AND BZT_SNO = #{bztSno}
                                                            AND NVL(AJT_YN,'N') = 'N')
                           ) D2
                     WHERE 1=1
                       AND D1.BZT_YR  = D2.BZT_YR
                       AND D1.BZT_SNO = D2.BZT_SNO
                       AND D1.PCT_CNB = D2.PCT_CNB
                       AND D1.MAX_SNO = D2.BZT_AJT_SNO
                       AND D1.BZT_YR  = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                  ) D1
                , (
                    SELECT D2.* 
                      FROM (    SELECT BZT_YR
                                     , BZT_SNO
                                     , PCT_CNB
                                     , MAX(BZT_AJT_SNO) MAX_SNO
                                  FROM TBBADDED019H
                                 WHERE BZT_YR  = #{bztYr}
                                   AND BZT_SNO = #{bztSno}
                                   AND NVL(AJT_YN,'N') = 'Y'
                                 GROUP BY BZT_YR , BZT_SNO , PCT_CNB ) D1
                        , (SELECT *
                             FROM VADED001
                            WHERE BZT_YR  = #{bztYr}
                              AND BZT_SNO = #{bztSno}
                              AND BZT_AJT_SNO = (SELECT MAX(BZT_AJT_SNO)
                                                   FROM TBBADDED019H
                                                  WHERE BZT_YR  = #{bztYr}
                                                    AND BZT_SNO = #{bztSno}
                                                    AND NVL(AJT_YN,'N') = 'Y')
                           ) D2
                     WHERE 1=1
                       AND D1.BZT_YR  = D2.BZT_YR
                       AND D1.BZT_SNO = D2.BZT_SNO
                       AND D1.PCT_CNB = D2.PCT_CNB
                       AND D1.MAX_SNO = D2.BZT_AJT_SNO 
                       AND D1.BZT_YR  = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                  ) D2
                 , TBBADDED002M D3
            WHERE 1=1
              AND D1.BZT_YR  = D2.BZT_YR(+)
              AND D1.BZT_SNO = D2.BZT_SNO(+)
              AND D1.PCT_CNB = D2.PCT_CNB(+)
              AND D1.BZT_YR  = D3.BZT_YR
              AND D1.BZT_SNO = D3.BZT_SNO
            )     
            WHERE 1=1
                AND DT_EXS <>0 OR LDC<>0 OR FDEX<>0 OR SPM_XPN<>0 OR BZT_DCN<>0 OR RL_FR_EXS<>0 OR LEAD_EXS<>0 OR AUD_ACTV_RCV_EXS<>0 OR SUM_COST<>0 OR ALL_COST<>0
                    OR CPRG_FR_EXS <> 0
               ORDER BY PCT_CNB
            ]]>
        <include refid="include.pageOrder" />
    </select>
    
    <update id="updateBADDED019H" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.updateBADDED019H*/
        UPDATE TBBADDED019H SET AJT_CHG_RSN     = #{ajtChgRsn}
                              , FNL_USR_ID      = #{usrId}
                              , FNL_DEAL_DPT_CD = #{dptCd}
                              , FNL_MNU_ID      = #{menuNo}
                              , FNL_MDF_DH      = SYSDATE
                          WHERE BZT_YR      = #{bztYr}
                            AND BZT_SNO     = #{bztSno}
                            AND PCT_CNB     = #{pctCnb}
                            AND BZT_AJT_SNO = #{maxSno}
    </update>
    
    <select id="getMaxAjtDge" parameterType="paramMap" resultType="String">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.getMaxAjtDge*/
        SELECT TO_CHAR(NVL(MAX(AJT_DGE),0) + 1) AS MAX_AJT_DGE
          FROM TBBADDED019H
         WHERE BZT_YR  = #{bztYr}
           AND BZT_SNO = #{bztSno}
    </select>
    
    <update id="updateBADDED019H_2" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.updateBADDED019H*/
        UPDATE TBBADDED019H SET AJT_YN          = 'Y'
                              , AJT_DGE         = #{ajtDge}
                              , AJT_DT          = TO_CHAR(SYSDATE,'YYYYMMDD')
                              , FNL_USR_ID      = #{usrId}
                              , FNL_DEAL_DPT_CD = #{dptCd}
                              , FNL_MNU_ID      = #{menuNo}
                              , FNL_MDF_DH      = SYSDATE
                          WHERE BZT_YR          = #{bztYr}
                            AND BZT_SNO         = #{bztSno}
                            AND PCT_CNB         = #{pctCnb}
                            AND NVL(AJT_YN,'N') = 'N'
                            <if test="maxSno != null and maxSno != ''">
                            AND BZT_AJT_SNO     = #{maxSno}
                            </if>
    </update>
    
    <update id="updateBADDED020H" parameterType="paramMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.updateBADDED020H*/
        UPDATE TBBADDED020H SET AJT_YN = 'Y'
                              , AJT_DGE         = #{ajtDge}
                              , AJT_DT          = TO_CHAR(SYSDATE,'YYYYMMDD')
                              , FNL_USR_ID      = #{usrId}
                              , FNL_DEAL_DPT_CD = #{dptCd}
                              , FNL_MNU_ID      = #{menuNo}
                              , FNL_MDF_DH      = SYSDATE
                          WHERE BZT_YR          = #{bztYr}
                            AND BZT_SNO         = #{bztSno}
                            AND PCT_CNB         = #{pctCnb}
                            AND NVL(AJT_YN,'N') = 'N'
                            <if test="maxSno != null and maxSno != ''">
                            AND BZT_AJT_SNO     = #{maxSno}
                            </if>
    </update>
    
    
    
    <select id="selectExcelList1" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.selectExcelList1*/
            <![CDATA[
            	SELECT F_DPT_INFO(D.BLT_BRDV_CD, '1')                 AS DPT_NM     /* 소속 */
				       ,F_CODE_NM('1000173',D.PCT_RANK_CD)             AS RANK_NM    /* 직급 */
				       ,D.PCT_NM                                       AS PCT_NM     /* 성명 */
				       ,C.AUD_SBJ_NM                                   AS AUD_SBJ_NM /* 감사사항명 */
				       ,F_MNG_KND_AUDYRNO(C.AUD_YR, C.AUD_NO, '', '-') AS AUD_YR_NO  /* 감사연번호 */
				       ,A.BZT_STR_DT                                   AS BZT_STR_DT /* 출장시작일 */ 
				       ,A.BZT_END_DT                                   AS BZT_END_DT /* 출장종료일 */
				       ,TO_CHAR(TO_DATE(A.BZT_STR_DT),'YYYY. MM. DD') || ' ~ ' || TO_CHAR(TO_DATE(A.BZT_END_DT),'YYYY. MM. DD') AS BZT_STR_END_DT
				   FROM (SELECT A.BZT_YR
						       ,A.BZT_SNO
						       ,A.PCT_CNB
						       ,MIN(NVL(B.BZT_STR_DT,C.BZT_STR_DT)) AS BZT_STR_DT
						       ,MAX(NVL(B.BZT_END_DT,C.BZT_END_DT)) AS BZT_END_DT
						   FROM TBBADDED010L A
						  LEFT OUTER JOIN TBBADDED011L B ON (A.BZT_YR = B.BZT_YR AND A.BZT_SNO = B.BZT_SNO AND A.PCT_CNB = B.PCT_CNB AND B.FNL_YN = 'Y')
						       ,(SELECT BZT_YR
                                       ,BZT_SNO
                                       ,PCT_CNB
                                       ,MIN(BZT_STR_DT) AS BZT_STR_DT
                                       ,MAX(BZT_END_DT) AS BZT_END_DT
                                   FROM TBBADDED011L
                                  WHERE BZT_YR =  #{bztYr} 
                                    AND BZT_SNO = #{bztSno}
                                    AND PCT_CNB = #{cnb} 
                                    AND CALC_YN = 'N'
                                   GROUP BY BZT_YR
                                           ,BZT_SNO
                                           ,PCT_CNB
                                 ) C
						  WHERE A.BZT_YR = #{bztYr} 
						    AND A.BZT_SNO = #{bztSno}
						    AND A.PCT_CNB = #{cnb}
						    AND A.BZT_YR  = C.BZT_YR(+)
                            AND A.BZT_SNO = C.BZT_SNO(+)
                            AND A.PCT_CNB = C.PCT_CNB(+)
						  GROUP BY A.BZT_YR
						          ,A.BZT_SNO
						          ,A.PCT_CNB) A /* 여비정산서(개인) 출력시 오류 수정 */
				       ,TBBADDED002M B 
				       ,TBBADDED001M C
				       ,TBBADDED010L D
				  WHERE A.BZT_YR     = B.BZT_YR
				    AND A.BZT_SNO    = B.BZT_SNO
				    AND B.REL_AUD_YR = C.AUD_YR
				    AND B.REL_AUD_NO = C.AUD_NO
				    AND A.BZT_YR     = D.BZT_YR
				    AND A.BZT_SNO    = D.BZT_SNO
				    AND A.PCT_CNB    = D.PCT_CNB
            ]]>
    </select>
    
    
    <select id="selectExcelList2" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.selectExcelList2*/
            <![CDATA[
            	SELECT A.RID_DT                                                                         /* 일자(결제일자) */ 
				       ,A.TRAIN_TYPE_NM                                                                  /* 교통편 */   
				       ,A.DEP_STN_NM                                                                     /* 출발지 */
				       ,A.ARV_STN_NM                                                                     /* 도착지 */    
				       ,TO_CHAR(A.RL_FR_EXS)              AS RL_FR_EXS               /* 정부구매카드 결제금액 */
				       ,TO_CHAR(A.RL_GVM_PUR_CRD_EXMP_AM) AS RL_GVM_PUR_CRD_EXMP_AM  /* 정부구매카드 외 결제금액 */
				       ,TO_CHAR(A.TOT_AM)                 AS TOT_AM                  /* 계 */
				       ,A.RMK                                                                            /* 비고 */
				   FROM (
				            SELECT SUBSTR(A.RID_DT,5,2) || '월 ' || SUBSTR(A.RID_DT,7,2) || '일'  AS RID_DT                
				                 , F_CODE_NM('1000025',A.TRIN_KND_CD)                             AS TRAIN_TYPE_NM        
				                 , A.DEP_STN_NM                                                   AS DEP_STN_NM             
				                 , A.ARV_STN_NM                                                   AS ARV_STN_NM           
				                 , NVL(A.RL_FR_EXS,0)                                             AS RL_FR_EXS               
				                 , NVL(A.RL_GVM_PUR_CRD_EXMP_AM,0) + NVL(A.TOLL,0) + 
				                   NVL(A.PARKING_FEE,0)                                           AS RL_GVM_PUR_CRD_EXMP_AM   
				                 , NVL(A.RL_FR_EXS,0) + NVL(A.RL_GVM_PUR_CRD_EXMP_AM,0) + 
				                   NVL(A.TOLL,0) + NVL(A.PARKING_FEE,0)                           AS TOT_AM                  
				                 , CASE WHEN A.TRIN_KND_CD IN ('9','10','11','12','18','19','20','21','22') THEN '유류비:' || NVL(A.RL_GVM_PUR_CRD_EXMP_AM,0) || ',' || '톨비:' || NVL(A.TOLL,0) || ',' || '주차비:' || NVL(A.PARKING_FEE,0)
				                        ELSE ''
				                    END                                                           AS RMK    
				              FROM TBBADDED017L A
				             WHERE 1=1
				               AND A.BZT_YR      = #{bztYr} 
				               AND A.BZT_SNO     = #{bztSno} 
				               AND A.PCT_CNB     = #{cnb} 
				               AND A.FNL_YN      = 'Y'
				      ) A 
				      ORDER BY A.RID_DT
            ]]>
    </select>
    
    <select id="selectExcelList3" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.selectExcelList3*/
            <![CDATA[
            	WITH BASE AS (
			        SELECT A.BZT_STR_DT                                      AS BZT_STR_DT           /*출장시작일*/
			             , A.BZT_END_DT                                      AS BZT_END_DT           /*출장종료일*/
			             , A.LODG_DCN                                        AS LODG_DCN             /*숙박일수*/
			             , F_CODE_NM('1000001',A.RGN_CD)                     AS RGN_NM               /*숙박지*/
			             , (SELECT CASE 
                                    WHEN B1.LDC_BND_APC_YN = 'Y' THEN TO_CHAR(MAX(B2.BZT_STAD_AM)*B1.LDC_BND_APC_RTS) 
                                    ELSE TO_CHAR(MAX(B2.BZT_STAD_AM)) 
                                   END BZT_STAD_AM         /*3월2일 이후 한도해제로 인해 TBBADDED180B 에 새로운 컬럼을 추가하여 관리되도록 수정*/
			                  FROM TBBADDED180B B1
			                      ,TBBADDED018B B2  
			                 WHERE 1=1 
			                   AND B1.BZT_SRNO     = B2.BZT_SRNO
			                   AND B1.BZT_DVSN_CD  = '1'
			                   AND B2.TREXP_CLU_CD = '03'
			                   AND B1.STAD_STR_DT <= REPLACE(A.BZT_STR_DT,'-','') AND B1.STAD_END_DT >= REPLACE(A.BZT_STR_DT,'-','')
			                   AND B2.RGN_DVSN_CD  = (SELECT CASE WHEN A.RGN_CD      = '2000'  THEN '5' 
			                                                      WHEN USR_DFN_TXT_1 = '1'     THEN '4' 
			                                                      WHEN USR_DFN_TXT_1 = '2'     THEN '5' 
			                                                      WHEN USR_DFN_TXT_1 = '3'     THEN '6' 
			                                                  END 
			                                            FROM TBDCMACM013C
			                                           WHERE CMM_CD_DVSN_CD = '1000001'
			                                             AND USE_YN         = 'Y'
			                                             AND CD             = A.RGN_CD)
			                 GROUP BY B1.LDC_BND_APC_YN, B1.LDC_BND_APC_RTS
			                ) * NVL(A.LODG_DCN,0)                            AS LIMIT_AM                 /* 한도금액=숙박일수X출장기준금액 */
			             , NVL(A.LDC,0)                                      AS LDC                      /* 정부구매카드 결제금액 */
			             , NVL(A.LODG_GVM_PUR_CRD_EXMP_AM,0)                 AS LODG_GVM_PUR_CRD_EXMP_AM /* 정부구매카드 외 결제금액 */
			             , NVL(A.LDC,0) + NVL(A.LODG_GVM_PUR_CRD_EXMP_AM,0)  AS TOT_AM                   /* 계 */
			             , A.BZT_EXS_SNO
			             , A.LODG_TYP_CD
			          FROM TBBADDED011L A
			              ,TBBADDED002M B
			         WHERE 1=1 
			           AND A.BZT_YR  = B.BZT_YR
			           AND A.BZT_SNO = B.BZT_SNO
			           AND A.BZT_YR  = #{bztYr}     
			           AND A.BZT_SNO = #{bztSno}    
			           AND A.PCT_CNB = #{cnb}    
			           AND A.FNL_YN  = 'Y'
			           AND NVL(A.LDC,0) + NVL(A.LODG_GVM_PUR_CRD_EXMP_AM,0) > 0
			          ORDER BY A.BZT_EXS_SNO
			)
			  SELECT BZT_STR_DT                                                                           /* 출장시작일 */
			        ,BZT_END_DT                                                                           /* 출장종료일 */
			        ,TO_CHAR(LODG_DCN) AS LODG_DCN                                                         /* 숙박일수 */
			        ,RGN_NM                                                                               /* 숙박지 */
			        ,SUBSTR(BZT_STR_DT,5,2) || '월 ' || SUBSTR(BZT_STR_DT,7,2) || '일' 
			         || '~' || SUBSTR(BZT_END_DT,5,2) || '월 ' || SUBSTR(BZT_END_DT,7,2) || '일' AS BZT_STR_END_DT
			        ,TRIM(TO_CHAR(LIMIT_AM))                 AS LIMIT_AM                    /* 한도금액 */
			        ,TRIM(TO_CHAR(LDC))                      AS LDC                         /* 정부구매카드 결제금액 */
			        ,TRIM(TO_CHAR(LODG_GVM_PUR_CRD_EXMP_AM)) AS LODG_GVM_PUR_CRD_EXMP_AM    /* 정부구매카드 외 결제금액 */
			        ,TRIM(TO_CHAR(TOT_AM))                   AS TOT_AM                      /* 계 */
			        ,LODG_TYP_NM                                                            /* 숙박유형, 20230512 추가 */
			  FROM (
			          SELECT BZT_STR_DT               
			                ,BZT_END_DT               
			                ,LODG_DCN                 
			                ,RGN_NM                   
			                ,NVL(LIMIT_AM,0) AS LIMIT_AM                 
			                ,LDC                      
			                ,LODG_GVM_PUR_CRD_EXMP_AM 
			                ,TOT_AM                   
			                ,DECODE(LODG_TYP_CD, '30',F_CODE_NM('1000965',LODG_TYP_CD)||'숙박', '-') AS LODG_TYP_NM
			            FROM BASE
			        
			      )        
            ]]>
    </select>
    
    <select id="selectExcelList4" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.selectExcelList4*/
	<![CDATA[
          SELECT NVL(BZT_STR_END_DT, BZT_STR_END_DT2) BZT_STR_END_DT  /* 출장여비내역 삭제할 경우 여비정산서(개인) 출력물에 정산일자 공백표시되지 않게 수정*/
                ,TO_CHAR(BZT_DCN)       AS BZT_DCN
                ,TO_CHAR(FDEX)          AS FDEX
                ,TO_CHAR(DT_EXS)        AS DT_EXS
                ,TO_CHAR(FDEX + DT_EXS) AS TOT_AM
            FROM (
            SELECT D1.BZT_YR                                               AS BZT_YR
                 , D1.BZT_SNO                                              AS BZT_SNO
                 , D1.PCT_CNB                                              AS PCT_CNB
                 , (SELECT SUBSTR(MIN(BZT_STR_DT),5,2) || '월 ' || SUBSTR(MIN(BZT_STR_DT),7,2) || '일'  || '~' || 
			               SUBSTR(MAX(BZT_END_DT),5,2) || '월 ' || SUBSTR(MAX(BZT_END_DT),7,2) || '일'                              
                      FROM TBBADDED011L
                     WHERE BZT_YR  = D1.BZT_YR
                       AND BZT_SNO = D1.BZT_SNO
                       AND PCT_CNB = D1.PCT_CNB
                       AND CALC_YN  = 'N'
                     GROUP BY BZT_YR
                             ,BZT_SNO
                             ,PCT_CNB) AS BZT_STR_END_DT2  
                 , NVL(D1.BZT_DCN,0) - NVL(D2.BZT_DCN,0)                   AS BZT_DCN          /*출장일수*/
                 , NVL(D1.FDEX,0)    - NVL(D2.FDEX,0)                      AS FDEX             /*식비*/
                 , NVL(D1.DT_EXS,0) - NVL(D2.DT_EXS,0)                     AS DT_EXS           /*일비*/
                 , (SELECT SUBSTR(MIN(BZT_STR_DT),5,2) || '월 ' || SUBSTR(MIN(BZT_STR_DT),7,2) || '일'  || '~' || 
			               SUBSTR(MAX(BZT_END_DT),5,2) || '월 ' || SUBSTR(MAX(BZT_END_DT),7,2) || '일'                              
                      FROM TBBADDED011L
                     WHERE BZT_YR  = D1.BZT_YR
                       AND BZT_SNO = D1.BZT_SNO
                       AND PCT_CNB = D1.PCT_CNB
                       AND FNL_YN  = 'Y'
                     GROUP BY BZT_YR
                             ,BZT_SNO
                             ,PCT_CNB) AS BZT_STR_END_DT              
              FROM (SELECT D2.*
                         , MAX_SNO
                         , AJT_CHG_RSN 
                      FROM (    SELECT BZT_YR
                                     , BZT_SNO
                                     , PCT_CNB
                                     , MAX(BZT_AJT_SNO) MAX_SNO
                                     , MAX(AJT_CHG_RSN) AJT_CHG_RSN
                                  FROM TBBADDED019H
                                 WHERE BZT_YR  = #{bztYr}
                                   AND BZT_SNO = #{bztSno}
                                   AND PCT_CNB = #{cnb}
                                   AND NVL(AJT_YN,'N') = 'N'
                                 GROUP BY BZT_YR , BZT_SNO , PCT_CNB ) D1
                        , VADED001 D2
                     WHERE 1=1
                       AND D1.BZT_YR  = D2.BZT_YR
                       AND D1.BZT_SNO = D2.BZT_SNO
                       AND D1.PCT_CNB = D2.PCT_CNB
                       AND D1.MAX_SNO = D2.BZT_AJT_SNO
                       AND D1.BZT_YR  = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                       AND D1.PCT_CNB = #{cnb}
                  ) D1
                , (
                    SELECT D2.* 
                      FROM (    SELECT BZT_YR
                                     , BZT_SNO
                                     , PCT_CNB
                                     , MAX(BZT_AJT_SNO) MAX_SNO
                                  FROM TBBADDED019H
                                 WHERE BZT_YR  = #{bztYr}
                                   AND BZT_SNO = #{bztSno}
                                   AND PCT_CNB = #{cnb}
                                   AND NVL(AJT_YN,'N') = 'Y'
                                 GROUP BY BZT_YR , BZT_SNO , PCT_CNB ) D1
                        , VADED001 D2
                     WHERE 1=1
                       AND D1.BZT_YR  = D2.BZT_YR
                       AND D1.BZT_SNO = D2.BZT_SNO
                       AND D1.PCT_CNB = D2.PCT_CNB
                       AND D1.MAX_SNO = D2.BZT_AJT_SNO 
                       AND D1.BZT_YR  = #{bztYr}
                       AND D1.BZT_SNO = #{bztSno}
                       AND D1.PCT_CNB = #{cnb}
                  ) D2
                 , TBBADDED002M D3
            WHERE 1=1
              AND D1.BZT_YR  = D2.BZT_YR(+)
              AND D1.BZT_SNO = D2.BZT_SNO(+)
              AND D1.PCT_CNB = D2.PCT_CNB(+)
              AND D1.BZT_YR  = D3.BZT_YR
              AND D1.BZT_SNO = D3.BZT_SNO
            )     
            WHERE 1=1
              AND BZT_DCN <> 0 OR FDEX <> 0 OR DT_EXS <> 0
            ORDER BY PCT_CNB            
            ]]>
    </select>
    
    <select id="selectTBBADDED010L" parameterType="paramMap" resultType="egovMap">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.selectTBBADDED010L*/
            <![CDATA[
            SELECT PCT_CNB
			  FROM TBBADDED010L
			 WHERE BZT_YR = #{bztYr}
			   AND BZT_SNO = #{bztSno}
			 ]]>  
			<if test='manpowerPoolSyeYn == "Y"'>
             UNION ALL
			SELECT CNB
			  FROM TBDCMACM001M
			 WHERE DPT_CD IN (SELECT DPT_CD 
                                FROM TABLE(F_AUTH_DEPT(#{cnb}, '', 'Y', #{dptCd})))
               AND #{dptCd} = (SELECT HIRK_DPT_CD
			                     FROM TBDCMACM002M
			                    WHERE DPT_CD = (SELECT BZT_BRDV_CD
			                                      FROM TBBADDED002M
			                                     WHERE BZT_YR = #{bztYr}
			                                       AND BZT_SNO = #{bztSno}))
             </if>
             <if test='manpowerPoolSyeYn != "Y"'>
             UNION ALL
			SELECT CNB
			  FROM TBDCMACM001M
			 WHERE DPT_CD = (SELECT BZT_BRDV_CD
			                   FROM TBBADDED002M
			                  WHERE BZT_YR = #{bztYr}
			                    AND BZT_SNO = #{bztSno})
             </if>
    </select>
    
    <select id="selectManpowerPoolSyeYn" parameterType="paramMap" resultType="String">
    /*kr.go.bai.eip.bad.ded.dao.BADDED010PMapper.selectManpowerPoolSyeYn*/
        SELECT NVL(MANPOWER_POOL_SYE_YN, 'N') AS MANPOWER_POOL_SYE_YN
		  FROM TBDCMACM002M
		 WHERE 1=1
		   AND DPT_CD = #{dptCd}
    </select>
    
</mapper>