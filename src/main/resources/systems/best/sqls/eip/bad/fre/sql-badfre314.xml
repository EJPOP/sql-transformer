<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--   -->
<mapper namespace="kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper">

	<select id="BADFRE314EMainselect" parameterType="paramMap" resultType="egovMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.BADFRE314EMainselect */
	</select>
	
		<!-- 최종의결 및 결과 업데이트 -->
	<update id="BADFRE012MDcsInfoUpdate" parameterType="paramMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.BADFRE012MDcsInfontUpdate */
		   UPDATE TBBADFRE012M
		      SET 
		<if test='vtKndCd != null and vtKndCd != ""'>
		      	  VT_KND_CD      = #{vtKndCd}, /* 심사청구의결종류코드 */
		</if> 
		<if test='dcsDt != null and dcsDt != ""'>
		          DCS_DT         = #{dcsDt},  /*결정일자*/	
	    </if>
		<if test='amitAm != null and amitAm != ""'>
		         AMIT_AM        = #{amitAm},  /*결정금액*/
	    </if>
   		<if test='dcsSbj != null and dcsSbj != ""'>
		         DCS_SBJ        = #{dcsSbj},    /*결정내용*/
	    </if>
	    <if test='isuTxt != null and isuTxt != ""'>
		         ISU_TXT        = #{isuTxt},    /*쟁점*/
	    </if>
			     FNL_USR_ID     = #{fnlUsrId},  /*최종사용자ID*/
                 FNL_MDF_DH     = SYSDATE      /*최종수정일시*/
		 WHERE ACP_YR = #{acpYr}
		   AND ACP_DVSN_CD = #{acpDvsnCd}
		   AND ACP_SRNO = #{acpSrno}
	</update>
	
	<!-- 통계여부 업데이트 -->
	<update id="BADFRE012MExYnUpdate" parameterType="paramMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.BADFRE012MExYnUpdate */
		   UPDATE TBBADFRE012M
		      SET 
		      	  EX_YN      = #{exYn}, /* 통계제외 여부 */
		          EX_RSN_TXT = #{exRsnTxt}  /* 통계제외 사유 */	
		 WHERE ACP_YR 	   = #{acpYr}
		   AND ACP_DVSN_CD = #{acpDvsnCd}
		   AND ACP_SRNO    = #{acpSrno}
	</update>
	
	<!-- 사무처위임처리 체크 -->
	<select id="BADFRE314Ck200101Select" parameterType="paramMap" resultType="egovMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.BADFRE314Ck200101Select */
		select 
          CMPT_YN
          FROM TBBADFRE102M A
         WHERE 1=1
         
           AND A.ACP_YR = #{acpYr} /* PARAM : 접수년도 */
           AND A.ACP_SRNO = #{acpSrno} /* PARAM : 접수연번(내부  pk 번호) */
           AND A.ACP_DVSN_CD = #{acpDvsnCd}
           AND A.ACP_STEP_CD = 'D1020'
           AND A.ACP_MAIN_STEP_ID = '200101'
	</select>
	
	<update id="BADFRE102MPrcsUpdate" parameterType="paramMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.BADFRE102MPrcsUpdate */
		   UPDATE TBBADFRE102M
		      SET 
				 CMPT_YN = #{cmptYn},
			     FNL_USR_ID     = #{fnlUsrId},  /*최종사용자ID*/
                 FNL_MDF_DH     = SYSDATE      /*최종수정일시*/
		 WHERE (ACP_YR, ACP_DVSN_CD, ACP_SRNO) IN (
         		SELECT ACP_YR, ACP_DVSN_CD, ACP_SRNO 
         		FROM TBBADFRE012M B 
         		WHERE NVL(B.MG_ACP_YR, B.ACP_YR) = #{acpYr} AND NVL(B.MG_ACP_DVSN_CD, B.ACP_DVSN_CD) = #{acpDvsnCd} AND NVL(B.MG_ACP_SRNO, B.ACP_SRNO) = #{acpSrno})
		   AND ACP_MAIN_STEP_ID = #{acpMainStepId}
	</update>
	
	<update id="BADFRE103MSndYnUpdate" parameterType="paramMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.BADFRE103MSndYnUpdate */
		   UPDATE TBBADFRE103M
		      SET 
		      	 SND_DOC_YN      ='Y', /* 심사청구의결종류코드 */
			     FNL_USR_ID     = #{fnlUsrId},  /*최종사용자ID*/
                 FNL_MDF_DH     = SYSDATE      /*최종수정일시*/
         WHERE (ACP_YR, ACP_DVSN_CD, ACP_SRNO) IN (
         		SELECT ACP_YR, ACP_DVSN_CD, ACP_SRNO 
         		FROM TBBADFRE012M B 
         		WHERE NVL(B.MG_ACP_YR, B.ACP_YR) = #{acpYr} AND NVL(B.MG_ACP_DVSN_CD, B.ACP_DVSN_CD) = #{acpDvsnCd} AND NVL(B.MG_ACP_SRNO, B.ACP_SRNO) = #{acpSrno})
		   AND RPRT_CD = #{rprtCd}
	</update>
	
	
	<update id="BADFRE103MUpdateEditorWrkApplY" parameterType="paramMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.BADFRE103MUpdateEditorWrkApplY */
		UPDATE TBBADFRE103M
		   SET EDITOR_WRK_APPL_YN     = 'Y', /* 에디팅 반영여부 */
			   FNL_USR_ID     = #{fnlUsrId},  /*최종사용자ID*/
               FNL_MDF_DH     = SYSDATE      /*최종수정일시*/
         WHERE ACP_YR      = #{acpYr}
           AND ACP_DVSN_CD = #{acpDvsnCd}
           AND ACP_SRNO    = #{acpSrno}
           AND ACP_STEP_CD = #{acpStepCd}
           AND DOC_ID      = #{docId}
	</update>
	
	
	<select id="selectFnlDocInfo" parameterType="paramMap" resultType="egovMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.selectFnlDocInfo */
		SELECT CASE WHEN A.SUB_YN = 'Y' THEN A.DOC_ID /*병행건 AND 대표건이 아닌경우 결정문 DOC_ID리턴*/
                    ELSE (CASE WHEN A.REFER_ENT = 'Y' AND A.REFER_ENT_RSN = '0' AND A.RPRT_CD = 'D10200100' THEN A.DOC_ID 
                               WHEN A.REFER_ENT = 'Y' AND A.REFER_ENT_RSN = '1' AND A.RPRT_CD = 'D10300100'THEN A.DOC_ID 
                               WHEN (A.REFER_ENT = 'N' OR A.REFER_ENT IS NULL) AND A.RPRT_CD IN ('E10500600','D10301100') AND A.APV_STA_CD = '30' THEN A.REF_ID /*부의건 부의안 DOC_ID리턴*/
                               WHEN (A.REFER_ENT = 'N' OR A.REFER_ENT IS NULL) AND A.RPRT_CD = 'E10500200' AND A.APV_STA_CD = '30' AND (SELECT NVL(CMPT_YN, 'N')
                                                                                                                                          FROM TBBADFRE102M
                                                                                                                                         WHERE 1=1
                                                                                                                                           AND ACP_YR = A.ACP_YR
                                                                                                                                           AND ACP_DVSN_CD = A.ACP_DVSN_CD
                                                                                                                                           AND ACP_SRNO = A.ACP_SRNO
                                                                                                                                           AND ACP_STEP_CD = 'E1050'
                                                                                                                                           AND ACP_MAIN_STEP_ID  = '510101') = 'N' THEN A.REF_ID /*서면의결 건 결정문 DOC_ID리턴*/
                               ELSE '' END) END AS DOC_ID
               , A.REFER_ENT
               , A.REFER_ENT_RSN
               , A.RPRT_CD
               , (SELECT NVL(CMPT_YN, 'N')
                    FROM TBBADFRE102M
                   WHERE 1=1
                     AND ACP_YR = A.ACP_YR
                     AND ACP_DVSN_CD = A.ACP_DVSN_CD
                     AND ACP_SRNO = A.ACP_SRNO
                     AND ACP_STEP_CD = 'E1050'
                     AND ACP_MAIN_STEP_ID  = '510101') AS CMPT_YN
        FROM (
			SELECT A.ACP_YR
	               , A.ACP_DVSN_CD
	               , A.ACP_SRNO
	               , A.ACP_STEP_CD
	               , A.RPRT_CD
	               , A.APV_STA_CD
	               , A.DOC_ID
	               , A.REF_ID
	               , A.REF_DY
	               , B.REFER_ENT
	               , B.REFER_ENT_RSN
	               , CASE WHEN B.MG_DIV_CD = '20' AND NOT (B.MG_ACP_YR = B.ACP_YR AND B.MG_ACP_DVSN_CD = B.ACP_DVSN_CD AND B.MG_ACP_SRNO = B.ACP_SRNO) THEN 'Y'
	                      ELSE 'N' END AS SUB_YN
	               , B.WT_VT_YN 
	          FROM TBBADFRE103M A 
	    INNER JOIN TBBADFRE012M B ON (B.ACP_YR = A.ACP_YR AND B.ACP_DVSN_CD = A.ACP_DVSN_CD AND B.ACP_SRNO = A.ACP_SRNO)
	         WHERE A.RPRT_CD IN ('D10301100','E10500600','D10200100', 'D10300100', 'E10500200')
	           AND A.ACP_YR      = #{acpYr}
	           AND A.ACP_DVSN_CD = #{acpDvsnCd}
	           AND A.ACP_SRNO    = #{acpSrno}
      ) A
      ORDER BY A.RPRT_CD DESC, NVL(A.REF_DY, '11111111') DESC
	</select>
	
	<select id="selectFnlDocInfoTwo" parameterType="paramMap" resultType="egovMap">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.selectFnlDocInfoTwo */
		SELECT   A.DOC_ID
               , A.REFER_ENT
               , A.REFER_ENT_RSN
               , A.RPRT_CD
               , (SELECT NVL(CMPT_YN, 'N')
                    FROM TBBADFRE102M
                   WHERE 1=1
                     AND ACP_YR = A.ACP_YR
                     AND ACP_DVSN_CD = A.ACP_DVSN_CD
                     AND ACP_SRNO = A.ACP_SRNO
                     AND ACP_STEP_CD = 'E1050'
                     AND ACP_MAIN_STEP_ID  = '510101') AS CMPT_YN
        FROM (
			SELECT A.ACP_YR
	               , A.ACP_DVSN_CD
	               , A.ACP_SRNO
	               , A.ACP_STEP_CD
	               , A.RPRT_CD
	               , A.APV_STA_CD
	               , A.DOC_ID
	               , A.REF_ID
	               , A.REF_DY
	               , B.REFER_ENT
	               , B.REFER_ENT_RSN
	               , CASE WHEN B.MG_DIV_CD = '20' AND NOT (B.MG_ACP_YR = B.ACP_YR AND B.MG_ACP_DVSN_CD = B.ACP_DVSN_CD AND B.MG_ACP_SRNO = B.ACP_SRNO) THEN 'Y'
	                      ELSE 'N' END AS SUB_YN
	               , B.WT_VT_YN 
	          FROM TBBADFRE103M A 
	    INNER JOIN TBBADFRE012M B ON (B.ACP_YR = A.ACP_YR AND B.ACP_DVSN_CD = A.ACP_DVSN_CD AND B.ACP_SRNO = A.ACP_SRNO)
	         WHERE A.RPRT_CD IN ('E10400100','E10500100','E10500500')
	           AND A.ACP_YR      = #{acpYr}
	           AND A.ACP_DVSN_CD = #{acpDvsnCd}
	           AND A.ACP_SRNO    = #{acpSrno}
	           AND '30' = (CASE WHEN A.RPRT_CD IN ('E10500100','E10500500') THEN (SELECT T1.APV_STA_CD
                                                                                     FROM TBBADFRE103M T1
                                                                                    WHERE A.DOC_ID = T1.REF_ID
                                                                                      AND A.ACP_YR = T1.ACP_YR
                                                                                      AND A.ACP_DVSN_CD = T1.ACP_DVSN_CD
                                                                                      AND A.ACP_SRNO = T1.ACP_SRNO
                                                                                      AND T1.RPRT_CD IN ('E10500200','E10500600'))
                            ELSE '30'
                           END )
      ) A
      ORDER BY A.RPRT_CD DESC, NVL(A.REF_DY, '11111111') DESC
	</select>
	
	<select id="selWtVtYn" parameterType="paramMap" resultType="String">
		/* kr.go.bai.eip.bad.fre.dao.BADFRE314Mapper.selWtVtYn */
		SELECT WT_VT_YN
		  FROM TBBADFRE012M
         WHERE ACP_YR = #{acpYr}
           AND ACP_DVSN_CD = #{acpDvsnCd}
           AND ACP_SRNO = #{acpSrno}
	</select>
	
</mapper>
