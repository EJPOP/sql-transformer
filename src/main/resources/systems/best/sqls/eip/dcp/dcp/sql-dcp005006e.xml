<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC " -//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.dcp.dcp.dao.DCP005006EMapper">


	<select id="DCP005006ESysDateSelect" resultType="egovMap">
	/* kr.go.bai.eip.dcp.dcp.dao.DCP005006EMapper.DCP005006ESysDateSelect */
 	<![CDATA[
 	SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') AS ENDDT,
    	   TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE, -12), 'dd'), 'YYYYMMDD') AS STARTDT
  	FROM DUAL
 	]]>
	</select>


	<select id="DCP005006EMainSelect" parameterType="paramMap"
		resultType="egovMap">
		/* kr.go.bai.eip.dcp.dcp.dao.DCP005006EMapper.DCP005006EMainSelect */
		<include refid="include.pageSelct1" />
		<![CDATA[
			SELECT	D1.REQ_DVSN_CD
					,D1.CVPT_KND_CD
			      	 ,F_CODE_NM('1000940', D1.CVPT_KND_CD) AS CVPT_KND_NM
			      ,F_CODE_NM('1000944', D1.CVPT_KND_DTL_CD) AS CVPT_KND_DTL_NM
			      	,TO_CHAR(D1.ACP_DH, 'YYYY-MM-DD') AS ACP_DH
			      	,D1.CVPT_ACP_NO
			      	,D1.ACP_YR
			      	,D1.ACP_YR||'-청금-'||D1.RM_CVPT_ACP_NO AS ACP_YR_NO
			      	,F_CODE_NM('1000943', D3.CVPT_HNDL_DVSN_CD) AS CVPT_HNDL_DVSN_NM
			      	,F_CODE_NM('1000051', D3.T_CVPT_HNDL_DVSN_CD) AS T_CVPT_HNDL_DVSN_NM
			      	,CASE WHEN (	SELECT COUNT(*)
			      					FROM TBDCPDCP105L S1
			      					WHERE S1.REQ_DVSN_CD = D1.REQ_DVSN_CD
			      					AND S1.ACP_YR = D1.ACP_YR
			      					AND S1.CVPT_ACP_NO = D1.CVPT_ACP_NO
			      				) > 0 THEN D1.TIT_NM||'(합건 : '||D1.RM_CVPT_ACP_NO||', '||(	SELECT	AGGR_CONCAT( S3.RM_CVPT_ACP_NO, ', ')||' )'
			      																			FROM	TBDCPDCP105L S2, TBDCPDCP101M S3
			      																			WHERE	D1.REQ_DVSN_CD = S2.REQ_DVSN_CD
			      																			AND		D1.ACP_YR = S2.ACP_YR
			      																			AND		D1.CVPT_ACP_NO = S2.CVPT_ACP_NO
			      																			AND		S2.SUC_REQ_DVSN_CD = S3.REQ_DVSN_CD
			      																			AND		S2.SUC_ACP_YR = S3.ACP_YR
			      																			AND		S2.SUC_CVPT_ACP_NO = S3.CVPT_ACP_NO)
			      		ELSE D1.TIT_NM END AS TIT_NM
			      	,DECODE(D1.REQR_KND_CD,'1',D1.CVPTR_NM,'2',D1.RPST_PEN_NM,'3',D1.RPST_PEN_NM,'4',D1.CVPTR_NM) AS CVPTR_NM
			      	,TO_CHAR(D4.FNL_HNDL_DH, 'YYYY-MM-DD HH24:Mi:SS') AS FNL_HNDL_DH
			      	,F_CODE_NM('1000934',D1.CVPT_HNDL_STA_CD) AS CVPT_HNDL_STA_NM
			      	,(	SELECT	TO_CHAR(TO_DATE(TO_CHAR(D1.ACP_DH, 'YYYYMMDD'), 'YYYYMMDD') + NVL( S1.USR_DFN_TXT_2, 30), 'YYYY-MM-DD')
                    	FROM	TBDCMACM013C S1
                    	WHERE	S1.CMM_CD_DVSN_CD = '1000051'
                    	AND		S1.CD <> '000000000'
                    	AND     S1.CD  = D3.CVPT_HNDL_DVSN_CD) AS HNDL_LIMIT__DT
                    ,TO_CHAR(D1.ACP_DH + 30 + 
                        DECODE((
                            SELECT NVL(SUM(DECODE(NVL(Z3.APV_STA_CD,'0'), '30', '1', '0')),0)
                             FROM TBDCPDCP603M Z3
                             WHERE Z3.ACP_YR = D1.ACP_YR
                               AND Z3.REQ_DVSN_CD = D1.REQ_DVSN_CD
                               AND Z3.CVPT_ACP_NO = D1.CVPT_ACP_NO
                               AND Z3.RPRT_CD = 'G10200100'),0,0,10),'YYYY-MM-DD')  AS HNDL_LIMIT_DT_PRCS
                  	,D3.SRNO
                  	,D3.CVPT_HNDL_DVSN_CD
			  FROM TBDCPDCP101M D1
			      ,TBDCPDCP102M D2
			      ,TBDCPDCP205L D3
			      ,TBDCPDCP201M D4
			 WHERE 1=1
			   AND D1.REQ_DVSN_CD = '6'
			   AND D1.REQ_DVSN_CD = D2.REQ_DVSN_CD
			   AND D1.CVPT_ACP_NO = D2.CVPT_ACP_NO
			   AND D1.ACP_YR      = D2.ACP_YR
			   AND D1.REQ_DVSN_CD = D3.REQ_DVSN_CD
			   AND D1.CVPT_ACP_NO = D3.CVPT_ACP_NO
			   AND D1.ACP_YR      = D3.ACP_YR
			   AND D1.REQ_DVSN_CD = D4.REQ_DVSN_CD
			   AND D1.CVPT_ACP_NO = D4.CVPT_ACP_NO
			   AND D1.ACP_YR      = D4.ACP_YR
			   AND D1.CVPT_HNDL_STA_CD IN ('50','60')
			   AND (D3.REQ_DVSN_CD, D3.CVPT_ACP_NO, D3.ACP_YR, D3.SRNO ) IN (	SELECT	Z.REQ_DVSN_CD, Z.CVPT_ACP_NO, Z.ACP_YR, MIN(Z.SRNO)
			   																	FROM	TBDCPDCP205L Z
			   																	WHERE	D1.REQ_DVSN_CD = Z.REQ_DVSN_CD
			   																	AND		D1.CVPT_ACP_NO = Z.CVPT_ACP_NO
			   																	AND		D1.ACP_YR = Z.ACP_YR
			   																	GROUP BY Z.REQ_DVSN_CD, Z.CVPT_ACP_NO, Z.ACP_YR
			   																)
			   AND ( D3.CVPT_HNDL_DVSN_CD = '60' OR T_CVPT_HNDL_DVSN_CD = '14' )
			   AND (D1.REQ_DVSN_CD, D1.ACP_YR, D1.CVPT_ACP_NO) NOT IN (
	   														SELECT	SUC_REQ_DVSN_CD,SUC_ACP_YR,SUC_CVPT_ACP_NO
	   														FROM	TBDCPDCP105L
	   														)

		]]>
		<if test='usrId != "haahaasch"'>
			AND D4.HNDL_DPT_CD = #{dptCd}
			AND D4.HNDL_CHGR_ID = #{usrId}
		</if>
		<if test='titNm != null and titNm != ""'>
			AND D1.TIT_NM LIKE '%'||#{titNm}||'%'
		</if>

		<if test='acpDhs != null and acpDhs != ""'>
			AND TO_CHAR(D1.ACP_DH, 'YYYYMMDD') BETWEEN #{acpDhs} AND #{acpDhe}
		</if>

		<if test='cvptKndCd != null and cvptKndCd != ""'>
			AND D1.CVPT_KND_CD IN (SELECT
			SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL)
			-1) merge_col
			FROM DUAL A
			CROSS JOIN(SELECT ','|| #{cvptKndCd} ||',' AS CODE FROM DUAL) B
			CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
		</if>

		<!-- <if test='cvptHndlDvsnCd != null and cvptHndlDvsnCd != ""'>
			AND D3.CVPT_HNDL_DVSN_CD IN (SELECT
			SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL)
			-1) merge_col
			FROM DUAL A
			CROSS JOIN(SELECT ','|| #{cvptHndlDvsnCd} ||',' AS CODE FROM DUAL) B
			CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )

		</if> -->
		

		<if test='rmCvptAcpNo != null and rmCvptAcpNo != ""'>
			AND D1.RM_CVPT_ACP_NO = LPAD(#{rmCvptAcpNo}, 5, 0)
		</if>

		<if test='cvptrNm != null and cvptrNm != ""'>
			AND D1.CVPTR_NM LIKE '%'||#{cvptrNm}||'%'
		</if>
		AND D1.ACP_YR = NVL(#{acpYr}, D1.ACP_YR)
		AND D1.CVPT_HNDL_STA_CD = NVL(#{cvptHndlStaCd}, D1.CVPT_HNDL_STA_CD)
		ORDER BY D1.ACP_YR DESC
		, D1.RM_CVPT_ACP_NO DESC


		<include refid="include.pageOrder" />
	</select>


	<select id="DCP005006EMainCount" resultType="egovMap">
		/* kr.go.bai.eip.dcp.dcp.dao.DCP005006EMapper.DCP005006EMainCount */
		SELECT COUNT(1) AS
		TOTCNT
		,SUM(CASE WHEN D1.CVPT_HNDL_STA_CD = '50' THEN 1 ELSE 0 END ) AS NOTCM
		,SUM(CASE WHEN D1.CVPT_HNDL_STA_CD = '60' THEN 1 ELSE 0 END ) AS CM
		FROM TBDCPDCP101M D1
		,TBDCPDCP102M D2
		,TBDCPDCP205L D3
		,TBDCPDCP201M D4
		WHERE 1=1
		AND D1.REQ_DVSN_CD = D2.REQ_DVSN_CD(+)
		AND D1.CVPT_ACP_NO = D2.CVPT_ACP_NO(+)
		AND D1.ACP_YR = D2.ACP_YR(+)
		AND D1.REQ_DVSN_CD = D3.REQ_DVSN_CD(+)
		AND D1.CVPT_ACP_NO = D3.CVPT_ACP_NO(+)
		AND D1.ACP_YR = D3.ACP_YR(+)
		AND D1.REQ_DVSN_CD = D4.REQ_DVSN_CD(+)
		AND D1.CVPT_ACP_NO = D4.CVPT_ACP_NO(+)
		AND D1.ACP_YR = D4.ACP_YR(+)
		AND D1.CVPT_HNDL_STA_CD IN ('50', '60')
		AND D1.REQ_DVSN_CD = '6'
		AND D3.SRNO = 1
		AND D3.CVPT_HNDL_DVSN_CD IN ('10', '20', '50', '60')
	</select>

</mapper>
