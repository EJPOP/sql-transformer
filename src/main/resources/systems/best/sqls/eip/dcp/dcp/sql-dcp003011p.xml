<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.go.bai.eip.dcp.dcp.dao.DCP003011PMapper">

    <select id="selectEviDocbList" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.dcp.dcp.dao.DCP003001PMapper.selectEviDocbList*/
        /*증거서류함(그룹)*/
        <include refid="include.pageSelct" />
        SELECT
            ACP_YR  /*접수년도 */
            ,REQ_DVSN_CD /* 구분코드 */
            ,CVPT_ACP_NO /*접수번호 */
            ,EVI_DCMB_SNO   /*서류함순번 */
            ,FOLDER_NM  /*폴더명 */
            ,SORT_SNO   /*정렬순번 */
            ,FRT_USR_ID  /*최초사용자ID */
            ,F_USR_INFO_BY_ID(FRT_USR_ID,'2') AS FRT_USR_NM /*최초사용자ID명 */
            ,TO_CHAR(FRT_REGI_DH,'YYYY-MM-DD') FRT_REGI_DH  /*최초등록일시 */
            ,(SELECT COUNT(*) FROM TBDCPDCP608D D
            WHERE D.EVI_DCMB_SNO = A.EVI_DCMB_SNO
            AND A.ACP_YR = d.ACP_YR
            AND A.REQ_DVSN_CD = d.REQ_DVSN_CD
            AND A.CVPT_ACP_NO = d.CVPT_ACP_NO
            AND D.EVI_DCMB_DVSN_CD = #{eviDcmbDvsnCd} /*감사서류구분코드 10 : 증거서류,30 : 실지감사부속서류*/) AS CNT
            FROM TBDCPDCP608M A
          WHERE 1=1
            <if test='acpYr != null and acpYr != ""'>
                AND A.ACP_YR = #{acpYr}
            </if>
            <if test='reqDvsnCd != null and reqDvsnCd != ""'>
                AND A.REQ_DVSN_CD = #{reqDvsnCd}
            </if>
            <if test='cvptAcpNo != null and cvptAcpNo != ""'>
                AND A.CVPT_ACP_NO = #{cvptAcpNo}
            </if>
            ORDER BY SORT_SNO ASC
            <include refid="include.pageOrder" />
    </select>

    <select id="selectEviDocList" parameterType="paramMap" resultType="egovMap" >
        /*kr.go.bai.eip.dcp.dcp.dao.DCP003001PMapper.selectEviDocList*/
        /*증거서류*/
        <include refid="include.pageSelct" />
        SELECT
            ACP_DCM_DOC_ID	    /*서류문서ID */
            ,EVI_DCMB_SNO       /*서류함순번 */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,F_CODE_NM('1000776', A.EVI_DCM_DVSN_CD) AS EVI_DCM_DVSN_NM	/*증거서류구분코드 */
            ,FILE_NM	        /*파일명 */
            ,AFF_SNO	        /*사건순번 */
            --,TO_CHAR(TO_DATE(ISUE_DY,'YYYY-MM-DD'),'YYYY-MM-DD') AS ISUE_DY /*발부일자*/
            ,EVI_DCMB_DVSN_CD	/*감사서류구분코드 */
            ,F_CODE_NM('1000778', A.EVI_DCMB_DVSN_CD) AS EVI_DCMB_DVSN_NM /*서류구분코드 */
            ,SORT_SNO           /*정렬순번 */
            ,FRT_USR_ID         /*최초사용자ID */
            ,F_USR_INFO_BY_ID(FRT_USR_ID,'2') AS FRT_USR_NM /*최초사용자ID명 */
            ,TO_CHAR(FRT_REGI_DH,'YYYY-MM-DD') FRT_REGI_DH  /*최초등록일시 */
            FROM TBDCPDCP608D A
          WHERE A.ACP_YR = #{acpYr}
                AND A.REQ_DVSN_CD = #{reqDvsnCd}
                AND A.CVPT_ACP_NO = #{cvptAcpNo}
                AND A.EVI_DCMB_SNO = #{eviDcmbSno}
             ORDER BY (
                CASE EVI_DCM_DVSN_CD
                WHEN '20' THEN 1
                WHEN '10' THEN 2
                WHEN '30' THEN 3
                WHEN '40' THEN 4
                WHEN '50' THEN 5
                ELSE 6 
                END 
             ),
             SORT_SNO desc
         <include refid="include.pageOrder" />
    </select>

    <select id="selectMaxEviDcmbSno" parameterType="paramMap" resultType="egovMap">
        /*kr.go.bai.eip.aep.mac.dao.CSPDCP423PMapper.selectMaxEviDcmbSno*/
        /*감사서류함순번 MAX*/
        SELECT NVL(MAX(EVI_DCMB_SNO),0)+1 FROM TBDCPDCP608M
        WHERE A.ACP_YR = #{acpYr}
            <if test='acpYr != null and acpYr != ""'>
                AND A.ACP_YR = #{acpYr}
            </if>
    </select>

    <insert id="TBCSPDCP608MInsert" parameterType="paramMap">
        /*kr.go.bai.eip.dcp.dcp.dao.DCP003001PMapper.TBCSPDCP608MInsert*/
        /*증거서류함 Insert*/
        INSERT INTO TBDCPDCP608M
        (
            ACP_YR  /*접수년도 */
            ,REQ_DVSN_CD /*구분코드 */
            ,CVPT_ACP_NO /*접수번호 */
            ,EVI_DCMB_SNO   /*서류함순번 */
            ,FOLDER_NM  /*폴더명 */
            ,SORT_SNO   /*정렬순번 */
            ,FRT_USR_ID  /*최초사용자ID */
            ,FNL_USR_ID /*최종사용자ID */
            ,FNL_DEAL_DPT_CD    /*최종거래부서코드 */
            ,FNL_MNU_ID /*최종메뉴ID */
            ,FRT_REGI_DH    /*최초등록일시 */
            ,FNL_MDF_DH /*최종수정일시 */
        )
        values
        (
            #{acpYr}         /*접수년도 */
            ,#{reqDvsnCd}  /*구분코드 */
            ,#{cvptAcpNo}  /*접수번호 */
            ,(SELECT NVL(MAX(EVI_DCMB_SNO),0)+1 FROM TBCSPDCP608M)  /*서류함순번 */
            ,#{folderNm}  /*폴더명 */
            ,(SELECT NVL(MAX(SORT_SNO),0)+1
                 FROM TBDCPDCP608M
                  WHERE ACP_YR = #{acpYr}
                  AND REQ_DVSN_CD = #{reqDvsnCd}
                  AND CVPT_ACP_NO = #{cvptAcpNo} /*정렬순번 */
              )
            ,#{frtUsrId}  /*최초사용자id */
            ,#{fnlUsrId} /*최종사용자id */
            ,#{fnlDealDptCd}    /*최종거래부서코드 */
            ,#{fnlMnuId} /*최종메뉴id */
            ,SYSDATE    /*최초등록일시 */
            ,SYSDATE /*최종수정일시 */
        )
    </insert>

    <update id="TBCSPDCP608MUpdate" parameterType="paramMap">
    /*kr.go.bai.eip.dcp.dcp.dao.DCP003001PMapper.TBCSPDCP608MUpdate*/
    /*증거서류함 Update*/
        UPDATE TBDCPDCP608M
           SET FOLDER_NM = #{folderNm} /*폴더명 */
          ,
               SORT_SNO = #{sortSno} /*정렬순번 */
          ,
               FNL_USR_ID = #{fnlUsrId} /*최종사용자ID */
          ,
               FNL_DEAL_DPT_CD = #{fnlDealDptCd} /*최종거래부서코드 */
          ,
               FNL_MNU_ID = #{fnlMnuId} /*최종메뉴ID */
          ,
               FNL_MDF_DH = sysdate /*최종수정일시 */
         WHERE EVI_DCMB_SNO = #{eviDcmbSno} /*서류함순번 */
            <if test='acpYr != null and acpYr != ""'>
                AND ACP_YR = #{acpYr}
            </if>
            <if test='reqDvsnCd != null and reqDvsnCd != ""'>
                AND REQ_DVSN_CD = #{reqDvsnCd}
            </if>
            <if test='cvptAcpNo != null and cvptAcpNo != ""'>
                AND CVPT_ACP_NO = #{cvptAcpNo}
            </if>
    </update>

    <delete id="TBCSPDCP608MDelete" parameterType="paramMap">
    /*kr.go.bai.eip.dcp.dcp.dao.DCP003001PMapper.TBCSPDCP608MDelete*/
    /*증거서류함 Delete*/
        DELETE FROM TBDCPDCP608M
        WHERE EVI_DCMB_SNO = #{eviDcmbSno} /*서류함순번 */
            <if test='acpYr != null and acpYr != ""'>
                AND ACP_YR = #{acpYr}
            </if>
            <if test='reqDvsnCd != null and reqDvsnCd != ""'>
                AND REQ_DVSN_CD = #{reqDvsnCd}
            </if>
            <if test='cvptAcpNo != null and cvptAcpNo != ""'>
                AND CVPT_ACP_NO = #{cvptAcpNo}
            </if>
            <if test='eviDcmbSno != null and eviDcmbSno != ""'>
                AND EVI_DCMB_SNO  = #{eviDcmbSno}
            </if>

    </delete>

    <insert id="TBCSPDCP608DInsert" parameterType="paramMap">
        /*kr.go.bai.eip.dcp.dcp.dao.DCP003001PPMapper.TBCSPDCP608DInsert*/
        /*증거서류 Insert*/
        INSERT INTO TBDCPDCP608D
        (
            ACP_YR /*접수년도 */
            ,REQ_DVSN_CD /*구분코드 */
            ,CVPT_ACP_NO /*접수번호*/
            ,EVI_DCMB_SNO	/*서류함순번 */
            ,ACP_DCM_DOC_ID	/*서류문서ID */
            ,EVI_DCM_DVSN_CD	/*증거서류구분코드 */
            ,FILE_NM	/*파일명 */
            ,EVI_DCMB_DVSN_CD	/*서류구분코드 */
            ,AFF_SNO	/*사건순번 */
            ,ACP_DCM_CRE_ID	/*서류생성자ID */
            ,SORT_SNO	/*정렬순번 */
            ,FRT_USR_ID	/*최초사용자ID */
            ,FNL_USR_ID	/*최종사용자ID */
            ,FNL_DEAL_DPT_CD	/*최종거래부서코드 */
            ,FNL_MNU_ID	/*최종메뉴ID */
            ,FRT_REGI_DH	/*최초등록일시 */
            ,FNL_MDF_DH	/*최종수정일시  */
            ,FILE_SIZE
        )
        values
        (
            #{acpYr}        /*접수년도 */
            ,#{reqDvsnCd} /*구분코드 */
            ,#{cvptAcpNo} /*접수번호 */
            ,#{eviDcmbSno}  /*감사서류함순번 */
            ,#{acpDcmDocId}  /*서류문서ID */
            ,#{eviDcmDvsnCd}	/*증거서류구분코드 */
            ,#{fileNm}	/*파일명 */
            ,#{eviDcmbDvsnCd}   /*서류구분코드 */
            ,#{affSno}	/*사건순번 */
            ,#{frtUsrId} /*감사서류생성자ID(최초사용자id) */
            ,(SELECT NVL(MAX(SORT_SNO),0)+1
                 FROM TBDCPDCP608D
                  WHERE ACP_YR = #{acpYr}
                  AND REQ_DVSN_CD = #{reqDvsnCd}
                  AND CVPT_ACP_NO = #{cvptAcpNo}
                  AND EVI_DCMB_SNO = #{eviDcmbSno} /*정렬순번 */
              )
            ,#{frtUsrId}  /*최초사용자id */
            ,#{fnlUsrId} /*최종사용자id */
            ,#{fnlDealDptCd}    /*최종거래부서코드 */
            ,#{fnlMnuId} /*최종메뉴id */
            ,SYSDATE    /*최초등록일시 */
            ,SYSDATE /*최종수정일시 */
            ,#{fileSize}
        )
    </insert>

    <delete id="TBCSPDCP608DDelete" parameterType="paramMap">
    /*kr.go.bai.eip.dcp.dcp.dao.DCP003001PMapper.TBCSPDCP608DDelete*/
    /*증거서류 Delete*/
        DELETE FROM TBDCPDCP608D
        WHERE EVI_DCMB_SNO = #{eviDcmbSno} /*감사서류함순번 */
            <if test='acpYr != null and acpYr != ""'>
                AND ACP_YR = #{acpYr}
            </if>
            <if test='reqDvsnCd != null and reqDvsnCd != ""'>
                AND REQ_DVSN_CD = #{reqDvsnCd}
            </if>
            <if test='cvptAcpNo != null and cvptAcpNo != ""'>
                AND CVPT_ACP_NO = #{cvptAcpNo}
            </if>
            <if test='eviDcmbSno != null and eviDcmbSno != ""'>
                AND EVI_DCMB_SNO  = #{eviDcmbSno}
            </if>
            <if test='acpDcmDocId != null and acpDcmDocId != ""'>
                AND ACP_DCM_DOC_ID  = #{acpDcmDocId}
            </if>
    </delete>

    <select id="chkFileTBBADDED110M" parameterType="paramMap" resultType="Integer">
    /*kr.go.bai.eip.dcp.dcp.dao.DCP003001PMapper.chkFileTBBADDED110M*/
    /*증거서류 매핑테이블 존재여부*/
        	SELECT COUNT(*) 
            FROM TBDCPDCP608D A 
            INNER JOIN TBDCPDCP608M B
            ON(A.ACP_YR = B.ACP_YR
                AND A.REQ_DVSN_CD = B.REQ_DVSN_CD
                AND A.CVPT_ACP_NO = B.CVPT_ACP_NO
                AND A.EVI_DCMB_SNO  = B.EVI_DCMB_SNO)
        	WHERE A.ACP_YR = #{acpYr}
            AND A.REQ_DVSN_CD = #{reqDvsnCd}
            AND A.CVPT_ACP_NO = #{cvptAcpNo}
            <if test='eviDcmbSno != null and eviDcmbSno != ""'>
                <if test='type == null or type == ""'>
                    AND B.EVI_DCMB_SNO = #{eviDcmbSno}
                </if>
            </if>
            <if test='acpDcmDocId != null and acpDcmDocId != ""'>
                <if test="type != '' and type eq 'docId'.toString()">
                    AND A.ACP_DCM_DOC_ID = #{acpDcmDocId}
                </if>
            </if>
    </select>

	<insert id="TBCSPDCP608MInsertInit" parameterType="paramMap">
	/*kr.go.bai.eip.dcp.dcp.dao.DCP003001PMapper.TBCSPDCP608MInsertInit*/
	        /*증거서류함 Insert*/
	        INSERT INTO TBDCPDCP608M
	        (
	            ACP_YR  /*접수년도 */
	            ,REQ_DVSN_CD /*구분코드 */
	            ,CVPT_ACP_NO /*접수번호 */
	            ,EVI_DCMB_SNO   /*서류함순번 */
	            ,FOLDER_NM  /*폴더명 */
	            ,SORT_SNO   /*정렬순번 */
	            ,FRT_USR_ID  /*최초사용자ID */
	            ,FNL_USR_ID /*최종사용자ID */
	            ,FNL_DEAL_DPT_CD    /*최종거래부서코드 */
	            ,FNL_MNU_ID /*최종메뉴ID */
	            ,FRT_REGI_DH    /*최초등록일시 */
	            ,FNL_MDF_DH /*최종수정일시 */
	        )
	        values
	        (
	            #{acpYr}         /*접수년도 */
	            ,#{reqDvsnCd}  /*구분코드 */
	            ,#{cvptAcpNo}  /*접수번호 */
	            ,(SELECT NVL(MAX(EVI_DCMB_SNO),0)+1 FROM TBDCPDCP608M)  /*서류함순번 */
	            ,(SELECT CASE WHEN REQ_DVSN_CD = '9' THEN ACP_YR||'-이해-'|| RM_CVPT_ACP_NO
   					     ELSE ACP_YR ||'-청금-'|| RM_CVPT_ACP_NO
   					     END 
                	FROM TBDCPDCP101M
               	 	WHERE ACP_YR = #{acpYr}
                  	AND REQ_DVSN_CD = #{reqDvsnCd}
                  	AND CVPT_ACP_NO = #{cvptAcpNo}
             	)	  			/*폴더명 */
	            ,(SELECT NVL(MAX(SORT_SNO),0)+1
	                 FROM TBDCPDCP608M
	                  WHERE ACP_YR = #{acpYr}
	                  AND REQ_DVSN_CD = #{reqDvsnCd}
	                  AND CVPT_ACP_NO = #{cvptAcpNo} /*정렬순번 */
	              )
	            ,#{frtUsrId}  /*최초사용자id */
	            ,#{fnlUsrId} /*최종사용자id */
	            ,#{fnlDealDptCd}    /*최종거래부서코드 */
	            ,#{fnlMnuId} /*최종메뉴id */
	            ,SYSDATE    /*최초등록일시 */
	            ,SYSDATE /*최종수정일시 */
	        )
    </insert>
</mapper>
