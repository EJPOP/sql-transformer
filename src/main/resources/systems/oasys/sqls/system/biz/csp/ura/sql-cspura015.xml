<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/ura/015">
	<select id="CSPURA015ESelectInfo" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			WITH DATA AS (
				SELECT 	DISTINCT C.STD_YE
						, C.CNB
						, NVL(A.CNT, 0) AS ROLE1
						, NVL(B.CNT, 0) AS ROLE2
				FROM	(
						SELECT	COUNT(A.STD_YE) CNT
								, A.STD_YE
								, B.CNB
						FROM	TBCSPURA008M A
								, TBCSPURA009D B
						WHERE	B.STD_YE = A.STD_YE
						AND		B.STD_SLN = A.STD_SLN
						AND		B.ROLE_DVSN_CD = '1'
						GROUP BY A.STD_YE, B.CNB
						) A
						, (
						SELECT	COUNT(A.STD_YE) CNT
								, A.STD_YE
								, B.CNB
						FROM	TBCSPURA008M A
								, TBCSPURA009D B
						WHERE	B.STD_YE = A.STD_YE
						AND		B.STD_SLN = A.STD_SLN
						AND		B.ROLE_DVSN_CD = '2'
						GROUP BY A.STD_YE, B.CNB
						) B,
						TBCSPURA009D C
				WHERE 	C.STD_YE = A.STD_YE(+)
				AND		C.CNB = A.CNB(+)
				AND 	C.STD_YE = B.STD_YE(+)
				AND		C.CNB = B.CNB(+)
			)
			
			SELECT	(SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD = (SELECT DPT_CD FROM TBDCMACM001M WHERE CNB = B.CNB)) AS DPT_NM
					, (SELECT USR_NAM FROM TBDCMACM001M WHERE CNB = B.CNB) AS USR_NAM
					, (SELECT CD_NM FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000173' AND CD = (SELECT RANK_CD FROM TBDCMACM001M WHERE CNB = B.CNB)) AS RANK_NM
					, (SELECT ROLE1 FROM DATA D1 WHERE D1.CNB = B.CNB AND D1.STD_YE = A.STD_YE) AS ROLE1
					, (SELECT ROLE2 FROM DATA D1 WHERE D1.CNB = B.CNB AND D1.STD_YE = A.STD_YE) AS ROLE2
					, (SELECT ROLE1 FROM DATA D1 WHERE D1.CNB = B.CNB AND D1.STD_YE = A.STD_YE) +
					  (SELECT ROLE2 FROM DATA D1 WHERE D1.CNB = B.CNB AND D1.STD_YE = A.STD_YE) AS TOT
					, B.ROLE_DVSN_CD
					, A.STD_DVSN_TXT
					, A.STD_TASK_NM
					, A.TASK_TYP_NM
					, A.STD_PRD_TXT
					, A.STD_MNTH_CNT
					, A.RT
					, C.PLN_ACMP_DVSN_CD
					, C.MN_1_TXT
					, C.MN_2_TXT
					, C.MN_3_TXT
					, C.MN_4_TXT
					, C.MN_5_TXT
					, C.MN_6_TXT
					, C.MN_7_TXT
					, C.MN_8_TXT
					, C.MN_9_TXT
					, C.MN_10_TXT
					, C.MN_11_TXT
					, MN_12_TXT
					, MN_1_PT_NM
					, MN_2_PT_NM
					, MN_3_PT_NM
					, MN_4_PT_NM
					, MN_5_PT_NM
					, MN_6_PT_NM
					, MN_7_PT_NM
					, MN_8_PT_NM
					, MN_9_PT_NM
					, MN_10_PT_NM
					, MN_11_PT_NM
					, MN_12_PT_NM
					, A.RMK_SBJ
					, A.STD_YE
					, A.STD_SLN
			FROM	TBCSPURA008M A
					, TBCSPURA009D B
					, TBCSPURA010D C
			WHERE	B.STD_YE = A.STD_YE
			AND		B.STD_SLN = A.STD_SLN
			AND		C.STD_YE = A.STD_YE
			AND		C.STD_SLN = A.STD_SLN
			AND		A.STD_YE = #fromSTD_YE#
		]]>	
		<isNotEmpty property="strDPT_CD">
			AND		B.CNB IN (SELECT 	CNB
					  FROM		TBDCMACM001M
					  WHERE		DPT_CD = #strDPT_CD#)
		</isNotEmpty>
		<isNotEmpty property="strROLE_DVSN_CD">
			AND		B.ROLE_DVSN_CD = #strROLE_DVSN_CD#
		</isNotEmpty>
		<isNotEmpty property="strTASK_TYP_NM">
			AND		A.TASK_TYP_NM LIKE '%' || #strTASK_TYP_NM# || '%'		
		</isNotEmpty>
		<isNotEmpty property="strUSR_NAM">
			AND 	B.CNB IN (SELECT 	CNB
				  FROM		TBDCMACM001M
				  WHERE		USR_NAM LIKE '%' || #strUSR_NAM# || '%')
		</isNotEmpty>
		<isNotEmpty property="strSTD_TASK_NM">
			AND		A.STD_TASK_NM LIKE '%' || #strSTD_TASK_NM# || '%'
		</isNotEmpty>
		<isNotEmpty property="strRMK_SBJ">
			AND		A.RMK_SBJ LIKE '%' || #strRMK_SBJ# || '%'
		</isNotEmpty>
		<![CDATA[
			ORDER BY A.STD_YE, DPT_NM,RANK_NM, USR_NAM, A.RT, A.STD_TASK_NM, C.PLN_ACMP_DVSN_CD
		]]>	
	</select>
</sqlMap> 
