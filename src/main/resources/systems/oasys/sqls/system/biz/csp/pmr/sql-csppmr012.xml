<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/pmr/012">
	<!-- 담당자 여부체크 -->
	<select id="CSPPMR012EMCntselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT TO_CHAR(COUNT(*)) AS CNT
			  FROM TBCSPPMR012M 
			 WHERE 1 = 1
			   AND CHGR_CNB     = #strCnb#
		]]>
	</select>
	<select id="CSPPMR012EMainSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT  DPT_CD,
					F_DPT_INFO(DPT_CD, '1')   AS DPT_NM,      /*소속부서명*/
					CHGR_CNB,
					CHGR_CNB AS CHGR_CNB_BAK,
					F_USR_INFO(CHGR_CNB, '2')     AS NAM,     /*성명*/ 
					(SELECT TNB FROM TBDCMACM001M WHERE CNB = CHGR_CNB) AS TNB,
					RANK_CD,
					F_CODE_NM('1000173', RANK_CD) AS RANK_NAM
			  FROM TBCSPPMR012M
			 WHERE 1=1
		]]>
		<dynamic>
			<isNotEmpty property="strDptCd">
				AND DPT_CD = #strDptCd#
			</isNotEmpty>			
			<isNotEmpty property="cnb">
				AND CHGR_CNB  = #cnb#
			</isNotEmpty>
		</dynamic>
		
		ORDER BY DPT_CD
	</select>
	<!-- 담당자 상세정보 삭제 -->
	<delete id="CSPPMR012Edelete" parameterClass="paramMap">
		DELETE TBCSPPMR012M
		 WHERE 1=1
		   AND CHGR_CNB   = #CHGR_CNB#
		   AND DPT_CD     = #DPT_CD#
	</delete>	
	
	<!-- 신규등록전 중복데이터 유무 체크 -->
	<select id="CSPPMR012ECntselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT TO_CHAR(COUNT(*)) AS CNT
			  FROM TBCSPPMR012M 
			 WHERE 1 = 1
			   AND DPT_CD     = #DPT_CD#
		]]>
	</select>
	
	<!-- 담당자관리_담당자 상세 신규등록 -->
	<insert id="CSPPMR012Einsert" parameterClass="paramMap">
		INSERT INTO TBCSPPMR012M
			(
				  CHGR_CNB
				, DPT_CD
				, RANK_CD
				, FRT_USR_ID
				, FNL_USR_ID
				, FNL_DEAL_DPT_CD
				, FNL_MNU_ID
				, FRT_REGI_DH
				, FNL_MDF_DH
			) 
			VALUES
			(
				  #CHGR_CNB#
				, #DPT_CD#
				, #RANK_CD#
				, #FRT_USR_ID#
				, #FNL_USR_ID#
				, #FNL_DEAL_DPT_CD#
				, #FNL_MNU_ID#
				, SYSDATE
				, SYSDATE
			)
	</insert>
	
	<!-- 예약관리자를 등록한다.-->
	<update id="CSPPMR012Eupdate" parameterClass="paramMap">
		UPDATE TBCSPPMR012M
	       SET 
	       	   FNL_MDF_DH = SYSDATE
		     , DPT_CD     = F_USR_INFO(#CHGR_CNB#, '5')
		     , CHGR_CNB   = #CHGR_CNB#
			<isNotEmpty prepend="," property="FNL_USR_ID">
				FNL_USR_ID = #FNL_USR_ID#
			</isNotEmpty>
			<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
				FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
			</isNotEmpty>
			<isNotEmpty prepend="," property="FNL_MNU_ID">
				FNL_MNU_ID = #FNL_MNU_ID#
			</isNotEmpty>
		 WHERE 1=1
		   AND CHGR_CNB   = #CHGR_CNB_BAK#
		   AND DPT_CD     = #DPT_CD#
	</update>
	
</sqlMap> 
