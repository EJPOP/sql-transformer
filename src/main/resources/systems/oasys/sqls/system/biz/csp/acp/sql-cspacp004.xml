<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/acp/004">
	
	<!-- 물품소모품요청 목록 조회 -->
	<select id="CSPACP004QMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[  /* csp/acp/004/CSPACP004QMainSelect */ ]]>
		<include refid = "include.pageSelct"/>
        <![CDATA[
			SELECT  A.GDS_RQS_SNO,      /*물품요청순번*/
			        A.RQS_DT,           /*요청일*/
			        D.ABR_DPT_NM_1 AS RQS_DPT_NM,   /*요청자부서명*/
			        B.USR_NAM AS RQR_NAM,   /*요청자명*/
			        A.RQS_TIT_NM,       /*요청제목*/
			        C.USR_NAM AS HNDL_PEN_NAM,  /*처리자명*/
			        A.HNDL_DT,          /*처리일자*/
			        A.RQR_CNB,          /*요청자전산번호*/
			        A.HNDL_PEN_CNB,     /*처리자전산번호*/
			        A.RQS_DPT_CD,        /*처리자부서코드*/
			        A.HNDL_TXT	/*처리결과*/
			FROM    TBCSPACP001M A,
			        TBDCMACM001M B,
			        TBDCMACM001M C,
			        TBDCMACM002M D
			WHERE   A.RQR_CNB = B.CNB(+)
			AND     A.HNDL_PEN_CNB = C.CNB(+)
			AND     A.RQS_DPT_CD = D.DPT_CD(+)
			AND		A.GDS_KBN='2'
			]]>
			<dynamic>
				<isNotEqual property="strAUTH_CD" compareValue="ALL">
	        		<isNotEmpty property="strRQR_DPT_CD">
				        AND	 A.RQS_DPT_CD = #strRQR_DPT_CD#
				    </isNotEmpty>
	        	</isNotEqual>
			    <isNotEmpty property="strRQS_DTS">
			        AND	A.RQS_DT &gt;= #strRQS_DTS#
			    </isNotEmpty>
			    <isNotEmpty property="strRQS_DTE">
			        AND	A.RQS_DT &lt;= #strRQS_DTE#
			    </isNotEmpty>
			    <isNotEmpty property="strSEARCH_NM">
			        AND	(D.DPT_NM LIKE '%'||#strSEARCH_NM#||'%'
			                OR A.RQS_TIT_NM LIKE '%'||#strSEARCH_NM#||'%'
			                OR A.RQS_TXT LIKE '%'||#strSEARCH_NM#||'%'
			                OR A.HNDL_TXT LIKE '%'||#strSEARCH_NM#||'%')
			    </isNotEmpty>
			    <isNotEmpty property="strRQR_NAM">
			        AND B.USR_NAM LIKE '%'||#strRQR_NAM#||'%'
			    </isNotEmpty>
			    <isNotEmpty property="strHNDL_PEN_NAM">
			        AND	C.USR_NAM LIKE '%'||#strHNDL_PEN_NAM#||'%'
			    </isNotEmpty>
			    <isEqual property="strRESULT_CD" compareValue="1">
			        AND	A.HNDL_DT IS NULL
			    </isEqual>
			    <isEqual property="strRESULT_CD" compareValue="2">
			        AND	A.HNDL_DT IS NOT NULL
			    </isEqual>
			   
			    
			</dynamic>
        <![CDATA[
        	ORDER BY TO_NUMBER(A.GDS_RQS_SNO) DESC
        ]]>
        <include refid = "include.pageOrder"/> 
	</select>
	
	
	<!-- 물품소모품요청 목록 엑셀다운 -->
	<select id="CSPACP004QExcelExportSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[  /* csp/acp/004/CSPACP004QExcelExportSelect */ ]]>
        <![CDATA[
			SELECT ROWNUM, AA.* FROM 
				(SELECT 	/*CSPACP004QExcelExportSelect*/
			        GDS_RQS_SNO,        /*물품요청순번*/
			        TO_CHAR(TO_DATE(A.RQS_DT),'YYYY-MM-DD') AS RQS_DT,		/*요청일자*/
			        D.DPT_NM AS RQS_DPT_NM,	/*요청자부서명*/
			        B.USR_NAM AS RQR_NAM,	/*요청자명*/
			        A.RQS_TIT_NM,			/*요청제목*/
			        C.USR_NAM AS HNDL_PEN_NAM,	/*처리담당자명*/
			        TO_CHAR(TO_DATE(A.HNDL_DT),'YYYY-MM-DD') AS HNDL_DT,	/*처리일자*/
			        A.HNDL_TXT,	/*처리결과*/
			        A.RQS_TXT	/*요청내용*/
			FROM   	TBCSPACP001M A,			/*물품수리요청기본*/
			        TBDCMACM001M B, 		/*사용자테이블(요청자)*/
			        TBDCMACM001M C,			/*사용자테이블(처리자)*/
			        TBDCMACM002M D
			WHERE	A.RQR_CNB = B.CNB(+)
			AND		A.HNDL_PEN_CNB = C.CNB(+)
			AND		A.RQS_DPT_CD = D.DPT_CD(+)
			AND		A.GDS_KBN='2'
        ]]>
        <dynamic>
        	<isNotEqual property="strAUTH_CD" compareValue="ALL">
        		<isNotEmpty property="strRQR_DPT_CD">
			        AND	 A.RQS_DPT_CD = #strRQR_DPT_CD#
			    </isNotEmpty>
        	</isNotEqual>
        	<isNotEmpty property="strRQS_DTS">
        		AND	A.RQS_DT &gt;= #strRQS_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strRQS_DTE">
        		AND	A.RQS_DT &lt;= #strRQS_DTE#
        	</isNotEmpty>
        	<isNotEmpty property="strSEARCH_NM">
        		AND	(D.DPT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.RQS_TIT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.RQS_TXT LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.HNDL_TXT LIKE '%'||#strSEARCH_NM#||'%')
        	</isNotEmpty>
        	<isNotEmpty property="strRQR_NAM">
        		AND B.USR_NAM LIKE '%'||#strRQR_NAM#||'%'
        	</isNotEmpty>
        	<isNotEmpty property="strHNDL_PEN_NAM">
        		AND	C.USR_NAM LIKE '%'||#strHNDL_PEN_NAM#||'%'
        	</isNotEmpty>
        	<isEqual property="strRESULT_CD" compareValue="1">
        		AND	A.HNDL_DT IS NULL
        	</isEqual>
        	<isEqual property="strRESULT_CD" compareValue="2">
        		AND	A.HNDL_DT IS NOT NULL
        	</isEqual>
        </dynamic>
        <![CDATA[
        	ORDER BY TO_NUMBER(A.GDS_RQS_SNO) DESC ) AA
        ]]>
	</select>
	
	
	<!-- 물품소모품요청 상세 조회 -->
	<select id="CSPACP004EDetailSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[  /* csp/acp/004/CSPACP004EDetailSelect */ ]]>
        <![CDATA[
			SELECT	A.GDS_RQS_SNO,		/*물품요청순번*/ 
			        A.RQS_DT,		/*요청일*/ 
			        A.RQR_CNB,		/*요청자전산번호*/
			        (SELECT USR_NAM 
			        FROM TBDCMACM001M Z
			        WHERE A.RQR_CNB = Z.CNB
			        ) AS RQR_NAM,		/*요청자명*/
			        A.RQS_TIT_NM,	/*요청제목명*/
			        A.RQS_TXT, 		/*요청내용*/
			        A.HNDL_DT, 		/*처리일*/
			        A.HNDL_PEN_CNB, 	/*처리자전산번호*/
			        (SELECT USR_NAM 
			        FROM TBDCMACM001M Z
			        WHERE A.HNDL_PEN_CNB = Z.CNB
			        ) AS HNDL_PEN_NAM,		/*처리자명*/
			        A.HNDL_TXT, 		/*처리내용*/
			        F_DPT_INFO(A.RQS_DPT_CD,'1') AS RQS_DPT_NM,
			        (SELECT	TNB
			        FROM	TBDCMACM001M
			        WHERE	CNB = A.RQR_CNB ) AS TNB,
			        A.HNDL_PEN_CNB AS OLD_HNDL_PEN_CNB
			FROM	TBCSPACP001M A
        	WHERE 	A.GDS_RQS_SNO = #strGDS_RQS_SNO# AND A.GDS_KBN='2'
		]]>
	</select>
	
	
	<!-- 전산장애 요청 년도, 요청연번 Max값 가져오기 -->
	<select id="CSPACP004EKeySelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[  /* csp/acp/004/CSPACP004EKeySelect */ ]]>
        <![CDATA[     	
			SELECT  TO_CHAR(NVL(MAX(TO_NUMBER(GDS_RQS_SNO)),0)+1) AS GDS_RQS_SNO
			FROM    TBCSPACP001M WHERE GDS_KBN='2'
		]]>
	</select>
	
	
	<insert id="CSPACP004EMainInsert" parameterClass="paramMap">
		<![CDATA[  /* csp/acp/004/CSPACP004EMainInsert */ ]]>
        <![CDATA[
        	INSERT INTO TBCSPACP001M
        	(		
        			GDS_KBN,
        			GDS_RQS_SNO,	/*물품요청순번*/
        			RQS_DT,			/*요청일*/
        			RQS_DPT_CD,		/*요청부서*/
        			RQR_CNB,		/*요청자전산번호*/
        			RQS_TIT_NM,		/*요청제목명*/
        			RQS_TXT,		/*요청내용*/
        			FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH
        	) VALUES (
        			'2', /*소모품*/
        			#GDS_RQS_SNO#,
	        		#RQS_DT#,
	        		F_USR_INFO(#RQR_CNB#,'5'),
	        		#RQR_CNB#,
	        		#RQS_TIT_NM#,
	        		#RQS_TXT#,
	        		#FRT_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
					SYSDATE
        	)
        ]]>
	</insert>
	
	
	
	
	
	
	<update id="CSPACP004EMainUpdate" parameterClass="paramMap">
		<![CDATA[  /* csp/acp/004/CSPACP004EMainUpdate */ ]]>
		<![CDATA[
			UPDATE 	TBCSPACP001M
			SET		RQS_DT = #RQS_DT#,			/*요청일*/
					RQR_CNB = #RQR_CNB#,		/*요청자전산번호*/
					RQS_DPT_CD = F_USR_INFO(#RQR_CNB#,'5'),	/*요청자부서코드*/
					RQS_TIT_NM = #RQS_TIT_NM#,	/*요청제목명*/
					RQS_TXT = #RQS_TXT#,		/*요청내용*/
					HNDL_DT = #HNDL_DT#,	/*처리일*/
					HNDL_PEN_CNB = #HNDL_PEN_CNB#, /*처리자전산번호*/
					HNDL_TXT = #HNDL_TXT#,	/*처리내용*/
					FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE
			WHERE	GDS_RQS_SNO = #GDS_RQS_SNO# AND GDS_KBN = '2'
		]]>
	</update>
	
	
	<delete id="CSPACP004EMainDelete" parameterClass="paramMap">
		<![CDATA[  /* csp/acp/004/CSPACP004EMainDelete */ ]]>
		<![CDATA[
			DELETE	TBCSPACP001M
			WHERE	GDS_RQS_SNO = #GDS_RQS_SNO# AND GDS_KBN = '2'
		]]>
	</delete>
	
	<!-- 물품소모품요청 목록 조회 -->
	<select id="CSPACP004MainPSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[  /* csp/acp/004/CSPACP004MainPSelect */ ]]>
        <![CDATA[
            SELECT	
        			TO_CHAR(TO_DATE(A.RQS_DT),'YYYY-MM-DD') AS RQS_DT,	/*요청일*/ 
        			A.RQR_CNB,		/*요청자전산번호*/
        			(   SELECT  S1.ABR_DPT_NM_1
                        FROM    TBDCMACM002M S1
                        WHERE   S1.DPT_CD = A.RQS_DPT_CD
        			) ||' '|| 
        			(   SELECT  Z.USR_NAM 
                        FROM    TBDCMACM001M Z
                        WHERE   A.RQR_CNB = Z.CNB
        			) AS RQR_NAM,		/*요청자명*/
        			A.RQS_TIT_NM,	/*요청제목명*/
			 		A.RQS_TXT, 		/*요청내용*/
			 		TO_CHAR(TO_DATE(A.HNDL_DT),'YYYY-MM-DD') AS HNDL_DT, 		/*처리일*/
			 		A.HNDL_PEN_CNB, 	/*처리자전산번호*/
			 		(   SELECT  F_DPT_INFO(Z.DPT_CD,'4')||' '||USR_NAM 
                        FROM    TBDCMACM001M Z
                        WHERE   A.HNDL_PEN_CNB = Z.CNB
        			) AS HNDL_PEN_NAM,		/*처리자명*/
			 		A.HNDL_TXT 		/*처리내용*/
        	FROM	TBCSPACP001M A
        	WHERE 	A.GDS_RQS_SNO = #strGDS_RQS_SNO#
        			AND A.GDS_KBN = '2' /*소모품*/
		]]>
	</select>
	
	
	
</sqlMap>