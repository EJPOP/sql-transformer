<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/cmr/021">

	<!-- 동일한 모니터링 제목이 있는지 체크한다. -->
	<select id="BADCMR021ECntselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			 SELECT TO_CHAR(COUNT(*)) AS CNT
			   FROM TBBADCMR011M
			  WHERE TRIM(MNT_TIT_NM) = TRIM(#MNT_TIT_NM#)
		]]>
	</select>
	
	<!-- 신규등록할 법령연도, 법령모니터링순번을 가져온다. -->
	<select id="BADCMR021EInsertKeyselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			  SELECT TO_CHAR(NVL(MAX(LAW_MNT_SNO), 0) + 1) AS LAW_MNT_SNO 
                   , TO_CHAR(SYSDATE, 'YYYY')              AS LAW_YE
			    FROM TBBADCMR011M 
			   WHERE LAW_YE = TO_CHAR(SYSDATE, 'YYYY') 
		]]>
	</select>
	
	<!-- 법령모니터링 신규 등록한다. -->
	<insert id="BADCMR021Emaininsert" parameterClass="paramMap" >
		INSERT INTO TBBADCMR011M
			(
			  LAW_YE
			, LAW_MNT_SNO
			, MTRL_CAT_CD
			, MTRL_OGN_DT
			, AUD_MNT_HNDL_STA_CD
			, BLE_DIV_DPT_CD
			, CHGD_DPT_CD
			, COPT_GD_CD
			, LAW_KND_CD
			, MNT_TIT_NM
			, MNT_TXT
			, CBT_CFR_BILL_DT
			, CBT_CFR_TXT
			, REGI_DT
			, REGI_DPT_CD
			, LAW_URL_AD
			, LAW_LNK_ID
			, LAW_URL_AD_1
			, LAW_LNK_ID_1
			, OPIN_DTM_DT
			, MDF_DT
			, MDF_PEN_CNB
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
			)		
		VALUES
			(
			  #LAW_YE#
			, TO_NUMBER(#LAW_MNT_SNO#)
			, #MTRL_CAT_CD#
			, TO_CHAR(SYSDATE, 'YYYYMMDD')
			, #AUD_MNT_HNDL_STA_CD#
			, #BLE_DIV_DPT_CD#
			, #CHGD_DPT_CD#
			, #COPT_GD_CD#
			, #LAW_KND_CD#
			, #MNT_TIT_NM#
			, #MNT_TXT#
			, #CBT_CFR_BILL_DT#
			, #CBT_CFR_TXT#
			, TO_CHAR(SYSDATE, 'YYYYMMDD')
			, #FNL_DEAL_DPT_CD#
			, #LAW_URL_AD#
			, #LAW_LNK_ID#
			, #LAW_URL_AD_1#
			, #LAW_LNK_ID_1#
			, #OPIN_DTM_DT#
			, #MDF_DT#
			, #MDF_PEN_CNB#
			, #FRT_USR_ID#
			, #FNL_USR_ID#
			, #FNL_DEAL_DPT_CD#
			, #FNL_MNU_ID#
			, SYSDATE
			, SYSDATE			
			)
	</insert> 
	
	<!-- 처리기한을 변경 -->
	<update id="BADCMR021EMtrlCatDtupdate">
		UPDATE TBDCMACM013C
	       SET FNL_MDF_DH = SYSDATE
		     , USR_DFN_TXT_1 = #strMtrlCatDt#
		<isNotEmpty prepend="," property="FNL_USR_ID">
			FNL_USR_ID = #FNL_USR_ID#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
			FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_MNU_ID">
			FNL_MNU_ID = #FNL_MNU_ID#
		</isNotEmpty>
		WHERE 1 = 1
		  AND CMM_CD_DVSN_CD = '1000253' /*법령모니터링자료분류코드*/
		  AND CD             = #strMtrlCatCd#

	</update>
	
	<!-- 소관(처리)과 자동 세팅 -->
	<!-- 소관기관 코드번호를 가지고 소관과 검색 -->
	<select id="BADCMR021EChgdptSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[   
			SELECT B.DPT_CD
			     , B.DPT_NM
			  FROM TBDCMACM015M A
			     , TBDCMACM002M B			          
			 WHERE A.ENFM_DPT_CD = B.DPT_CD
			   AND A.ORG_CD = #strCoptGdCd#
		]]>
	</select>
	
</sqlMap> 
