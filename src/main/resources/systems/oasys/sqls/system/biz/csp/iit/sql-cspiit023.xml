<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/iit/023">
	
	<select id="CSPIIT023QMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<include refid = "include.pageSelct"/>
        <![CDATA[
			SELECT 	A.MTRL_RQS_SNO,			/*자료요청순번*/
					A.MTRL_RQS_DVSN_CD,		/*자료요청구분코드*/
					A.RQS_DT,				/*요청일*/
					D.ABR_DPT_NM_1 AS RQS_DPT_NM,	/*요청자부서명*/
					B.USR_NAM AS RQR_NAM,	/*요청자명*/
					A.RQS_TIT_NM,			/*요청제목*/
					C.USR_NAM AS HNDL_PEN_NAM,	/*처리담당자명*/
					A.HNDL_DT,				/*처리일자*/
					A.RQR_CNB,				/*요청자전산번호*/
					A.HNDL_PEN_CNB,			/*처리자전산번호*/
					A.RQS_DPT_CD,	/*요청부서코드*/
					F_CODE_NM('1000796',A.DGE1_MNU_DVSN_CD) AS DGE1_MNU_DVSN_NM	/*1차메뉴구분코드*/
			FROM   	TBCSPIIT002M A,			/*PC장비관리테이블*/
					TBDCMACM001M B, 		/*사용자테이블(요청자)*/
					TBDCMACM001M C,			/*사용자테이블(처리자)*/
					TBDCMACM002M D,			/*부서코드(요청자)*/
					TBDCMACM002M E			/*부서코드(처리자)*/
			WHERE	A.RQR_CNB = B.CNB(+)
			AND		A.HNDL_PEN_CNB = C.CNB(+)
			AND		A.RQS_DPT_CD = D.DPT_CD(+)
			AND		C.DPT_CD = E.DPT_CD(+)
			AND		A.COPUT_BRD_DVSN_CD = '03' /*게시판구분코드 - 전산개선요청*/
        ]]>
        <dynamic>
        	<isNotEmpty property="strRQS_DTS">
        		AND	A.RQS_DT &gt;= #strRQS_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strRQS_DTE">
        		AND	A.RQS_DT &lt;= #strRQS_DTE#
        	</isNotEmpty>
        	<isNotEmpty property="strMTRL_RQS_DVSN_CD">
        		AND	A.MTRL_RQS_DVSN_CD = #strMTRL_RQS_DVSN_CD#
        	</isNotEmpty>
        	<isNotEmpty property="strSEARCH_NM">
        		AND	(D.DPT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR E.DPT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.RQS_TIT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.RQS_TXT LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.HNDL_TXT LIKE '%'||#strSEARCH_NM#||'%')
        	</isNotEmpty>
        	<isNotEmpty property="strRQR_NAM">
        		AND B.USR_NAM LIKE '%'||#strRQR_NAM#||'%'
        	</isNotEmpty>
        	<isNotEmpty property="strHNDL_PEN_NAM">
        		AND	C.USR_NAM LIKE '%'||#strHNDL_PEN_NAM#||'%'
        	</isNotEmpty>
        	<isEqual property="strAUTH_CD" compareValue="DEPT">
        		AND	( A.OPEN_YN = 'Y' OR  A.RQR_CNB = #strCNB#)
        	</isEqual>
        	<isEqual property="strRESULT_CD" compareValue="1">
        		AND	A.HNDL_DT IS NULL
        	</isEqual>
        	<isEqual property="strRESULT_CD" compareValue="2">
        		AND	A.HNDL_DT IS NOT NULL
        	</isEqual>
        	<isNotEmpty property="strDGE1_MNU_DVSN_CD">
        		AND a.DGE1_MNU_DVSN_CD = #strDGE1_MNU_DVSN_CD#
        	</isNotEmpty>
        	
        </dynamic>
        <![CDATA[
        	ORDER BY TO_NUMBER(A.MTRL_RQS_SNO) DESC
        ]]>
        <include refid = "include.pageOrder"/> 
	</select>     
	
	<select id="CSPIIT024EMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[
        	SELECT	A.MTRL_RQS_SNO,		/*자료요청순번*/ 
        			A.MTRL_RQS_DVSN_CD, 		/*자료요청구분코드*/
        			A.RQS_DT,	/*요청일*/ 
        			A.RQR_CNB,		/*요청자전산번호*/
        			(SELECT USR_NAM 
        			FROM TBDCMACM001M Z
        			WHERE A.RQR_CNB = Z.CNB
        			) AS RQR_NAM,		/*요청자명*/
        			A.OPEN_YN,		/*공개여부*/ 
        			A.RQS_TIT_NM,	/*요청제목명*/
			 		A.RQS_TXT, 		/*요청내용*/
			 		A.HNDL_DT, 		/*처리일*/
			 		A.HNDL_PEN_CNB, 	/*처리자전산번호*/
			 		(SELECT USR_NAM 
        			FROM TBDCMACM001M Z
        			WHERE A.HNDL_PEN_CNB = Z.CNB
        			) AS HNDL_PEN_NAM,		/*처리자명*/
			 		A.HNDL_TXT, 		/*처리내용*/
			 		(SELECT DOC_ID FROM TBCSPIIT009M Z 
			 		WHERE Z.MTRL_RQS_SNO = A.MTRL_RQS_SNO 
			 		AND Z.MTRL_RQS_ATT_FL_DVSN_CD = '1'
			 		AND	Z.COPUT_BRD_DVSN_CD = '03') AS RQS_DOC_ID,
			 		(SELECT DOC_ID FROM TBCSPIIT009M Z 
			 		WHERE Z.MTRL_RQS_SNO = A.MTRL_RQS_SNO 
			 		AND Z.MTRL_RQS_ATT_FL_DVSN_CD = '2'
			 		AND	Z.COPUT_BRD_DVSN_CD = '03') AS HNDL_DOC_ID,
			 		PRPS_YE,
			 		PRPS_SLN,
			 		F_DPT_INFO(A.RQS_DPT_CD,'1') AS RQS_DPT_NM,
			 		A.DGE1_MNU_DVSN_CD	/*1차메뉴구분코드*/,
			 		(SELECT	TNB
			 		FROM	TBDCMACM001M
			 		WHERE	CNB = A.RQR_CNB ) AS TNB
        	FROM	TBCSPIIT002M A
        	WHERE 	A.MTRL_RQS_SNO = #strMTRL_RQS_SNO#
        	AND		A.COPUT_BRD_DVSN_CD = '03' /*게시판구분코드 - 전산개선요청*/
		]]>
	</select>
	
	<!-- 전산장애 요청 년도, 요청연번 Max값 가져오기 -->
	<select id="CSPIIT024EKeySelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[     	
			    SELECT TO_CHAR(NVL(MAX(TO_NUMBER(MTRL_RQS_SNO)),0)+1) AS MTRL_RQS_SNO
				  FROM TBCSPIIT002M
				 WHERE 1=1
				 AND		COPUT_BRD_DVSN_CD = '03' /*게시판구분코드 - 전산개선요청*/
		]]>
	</select>
	
	<insert id="CSPIIT024EMainInsert" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO TBCSPIIT002M
        	(		COPUT_BRD_DVSN_CD, /*게시판구분코드 - 전산개선요청*/
        			MTRL_RQS_SNO,			/*자료요청순번*/
        			MTRL_RQS_DVSN_CD,		/*자료요청구분코드*/
        			RQS_DT,			/*요청일*/
        			RQR_CNB,		/*요청자전산번호*/
        			RQS_TIT_NM,		/*요청제목명*/
        			RQS_TXT,		/*요청내용*/
        			OPEN_YN,		/*공개여부*/
        			FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH,
					RQS_DPT_CD,
					DGE1_MNU_DVSN_CD	/*1차메뉴구분코드*/
        	) VALUES (
        			'03',	/*게시판구분코드 - 전산개선요청*/
	        		#MTRL_RQS_SNO#,
	        		#MTRL_RQS_DVSN_CD#,
	        		#RQS_DT#,
	        		#RQR_CNB#,
	        		#RQS_TIT_NM#,
	        		#RQS_TXT#,
	        		#OPEN_YN#,
	        		#FRT_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
					SYSDATE,
					F_USR_INFO(#RQR_CNB#,'5'),
					#DGE1_MNU_DVSN_CD#
        	)
        ]]>
	</insert>
	
	<update id="CSPIIT024EMainUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPIIT002M
			SET		MTRL_RQS_DVSN_CD = #MTRL_RQS_DVSN_CD# ,	/*자료요청구분코드*/
					RQS_DT = #RQS_DT#,			/*요청일*/
					RQR_CNB = #RQR_CNB#,		/*요청자전산번호*/
					RQS_TIT_NM = #RQS_TIT_NM#,	/*요청제목명*/
					RQS_TXT = #RQS_TXT#,		/*요청내용*/
					HNDL_DT = #HNDL_DT#,	/*처리일*/
					HNDL_PEN_CNB = #HNDL_PEN_CNB#, /*처리자전산번호*/
					HNDL_TXT = #HNDL_TXT#,	/*처리내용*/
					OPEN_YN = #OPEN_YN#, 	/*공개여부*/
					FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE,
					RQS_DPT_CD = F_USR_INFO(#RQR_CNB#,'5'),
					DGE1_MNU_DVSN_CD = #DGE1_MNU_DVSN_CD#	/*1차메뉴구분코드*/
			WHERE	MTRL_RQS_SNO = #MTRL_RQS_SNO#
			AND		COPUT_BRD_DVSN_CD = '03'	/*게시판구분코드 - 전산개선요청*/
		]]>
	</update>
	
	<delete id="CSPIIT024EMainDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE	
			FROM	TBCSPIIT002M
			WHERE	MTRL_RQS_SNO = #MTRL_RQS_SNO#
			AND		COPUT_BRD_DVSN_CD = '03'	/*게시판구분코드 - 전산개선요청*/
		]]>
	</delete>
	
	<insert id="CSPIIT024ERqsFileInsert" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO TBCSPIIT009M
        	(
        			COPUT_BRD_DVSN_CD,	/*게시판구분코드 - 전산개선요청*/
        			MTRL_RQS_SNO,			/*자료요청순번*/
        			MTRL_RQS_ATT_FL_DVSN_CD,		/*자료요청첨부파일구분코드*/
        			DOC_ID,			/*요청일*/
        			FRT_USR_ID,
        			FNL_USR_ID,
        			FNL_DEAL_DPT_CD,
        			FNL_MNU_ID,
        			FRT_REGI_DH,
        			FNL_MDF_DH
        	) VALUES (
        			'03',
	        		#MTRL_RQS_SNO#,
	        		'1',
	        		#RQS_DOC_ID#,
	        		#FRT_USR_ID#,
	        		#FNL_USR_ID#,
	        		#FNL_DEAL_DPT_CD#,
	        		#FNL_MNU_ID#,
	        		SYSDATE,
	        		SYSDATE
        	)
        ]]>
	</insert>
	
	<insert id="CSPIIT024EHndlFileInsert" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO TBCSPIIT009M
        	(	
        			COPUT_BRD_DVSN_CD,	/*게시판구분코드 - 전산개선요청*/
        			MTRL_RQS_SNO,			/*자료요청순번*/
        			MTRL_RQS_ATT_FL_DVSN_CD,		/*자료요청첨부파일구분코드*/
        			DOC_ID,			/*요청일*/
        			FRT_USR_ID,
        			FNL_USR_ID,
        			FNL_DEAL_DPT_CD,
        			FNL_MNU_ID,
        			FRT_REGI_DH,
        			FNL_MDF_DH
        	) VALUES (
        			'03',
	        		#MTRL_RQS_SNO#,
	        		'2',
	        		#HNDL_DOC_ID#,
	        		#FRT_USR_ID#,
	        		#FNL_USR_ID#,
	        		#FNL_DEAL_DPT_CD#,
	        		#FNL_MNU_ID#,
	        		SYSDATE,
	        		SYSDATE
        	)
        ]]>
	</insert>
	
	<delete id="CSPIIT024EFileDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE	
			FROM	TBCSPIIT009M
			WHERE	MTRL_RQS_SNO = #MTRL_RQS_SNO#
			AND		COPUT_BRD_DVSN_CD = '03'	/*게시판구분코드 - 전산개선요청*/
		]]>
	</delete>
	
	<!-- 전산개선 및 자료요청 엑셀다운로드 -->
	<select id="CSPIIT023QExcelExportSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[
			SELECT 	/*CSPIIT003QExcelExportSelect*/
					F_CODE_NM('1000795',A.MTRL_RQS_DVSN_CD) AS MTRL_RQS_DVSN_NM,	/*자료요청구분코드*/
					TO_CHAR(TO_DATE(A.RQS_DT),'YYYY-MM-DD') AS RQS_DT,		/*요청일*/
					D.DPT_NM AS RQS_DPT_NM,	/*요청자부서명*/
					B.USR_NAM AS RQR_NAM,	/*요청자명*/
					A.RQS_TIT_NM,			/*요청제목*/
					C.USR_NAM AS HNDL_PEN_NAM,	/*처리담당자명*/
					TO_CHAR(TO_DATE(A.HNDL_DT),'YYYY-MM-DD') AS HNDL_DT	/*처리일자*/,
					F_CODE_NM('1000796',A.DGE1_MNU_DVSN_CD) AS DGE1_MNU_DVSN_NM	/*1차메뉴구분코드*/
			FROM   	TBCSPIIT002M A,			/*PC장비관리테이블*/
					TBDCMACM001M B, 		/*사용자테이블(요청자)*/
					TBDCMACM001M C,			/*사용자테이블(처리자)*/
					TBDCMACM002M D,			/*부서코드(요청자)*/
					TBDCMACM002M E			/*부서코드(처리자)*/
			WHERE	A.RQR_CNB = B.CNB(+)
			AND		A.HNDL_PEN_CNB = C.CNB(+)
			AND		A.RQS_DPT_CD = D.DPT_CD(+)
			AND		C.DPT_CD = E.DPT_CD(+)
			AND		COPUT_BRD_DVSN_CD = '03'	/*게시판구분코드 - 전산개선요청*/
        ]]>
        <dynamic>
        	<isNotEmpty property="strRQS_DTS">
        		AND	A.RQS_DT &gt;= #strRQS_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strRQS_DTE">
        		AND	A.RQS_DT &lt;= #strRQS_DTE#
        	</isNotEmpty>
        	<isNotEmpty property="strMTRL_RQS_DVSN_CD">
        		AND	A.MTRL_RQS_DVSN_CD = #strMTRL_RQS_DVSN_CD#
        	</isNotEmpty>
        	<isNotEmpty property="strSEARCH_NM">
        		AND	(D.DPT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR E.DPT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.RQS_TIT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.RQS_TXT LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.HNDL_TXT LIKE '%'||#strSEARCH_NM#||'%')
        	</isNotEmpty>
        	<isNotEmpty property="strRQR_NAM">
        		AND B.USR_NAM LIKE '%'||#strRQR_NAM#||'%'
        	</isNotEmpty>
        	<isNotEmpty property="strHNDL_PEN_NAM">
        		AND	C.USR_NAM LIKE '%'||#strHNDL_PEN_NAM#||'%'
        	</isNotEmpty>
        	<isEqual property="strAUTH_CD" compareValue="DEPT">
        		AND	( A.OPEN_YN = 'Y' OR  A.RQR_CNB = #strCNB#)
        	</isEqual>
        	<isEqual property="strRESULT_CD" compareValue="1">
        		AND	A.HNDL_DT IS NULL
        	</isEqual>
        	<isEqual property="strRESULT_CD" compareValue="2">
        		AND	A.HNDL_DT IS NOT NULL
        	</isEqual>
        	<isNotEmpty property="strDGE1_MNU_DVSN_CD">
        		AND A.DGE1_MNU_DVSN_CD = #strDGE1_MNU_DVSN_CD#
        	</isNotEmpty>
        </dynamic>
        <![CDATA[
        	ORDER BY TO_NUMBER(A.MTRL_RQS_SNO) DESC
        ]]>
	</select>
	
</sqlMap> 
