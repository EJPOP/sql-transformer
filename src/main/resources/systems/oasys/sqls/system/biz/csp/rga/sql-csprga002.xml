<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/rga/002">

	<!-- 기본 조회 -->
	<select id="CSPRGA002EMainSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
                  SELECT T1.PBC_YR                            AS PBC_YR      /* 발간년도 */
                        ,T1.PBC_NO                            AS PBC_NO      /* 발간번호 */
                        ,T1.PBC_YR || '-' || T1.PBC_NO        AS PBC_YR_NO   /* 발간연번호 */
                        ,T1.PBC_KND_CD                        AS PBC_KND_CD  /* 발간종류코드 */
                        ,F_CODE_NM('1000903', T1.PBC_KND_CD)  AS PBC_KND_NM  /* 발간종류명 */
                        ,T1.PBC_TIT_TXT                       AS PBC_TIT_TXT /* 발간제목내용 */
                        ,T1.ACP_DT                            AS ACP_DT      /* 접수일 */
                        ,T1.PBC_DT                            AS PBC_DT      /* 발간일 */
                        ,T1.RQR_DPT_CD                        AS RQR_DPT_CD  /* 요청부서코드  */
                        ,F_DPT_INFO(T1.RQR_DPT_CD, '1')       AS RQR_DPT_NM  /* 요청부서명  */
                        ,T1.RQR_CNB                           AS RQR_CNB     /* 요청전산번호  */
                        ,F_USR_INFO(T1.RQR_CNB, '2')          AS RQR_NM      /* 요청자명 */
                        ,T1.HNDL_STA_CD                       AS HNDL_STA_CD /* 처리상태코드 */
                        ,F_CODE_NM('1000904', T1.HNDL_STA_CD) AS HNDL_STA_NM /* 처리상태명 */
                        ,T1.APV_STA_CD                        AS APV_STA_CD  /* 결재상태코드 */
                        ,F_CODE_NM('1000333', T1.APV_STA_CD)  AS APV_STA_NM  /* 결재상태명 */
                        ,T1.APV_DOC_NO                        AS APV_DOC_NO  /* 결재문서번호 */
                        ,T1.DOC_ID                            AS DOC_ID      /* 문서ID */                        
                    FROM TBCSPRGA001M T1
                   WHERE 1=1
                     AND PBC_YR = #strPbcYr#
                     AND PBC_NO = #strPbcNo#
		]]>
	</select>
	
	<!-- 발간 요구서 조회 -->
	<select id="CSPRGA002EPbcSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
                  SELECT T1.PBC_YR                                         AS PBC_YR         /* 발간년도 */
                        ,T1.PBC_NO                                         AS PBC_NO         /* 발간번호 */
                        ,T1.SRNO                                           AS SRNO           /* 일련번호 */
                        ,T1.PBC_YR || '-' || T1.PBC_NO || '-' || T1.SRNO   AS PBC_YR_NO_SRNO /* 발간연번호 */
                        ,T1.TIT_TXT                                        AS TIT_TXT        /* 제목내용 */
                        ,T1.MNG_NO                                         AS MNG_NO         /* 관리번호 */
                        ,T1.CP_CNT                                         AS CP_CNT         /* 부수 */
                        ,T1.PNCG_CD                                        AS PNCG_CD        /* 펀칭코드 */
                        ,T1.BKBNG_CD                                       AS BKBNG_CD       /* 제본코드 */
                        ,T1.PRT_PG_KND_CD                                  AS PRT_PG_KND_CD  /* 인쇄면종류코드 */
                        ,T1.DLV_DDLN_DT                                    AS DLV_DDLN_DT    /* 납품기한일 */
                        ,T1.RMK_TXT                                        AS RMK_TXT        /* 비고내용 */
                        
                        /* 이하 출력물에서 더 필요한 컬럼 들 */
                        ,F_CODE_NM('1000905', T1.BKBNG_CD)                 AS BKBNG_NM       /* 제본코드명 */
                        ,F_CODE_NM('1000906', T1.PRT_PG_KND_CD)            AS PRT_PG_KND_NM  /* 인쇄면종류코드명*/    
                    FROM TBCSPRGA002L T1
                   WHERE 1=1
                     AND PBC_YR = #strPbcYr#
                     AND PBC_NO = #strPbcNo#
                   ORDER BY T1.PBC_YR  
                           ,T1.PBC_NO  
                           ,T1.SRNO 
		]]>
	</select>	
	
	<!-- 발간번호 채번 -->
	<select id="CSPRGA002EMainMaxSrnoSelect" parameterClass="paramMap" resultClass="Integer">
        <![CDATA[     	
			    SELECT NVL(MAX(PBC_NO),0) + 1 AS MAX_PBC_NO
				  FROM TBCSPRGA001M
				 WHERE 1=1
				   AND PBC_YR = #PBC_YR# 
		]]>
	</select>
		
	<!-- 기본 insert -->
	<insert id="CSPRGA002EMainInsert" parameterClass="paramMap">
			INSERT INTO TBCSPRGA001M
				 (
                      PBC_YR           /* 발간년도 */
                     ,PBC_NO           /* 발간번호 */
                     ,PBC_KND_CD       /* 발간종류코드 */
                     ,PBC_TIT_TXT      /* 발간제목내용 */
                     ,ACP_DT           /* 접수일 */
                     ,PBC_DT           /* 발간일 */
                     ,RQR_DPT_CD       /* 요청부서코드 */
                     ,RQR_CNB          /* 요청전산번호 */
                     ,HNDL_STA_CD      /* 처리상태코드 */
                     ,APV_STA_CD       /* 결재상태코드 */
                     ,APV_DOC_NO       /* 결재문서번호 */
                     ,DOC_TYP_CD       /* 문서유형코드 */
                     ,DOC_ID           /* 문서ID */
                     ,FRT_USR_ID       /* 최초사용자ID */
                     ,FNL_USR_ID       /* 최종사용자ID */
                     ,FNL_DEAL_DPT_CD  /* 최종거래부서코드 */
                     ,FNL_MNU_ID       /* 최종메뉴ID */
                     ,FRT_REGI_DH      /* 최초등록일시 */
                     ,FNL_MDF_DH       /* 최종수정일시 */              
				 ) VALUES
				 (
                      #PBC_YR#
                     ,#PBC_NO#
                     ,#PBC_KND_CD#
                     ,#PBC_TIT_TXT#
                     ,TO_CHAR(SYSDATE, 'YYYYMMDD')
                     ,#PBC_DT#
                     ,#FNL_DEAL_DPT_CD#
                     ,#S_CNB#
                     ,#PBC_KND_CD# || '0'
                     ,'1'
                     ,#APV_DOC_NO#
                     ,#DOC_TYP_CD#
                     ,#DOC_ID#		     			     		    
				     ,#FRT_USR_ID#
				     ,#FNL_USR_ID#
				     ,#FNL_DEAL_DPT_CD#
				     ,#FNL_MNU_ID#
				     ,SYSDATE
				     ,SYSDATE
				 ) 
	</insert>		
	
	<!-- 기본 update -->
	<update id="CSPRGA002EMainUpdate" parameterClass="paramMap">
	        UPDATE TBCSPRGA001M
	           SET PBC_KND_CD      = #PBC_KND_CD#          /* 발간종류코드 */
                  ,PBC_TIT_TXT     = #PBC_TIT_TXT#         /* 발간제목내용 */
                  ,DOC_TYP_CD      = #DOC_TYP_CD#          /* 문서유형코드 */
                  ,DOC_ID          = #DOC_ID#              /* 문서ID */
				  ,FNL_USR_ID      = #FNL_USR_ID#          /* 최종사용자ID */
				  ,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#     /* 최종거래부서코드 */
				  ,FNL_MNU_ID      = #FNL_MNU_ID#          /* 최종메뉴ID */
				  ,FNL_MDF_DH      = SYSDATE               /* 최종수정일시 */
             WHERE 1=1
               AND PBC_YR          = #PBC_YR#
               AND PBC_NO          = #PBC_NO#
	</update>
		
	<!--기본 delete -->
	<update id="CSPRGA002EMainDelete" parameterClass="paramMap">
	        DELETE 
	          FROM TBCSPRGA001M
             WHERE 1=1
               AND PBC_YR = #PBC_YR#
               AND PBC_NO = #PBC_NO#
	</update>		
	
	<!-- 발간요구서 insert -->
	<insert id="CSPRGA002EPbcInsert" parameterClass="paramMap">
			INSERT INTO TBCSPRGA002L
				 (
                      PBC_YR           /* 발간년도 */
                     ,PBC_NO           /* 발간번호 */
                     ,SRNO             /* 일련번호 */
                     ,TIT_TXT          /* 제목내용 */
                     ,CP_CNT           /* 부수 */
                     ,PNCG_CD          /* 펀칭코드 */
                     ,BKBNG_CD         /* 제본코드 */
                     ,PRT_PG_KND_CD    /* 인쇄면종류코드 */
                     ,DLV_DDLN_DT      /* 납품기한일 */
                     ,RMK_TXT          /* 비고내용 */
                     ,FRT_USR_ID       /* 최초사용자ID */
                     ,FNL_USR_ID       /* 최종사용자ID */
                     ,FNL_DEAL_DPT_CD  /* 최종거래부서코드 */
                     ,FNL_MNU_ID       /* 최종메뉴ID */
                     ,FRT_REGI_DH      /* 최초등록일시 */
                     ,FNL_MDF_DH       /* 최종수정일시 */              
				 ) VALUES
				 (
                      #PBC_YR#
                     ,#PBC_NO#
                     ,(SELECT NVL(MAX(SRNO),0) + 1
				        FROM TBCSPRGA002L
				       WHERE PBC_YR = #PBC_YR#
				         AND PBC_NO = #PBC_NO#)
                     ,#TIT_TXT#
                     ,#CP_CNT#
                     ,#PNCG_CD#
                     ,#BKBNG_CD#   
                     ,#PRT_PG_KND_CD#
                     ,#DLV_DDLN_DT#
                     ,#RMK_TXT#
				     ,#FRT_USR_ID#
				     ,#FNL_USR_ID#
				     ,#FNL_DEAL_DPT_CD#
				     ,#FNL_MNU_ID#
				     ,SYSDATE
				     ,SYSDATE
				 ) 
	</insert>		
	
	<!-- 발간요구서 update -->
	<update id="CSPRGA002EPbcUpdate" parameterClass="paramMap">
	        UPDATE TBCSPRGA002L
	           SET TIT_TXT         = #TIT_TXT#         /* 제목내용 */
                  ,CP_CNT          = #CP_CNT#          /* 부수 */
                  ,PNCG_CD         = #PNCG_CD#         /* 펀칭코드 */
                  ,BKBNG_CD        = #BKBNG_CD#        /* 제본코드 */
                  ,PRT_PG_KND_CD   = #PRT_PG_KND_CD#   /* 인쇄면종류코드 */
                  ,DLV_DDLN_DT     = #DLV_DDLN_DT#     /* 납품기한일 */
                  ,RMK_TXT         = #RMK_TXT#         /* 비고내용 */                  
				  ,FNL_USR_ID      = #FNL_USR_ID#      /* 최종사용자ID */
				  ,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
				  ,FNL_MNU_ID      = #FNL_MNU_ID#      /* 최종메뉴ID */
				  ,FNL_MDF_DH      = SYSDATE           /* 최종수정일시 */
             WHERE 1=1
               AND PBC_YR          = #PBC_YR#
               AND PBC_NO          = #PBC_NO#
               AND SRNO            = #SRNO#
	</update>
	
		
	<!--발간요구서 delete -->
	<update id="CSPRGA002EPbcDelete" parameterClass="paramMap">
	        DELETE 
	          FROM TBCSPRGA002L
             WHERE 1=1
               AND PBC_YR = #PBC_YR#
               AND PBC_NO = #PBC_NO#
               
           <isNotEmpty property="SRNO">
               AND SRNO   = #SRNO#
           </isNotEmpty>
	</update>			
	
	
	<!-- 담당자 여부조회 -->
	<select id="CSPRGA002EChrTskYnInfoSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
                   SELECT CHR_TSK_CD
                         ,CNB
                     FROM TBCSPRGA003M
                    WHERE CNB = #S_CNB#
                    ORDER BY CHR_TSK_CD, CNB
		]]>
	</select>			
	
	
	<!-- 결재문서번호로 조회-->
	<select id="CSPRGA002EApvDocNoselect" parameterClass="paramMap" resultClass="resultMap">
        SELECT PBC_YR                   AS PBC_YR
              ,PBC_NO                   AS PBC_NO
              ,APV_DOC_NO               AS APV_DOC_NO  
              
              ,PBC_YR || '-' || PBC_NO  AS PBC_YR_NO  
              ,PBC_TIT_TXT              AS PBC_TIT_TXT     
              ,F_USR_INFO(RQR_CNB, '1') AS RQR_USR_ID
          FROM TBCSPRGA001M 
         WHERE APV_DOC_NO = #APV_DOC_NO#
	</select>	
	
	
	<!-- 결재저장 -->
	<update id="CSPRGA002EApvSaveUpdate" parameterClass="paramMap">
	    UPDATE TBCSPRGA001M                  
           SET APV_STA_CD  = #APV_STA_CD#    
              ,APV_DOC_NO  = #APV_DOC_NO#    
              ,HNDL_STA_CD = CASE WHEN #APV_STA_CD# = '3' THEN PBC_KND_CD || '1'
                                  ELSE                         PBC_KND_CD || '0'
                              END  
         WHERE PBC_YR      = #PBC_YR#         
           AND PBC_NO      = #PBC_NO#     
	</update>	
		
		
	<!-- 담당자 전산번호(쪽지 보내기 위해)  -->
	<select id="CSPRGA002EChrTskCnbsSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
               /* 
                * WHERE 조건절 설명 : 메신저 쪽지를 보내기 위해, CHR_TSK_CD 를 만든다.
                *
                * 참조 코드
                *   - 발간종류코드     : 1000903
 	            *   - 발간담당업무코드 : 1000904
                *
                * 처리순서
                *   - 일반               : 과 >         서무 > 발간 - 3
                *   - 감사결과처분요구서 : 과 > 자료실 > 서무 > 발간 - 1
                *   - 부의안위원회의록   : 과 > 심의실 > 서무 > 발간 - 2
                */
                		
                   SELECT COUNT(CNB)                                                                   AS RCNT_CNT
                         ,TO_CHAR( EXTRACT(XMLAGG(XMLELEMENT(A, ''|| CNB) ORDER BY CNB), '//text()') ) AS RCNT_CNB
                     FROM TBCSPRGA003M 
		]]>
		 
		<isEqual property="strSchDvsn" compareValue="APV"> 
		            /* 결재완료 후 */               
                    WHERE CHR_TSK_CD = (SELECT CASE WHEN PBC_KND_CD = '1' THEN '3' 
                                                    WHEN PBC_KND_CD = '2' THEN '1' 
                                                    WHEN PBC_KND_CD = '3' THEN '2' 
                                                END
                                           FROM TBCSPRGA001M
                                          WHERE PBC_YR = #PBC_YR# 
                                            AND PBC_NO = #PBC_NO# )
		</isEqual>
		
		<isEqual property="strSchDvsn" compareValue="CFM">
		            /* 확인시 */                
                    WHERE CHR_TSK_CD = #CHR_TSK_CD#
		</isEqual>		
	</select>		
		
		
	<!-- 메신저 쪽지 발송입력 -->	    
	<insert id="CSPRGA002EMessengerInsert" parameterClass="paramMap">
		<![CDATA[	
			INSERT INTO TBDCMACM026L (              			
			            MSG_SNO 
			          , TSK_CAT_CD 
			          , FUNC_CAT_CD 
			          , SEND_ID 
			          , MSG_TP_YN 
			          , MSG_TXT_2 
			          , RCNT_CNT 
			          , RCNT_HIS 
			          , MSG_REGI_DH 
			          , MSG_HNDL_YN 
			          , FRT_USR_ID 
			          , FNL_USR_ID 
			          , FNL_DEAL_DPT_CD 
			          , FNL_MNU_ID 
			          , FRT_REGI_DH 
			          , FNL_MDF_DH )
			  VALUES ( 
			            (SELECT NVL(MAX(MSG_SNO),0) + 1 
			               FROM (SELECT MSG_SNO 
			                       FROM TBDCMACM026L        		
			                      ORDER BY MSG_SNO DESC) 
			              WHERE ROWNUM < 2 
			              GROUP BY MSG_SNO) 
			          , 'SP' 
			          , 'GA' 
			          , #SEND_USR_ID#            /* 보내는 사람 USR_ID */
			          , '0' 
			          , #TXT_CONT#               /* 내용 */
			          , #RCNT_CNT#               /* 받는사람 인원수 */
			          , #RCNT_CNB#               /* 받는사람 전산번호 */
			          , SYSDATE 
			          , 'N' 
			          , NVL(#FRT_USR_ID#      , 'SYSTEM')
			          , NVL(#FNL_USR_ID#      , 'SYSTEM')
			          , NVL(#FNL_DEAL_DPT_CD# , 'SYSTEM')
			          , NVL(#FNL_MNU_ID#      , 'CSPRGA002E')
			          , SYSDATE
			          , SYSDATE )
		]]>			          
	</insert>		
		
	<!-- 반려처리 update -->
	<update id="CSPRGA002ESaveRetUpdate" parameterClass="paramMap">
	        UPDATE TBCSPRGA001M
	           SET APV_STA_CD      = '1'
	              ,APV_DOC_NO      = ''
	              ,HNDL_STA_CD     = PBC_KND_CD || '0'   
				  ,FNL_USR_ID      = #FNL_USR_ID#      /* 최종사용자ID */
				  ,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
				  ,FNL_MNU_ID      = #FNL_MNU_ID#      /* 최종메뉴ID */
				  ,FNL_MDF_DH      = SYSDATE           /* 최종수정일시 */
             WHERE 1=1
               AND PBC_YR          = #PBC_YR#
               AND PBC_NO          = #PBC_NO#
	</update>		
		
    <!-- 결재선정보 삭제 -->
    <update id="CSPRGA002ApvSubDelete" parameterClass="paramMap">
   		DELETE TBDCMACM023L
   		 WHERE APV_DOC_NO  = #APV_DOC_NO#
   		   AND APV_DVSN_CD = 'PbcRqExe'
    </update>
    
    <!-- 결재정보 삭제 -->
    <update id="CSPRGA002ApvMstDelete" parameterClass="paramMap">
   		DELETE TBDCMACM022L
   		 WHERE APV_DOC_NO  = #APV_DOC_NO#
   		   AND APV_DVSN_CD = 'PbcRqExe'
    </update>	
    
    <!-- 결재히스토리 삭제 -->
	<delete id="CSPRGA002ApvHstDelete" parameterClass="paramMap">
	    DELETE FROM TBDCMACM023H
		 WHERE APV_DOC_NO  = #APV_DOC_NO# 
		   AND APV_DVSN_CD = 'PbcRqExe'
	</delete>     	
		

	<!-- 확인처리 update -->
	<update id="CSPRGA002ESaveCfmUpdate" parameterClass="paramMap">
	        UPDATE TBCSPRGA001M
	           SET HNDL_STA_CD     = #HNDL_STA_CD#     /* 처리상태코드 */
	              ,PBC_DT          = CASE WHEN #HNDL_STA_CD# IN ('13','24','34') THEN TO_CHAR(SYSDATE, 'YYYYMMDD')
	                                      ELSE ''
	                                  END              /* 발간확인 일때만 발간일자 SET */
				  ,FNL_USR_ID      = #FNL_USR_ID#      /* 최종사용자ID */
				  ,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
				  ,FNL_MNU_ID      = #FNL_MNU_ID#      /* 최종메뉴ID */
				  ,FNL_MDF_DH      = SYSDATE           /* 최종수정일시 */
             WHERE 1=1
               AND PBC_YR          = #PBC_YR#
               AND PBC_NO          = #PBC_NO#
	</update>	
	
	
	<!-- 관리번호 update -->
	<update id="CSPRGA002EMngNoUpdate" parameterClass="paramMap">
	        UPDATE TBCSPRGA002L
	           SET MNG_NO          = #MNG_NO#          /* 관리번호 */
				  ,FNL_USR_ID      = #FNL_USR_ID#      /* 최종사용자ID */
				  ,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
				  ,FNL_MNU_ID      = #FNL_MNU_ID#      /* 최종메뉴ID */
				  ,FNL_MDF_DH      = SYSDATE           /* 최종수정일시 */
             WHERE 1=1
               AND PBC_YR          = #PBC_YR#
               AND PBC_NO          = #PBC_NO#
               AND SRNO            = #SRNO#
	</update>	
</sqlMap> 