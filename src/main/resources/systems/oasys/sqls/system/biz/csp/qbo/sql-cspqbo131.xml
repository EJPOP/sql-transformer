<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/qbo/131">
 
 	<select id="CSPQBO131EMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT 	F_USR_INFO(B.LAG_INV_CNB,'2') AS LAG_INV_NAM
					, B.BOO_LEND_DT 			/*도서대출일*/
					,DECODE(B.BOO_REN_YN_CD,'0',B.BOO_REN_APT_DT,B.BOO_REN_DT) AS BOO_REN_DT	/*도서반납(예정)일*/
					,A.CAT_SYM_NM  			/*분류기호명*/
					, SUBSTR(A.CAT_SYM_NM,1,1)||'-'||SUBSTR(A.CAT_SYM_NM,2,3)||'-'||SUBSTR(A.CAT_SYM_NM,5,3) AS CAT_SYM_NM2
					,A.BOO_TIT_NM  			/*도서제목명*/
					,A.ATR_NM				/*저자명*/
					,F_CODE_NM('1000325', NVL(B.BOO_REN_YN_CD,'1')) AS BOO_REN_YN_CD		/*도서반납여부*/
					,A.COPT_CAT_CD			/*소관분류코드*/
					,A.BOO_KND_CD			/*도서종류코드*/
					,A.BOO_NO				/*도서번호*/
					,A.BOO_NO||'-'||A.BOO_VLE_NO AS BOO_NOS
					,A.BOO_VLE_NO
					,B.BOO_LEND_SLN			/*도서대출연번*/
			FROM	 TBCSPQBO001M A		/*도서자료기본*/
					,TBCSPQBO002H B		/*도서대출이력*/
			WHERE	1=1
			AND		A.COPT_CAT_CD = B.COPT_CAT_CD
			AND		A.BOO_KND_CD = B.BOO_KND_CD
			AND		A.BOO_NO = B.BOO_NO
			AND		A.CAT_SYM_NM = B.CAT_SYM_NM
			AND		A.BOO_VLE_NO = B.BOO_VLE_NO
			
		]]> 
		<dynamic>
			<isNotEmpty property="strCOPT_CAT_CD">
        		AND		A.COPT_CAT_CD = #strCOPT_CAT_CD#
        	</isNotEmpty>
			<isEqual property="strCD" compareValue="DEPT">
				AND	B.LAG_INV_CNB = #strCNB#
			</isEqual>
        	<isNotEmpty property="strBOO_LEND_DTS">
        		AND	B.BOO_LEND_DT &gt;= #strBOO_LEND_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strBOO_LEND_DTE">
        		AND	B.BOO_LEND_DT &lt;= #strBOO_LEND_DTE#
        	</isNotEmpty>
        	<isNotEmpty property="strBOO_REN_YN_CD">
        		AND	B.BOO_REN_YN_CD = #strBOO_REN_YN_CD#
        	</isNotEmpty>
        	<isNotEmpty property="strBOO_TIT_NM1">
        		<isEmpty property="strBOO_TIT_NM2">
        			<isEmpty property="strBOO_TIT_NM3">
        				AND	A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%'
        			</isEmpty>
        			<isNotEmpty property="strBOO_TIT_NM3">
        				<isEqual property="strBOO_TIT_NM_DELI2" compareValue="AND">
        					AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' AND A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        				</isEqual>
        				<isEqual property="strBOO_TIT_NM_DELI2" compareValue="OR">
        					AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        				</isEqual>
        			</isNotEmpty>
        		</isEmpty>
        		<isNotEmpty property="strBOO_TIT_NM2">
        			<isEmpty property="strBOO_TIT_NM3">
        				<isEqual property="strBOO_TIT_NM_DELI1" compareValue="AND">
        					AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' AND A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%')
        				</isEqual>
        				<isEqual property="strBOO_TIT_NM_DELI1" compareValue="OR">
        					AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%')
        				</isEqual>
        			</isEmpty>
        			<isNotEmpty property="strBOO_TIT_NM3">
        				<isEqual property="strBOO_TIT_NM_DELI1" compareValue="AND">
        					<isEqual property="strBOO_TIT_NM_DELI2" compareValue="AND">
        						AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' 
        							AND A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%'
        							AND A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        					</isEqual>
        					<isEqual property="strBOO_TIT_NM_DELI2" compareValue="OR">
        						AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' 
        							AND (A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%'
        								OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%'))
        					</isEqual>
        				</isEqual>
        				<isEqual property="strBOO_TIT_NM_DELI1" compareValue="OR">
        					<isEqual property="strBOO_TIT_NM_DELI2" compareValue="AND">
        						AND	( (A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%')
        								AND	A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        					</isEqual>
        					<isEqual property="strBOO_TIT_NM_DELI2" compareValue="OR">
        						AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%'
        								OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        					</isEqual>
        				</isEqual>
        			</isNotEmpty>
        		</isNotEmpty>
        	</isNotEmpty>
        </dynamic>
        <![CDATA[
        	ORDER BY B.BOO_LEND_DT DESC
        ]]>
	</select>
	
	
	<select id="CSPQBO131ESubSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT 	 B.LEND_BOKG_APL_DT 		/*대출예약신청일*/
					,A.BOO_NO					/*도서번호*/
					,A.BOO_NO||'-'||A.BOO_VLE_NO AS BOO_NOS
					,A.BOO_VLE_NO
					,A.CAT_SYM_NM  			/*분류기호명*/
					, SUBSTR(A.CAT_SYM_NM,1,1)||'-'||SUBSTR(A.CAT_SYM_NM,2,3)||'-'||SUBSTR(A.CAT_SYM_NM,5,3) AS CAT_SYM_NM2
					,A.BOO_TIT_NM  			/*도서제목명*/
					,A.ATR_NM				/*저자명*/
					,B.BOO_BOKG_NO
					,NVL(A.BOO_LEND_DVSN_CD,'1') AS BOO_LEND_DVSN_CD		/*입고여부*/
					,A.COPT_CAT_CD			/*소관분류코드*/
					,A.BOO_KND_CD			/*도서종류코드*/
					,B.BOO_BOKG_SLN			/*도서예약연번*/
			FROM	 TBCSPQBO001M A		/*도서자료기본*/
					,( 	SELECT	B.* ,RANK() OVER (PARTITION BY B.COPT_CAT_CD, B.BOO_KND_CD, B.BOO_NO, B.CAT_SYM_NM, B.BOO_VLE_NO ORDER BY B.BOO_BOKG_SLN ASC) AS BOO_BOKG_NO 
						FROM	TBCSPQBO003H B		/*도서대출예약이력*/
						WHERE 	B.LEND_BOKG_STA_CD = 'Y'
					) B
			WHERE	1=1
			AND		A.COPT_CAT_CD = B.COPT_CAT_CD
			AND		A.BOO_KND_CD = B.BOO_KND_CD
			AND		A.BOO_NO = B.BOO_NO
			AND		A.CAT_SYM_NM = B.CAT_SYM_NM
			AND		A.BOO_VLE_NO = B.BOO_VLE_NO
			AND		A.COPT_CAT_CD = #strCOPT_CAT_CD#
		]]> 
		<dynamic>
			<isEqual property="strCD" compareValue="DEPT">
				AND	B.LEND_BOKG_PEN_CNB = #strCNB# 
			</isEqual>
        	<isNotEmpty property="strLEND_BOKG_APL_DTS">
        		AND	B.LEND_BOKG_APL_DT &gt;= #strLEND_BOKG_APL_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strLEND_BOKG_APL_DTE">
        		AND	B.LEND_BOKG_APL_DT &lt;= #strLEND_BOKG_APL_DTE#
        	</isNotEmpty>
        	<isEqual property="strBOO_LEND_DVSN_CD" compareValue="1">
        		AND	( A.BOO_LEND_DVSN_CD = #strBOO_LEND_DVSN_CD# OR A.BOO_LEND_DVSN_CD IS NULL )
        	</isEqual>
        	<isEqual property="strBOO_LEND_DVSN_CD" compareValue="0">
        		AND	( A.BOO_LEND_DVSN_CD = #strBOO_LEND_DVSN_CD# )
        	</isEqual>
        	<isNotEmpty property="strBOO_TIT_NM1">
        		<isEmpty property="strBOO_TIT_NM2">
        			<isEmpty property="strBOO_TIT_NM3">
        				AND	A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%'
        			</isEmpty>
        			<isNotEmpty property="strBOO_TIT_NM3">
        				<isEqual property="strBOO_TIT_NM_DELI2" compareValue="AND">
        					AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' AND A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        				</isEqual>
        				<isEqual property="strBOO_TIT_NM_DELI2" compareValue="OR">
        					AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        				</isEqual>
        			</isNotEmpty>
        		</isEmpty>
        		<isNotEmpty property="strBOO_TIT_NM2">
        			<isEmpty property="strBOO_TIT_NM3">
        				<isEqual property="strBOO_TIT_NM_DELI1" compareValue="AND">
        					AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' AND A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%')
        				</isEqual>
        				<isEqual property="strBOO_TIT_NM_DELI1" compareValue="OR">
        					AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%')
        				</isEqual>
        			</isEmpty>
        			<isNotEmpty property="strBOO_TIT_NM3">
        				<isEqual property="strBOO_TIT_NM_DELI1" compareValue="AND">
        					<isEqual property="strBOO_TIT_NM_DELI2" compareValue="AND">
        						AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' 
        							AND A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%'
        							AND A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        					</isEqual>
        					<isEqual property="strBOO_TIT_NM_DELI2" compareValue="OR">
        						AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' 
        							AND (A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%'
        								OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%'))
        					</isEqual>
        				</isEqual>
        				<isEqual property="strBOO_TIT_NM_DELI1" compareValue="OR">
        					<isEqual property="strBOO_TIT_NM_DELI2" compareValue="AND">
        						AND	( (BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' OR BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%')
        								AND	BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        					</isEqual>
        					<isEqual property="strBOO_TIT_NM_DELI2" compareValue="OR">
        						AND	(A.BOO_TIT_NM like '%'||#strBOO_TIT_NM1#||'%' OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM2#||'%'
        								OR A.BOO_TIT_NM like '%'||#strBOO_TIT_NM3#||'%')
        					</isEqual>
        				</isEqual>
        			</isNotEmpty>
        		</isNotEmpty>
        	</isNotEmpty>
        </dynamic>
        <![CDATA[
        	ORDER BY B.LEND_BOKG_APL_DT DESC
        ]]>
	</select>
	
</sqlMap> 
