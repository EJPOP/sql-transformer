<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/hpm/004">
	
	<!--감사착수 및 처리단계 정보를 조회한다.-->
	<select id="CSPHPM004Qmainselect" parameterClass="paramMap" 	resultClass="resultMap">
		<include refid = "include.pageSelct"/><!-- 페이징 -->
        <![CDATA[
				SELECT
				  A.FMDA_IDX
				, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD') || ' ~ ' ||TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD')  AS FMDA_AUDIT
				, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD')  AS FMDA_AUDIT_ST
				, TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD') AS FMDA_AUDIT_ET
				, A.FMDA_TXT	
				, A.FMDA_DEPT
				, (SELECT dpt_nm 					
            	 	 FROM tbdcmacm002m	
            		WHERE use_yn = 'Y'
            		  AND dpt_cd = A.FMDA_DEPT         		 
            	) AS FMDA_DEPT_NM
				, A.FMDA_PART
				, A.FMDA_PROC
				, A.FMDA_DT
				, A.FMDA_SJ
				, A.FMDA_RDCNT
				, A.FMDA_OPN_REGCNT
				, A.ATCH_FILE_ID AS DOC_ID
				, TO_CHAR(A.FMDA_PUBLIC_DT, 'YYYY-MM-DD') AS FMDA_PUBLIC_DT
				, A.FMDA_PUBLIC_YN
				, (CASE WHEN A.FMDA_PUBLIC_YN IS NULL THEN '공개전' 
                        WHEN A.FMDA_PUBLIC_YN = 'Y' AND TO_CHAR(SYSDATE,'YYYYMMDD') < TO_CHAR(A.fmda_public_dt,'YYYYMMDD' ) THEN '' 
                        WHEN A.FMDA_PUBLIC_YN = 'Y' AND TO_CHAR(SYSDATE,'YYYYMMDD') >= TO_CHAR(A.fmda_public_dt,'YYYYMMDD' ) 
                        	AND TO_CHAR(SYSDATE,'YYYYMMDD') NOT BETWEEN TO_CHAR(A.fmda_public_dt,'YYYYMMDD' ) AND TO_CHAR(A.fmda_public_dt+14,'YYYYMMDD' ) THEN '공개기간 경과'
                 END) AS FMDA_HOME_ST
			FROM TBCSPTSM001M	A	
			WHERE USE_AT = 'Y'
			AND A.FMDA_DEPT IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#)))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/
		]]>	
		<isNotEmpty property="strSpvBrdvCd">	 
			  AND A.FMDA_DEPT = #strSpvBrdvCd#		<!-- 담당부서 과조회 --> 
		</isNotEmpty>   			
		<!--  <isNotEmpty property="strFMDA_DEPT_NM2" > 담당부서 과 조회
				AND A.FMDA_DEPT = #strFMDA_DEPT_NM2#
		</isNotEmpty> -->
		<!-- <isNotEmpty property="strFMDA_DEPT_NM">담당부서 국조회
				AND	SUBSTR(A.FMDA_DEPT, 1, 3) = SUBSTR(#strFMDA_DEPT_NM#, 1, 3)
		</isNotEmpty> -->
		<isNotEmpty property="strFMDA_PROC"> <!--  처리상태구분 -->
			 	AND	A.FMDA_PROC = #strFMDA_PROC#
		</isNotEmpty>
		
		<!-- <isEmpty property="strFMDA_AUDIT_ET">시작 작성일
			<isNotEqual property="strFMDA_AUDIT_ST" compareValue="">
				<![CDATA[ AND ( #strFMDA_AUDIT_ST# BETWEEN A.FMDA_AUDIT_ST AND A.FMDA_AUDIT_ET) ]]>
			</isNotEqual>
		</isEmpty>
		<isEmpty property="strFMDA_AUDIT_ST">
			<isNotEqual  property="strFMDA_AUDIT_ET" compareValue="">
				<![CDATA[ AND ( #strFMDA_AUDIT_ET# BETWEEN A.FMDA_AUDIT_ST AND A.FMDA_AUDIT_ET) ]]>
			</isNotEqual>
		</isEmpty>
		
		<isNotEmpty property="strFMDA_AUDIT_ST">
			<isNotEmpty  property="strFMDA_AUDIT_ET">
				AND (#strFMDA_AUDIT_ST# BETWEEN A.FMDA_AUDIT_ST AND A.FMDA_AUDIT_ET OR #strFMDA_AUDIT_ET# BETWEEN A.FMDA_AUDIT_ST AND A.FMDA_AUDIT_ET)
			</isNotEmpty>
		</isNotEmpty> -->
		
		<isNotEmpty  property="strYr"> <!-- 연도별 -->
		 		AND SUBSTR(a.FMDA_DT,1,4) = #strYr#	
		</isNotEmpty>	
		
		<isNotEmpty property="strSearchBox" > <!-- 검색조건-->
		 		AND ( UPPER(A.FMDA_SJ) LIKE UPPER('%' || #strSearchBox# || '%') OR  UPPER(A.FMDA_TXT) LIKE UPPER('%' || #strSearchBox# || '%') )
		</isNotEmpty>
		<include refid = "include.pageOrder"/> <!-- 페이징 -->
	</select>
	
<!-- 		
	국 조회
	<select id="selectDeptCombo" parameterClass="paramMap" 	resultClass="resultMap">
		<![CDATA[
			SELECT dpt_cd AS CD, dpt_nm AS CD_NM
			FROM TBDCMACM002M
			WHERE use_yn = 'Y'
			AND SUBSTR(dpt_cd, 4, 6) = '000'
		]]>
	</select>
	
	과 조회
	<select id="selectDeptCombo2" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT dpt_cd AS CD, dpt_nm AS CD_NM
			FROM TBDCMACM002M
			WHERE use_yn = 'Y'
			AND SUBSTR(dpt_cd, 4, 6) != '000'
			AND SUBSTR(dpt_cd, 1, 4) != '1901'
			AND dpt_cd NOT IN('150150', '150160', '150170', '770770', '880880')
			AND dpt_cd NOT IN('140100', '140150', '140170') 
			AND dpt_cd NOT IN('080170', '080180', '080190', '080200', '080210', '080220')
			AND dpt_cd NOT IN('0I0100', '0I0200', '0I0210', '0I0220')
			AND SUBSTR(dpt_cd, 1, 3) NOT IN ('141', '100', '160', '1A0', '170', '200', '300', '150')
			ORDER BY dpt_cd
		]]>
	</select>
 -->	
		<!-- 부서 국 리스트 조회 -->
	<select id="csphpm004DeptBureauSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[       
          SELECT DPT_CD, DPT_NM,HIRK_DPT_CD
            FROM TBDCMACM002M
           WHERE 1=1
         
             ]]>
        <isNotEmpty prepend="AND" property="strDptAuth"> 
              DPT_CD IN ( SELECT SUBSTR(DPT_CD,'1','3')||'000' FROM TABLE(F_AUTH_DEPT(#strCnb#, #strDptAuth#, 'Y')))
        </isNotEmpty>
            AND DPT_CD  LIKE '%000'
            AND USE_YN = 'Y'
            AND SUBSTR(dpt_cd, 1, 3) NOT IN ('100', '120', '121', '122', '140', '160', '170', '1A0','200','300','400','500','510','520','530','540','550')
           ORDER BY DPT_CD 					
        
	</select>
	<!-- 부서 과 리스트 조회 -->
	<select id="csphpm004DeptSectSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[       
           SELECT DPT_CD, DPT_NM, HIRK_DPT_CD
             FROM TBDCMACM002M
            WHERE 1=1

                 ]]>
             <isNotEmpty prepend="AND" property="strDptAuth"> 
              DPT_CD IN ( SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #strDptAuth#, 'Y')))
             </isNotEmpty>
             
			<isNotEmpty property="strHrkDptCd">
	        	<isEmpty property="strDptCd">
				AND SUBSTR(DPT_CD, 0, 3) = SUBSTR(#strHrkDptCd#, 0, 3)        	
	        	</isEmpty>
	        	<isNotEmpty property="strDptCd">
	        	OR SUBSTR(DPT_CD, 0, 3) = SUBSTR(#strHrkDptCd#, 0, 3)
	        	</isNotEmpty>
			</isNotEmpty>
			
			  
              AND USE_YN = 'Y'
              AND SUBSTR(dpt_cd, 4, 6) != '000'
			AND SUBSTR(dpt_cd, 1, 4) != '1901'
			AND dpt_cd NOT IN( '150160', '150170', '150180', '150190', '770770', '880880')
			AND dpt_cd NOT IN('140100', '140150', '140170') 
			AND dpt_cd NOT IN('080170', '080180', '080190', '080200', '080210', '080220')
			AND dpt_cd NOT IN('0I0100', '0I0200', '0I0210', '0I0220')
			AND SUBSTR(dpt_cd, 1, 3) NOT IN ('121','122','140','141', '100', '160', '1A0', '170', '200', '300','400')
            ORDER BY DPT_CD			
      
	</select>
	
	
	<!-- 수정한 내용 저장하기 -->
	<update id="CSPHPM004QUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBCSPTSM001M 
			SET 
			FMDA_AUDIT_ST = #FMDA_AUDIT_ST#, 
			FMDA_AUDIT_ET = #FMDA_AUDIT_ET#,
			FMDA_DEPT  = #FMDA_DEPT#,
			FMDA_PART  = #FMDA_PART#,
			FMDA_PROC  = #FMDA_PROC#,
			FMDA_TXT  = #FMDA_TXT#,
		    ATCH_FILE_ID  = #DOC_ID#, 
			FMDA_SJ  = #FMDA_SJ#, 
			FMDA_UP_DT = SYSDATE, 
			FMDA_PUBLIC_DT = #FMDA_PUBLIC_DT#,
			FMDA_PUBLIC_YN = #FMDA_PUBLIC_YN#		
			WHERE FMDA_IDX = #FMDA_IDX#
		]]>
	</update>
	
	<!--  insert -->
     <insert id="CSPHPM004QInsert" parameterClass="paramMap">
     	<![CDATA[
     		INSERT INTO	TBCSPTSM001M
     				(	    
					     FMDA_IDX       
					    ,FMDA_AUDIT_ST   
					    ,FMDA_AUDIT_ET  
					    ,FMDA_DEPT       
					    ,FMDA_PART       
					    ,FMDA_PROC      
					    ,FMDA_DT         
					    ,FMDA_TXT      
					    ,ATCH_FILE_ID        
					    ,FMDA_SJ        
					    ,FMDA_RDCNT     
					    ,FMDA_OPN_REGCNT 
					    ,FMDA_UP_DT      
					    ,USE_AT         
					    ,FMDA_PUBLIC_DT  
					    ,FMDA_PUBLIC_YN  
					)
			VALUES	(	    
					     #FMDA_IDX#
					    ,#FMDA_AUDIT_ST#   
					    ,#FMDA_AUDIT_ET# 
					    ,#FMDA_DEPT#       
					    ,#FMDA_PART#       
					    ,#FMDA_PROC#      
					    ,SYSDATE      
					    ,#FMDA_TXT#      
					    ,#DOC_ID#        
					    ,#FMDA_SJ#        
					    ,#FMDA_RDCNT#     
					    ,#FMDA_OPN_REGCNT# 
					    ,SYSDATE      
					    ,'Y'        
					    ,#FMDA_PUBLIC_DT#  
					    ,#FMDA_PUBLIC_YN#          
					)
     	]]>
     </insert>
          
	<!-- 삭제 -->
	<delete id="CSPHPM004QDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			  FROM TBCSPTSM001M 				
			 WHERE FMDA_IDX = #FMDA_IDX#
		]]>
	</delete>
	
     <!-- 홈페이지용 select :: 홈페이지 연계 -->
     <select id="CSPHPM004QSendHomepageselect" parameterClass="paramMap"
		resultClass="resultMap">
     <![CDATA[
			SELECT
				  A.FMDA_IDX
				, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD') || ' ~ ' ||TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD')  AS FMDA_AUDIT
				, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD')  AS FMDA_AUDIT_ST
				, TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD') AS FMDA_AUDIT_ET
				, A.FMDA_TXT	
				, A.FMDA_DEPT
				, (SELECT dpt_nm 					
            	 	 FROM tbdcmacm002m	
            		WHERE use_yn = 'Y'
            		  AND dpt_cd = A.FMDA_DEPT         		 
            	) AS FMDA_DEPT_NM
				, A.FMDA_PART
				, A.FMDA_PROC
				, A.FMDA_DT
				, A.FMDA_SJ
				, A.FMDA_RDCNT
				, A.FMDA_OPN_REGCNT
				, A.ATCH_FILE_ID as DOC_ID
				, TO_CHAR(A.FMDA_PUBLIC_DT, 'YYYY-MM-DD') AS FMDA_PUBLIC_DT
				, A.FMDA_PUBLIC_YN
				, A.USE_AT
                , #FLAG# as FLAG
                , A.FMDA_UP_DT
			FROM TBCSPTSM001M	A	
			WHERE USE_AT = 'Y'
			 AND FMDA_IDX = #FMDA_IDX#
      ]]>
     </select>
     
     <!--  연계 테이블 안에 데이터 insert -->
     <insert id="CSPHPM004QSEND001Insert" parameterClass="paramMap">
     	<![CDATA[
     		INSERT INTO	EH_INF_SP_HP_002
     				(	IF_SEQ         
					    ,IF_TYPE       
					    ,IF_SIID 
					    ,DVSN_CD       
					    ,FMDA_IDX       
					    ,FMDA_AUDIT_ST   
					    ,FMDA_AUDIT_ET  
					    ,FMDA_DEPT       
					    ,FMDA_PART       
					    ,FMDA_PROC      
					    ,FMDA_DT         
					    ,FMDA_TXT      
					    ,ATCH_FILE_ID        
					    ,FMDA_SJ        
					    ,FMDA_RDCNT     
					    ,FMDA_OPN_REGCNT 
					    ,FMDA_UP_DT      
					    ,USE_AT         
					    ,FMDA_PUBLIC_DT  
					    ,FMDA_PUBLIC_YN  
					    ,FLAG            
					)
			VALUES	(	#IF_SEQ#
						,'SND'
						,#IF_SIID#  
						,#DVSN_CD#       
					    ,#FMDA_IDX#       
					    ,#FMDA_AUDIT_ST#   
					    ,#FMDA_AUDIT_ET# 
					    ,#FMDA_DEPT#       
					    ,#FMDA_PART#       
					    ,#FMDA_PROC#      
					    ,#FMDA_DT#         
					    ,#FMDA_TXT#      
					    ,#DOC_ID#        
					    ,#FMDA_SJ#        
					    ,#FMDA_RDCNT#     
					    ,#FMDA_OPN_REGCNT# 
					    ,#FMDA_UP_DT#      
					    ,#USE_AT#         
					    ,#FMDA_PUBLIC_DT#  
					    ,#FMDA_PUBLIC_YN#  
					    ,#FLAG#            
					)
     	]]>
     </insert>
	
	<select id="CSPHPM004QGetMaxFmdxIdx" parameterClass="paramMap" resultClass="Integer">
		<![CDATA[
			SELECT	NVL(MAX(FMDA_IDX),0)+1
			FROM	TBCSPTSM001M
		]]>
	</select>
	
	<select id="CSPHPM004QExcelExportSelect" parameterClass="paramMap" resultClass="resultMap">
	
		<![CDATA[
		SELECT T.* ,
               ROW_NUMBER() OVER(
                 ORDER BY FMDA_AUDIT_ST DESC, FMDA_IDX DESC ) AS NUM
          FROM (SELECT DT.* , COUNT(1) OVER() AS TOT_CNT
                  FROM (
				SELECT
					  A.FMDA_IDX
					, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD') || ' ~ ' ||TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD')  AS FMDA_AUDIT
					, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD')  AS FMDA_AUDIT_ST
					, TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD') AS FMDA_AUDIT_ET
					, A.FMDA_TXT	
					, A.FMDA_DEPT
					, (SELECT dpt_nm 					
	            	 	 FROM tbdcmacm002m	
	            		WHERE use_yn = 'Y'
	            		  AND dpt_cd = A.FMDA_DEPT         		 
	            	) AS FMDA_DEPT_NM
					, A.FMDA_PART
					, A.FMDA_PROC
	                , (CASE WHEN A.FMDA_PROC='0' THEN '실지감사' 
	                        WHEN A.FMDA_PROC='1' THEN '의견수렴' 
	                        WHEN A.FMDA_PROC='2' THEN '감사보고서작성' 
	                        WHEN A.FMDA_PROC='3' THEN '감사보고서 검토 및 심의' 
	                        WHEN A.FMDA_PROC='4' THEN '감사보고서 시행 및 공개 준비' 
	                        WHEN A.FMDA_PROC='5' THEN '감사보고서 공개'  END) AS FMDA_PROC_NM
					, A.FMDA_DT
					, A.FMDA_SJ
					, A.FMDA_RDCNT
					, A.FMDA_OPN_REGCNT
					, A.ATCH_FILE_ID AS DOC_ID
					, TO_CHAR(A.FMDA_PUBLIC_DT, 'YYYY-MM-DD') AS FMDA_PUBLIC_DT
					, A.FMDA_PUBLIC_YN
	                , (CASE WHEN A.FMDA_PUBLIC_YN='Y' THEN '공개' ELSE '비공개' END ) AS FMDA_PUBLIC_NM
					, (CASE WHEN A.FMDA_PUBLIC_YN IS NULL THEN '공개전' 
	                        WHEN A.FMDA_PUBLIC_YN = 'Y' AND TO_CHAR(SYSDATE,'YYYYMMDD') < TO_CHAR(A.fmda_public_dt,'YYYYMMDD' ) THEN '' 
	                        WHEN A.FMDA_PUBLIC_YN = 'Y' AND TO_CHAR(SYSDATE,'YYYYMMDD') >= TO_CHAR(A.fmda_public_dt,'YYYYMMDD' ) 
	                        	AND TO_CHAR(SYSDATE,'YYYYMMDD') NOT BETWEEN TO_CHAR(A.fmda_public_dt,'YYYYMMDD' ) AND TO_CHAR(A.fmda_public_dt+14,'YYYYMMDD' ) THEN '공개기간 경과'
	                 END) AS FMDA_HOME_ST
				FROM TBCSPTSM001M	A	
				WHERE USE_AT = 'Y'
				AND A.FMDA_DEPT IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#)))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/
			]]>	
			<isNotEmpty property="strSpvBrdvCd">	 
				  AND A.FMDA_DEPT = #strSpvBrdvCd#		<!-- 담당부서 과조회 --> 
			</isNotEmpty>
			<isNotEmpty property="strFMDA_PROC"> <!--  처리상태구분 -->
				 	AND	A.FMDA_PROC = #strFMDA_PROC#
			</isNotEmpty>
			
			
			<isNotEmpty  property="strYr"> <!-- 연도별 -->
			 		AND SUBSTR(a.FMDA_DT,1,4) = #strYr#	
			</isNotEmpty>	
			
			<isNotEmpty property="strSearchBox" > <!-- 검색조건-->
			 		AND ( UPPER(A.FMDA_SJ) LIKE UPPER('%' || #strSearchBox# || '%') OR  UPPER(A.FMDA_TXT) LIKE UPPER('%' || #strSearchBox# || '%') )
			</isNotEmpty>
			
			) DT
            ORDER BY FMDA_AUDIT_ST DESC,  FMDA_IDX DESC ) T 
	</select>
	
	
</sqlMap> 
