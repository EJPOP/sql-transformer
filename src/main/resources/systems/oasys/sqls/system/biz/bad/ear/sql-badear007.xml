<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/ear/007">

	<resultMap class="java.util.HashMap" id="hwpDocMap">
		<result property="TOT_CNT" column="TOT_CNT" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="SUMPRT_ALL_TXT" column="SUMPRT_ALL_TXT" jdbcType="CLOB"
			javaType="java.lang.String" />
		<result property="DSP_RQ_HND_SBJ" column="DSP_RQ_HND_SBJ" jdbcType="CLOB"
			javaType="java.lang.String" />
		<result property="DSP_RQ_HND_SBJ_TXT" column="DSP_RQ_HND_SBJ_TXT" jdbcType="CLOB"
			javaType="java.lang.String" />			
		<result property="SUMPRT_TXT" column="SUMPRT_TXT" jdbcType="CLOB"
			javaType="java.lang.String" />
		<result property="AUD_YR" column="AUD_YR" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="AUD_NO" column="AUD_NO" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="AUD_YRNO" column="AUD_YRNO" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="AUD_YR_RQ_NO" column="AUD_YR_RQ_NO" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="DSP_RQ_SNO" column="DSP_RQ_SNO" jdbcType="NUMBER"
			javaType="java.lang.String" />
		<result property="SUMPRT_IPT_YN" column="SUMPRT_IPT_YN" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="TIT_TXT" column="TIT_TXT" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="ORG_DVSN_CD" column="ORG_DVSN_CD" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="DSP_RQ_KND_CD" column="DSP_RQ_KND_CD" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="AUD_SBJ_NM" column="AUD_SBJ_NM" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="DOC_ID" column="DOC_ID" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="RLTN_ORG_NM" column="RLTN_ORG_NM" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="NUM" column="NUM" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
	</resultMap>

	<!--처분요구목록 -->
	<select id="BADEAR007EMainSelect" parameterClass="paramMap"
		resultMap="hwpDocMap">
		<include refid="include.pageSelct" />
				
		<![CDATA[
		 select d1.AUD_YR as AUD_YR,
		        d1.AUD_NO as AUD_NO,
		        F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-')                          AS AUD_YRNO,
		        F_MNG_KND_AUDYRNO(T1.AUD_YR, T1.AUD_NO, T1.AUD_KND_CD, '-') || '-' || d1.DSP_RQ_SNO  AS AUD_YR_RQ_NO,
		        d1.DSP_RQ_SNO as DSP_RQ_SNO,
		        d1.TIT_TXT as TIT_TXT,
		        F_CODE_NM ('1000125',
		        d1.ORG_DVSN_CD) as ORG_DVSN_CD,
		        F_CODE_NM ('1000002',
		        d1.DSP_RQ_KND_CD) as DSP_RQ_KND_CD,
		        T1.AUD_SBJ_NM as AUD_SBJ_NM,
		        decode(D2.SUMPRT_IPT_YN, 'Y', '등록', null, '미등록', D2.SUMPRT_IPT_YN) AS SUMPRT_IPT_YN,
		        D2.SUMPRT_TXT,
		        D2.DSP_RQ_HND_SBJ,
		        (CASE WHEN NVL(DBMS_LOB.GETLENGTH(D2.DSP_RQ_HND_SBJ_TXT),0) = 0 THEN D2.DSP_RQ_HND_SBJ
		              ELSE D2.DSP_RQ_HND_SBJ_TXT
		          END) AS DSP_RQ_HND_SBJ_TXT,
		        
		        D2.SUMPRT_ALL_TXT,
		        ( select D3.DOC_ID_1 as DOC_ID
		             FROM TBBADEAR028M D3
		            where 1=1
		              and D3.AUD_SLN = T1.AUD_YR||T1.AUD_NO
		              and D3.DGE IN (SELECT MIN(DGE) FROM TBBADEAR028M S1 WHERE S1.AUD_SLN = T1.AUD_YR||T1.AUD_NO)) as DOC_ID,
		        RLTN_ORG_NM as RLTN_ORG_NM
		   from TBBADEAR001M d1,
		        TBBADEAR005M D2,
		        TBBADDED001M T1,
		        ( SELECT A.AUD_YR,
		                  A.AUD_NO,
		                  A.DSP_RQ_SNO,
		                  (CASE WHEN B.CNT = 1 THEN F_ORG_INFO (B.RLTN_ORG_CD,
		                  '1') WHEN B.CNT > 1 THEN F_ORG_INFO (B.RLTN_ORG_CD,
		                  '1') || ' 외 ' || (CNT-1) || ' 건' ELSE ' ' END ) AS RLTN_ORG_NM
		             FROM TBBADEAR006M A,
		                  ( SELECT A.AUD_YR,
		                            A.AUD_NO,
		                            DSP_RQ_SNO,
		                            COUNT(*) CNT,
		                            MIN(RLTN_ORG_CD) AS RLTN_ORG_CD
		                       FROM TBBADEAR006M A
		                      GROUP BY A.AUD_YR,
		                            A.AUD_NO,
		                            DSP_RQ_SNO) B
		            WHERE A.AUD_YR = B.AUD_YR
		              AND A.AUD_NO = B.AUD_NO
		              AND A.DSP_RQ_SNO = B.DSP_RQ_SNO
		              AND A.RLTN_ORG_CD = B.RLTN_ORG_CD) D4
		  where 1=1
			AND D1.AUD_YR = D2.AUD_YR(+)
			AND	D1.AUD_NO = D2.AUD_NO(+)
			AND D1.DSP_RQ_SNO = D2.DSP_RQ_SNO(+)
			AND D1.DSP_RQ_SNO = D4.DSP_RQ_SNO (+ )
			AND D1.AUD_YR = D4.AUD_YR (+ )
			AND D1.AUD_NO = D4.AUD_NO (+ )
			AND D1.AUD_YR = T1.AUD_YR
			AND D1.AUD_NO = T1.AUD_NO
			AND T1.MNG_DPT_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#)))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/		 
    		]]>
		<dynamic>
			<isNotEmpty prepend="AND" property="strAudYr">
				d1.AUD_YR = #strAudYr#
			</isNotEmpty>

			<isNotEmpty prepend="AND" property="strAudYrNoKndCd">	 	
		       SUBSTR(T1.AUD_KND_CD,3,1) = #strAudYrNoKndCd# 
			</isNotEmpty>			
			<isNotEmpty prepend="AND" property="strAudGrnNo">
				T1.AUD_GRN_NO = #strAudGrnNo#
			</isNotEmpty>	
					
			<isNotEmpty prepend="AND" property="strRqKndCd">
				d1.DSP_RQ_KND_CD = #strRqKndCd#
			</isNotEmpty>
			<isEqual prepend="AND" property="strIptYn" compareValue="Y">
				D2.SUMPRT_IPT_YN =	#strIptYn#
			</isEqual>
			<isEqual prepend="AND" property="strIptYn" compareValue="N">
				D2.SUMPRT_IPT_YN IS NULL
			</isEqual>
			<isNotEmpty property="strSpvBrdvCd">	
				   /* 주관국과에서 관리국과로 변경 - 2016.07.05 yyh */ 
			       AND T1.MNG_DPT_CD = #strSpvBrdvCd#
		</isNotEmpty>   
		</dynamic>
		
		
		<![CDATA[       
			/* ORDER BY d1.DSP_RQ_SNO ASC */
		]]>
		
		<include refid="include.pageOrder" />		
	</select>

	<!--공개문 생성 치환기호조회 -->
	<select id="BADEAR007EAbstSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
		 select D1.ABST_NO,
		        D1.ABST_TXT,
		        D1.REGI_DT,
		        (select COUNT(ABST_TXT) from TBBADEAR011L) AS CNT
		   from TBBADEAR011L D1
		  where 1=1
		]]>
	</select>
	
	<insert id="BADEAR007EMainInsert" parameterClass="paramMap">
				 INSERT INTO TBBADEAR005M (AUD_YR,
				        AUD_NO,
				        DSP_RQ_SNO,
				        SUMPRT_ALL_TXT,
				        DSP_RQ_HND_SBJ,
				        DSP_RQ_HND_SBJ_TXT,
				        SUMPRT_IPT_YN,
				        SUMPRT_TXT,
				        FRT_USR_ID,
				        FNL_USR_ID,
				        FNL_DEAL_DPT_CD,
				        FNL_MNU_ID,
				        FRT_REGI_DH,
				        FNL_MDF_DH)
				 VALUES(#AUD_YR#,
				        #AUD_NO#,
				        #DSP_RQ_SNO#,
				        #SUMPRT_ALL_TXT#,
				        #DSP_RQ_HND_SBJ#,
				        #DSP_RQ_HND_SBJ_TXT#,
				        #SUMPRT_IPT_YN#,
				        #SUMPRT_TXT#,
				        #FRT_USR_ID#,
				        #FNL_USR_ID#,
				        #FNL_DEAL_DPT_CD#,
				        #FNL_MNU_ID#,
				        SYSDATE,
				        SYSDATE)
	</insert>	
	
	<insert id="BADEAR007ESubInsert" parameterClass="paramMap">
				INSERT INTO TBBADEAR027H
				(
				    CON_NO,
				    AUD_YR,
				    AUD_NO,
				    DSP_RQ_SNO,
				    CON_HNDL_CD,
				    USE_YN,
				    FRT_USR_ID,
				    FNL_USR_ID,
				    FNL_DEAL_DPT_CD,
				    FNL_MNU_ID,
				    FRT_REGI_DH,
				    FNL_MDF_DH
				)
				VALUES
				(
				    (SELECT NVL(MAX(CON_NO),0)+1 FROM TBBADEAR027H),
				    #AUD_YR#,
				    #AUD_NO#,
				    #DSP_RQ_SNO#,
				    'C',
				    'N',
				    #FRT_USR_ID#,
				    #FNL_USR_ID#,
				    #FNL_DEAL_DPT_CD#,
				    #FNL_MNU_ID#,
				    SYSDATE,
				    SYSDATE
				);
	</insert>	
	
	<update id="BADEAR007EMainUpdate" parameterClass="paramMap">
		<![CDATA[ 	
			UPDATE TBBADEAR005M
			   SET  FNL_MDF_DH        = SYSDATE
		]]>	 
		<isNotNull prepend="," property="SUMPRT_ALL_TXT">SUMPRT_ALL_TXT=#SUMPRT_ALL_TXT# </isNotNull>
		<isNotNull prepend="," property="DSP_RQ_HND_SBJ">DSP_RQ_HND_SBJ=#DSP_RQ_HND_SBJ# </isNotNull>
		<isNotNull prepend="," property="DSP_RQ_HND_SBJ_TXT">DSP_RQ_HND_SBJ_TXT=#DSP_RQ_HND_SBJ_TXT# </isNotNull>
		<isNotNull prepend="," property="SUMPRT_IPT_YN">SUMPRT_IPT_YN=#SUMPRT_IPT_YN# </isNotNull>
		<isNotNull prepend="," property="SUMPRT_TXT">SUMPRT_TXT=#SUMPRT_TXT# </isNotNull>
		<isNotNull prepend="," property="FNL_USR_ID">	       
			      FNL_USR_ID      = #FNL_USR_ID#
		</isNotNull>	
		<isNotNull prepend="," property="FNL_DEAL_DPT_CD">	       
			      FNL_DEAL_DPT_CD  = #FNL_DEAL_DPT_CD#
		</isNotNull>		
		<isNotNull prepend="," property="FNL_MNU_ID">	       
			      FNL_MNU_ID        = #FNL_MNU_ID#
		</isNotNull>
		<![CDATA[ 	
							
			  WHERE 1=1
			    AND AUD_YR = #AUD_YR# 
			    AND AUD_NO = #AUD_NO# 	
			    AND DSP_RQ_SNO = #DSP_RQ_SNO#
		]]>	
	</update>	
	
	<insert id="BADEAR007ESubUpdate" parameterClass="paramMap">
			INSERT INTO TBBADEAR026H
			(
			    CON_NO,
			    AUD_YR,
			    AUD_NO,
			    DSP_RQ_SNO,
			    SUMPRT_ALL_TXT,
			    DSP_RQ_HND_SBJ,
			    SUMPRT_IPT_YN,
			    SUMPRT_TXT,
			    USE_YN,
			    FRT_USR_ID,
			    FNL_USR_ID,
			    FNL_DEAL_DPT_CD,
			    FNL_MNU_ID,
			    FRT_REGI_DH,
			    FNL_MDF_DH
			)
			SELECT   (SELECT NVL(MAX(CON_NO),0)+1 FROM TBBADEAR026H),
			        AUD_YR,
			        AUD_NO,
			        DSP_RQ_SNO,
			        SUMPRT_ALL_TXT,
			        DSP_RQ_HND_SBJ,
			        SUMPRT_IPT_YN,
			        SUMPRT_TXT, 
			        'N',
			        #FRT_USR_ID#,
			        #FNL_USR_ID#,
			        #FNL_DEAL_DPT_CD#,
			        #FNL_MNU_ID#,
			        SYSDATE,
			        SYSDATE
			  FROM TBBADEAR005M
			 WHERE 1=1
			   AND AUD_YR = #AUD_YR# 
			   AND AUD_NO = #AUD_NO# 	
			   AND DSP_RQ_SNO = #DSP_RQ_SNO#			
	</insert>		
	
	<select id="BADEAR007ElawSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[
			SELECT 	A.LAW_LNK_ID			/*법령연결ID*/
			FROM	TBBADCMR013M A	/*PC장비코드*/
			WHERE	1=1
        ]]>
        <dynamic>
        	<isNotEmpty property="strLawTitle">
        			AND	REPLACE(A.LAW_NM,' ','') = #strLawTitle#
        	</isNotEmpty>
        </dynamic>
        <![CDATA[
        	ORDER BY A.LAW_LNK_ID
        ]]>
	</select>   	
</sqlMap> 
