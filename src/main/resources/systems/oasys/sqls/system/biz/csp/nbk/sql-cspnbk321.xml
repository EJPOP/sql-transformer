<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="csp/nbk/321">

	<select id="CSPNBK321ETracHistYYSelect" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK321ETracHistYYSelect */
				DISTINCT SUBSTR(D1.HNDL_YM, 1, 4) AS HNDL_YY
		FROM	TBCSPNBK104L D1
		UNION
		SELECT	TO_CHAR(SYSDATE, 'YYYY') AS HNDL_YY
		FROM	dual
		ORDER BY HNDL_YY DESC
	]]>
	</select>
	
	<select id="CSPNBK321ETracMouiListSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK321ETracMouiListSelect */
				D1.TRAC_KND_CD
				, D1.MOUI_NO
				, D3.USR_NAM
				, D2.CNB
				, D4.DPT_NM
				, D3.RANK_CD
				, F_CODE_NM( '1000176', D3.PST_CD ) AS PST_CD_NM
				, F_CODE_NM( '1000173', D3.RANK_CD ) AS RANK_CD_NM
				, D5.INV_BL
				, D1.DDCT_AM AS CH_DDCT_AM
		FROM	TBCSPNBK103M D1
				, TBCSPNBK001M D2
				, TBDCMACM001M D3
				, TBDCMACM002M D4
				, TBCSPNBK101M D5
		WHERE	D1.MOUI_NO = D2.MOUI_NO
		AND		D2.CNB = D3.CNB
		AND		D3.DPT_CD = D4.DPT_CD
		AND		D1.MOUI_NO = D5.MOUI_NO(+)
		AND		D2.MOUI_DVSN_CD = '0'
		AND		D2.SCS_YN = 'N'
	]]>
		<isNotEmpty property="tracKndCd" prepend="AND">
				D1.TRAC_KND_CD = #tracKndCd#
		</isNotEmpty>
		<isEqual property="dispatchYn" prepend="AND" compareValue="Y">
				D4.DPT_CD = '770770'
		</isEqual>
		<isNotEmpty property="mouiNo" prepend="AND">
				D1.MOUI_NO = #mouiNo#
		</isNotEmpty>
		<isNotEmpty property="mouiNm" prepend="AND">
				D3.USR_NAM LIKE '%' || #mouiNm# || '%'
		</isNotEmpty>
	<![CDATA[
		ORDER BY USR_NAM
	]]>
	</select>
	
	<select id="CSPNBK321ETracHistListSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK321ETracHistListSelect */
				D1.HNDL_YM
				, D1.TRAC_KND_CD
				, D1.MOUI_NO
				, D3.USR_NAM
				, D2.CNB
				, D4.DPT_NM
				, D3.RANK_CD
				, F_CODE_NM( '1000176', D3.PST_CD ) AS PST_CD_NM
				, F_CODE_NM( '1000173', D3.RANK_CD ) AS RANK_CD_NM
				, D5.INV_BL
				, D1.DDCT_AM
		FROM	TBCSPNBK104L D1
				, TBCSPNBK001M D2
				, TBDCMACM001M D3
				, TBDCMACM002M D4
				, TBCSPNBK101M D5
		WHERE	D1.MOUI_NO = D2.MOUI_NO
		AND		D2.CNB = D3.CNB
		AND		D3.DPT_CD = D4.DPT_CD
		AND		D1.MOUI_NO = D5.MOUI_NO(+)
		AND		D2.MOUI_DVSN_CD = '0'
		AND		D2.SCS_YN = 'N'
	]]>
		<isNotEmpty property="hndlYm" prepend="AND">
				D1.HNDL_YM = #hndlYm#
		</isNotEmpty>
		<isNotEmpty property="tracKndCd" prepend="AND">
				D1.TRAC_KND_CD = #tracKndCd#
		</isNotEmpty>
		<isNotEmpty property="mouiNo" prepend="AND">
				D1.MOUI_NO = #mouiNo#
		</isNotEmpty>
		<isNotEmpty property="mouiNm" prepend="AND">
				D3.USR_NAM LIKE '%' || #mouiNm# || '%'
		</isNotEmpty>
	<![CDATA[
		ORDER BY USR_NAM
	]]>
	</select>
	
	<select id="CSPNBK321ETracHistTotalSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK321ETracHistTotalSelect */
				COUNT(D1.MOUI_NO) AS CNT
				, NVL(SUM(DDCT_AM), 0) AS TOT_DDCT_AM
		FROM	TBCSPNBK104L D1
				, TBCSPNBK001M D2
		WHERE	D1.MOUI_NO = D2.MOUI_NO
		AND		D1.HNDL_YM = #hndlYm#
		AND		D1.TRAC_KND_CD = #tracKndCd#
		AND		D2.MOUI_DVSN_CD = '0'
		AND		D2.SCS_YN = 'N'
	]]>
	</select>
	
	<select id="CSPNBK321ETracHistExcelListSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK321ETracHistExcelListSelect */
				'1040000' AS DDCT_ORG_CD
				, D3.USR_NAM
				, D3.EIN
				, 'C50' AS DDCD_CD
				, 0 AS SLN
				, D1.HNDL_YM AS START_YM
				, 'AA' AS SAL_DVSN_CD
				, D1.DDCT_AM
				, '' AS DDCT_YY_DVSN_CD
				, '' AS BNK_CD
				, '' AS ACNB
				, D1.HNDL_YM AS END_YM
				, '' AS RMK
				, '' AS UPD_USER_ID
				, '' AS UPD_DH
		FROM	TBCSPNBK104L D1
				, TBCSPNBK001M D2
				, TBDCMACM001M D3
		WHERE	D1.MOUI_NO = D2.MOUI_NO
		AND		D2.CNB = D3.CNB
		AND		D1.HNDL_YM = #hndlYm#
		AND		D1.TRAC_KND_CD = #tracKndCd#
		AND		D1.DDCT_AM > 0
		AND		D2.MOUI_DVSN_CD = '0'
		AND		D2.SCS_YN = 'N'
		ORDER BY USR_NAM
	]]>
	</select>
	
	<delete id="CSPNBK321ETracHistListByHndlYmDelete" parameterClass="paramMap">
	<![CDATA[
		DELETE	/* CSPNBK321ETracHistListByHndlYmDelete */
		FROM	TBCSPNBK104L D1
		WHERE	D1.HNDL_YM = #hndlYm#
		AND		D1.TRAC_KND_CD = #tracKndCd#
	]]>
	</delete>
	
	<insert id="CSPNBK321ETracMouiListCopyByHndlYmInsert" parameterClass="paramMap">
	<![CDATA[
		INSERT INTO TBCSPNBK104L /* CSPNBK321ETracMouiListCopyByHndlYmInsert */
		(
			HNDL_YM
			, TRAC_KND_CD
			, MOUI_NO
			, DDCT_AM
			, INV_M_TRAC_HNDL_STA_CD
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		)
		SELECT	#hndlYm#
				, D1.TRAC_KND_CD
				, D1.MOUI_NO
				, D1.DDCT_AM
				, '0'
				, #usrId#
				, #usrId#
				, #dptCd#
				, #mnuId#
				, SYSDATE
				, SYSDATE
		FROM	TBCSPNBK103M D1
		WHERE	D1.TRAC_KND_CD = #tracKndCd#
		AND		D1.DDCT_AM > 0
	]]>
	</insert>
	
	<insert id="CSPNBK321ETracInvJiInsert" parameterClass="paramMap">
	<![CDATA[
		INSERT INTO /* CSPNBK321ETracInvJiInsert */ TBCSPNBK102L
		(
			MOUI_NO
			, INV_DEAL_DT
			, INV_DEAL_SLN
			, OPT_MOUI_NO
			, PET_DH
			, INV_AM
			, DEPTS_PMT_DVSN_CD
			, DEAL_BK_LEDG_BL
			, DEAL_AF_LEDG_BL
			, RMK
			, CNL_YN
			, BBK_PRT_YN
			, INV_KND_CD
			, SMB_DEAL_DT
			, SMB_SLN
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		)
		SELECT	D1.MOUI_NO
				, TO_CHAR(SYSDATE, 'YYYYMMDD') AS INV_DEAL_DT
				, ( SELECT NVL(MAX(D2.INV_DEAL_SLN), 0) + 1 FROM TBCSPNBK102L D2 WHERE D2.MOUI_NO = D1.MOUI_NO AND D2.INV_DEAL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD') ) AS INV_DEAL_SLN
				, '' AS OPT_MOUI_NO
				, SYSDATE AS PET_DH
				, D1.DDCT_AM AS INV_AM
				, 'C' AS DEPTS_PMT_DVSN_CD
				, ( SELECT D3.INV_BL FROM TBCSPNBK101M D3 WHERE D3.MOUI_NO = D1.MOUI_NO ) AS DEAL_BK_LEDG_BL
				, ( SELECT D3.INV_BL FROM TBCSPNBK101M D3 WHERE D3.MOUI_NO = D1.MOUI_NO ) + D1.DDCT_AM AS DEAL_AF_LEDG_BL
				, F_CODE_NM( '1000165', D1.TRAC_KND_CD ) AS RMK
				, 'N' AS CNL_YN
				, 'N' AS BBK_PRT_YN
				, '1' AS INV_KND_CD
				, #smbDealDt# AS SMB_DEAL_DT
				, #smbSln# AS SMB_SLN
				, #usrId# AS FRT_USR_ID
				, #usrId# AS FNL_USR_ID
				, #dptCd# AS FNL_DEAL_DPT_CD
				, #mnuId# AS FNL_MNU_ID
				, SYSDATE AS FRT_REGI_DH
				, SYSDATE AS FNL_MDF_DH
		FROM	TBCSPNBK104L D1
		WHERE	D1.HNDL_YM = #hndlYm#
		AND		D1.TRAC_KND_CD = #tracKndCd#
		AND		D1.DDCT_AM > 0
	]]>
	</insert>
	
	<update id="CSPNBK321ETracInvBlUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK321ETracInvBlUpdate */ TBCSPNBK101M D2
		SET		INV_BL = INV_BL + ( SELECT	D3.DDCT_AM
									FROM	TBCSPNBK104L D3
									WHERE	D3.HNDL_YM = #hndlYm#
									AND		D3.TRAC_KND_CD = #tracKndCd#
									AND		D3.DDCT_AM > 0  
									AND		D3.MOUI_NO = D2.MOUI_NO)
				, FNL_USR_ID = #usrId#
				, FNL_DEAL_DPT_CD = #dptCd#
				, FNL_MNU_ID = #mnuId#
				, FNL_MDF_DH = SYSDATE
		WHERE	D2.MOUI_NO IN (
								SELECT	D1.MOUI_NO
								FROM	TBCSPNBK104L D1
								WHERE	D1.HNDL_YM = #hndlYm#
								AND		D1.TRAC_KND_CD = #tracKndCd#
								AND		D1.DDCT_AM > 0
							)
	]]>
	</update>
	
	<update id="CSPNBK321ETracCompleteUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK321ETracCompleteUpdate */ TBCSPNBK104L D1
		SET		INV_M_TRAC_HNDL_STA_CD = '3'
				, FNL_USR_ID = #usrId#
				, FNL_DEAL_DPT_CD = #dptCd#
				, FNL_MNU_ID = #mnuId#
				, FNL_MDF_DH = SYSDATE
		WHERE	D1.HNDL_YM = #hndlYm#
		AND		D1.TRAC_KND_CD = #tracKndCd#
		AND		D1.DDCT_AM > 0
	]]>
	</update>
	
	<insert id="CSPNBK321ETracCreateNextMonthInsert" parameterClass="paramMap">
	<![CDATA[
		INSERT INTO /* CSPNBK321ETracCreateNextMonthInsert */ TBCSPNBK104L
		(
			HNDL_YM
			, TRAC_KND_CD
			, MOUI_NO
			, DDCT_AM
			, INV_M_TRAC_HNDL_STA_CD
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		)
		SELECT	TO_CHAR( ADD_MONTHS(TO_DATE(#hndlYm#, 'YYYYMM'), 1), 'YYYYMM') AS HNDL_YM
				, D1.TRAC_KND_CD
				, D1.MOUI_NO
				, D1.DDCT_AM
				, '1' AS INV_M_TRAC_HNDL_STA_CD
				, #usrId# AS FRT_USR_ID
				, #usrId# AS FNL_USR_ID
				, #dptCd# AS FNL_DEAL_DPT_CD
				, #mnuId# AS FNL_MNU_ID
				, SYSDATE AS FRT_REGI_DH
				, SYSDATE AS FNL_MDF_DH
		FROM	TBCSPNBK104L D1
		WHERE	D1.HNDL_YM = #hndlYm#
		AND		D1.TRAC_KND_CD = #tracKndCd#
		AND		D1.DDCT_AM > 0
	]]>
	</insert>
	
	<select id="CSPNBK321ETracHistDiffCntSelect" parameterClass="paramMap" resultClass="int">
	<![CDATA[
		SELECT	/* CSPNBK321ETracHistDiffCntSelect */
				COUNT(D3.MOUI_NO) AS CNT
		FROM	(
					SELECT	D2.MOUI_NO
							, D2.DDCT_AM
							, D1.DDCT_AM AS DDCT_AM_DE
							, NVL(D2.DDCT_AM, 0) - NVL(D1.DDCT_AM, 0) AS DDCT_AM_TT
					FROM	TBCSPNBK103M D1
							, TBCSPNBK104L D2
					WHERE	D2.MOUI_NO = D1.MOUI_NO(+)
					AND		D2.TRAC_KND_CD = D1.TRAC_KND_CD(+)
					AND		D2.HNDL_YM = #hndlYm#
					AND		D2.TRAC_KND_CD = #tracKndCd#
					AND		D2.DDCT_AM > 0
				) D3
		WHERE	D3.DDCT_AM_TT != 0
	]]>
	</select>
	
	<select id="CSPNBK321ETracCmplYnSelect" parameterClass="paramMap" resultClass="String">
	<![CDATA[
		SELECT	/* CSPNBK321ETracCmplYnSelect */
				(
					CASE
						WHEN D2.INV_M_TRAC_HNDL_STA_CD = '3'
						THEN 'Y'
						ELSE 'N'
					END
				) AS HNDL_CMPL_YN
		FROM	(
					SELECT	DISTINCT INV_M_TRAC_HNDL_STA_CD
					FROM	TBCSPNBK104L D1
					WHERE	D1.HNDL_YM = #hndlYm#
					AND		D1.TRAC_KND_CD = #tracKndCd#
					AND		D1.DDCT_AM > 0
				) D2
	]]>
	</select>
	
	<delete id="CSPNBK321ETracInfoByTracKndCdDelete" parameterClass="paramMap">
	<![CDATA[
		DELETE	/* CSPNBK321ETracInfoByTracKndCdDelete */
		FROM	TBCSPNBK103M D1
		WHERE	TRAC_KND_CD = #tracKndCd#
	]]>
	</delete>
	
	<select id="CSPNBK321ETracInfoCheckUserSelect" parameterClass="paramMap" resultClass="int">
	<![CDATA[
		SELECT	/* CSPNBK321ETracInfoCheckUserSelect */
				COUNT(D1.CNB) AS CNT
		FROM	TBDCMACM001M D1
		WHERE	D1.CNB = #CNB#
		AND		D1.USR_NAM = #USR_NAM#
	]]>
	</select>
	
	<select id="CSPNBK321ETracInfoCheckMouiSelect" parameterClass="paramMap" resultClass="String">
	<![CDATA[
		SELECT	/* CSPNBK321ETracInfoCheckMouiSelect */
				D1.MOUI_NO
		FROM	TBCSPNBK001M D1
		WHERE	D1.CNB = #CNB#
		AND		D1.MOUI_DVSN_CD = '0'
		AND		D1.SCS_YN = 'N'
	]]>
	</select>
	
	<select id="CSPNBK321EMouiInfoSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK321EMouiInfoSelect */
				D2.MOUI_DVSN_CD
				, D2.MOUI_NO
				, D1.USR_NAM
				, D2.CNB
				, D3.DPT_NM 
				, D1.RANK_CD
				, F_CODE_NM( '1000173', D1.RANK_CD ) AS RANK_CD_NM
				, F_CODE_NM( '1000176', D1.PST_CD ) AS PST_CD_NM
				, D3.DPT_CD		
				, NVL(D4.INV_BL, 0) AS INV_BL
				, D4.INV_OAA_DT
		FROM	TBDCMACM001M D1
				, TBCSPNBK001M D2
				, TBDCMACM002M D3
				, TBCSPNBK101M D4
		WHERE	D2.CNB = D1.CNB(+)
		AND		D1.DPT_CD = D3.DPT_CD(+)
		AND		D2.MOUI_NO = D4.MOUI_NO(+)
		AND		D2.MOUI_DVSN_CD = '0'
		AND		D1.CNB = #CNB#
		AND		D2.SCS_YN = 'N'
	]]>
	</select>
	
	<select id="CSPNBK321EselectTracMouiListByConditionOrHistReport" resultClass="resultMap">
		<dynamic>
			<isNotEmpty property="hndlYm">
				/* 이체이력 탭 */
				SELECT  D.DPT_NM,
				        E.CD_NM,
				        B.CNB,
				        C.USR_NAM,
				        SUM(A.DDCT_AM) as DDCT_AM,
				        A.MOUI_NO,
				        #hndlYm# as HNDL_YM
				FROM    TBCSPNBK104L A,
				        TBCSPNBK001M B,
				        TBDCMACM001M C,
				        TBDCMACM002M D,
				        TBDCMACM013C E
				WHERE   A.HNDL_YM = #hndlYm#
				AND     B.MOUI_DVSN_CD = '0'
				AND     A.MOUI_NO = B.MOUI_NO
				AND     B.CNB = C.CNB
				AND     C.DPT_CD = D.DPT_CD
				AND     E.CMM_CD_DVSN_CD = '1000173'
				AND     E.CD = C.RANK_CD
				GROUP BY D.DPT_NM, C.RANK_CD, B.CNB, E.CD_NM, C.USR_NAM, A.MOUI_NO, C.DPT_CD
				ORDER BY D.DPT_NM, C.RANK_CD, B.CNB
			</isNotEmpty>
			<isEmpty  property="hndlYm">
				/* 이체자관리 탭 */
				SELECT  D.DPT_NM,
				        E.CD_NM,
				        B.CNB,
				        C.USR_NAM,
				        SUM(A.DDCT_AM) as DDCT_AM,
				        A.MOUI_NO,
				        TO_CHAR(SYSDATE, 'YYYYMM') AS HNDL_YM
				FROM    TBCSPNBK103M A,
				        TBCSPNBK001M B,
				        TBDCMACM001M C,
				        TBDCMACM002M D,
				        TBDCMACM013C E
				WHERE   1 = 1
				AND     B.MOUI_DVSN_CD = '0'
				AND     A.MOUI_NO = B.MOUI_NO
				AND     B.CNB = C.CNB
				AND     C.DPT_CD = D.DPT_CD
				AND     E.CMM_CD_DVSN_CD = '1000173'
				AND     E.CD = C.RANK_CD
				GROUP BY D.DPT_NM, C.RANK_CD, B.CNB, E.CD_NM, C.USR_NAM, A.MOUI_NO, C.DPT_CD
				ORDER BY D.DPT_NM, C.RANK_CD, B.CNB
			</isEmpty>
		</dynamic>
	</select>
</sqlMap>