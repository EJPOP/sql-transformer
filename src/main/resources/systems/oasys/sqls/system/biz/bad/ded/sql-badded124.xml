<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/ded/124">
	<select id="BADDED124PMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[
		    SELECT D1.BZT_YR 
		         , D1.BZT_SNO 
		         , D1.PCT_CNB 
		         , D1.PCT_NM||'('||D1.PCT_CNB||')' AS PCT_NM 
		         , D1.PCT_RANK_CD
		         , F_CODE_NM('1000173', D1.PCT_RANK_CD)   	   AS PCT_RANK_NM   /*직급명*/
		         , CASE WHEN D3.CNT<=0  AND D2.PCT_CNB IS NOT NULL THEN 'Y' ELSE D1.LEAD_EXS_RCV_EXS_RCIT_PEN_YN END LEAD_EXS_RCV_EXS_RCIT_PEN_YN
		      FROM TBBADDED010L D1
		         , (SELECT BZT_YR ,
		               BZT_SNO ,
		               BZT_TL_CNB ,
		               PCT_CNB
		          FROM (SELECT D1.BZT_YR ,
		                       D1.BZT_SNO ,
		                                       CASE
		                                         WHEN D2.LEAD_EXS_RCV_EXS_RCIT_PEN_YN = 'Y' THEN D2.PCT_CNB
		                                         WHEN D2.LEAD_EXS_RCV_EXS_RCIT_PEN_YN IS NULL THEN D1.BZT_TL_CNB
		                                       END AS BZT_TL_CNB ,
		                       D2.PCT_CNB
		                  FROM TBBADDED002M D1 /*출장상황기본*/,
		                       TBBADDED010L D2 /*출장비수령자내역*/
		                 WHERE 1=1
		                   AND D1.BZT_YR   = #BZT_YR#
		                   AND D1.BZT_SNO  = #BZT_SNO#
		                   AND D1.BZT_YR = D2.BZT_YR(+)
		                   AND D1.BZT_SNO = D2.BZT_SNO(+) )
		         WHERE 1=1
		           AND BZT_TL_CNB = PCT_CNB ) D2
		        , (
		            SELECT BZT_YR
		                 , BZT_SNO
		                 , SUM(CASE WHEN NVL(D1.LEAD_EXS_RCV_EXS_RCIT_PEN_YN,'N') = 'Y' THEN 1 ELSE 0 END) AS CNT 
		              FROM TBBADDED010L D1
		             WHERE 1=1
		               AND D1.BZT_YR   = #BZT_YR#
		               AND D1.BZT_SNO  = #BZT_SNO#
		             GROUP BY BZT_YR, BZT_SNO
		         ) D3
		     WHERE 1=1
		       AND D1.BZT_YR   = D2.BZT_YR(+)
		       AND D1.BZT_SNO  = D2.BZT_SNO(+)
		       AND D1.PCT_CNB  = D2.PCT_CNB(+)
		       AND D1.BZT_YR   = D3.BZT_YR(+)
		       AND D1.BZT_SNO  = D3.BZT_SNO(+)
		       AND D1.BZT_YR   = #BZT_YR#
		       AND D1.BZT_SNO  = #BZT_SNO#
		    ORDER BY TO_NUMBER(D1.PCT_CNB)          
		]]>
	</select>	
	
	
	<!--지휘비/수용비수령자를   저장한다. update-->
	<update id="BADDED124PMainUpdate" parameterClass="paramMap">
        <![CDATA[ 
        	UPDATE TBBADDED010L
        	   SET BZT_YR		= #BZT_YR#
				 , BZT_SNO		= #BZT_SNO#
				 , PCT_CNB		= #PCT_CNB#
		]]>		 
		<isNotNull prepend="," property="LEAD_EXS_RCV_EXS_RCIT_PEN_YN">	       
			     LEAD_EXS_RCV_EXS_RCIT_PEN_YN  = #LEAD_EXS_RCV_EXS_RCIT_PEN_YN#
		</isNotNull>		
		<isNotNull prepend="," property="FNL_USR_ID">	       
			     FNL_USR_ID  = #FNL_USR_ID#
		</isNotNull>	
		<isNotNull prepend="," property="FNL_DEAL_DPT_CD">	       
			     FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		</isNotNull>		
		<isNotNull prepend="," property="FNL_MNU_ID">	       
			     FNL_MNU_ID  = #FNL_MNU_ID#
		</isNotNull>		
        <![CDATA[ 
				  , FNL_MDF_DH              = SYSDATE		                                                                                                                                                                                                                                                                                                                                                                                                          
			  WHERE 1=1
				AND BZT_YR                 = #BZT_YR# 
			    AND BZT_SNO                = #BZT_SNO#  
			    AND PCT_CNB				   = #PCT_CNB#   
		]]>		
	</update>	
	
</sqlMap> 

