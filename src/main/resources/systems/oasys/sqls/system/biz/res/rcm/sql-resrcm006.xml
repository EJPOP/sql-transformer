<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="res/rcm/006">

	<select id="RESRCM006IMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT rownum AS NUM,
			       T1.EVL_YR /* 평가년도 */,
			       T1.HLYR_DVSN_CD /* 반기구분코드 */,
			       T1.EVL_DGE /* 평가차수 */,
			       T1.PTCPT_CNB,
			       T1.PTCPT_DPT_CD /* 평가대상부서코드 */,
			       F_USR_INFO(T1.PTCPT_CNB,'2') AS PTCPT_NM,
			       F_DPT_INFO(T1.PTCPT_DPT_CD,'1') AS PTCPT_DPT_NM,
			       T1.EVL_RK_CD /* 평가대상부서코드 */,
			       (SELECT CD_NM FROM TBRESRCM006C WHERE 1=1 AND EVL_YR = T1.EVL_YR AND HLYR_DVSN_CD = T1.HLYR_DVSN_CD 
			                       AND EVL_DGE = T1.EVL_DGE AND CD <> '0000' AND CD = T1.EVL_RK_CD) AS EVL_RK_NM,
			       T1.EVL_OPIN /* 평가의견 */,
			       COUNT(1) OVER () AS TOT_CNT
			  FROM TBRESROF003D T1
			 WHERE 1=1
		]]>
		<isNotEmpty property="EVL_YR">	
			   AND T1.EVL_YR = #EVL_YR#
		</isNotEmpty>

		<isNotEmpty property="HLYR_DVSN_CD">	
			   AND T1.HLYR_DVSN_CD = #HLYR_DVSN_CD#
		</isNotEmpty>
		
		<isNotEmpty property="EVL_DGE">	
			   AND T1.EVL_DGE = #EVL_DGE#
		</isNotEmpty>		
		<isNotEmpty property="PTCPT_DPT_CD">	
			   AND T1.PTCPT_DPT_CD = #PTCPT_DPT_CD#
		</isNotEmpty>		
		<isNotEmpty property="PTCPT_CNB">
			   AND T1.PTCPT_CNB IN
					<iterate property="PTCPT_CNB" open="(" close=")" conjunction=",">
						#PTCPT_CNB[]#
					</iterate>
		</isNotEmpty>
	     
		<isNotEmpty property="APV_DOC_NO">	
			   AND T1.APV_DOC_NO = #APV_DOC_NO#
		</isNotEmpty>
	     
		ORDER BY T1.PTCPT_DPT_CD ASC, F_USR_INFO(T1.PTCPT_CNB,'9') ASC, T1.PTCPT_CNB ASC
	</select>
	
	<update id="RESRCM006IApvSave" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBRESROF003D T1
			   SET APV_DOC_NO = #APV_DOC_NO#
			      ,APV_STA_CD = #APV_STA_CD#
			 WHERE 1=1
		]]>
		
		<isNotEmpty property="PTCPT_CNB">
			AND T1.EVL_YR = #EVL_YR#
			AND T1.HLYR_DVSN_CD = #HLYR_DVSN_CD#
			AND T1.EVL_DGE = #EVL_DGE#
			AND T1.PTCPT_DPT_CD = #PTCPT_DPT_CD#
		   	AND T1.PTCPT_CNB IN
				<iterate property="PTCPT_CNB" open="(" close=")" conjunction=",">
					#PTCPT_CNB[]#
				</iterate>
		</isNotEmpty>
		
		<isEmpty property="PTCPT_CNB">
			AND APV_DOC_NO = #APV_DOC_NO#
		</isEmpty>
	</update>
</sqlMap> 
