<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/cmr/002">

	<resultMap class="java.util.HashMap" id="resultClob">
		<result property="SALL_CAT_TIT_NM" column="SALL_CAT_TIT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DPT_NM" column="DPT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="CHGR_NM" column="CHGR_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="YE" column="YE" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="SALL_CAT_SNO" column="SALL_CAT_SNO" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="FIRST_HALF_MDF_DH" column="FIRST_HALF_MDF_DH" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="SECOND_HALF_MDF_DH" column="SECOND_HALF_MDF_DH" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="FIRST_HALF_DOC_ID" column="FIRST_HALF_DOC_ID" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="SECOND_HALF_DOC_ID" column="SECOND_HALF_DOC_ID" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="FIRST_HALF_MAIN_PLCY_DTL_TXT" column="FIRST_HALF_MAIN_PLCY_DTL_TXT" jdbcType="CLOB" javaType="java.lang.String" />
		<result property="SECOND_HALF_MAIN_PLCY_DTL_TXT" column="SECOND_HALF_MAIN_PLCY_DTL_TXT" jdbcType="CLOB" javaType="java.lang.String" />
        <result property="LAG_CAT_TIT_NM" column="LAG_CAT_TIT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="MID_CAT_TIT_NM" column="MID_CAT_TIT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="SUBJ_NO" column="SUBJ_NO" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="CPR_CHGR_ID" column="CPR_CHGR_ID" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="CPR_CHGR_NM" column="CPR_CHGR_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="CPR_DPT_CD" column="CPR_DPT_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="CPR_DPT_NM" column="CPR_DPT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="STD_CHGR_ID" column="STD_CHGR_ID" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="STD_CHGR_NM" column="STD_CHGR_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="STD_DPT_CD" column="STD_DPT_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="STD_DPT_NM" column="STD_DPT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="EPS_MNG_YN" column="EPS_MNG_YN" jdbcType="VARCHAR2" javaType="java.lang.String" />
          
    </resultMap>
    
	<!-- 모니터링 결과 탭에서 필요한 정보를 가져온다. -->
	<select id="BADCMR002Pmainselect" parameterClass="paramMap" resultMap="resultClob">
		<![CDATA[ 
            SELECT D.SALL_CAT_TIT_NM /*과제명*/
			     , F_DPT_INFO(D.CHR_DPT_CD, '1') AS DPT_NM /*담당부서*/
			     , F_USR_INFO(D.CHGR_ID, '2')    AS CHGR_NM /*전담자*/
			     , #strYe# AS YE
				 , #strSallCatSno# AS SALL_CAT_SNO
                 , D.FIRST_HALF_MDF_DH  /*상반기*/
                 , D.SECOND_HALF_MDF_DH /*하반기*/
                 , D.FIRST_HALF_DOC_ID  /*상반기 문서ID*/
                 , D.SECOND_HALF_DOC_ID /*하반기 문서 ID*/
                 , CASE WHEN D.FIRST_HALF_MDF_DH IS NOT NULL THEN (SELECT MAIN_PLCY_DTL_TXT FROM TBBADCMR004D WHERE YE = #strYe# AND SALL_CAT_SNO = #strSallCatSno# AND MAIN_PLCY_DTL_DVSN_CD ='b' AND REGI_DT =  D.FIRST_HALF_MDF_DH)
                        ELSE NULL END FIRST_HALF_MAIN_PLCY_DTL_TXT /*상반기 주요정책상세내용*/
                 , CASE WHEN SECOND_HALF_MDF_DH IS NOT NULL THEN (SELECT MAIN_PLCY_DTL_TXT FROM TBBADCMR004D WHERE YE = #strYe# AND SALL_CAT_SNO = #strSallCatSno# AND MAIN_PLCY_DTL_DVSN_CD ='b' AND REGI_DT =  D.SECOND_HALF_MDF_DH)
                        ELSE NULL END SECOND_HALF_MAIN_PLCY_DTL_TXT /*상반기 주요정책상세내용*/
			     , LAG_CAT_TIT_NM /*대분류 명*/
			     , MID_CAT_TIT_NM /*중분류명*/
			     , SUBJ_NO /*과제번호*/  
			     , D.CPR_CHGR_ID
		     		 , F_USR_INFO(D.CPR_CHGR_ID,'2')AS CPR_CHGR_NM
					, D.CPR_DPT_CD
					, F_DPT_INFO(D.CPR_DPT_CD,'1') AS CPR_DPT_NM
					, D.STD_CHGR_ID
					, F_USR_INFO(D.STD_CHGR_ID,'2')AS STD_CHGR_NM
					, D.STD_DPT_CD
					, F_DPT_INFO(D.STD_DPT_CD,'1') AS STD_DPT_NM   
					, EPS_MNG_YN
			  FROM (		
				SELECT A.SALL_CAT_TIT_NM /*과제명*/
				     , A.CHR_DPT_CD /*담당부서*/
				     , A.CHGR_ID /*전담자*/
				     , MAX(CASE WHEN B.REGI_DT BETWEEN #strYe#||'0101' AND #strYe#||'0401' THEN B.REGI_DT ELSE NULL END) AS FIRST_HALF_MDF_DH  /*상반기*/
	                 , MAX(CASE WHEN B.REGI_DT BETWEEN #strYe#||'0402' AND #strYe#||'1001' THEN B.REGI_DT ELSE NULL END) AS SECOND_HALF_MDF_DH /*하반기*/
	                 , MAX(CASE WHEN B.REGI_DT BETWEEN #strYe#||'0101' AND #strYe#||'0401' THEN B.DOC_ID ELSE NULL END) AS FIRST_HALF_DOC_ID  /*상반기 문서ID*/
	                 , MAX(CASE WHEN B.REGI_DT BETWEEN #strYe#||'0402' AND #strYe#||'1001' THEN B.DOC_ID ELSE NULL END) AS SECOND_HALF_DOC_ID /*하반기 문서 ID*/
				     , (SELECT LAG_CAT_TIT_NM FROM TBBADCMR001M WHERE YE = #strYe# AND LAG_CAT_SNO = A.LAG_CAT_SNO) AS LAG_CAT_TIT_NM /*대분류 명*/
				     , (SELECT MID_CAT_TIT_NM FROM TBBADCMR002M WHERE YE = #strYe# AND LAG_CAT_SNO = A.LAG_CAT_SNO AND MID_CAT_SNO = A.MID_CAT_SNO) AS MID_CAT_TIT_NM /*중분류명*/
				     , #strYe# || '-' || A.LAG_CAT_SNO || '-' || A.MID_CAT_SNO || '-' || #strSallCatSno# AS SUBJ_NO /*과제번호*/
				     , A.CPR_CHGR_ID
					, A.CPR_DPT_CD
					, A.STD_CHGR_ID
					, A.STD_DPT_CD
					, NVL(A.EPS_MNG_YN,'N') AS EPS_MNG_YN
				  FROM TBBADCMR003M A 
				     , TBBADCMR004D B
				 WHERE A.YE           = B.YE (+)
				   AND A.SALL_CAT_SNO = B.SALL_CAT_SNO (+)
				   AND A.YE           = #strYe#
				   AND A.SALL_CAT_SNO = #strSallCatSno#
				   AND B.MAIN_PLCY_DTL_DVSN_CD (+) = 'b' /*모니터링결과*/
				 GROUP BY A.SALL_CAT_TIT_NM, A.CHR_DPT_CD, A.CHGR_ID, A.LAG_CAT_SNO, A.MID_CAT_SNO, A.CPR_CHGR_ID , A.CPR_DPT_CD, A.STD_CHGR_ID, A.STD_DPT_CD, A.EPS_MNG_YN
			 )D
		]]>
	</select>
	
	<!-- 신규등록 전 중복 데이터가 있는지 체크한다. -->
	<select id="BADCMR002PCntselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[ 
			SELECT TO_CHAR(COUNT(*)) AS CNT
			  FROM TBBADCMR004D
			 WHERE YE                    = #YE#
			   AND SALL_CAT_SNO          = #SALL_CAT_SNO#
			   AND MAIN_PLCY_DTL_DVSN_CD = 'b'
			   AND REGI_DT               = #REGI_DT#
		]]>
	</select>
	
	<!-- 주요정책 상세 신규 등록한다. -->
	<insert id="BADCMR002Pmaininsert" parameterClass="paramMap" >
		INSERT INTO TBBADCMR004D
			(
			  YE
			, SALL_CAT_SNO
			, MAIN_PLCY_DTL_DVSN_CD
			, REGI_DT
			, MAIN_PLCY_DTL_TXT
			, DOC_ID
			, DOC_TYP_CD
            , PLCY_MDF_DH
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
			)		
		VALUES
			(
			  #YE#
			, #SALL_CAT_SNO#
			, 'b'
			, #REGI_DT#
			, #MAIN_PLCY_DTL_TXT#
			, #DOC_ID#
			, DECODE(#DOC_ID#, '', '', 'AD-MR-007')
			, TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
			, #FRT_USR_ID# 
			, #FNL_USR_ID#
			, #FNL_DEAL_DPT_CD#
			, #FNL_MNU_ID#
			, SYSDATE
			, SYSDATE			
			)
	</insert> 
	
	<!-- 주요정책상세 수정된 부분 업데이트 한다. -->
	<update id="BADCMR002Pmainupdate" parameterClass="paramMap">
		UPDATE TBBADCMR004D
	       SET FNL_MDF_DH        = SYSDATE
		     , MAIN_PLCY_DTL_TXT = #MAIN_PLCY_DTL_TXT#
		     , DOC_ID            = #DOC_ID#
		     , DOC_TYP_CD        = DECODE(#DOC_ID#, '', '', 'AD-MR-007')
		     , PLCY_MDF_DH       = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
		<isNotEmpty prepend="," property="FNL_USR_ID">
			FNL_USR_ID = #FNL_USR_ID#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
			FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_MNU_ID">
			FNL_MNU_ID = #FNL_MNU_ID#
		</isNotEmpty>
		WHERE 1 = 1
		  AND YE                    = #YE#
		  AND SALL_CAT_SNO          = #SALL_CAT_SNO#
          AND MAIN_PLCY_DTL_DVSN_CD = 'b'
          AND REGI_DT               = #REGI_DT#
	</update>
	
	<!-- 주요정책상세 삭제 -->
	<update id="BADCMR002Pmaindelete" parameterClass="paramMap">
		<![CDATA[   
		   DELETE FROM TBBADCMR004D
			WHERE 1 = 1
			  AND YE                    = #YE#
			  AND SALL_CAT_SNO          = #SALL_CAT_SNO#
	          AND MAIN_PLCY_DTL_DVSN_CD = 'b'
	          AND REGI_DT               = #REGI_DT#
		]]>
	</update>	
	
	<!-- 정책게시판의 입력현황을 조회한다. -->
	<select id="BADCMR002PBoardDataselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[ 
			SELECT TO_CHAR(TO_DATE(SUBSTR(MAX(CASE WHEN REGI_DT BETWEEN #strYe#||'0101' AND #strYe#||'0401' THEN PLCY_MDF_DH ELSE NULL END), 0, 8), 'YYYYMMDD'), 'YYYY.MM.DD') AS FIRST_HALF_MDF_DH  /*상반기*/
                 , TO_CHAR(TO_DATE(SUBSTR(MAX(CASE WHEN REGI_DT BETWEEN #strYe#||'0402' AND #strYe#||'1001' THEN PLCY_MDF_DH ELSE NULL END), 0, 8), 'YYYYMMDD'), 'YYYY.MM.DD') AS SECOND_HALF_MDF_DH /*하반기*/
			  FROM TBBADCMR004D 
			 WHERE YE           = #strYe#
			   AND SALL_CAT_SNO = #strSallCatSno#
			   AND MAIN_PLCY_DTL_DVSN_CD = 'b' /*모니터링결과*/
		]]>
	</select>
	
	<!-- 게시판 조회 -->
	<select id="BADCMR002PBoardselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[ 
			SELECT YE /*연도*/
			     , SALL_CAT_SNO /*소분류순번*/
			     , EVL_NO /*평가번호*/
			     , TIT_NM AS TIT_NM
			     , REPLACE(LPAD(' ', 5*(LEVEL-1)), ' ', '&nbsp') || DECODE(LEVEL, 1, '', '└RE: ') || TIT_NM AS SEE_TIT_NM  /*제목명*/
			     , PLCY_EVL_TXT /*정책평가내용*/
			     , REGN_CNB /*등록자전산번호*/
			     , F_USR_INFO(REGN_CNB, '2') AS REGN_NM /*등록자명*/
			     , TO_CHAR(FRT_REGI_DH, 'YYYY.MM.DD') AS FRT_REGI_DH /*최초등록일자*/
			     , NVL(SRCH_YN, 'N') AS SRCH_YN /*조회여부*/
			     , HIRK_EVL_NO /*상위평가번호*/
			     , '원래의 글--------------------------------------------' || CHR(10) || TIT_NM AS RE_TIT_NM
			     , (SELECT COUNT(*) FROM TBBADCMR006L A WHERE A.YE = BOARD.YE AND A.SALL_CAT_SNO = BOARD.SALL_CAT_SNO AND A.HIRK_EVL_NO = BOARD.EVL_NO) AS DEL_CNT /*뎃글 갯수*/
			  FROM (            
                SELECT YE
                     , SALL_CAT_SNO
                     , EVL_NO
                     , TIT_NM
                     , PLCY_EVL_TXT
                     , REGN_CNB
                     , HIRK_EVL_NO
                     , FRT_REGI_DH
                     , SRCH_YN
                  FROM TBBADCMR006L
				 WHERE YE                         = #strYe#
				   AND SALL_CAT_SNO               = #strSallCatSno#
				   AND SUBSTR(PLCY_REGI_DH, 1, 4) = #strYe#
               ) BOARD
           START WITH HIRK_EVL_NO IS NULL
           CONNECT BY PRIOR EVL_NO = HIRK_EVL_NO
		]]>
	</select>
	
	<!-- 게시판 신규 등록시 평가번호 -->
	<select id="BADCMR002PBoardEvlNoselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[ 
			SELECT TO_CHAR(NVL(MAX(EVL_NO), 0) + 1) AS EVL_NO
			  FROM TBBADCMR006L
			 WHERE YE = #YE#
			   AND SALL_CAT_SNO = #SALL_CAT_SNO#
		]]>
	</select>
	
	<!-- 정책게시판 신규 등록한다. -->
	<insert id="BADCMR002PBoardinsert" parameterClass="paramMap" >
		INSERT INTO TBBADCMR006L
			(
			  YE
			, SALL_CAT_SNO
			, EVL_NO
			, TIT_NM
			, PLCY_EVL_TXT
			, REGN_CNB
			, PLCY_MDF_DH
            , PLCY_REGI_DH
            , HIRK_EVL_NO
            , SRCH_YN
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
			)		
		VALUES
			(
			  #YE#
			, #SALL_CAT_SNO#
			, #EVL_NO#
			, #TIT_NM#
			, #PLCY_EVL_TXT#
			, #REGN_CNB#
			, TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , #HIRK_EVL_NO#
            , 'N'
			, #FRT_USR_ID# 
			, #FNL_USR_ID#
			, #FNL_DEAL_DPT_CD#
			, #FNL_MNU_ID#
			, SYSDATE
			, SYSDATE			
			)
	</insert> 
	
	<!-- 정책게시판 수정된 부분 업데이트 한다. -->
	<update id="BADCMR002PBoardupdate" parameterClass="paramMap">
		UPDATE TBBADCMR006L
	       SET FNL_MDF_DH        = SYSDATE
		     , TIT_NM            = #TIT_NM#
		     , PLCY_EVL_TXT      = #PLCY_EVL_TXT#
		     , PLCY_MDF_DH       = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
		<isNotEmpty prepend="," property="FNL_USR_ID">
			FNL_USR_ID = #FNL_USR_ID#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
			FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_MNU_ID">
			FNL_MNU_ID = #FNL_MNU_ID#
		</isNotEmpty>
		WHERE 1 = 1
		  AND YE            = #YE#
		  AND SALL_CAT_SNO  = #SALL_CAT_SNO#
          AND EVL_NO        = #EVL_NO#
	</update>
	
	<!-- 정책게시판 삭제 전 뎃글 있는지 체크 -->
	<select id="BADCMR002PBoradReplayCntselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[ 
			SELECT TO_CHAR(COUNT(*)) AS CNT
			  FROM TBBADCMR006L
			 WHERE YE           = #YE#
			   AND SALL_CAT_SNO = #SALL_CAT_SNO#
			   AND HIRK_EVL_NO  = #EVL_NO# 
		]]>
	</select>
	
	<!-- 정책게시판 삭제 -->
	<update id="BADCMR002PBoarddelete" parameterClass="paramMap">
		<![CDATA[   
		   DELETE FROM TBBADCMR006L
			WHERE 1 = 1
			  AND YE            = #YE#
			  AND SALL_CAT_SNO  = #SALL_CAT_SNO#
	          AND EVL_NO        = #EVL_NO#
		]]>
	</update>
	
	<!-- 담당자가 들어와서 읽었다. -->
	<update id="BADCMR002PBoardSrchYnsave" parameterClass="paramMap">
		UPDATE TBBADCMR006L
	       SET FNL_MDF_DH        = SYSDATE
		     , SRCH_YN           = 'Y'
		<isNotEmpty prepend="," property="FNL_USR_ID">
			FNL_USR_ID = #FNL_USR_ID#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
			FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_MNU_ID">
			FNL_MNU_ID = #FNL_MNU_ID#
		</isNotEmpty>
		WHERE 1 = 1
		  AND YE            = #strYe#
		  AND SALL_CAT_SNO  = #strSallCatSno#
          AND EVL_NO        = #strEvlNo#
	</update>
</sqlMap> 
