<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/hpm/005">
	
	<!--감사착수 보도자료 정보를 조회한다.-->
	<select id="CSPHPM005Qmainselect" parameterClass="paramMap" 	resultClass="resultMap">
		<include refid = "include.pageSelct"/><!-- 페이징 -->
        <![CDATA[
				SELECT
				  A.FMDA_IDX
				, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD') || ' ~ ' ||TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD')  AS FMDA_AUDIT
				, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD')  AS FMDA_AUDIT_ST
				, TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD') AS FMDA_AUDIT_ET
				, A.FMDA_TXT	
				, A.FMDA_DEPT
				, (SELECT dpt_nm 					
            	 	 FROM tbdcmacm002m	
            		WHERE use_yn = 'Y'
            		  AND dpt_cd = A.FMDA_DEPT         		 
            	) AS FMDA_DEPT_NM
				, A.FMDA_PART
				, A.FMDA_PROC
				, A.FMDA_DT
				, A.FMDA_SJ
				, A.FMDA_RDCNT
				, A.FMDA_OPN_REGCNT
				, A.ATCH_FILE_ID AS DOC_ID
				, TO_CHAR(A.FMDA_PUBLIC_DT, 'YYYY-MM-DD') AS FMDA_PUBLIC_DT
				, A.FMDA_PUBLIC_YN
			FROM TBCSPTSM002M	A	
			WHERE USE_AT = 'Y'
			AND A.FMDA_DEPT IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#)))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/
		]]>		
		<isNotEmpty property="strSpvBrdvCd">	 
			  AND A.FMDA_DEPT = #strSpvBrdvCd#		<!-- 담당부서 과조회 --> 
		</isNotEmpty>   		
		 <!-- <isNotEmpty property="strFMDA_DEPT_NM2" > 담당부서 과 조회
				AND A.FMDA_DEPT = #strFMDA_DEPT_NM2#
		</isNotEmpty> -->
		<!-- <isNotEmpty property="strFMDA_DEPT_NM">담당부서 국조회
				AND	SUBSTR(A.FMDA_DEPT, 1, 3) = SUBSTR(#strFMDA_DEPT_NM#, 1, 3)
		</isNotEmpty> -->
		<isNotEmpty property="strFMDA_PROC"> <!--  처리상태구분 -->
			 	AND	A.FMDA_PROC = #strFMDA_PROC#
		</isNotEmpty>
		
		<isEmpty property="strFMDA_AUDIT_ET"><!-- 시작 작성일 -->
			<isNotEqual property="strFMDA_AUDIT_ST" compareValue="">
				<![CDATA[ AND ( #strFMDA_AUDIT_ST# BETWEEN A.FMDA_AUDIT_ST AND A.FMDA_AUDIT_ET) ]]>
			</isNotEqual>
		</isEmpty>
		<isEmpty property="strFMDA_AUDIT_ST">
			<isNotEqual  property="strFMDA_AUDIT_ET" compareValue="">
				<![CDATA[ AND ( #strFMDA_AUDIT_ET# BETWEEN A.FMDA_AUDIT_ST AND A.FMDA_AUDIT_ET) ]]>
			</isNotEqual>
		</isEmpty>
		
		<isNotEmpty property="strFMDA_AUDIT_ST">
			<isNotEmpty  property="strFMDA_AUDIT_ET">
				AND (#strFMDA_AUDIT_ST# BETWEEN A.FMDA_AUDIT_ST AND A.FMDA_AUDIT_ET OR #strFMDA_AUDIT_ET# BETWEEN A.FMDA_AUDIT_ST AND A.FMDA_AUDIT_ET)
			</isNotEmpty>
		</isNotEmpty>
		
		<isNotEmpty  property="strYr"> <!-- 연도별 -->
		 		AND SUBSTR(a.FMDA_DT,1,4) = #strYr#	
		</isNotEmpty>	
		<isEqual property="strSearchCd" compareValue="1"> <!-- 감사사항 -->
		 		AND UPPER(A.FMDA_SJ) LIKE UPPER('%' || #strSearchBox# || '%')
		</isEqual>
		<isEqual property="strSearchCd" compareValue="2"> <!-- 내용 -->
				AND UPPER(A.FMDA_TXT) LIKE UPPER('%' || #strSearchBox# || '%')
		</isEqual> 
		<include refid = "include.pageOrder"/> <!-- 페이징 -->
	</select>
	
		
	<!-- 국 조회 -->
<!-- 	<select id="selectDeptCombo" parameterClass="paramMap" 	resultClass="resultMap">
		<![CDATA[
			SELECT dpt_cd AS CD, dpt_nm AS CD_NM
			FROM TBDCMACM002M
			WHERE use_yn = 'Y'
			AND SUBSTR(dpt_cd, 4, 6) = '000'
		]]>
	</select> -->
	
	<!-- 과 조회 -->
<!-- 	<select id="selectDeptCombo2" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT dpt_cd AS CD, dpt_nm AS CD_NM
			FROM TBDCMACM002M
			WHERE use_yn = 'Y'
			AND SUBSTR(dpt_cd, 4, 6) != '000'
			AND SUBSTR(dpt_cd, 1, 4) != '1901'
			AND dpt_cd NOT IN('150150', '150160', '150170', '770770', '880880')
			AND dpt_cd NOT IN('140100', '140150', '140170') 
			AND dpt_cd NOT IN('080170', '080180', '080190', '080200', '080210', '080220')
			AND dpt_cd NOT IN('0I0100', '0I0200', '0I0210', '0I0220')
			AND SUBSTR(dpt_cd, 1, 3) NOT IN ('141', '100', '160', '1A0', '170', '200', '300', '150')
			ORDER BY dpt_cd
		]]>
	</select> -->
	
			<!-- 부서 국 리스트 조회 -->
	<select id="csphpm005DeptBureauSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[       
          SELECT DPT_CD, DPT_NM,HIRK_DPT_CD
            FROM TBDCMACM002M
           WHERE 1=1
         
             ]]>
        <isNotEmpty prepend="AND" property="strDptAuth"> 
              DPT_CD IN ( SELECT SUBSTR(DPT_CD,'1','3')||'000' FROM TABLE(F_AUTH_DEPT(#strCnb#, #strDptAuth#, 'Y')))
        </isNotEmpty>
            AND DPT_CD  LIKE '%000'
            AND USE_YN = 'Y'
            AND SUBSTR(dpt_cd, 1, 3) NOT IN ('100', '120', '121', '122', '140', '160', '170', '1A0','200','300','400','500','510','520','530','540','550')
           ORDER BY DPT_CD 					
        
	</select>
	<!-- 부서 과 리스트 조회 -->
	<select id="csphpm005DeptSectSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[       
           SELECT DPT_CD, DPT_NM, HIRK_DPT_CD
             FROM TBDCMACM002M
            WHERE 1=1

                 ]]>
             <isNotEmpty prepend="AND" property="strDptAuth"> 
              DPT_CD IN ( SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #strDptAuth#, 'Y')))
             </isNotEmpty>
             
			<isNotEmpty property="strHrkDptCd">
	        	<isEmpty property="strDptCd">
				AND SUBSTR(DPT_CD, 0, 3) = SUBSTR(#strHrkDptCd#, 0, 3)        	
	        	</isEmpty>
	        	<isNotEmpty property="strDptCd">
	        	OR SUBSTR(DPT_CD, 0, 3) = SUBSTR(#strHrkDptCd#, 0, 3)
	        	</isNotEmpty>
			</isNotEmpty>
			
			  
              AND USE_YN = 'Y'
              AND SUBSTR(dpt_cd, 4, 6) != '000'
			AND SUBSTR(dpt_cd, 1, 4) != '1901'
			AND dpt_cd NOT IN('150160', '150170', '150180', '150190', '770770', '880880')
			AND dpt_cd NOT IN('140100', '140150', '140170') 
			AND dpt_cd NOT IN('080170', '080180', '080190', '080200', '080210', '080220')
			AND dpt_cd NOT IN('0I0100', '0I0200', '0I0210', '0I0220')
			AND SUBSTR(dpt_cd, 1, 3) NOT IN ('121','122','140','141', '100', '160', '1A0', '170', '200', '300','400')
            ORDER BY DPT_CD			
      
	</select>
	
	
	
	<!-- 수정한 내용 저장하기 -->
	<update id="CSPHPM005QUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBCSPTSM002M 
			SET 
				FMDA_AUDIT_ST = #FMDA_AUDIT_ST#, 
				FMDA_AUDIT_ET = #FMDA_AUDIT_ET#,
				FMDA_DEPT  = #FMDA_DEPT#,
				FMDA_PART  = #FMDA_PART#,
				FMDA_TXT  = #FMDA_TXT#,
			    ATCH_FILE_ID  = #DOC_ID#, 
				FMDA_SJ  = #FMDA_SJ#, 
				FMDA_UP_DT = SYSDATE, 
				FMDA_PUBLIC_YN = 'Y'
			WHERE FMDA_IDX = #FMDA_IDX#
		]]>
	</update>
	
	<!--  insert -->
     <insert id="CSPHPM005QInsert" parameterClass="paramMap">
     	<![CDATA[
     		INSERT INTO	TBCSPTSM002M
     				(	    
					     FMDA_IDX       
					    ,FMDA_AUDIT_ST   
					    ,FMDA_AUDIT_ET  
					    ,FMDA_DEPT       
					    ,FMDA_PART       
					    ,FMDA_PROC      
					    ,FMDA_DT         
					    ,FMDA_TXT      
					    ,ATCH_FILE_ID        
					    ,FMDA_SJ        
					    ,FMDA_RDCNT     
					    ,FMDA_OPN_REGCNT 
					    ,FMDA_UP_DT      
					    ,USE_AT         
					    ,FMDA_PUBLIC_DT  
					    ,FMDA_PUBLIC_YN  
					)
			VALUES	(	    
					     #FMDA_IDX#
					    ,#FMDA_AUDIT_ST#   
					    ,#FMDA_AUDIT_ET# 
					    ,#FMDA_DEPT#       
					    ,#FMDA_PART#       
					    ,#FMDA_PROC#      
					    ,SYSDATE      
					    ,#FMDA_TXT#      
					    ,#DOC_ID#        
					    ,#FMDA_SJ#        
					    ,#FMDA_RDCNT#     
					    ,#FMDA_OPN_REGCNT# 
					    ,SYSDATE     
					    ,'Y'        
					    ,#FMDA_PUBLIC_DT#  
					    ,'Y'      
					)
     	]]>
     </insert>
          
	<!-- 삭제 -->
	<delete id="CSPHPM005QDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			  FROM TBCSPTSM002M 				
			 WHERE FMDA_IDX = #FMDA_IDX#
		]]>
	</delete>
	     
     <!-- 홈페이지용 select :: 홈페이지 연계 -->
     <select id="CSPHPM005QSendHomepageselect" parameterClass="paramMap"
		resultClass="resultMap">
     <![CDATA[
			SELECT
				  A.FMDA_IDX
				, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD') || ' ~ ' ||TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD')  AS FMDA_AUDIT
				, TO_CHAR(A.FMDA_AUDIT_ST, 'YYYY-MM-DD')  AS FMDA_AUDIT_ST
				, TO_CHAR(A.FMDA_AUDIT_ET, 'YYYY-MM-DD') AS FMDA_AUDIT_ET
				, A.FMDA_TXT	
				, A.FMDA_DEPT
				, (SELECT dpt_nm 					
            	 	 FROM tbdcmacm002m	
            		WHERE use_yn = 'Y'
            		  AND dpt_cd = A.FMDA_DEPT         		 
            	) AS FMDA_DEPT_NM
				, A.FMDA_PART
				, A.FMDA_PROC
				, A.FMDA_DT
				, A.FMDA_SJ
				, A.FMDA_RDCNT
				, A.FMDA_OPN_REGCNT
				, A.ATCH_FILE_ID as DOC_ID
				, TO_CHAR(A.FMDA_PUBLIC_DT, 'YYYY-MM-DD') AS FMDA_PUBLIC_DT
				, A.FMDA_PUBLIC_YN
                , #FLAG# as FLAG
                , A.USE_AT
                , A.FMDA_UP_DT
			FROM TBCSPTSM002M	A	
			WHERE USE_AT = 'Y'
			 AND FMDA_IDX = #FMDA_IDX#
      ]]>
     </select>
     
     <!--  연계 테이블 안에 데이터 insert -->
     <insert id="CSPHPM005QSEND001Insert" parameterClass="paramMap">
     	<![CDATA[
     		INSERT INTO	EH_INF_SP_HP_002
     				(	IF_SEQ         
					    ,IF_TYPE       
					    ,IF_SIID 
					    ,DVSN_CD       
					    ,FMDA_IDX       
					    ,FMDA_AUDIT_ST   
					    ,FMDA_AUDIT_ET  
					    ,FMDA_DEPT       
					    ,FMDA_PART       
					    ,FMDA_PROC      
					    ,FMDA_DT         
					    ,FMDA_TXT      
					    ,ATCH_FILE_ID        
					    ,FMDA_SJ        
					    ,FMDA_RDCNT     
					    ,FMDA_OPN_REGCNT 
					    ,FMDA_UP_DT      
					    ,USE_AT         
					    ,FMDA_PUBLIC_DT  
					    ,FMDA_PUBLIC_YN  
					    ,FLAG            
					)
			VALUES	(	#IF_SEQ#
						,'SND'
						,#IF_SIID#  
						,#DVSN_CD#       
					    ,#FMDA_IDX#       
					    ,#FMDA_AUDIT_ST#   
					    ,#FMDA_AUDIT_ET# 
					    ,#FMDA_DEPT#       
					    ,#FMDA_PART#       
					    ,#FMDA_PROC#      
					    ,#FMDA_DT#         
					    ,#FMDA_TXT#      
					    ,#DOC_ID#        
					    ,#FMDA_SJ#        
					    ,#FMDA_RDCNT#     
					    ,#FMDA_OPN_REGCNT# 
					    ,#FMDA_UP_DT#      
					    ,#USE_AT#         
					    ,#FMDA_PUBLIC_DT#  
					    ,#FMDA_PUBLIC_YN#  
					    ,#FLAG#            
					)
     	]]>
     </insert>
	
	<select id="CSPHPM005QGetMaxFmdxIdx" parameterClass="paramMap" resultClass="Integer">
		<![CDATA[
			SELECT	NVL(MAX(FMDA_IDX),0)+1
			FROM	TBCSPTSM002M
		]]>
	</select>
</sqlMap> 
