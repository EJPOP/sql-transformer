<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/cor/110">
 	
 	<select id="CSPCOR110PMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	T1.CORR_DVSN_CD
					,T1.ACP_YR
					,T1.CORR_ACP_NO
					,DECODE(T1.RM_CORR_ACP_NO,NULL,NULL,T1.ACP_YR||'-부감-'||T1.RM_CORR_ACP_NO) AS ACP_NO
					,T1.NAM
					,T1.TIT_NM
					,TO_CHAR(T1.ACP_DH,'YYYY-MM-DD HH24:MI') AS ACP_DH
					,T1.ACP_RUT_CD
					,F_CODE_NM('1000885',T1.ACP_RUT_CD) AS ACP_RUT_NM
					,T1.HNDL_STA_CD
					,F_CODE_NM('1000886',T1.HNDL_STA_CD) AS HNDL_STA_NM
					,T1.RM_CORR_ACP_NO
					,T1.TNB
					,TO_CHAR(T2.DTB_DH,'YYYY-MM-DD') AS DTB_DH
					,F_DPT_INFO(T2.HNDL_DPT_CD,'1') AS HNDL_DPT_NM
					,T2.HNDL_DPT_CD
					,F_USR_INFO_BY_ID(T2.HNDL_CHGR_ID,'2') AS HNDL_CHGR_NM
					,T2.HNDL_CHGR_ID
					,T1.EIN
					,TO_CHAR(TO_DATE(T1.HNDL_DDLN_DT),'YYYY-MM-DD') AS HNDL_DDLN_DT
					,T2.INSPC_DPT_CD
					,F_DPT_INFO(T2.INSPC_DPT_CD,'1') AS INSPC_DPT_NM
					,T2.INSPC_CHGR_ID
					,F_USR_INFO_BY_ID(T2.INSPC_CHGR_ID,'2') AS INSPC_CHGR_NM
					,TO_CHAR(T1.HNDL_DH,'YYYY-MM-DD') AS HNDL_DH
			FROM	TBCSPCOR101M T1
			       ,TBCSPCOR104M T2
			WHERE	T1.CORR_DVSN_CD = '1'
			  AND   T1.CORR_DVSN_CD = T2.CORR_DVSN_CD(+)
			  AND   T1.ACP_YR = T2.ACP_YR(+)
			  AND   T1.CORR_ACp_NO = T2.CORR_ACP_NO(+)
			  AND   T1.HNDL_STA_CD = '30'
			  AND   T2.HNDL_DPT_CD = #strDPT_CD#
			  AND   T2.HNDL_CHGR_ID = #strUSR_ID#
			  AND   (T1.CORR_DVSN_CD, T1.ACP_YR, T1.CORR_ACP_NO) NOT IN ( SELECT #strCORR_DVSN_CD#,#strACP_YR#,#strCORR_ACP_NO#
			                                                                FROM DUAL
			                                                            )
			  AND   (T1.CORR_DVSN_CD, T1.ACP_YR, T1.CORR_ACP_NO) NOT IN ( SELECT S1.CORR_DVSN_CD, S1.ACP_YR, S1.CORR_ACP_NO
			                                                                FROM TBCSPCOR107L S1
			                                                            )
              AND   (T1.CORR_DVSN_CD, T1.ACP_YR, T1.CORR_ACP_NO) NOT IN ( SELECT S1.SUC_CORR_DVSN_CD, S1.SUC_ACP_YR, S1.SUC_CORR_ACP_NO
			                                                                FROM TBCSPCOR107L S1
			                                                            )
			  
			ORDER BY T1.ACP_YR DESC,TO_NUMBER(T1.RM_CORR_ACP_NO) DESC
		]]>
	</select>
	
	<select id="CSPCOR110PSucSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT T2.CORR_DVSN_CD
			      ,T2.ACP_YR
			      ,T2.CORR_ACP_NO
			      ,T2.SUC_CORR_DVSN_CD
			      ,T2.SUC_ACP_YR
			      ,T2.SUC_CORR_ACP_NO
			      ,T1.NAM
			      ,DECODE(T1.RM_CORR_ACP_NO,NULL,NULL,T1.ACP_YR||'-부감-'||T1.RM_CORR_ACP_NO) AS ACP_NO
			      ,T1.TIT_NM
			      ,TO_CHAR(T1.ACP_DH,'YYYY-MM-DD HH24:MI') AS ACP_DH
			      ,F_CODE_NM('1000885',T1.ACP_RUT_CD) AS ACP_RUT_NM
			      ,TO_CHAR(TO_DATE(T1.HNDL_DDLN_DT),'YYYY-MM-DD') AS HNDL_DDLN_DT
			      ,T1.TNB
			  FROM TBCSPCOR101M T1
			      ,TBCSPCOR107L T2
			 WHERE T1.CORR_DVSN_CD = T2.SUC_CORR_DVSN_CD
			   AND T1.ACP_YR = T2.SUC_ACP_YR
			   AND T1.CORR_ACP_NO = T2.SUC_CORR_ACP_NO
			   AND T2.CORR_DVSN_CD = #strCORR_DVSN_CD#
			   AND T2.ACP_YR = #strACP_YR#
			   AND T2.CORR_ACP_NO = #strCORR_ACP_NO#
		]]>
	</select>
	
	<insert id="CSPCOR110P107LInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPCOR107L
				( CORR_DVSN_CD
				 ,ACP_YR
				 ,CORR_ACP_NO
				 ,SUC_CORR_DVSN_CD
				 ,SUC_ACP_YR
				 ,SUC_CORR_ACP_NO
				 ,FRT_USR_ID
				 ,FNL_USR_ID
				 ,FNL_DEAL_DPT_CD
				 ,FNL_MNU_ID
				 ,FRT_REGI_DH
				 ,FNL_MDF_DH
				)
			VALUES ( #CORR_DVSN_CD#
				    ,#ACP_YR#
				    ,#CORR_ACP_NO#
				    ,#SUC_CORR_DVSN_CD#
				    ,#SUC_ACP_YR#
				    ,#SUC_CORR_ACP_NO#
				    ,#FNL_USR_ID#
				    ,#FNL_USR_ID#
				    ,#FNL_DEAL_DPT_CD#
				    ,#FNL_MNU_ID#
				    ,SYSDATE
				    ,SYSDATE
			       )
			
		]]>
	</insert>
	
	<update id="CSPCOR110P101MUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBCSPCOR101M T1
			   SET T1.ANS_TXT = ( SELECT S1.ANS_TXT
			                        FROM TBCSPCOR101M S1
			                       WHERE S1.CORR_DVSN_CD = #CORR_DVSN_CD#
			                         AND S1.ACP_YR = #ACP_YR#
			                         AND S1.CORR_ACP_NO = #CORR_ACP_NO#
			                    )
			 WHERE T1.CORR_DVSN_CD = #SUC_CORR_DVSN_CD#
			   AND T1.ACP_YR = #SUC_ACP_YR#
			   AND T1.CORR_ACP_NO = #SUC_CORR_ACP_NO#
		]]>
	</update>
	
	<update id="CSPCOR110P104MUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBCSPCOR104M T1
			   SET T1.HNDL_RSLT_CD = ( SELECT S1.HNDL_RSLT_CD
			                             FROM TBCSPCOR104M S1
			                            WHERE S1.CORR_DVSN_CD = #CORR_DVSN_CD#
			                              AND S1.ACP_YR = #ACP_YR#
			                              AND S1.CORR_ACP_NO = #CORR_ACP_NO#
			                    )
			      ,T1.INSPC_DPT_CD = ( SELECT S1.INSPC_DPT_CD
			                             FROM TBCSPCOR104M S1
			                            WHERE S1.CORR_DVSN_CD = #CORR_DVSN_CD#
			                              AND S1.ACP_YR = #ACP_YR#
			                              AND S1.CORR_ACP_NO = #CORR_ACP_NO#
			                    )
			      ,T1.INSPC_CHGR_ID = ( SELECT S1.INSPC_CHGR_ID
			                             FROM TBCSPCOR104M S1
			                            WHERE S1.CORR_DVSN_CD = #CORR_DVSN_CD#
			                              AND S1.ACP_YR = #ACP_YR#
			                              AND S1.CORR_ACP_NO = #CORR_ACP_NO#
			                    )
			 WHERE T1.CORR_DVSN_CD = #SUC_CORR_DVSN_CD#
			   AND T1.ACP_YR = #SUC_ACP_YR#
			   AND T1.CORR_ACP_NO = #SUC_CORR_ACP_NO#
			 
		]]>
	</update>
	
	<insert id="CSPCOR110PTBCSPCOR103HInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPCOR103H
					( CORR_DVSN_CD
					 ,ACP_YR
					 ,CORR_ACP_NO
					 ,SRNO
					 ,PET_DPT_CD
					 ,PET_ID
					 ,PET_TXT
					 ,FRT_USR_ID
					 ,FNL_USR_ID
					 ,FNL_DEAL_DPT_CD
					 ,FNL_MNU_ID
					 ,FRT_REGI_DH
					 ,FNL_MDF_DH
					)
				VALUES ( #SUC_CORR_DVSN_CD#
				        ,#SUC_ACP_YR#
				        ,#SUC_CORR_ACP_NO#
				        ,(SELECT NVL(MAX(S1.SRNO),0)+1
				            FROM TBCSPCOR103H S1
				           WHERE S1.CORR_DVSN_CD = #SUC_CORR_DVSN_CD#
				             AND S1.ACP_YR = #SUC_ACP_YR#
				             AND S1.CORR_ACP_NO = #SUC_CORR_ACP_NO#
				         )
				        ,#FNL_DEAL_DPT_CD#
				        ,#FNL_USR_ID#
				        ,#PET_TXT#||' ( '||( SELECT S1.ACP_YR||'-부감-'||S1.RM_CORR_ACP_NO
				                              FROM TBCSPCOR101M S1
				                             WHERE S1.CORR_DVSN_CD = #CORR_DVSN_CD#
				                               AND S1.ACP_YR = #ACP_YR#
				                               AND S1.CORR_ACP_NO = #CORR_ACP_NO#
				                      )|| ' )'
				        ,#FNL_USR_ID#
				        ,#FNL_USR_ID#
				        ,#FNL_DEAL_DPT_CD#
				        ,#FNL_MNU_ID#
				        ,SYSDATE
				        ,SYSDATE
				       )
		]]>
	</insert>
	
	<delete id="CSPCOR101P107LDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			  FROM TBCSPCOR107L T1
			 WHERE T1.CORR_DVSN_CD = #CORR_DVSN_CD#
			   AND T1.ACP_YR = #ACP_YR#
			   AND T1.CORR_ACP_NO = #CORR_ACP_NO#
			   AND T1.SUC_CORR_DVSN_CD = #SUC_CORR_DVSN_CD#
			   AND T1.SUC_ACP_YR = #SUC_ACP_YR#
			   AND T1.SUC_CORR_ACP_NO = #SUC_CORR_ACP_NO#
		]]>
	</delete>
</sqlMap> 
