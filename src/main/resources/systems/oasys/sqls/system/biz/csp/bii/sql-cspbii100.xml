<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="csp/bii/100">
	<!-- 감사정보제출 결재상신-->
	<update id="CSPBII100EAudInfSmtSbmUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfSmtSbmUpdate */
		       TBCSPBII100M                       
		   SET APV_DOC_NO          = #APV_DOC_NO#                 /* 결재문서번호 */
		     , SBM_DT              = TO_CHAR(SYSDATE, 'YYYYMMDD') /* 결재상신일 */
		     , AUD_INF_PRSS_STA_CD = '02'                         /* 감사정보진행상태코드[02:제출결재중] */
		     , FNL_USR_ID          = #FNL_USR_ID#                 /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD#            /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#                 /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE                      /* 최종수정일시 */
		 WHERE YE   = REGEXP_SUBSTR(#INF_NO#, '[^|]+', 1, 1)
           AND SRNO = REGEXP_SUBSTR(#INF_NO#, '[^|]+', 1, 2)
	</update>	
	
	<!-- 감사정보제출 결재 -->
	<update id="CSPBII100EAudInfSmtApvUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfSmtApvUpdate */
		       TBCSPBII100M T1                   
		   SET SMT_DT              = #SBM_DT#                      /* 제출일 */
		     , AUD_INF_PRSS_STA_CD = '05'                         /* 감사정보진행상태코드[05:제출완료] */
		     , FNL_USR_ID          = #FNL_USR_ID#                 /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD#            /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#                 /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE                      /* 최종수정일시 */
		     , PRSR_DPT_CD = (SELECT S1.DPT_CD
		     					FROM TBDCMACM001M S1
		     					WHERE S1.CNB = T1.PRSR_CNB)
		     , PRSR_DPT_TP_CD =  (	SELECT	CASE WHEN S1.DPT_CD IN ('062500','062600','062700','062800','170300','170320','071100','071300','180100','180110','100100','081100','081200','081300','081400','081500','081600','081700','081800','081900','0L0100','0L0200','0L0300')
		                        						THEN 'A' 
		                        				ELSE S1.DPT_TP_CD END  
		                        	FROM	TBDCMACM002M S1
		                        	WHERE	S1.DPT_CD = (SELECT S3.DPT_CD
		     					FROM TBDCMACM001M S3
		     					WHERE S3.CNB = T1.PRSR_CNB)
				                 )
		 WHERE APV_DOC_NO = #APV_DOC_NO#
	</update>
	
	<!-- 감사정보제출 결재 -->
	<update id="CSPBII100EAudInfSmtCntUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfSmtCntUpdate */
		       TBCSPBII160L A                       
		   SET SMT_NOC             = NVL(SMT_NOC, 0) + 1          /* 제출건수(현재건수 + 1) */
		     , FNL_USR_ID          = #FNL_USR_ID#                 /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD#            /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#                 /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE                      /* 최종수정일시 */
		 WHERE (YE, CNB) = (SELECT YE
		                         , CNB
		                      FROM TBCSPBII100M
		                     WHERE APV_DOC_NO = #APV_DOC_NO#)
		   AND QR_DVSN_CD = CASE WHEN SUBSTR(#SBM_DT#, 5,2) BETWEEN '01' AND '06' THEN '1'
		                           WHEN SUBSTR(#SBM_DT#, 5,2) BETWEEN '07' AND '12' THEN '2'
		                      END		   
	</update>
	
	<!-- 감사정보제출 반려 -->
	<update id="CSPBII100EAudInfSmtRetUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfSmtRetUpdate */
		       TBCSPBII100M                       
		   SET SBM_DT              = NULL              /* 상신일 Null*/
		     , AUD_INF_PRSS_STA_CD = '04'              /* 감사정보진행상태코드[04:제출반려] */
		     , FNL_USR_ID          = #FNL_USR_ID#      /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#      /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE           /* 최종수정일시 */
		     , APV_DOC_NO = NULL
		 WHERE APV_DOC_NO = #APV_DOC_NO#
	</update>
	
	<update id="CSPBII100ETBDCMACM022LDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			FROM	TBDCMACM022L
			WHERE APV_DOC_NO = #APV_DOC_NO#
		]]>
	</update>
	
	<update id="CSPBII100ETBDCMACM023HDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			FROM	TBDCMACM023H
			WHERE APV_DOC_NO = #APV_DOC_NO#
		]]>
	</update>
	
	<update id="CSPBII100ETBDCMACM023LDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			FROM	TBDCMACM023L
			WHERE APV_DOC_NO = #APV_DOC_NO#
		]]>
	</update>
	
	<!-- 감사정보제출 상신취소 -->
	<update id="CSPBII100EAudInfSmtCnlUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfSmtCnlUpdate */
		       TBCSPBII100M                       
		   SET SBM_DT              = NULL              /* 상신일 Null*/
		     , AUD_INF_PRSS_STA_CD = '01'              /* 감사정보진행상태코드[01:제출작성] */
		     , FNL_USR_ID          = #FNL_USR_ID#      /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#      /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE           /* 최종수정일시 */
		     , APV_DOC_NO = NULL
		 WHERE APV_DOC_NO = #APV_DOC_NO#
	</update>
	
	<!-- 감사정보처리 결재상신-->
	<update id="CSPBII100EAudInfHndlSbmUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfHndlSbm */
		       TBCSPBII100M                       
		   SET APV_DOC_NO          = #APV_DOC_NO#                 /* 결재문서번호 */
		     , AUD_INF_PRSS_STA_CD = '22'                         /* 감사정보진행상태코드[22:처리결재중] */
		     , FNL_USR_ID          = #FNL_USR_ID#                 /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD#            /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#                 /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE                      /* 최종수정일시 */
		 WHERE YE   = REGEXP_SUBSTR(#INF_NO#, '[^|]+', 1, 1)
           AND SRNO = REGEXP_SUBSTR(#INF_NO#, '[^|]+', 1, 2)
	</update>	
	
	<!-- 감사정보이송 결재상신-->
	<update id="CSPBII100EAudInfTrnfSbmUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfTrnfSbmUpdate */
		       TBCSPBII100M                       
		   SET TRNF_APV_DOC_NO     = #APV_DOC_NO#                 /* 결재문서번호 */
		     , AUD_INF_PRSS_STA_CD = '16'                         /* 감사정보진행상태코드 */
		     , FNL_USR_ID          = #FNL_USR_ID#                 /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD#            /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#                 /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE                      /* 최종수정일시 */
		 WHERE YE   = REGEXP_SUBSTR(#INF_NO#, '[^|]+', 1, 1)
           AND SRNO = REGEXP_SUBSTR(#INF_NO#, '[^|]+', 1, 2)
	</update>
	
	<!-- 감사정보이송 결재상신-->
	<update id="CSPBII100EAudInfTrnfSbmUpdate2" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfTrnfSbmUpdate2 */
		       TBCSPBII100M                       
		   SET TRNF_APV_DOC_NO     = #APV_DOC_NO#                 /* 결재문서번호 */
		     , AUD_INF_PRSS_STA_CD = '16'                         /* 감사정보진행상태코드 */
		     , FNL_USR_ID          = #FNL_USR_ID#                 /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD#            /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#                 /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE                      /* 최종수정일시 */
			<!-- 뷰를 사용하지 않을 경우 인덱스를 타지 않는 현상이 발생해서 뷰를 먼저 생성하고 서브쿼리 함 -->
		 WHERE
		 <isNotEmpty property="strYeList">
		  (YE, SRNO) IN (WITH VW AS (SELECT REGEXP_SUBSTR(#strYeList#, '[^||]+', 1, LEVEL)   AS YE
                                               , REGEXP_SUBSTR(#strSrnoList#, '[^||]+', 1, LEVEL) AS SRNO
                                            FROM DUAL
                                      CONNECT BY LEVEL &lt;= REGEXP_COUNT(#strYeList#, '[^|]+'))
                              SELECT YE
                                   , SRNO
                                FROM VW
                            )
         </isNotEmpty>
         <isEmpty property="strYeList">
          TRNF_APV_DOC_NO  = #APV_DOC_NO#
         </isEmpty>
	</update>	
	
	<!-- 감사자료대장기본 등록  -->
	<insert id="CSPBII100EAudMtrlLdgInsert" parameterClass="paramMap"> 
		/* csp.bii.service.impl.CSPBII100EServiceImpl.CSPBII100EAudMtrlLdgInsert */
		INSERT INTO TBBADHAB006M

		SELECT TO_CHAR(SYSDATE, 'YYYY')                  /* 년도 */
		     , A.HNDL_DPT_CD                             /* 부서코드 */
		     , (SELECT NVL(MAX(SRNO), 0) + 1 
		          FROM TBBADHAB006M
		         WHERE YR     = TO_CHAR(SYSDATE, 'YYYY')
		           AND DPT_CD = A.HNDL_DPT_CD)           /* 일련번호 */
		     , '10'                                      /* 관련업무코드[10:정보사항] */      
		     , A.SRNO                                    /* 관련번호 */ 
		     , TO_CHAR(SYSDATE, 'YYYYMMDD')              /* 확정일 */
		     , A.REL_ORG_CD                              /* 관계기관코드 */
		     , A.TIT_TXT                                 /* 제목명 */
		     , ''                                        /* 실지감사일 */  
		     , ''                                        /* 처리담당자전산번호 */
		     , ''                                        /* 결재일 */
		     , ''                                        /* 처리상황내용 */
		     , ''                                        /* 위원회부의내용 */
		     , ''                                        /* 시행일 */
		     , ''                                        /* 비고사항 */
		     , #FNL_USR_ID#
		     , #FNL_USR_ID#
		     , #FNL_DEAL_DPT_CD#
		     , #FNL_MNU_ID#
		     , SYSDATE
		     , SYSDATE
		  FROM TBCSPBII100M A
		 WHERE A.APV_DOC_NO  = #APV_DOC_NO#
		   AND A.HNDL_ORD_CD = '3'	<!-- 처리지시가 [3:감사대상]일 경우에만 등록 -->
	</insert>
	
	<!-- 감사정보처리 결재 -->
	<update id="CSPBII100EAudInfHndlApvUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfHndlApvUpdate */
		       TBCSPBII100M                       
		   SET CMPT_DT             = TO_CHAR(SYSDATE, 'YYYYMMDD') /* 제출일 */
		     , AUD_INF_PRSS_STA_CD = '99'                         /* 감사정보진행상태코드[99:완료] */
		     /* 감사지시코드가 [3:감사대상]일 경우 감사자료관련 컬럼3개 업데이트 */
		     , AUD_MTRL_YR         = CASE WHEN HNDL_ORD_CD = '3' THEN TO_CHAR(SYSDATE, 'YYYY') /* 감사자료년도 */
		                                  ELSE ''
		                             END
		     , AUD_MTRL_SRNO       = CASE WHEN HNDL_ORD_CD = '3' THEN '0'
		                                  ELSE ''
		                             END                                                       /* 감사자료일련번호 */
		     , AUD_MTRL_DPT_CD     = CASE WHEN HNDL_ORD_CD = '3' THEN HNDL_DPT_CD
		                                  ELSE ''
		                             END                                                       /* 감사자료부서코드 */
		     , FNL_USR_ID          = #FNL_USR_ID#                 /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD#            /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#                 /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE                      /* 최종수정일시 */
		 WHERE APV_DOC_NO = #APV_DOC_NO#
	</update>
	
	<!-- 감사정보이송 결재 -->
	<update id="CSPBII100EAudInfTrnfApvUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfTrnfApvUpdate */
		       TBCSPBII100M 
		   SET TRNF_DT             = TO_CHAR(SYSDATE, 'YYYYMMDD') /* 이송일 */
		     , AUD_INF_PRSS_STA_CD = DECODE(HNDL_ORD_CD, '7', '99', '15') /* 감사정보진행상태코드 처리지시코드가[7:폐기]일 경우 [99:완료] 그 외[15:이송완료] */
		     , TRNF_ACP_DT = DECODE(HNDL_ORD_CD, '7', TO_CHAR(SYSDATE, 'YYYYMMDD'), TRNF_ACP_DT) /* 처리지시코드가[7:폐기]일 경우 이송접수일 수정  */
		     , CMPT_DT = DECODE(HNDL_ORD_CD, '7', TO_CHAR(SYSDATE, 'YYYYMMDD'), CMPT_DT) /* 처리지시코드가[7:폐기]일 경우 완료일 수정*/
		     , HNDL_RSLT_CD = DECODE(HNDL_ORD_CD, '7', '88', HNDL_RSLT_CD) /* 처리지시코드가[7:폐기]일 경우 처리결과코드[88:종결] 수정*/
		     , FDLTY_SC            = nvl(FDLTY_MNAG_SC,0) + nvl(FDLTY_TIME_SC,0) + nvl(FDLTY_TG_SC,0) + nvl(FDLTY_TXT_SC,0) + nvl(FDLTY_BAS_SC,0) 
		     , RIBLY_SC            = nvl(RIBLY_EVI_SC,0) + nvl(RIBLY_IVTG_SC,0)
		     , UTL_SC              = nvl(UTL_INSP_SC,0) + nvl(UTL_SPCF_SC,0) 
		     , FNL_USR_ID          = #FNL_USR_ID#                 /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD#            /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#                 /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE                      /* 최종수정일시 */
		 WHERE TRNF_APV_DOC_NO     = #APV_DOC_NO#
	</update>	
	
	<!-- 감사정보처리 반려 -->
	<update id="CSPBII100EAudInfHndlRetUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfHndlRetUpdate */
		       TBCSPBII100M                       
		   SET AUD_INF_PRSS_STA_CD = '24'              /* 감사정보진행상태코드[24:처리반려] */
		     , FNL_USR_ID          = #FNL_USR_ID#      /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#      /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE           /* 최종수정일시 */
		 WHERE APV_DOC_NO = #APV_DOC_NO#
	</update>
	
	<!-- 감사정보이송 반려 -->
	<update id="CSPBII100EAudInfTrnfRetUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfTrnfRetUpdate */
		       TBCSPBII100M                       
		   SET AUD_INF_PRSS_STA_CD = '18'              /* 감사정보진행상태코드[24:이송반려] */
		     , FNL_USR_ID          = #FNL_USR_ID#      /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#      /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE           /* 최종수정일시 */
		 WHERE TRNF_APV_DOC_NO = #APV_DOC_NO#
	</update>		
	
	<!-- 감사정보처리 상신취소 -->
	<update id="CSPBII100EAudInfHndlCnlUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfHndlCnlUpdate */
		       TBCSPBII100M                       
		   SET AUD_INF_PRSS_STA_CD = '21'              /* 감사정보진행상태코드[21:처리작성] */
		     , FNL_USR_ID          = #FNL_USR_ID#      /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#      /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE           /* 최종수정일시 */
		 WHERE APV_DOC_NO = #APV_DOC_NO#
	</update>
	
	<!-- 감사정보이송 상신취소 -->
	<update id="CSPBII100EAudInfTrnfCnlUpdate" parameterClass="paramMap">
		UPDATE /* csp.bii.service.impl.CSPBII100QServiceImpl.CSPBII100EAudInfTrnfCnlUpdate */
		       TBCSPBII100M                       
		   SET AUD_INF_PRSS_STA_CD = '13'              /* 감사정보진행상태코드[13:담당자배부] */
		     , TRNF_APV_DOC_NO = ''
		     , FNL_USR_ID          = #FNL_USR_ID#      /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD     = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
		     , FNL_MNU_ID          = #FNL_MNU_ID#      /* 최종메뉴ID */
		     , FNL_MDF_DH          = SYSDATE           /* 최종수정일시 */
		 WHERE TRNF_APV_DOC_NO = #APV_DOC_NO#
	</update>	
	
	<select id="CSPBII100ESelectSBM_DT" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	CASE WHEN ROUND(SYSDATE -TO_DATE((SELECT SBM_DT FROM TBCSPBII100M A WHERE A.APV_DOC_NO =#APV_DOC_NO#) ,'YYYYMMDD')) > 10 THEN TO_CHAR(SYSDATE,'YYYYMMDD')
					ELSE (SELECT SBM_DT FROM TBCSPBII100M A WHERE A.APV_DOC_NO =#APV_DOC_NO#) END AS SBM_DT
			FROM DUAL
		]]>
	</select>
</sqlMap>