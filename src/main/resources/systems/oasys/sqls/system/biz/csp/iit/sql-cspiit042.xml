<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/iit/042">
	<select id="CSPIIT042QMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<include refid = "include.pageSelct"/>
        <![CDATA[
			SELECT 	
					D2.AUD_YR,
					D2.AUD_NO,
					D3.AUD_YR			AS AUD_YR2,
					D3.AUD_NO			AS AUD_NO2,
					F_MNG_KND_AUDYRNO(D2.AUD_YR, D2.AUD_NO, D2.AUD_KND_CD, '-')    AS AUD_YR_NO ,
       				D2.AUD_KND_CD,
       				F_CODE_NM('1000007',D2.AUD_KND_CD)   AS AUD_KND_NM,
       				D2.AUD_SBJ_NM,
			        TO_DATE(D1.AUD_STR_DT, 'YYYY-MM-DD') || ' ~ ' || TO_DATE(D1.AUD_END_DT, 'YYYY-MM-DD') AS AUD_DT,
			        D1.AUD_DCN,
			        F_DPT_INFO(D2.SPV_BRDV_CD,'1')       AS SPV_BRDV_NM,          /*주관부서명*/     
			        D3.SEL_YN,
                    D3.RMK_TXT,
			        D2.AUD_RPST_ORG_CD,
			        F_ORG_INFO(D2.AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM,
			        D1.AUD_STR_DT,
                    D1.AUD_END_DT,
                    D2.SPV_BRDV_CD,
                    D3.DOC_ID,
                    F_CODE_NM('1000975',D3.SUP_YN) AS SUP_YN
			FROM    TBBADDED002M D1
			       ,TBBADDED001M D2
			       ,TBCSPIIT023M D3
			WHERE  D1.AUD_STR_DT >= '20210201'
			AND D2.AUD_YR = D3.AUD_YR(+)
            AND D2.AUD_NO = D3.AUD_NO(+)
            AND D2.AUD_YR = D1.REL_AUD_YR(+)
            AND D2.AUD_NO = D1.REL_AUD_NO(+)
			AND NOT SUBSTR(F_CODE_NM('1000007',D2.AUD_KND_CD),1,2)='서면'
  			AND NOT SUBSTR(F_CODE_NM('1000007',D2.AUD_KND_CD),1,2)='확인'
        ]]>
        <dynamic>
        	<isNotEmpty property="strYr"> <!-- 연도별 -->
		 		AND SUBSTR(D2.AUD_YR,1,4) = #strYr#
		</isNotEmpty>
        	
        	<isNotEmpty property="strSEARCH_NM">
        		AND	(D2.AUD_SBJ_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR D3.RMK_TXT LIKE '%'||#strSEARCH_NM#||'%'
        				OR F_ORG_INFO(D2.AUD_RPST_ORG_CD,'1') LIKE '%'||#strSEARCH_NM#||'%')
        	</isNotEmpty>
        	<isNotEmpty property="strChk_SEL_YN">
        		<isEqual property="strChk_SEL_YN" compareValue="10">
        			AND D3.SEL_YN = #strChk_SEL_YN#
        		</isEqual>
        		<isEqual property="strChk_SEL_YN" compareValue="20">
        			AND D3.SEL_YN = #strChk_SEL_YN#
        		</isEqual>
        		<isEqual property="strChk_SEL_YN" compareValue="30">
        			AND D3.SEL_YN = #strChk_SEL_YN#
        		</isEqual>
        	</isNotEmpty>
        	<isNotEmpty property="strSpvBrdvCd">	 
			     AND D2.SPV_BRDV_CD = #strSpvBrdvCd#
			</isNotEmpty>
			<isNotEmpty property="strSUP_YN">
        		<isEqual property="strSUP_YN" compareValue="10">
        			AND D3.SUP_YN = #strSUP_YN#
        		</isEqual>
        		<isEqual property="strSUP_YN" compareValue="30">
        			AND D3.SUP_YN = #strSUP_YN#
        		</isEqual>
        	</isNotEmpty>
        </dynamic> 
        <include refid = "include.pageOrder"/> 
	</select>
	
	
	<select id ="CSPIIT043EMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT 	
					AUD_YR,
					AUD_NO,
					F_MNG_KND_AUDYRNO(AUD_YR, AUD_NO, AUD_KND_CD, '-')    AS AUD_YR_NO ,
       				AUD_KND_CD,
       				F_CODE_NM('1000007',AUD_KND_CD)   AS AUD_KND_NM,
       				AUD_SBJ_NM,
			        TO_DATE(AUD_STR_DT, 'YYYY-MM-DD') || ' ~ ' || TO_DATE(AUD_END_DT, 'YYYY-MM-DD') AS AUD_DT,
			        AUD_DCN,
			        F_DPT_INFO(SPV_BRDV_CD,'1')       AS SPV_BRDV_NM,          /*주관부서명*/
			        SEL_YN,
                    RMK_TXT,
			        AUD_RPST_ORG_CD,
			        F_ORG_INFO(AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM,
			        AUD_STR_DT,
                    AUD_END_DT,
                    SPV_BRDV_CD,
                    DOC_ID,
                    SUP_YN
			FROM    TBCSPIIT023M
			WHERE   AUD_STR_DT >= '20210201'
			AND NOT SUBSTR(F_CODE_NM('1000007',AUD_KND_CD),1,2)='서면'
  			AND NOT SUBSTR(F_CODE_NM('1000007',AUD_KND_CD),1,2)='확인'
  			AND AUD_YR = #strAUD_YR#
  			AND AUD_NO = #strAUD_NO#
  			AND AUD_KND_CD = #strAUD_KND_CD#
		]]>
	</select>
	
	<insert id="CSPIIT043EMainInsert" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO TBCSPIIT023M
        	(		AUD_YR,
        			AUD_NO,
        			AUD_KND_CD,
        			SPV_BRDV_CD,
        			AUD_SBJ_NM,
        			AUD_STR_DT,
        			AUD_END_DT,
        			AUD_DCN,
        			SEL_YN,
        			RMK_TXT,
        			AUD_RPST_ORG_CD,
        			SPV_BRDV_NM,
        			DOC_ID,
        			SUP_YN,
        			FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH
        	) VALUES (
        			#AUD_YR#,
	        		#AUD_NO#,
	        		#AUD_KND_CD#,
	        		#SPV_BRDV_CD#,
	        		#AUD_SBJ_NM#,
	        		#AUD_STR_DT#,
	        		#AUD_END_DT#,
	        		#AUD_DCN#,
	        		#SEL_YN#,
	        		#RMK_TXT#,
	        		#AUD_RPST_ORG_CD#,
	        		#SPV_BRDV_NM#,
	        		#DOC_ID#,
	        		#SUP_YN#,
	        		#FRT_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
					SYSDATE
        	)
        ]]>
	</insert>
	
	
	<update id="CSPIIT043EMainUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPIIT023M
			SET		SEL_YN  = #SEL_YN# ,
					RMK_TXT = #RMK_TXT#,
					DOC_ID  = #DOC_ID#,
					SUP_YN  = #SUP_YN#,
					FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE
			WHERE	1=1
			AND		AUD_YR = #AUD_YR#
			AND		AUD_NO = #AUD_NO#
			AND		AUD_KND_CD = #AUD_KND_CD#
		]]>
	</update>
	
	<!-- BARON활용내역관리 엑셀다운로드 -->
	<select id="CSPIIT042QExcelExportSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[
			SELECT 	
					D2.AUD_YR,
					D2.AUD_NO,
					D3.AUD_YR			AS AUD_YR2,
					D3.AUD_NO			AS AUD_NO2,
					F_MNG_KND_AUDYRNO(D2.AUD_YR, D2.AUD_NO, D2.AUD_KND_CD, '-')    AS AUD_YR_NO ,
       				D2.AUD_KND_CD,
       				F_CODE_NM('1000007',D2.AUD_KND_CD)   AS AUD_KND_NM,
       				D2.AUD_SBJ_NM,
			        TO_DATE(D1.AUD_STR_DT, 'YYYY-MM-DD') || ' ~ ' || TO_DATE(D1.AUD_END_DT, 'YYYY-MM-DD') AS AUD_DT,
			        D1.AUD_DCN,
			        F_DPT_INFO(D2.SPV_BRDV_CD,'1')       AS SPV_BRDV_NM,          /*주관부서명*/     
			        D3.SEL_YN,
                    D3.RMK_TXT,
			        D2.AUD_RPST_ORG_CD,
			        F_ORG_INFO(D2.AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM,
			        D1.AUD_STR_DT,
                    D1.AUD_END_DT,
                    D2.SPV_BRDV_CD,
                    D3.DOC_ID,
                    F_CODE_NM('1000975',D3.SUP_YN) AS SUP_YN
			FROM    TBBADDED002M D1
			       ,TBBADDED001M D2
			       ,TBCSPIIT023M D3
			WHERE  D1.AUD_STR_DT >= '20210201'
			AND D2.AUD_YR = D3.AUD_YR(+)
            AND D2.AUD_NO = D3.AUD_NO(+)
            AND D2.AUD_YR = D1.REL_AUD_YR(+)
            AND D2.AUD_NO = D1.REL_AUD_NO(+)
			AND NOT SUBSTR(F_CODE_NM('1000007',D2.AUD_KND_CD),1,2)='서면'
  			AND NOT SUBSTR(F_CODE_NM('1000007',D2.AUD_KND_CD),1,2)='확인'
        ]]>
        <dynamic>
        	<isNotEmpty property="strYr"> <!-- 연도별 -->
		 		AND SUBSTR(D2.AUD_YR,1,4) = #strYr#
		</isNotEmpty>
        	
        	<isNotEmpty property="strSEARCH_NM">
        		AND	(D2.AUD_SBJ_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR D3.RMK_TXT LIKE '%'||#strSEARCH_NM#||'%'
        				OR D2.AUD_RPST_ORG_NM LIKE '%'||#strSEARCH_NM#||'%')
        	</isNotEmpty>
        	<isNotEmpty property="strChk_SEL_YN">
        		<isEqual property="strChk_SEL_YN" compareValue="10">
        			AND D3.SEL_YN = #strChk_SEL_YN#
        		</isEqual>
        		<isEqual property="strChk_SEL_YN" compareValue="20">
        			AND D3.SEL_YN = #strChk_SEL_YN#
        		</isEqual>
        		<isEqual property="strChk_SEL_YN" compareValue="30">
        			AND D3.SEL_YN = #strChk_SEL_YN#
        		</isEqual>
        	</isNotEmpty>
        	<isNotEmpty property="strSpvBrdvCd">	 
			     AND D2.SPV_BRDV_CD = #strSpvBrdvCd#
			</isNotEmpty>
        </dynamic> 
        <![CDATA[
        	ORDER BY D2.AUD_YR, D2.AUD_NO DESC
        ]]>
	</select>
</sqlMap> 
