<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/mwf/002">

	<select id="CSPMWF011EMenuSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
		    SELECT *
			  FROM
			(
				SELECT '밥' AS NM, DECODE(MAX(RICE_NM), NULL, NVL((SELECT HLDY_NM FROM TBBADDED013B Z WHERE Z.YE || Z.MD = #MNU_DT#), ' '), 
				MAX(RICE_NM)) AS RICE_NM FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2'
				UNION ALL
				SELECT '국' AS NM, MAX(SOUP_NM) FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2'
				UNION ALL
				SELECT '반찬' AS NM, MAX(SD_NM_1) FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  SD_NM_1 IS NOT NULL
				UNION ALL
				SELECT '반찬' AS NM, SD_NM_2 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  SD_NM_2 IS NOT NULL
				UNION ALL
				SELECT '반찬' AS NM, SD_NM_3 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  SD_NM_3 IS NOT NULL
				UNION ALL
				SELECT '반찬' AS NM, SD_NM_4 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  SD_NM_4 IS NOT NULL
				UNION ALL
				SELECT '반찬' AS NM, SD_NM_5 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  SD_NM_5 IS NOT NULL
				UNION ALL
				SELECT '반찬' AS NM, SD_NM_6 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  SD_NM_6 IS NOT NULL
				UNION ALL
				SELECT '반찬' AS NM, SD_NM_7 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  SD_NM_7 IS NOT NULL
				UNION ALL
		]]>
			<dynamic>
				<isEqual property="RSTRNT_CD" compareValue="3">	
				SELECT '테마' AS NM, SNC_NM FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD =#RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  SNC_NM IS NOT NULL
				UNION ALL
				</isEqual>
			</dynamic>
		<![CDATA[
				SELECT '원산지' AS NM, COO_INF_NM_1 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD = #RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  COO_INF_NM_1 IS NOT NULL
				UNION ALL
				SELECT '원산지' AS NM, COO_INF_NM_2 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD = #RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  COO_INF_NM_2 IS NOT NULL
				UNION ALL
				SELECT '원산지' AS NM, COO_INF_NM_3 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD = #RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  COO_INF_NM_3 IS NOT NULL
				UNION ALL
				SELECT '원산지' AS NM, COO_INF_NM_4 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD = #RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  COO_INF_NM_4 IS NOT NULL
				UNION ALL
				SELECT '원산지' AS NM, COO_INF_NM_5 FROM TBCSPMWF002M WHERE MNU_DT = #MNU_DT# AND RSTRNT_CD = #RSTRNT_CD# AND MEAL_DVSN_CD = '2' AND  COO_INF_NM_5 IS NOT NULL
			)
		]]>
	</select>
	
	<select id="CSPMWF011ESelectHeaderList" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT TO_CHAR(TO_DATE(#MNU_DT#), 'YYYY-MM-DD (DY)') AS DATETIME FROM DUAL
		]]>
	</select>
	
	<select id="CSPMWF015PInit1" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT DPT_CD, DPT_NM FROM TBDCMACM002M WHERE DPT_CD LIKE '%000' and USE_YN = 'Y' 
			 ORDER BY HIRK_DPT_CD , SRT_SNO
		]]>
	</select>
	
	<select id="CSPMWF015PInit2" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT DPT_CD, DPT_NM 
			 FROM TBDCMACM002M 
			WHERE 1=1
			  AND USE_YN = 'Y' 
			  AND DPT_CD LIKE #kuk#||'%'
			  AND (DPT_CD NOT LIKE '%000' OR DPT_CD IN ('110000', '120000') ) 
			  AND DPT_CD != '880880'
			 ORDER BY DPT_CD
		]]>
	</select>
	
	<select id="CSPMWF015PUserSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT CNB, USR_ID, USR_NAM,
			      (SELECT CD_NM FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD ='1000173' AND CD = A.RANK_CD) AS RANK_NM,
				  (SELECT CD_NM FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD ='1000176' AND CD = A.PST_CD )AS PST_NM,
				  (SELECT DPT_NM FROM TBDCMACM002M WHERE DPT_CD = A.DPT_CD) AS DPT_NM,
				  '추가' AS NEW
			  FROM TBDCMACM001M A 
			 WHERE 1=1
			 AND	A.BAI_USR_YN = 'Y'
			 AND	A.DPT_CD != '880880'
			 AND	A.RSG_DT IS NULL
			 AND	(A.WOK_DVSN_CD IS NULL OR A.WOK_DVSN_CD != 'DAA')
			 AND	A.RQS_STA_CD = '3'
		]]>
			<dynamic>
				<isNotEmpty property="kuk">
					<isNotEmpty property="section">
						AND A.DPT_CD = #section#				
					</isNotEmpty>
					<isEmpty property="section">
						AND A.DPT_CD LIKE #kuk#||'%'
					</isEmpty>
				</isNotEmpty>
				<isEmpty property="kuk">
					<isNotEmpty property="section">
				   		AND A.DPT_CD = #section#
					</isNotEmpty>
				</isEmpty>
				<isNotEmpty property="usrNam">
				   AND A.USR_NAM LIKE '%'|| #usrNam# ||'%'
				</isNotEmpty>
			</dynamic>
		<![CDATA[
			ORDER BY CNB
		]]>
	</select>
	
   	<select id="CSPMWF015PResvDuplicationCheckSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       		   
			SELECT 	F_USR_INFO (BOKG_PEN_CNB,'2') AS RESERVER,
					F_USR_INFO (MEAL_PEN_CNB,'2') AS MEAL_PEN_NAM
			FROM  	TBCSPMWF003M 
			WHERE 	MEAL_PEN_CNB = #MEAL_PEN_CNB#   
			AND 	MEAL_DT = #MEAL_DT#
		 ]]>
	</select>
	
	<insert id="CSPMWF015PInsert" parameterClass="paramMap">
        <![CDATA[       
			INSERT INTO TBCSPMWF003M
			(
				MEAL_DT, BOKG_ID,
				BOKG_PEN_CNB, BOKG_DT,
				MEAL_PEN_CNB, BOKG_YN,
				MEAL_YN, BOKG_CNL_YN,
				MEAL_AM, BOKG_REGI_DH,
				FRT_USR_ID, FNL_USR_ID,
				FNL_DEAL_DPT_CD, FNL_MNU_ID,
				FRT_REGI_DH, FNL_MDF_DH
			)
			VALUES
			(
				#MEAL_DT#,
				(SELECT 'RS'|| TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHHMMSSFF4') FROM DUAL), 
				#BOKG_PEN_CNB#, 
				(SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') FROM DUAL),
				#MEAL_PEN_CNB#, 
				'Y', 
				'N',
				'N',
		        DECODE(
		        (SELECT COUNT(*) FROM TBCSPMWF005M WHERE CNB = #MEAL_PEN_CNB#),
		         0, (SELECT BOKG_M FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='2' AND USE_YN='Y'  AND STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE 1=1 AND EXTV_DVSN_CD ='2' AND USE_YN='Y') ),
		         1, (SELECT BOKG_M FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='1' AND USE_YN='Y'  AND STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE 1=1 AND EXTV_DVSN_CD ='1' AND USE_YN='Y') )
		         ),
				(SELECT TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI') FROM DUAL),
				#FRT_USR_ID#,
				#FNL_USR_ID#,
				#FNL_DEAL_DPT_CD#,
				#FNL_MNU_ID#,
				SYSDATE, 
				SYSDATE
			)
        ]]>
	</insert>
	
	<select id="CSPMWF011EResvSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[
			 SELECT MEAL_DT,
			        BOKG_ID,
			        BOKG_PEN_CNB,
			        (SELECT USR_NAM FROM TBDCMACM001M WHERE CNB = BOKG_PEN_CNB) AS BOKG_PEN_NAM,
			        BOKG_DT,
			        MEAL_PEN_CNB,
			        (SELECT USR_NAM FROM TBDCMACM001M WHERE CNB = MEAL_PEN_CNB) AS MEAL_PEN_NAM,
			        (SELECT DPT_NM FROM TBDCMACM002M 
			          WHERE DPT_CD = (SELECT DPT_CD FROM TBDCMACM001M WHERE CNB = MEAL_PEN_CNB)) AS DPT_NM,
			        BOKG_YN,
			        MEAL_YN,
			        BOKG_CNL_YN,
			        MEAL_AM,
			        BOKG_REGI_DH,
			        FRT_USR_ID,
			        FNL_USR_ID,
			        FNL_DEAL_DPT_CD,
			        FNL_MNU_ID,
			        FRT_REGI_DH,
			        FNL_MDF_DH
			   FROM TBCSPMWF003M
			  WHERE 1=1
			    AND MEAL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
			    AND BOKG_YN = 'Y'
			    AND BOKG_CNL_YN = 'N'
			    AND (BOKG_PEN_CNB = #CNB#
			         OR MEAL_PEN_CNB = #CNB#
			         OR (SELECT RAL_BLT_DIV_CD FROM TBDCMACM001M WHERE CNB = #CNB#) = (SELECT RAL_BLT_DIV_CD FROM TBDCMACM001M WHERE CNB = MEAL_PEN_CNB)
			         OR (SELECT RAL_BLT_DIV_CD FROM TBDCMACM001M WHERE CNB = #CNB#) = (SELECT RAL_BLT_DIV_CD FROM TBDCMACM001M WHERE CNB = BOKG_PEN_CNB)
			        )
			ORDER BY MEAL_DT
		]]>
	</select>
	
	<delete id="CSPMWF015PDelete" parameterClass="paramMap">
		<![CDATA[   	   
		DELETE FROM TBCSPMWF003M
		 WHERE MEAL_DT = #MEAL_DT#
		   AND BOKG_ID = #BOKG_ID#
		]]>
	</delete>
	
	<select id="CSPMWF011ECheck" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT TO_CHAR(YE||MD) AS YEMD,
				   TO_CHAR(SYSDATE, 'YYYYMMDD') AS YYYYMMDD,
				   TO_CHAR(SYSDATE + 1, 'YYYYMMDD') AS YYYYMMDD2,  
			       TO_CHAR(SYSDATE, 'HH24MI') AS HH24MI
			  FROM TBBADDED013B 
			 WHERE YE||MD >= TO_CHAR(SYSDATE, 'YYYYMMDD')
		]]>
	</select>
	
	<select id="CSPMWF018PExtvSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT 	A.EXTV_LST_SNO,
					A.SRCH_SNO,
					A.PST_CD,
					A.PST_NM,
					A.CNB,
					A.NAM,
					F_DPT_INFO((SELECT DPT_CD FROM TBDCMACM001M Z WHERE Z.CNB = A.CNB), '1')  AS DPT_NM
			  FROM TBCSPMWF005M A
			 ORDER BY SRCH_SNO
		]]>
	</select>
	
	<update id="CSPMWF018PExtvUpdate" parameterClass="paramMap">
		UPDATE 	TBCSPMWF005M
		   SET 	SRCH_SNO = #SRCH_SNO#,
				PST_CD = #PST_CD#,
				PST_NM = #PST_NM#,
				CNB = #CNB#,
				NAM = #NAM#,
				
				FNL_USR_ID = #FNL_USR_ID#,
				FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
				FNL_MNU_ID = #FNL_MNU_ID#,
				FNL_MDF_DH = SYSDATE
		 WHERE 	EXTV_LST_SNO = #EXTV_LST_SNO#

		    
	</update>
	
	<insert id="CSPMWF018PExtvInsert" parameterClass="paramMap">
        <![CDATA[       
			INSERT INTO TBCSPMWF005M (
					EXTV_LST_SNO,
					SRCH_SNO,
					PST_CD,
					PST_NM,
					CNB,
					NAM,
					FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH 
					)
					VALUES
					(
					(SELECT NVL(MAX(TO_NUMBER(EXTV_LST_SNO))+1, 1) FROM TBCSPMWF005M),
					#SRCH_SNO#,
					#PST_CD#,
					#PST_NM#,
					#CNB#,
					#NAM#,
					#FRT_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
					SYSDATE
					)
        ]]>
	</insert>
	
	<delete id="CSPMWF018PExtvDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE FROM TBCSPMWF005M
 			 WHERE EXTV_LST_SNO = #EXTV_LST_SNO#	   
		]]>  
	</delete>
<!-- 금액설정관리 시작 -->
	<select id="CSPMWF017PAmSetSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT	STAD_DT,
					AM_SET_SNO,
					EXTV_DVSN_CD,
					BSC_M,
					BOKG_M,
					UN_BOKG_M,
					USE_YN,
					FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH 
			  FROM TBCSPMWF004M
			 WHERE 1=1
			   AND STAD_DT <= #toYmd#
		]]>
			<isNotEmpty property="fromYmd">
			   AND STAD_DT &gt;= #fromYmd#
			</isNotEmpty>
			<isNotEmpty property="useYn">
			   AND USE_YN = #useYn#
			</isNotEmpty>
		<![CDATA[ 
			ORDER BY STAD_DT DESC, EXTV_DVSN_CD ASC
		]]>
	</select>
	
	<update id="CSPMWF017PAmSetUpdate" parameterClass="paramMap">
		<![CDATA[ 
			UPDATE	TBCSPMWF004M
			   SET 	EXTV_DVSN_CD = #EXTV_DVSN_CD#,
					BSC_M = #BSC_M#,
					BOKG_M = #BOKG_M#,
					UN_BOKG_M = #UN_BOKG_M#,
					USE_YN = #USE_YN#,
					FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE
			 WHERE	STAD_DT = #STAD_DT#
			   AND	AM_SET_SNO = #AM_SET_SNO#
	 	]]>
	</update>
	
	<update id="CSPMWF017PAmSetUseYnUpdate" parameterClass="paramMap">
		<![CDATA[ 
			UPDATE TBCSPMWF004M 
			   SET USE_YN = 'N'
			 WHERE EXTV_DVSN_CD = #EXTV_DVSN_CD#
	 	]]> 
	</update>
	
	<insert id="CSPMWF017PAmSetInsert" parameterClass="paramMap">
        <![CDATA[       
			INSERT INTO TBCSPMWF004M (
					STAD_DT,
					AM_SET_SNO,
					EXTV_DVSN_CD,
					BSC_M,
					BOKG_M,
					UN_BOKG_M,
					USE_YN,
					FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH 
			)VALUES(
					#STAD_DT#,
				   (SELECT DECODE(COUNT(STAD_DT), 0, 1, (SELECT MAX(AM_SET_SNO) + 1 
				                                           FROM TBCSPMWF004M WHERE  stad_dt = #STAD_DT#)) 
			          FROM TBCSPMWF004M where stad_dt = #STAD_DT#),
					#EXTV_DVSN_CD#,
					DECODE(#BSC_M#, NULL, 0, #BSC_M#),
					DECODE(#BOKG_M#, NULL, 0, #BOKG_M#),
					DECODE(#UN_BOKG_M#, NULL, 0, #UN_BOKG_M#),
					#USE_YN#,
					#FRT_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
					SYSDATE 
			)
        ]]>
	</insert>
	
	<delete id="CSPMWF017PAmSetDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE FROM TBCSPMWF004M
			 WHERE	STAD_DT = #STAD_DT#
			   AND	AM_SET_SNO = #AM_SET_SNO#
		]]>  
	</delete>
<!-- 금액설정관리 종료 -->

<!-- 예약관리 -->
	<insert id="CSPMWF016EextvListInsert" parameterClass="paramMap">
        <![CDATA[       
			INSERT INTO TBCSPMWF003M
				   (MEAL_DT,
					BOKG_ID,
					BOKG_PEN_CNB,
					BOKG_DT,
					MEAL_PEN_CNB,
					BOKG_YN,
					MEAL_YN,
					BOKG_CNL_YN,
					MEAL_AM,
					BOKG_REGI_DH,
					FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH)
			SELECT #ymd# AS MEAL_DT,
			       (SELECT 'RS'|| TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHHMMSSFF4') FROM DUAL) AS BOKG_ID,
			       (SELECT CNB FROM TBDCMACM001M WHERE USR_ID = A.FRT_USR_ID) AS BOKG_PEN_CNB,
			       #ymd# AS BOKG_DT,
			       A.CNB AS MEAL_PEN_CNB,
			       'N',
			       'N',
			       'N',
			       NULL,
			       SYSDATE,
			       A.FRT_USR_ID,
				   A.FNL_USR_ID,
				   A.FNL_DEAL_DPT_CD,
				   A.FNL_MNU_ID,
				   SYSDATE,
				   SYSDATE
			  FROM TBCSPMWF005M A
			 WHERE 1=1
			   AND A.CNB NOT IN (SELECT MEAL_PEN_CNB FROM TBCSPMWF003M WHERE MEAL_DT = #ymd#)
        ]]>
	</insert>

	<select id="CSPMWF016EextvListSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
   			SELECT	TO_CHAR(TO_DATE(A.MEAL_DT), 'YYYY-MM-DD') AS MEAL_DT,
					A.BOKG_ID,
					A.BOKG_PEN_CNB,
					(SELECT USR_NAM FROM TBDCMACM001M WHERE CNB = A.BOKG_PEN_CNB) AS BOKG_PEN_NAM ,
					A.BOKG_DT,
					A.MEAL_PEN_CNB,
					(SELECT USR_NAM FROM TBDCMACM001M WHERE CNB = A.MEAL_PEN_CNB) AS MEAL_PEN_NAM ,
			        (SELECT DPT_NM FROM TBDCMACM002M 
			          WHERE DPT_CD = (SELECT DPT_CD FROM TBDCMACM001M WHERE CNB = MEAL_PEN_CNB)) AS DPT_NM,
			        (SELECT CD_NM FROM TBDCMACM013C 
			          WHERE CMM_CD_DVSN_CD = '1000176' AND CD = (SELECT PST_CD 
			                                                       FROM TBDCMACM001M 
			                                                      WHERE CNB = MEAL_PEN_CNB)) AS RANK_NM,
					A.BOKG_YN,
					A.MEAL_YN,
					A.BOKG_CNL_YN,
					A.MEAL_AM,
					A.BOKG_REGI_DH,
					A.MEAL_YN AS OLD_MEAL_YN,
        			B.SRCH_SNO
			  FROM 	TBCSPMWF003M A,
			        TBCSPMWF005M B
			 WHERE 	A.MEAL_DT = #ymd#
			   AND 	A.MEAL_PEN_CNB = B.CNB
			   AND  A.BOKG_CNL_YN = 'N'
			   UNION 
			   SELECT
			   TO_CHAR(TO_DATE(#ymd#), 'YYYY-MM-DD') AS MEAL_DT,
			   '' AS BOKG_ID,
			   '' AS BOKG_PEN_CNB,
			   '' AS BOKG_PEN_NAM,
			   '' AS BOKG_DT,
			   B.CNB AS MEAL_PEN_CNB,
			   F_USR_INFO(B.CNB,'2') AS MEAL_PEN_NAM,
			   F_DPT_INFO(F_USR_INFO(B.CNB,'5'),'1') AS DPT_NM,
			   F_CODE_NM('1000176',F_USR_INFO(B.CNB,'4')) AS RANK_NM,
			   'N' BOKG_YN,
				'' MEAL_YN,
				'N' BOKG_CNL_YN,
				0  MEAL_AM,
				'' BOKG_REGI_DH,
				'' AS OLD_MEAL_YN,
        		B.SRCH_SNO
				FROM TBCSPMWF005M B
				WHERE B.CNB NOT IN (SELECT MEAL_PEN_CNB FROM TBCSPMWF003M WHERE MEAL_DT = #ymd#)
				ORDER BY B.SRCH_SNO
		 ]]>
	</select>
	
	<select id="CSPMWF016ENotExtvListSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT	A.MEAL_DT,
					A.BOKG_ID,
					A.BOKG_PEN_CNB,
					(SELECT USR_NAM FROM TBDCMACM001M WHERE CNB = A.BOKG_PEN_CNB) AS BOKG_PEN_NAM ,
					A.BOKG_DT,
					A.MEAL_PEN_CNB,
					(SELECT USR_NAM FROM TBDCMACM001M WHERE CNB = A.MEAL_PEN_CNB) AS MEAL_PEN_NAM ,
			        (SELECT DPT_NM FROM TBDCMACM002M 
			          WHERE DPT_CD = (SELECT DPT_CD FROM TBDCMACM001M WHERE CNB = MEAL_PEN_CNB)) AS DPT_NM,
			        (SELECT CD_NM FROM TBDCMACM013C 
			          WHERE CMM_CD_DVSN_CD = '1000176' AND CD = (SELECT PST_CD 
			                                                       FROM TBDCMACM001M 
			                                                      WHERE CNB = MEAL_PEN_CNB)) AS RANK_NM,
					A.BOKG_YN,
					A.MEAL_YN,
					A.BOKG_CNL_YN,
					A.MEAL_AM,
					A.BOKG_REGI_DH,
					A.FRT_USR_ID,
					A.FNL_USR_ID,
					A.FNL_DEAL_DPT_CD,
					A.FNL_MNU_ID,
					A.FRT_REGI_DH,
					A.FNL_MDF_DH
			  FROM 	TBCSPMWF003M A
			 WHERE 	MEAL_DT = #ymd#
			   AND  A.BOKG_YN = 'Y'
			   AND 	A.MEAL_PEN_CNB NOT IN (SELECT CNB FROM TBCSPMWF005M B)
			 ORDER BY BOKG_PEN_CNB
		 ]]>
	</select>
	
	<!-- 간부이면서 예약 안하고 식사한 사람 -->
	<insert id="CSPMWF016EExtvResvInsert" parameterClass="paramMap">
        <![CDATA[       
			INSERT INTO TBCSPMWF003M
			(
				MEAL_DT,
				BOKG_ID,
				MEAL_PEN_CNB,
				BOKG_PEN_CNB,
				BOKG_DT,
				BOKG_YN,
				MEAL_YN,
				BOKG_CNL_YN,
				MEAL_AM,
				BOKG_REGI_DH,
				FRT_USR_ID,
				FNL_USR_ID,
				FNL_DEAL_DPT_CD,
				FNL_MNU_ID,
				FRT_REGI_DH,
				FNL_MDF_DH
			)
			VALUES
			(
				#MEAL_DT#,
				(SELECT 'RS'|| TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHHMMSSFF4') FROM DUAL), 
				#MEAL_PEN_CNB#,
				#S_CNB#, 
				(SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') FROM DUAL),
				'N', 
				'Y',
				'N',
				DECODE(
				(SELECT COUNT(*) FROM TBCSPMWF005M WHERE CNB = #MEAL_PEN_CNB#),
				 0, (SELECT BOKG_M FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='2' AND USE_YN='Y' AND STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE 1=1 AND EXTV_DVSN_CD ='2' AND USE_YN='Y')  ),
				 1, (SELECT UN_BOKG_M FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='1' AND USE_YN='Y' AND STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE 1=1 AND EXTV_DVSN_CD ='1' AND USE_YN='Y')    )
				 ),
				(SELECT TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI') FROM DUAL),
				#FNL_USR_ID#,
				#FNL_USR_ID#,
				#FNL_DEAL_DPT_CD#,
				#FNL_MNU_ID#,
				SYSDATE, 
				SYSDATE
			)
        ]]>
	</insert>
	
	<!-- 간부이면서 예약 하고 식사한 사람   CSPMWF016EExtvResvUpdate -->
	<update id="CSPMWF016EExtvResvUpdate" parameterClass="paramMap">
		UPDATE 	TBCSPMWF003M
		   SET 	MEAL_YN = 'Y',
				FNL_USR_ID  = #FNL_USR_ID#,
				FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
				FNL_MNU_ID = #FNL_MNU_ID#,
				FNL_MDF_DH = SYSDATE
		 WHERE 1=1
		   AND MEAL_DT = #MEAL_DT#
		   AND BOKG_ID = #BOKG_ID#
		   AND MEAL_PEN_CNB = #MEAL_PEN_CNB#
		   AND BOKG_YN = 'Y'
	</update>
	
	<!-- 간부 외 예약 후 식사 업데이트 CSPMWF016ENotExtvResvUpdate -->
	
	<update id="CSPMWF016ENotExtvResvUpdate" parameterClass="paramMap">
		UPDATE 	TBCSPMWF003M
		   SET 	MEAL_YN = #MEAL_YN#,
				FNL_USR_ID  = #FNL_USR_ID#,
				FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
				FNL_MNU_ID = #FNL_MNU_ID#,
				FNL_MDF_DH = SYSDATE
		 WHERE 1=1
		   AND MEAL_DT = #MEAL_DT#
		   AND BOKG_ID = #BOKG_ID#
		   AND MEAL_PEN_CNB = #MEAL_PEN_CNB#
		   AND BOKG_YN = 'Y'
	</update>
<!-- 예약관리 -->

	<update id="CSPMWF016EExtvResvInsertUpdate" parameterClass="paramMap">
	<![CDATA[    
		MERGE INTO TBCSPMWF003M
		USING DUAL
		ON (MEAL_DT = REPLACE(#MEAL_DT#, '-') AND MEAL_PEN_CNB = #MEAL_PEN_CNB#)
		WHEN MATCHED THEN 
		UPDATE SET 
	]]>
		<isEmpty property="MEAL_YN">
			MEAL_YN = 'N'
		</isEmpty>
		<isNotEmpty  property="MEAL_YN">
			MEAL_YN = #MEAL_YN#
		</isNotEmpty>
	<![CDATA[
		WHEN NOT MATCHED THEN 
		INSERT VALUES
					(
						REPLACE(#MEAL_DT#, '-'),
						#MEAL_PEN_CNB#,
						(SELECT 'RS'|| TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHHMMSSFF4') FROM DUAL), 
						#S_CNB#, 
						(SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') FROM DUAL),
						#BOKG_YN#, 
						#MEAL_YN#,
						#BOKG_CNL_YN#,
						DECODE(
						(SELECT COUNT(*) FROM TBCSPMWF005M WHERE CNB = #MEAL_PEN_CNB#),
						 0, (SELECT BOKG_M FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='2' AND USE_YN='Y' AND STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE 1=1 AND EXTV_DVSN_CD ='2' AND USE_YN='Y')  ),
						 1, (SELECT UN_BOKG_M FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='1' AND USE_YN='Y' AND STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE 1=1 AND EXTV_DVSN_CD ='1' AND USE_YN='Y')    )
						 ),
						(SELECT TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI') FROM DUAL),
						#FNL_USR_ID#,
						#FNL_USR_ID#,
						#FNL_DEAL_DPT_CD#,
						#FNL_MNU_ID#,
						SYSDATE,
						SYSDATE
					)
		]]>
	</update>


	<select id="CSPMWF020QMainSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT
					MEAL_DT,
					MEAL_PEN_CNB,
					F_USR_INFO(MEAL_PEN_CNB, '2') AS USRNAM,
					F_DPT_INFO(F_USR_INFO(MEAL_PEN_CNB, '5'), '1') AS DPT_NM,
					BOKG_YN,
					NVL(MEAL_YN, 'N') AS MEAL_YN,
					DECODE(BOKG_YN, 'Y', '1', '0') AS BOKG_YN_CNT,
					DECODE(MEAL_YN, 'Y', '1', '0') AS MEAL_YN_CNT
			 FROM 	TBCSPMWF003M
			WHERE 	MEAL_DT BETWEEN #fromYmd# AND #toYmd#
			  AND 	BOKG_CNL_YN = 'N'
		]]>
		<isEqual property="extvDvsn" compareValue="1">
			  AND	MEAL_PEN_CNB IN (SELECT CNB FROM  TBCSPMWF005M)
		</isEqual>
		<isEqual property="extvDvsn" compareValue="2">
			  AND	MEAL_PEN_CNB NOT IN (SELECT CNB FROM  TBCSPMWF005M)
		</isEqual>
		<isNotEmpty property="CNB">
			  AND	MEAL_PEN_CNB = #CNB#
		</isNotEmpty>
		<![CDATA[
			  AND	(BOKG_YN != 'N' OR MEAL_YN != 'N')
  		    ORDER BY MEAL_DT, MEAL_PEN_CNB
		]]>
	</select>
	
	<select id="CSPMWF021QExtvSumListSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT  D1.MM,
			        D1.MEAL_PEN_CNB,
			        D1.USR_NAM,
			        D1.DPT_CD,
			        D1.DPT_NM,
			        D1.SRCH_SNO,
			        SUM(YY) AS YY,
			        SUM(YN) AS YN,
			        SUM(NY) AS NY,
			        MAX(BSC_M) AS BSC_M,
			        NVL(SUM(MEAL_M),0) AS MEAL_M,
			        MAX(BSC_M) + SUM(MEAL_M) AS TOT_M 
			FROM    (
			            SELECT NVL(SUBSTR(MEAL_DT, 0, 6),#yyyymm#) AS MM,
			                   C.CNB AS MEAL_PEN_CNB,
			                   D.USR_NAM,
			                   E.DPT_CD,
			                   E.DPT_NM,
			                   (CASE WHEN A.BOKG_YN = 'Y' AND A.MEAL_YN = 'Y' THEN 1 ELSE 0 END) AS YY,    /* 예약하고 식사       */
			                   (CASE WHEN A.BOKG_YN = 'Y' AND A.MEAL_YN = 'N' THEN 1 ELSE 0 END) AS YN,    /* 예약하고 안먹음	*/
			                   (CASE WHEN A.BOKG_YN = 'N' AND A.MEAL_YN = 'Y' THEN 1 ELSE 0 END) AS NY,    /* 예약안하고 먹음	*/
			                   (SELECT BSC_M FROM TBCSPMWF004M WHERE STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='1' AND STAD_DT <= NVL(A.MEAL_DT,#yyyymm#)) AND EXTV_DVSN_CD ='1') AS BSC_M,
			                   (CASE WHEN A.MEAL_YN = 'Y' AND A.BOKG_YN = 'Y' THEN 
			                            (SELECT BOKG_M FROM TBCSPMWF004M WHERE STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='1' AND STAD_DT <= A.MEAL_DT) AND EXTV_DVSN_CD ='1')
			                            WHEN A.MEAL_YN = 'Y' AND A.BOKG_YN = 'N' THEN 
			                            (SELECT UN_BOKG_M FROM TBCSPMWF004M WHERE STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='1' AND STAD_DT <= A.MEAL_DT) AND EXTV_DVSN_CD ='1')
			                            WHEN A.MEAL_YN = 'N' AND A.BOKG_YN = 'Y' THEN 
			                            (SELECT BOKG_M FROM TBCSPMWF004M WHERE STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='1' AND STAD_DT <= A.MEAL_DT)AND EXTV_DVSN_CD ='1' )
			                            ELSE 0 END 
			                       ) AS MEAL_M,
			                   C.SRCH_SNO
			              FROM TBCSPMWF003M A,
			                   TBCSPMWF005M C,
			                   TBDCMACM001M D,
			                   TBDCMACM002M E
			             WHERE 1=1
			               AND A.MEAL_PEN_CNB(+) = C.CNB
			               AND C.CNB = D.CNB
			               AND D.DPT_CD = E.DPT_CD
			               AND A.MEAL_DT(+) LIKE #yyyymm# || '%'
		]]>
					<isNotEmpty property="dptCd">
						  AND D.DPT_CD LIKE #dptCd# || '%'
					</isNotEmpty>
					<isNotEmpty property="CNB">
						  AND C.CNB = #CNB# 
					</isNotEmpty>
		<![CDATA[
			        ) D1
			GROUP BY   	D1.MM,
				        D1.MEAL_PEN_CNB,
				        D1.USR_NAM,
				        D1.DPT_CD,
				        D1.DPT_NM,
				        D1.SRCH_SNO
			ORDER BY 	SRCH_SNO
		]]>
	</select>

	<select id="CSPMWF021QNotExtvSumListSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT  D1.MM,
			        D1.MEAL_PEN_CNB,
			        D1.USR_NAM,
			        D1.DPT_CD,
			        D1.DPT_NM,
			        SUM(YY) AS YY,
			        SUM(MEAL_M) AS MEAL_M
			FROM    (
			            SELECT SUBSTR(MEAL_DT, 0, 6) AS MM,
			                   MEAL_PEN_CNB,
			                   D.USR_NAM,
			                   E.DPT_CD,
			                   E.DPT_NM,
			                   (CASE WHEN A.BOKG_YN = 'Y' THEN 1 ELSE 0 END) AS YY,    /* 예약하고 식사       */
			                   (CASE WHEN A.BOKG_YN = 'Y' THEN 
			                            (SELECT BOKG_M FROM TBCSPMWF004M WHERE STAD_DT = (SELECT MAX(STAD_DT) FROM TBCSPMWF004M WHERE EXTV_DVSN_CD ='2' AND STAD_DT <= A.MEAL_DT) AND EXTV_DVSN_CD ='2')
			                            ELSE 0 END 
			                    ) AS MEAL_M
			              FROM TBCSPMWF003M A,
			                   TBDCMACM001M D,
			                   TBDCMACM002M E
			             WHERE 1=1
			               AND A.MEAL_PEN_CNB NOT IN (SELECT CNB FROM  TBCSPMWF005M)
			               AND A.MEAL_PEN_CNB = D.CNB
			               AND D.DPT_CD = E.DPT_CD
			               AND A.MEAL_DT LIKE #yyyymm# || '%'
		]]>
					<isNotEmpty property="dptCd">
						  AND D.DPT_CD LIKE #dptCd# || '%'
					</isNotEmpty>
					<isNotEmpty property="CNB">
						  AND A.MEAL_PEN_CNB = #CNB# 
					</isNotEmpty>
		<![CDATA[
			        ) D1
			GROUP BY   	D1.MM,
				        D1.MEAL_PEN_CNB,
				        D1.USR_NAM,
				        D1.DPT_CD,
				        D1.DPT_NM
			ORDER BY  	D1.DPT_CD, D1.USR_NAM
		]]>
	</select>
	
	
	<select id="CSPMWF011EHolyDayCheck" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	CASE WHEN (	SELECT COUNT(*) 
								FROM 	TBBADDED013B 
                    			WHERE 	YE||MD = #today#) > 0 THEN 'Y' 
                    ELSE 'N' END AS CHECK_YN
                    , TO_CHAR(SYSDATE, 'YYYYMMDD') AS YYYYMMDD
				   	, TO_CHAR(SYSDATE + 1, 'YYYYMMDD') AS YYYYMMDD2  
			        , TO_CHAR(SYSDATE, 'HH24MI') AS HH24MI
			FROM DUAL
		]]>
	</select>
</sqlMap>