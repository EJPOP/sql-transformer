<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/dcp/121">
 	
 	<select id="CSPDCP121QMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT T1.YM
			     , T1.INF_RPRT_NO
			     , T1.INF_TYP_CD
			     , T1.DOC_ID
			     , T1.TIT_NM
			     , T1.FRT_USR_ID AS USR_ID
			     , T2.USR_NAM
			     , T1.WRIT_STA_CD
			     , T1.SMT_DH
			     , F_CODE_NM('1000606', T1.WRIT_STA_CD) AS WRIT_STA_NM 
			     , '정보' || '-' || SUBSTR(T1.YM, 3, 4) || '-' || LPAD(T1.INF_RPRT_NO, 4, '0') AS INFNO
			     , CASE WHEN SUBSTR(T1.INF_TYP_CD, 0, 2) = '01' THEN F_CODE_NM('1000607', '0100')||' - '||F_CODE_NM('1000607', T1.INF_TYP_CD)
			            WHEN SUBSTR(T1.INF_TYP_CD, 0, 2) = '02' THEN F_CODE_NM('1000607', '0200')||' - '||F_CODE_NM('1000607', T1.INF_TYP_CD) END AS INFNM
			  FROM TBCSPDCP501M T1
                 , TBDCMACM001M T2
			 WHERE 1=1	
   			   AND T1.FRT_USR_ID = T2.USR_ID(+)
		]]>
		<dynamic>
			<isNotEmpty property="WRIT_STA_CD">
		    AND T1.WRIT_STA_CD = #WRIT_STA_CD#
			</isNotEmpty>
			<isNotEmpty property="INF_TYP_CD">
			AND T1.INF_TYP_CD  = #INF_TYP_CD#
			</isNotEmpty>
			<isNotEmpty property="TIT_NM">
			AND T1.TIT_NM LIKE '%'||#TIT_NM#||'%'
			</isNotEmpty>
			<isNotEmpty property="STARTDT">
				<isNotEmpty property="ENDDT">
			    AND TO_CHAR(T1.FRT_REGI_DH, 'YYYYMMDD') BETWEEN #STARTDT# AND #ENDDT#
				</isNotEmpty>
			</isNotEmpty>
			<isNotEmpty property="STARTDT">
				<isEmpty property="ENDDT">
				AND TO_CHAR(T1.FRT_REGI_DH, 'YYYYMMDD') BETWEEN #STARTDT# AND TO_CHAR(SYSDATE, 'YYYYMMDD')
				</isEmpty>
			</isNotEmpty>
				 
		</dynamic>
		ORDER BY T1.YM DESC, T1.INF_RPRT_NO DESC
	</select>
	
	<select id="CSPDCP121QMainCount" resultClass="resultMap">
	  SELECT  
			   COUNT(T1.YM) AS TOTALCNT ,
		       SUM(
		                       CASE
		                         WHEN SUBSTR(T1.INF_TYP_CD, 0, 2) = '01' THEN 1
		                         ELSE 0
		                       END) AS INFTYP01CNT ,
		       SUM(
		                       CASE
		                         WHEN SUBSTR(T1.INF_TYP_CD, 0, 2) = '02' THEN 1
		                         ELSE 0
		                       END) AS INFTYP02CNT
		  FROM TBCSPDCP501M T1 ,
		       TBDCMACM001M T2
		 WHERE 1=1
		   AND T1.FRT_USR_ID = T2.USR_ID(+)
	</select>
	
	
	<update id="CSPDCP121QWrtStatusUpdate" parameterClass="paramMap">
			UPDATE TBCSPDCP501M
			   SET WRIT_STA_CD     = #WRIT_STA_CD#
			      ,SMT_DH          = CASE WHEN #WRIT_STA_CD# = '20' THEN SYSDATE ELSE NULL END
			      ,FNL_USR_ID      = #FNL_USR_ID#
   				  ,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
   				  ,FNL_MNU_ID      = #FNL_MNU_ID#
   				  ,FNL_MDF_DH      = SYSDATE 
			 WHERE YM = #YM#
			   AND INF_RPRT_NO = #INF_RPRT_NO#
	</update>
	
	<delete id="CSPDCP121QDelete" parameterClass="paramMap">
			DELETE 
			  FROM TBCSPDCP501M
			 WHERE YM = #YM#
			   AND INF_RPRT_NO = #INF_RPRT_NO#
	</delete>
</sqlMap> 
