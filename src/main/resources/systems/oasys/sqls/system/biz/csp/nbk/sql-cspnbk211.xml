<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="csp/nbk/211">
	
	<select id="CSPNBK211EMouiPersonListSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK211EMouiPersonListSelect */
				D1.MOUI_NO
				, D1.CNB
				, D2.USR_NAM
				, SUBSTR(D2.EIN, 1, 6) || '-*******' AS EIN
				, D2.RANK_CD
				, ( SELECT	D4.CD_NM
					FROM	TBDCMACM013C D4
					WHERE	D4.CMM_CD_DVSN_CD = '1000173'
					AND		D4.CD = D2.RANK_CD
				) AS RANK_CD_NM
				, D3.DPT_NM
				, D1.EX_DVD_RTS_TG_YN
				, D1.SAL_SEI_YN
				, D1.SCS_YN
				, D1.RMK
				, D1.RGR_YN
		FROM	TBCSPNBK001M D1
				, TBDCMACM001M D2
				, TBDCMACM002M D3
		WHERE	D1.CNB = D2.CNB
		AND		D2.DPT_CD = D3.DPT_CD
		AND		D1.MOUI_DVSN_CD = '0'
	]]>
		<isNotEmpty property="mouiNo" prepend="AND">
				D1.MOUI_NO = #mouiNo#
		</isNotEmpty>
		<isNotEmpty property="cnb" prepend="AND">
				D1.CNB = #cnb#
		</isNotEmpty>
		<isNotEmpty property="mouiNm" prepend="AND">
				D2.USR_NAM LIKE '%' || #mouiNm# || '%'
		</isNotEmpty>
		<isNotEmpty property="scsYn" prepend="AND">
				D1.SCS_YN = #scsYn#
		</isNotEmpty>
		<isEqual property="rsgYn" compareValue="Y" prepend="AND">
				D2.RSG_DT IS NOT NULL
		</isEqual>
		<isEqual property="rsgYn" compareValue="N" prepend="AND">
				( D2.RSG_DT IS NULL OR D2.RSG_DT = '' ) 
		</isEqual>
	<![CDATA[
		ORDER BY MOUI_NO
	]]>
	</select>
	
	<select id="CSPNBK211EMouiOrgListSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK211EMouiOrgListSelect */
				D1.MOUI_NO
				, D1.CNB
				, D1.OGNZ_NM
				, (	SELECT	D4.MOUI_NO
					FROM	TBCSPNBK001M D4
					WHERE	D4.MOUI_DVSN_CD = '0'
					AND		D4.CNB = D1.CNB
				) AS USR_MOUI_NO
				, D2.USR_NAM
				, SUBSTR(D2.EIN, 1, 6) || '-*******' AS EIN
				, D2.RANK_CD
				, ( SELECT	D5.CD_NM
					FROM	TBDCMACM013C D5
					WHERE	D5.CMM_CD_DVSN_CD = '1000173'
					AND		D5.CD = D2.RANK_CD
				) AS RANK_CD_NM
				, D3.DPT_NM
				, D1.EX_DVD_RTS_TG_YN
				, D1.SAL_SEI_YN
				, D1.SCS_YN
				, D1.RMK
				, D1.RGR_YN
		FROM	TBCSPNBK001M D1
				, TBDCMACM001M D2
				, TBDCMACM002M D3
		WHERE	D1.CNB = D2.CNB
		AND		D2.DPT_CD = D3.DPT_CD
		AND		D1.MOUI_DVSN_CD = '1'
	]]>
		<isNotEmpty property="mouiNo" prepend="AND">
				D1.MOUI_NO = #mouiNo#
		</isNotEmpty>
		<isNotEmpty property="cnb" prepend="AND">
				D1.CNB = #cnb#
		</isNotEmpty>
		<isNotEmpty property="mouiNm" prepend="AND">
				D1.OGNZ_NM LIKE '%' || #mouiNm# || '%'
		</isNotEmpty>
		<isNotEmpty property="scsYn" prepend="AND">
				D1.SCS_YN = #scsYn#
		</isNotEmpty>
	<![CDATA[
		ORDER BY MOUI_NO
	]]>
	</select>
	
	<select id="CSPNBK211ENewMouiNoSelect" parameterClass="paramMap" resultClass="String">
	<![CDATA[
		SELECT	/* CSPNBK211ENewMouiNoSelect */
				LPAD( NVL(MAX(D1.MOUI_NO),0) + 1, 4, '0') AS MOUI_NO
		FROM	TBCSPNBK001M D1
		WHERE	SUBSTR(D1.MOUI_NO, 1, 1) NOT IN ( '8', '9' )
	]]>
	</select>
	
	<insert id="CSPNBK211EMouiInsert" parameterClass="paramMap">
	<![CDATA[
		INSERT INTO TBCSPNBK001M /* CSPNBK211EMouiInsert */
		(
			MOUI_NO
			, MOUI_DVSN_CD
			, CNB
			, EX_DVD_RTS_TG_YN
			, SAL_SEI_YN
			, SCS_YN
			, JOI_DT
			, RMK
			, OGNZ_NM
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
			, RGR_YN
		)
		VALUES
		(
			#MOUI_NO#
			, #MOUI_DVSN_CD#
			, #CNB#
			, #EX_DVD_RTS_TG_YN#
			, #SAL_SEI_YN#
			, 'N'
			, TO_CHAR(SYSDATE, 'YYYYMMDD')
			, #RMK#
			, #OGNZ_NM#
			, #FRT_USR_ID#
			, #FNL_USR_ID#
			, #FNL_DEAL_DPT_CD#
			, #FNL_MNU_ID#
			, SYSDATE
			, SYSDATE
			, #RGR_YN#
		)
	]]>
	</insert>
	
	<update id="CSPNBK211EMouiUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	TBCSPNBK001M D1 /* CSPNBK211EMouiUpdate */
		SET		CNB = #CNB#
				, EX_DVD_RTS_TG_YN = #EX_DVD_RTS_TG_YN#
				, SAL_SEI_YN = #SAL_SEI_YN#				
				, RMK = #RMK#
				, OGNZ_NM = #OGNZ_NM#
				, FNL_USR_ID = #FNL_USR_ID#
				, FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
				, FNL_MNU_ID = #FNL_MNU_ID#
				, FNL_MDF_DH = SYSDATE
				, RGR_YN = #RGR_YN#
		WHERE	D1.MOUI_NO = #MOUI_NO#
	]]>
	</update>
	
	<delete id="CSPNBK211EMouiDelete" parameterClass="paramMap">
	<![CDATA[
		DELETE  /* CSPNBK211EMouiDelete */
		FROM 	TBCSPNBK001M D1
		WHERE	D1.MOUI_NO = #MOUI_NO#
	]]>
	</delete>
	
	<select id="CSPNBK211EMouiPersonCheckSelect" parameterClass="paramMap" resultClass="int">
	<![CDATA[
		SELECT	/* CSPNBK211EMouiPersonCheckSelect */
				COUNT(D1.MOUI_NO) AS CNT
		FROM	TBCSPNBK001M D1
		WHERE	D1.CNB = #CNB#
		AND		D1.SCS_YN = 'N'
	]]>
	</select>
	
	<select id="CSPNBK211EMouiInvLendCheckSelect" parameterClass="paramMap" resultClass="int">
	<![CDATA[
		SELECT	/* CSPNBK211EMouiInvLendCheckSelect */
				SUM(CNT) AS CNT
		FROM	(
					SELECT	COUNT(D1.MOUI_NO) AS CNT
					FROM	TBCSPNBK101M D1
					WHERE	D1.INV_TMN_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')
					AND		D1.MOUI_NO = #MOUI_NO#
					
					UNION ALL
					
					SELECT	COUNT(D1.MOUI_NO) AS CNT
					FROM	TBCSPNBK202M D1
					WHERE	D1.LEND_BL > 0
					AND		D1.MOUI_NO = #MOUI_NO#
				)
	]]>
	</select>
	
	<select id="CSPNBK211MouiListSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK211MouiListSelect */
				D1.MOUI_NO
				, D1.CNB
				, D2.USR_NAM
				, D1.MOUI_DVSN_CD
				, DECODE( D1.MOUI_DVSN_CD, '0', D2.USR_NAM, D1.OGNZ_NM ) AS MOUI_NM
				, SUBSTR(D2.EIN, 1, 6) || '-*******' AS EIN
				, D2.RANK_CD
				, F_CODE_NM ( '1000173', D2.RANK_CD ) AS RANK_CD_NM
				, D3.DPT_NM
				, D1.EX_DVD_RTS_TG_YN
				, D1.SAL_SEI_YN
				, D1.SCS_YN
				, D1.RMK
		FROM	TBCSPNBK001M D1
				, TBDCMACM001M D2
				, TBDCMACM002M D3
		WHERE	D1.CNB = D2.CNB
		AND		D2.DPT_CD = D3.DPT_CD
	]]>
		<isNotEmpty property="scsYn" prepend="AND">
				D1.SCS_YN = #scsYn#
		</isNotEmpty>
	<![CDATA[
		ORDER BY MOUI_NO
	]]>
	</select>
</sqlMap>