<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/sae/903">

	<select id="CSPSAE903QCbbYr" parameterClass="paramMap" resultClass="resultMap">
		/*cspsae903 CSPSAE903QCbbYr*/
        <![CDATA[
            SELECT 	YYYY AS YR_CD, 
					YYYY AS YR_NM 
			FROM	(
						SELECT TO_CHAR(SYSDATE,'YYYY') - LEVEL + 1 YYYY 
						FROM DUAL 
						CONNECT BY TO_CHAR(SYSDATE,'YYYY') - LEVEL + 1 >= 1980
					)
        ]]>
	</select>
	
	<select id="CSPSAE903QMainList" parameterClass="paramMap" resultClass="resultMap">
		/*cspsae903 CSPSAE903QMainList*/
		<![CDATA[
		  SELECT ROWNUM AS NUM , T.*
			FROM
			( SELECT
			       A.SNO,
			       A.TIT_NM,
			       A.ORG_CD,
			       F_ORG_INFO(A.ORG_CD,'1') AS ORG_NM,
			       A.CRS_NM,
			       A.USR_CNB,
			       F_USR_INFO(A.USR_CNB, '2') AS USR_NM,
			       DECODE(A.EDU_RCMD_YN,'Y','추천','N','비추천') AS EDU_RCMD_YN,
			       A.FRT_REGI_DH,
			       A.SRCH_CNT
			  FROM TBCSPSAE903M A
			  WHERE 1=1
		]]>
		<dynamic>
			 <isNotEmpty property="strYR_CD">
		     	AND SUBSTR(A.FRT_REGI_DH,1,4) = #strYR_CD#
		     </isNotEmpty>
		     <isNotEmpty property="strEDU_RCMD_YN">
		     	AND A.EDU_RCMD_YN = #strEDU_RCMD_YN#
		     </isNotEmpty>
		     <isNotEmpty property="strORG_CD">
		     	AND A.ORG_CD = #strORG_CD#
		     </isNotEmpty>
	     </dynamic>
		<![CDATA[
		  ORDER BY TO_NUMBER(A.SNO)
		  ) T ORDER BY NUM DESC
		]]>
	</select>
	
	<update id="CSPSAE903QSrchCntUp" parameterClass="paramMap">
		/*cspsae903 CSPSAE903QSrchCntUp*/
		<![CDATA[
			UPDATE TBCSPSAE903M 
				SET SRCH_CNT = (SELECT SRCH_CNT+1 FROM TBCSPSAE903M WHERE SNO = #strSNO#)
                WHERE SNO = #strSNO#
		]]>
	</update>
	
	<select id="CSPSAE903EselectMain" parameterClass="paramMap" resultClass="resultMap">
		/*cspsae903 CSPSAE903EselectMain*/
		<![CDATA[
			SELECT  
			     A.ORG_CD
			    ,F_ORG_INFO(A.ORG_CD,'1') AS ORG_NM
			    ,A.TIT_NM
			    ,A.EDU_RCMD_YN
			    ,A.TXT
			    ,A.SNO
			    ,A.DOC_ID
			    ,A.CRS_NM
			FROM TBCSPSAE903M A
			WHERE
			    A.SNO = #strSNO#
		]]>  
	</select>
	
	<insert id="CSPSAE903EMainInsert" parameterClass="paramMap">
		/*cspsae903 CSPSAE903EMainInsert*/
		<selectKey keyProperty="SNO" resultClass="java.lang.String" type="pre" >
			SELECT TO_CHAR(NVL(MAX(TO_NUMBER(SNO)),0)+1)
				  FROM TBCSPSAE903M
		</selectKey>
        <![CDATA[     	
			INSERT INTO TBCSPSAE903M
        	(		SNO,
					
					TIT_NM,
					ORG_CD,
					USR_CNB,
					TXT,
					DOC_ID,
					EDU_RCMD_YN,
					CRS_NM,
					
        			FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH
        	) VALUES (
        			#SNO#,
					
					#TIT_NM#,
					#ORG_CD#,
					#S_CNB#,
					#TXT#,
					#DOC_ID#,
                    #EDU_RCMD_YN#,
                    #CRS_NM#,
                    
					#FRT_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
                    SYSDATE
             )
		]]>
	</insert>
	
	<delete id="CSPSAE903EMainDelete" parameterClass="paramMap">
		/*cspsae903 CSPSAE903EMainDelete*/
        <![CDATA[     	
			DELETE FROM TBCSPSAE903M 
			 WHERE SNO = #SNO#
		]]>
	</delete>
	<delete id="CSPSAE903ECommentDelete" parameterClass="paramMap">
		/*cspsae903 CSPSAE903ECommentDelete*/
        <![CDATA[     	
			DELETE FROM TBCSPSAE903L
			 WHERE SNO = #SNO#
		]]>
	</delete>
	
	<update id="CSPSAE903EMainUpdate" parameterClass="paramMap">
		/*cspsae903 CSPSAE903EMainUpdate*/
		<![CDATA[
			UPDATE TBCSPSAE903M
				SET ORG_CD = #ORG_CD#
					,TIT_NM = #TIT_NM#
					,TXT = #TXT#
					,EDU_RCMD_YN = #EDU_RCMD_YN#
					,CRS_NM = #CRS_NM#
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
					,FNL_MDF_DH = SYSDATE
				WHERE SNO = #SNO#
		]]>
	</update>
	<update id="CSPSAE903EFileUpdate" parameterClass="paramMap">
		/*cspsae903 CSPSAE903EFileUpdate*/
		<![CDATA[
			UPDATE TBCSPSAE903M
				SET DOC_ID = #DOC_ID#
				WHERE SNO = #SNO#
		]]>
	</update>

	<select id="CSPSAE903LCommentSelect" parameterClass="paramMap"
		resultClass="resultMap">
		/* csp.sae.service.impl.CSPSAE903EServiceImpl.CSPSAE903LCommentSelect */
        <![CDATA[
			SELECT 
				   ROW_NUMBER() OVER (ORDER BY A.SNO, A.CMMT_SEQ) AS NO,
			    A.SNO,
				A.CMMT_SEQ,
				A.CMMT_USR_CNB,
				F_USR_INFO(A.CMMT_USR_CNB,'2') AS CMMT_USR_NM,
				A.CMMT_CONTENT,
				A.DEL_YN,
				F_DPT_INFO(F_USR_INFO(A.CMMT_USR_CNB,'5'),'1') AS CMMT_USR_DPT_NM,
				TO_CHAR(A.FRT_REGI_DH, 'YYYY-MM-DD HH24:MI:SS') AS FRT_REGI_DH
			  FROM TBCSPSAE903L A
			 WHERE A.SNO = #strSNO#
			 		AND DEL_YN != 'D'
		  ORDER BY A.SNO, TO_NUMBER(A.CMMT_SEQ)
         ]]>
	</select>
	
	<!-- 교육이용후기 댓글 등록 -->
	<insert id="CSPSAE903ECommentInsert" parameterClass="paramMap">
	/* csp.sae.service.impl.CSPSAE903EServiceImpl.CSPSAE903ECommnetInsert */
	<![CDATA[
		INSERT INTO TBCSPSAE903L (
		                           SNO
		                          ,CMMT_SEQ 
		                          ,CMMT_USR_CNB
		                          ,CMMT_CONTENT
		                          ,FRT_USR_ID 
		                          ,FNL_USR_ID 
		                          ,FNL_DEAL_DPT_CD 
		                          ,FNL_MNU_ID
		                          ,FRT_REGI_DH
		                          ,FNL_MDF_DH
		                         )
		                   VALUES
		                         (
		                           #strSNO#
		                          ,NVL((SELECT MAX(TO_NUMBER(CMMT_SEQ)) FROM TBCSPSAE903L WHERE SNO = #strSNO#),0)+1
		                          ,#S_CNB#
		                          ,#strContent#
		                          ,#FRT_USR_ID#
		                          ,#FNL_USR_ID#
		                          ,#FNL_DEAL_DPT_CD#
		                          ,#FNL_MNU_ID#
		                          ,SYSDATE
		                          ,SYSDATE
		                         )
    ]]>	
	</insert>	
	
	<!-- 교육이용후기 댓글 수정 -->
	<update id="CSPSAE903ECommentUpdate" parameterClass="paramMap">
	/* csp.sae.service.impl.CSPSAE903EServiceImpl.CSPSAE903ECommentUpdate */
		<![CDATA[
			UPDATE TBCSPSAE903L SET 
              FNL_USR_ID = #FNL_USR_ID#
              ,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
              ,FNL_MDF_DH = SYSDATE
        ]]>
		<dynamic>
			 <isEqual property="DEL_YN" compareValue="D">
				<![CDATA[
		     		,DEL_YN = #DEL_YN#
	        	]]>
		     </isEqual>
		     <isNotEqual property="DEL_YN" compareValue="D">
				<![CDATA[
        	       ,CMMT_CONTENT = #strContent#
		        ]]>
		     </isNotEqual>
	    </dynamic>
		<![CDATA[
			          WHERE SNO    = #strSNO#
			            AND CMMT_SEQ   = #strCmmtSeq#
        ]]>
	</update>			
	
	<select id="CSPSAE903QExcelSelect" parameterClass="paramMap"
		resultClass="resultMap">
		/*cspsae902 CSPSAE903QExcelSelect*/
        <![CDATA[     	
			SELECT ROWNUM AS NUM , T.*
			FROM
			( SELECT
			       A.TIT_NM,
			       F_ORG_INFO(A.ORG_CD,'1') AS ORG_NM,
			       F_USR_INFO(A.USR_CNB, '2') AS USR_NM,
			       TO_CHAR(A.FRT_REGI_DH,'YYYY-MM-DD') AS FRT_REGI_DH,
                   DECODE(A.EDU_RCMD_YN,'Y','추천','N','비추천') AS EDU_RCMD_YN,
			       A.SRCH_CNT
			  FROM TBCSPSAE903M A
			  WHERE 1=1
		]]>
		<dynamic>
			 <isNotEmpty property="strYR_CD">
		     	AND SUBSTR(A.FRT_REGI_DH,1,4) = #strYR_CD#
		     </isNotEmpty>
		     <isNotEmpty property="strEDU_RCMD_YN">
		     	AND A.EDU_RCMD_YN = #strEDU_RCMD_YN#
		     </isNotEmpty>
		     <isNotEmpty property="strORG_CD">
		     	AND A.ORG_CD = #strORG_CD#
		     </isNotEmpty>
	     </dynamic>
		<![CDATA[
		  ORDER BY TO_NUMBER(A.SNO)
		  ) T ORDER BY NUM DESC
		]]>
	</select>
	
</sqlMap> 
