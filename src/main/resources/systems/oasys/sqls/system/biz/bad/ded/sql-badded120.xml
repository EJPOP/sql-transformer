<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="bad/ded/120">
	<!-- 감사사항목록을 조회한다.  -->
	<select id="BADDED120EMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[       
			SELECT AUD_YR
			     , AUD_NO
			     , AUD_SBJ_NM
			     , SPV_BRDV_CD
			     , SPV_BRDV_NM
			     , RSV_INSPC_LUNH_DT
			     , HNDL_DDLN_DT
			     , FLD_AUD_STR_DT
			     , FLD_AUD_END_DT
			     , FLD_AUD_EXEC_DCN
			     , RTN_DT
			     , RPT_DDLN_DT
			     , CHF_CMTR_CNB
			     , CHF_CMTR_NM
			     , SBCN_DT
			     , AUD_EXEC_HNDL_STA_CD
			     , FLD_EXTN_STR_DT
			     , FLD_EXTN_END_DT
			     , DTL_AUD_NO
			     , AUD_KND_CD
			     , AUD_KND_NM
			     , EXTN_PRD_COFM_DT
			     , GNR_HNDL_PLAN_YN
			     , HNDL_SITU_HIS
			     , STT_RMK
			     , MDF_YN
			     , INDC_NOC
			     , DELAY_CNT
			     , HNDL_STATUS
			     , RTN_RPT_DT
			     , DIFF_REPORT
			     , CASE WHEN DIFF_REPORT = '-' THEN '-' 
			            WHEN DIFF_REPORT > 0 THEN '경고' 
			            ELSE '' 
			        END AS DIFF_REPORT_STATUS
			     , BRDV_HNDL_DDLN_DT
			     , AUD_BRDV_APV_DT
			     , DIFF_BRDV
			     , CASE WHEN DIFF_BRDV = '-' THEN '-' 
			            WHEN DIFF_BRDV > 0 THEN '경고' 
			            ELSE '' 
			        END AS DIFF_BRDV_STATUS
			     , RVW_RM_APV_DDLN_DT
			     , JA_JDG_SSEC_APV_DT
			     , DIFF_RVW_RM
			     , CASE WHEN DIFF_RVW_RM = '-' THEN '-' 
			            WHEN DIFF_RVW_RM > 0 THEN '경고' 
			            ELSE '' 
			        END AS DIFF_RVW_RM_STATUS
			     , TOT_DHD_APV_DDLN_DT
			     , OW_DHD_APV_DT
			     , DIFF_TOT_DHD
			     , CASE WHEN DIFF_TOT_DHD = '-' THEN '-' 
			            WHEN DIFF_TOT_DHD > 0 THEN '경고' 
			            ELSE '' 
			        END AS DIFF_TOT_DHD_STATUS
			     , CHF_CMTR_APV_DDLN_DT
			     , CHF_CMTR_APV_DT
			     , DIFF_CHF_CMTR
			     , CASE WHEN DIFF_CHF_CMTR = '-' THEN '-' 
			            WHEN DIFF_CHF_CMTR > 0 THEN '경고' 
			            ELSE '' 
			        END AS DIFF_CHF_CMTR_STATUS
			     , ENF_APV_DDLN_DT
			     , ENF_APV_DT
			     , DIFF_ENF
			     , CASE WHEN DIFF_ENF = '-' THEN '-' 
			            WHEN DIFF_ENF > 0 THEN '경고' 
			            ELSE '' 
			        END AS DIFF_ENF_STATUS
			     , DIFF_HNDL
			     , FLD_AUD_DT
			     , AUD_YR_NO 
			     , CASE WHEN TO_CHAR(DECODE(DIFF_ENF,'-',0,DIFF_ENF)) <> '-' THEN  DIFF_ENF
			            WHEN TO_CHAR(DECODE(DIFF_CHF_CMTR,'-',0,DIFF_CHF_CMTR)) <> '-' THEN  DIFF_CHF_CMTR
			            WHEN TO_CHAR(DECODE(DIFF_TOT_DHD,'-',0,DIFF_TOT_DHD)) <> '-' THEN  DIFF_TOT_DHD
			            WHEN TO_CHAR(DECODE(DIFF_RVW_RM,'-',0,DIFF_RVW_RM)) <> '-' THEN  DIFF_RVW_RM
			            WHEN TO_CHAR(DECODE(DIFF_BRDV,'-',0,DIFF_BRDV)) <> '-' THEN  DIFF_BRDV
			            WHEN TO_CHAR(DECODE(DIFF_REPORT,'-',0,DIFF_REPORT)) <> '-' THEN  DIFF_REPORT
			         END AS SUM_DIFF     
			    , DOC_YN	
			    , DLAY_RSN_TXT	     
			  FROM 
			  ( 
			
			SELECT B.AUD_YR                         AS AUD_YR               /*감사년도*/
			     , B.AUD_NO                         AS AUD_NO               /*감사순번*/
			     , B.AUD_YR  ||'-'||  B.AUD_NO      AS AUD_YR_NO            /*연번호*/
			     , F_MNG_KND_AUDYRNO(B.AUD_YR, B.AUD_NO, B.AUD_KND_CD, '-') ||' ('|| F_CODE_NM('1000007',B.AUD_KND_CD)  ||')' ||B.AUD_SBJ_NM                     AS AUD_SBJ_NM           /*감사사항명*/
			     , B.MNG_DPT_CD                     AS SPV_BRDV_CD          /*주관부서코드*/
			     , F_DPT_INFO(B.MNG_DPT_CD ,'1')    AS SPV_BRDV_NM          /*주관부서명*/
			     , A.RSV_INSPC_LUNH_DT              AS RSV_INSPC_LUNH_DT    /*예비조사착수일*/
			     , A.HNDL_DDLN_DT                   AS HNDL_DDLN_DT         /*처리기한일*/
			     , A.FLD_AUD_STR_DT                 AS FLD_AUD_STR_DT       /*실지감사시작일*/
			     , A.FLD_AUD_END_DT                 AS FLD_AUD_END_DT       /*실지감사 종료일*/
			     , A.FLD_AUD_EXEC_DCN               AS FLD_AUD_EXEC_DCN     /* 실시기간*/
			     , TO_CHAR(TO_DATE(A.FLD_AUD_STR_DT),'YYYY-MM-DD')||'-'||TO_CHAR(TO_DATE(A.FLD_AUD_END_DT),'YYYY-MM-DD') ||'('||A.FLD_AUD_EXEC_DCN ||')' AS FLD_AUD_DT
			     , A.RTN_DT                         AS RTN_DT               /*귀청일자*/
			     , A.RPT_DDLN_DT                    AS RPT_DDLN_DT          /*보고기한일*/
			     , A.CHF_CMTR_CNB                   AS CHF_CMTR_CNB         /*주심위원전산번호*/  
			     , F_USR_INFO(A.CHF_CMTR_CNB,'2')   AS CHF_CMTR_NM          /*주심위원성명*/
			     , A.SBCN_DT                        AS SBCN_DT              /*부의일*/
			     , A.AUD_EXEC_HNDL_STA_CD           AS AUD_EXEC_HNDL_STA_CD /*감사실시처리상태코드*/
			     , FLD_EXTN_STR_DT                  AS FLD_EXTN_STR_DT      /*실지연장시작일(AS-IS때는 없던 컬럼 TO-BE부터 관리)*/
			     , FLD_EXTN_END_DT                  AS FLD_EXTN_END_DT      /*실지연장종료일(AS-IS때는 없던 컬럼 TO-BE부터 관리)*/
			     , SUBSTR(B.AUD_YR, 3, 2) || '-' || SUBSTR(B.AUD_TASK_CD,-1) ||'-'|| B.ORG_DVSN_CD || '-' || SUBSTR(B.AUD_KND_CD, 3, 1) ||B.SPV_BRDV_CD || '-' || SUBSTR(B.AUD_WAY_CD,-1)||'-' || B.AUD_NO ||'-' 
			       ||(SELECT MAX(C.AUD_STEP_SNO)
			            FROM TBBADDED002M C
			           WHERE B.AUD_YR = C.REL_AUD_YR
			             AND B.AUD_NO = C.REL_AUD_NO) AS DTL_AUD_NO         /*세부연번호*/
			     , B.AUD_KND_CD                       AS AUD_KND_CD          /*감사종류코드*/
			     , F_CODE_NM('1000007',B.AUD_KND_CD)  AS AUD_KND_NM          /*감사종류명*/
			     , EXTN_PRD_COFM_DT                 AS EXTN_PRD_COFM_DT     /*연장기간승인일*/
			     , GNR_HNDL_PLAN_YN                 AS GNR_HNDL_PLAN_YN     /*종합처리안여부*/
			     , HNDL_SITU_HIS                    AS HNDL_SITU_HIS        /*처리현황내역*/
			     , STT_RMK                          AS STT_RMK              /*상황비고*/
			     , MDF_YN                           AS MDF_YN               /*수정여부*/
			     , INDC_NOC                         AS INDC_NOC             /*지적건수*/
				 ,CASE 
				         WHEN trim(A.ENF_APV_DT)         IS NOT NULL THEN '-'  /*시행결재일자가 있으면 지연일수 없음*/
				         WHEN trim(A.CHF_CMTR_APV_DT)    IS NOT NULL THEN to_char(to_date(sysdate)-to_date(A.ENF_APV_DDLN_DT)) 
				         WHEN trim(A.OW_DHD_APV_DT)      IS NOT NULL THEN to_char(to_date(sysdate)-to_date(A.CHF_CMTR_APV_DDLN_DT)) 
				         WHEN trim(A.JA_JDG_SSEC_APV_DT) IS NOT NULL THEN to_char(to_date(sysdate)-to_date(A.TOT_DHD_APV_DDLN_DT)) 
				         WHEN trim(A.AUD_BRDV_APV_DT)    IS NOT NULL THEN to_char(to_date(sysdate)-to_date(A.RVW_RM_APV_DDLN_DT))
				         WHEN trim(A.RTN_RPT_DT)         IS NOT NULL THEN to_char(to_date(sysdate)-to_date(A.BRDV_HNDL_DDLN_DT))
				         WHEN trim(A.RTN_RPT_DT)         IS NULL THEN to_char(to_date(sysdate)-to_date(A.RPT_DDLN_DT))
				         ELSE '-'
				    END delay_cnt  /*지연일수*/ 
			
			        /*성과평가 지연일수 구하기
			
			         ,CASE WHEN A.ENF_APV_DT         IS NOT NULL THEN TO_CHAR(TO_DATE(A.ENF_APV_DT)          - TO_DATE(A.CHF_CMTR_APV_DT)      - 0) 성과평가에서 시행의 기준일수는 0으로 셋팅
			
			               WHEN A.CHF_CMTR_APV_DT    IS NOT NULL THEN TO_CHAR(TO_DATE(A.CHF_CMTR_APV_DT)     - TO_DATE(A.OW_DHD_APV_DT)        - 0) 성과평가에서 주심위원의 기준일수는 0으로 셋팅
			
			               WHEN A.OW_DHD_APV_DT      IS NOT NULL THEN TO_CHAR(TO_DATE(A.OW_DHD_APV_DT)       - TO_DATE(A.JA_JDG_SSEC_APV_DT)   - F_DDLN_DCN(AUD.AUD_YR, AUD.AUD_NO,'08'))
			
			               WHEN A.JA_JDG_SSEC_APV_DT IS NOT NULL THEN TO_CHAR(TO_DATE(A.JA_JDG_SSEC_APV_DT)  - TO_DATE(A.MDT_DDG_APV_DT)       - F_DDLN_DCN(AUD.AUD_YR, AUD.AUD_NO,'07'))
			
			               WHEN A.MDT_DDG_APV_DT     IS NOT NULL THEN TO_CHAR(TO_DATE(A.MDT_DDG_APV_DT)      - TO_DATE(A.MDT_OFER_APV_DT)      - F_DDLN_DCN(AUD.AUD_YR, AUD.AUD_NO,'06'))
			
			               WHEN A.MDT_OFER_APV_DT    IS NOT NULL THEN TO_CHAR(TO_DATE(A.MDT_OFER_APV_DT)     - TO_DATE(A.AUD_BRDV_APV_DT)      - F_DDLN_DCN(AUD.AUD_YR, AUD.AUD_NO,'05'))
			
			               WHEN A.AUD_BRDV_APV_DT    IS NOT NULL THEN TO_CHAR(TO_DATE(A.AUD_BRDV_APV_DT)     - TO_DATE(A.RTN_RPT_DT)           - F_DDLN_DCN(AUD.AUD_YR, AUD.AUD_NO,'04'))
			
			               WHEN A.RTN_RPT_DT         IS NOT NULL THEN TO_CHAR(TO_DATE(A.RTN_RPT_DT)          - TO_DATE(A.FLD_AUD_END_DT)       - F_DDLN_DCN(AUD.AUD_YR, AUD.AUD_NO,'03'))
			
			         ELSE NULL
			
			            END DELAY_CNT 현단계지연일수*/
			        
			     , CASE WHEN (A.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(A.RTN_DT) > TO_DATE(SYSDATE))                         THEN '감사중'
			            WHEN (A.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(A.HNDL_DDLN_DT) IS NULL) OR A.AUD_EXEC_HNDL_STA_CD = '3' THEN '처리중'
			            WHEN A.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(A.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE)      THEN '처리기한경과'
			            WHEN A.AUD_EXEC_HNDL_STA_CD = '3'                                                                    THEN '보류'
			            WHEN A.AUD_EXEC_HNDL_STA_CD = '9'                                                                    THEN '종료'
			            ELSE '처리중'
			        END HNDL_STATUS /*처리상태*/
			        
			        
			     , RTN_RPT_DT /*귀청보고결재일*/
			     , CASE
			         WHEN TRIM(RTN_RPT_DT) IS NOT NULL THEN /*귀청보고일이 있는 경우*/
			       CASE
			           WHEN TRIM(RPT_DDLN_DT) IS NULL THEN '0'
			           ELSE TO_CHAR(TO_DATE(RTN_RPT_DT) - TO_DATE(RPT_DDLN_DT))
			         END
			         ELSE CASE
			           WHEN TRIM(RPT_DDLN_DT) IS NULL THEN '0'
			           ELSE TO_CHAR(TO_DATE(SYSDATE) - TO_DATE(RPT_DDLN_DT))
			         END
			       END DIFF_REPORT /*귀청보고지연일수*/
			
			     , BRDV_HNDL_DDLN_DT /*감사국과기한일*/
			     , AUD_BRDV_APV_DT /*감사국과결재일*/      
			     , CASE
			         WHEN TRIM(RTN_RPT_DT) IS NOT NULL AND TRIM(BRDV_HNDL_DDLN_DT) IS NOT NULL
			         THEN /*귀청보고일이 있는 */
			              CASE WHEN TRIM(AUD_BRDV_APV_DT) IS NULL 
			                   THEN TO_CHAR(TO_DATE(SYSDATE) - TO_DATE(BRDV_HNDL_DDLN_DT))
			                   ELSE TO_CHAR(TO_DATE(AUD_BRDV_APV_DT) - TO_DATE(BRDV_HNDL_DDLN_DT))
			               END
			         ELSE '-'
			        END DIFF_BRDV /*감사국과지연일수*/
			     , RVW_RM_APV_DDLN_DT /*심의실장기한일*/
			     , JA_JDG_SSEC_APV_DT /*법무심사관결재일(심의실장) */     
			     , CASE                                                                                                                  			                                                                           
			         WHEN TRIM(AUD_BRDV_APV_DT) IS NOT NULL AND TRIM(RVW_RM_APV_DDLN_DT) IS NOT NULL THEN /*조정담당관결재일이 있는 경우*/
			       CASE                                                                                                                  
			           WHEN TRIM(JA_JDG_SSEC_APV_DT) IS NULL THEN TO_CHAR(TO_DATE(SYSDATE) - TO_DATE(RVW_RM_APV_DDLN_DT))                 
			           ELSE TO_CHAR(TO_DATE(JA_JDG_SSEC_APV_DT) - TO_DATE(RVW_RM_APV_DDLN_DT))                                           
			         END                                                                                                                 
			         ELSE '-'                                                                                                            
			       END DIFF_RVW_RM /*심의실장지연일수*/  
			       
			       
			     ,TOT_DHD_APV_DDLN_DT /*총차장기한일*/
			     ,OW_DHD_APV_DT /*사무차장결재일*/
			     ,CASE
			         WHEN TRIM(JA_JDG_SSEC_APV_DT) IS NOT NULL AND TRIM(TOT_DHD_APV_DDLN_DT) IS NOT NULL THEN /*법무심사관(심의실장)결재일이 있는 경우*/
			       CASE
			           WHEN TRIM(OW_DHD_APV_DT) IS NULL THEN TO_CHAR(TO_DATE(SYSDATE) - TO_DATE(TOT_DHD_APV_DDLN_DT))
			           ELSE TO_CHAR(TO_DATE(OW_DHD_APV_DT) - TO_DATE(TOT_DHD_APV_DDLN_DT))
			         END
			         ELSE '-'
			       END DIFF_TOT_DHD /*총차장지연일수*/
			     ,CHF_CMTR_APV_DDLN_DT /*주심위원기한일*/
			     ,CHF_CMTR_APV_DT /*주심위원결재일*/
			     ,CASE
			         WHEN TRIM(OW_DHD_APV_DT) IS NOT NULL AND TRIM(CHF_CMTR_APV_DDLN_DT) IS NOT NULL THEN /*사무차장결재일이 있는경우*/
			       CASE
			           WHEN TRIM(CHF_CMTR_APV_DT) IS NULL THEN TO_CHAR(TO_DATE(SYSDATE) - TO_DATE(CHF_CMTR_APV_DDLN_DT))
			           ELSE TO_CHAR(TO_DATE(CHF_CMTR_APV_DT) - TO_DATE(CHF_CMTR_APV_DDLN_DT))
			         END
			         ELSE '-'
			       END DIFF_CHF_CMTR /*주심위원지연일수*/
			     ,ENF_APV_DDLN_DT /*시행기한일*/
			     ,ENF_APV_DT /*시행결재일*/
			     ,CASE
			         WHEN TRIM(CHF_CMTR_APV_DT) IS NOT NULL THEN /*주심위원결재일이 있는 경우*/
			       CASE
			           WHEN TRIM(ENF_APV_DT) IS NULL THEN CASE
			             WHEN TRIM(ENF_APV_DDLN_DT) IS NULL THEN '0'
			             ELSE TO_CHAR(TO_DATE(SYSDATE) - TO_DATE(ENF_APV_DDLN_DT))
			           END
			           ELSE CASE
			             WHEN TRIM(ENF_APV_DDLN_DT) IS NULL THEN '0'
			             ELSE TO_CHAR(TO_DATE(ENF_APV_DT) - TO_DATE(ENF_APV_DDLN_DT))
			           END
			         END
			         ELSE '-'
			       END DIFF_ENF /*시행지연일수*/
			     ,CASE
			         WHEN TRIM(ENF_APV_DT) IS NOT NULL THEN /*시행결재일이 있는 경우*/
			       TO_CHAR(TO_DATE(ENF_APV_DT) - TO_DATE(HNDL_DDLN_DT))
			         ELSE CASE
			           WHEN TRIM(HNDL_DDLN_DT) IS NULL THEN '0'
			           ELSE TO_CHAR(TO_DATE(SYSDATE) - TO_DATE(HNDL_DDLN_DT))
			         END
			       END DIFF_HNDL /*처리기한지연일수*/
			   , DECODE(C.AUD_YR,NULL,'N','Y') DOC_YN  
			   , A.DLAY_RSN_TXT    
			  FROM TBBADDED003M A
			     ,TBBADDED001M B
			  , (
                SELECT AUD_YR
                        , AUD_NO 
                  FROM TBBADDED021M 
                  WHERE 1=1
                    AND DOC_TYP_CD = 'AD-AR-003' /*귀청보고서*/
                 GROUP BY AUD_YR
                        , AUD_NO 
               ) C 
			 WHERE 1=1
			   AND B.BZT_BGT_DVSN_CD = '1'    /* 확인출장(실국배정)은 제외 - 2015.04.28 yyh, 실국배정 조건 로직 변경(AUD_KND_CD 에서 BZT_BGT_DVSN_CD 로) - 2016.09.29 yyh */
			   AND A.AUD_YR(+) = B.AUD_YR
			   AND A.AUD_NO(+) = B.AUD_NO
	           AND B.AUD_NO  = C.AUD_NO(+)
	           AND B.AUD_YR  = C.AUD_YR(+)
               AND B.MNG_DPT_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#)))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/
		]]>
		<isNotEmpty property="strAudYrSt">	 
			<![CDATA[
			   AND A.AUD_YR           >= #strAudYrSt#
			]]>
		</isNotEmpty>
		<isNotEmpty property="strAudYrEnd">	 
			<![CDATA[
			   AND A.AUD_YR           <= #strAudYrEnd#
			]]>
		</isNotEmpty>		
		<isNotEmpty property="strAudGrnNoSt">	 
			<![CDATA[
			   AND B.AUD_GRN_NO           >= #strAudGrnNoSt#
			]]>
		</isNotEmpty>		
		<isNotEmpty property="strAudGrnNoEnd">	 
			<![CDATA[
			   AND B.AUD_GRN_NO           <= #strAudGrnNoEnd#
			]]>
		</isNotEmpty>				
		<isNotEmpty property="strSpvBrdvCd">	 
			   AND B.MNG_DPT_CD       = #strSpvBrdvCd#
		</isNotEmpty>		
		<isNotEmpty property="strAudSbjNm">	 
			   AND B.AUD_SBJ_NM       LIKE  '%'||#strAudSbjNm#||'%'
		</isNotEmpty>	
		<isNotEmpty property="strHndlStatus">	
			<isNotEqual property="strHndlStatus" compareValue="6">	
				<![CDATA[
				   AND  ( CASE WHEN (A.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(A.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
				            WHEN ((A.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(A.HNDL_DDLN_DT) IS NULL) OR A.AUD_EXEC_HNDL_STA_CD = '3') OR (A.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(A.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
				            WHEN A.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(A.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
				            WHEN A.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
				            WHEN A.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
				            ELSE '8'
				        END )  = #strHndlStatus#
				]]>
			</isNotEqual>	
			<isEqual property="strHndlStatus" compareValue="6"> 
				<![CDATA[
				   /*처리기한 경과*/
			       AND  (A.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(A.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE)) 
				]]>
			</isEqual>	
		</isNotEmpty>

		/* 
			감사연번종류코드 추가 - 2015.12.22 yyh 
			감사연번종류코드 FROM ~ TO 에서 한개로 변경 - 2016.05.30 yyh 
		*/		
		<isNotNull property="strAudYrNoKndCdSt">
			<isNotEmpty property="strAudYrNoKndCdSt">
                AND SUBSTR(B.AUD_KND_CD,3,1) = #strAudYrNoKndCdSt# 
            </isNotEmpty> 
		</isNotNull>

        <![CDATA[       
			   ) ORDER BY AUD_YR DESC, AUD_NO 
        ]]>
	</select>


	<!-- 변경을 저장한다.  -->
	<update id="BADDED120EMainUpdate" parameterClass="paramMap">
		<![CDATA[ 	
			UPDATE TBBADDED003M
			   SET AUD_YR                = #AUD_YR# 
			     , AUD_NO                = #AUD_NO# 	
		]]>	    
		<isNotNull prepend="," property="RSV_INSPC_LUNH_DT">
			   	   RSV_INSPC_LUNH_DT            = #RSV_INSPC_LUNH_DT#
		</isNotNull>
		<isNotNull prepend="," property="HNDL_DDLN_DT">
			   	   HNDL_DDLN_DT            = #HNDL_DDLN_DT#
		</isNotNull>
		<isNotNull prepend="," property="FLD_AUD_STR_DT">
			   	   FLD_AUD_STR_DT            = #FLD_AUD_STR_DT#
		</isNotNull>
		<isNotNull prepend="," property="FLD_AUD_END_DT">
			   	   FLD_AUD_END_DT            = #FLD_AUD_END_DT#
		</isNotNull>
		<isNotNull prepend="," property="FLD_AUD_EXEC_DCN">
			   	   FLD_AUD_EXEC_DCN            = #FLD_AUD_EXEC_DCN#
		</isNotNull>
		<isNotNull prepend="," property="RTN_DT">
			   	   RTN_DT            = #RTN_DT#
		</isNotNull>
		<isNotNull prepend="," property="RTN_RPT_DT">
			   	   RTN_RPT_DT            = #RTN_RPT_DT#
		</isNotNull>
		<isNotNull prepend="," property="RPT_DDLN_DT">
			   	   RPT_DDLN_DT            = #RPT_DDLN_DT#
		</isNotNull>
		<isNotNull prepend="," property="AUD_BRDV_APV_DT">
			   	   AUD_BRDV_APV_DT            = #AUD_BRDV_APV_DT#
		</isNotNull>
		<isNotNull prepend="," property="MDT_OFER_APV_DT">
			   	   MDT_OFER_APV_DT            = #MDT_OFER_APV_DT#
		</isNotNull>
		<isNotNull prepend="," property="MDT_DDG_APV_DT">
			   	   MDT_DDG_APV_DT            = #MDT_DDG_APV_DT#
		</isNotNull>
		<isNotNull prepend="," property="JA_JDG_SSEC_APV_DT">
			   	   JA_JDG_SSEC_APV_DT            = #JA_JDG_SSEC_APV_DT#
		</isNotNull>
		<isNotNull prepend="," property="OW_DHD_APV_DT">
			   	   OW_DHD_APV_DT            = #OW_DHD_APV_DT#
		</isNotNull>
		<isNotNull prepend="," property="OW_PSD_APV_DT">
			   	   OW_PSD_APV_DT            = #OW_PSD_APV_DT#
		</isNotNull>
		<isNotNull prepend="," property="ENF_APV_DT">
			   	   ENF_APV_DT            = #ENF_APV_DT#
		</isNotNull>
		<isNotNull prepend="," property="CHF_CMTR_CNB">
			   	   CHF_CMTR_CNB            = #CHF_CMTR_CNB#
		</isNotNull>
		<isNotNull prepend="," property="SBCN_DT">
			   	   SBCN_DT            = #SBCN_DT#
		</isNotNull>
		<isNotNull prepend="," property="AUD_EXEC_HNDL_STA_CD">
			   	   AUD_EXEC_HNDL_STA_CD            = #AUD_EXEC_HNDL_STA_CD#
		</isNotNull>
		<isNotNull prepend="," property="HNDL_SITU_HIS">
			   	   HNDL_SITU_HIS            = #HNDL_SITU_HIS#
		</isNotNull>
		<isNotNull prepend="," property="RTN_RPT_NOC">
			   	   RTN_RPT_NOC            = #RTN_RPT_NOC#
		</isNotNull>
		<isNotNull prepend="," property="TRTM_SBCN_NOC">
			   	   TRTM_SBCN_NOC            = #TRTM_SBCN_NOC#
		</isNotNull>
		<isNotNull prepend="," property="TRTM_DLG_NOC">
			   	   TRTM_DLG_NOC            = #TRTM_DLG_NOC#
		</isNotNull>
		<isNotNull prepend="," property="CMT_SBCN_NOC">
			   	   CMT_SBCN_NOC            = #CMT_SBCN_NOC#
		</isNotNull>
		<isNotNull prepend="," property="STT_RMK">
			   	   STT_RMK            = #STT_RMK#
		</isNotNull>
		<isNotNull prepend="," property="MDF_YN">
			   	   MDF_YN            = #MDF_YN#
		</isNotNull>
		<isNotNull prepend="," property="BRDV_HNDL_DDLN_DT">
			   	   BRDV_HNDL_DDLN_DT            = #BRDV_HNDL_DDLN_DT#
		</isNotNull>
		<isNotNull prepend="," property="MDT_CHGR_APV_DDLN_DT">
			   	   MDT_CHGR_APV_DDLN_DT            = #MDT_CHGR_APV_DDLN_DT#
		</isNotNull>
		<isNotNull prepend="," property="INDC_NOC">
			   	   INDC_NOC            = #INDC_NOC#
		</isNotNull>
		<isNotNull prepend="," property="GNR_HNDL_PLAN_YN">
			   	   GNR_HNDL_PLAN_YN            = #GNR_HNDL_PLAN_YN#
		</isNotNull>
		<isNotNull prepend="," property="EXTN_PRD_COFM_DT">
			   	   EXTN_PRD_COFM_DT         = #EXTN_PRD_COFM_DT#
		</isNotNull>
		<isNotNull prepend="," property="MDT_OFER_APV_DDLN_DT">
			   	   MDT_OFER_APV_DDLN_DT            = #MDT_OFER_APV_DDLN_DT#
		</isNotNull>
		<isNotNull prepend="," property="TOT_DHD_APV_DDLN_DT">
			   	   TOT_DHD_APV_DDLN_DT            = #TOT_DHD_APV_DDLN_DT#
		</isNotNull>
		<isNotNull prepend="," property="CHF_CMTR_APV_DDLN_DT">
			   	   CHF_CMTR_APV_DDLN_DT            = #CHF_CMTR_APV_DDLN_DT#
		</isNotNull>
		<isNotNull prepend="," property="CHF_CMTR_APV_DT">
			   	   CHF_CMTR_APV_DT            = #CHF_CMTR_APV_DT#
		</isNotNull>		
		<isNotNull prepend="," property="ENF_APV_DDLN_DT">
			   	   ENF_APV_DDLN_DT            = #ENF_APV_DDLN_DT#
		</isNotNull>
		<isNotNull prepend="," property="FLD_EXTN_STR_DT">
			   	   FLD_EXTN_STR_DT            = #FLD_EXTN_STR_DT#
		</isNotNull>
		<isNotNull prepend="," property="RSV_INSPC_LUNH_DT">
			   	   FLD_EXTN_END_DT            = #FLD_EXTN_END_DT#
		</isNotNull>
		<isNotNull prepend="," property="FNL_USR_ID">	       
			     FNL_USR_ID                 = #FNL_USR_ID#
		</isNotNull>	
		<isNotNull prepend="," property="FNL_DEAL_DPT_CD">	       
			     FNL_DEAL_DPT_CD                 = #FNL_DEAL_DPT_CD#
		</isNotNull>		
		<isNotNull prepend="," property="FNL_MNU_ID">	       
			     FNL_MNU_ID                 = #FNL_MNU_ID#
		</isNotNull>
				  , FNL_MDF_DH              = SYSDATE						
			  WHERE 1=1
				AND AUD_YR = #AUD_YR# 
			    AND AUD_NO = #AUD_NO#    	
	</update>


	<select id="BADDED120EDdlnDtSelect" parameterClass="paramMap"
		resultClass="resultMap">       
        <![CDATA[  
			SELECT  AUD_YR
			      , AUD_NO 
			      , TO_CHAR(TO_DATE(RTN_DT) + NVL(F_DDLN_ACC_DCN(AUD_YR ,AUD_NO,'03'),0),'YYYYMMDD')	                                                             /*귀청보고*/       RPT_DDLN_DT
			      , TO_CHAR(TO_DATE(RTN_DT) + NVL(F_DDLN_ACC_DCN(AUD_YR ,AUD_NO,'04'),0) + NVL(EXTN_PRD_COFM_DT,0) + DECODE(GNR_HNDL_PLAN_YN,'Y',5,0),'YYYYMMDD')	 /*과장(감사국과)*/  BRDV_HNDL_DDLN_DT
			      , TO_CHAR(TO_DATE(RTN_DT) + NVL(F_DDLN_ACC_DCN(AUD_YR ,AUD_NO,'07'),0) + NVL(EXTN_PRD_COFM_DT,0) + DECODE(GNR_HNDL_PLAN_YN,'Y',5,0),'YYYYMMDD')	 /*국장(심의실장)*/ RVW_RM_APV_DDLN_DT
			      , TO_CHAR(TO_DATE(RTN_DT) + NVL(F_DDLN_ACC_DCN(AUD_YR ,AUD_NO,'08'),0) + NVL(EXTN_PRD_COFM_DT,0) + DECODE(GNR_HNDL_PLAN_YN,'Y',5,0),'YYYYMMDD')	 /*총차장*/        TOT_DHD_APV_DDLN_DT
			      , TO_CHAR(TO_DATE(RTN_DT) + NVL(F_DDLN_ACC_DCN(AUD_YR ,AUD_NO,'09'),0) + NVL(EXTN_PRD_COFM_DT,0) + DECODE(GNR_HNDL_PLAN_YN,'Y',5,0),'YYYYMMDD')	 /*주심위원*/       CHF_CMTR_APV_DDLN_DT
			      , TO_CHAR(TO_DATE(RTN_DT) + NVL(F_DDLN_ACC_DCN(AUD_YR ,AUD_NO,'10'),0) + NVL(EXTN_PRD_COFM_DT,0) + DECODE(GNR_HNDL_PLAN_YN,'Y',5,0),'YYYYMMDD')	 /*시행*/          ENF_APV_DDLN_DT           
			  FROM TBBADDED003M
			 WHERE 1=1
			   AND AUD_YR = #AUD_YR# 
			   AND AUD_NO = #AUD_NO#    
		]]>
	</select>			

	<!-- 기준일자를 재계산해서 업데이트 한다.   -->
	<update id="BADDED120EDdlnDtUpdate" parameterClass="paramMap">
		<![CDATA[ 	
			UPDATE TBBADDED003M SET
				      /*귀청보고*/	    RPT_DDLN_DT		  		= #RPT_DDLN_DT#	
					, /*과장(감사국과)*/	BRDV_HNDL_DDLN_DT		= #BRDV_HNDL_DDLN_DT#		
					, /*국장(심의실장)*/	RVW_RM_APV_DDLN_DT		= #RVW_RM_APV_DDLN_DT#	
					, /*총차장*/	        TOT_DHD_APV_DDLN_DT	    = #TOT_DHD_APV_DDLN_DT#	
					, /*주심위원*/       CHF_CMTR_APV_DDLN_DT    = #CHF_CMTR_APV_DDLN_DT#	  	   
			   	    , /*시행*/          ENF_APV_DDLN_DT			= #ENF_APV_DDLN_DT#	
			   	    , /*처리기한일*/     HNDL_DDLN_DT 			= #ENF_APV_DDLN_DT#	
			  WHERE 1=1
				AND AUD_YR = #AUD_YR# 
			    AND AUD_NO = #AUD_NO#    
		]]>
	</update>
	
	<!-- 진행상태 항목을 업데이트 한다. 2016.10.04 yyh -->
	<update id="BADDED120EPrssStepUpdate" parameterClass="paramMap">
		<![CDATA[ 	
		      
		      UPDATE TBBADDED001M
		         SET PRSS_STEP_CD =  (SELECT  /*실국배정은 NULL로 표기 2015.05.18 yyh*/
                                            CASE WHEN D1.BZT_BGT_DVSN_CD != '1'      THEN '' 
                                                 WHEN D3.AUD_EXEC_HNDL_STA_CD = '9'  THEN '10' /* 국과별처리현황에 감사실시처리상태코드가 종료(9)면 감사실시처리상태코드를 종료(10)으로- 2015.05.20 yyh*/
                                             
                                            /*실국배정 이외 */
                                            ELSE 
                                          
                                                CASE WHEN TRIM(D3.ENF_APV_DT)         IS NOT NULL THEN '10'  /*종료*/
                                                     WHEN TRIM(D3.CHF_CMTR_APV_DT)    IS NOT NULL THEN '09'  /*주심위원*/
                                                     WHEN TRIM(D3.OW_DHD_APV_DT)      IS NOT NULL THEN '08'  /*총차장*/
                                                     WHEN TRIM(D3.JA_JDG_SSEC_APV_DT) IS NOT NULL THEN '07'  /*심의실장*/
                                                     WHEN TRIM(D3.MDT_DDG_APV_DT)     IS NOT NULL THEN '06'  /*조정담당관*/
                                                     WHEN TRIM(D3.MDT_OFER_APV_DT)    IS NOT NULL THEN '05'  /*조정담당자*/
                                                     WHEN TRIM(D3.AUD_BRDV_APV_DT)    IS NOT NULL THEN '04'  /*감사국과*/
                                                     WHEN TRIM(D3.RTN_RPT_DT)         IS NOT NULL THEN '03'  /*귀청보고*/
                                                 
                                                 ELSE 
                                                     /* 실지감사중을 출장단계과 귀청보고 준비중으로 분리함 - 2015.05.15 yyh*/				       
                                                    (CASE 
                                                          WHEN 
                                                          (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                ELSE '8'
                                                            END) = '8' AND D3.RTN_RPT_DT IS NULL AND D3.FLD_AUD_END_DT IS NULL THEN '02'    /*출장단계*/
                                                                                        
                                                          WHEN 
                                                          (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                ELSE '8'
                                                            END) = '8' AND D3.RTN_RPT_DT IS NULL     THEN '11'    /*귀청보고준비중*/
                                                          
                                                          WHEN      
                                                          (CASE WHEN (D3.AUD_EXEC_HNDL_STA_CD = '1' AND TO_DATE(D3.RTN_DT) > TO_DATE(SYSDATE)) THEN '7'
                                                                WHEN ((D3.AUD_EXEC_HNDL_STA_CD = '1' AND TRIM(D3.HNDL_DDLN_DT) IS NULL) OR D3.AUD_EXEC_HNDL_STA_CD = '3') OR (D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) )THEN '8'
                                                                WHEN D3.AUD_EXEC_HNDL_STA_CD = '1'AND NVL(TO_DATE(D3.HNDL_DDLN_DT),'99991231') < TO_DATE(SYSDATE) THEN '6'
                                                                WHEN D3.AUD_EXEC_HNDL_STA_CD = '3' THEN '3'
                                                                WHEN D3.AUD_EXEC_HNDL_STA_CD = '9' THEN '9'
                                                                ELSE '8'
                                                            END) = '7' THEN '02'    /*출장단계*/
                                                      END) 				                 
                                                 END 	
                                          END               PRSS_STEP_CD     /*진행단계코드*/         
                                          
                                       	       		   		         
                                     FROM TBBADDED001M D1
                                        , TBBADDED003M D3
                                     WHERE 1=1
                                      AND D1.AUD_YR = D3.AUD_YR(+)
                                      AND D1.AUD_NO = D3.AUD_NO(+)
                                      AND D1.AUD_YR = #AUD_YR#
                                      AND D1.AUD_NO = #AUD_NO#
                    )
             WHERE AUD_YR = #AUD_YR#
               AND AUD_NO = #AUD_NO#
               
		]]>
	</update>	
</sqlMap> 

