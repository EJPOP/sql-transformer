<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/ded/048">

	<select id="badded048EAppCostselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
        SELECT A.BZT_SRNO             /* 춟장순번 */
             , A.BZT_DVSN_CD          /* 출장구분코드 */
             , F_CODE_NM('1000031',A.BZT_DVSN_CD)  AS BZT_DVSN_NM /* 츌장구분명 */
             , A.STAD_STR_DT          /* 기준시작일자 */
             , A.STAD_END_DT          /* 기준종료일자 */
             , A.STAD_APC_DT          /* 기준적용일자 */
             , A.RMK                  /* 비고 */
          FROM TBBADDED180B A
          WHERE 1=1
        ]]>
        
        <isNotEmpty property="strBztDvsnCd">	 
			  AND BZT_DVSN_CD = #strBztDvsnCd#	
		</isNotEmpty>
		
		<isNotEmpty property="strStadStrDt">	
		   <isNotEmpty property="strStadEndDt"> 
			<![CDATA[  AND A.STAD_STR_DT <= #strStadEndDt# ]]>
			<![CDATA[  AND A.STAD_END_DT >= #strStadStrDt# ]]>
		   </isNotEmpty>	
		</isNotEmpty>
		   
        <![CDATA[
		   ORDER BY 
		         A.BZT_SRNO DESC
		]]>
		
        </select>
        
    <select id="badded048EAppCostselectSub" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
        SELECT A.BZT_SRNO             /* 출장순번 */
             , A.TREXP_CLU_SEQ        /* 여비항목순번 */
             , A.TREXP_CLU_CD         /* 여비항목코드 */
             , F_CODE_NM('1000022',A.TREXP_CLU_CD)   AS TREXP_CLU_NM /* 여비항목명 */
             , A.RANK_DVSN_CD         /* 직급구분코드 */
             , F_CODE_NM('1000024',A.RANK_DVSN_CD)   AS RANK_DVSN_NM /* 직급구분명 */
             , A.RGN_DVSN_CD          /* 지역구분코드 */
             , F_CODE_NM('1000023',A.RGN_DVSN_CD)    AS RGN_DVSN_NM  /* 지역구분명 */
             , A.BZT_STAD_AM          /* 출장기준금액 */
             , A.AUD_BZT_KND_CD       /* 감사출장종류코드 */
             , F_CODE_NM('1000030',A.AUD_BZT_KND_CD) AS AUD_BZT_KND_NM /* 감사출장종류명 */
             , F_CODE_NM('1000751', A.BZT_BGT_DVSN_CD) AS BZT_BGT_DVSN_NM /* 예산구분명 */
             , F_CODE_NM('1001019', A.DT_EXS_DVSN_CD) AS DT_EXS_DVSN_NM  /* 여비구분명 */
             , A.BZT_BGT_DVSN_CD
             , A.DT_EXS_DVSN_CD
          FROM TBBADDED018B A
          WHERE ((NVL(#newYn#,'N') = 'Y' AND A.BZT_SRNO = (SELECT MAX(AA.BZT_SRNO)
                                                             FROM TBBADDED180B AA
                                                            WHERE AA.BZT_DVSN_CD = #strBztDvsnCd# ) ) OR 
                 (NVL(#newYn#,'N') = 'N' AND A.BZT_SRNO = #BZT_SRNO#) )
        ]]>
        
        <isNotEmpty property="strTrexpCluCd">	 
			  AND A.TREXP_CLU_CD = #strTrexpCluCd#	
		</isNotEmpty>

        <![CDATA[
		   ORDER BY A.BZT_SRNO, A.TREXP_CLU_CD, A.TREXP_CLU_SEQ
		]]>
		
        </select>
		
	<insert id="badded048EMstInsert" parameterClass="paramMap">
		INSERT 
		  INTO TBBADDED180B
		     ( BZT_SRNO
		     , BZT_DVSN_CD
		     , STAD_STR_DT
		     , STAD_END_DT
		     , STAD_APC_DT
		     , RMK
		     , FNL_DEAL_DPT_CD
		     , FNL_MNU_ID
		     , FRT_USR_ID
		     , FRT_REGI_DH
		     , FNL_USR_ID
		     , FNL_MDF_DH
 		     )
 		VALUES
 		     ( #BZT_SRNO#
 		     , #BZT_DVSN_CD#
 		     , #STAD_STR_DT#
 		     , '29991231'
 		     , TO_CHAR(SYSDATE,'yyyyMMdd')
 		     , #RMK#
 		     , #FNL_DEAL_DPT_CD#
 		     , #FNL_MNU_ID#
 		     , #FRT_USR_ID#
 		     , SYSDATE
 		     , #FNL_USR_ID#
 		     , SYSDATE
 		     )
	</insert>
	
	<update id="badded048EMstRmkUpdate" parameterClass="paramMap">
		UPDATE TBBADDED180B
		   SET RMK = #RMK#
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		     , FNL_MNU_ID = #FNL_MNU_ID#
		     , FNL_USR_ID = #FNL_USR_ID#
		     , FNL_MDF_DH = SYSDATE
		 WHERE BZT_SRNO = #BZT_SRNO#
	</update>
	
	<update id="badded048EMstStadEndDtUpdate" parameterClass="paramMap">
		UPDATE TBBADDED180B A
		   SET STAD_END_DT = (SELECT TO_CHAR(TO_DATE(MAX(B.STAD_STR_DT),'yyyyMMdd')-1,'yyyyMMdd')
		                        FROM TBBADDED180B B
		                       WHERE B.BZT_DVSN_CD = #BZT_DVSN_CD#)
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		     , FNL_MNU_ID = #FNL_MNU_ID#
		     , FNL_USR_ID = #FNL_USR_ID#
		     , FNL_MDF_DH = SYSDATE
		 WHERE A.BZT_SRNO = (SELECT MAX(B.BZT_SRNO)
		                       FROM TBBADDED180B B
		                      WHERE B.BZT_DVSN_CD = #BZT_DVSN_CD#
		                        AND B.BZT_SRNO != (SELECT MAX(B.BZT_SRNO)
		                                             FROM TBBADDED180B B
		                                            WHERE B.BZT_DVSN_CD = #BZT_DVSN_CD#))
	</update>
	
	<insert id="badded048EDtlInsert" parameterClass="paramMap">
		INSERT 
		  INTO TBBADDED018B
		     ( BZT_SRNO
		     , BZT_STAD_AM
		     , TREXP_CLU_SEQ
		     , RANK_DVSN_CD
		     , RGN_DVSN_CD
		     , TREXP_CLU_CD
		     , FNL_DEAL_DPT_CD
		     , FNL_MNU_ID
		     , FRT_USR_ID
		     , FRT_REGI_DH
		     , FNL_USR_ID
		     , FNL_MDF_DH
		     , AUD_BZT_KND_CD
		     , BZT_BGT_DVSN_CD
		     , DT_EXS_DVSN_CD
 		     )
 		VALUES
 		     ( #BZT_SRNO#
 		     , #BZT_STAD_AM#
 		     , #TREXP_CLU_SEQ#
 		     , #RANK_DVSN_CD#
 		     , #RGN_DVSN_CD#
 		     , #TREXP_CLU_CD#
 		     , #FNL_DEAL_DPT_CD#
 		     , #FNL_MNU_ID#
 		     , #FRT_USR_ID#
 		     , SYSDATE
 		     , #FNL_USR_ID#
 		     , SYSDATE
 		     , #AUD_BZT_KND_CD#
 		     , #BZT_BGT_DVSN_CD#
 		     , #DT_EXS_DVSN_CD#
 		     )
	</insert>
	
	<update id="badded048EDtlUpdate" parameterClass="paramMap">
		UPDATE TBBADDED018B
		   SET BZT_STAD_AM = #BZT_STAD_AM#
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		     , FNL_MNU_ID = #FNL_MNU_ID#
		     , FNL_USR_ID = #FNL_USR_ID#
		     , FNL_MDF_DH = SYSDATE
		 WHERE BZT_SRNO = #BZT_SRNO#
		   AND TREXP_CLU_SEQ = #TREXP_CLU_SEQ#
		   AND RANK_DVSN_CD = #RANK_DVSN_CD#
		   AND RGN_DVSN_CD = #RGN_DVSN_CD#
		   AND TREXP_CLU_CD = #TREXP_CLU_CD# 
	</update>
	
	<select id="badded048EMaxBztSrno" parameterClass="paramMap"
		resultClass="java.lang.String">
        <![CDATA[       
			SELECT MAX(NVL(BZT_SRNO,0))+1 AS BZT_SRNO
		      FROM TBBADDED180B
        ]]>

	</select>
	
	<update id="badded048EMstDelete" parameterClass="paramMap">
		DELETE 
		  FROM TBBADDED180B
		 WHERE BZT_SRNO = #BZT_SRNO#
	</update>
	
	<update id="badded048EDtlDelete" parameterClass="paramMap">
		DELETE
		  FROM TBBADDED018B
		 WHERE BZT_SRNO = #BZT_SRNO#
	</update>
	
	<update id="badded048EMstDelStadEndDtUpdate" parameterClass="paramMap">
	   <![CDATA[
		UPDATE TBBADDED180B
		   SET STAD_END_DT = #STAD_END_DT#
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		     , FNL_MNU_ID = #FNL_MNU_ID#
		     , FNL_USR_ID = #FNL_USR_ID#
		     , FNL_MDF_DH = SYSDATE
		 WHERE BZT_SRNO = (SELECT MAX(BZT_SRNO)
		                     FROM TBBADDED180B
		                    WHERE BZT_SRNO < #BZT_SRNO#
		                      AND BZT_DVSN_CD = #BZT_DVSN_CD#)
	    ]]>	                       
	</update>
	
</sqlMap> 

