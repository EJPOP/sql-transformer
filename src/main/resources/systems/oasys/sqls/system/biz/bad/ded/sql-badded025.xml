<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/ded/025">

	<!--일반출장사항 조회-->
	<select id="BADDED025EMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[       
			SELECT D1.REL_AUD_YR||'-'||D1.REL_AUD_NO    AS AUD_YR_NO            /*감사연번호*/
			     , D1.BZT_YR							AS BZT_YR				/*출장년도*/
			     , D1.BZT_SNO                           AS BZT_SNO              /*출장순번*/
			     , D1.BZT_DVSN_CD                       AS BZT_DVSN_CD          /*출장구분코드*/
			     , D1.AUD_BZT_KND_CD                    AS AUD_BZT_KND_CD       /*감사출장종류코드*/
			     , D1.BZT_TL_CNB                        AS BZT_TL_CNB           /*출장반장전산번호*/
			     , D1.BZT_TL_BRDV_CD                    AS BZT_TL_BRDV_CD       /*출장반장국과코드*/    
			     , D1.BZT_TL_RANK_CD                    AS BZT_TL_RANK_CD       /*출장반장직급코드*/
			     , F_USR_INFO(D1.BZT_TL_CNB,'2')        AS BZT_TL_CNB_NM        /*출장반장명*/    
			     , F_DPT_INFO(D1.BZT_TL_BRDV_CD,'1')    AS BZT_TL_BRDV_NM       /*출장반장국과명*/
			     , F_CODE_NM('1000173',D1.BZT_TL_RANK_CD)   AS BZT_TL_RANK_NM   /*출장반장직급명*/
			     , D1.TIT_TXT                           AS TIT_TXT              /*제목내용*/
			     , D1.BZT_BRDV_CD                       AS BZT_BRDV_CD          /*출장국과코드*/
			     , F_DPT_INFO(D1.BZT_BRDV_CD,'1')       AS BZT_BRDV_NM          /*출장국과명*/
			     , D1.HLDY_ACTV_DVSN_CD                 AS HLDY_ACTV_DVSN_CD    /*휴일활동구분코드*/
			     , F_CODE_NM('1000019',D1.HLDY_ACTV_DVSN_CD) AS HLDY_ACTV_DVSN_NM
			     , D1.USE_VHCLE                         AS USE_VHCLE            /*공용차량사용여부*/ 
			     , D1.REL_AUD_YR                        AS REL_AUD_YR           /*관련감사년도*/
			     , D1.REL_AUD_NO                        AS REL_AUD_NO           /*관련감사번호*/
			     , D1.AUD_STEP_SNO                      AS AUD_STEP_SNO         /*감사단계순번*/
			     , D1.BZT_TXT                           AS BZT_TXT              /*출장내용*/
			     , D1.CTRL_YN                           AS CTRL_YN              /*통제여부*/
			     , D1.BZT_YR ||'-'||D1.SPRT_NO          AS SPRT_NM              /*지원번호*/
			     , D1.SPRT_NO                           AS SPRT_NO              /*지원번호*/
			     , D1.GEN_BZT_KND_CD                    AS GEN_BZT_KND_CD       /*일반출장구분코드*/
			     , F_CODE_NM('1000021',D1.GEN_BZT_KND_CD) AS GEN_BZT_KND_NM
			     , D1.REGI_DT                           AS REGI_DT              /*등록일*/
			     , D1.AUD_STR_DT                        AS AUD_STR_DT           /*감사시작일*/
			     , D1.AUD_END_DT                        AS AUD_END_DT           /*감사종료일*/
			     , D1.AUD_DCN                           AS AUD_DCN              /*감사일수*/
			     , D1.LEAD_EXS_PMT_YN                   AS LEAD_EXS_PMT_YN      /*지휘비지급여부*/
			     , D1.CTRL_TG_YN                        AS CTRL_TG_YN           /*통제대상여부*/
			     , D1.CTRL_DT                           AS CTRL_DT              /*통제일*/
			     , D1.SND_YN                            AS SND_YN               /*송부여부*/
			     , D1.SND_DT                            AS SND_DT               /*송부일*/
			     , D1.FLD_AUD_STEP_NO                   AS FLD_AUD_STEP_NO      /*실지감사단계번호*/
			     , TO_CHAR(TO_DATE(D1.AUD_STR_DT),'YYYY-MM-DD')||'~'|| TO_CHAR(TO_DATE(D1.AUD_END_DT),'YYYY-MM-DD')    AS AUD_ST_END_DT        /*실시기간*/
                 , CASE WHEN NVL(D1.CTRL_TG_YN,'N') = 'N' THEN '-'
                        WHEN NVL(D1.CTRL_TG_YN,'N') = 'Y' AND NVL(D1.CTRL_YN,'N') = 'Y' THEN 'O' 
                        WHEN NVL(D1.CTRL_TG_YN,'N') = 'Y' AND NVL(D1.CTRL_YN,'N') = 'N' THEN 'X'
                    END AS CTRL_YN_DISP
                 , CASE WHEN NVL(D1.SND_YN,'N') = 'Y' THEN 'O' ELSE 'X' END AS SND_YN_DISP
                 , (SELECT CASE WHEN D1.CALC_DTM_YN = 'Y' 
                                     THEN '확정'
                                ELSE CASE WHEN COUNT(1)>0 THEN 'Y' ELSE 'N' END
                            END   
                      FROM TBBADDED011L
                     WHERE 1=1
                       AND BZT_YR  = D1.BZT_YR
                       AND BZT_SNO = D1.BZT_SNO
                    )  	AS EXP_YN 		/*수정가능여부를 판단하기 위함.*/
                 , '' 	AS SEL_YN		/*선택여부를 판단하기위함.(통제화면)*/        
                 , NVL(D3.IN_PSON_CNT,0)    AS IN_PSON_CNT
			     , NVL(D3.EXT_PSON_CNT,0)   AS EXT_PSON_CNT
			     , NVL(D3.IN_PSON_CNT,0)||'/'||NVL(D3.EXT_PSON_CNT,0)||'/'||(NVL(D3.IN_PSON_CNT,0)+ NVL(D3.EXT_PSON_CNT,0)) AS ALL_PSON_CNT 
			     , F_ORG_CNT_NM_AUD(D1.BZT_YR,D1.BZT_SNO,'BZT') AS ORG_CNT_NM  
                 , (SELECT CASE WHEN COUNT(1)>0 THEN 'Y' ELSE 'N' END  
                      FROM TBBADDED004L
                     WHERE 1=1
                       AND BZT_YR  = D1.BZT_YR
                       AND BZT_SNO = D1.BZT_SNO
                    )  	AS TEAM_YN			          		     
			  FROM TBBADDED002M D1
			     , (
			        SELECT BZT_YR
			             , BZT_SNO
			             , SUM( CASE WHEN A.STF_DVSN_CD = '0' THEN 1 ELSE 0 END) AS IN_PSON_CNT  /*내부인원*/
			             , SUM( CASE WHEN A.STF_DVSN_CD = '0' THEN 0 ELSE 1 END) AS EXT_PSON_CNT /*외부인원*/
			          FROM (SELECT DISTINCT BZT_YR
			                     , BZT_SNO
			                     , PCT_CNB
			                     , STF_DVSN_CD
			                  FROM TBBADDED005L) A
			         GROUP BY BZT_YR, BZT_SNO 
			     ) D3			     
			WHERE 1=1
			  AND D1.BZT_YR     = D3.BZT_YR(+)
			  AND D1.BZT_SNO    = D3.BZT_SNO(+)
			  AND D1.BZT_DVSN_CD = '2'
			  AND D1.BZT_BRDV_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#)))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/
		]]>		
		<isNotEmpty property="strSpvBrdvCd">	 
			  AND D1.BZT_BRDV_CD = #strSpvBrdvCd#		 /*출장국과코드*/
		</isNotEmpty>   
		<isNotEmpty property="SPRT_NO">
			  AND D1.SPRT_NO = #SPRT_NO#				/*지원번호*/
		</isNotEmpty>		
		<isNotEmpty property="BZT_YR">
			  AND D1.BZT_YR = #BZT_YR#					/*출장년도*/
		</isNotEmpty>
		<isNotEmpty property="TIT_TXT">
			 AND D1.TIT_TXT LIKE #TIT_TXT#||'%'			/*출장상황명*/
		</isNotEmpty>
		<isNotEmpty property="strBztYr">
			  AND D1.BZT_YR = #strBztYr#					/*출장년도*/
		</isNotEmpty>		
		<isNotEmpty property="strBztSno">
			  AND D1.BZT_SNO = #strBztSno#					/*출장년도*/
		</isNotEmpty>				
        <![CDATA[       
			 ORDER BY TO_NUMBER(D1.SPRT_NO) DESC 
        ]]>
	</select>

	<!-- 일반출장 지원번호 Max값 찾기 -->
	<select id="BADDED025ESprtNoMaxSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[     	
			    SELECT TO_CHAR(NVL(MAX(TO_NUMBER(SPRT_NO)),0)+1) AS MAX_SPRT_NO
				  FROM TBBADDED002M
				 WHERE 1=1
					AND BZT_YR = #BZT_YR#
		]]>
	</select>	
	
	
</sqlMap> 

