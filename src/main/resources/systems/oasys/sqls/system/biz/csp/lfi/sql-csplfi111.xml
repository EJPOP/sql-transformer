<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/lfi/111">
	
	<select id="CSPLFI111QMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	A.LON_DDCT_DVSN_CD,
					C.DPT_NM,
					A.LON_PEN_CNB,
					B.USR_NAM,
					SUBSTR(B.EIN,0, 6) || (SELECT TO_CHAR('-*******') FROM DUAL) AS EIN,
					A.TOT_LON_AM,
					A.MN_STT_AM,
					A.STR_YM,
					A.END_YM,
					SUBSTR(#yyyymm#,0,4)||'-'||SUBSTR(#yyyymm#,5,6)  AS YM
			  FROM 	TBCSPLFI001M A,
			  		TBDCMACM001M B,
			  		TBDCMACM002M C
			 WHERE	1=1
			   AND 	A.LON_PEN_CNB = B.CNB
			   AND	B.DPT_CD = C.DPT_CD
			   AND	A.STR_YM <= #yyyymm#
			   AND	A.END_YM >= #yyyymm#
			   AND	A.LON_DDCT_DVSN_CD = #lonDdctDvsnCd#
		]]>
		<dynamic>
		   	<isNotEmpty property="cnb">
			   AND	A.LON_PEN_CNB = #cnb#
		   </isNotEmpty>
		   <isNotEmpty property="name">
			   AND	B.USR_NAM LIKE '%' || #name# || '%'
		   </isNotEmpty>
		</dynamic>
		<![CDATA[
			 ORDER BY SUBSTR(B.EIN,0, 6), A.LON_DDCT_DVSN_CD, C.DPT_NM, A.LON_PEN_CNB
		]]>
	</select>
	
	<select id="CSPLFI111QMainTotalAmt" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT TO_CHAR(SUM(A.MN_STT_AM), 'FM999,999,999,999,999,999,999,999') AS TOTAL_AMT
			  FROM 	TBCSPLFI001M A,
			  		TBDCMACM001M B,
			  		TBDCMACM002M C
			 WHERE	1=1
			   AND 	A.LON_PEN_CNB = B.CNB
			   AND	B.DPT_CD = C.DPT_CD
		]]>
		<dynamic>
			<isNotEmpty property="yyyymm">
			   AND	A.STR_YM &lt;= #yyyymm#
			   AND	A.END_YM &gt;= #yyyymm#
		   	</isNotEmpty>
		   	<isNotEmpty property="lonDdctDvsnCd">
			   AND	A.LON_DDCT_DVSN_CD = #lonDdctDvsnCd#
		   	</isNotEmpty>
		   	<isNotEmpty property="cnb">
			   AND	A.LON_PEN_CNB = #cnb#
		   </isNotEmpty>
		   <isNotEmpty property="name">
			   AND	B.USR_NAM LIKE '%' || #name# || '%'
		   </isNotEmpty>
		</dynamic>
		<![CDATA[
			 ORDER BY A.LON_DDCT_DVSN_CD, C.DPT_NM, A.LON_PEN_CNB
		]]>
	</select>
	
	<select id="CSPLFI111QExcelExportSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			 SELECT '1040000' AS SAL_DPT_CD,
			        B.USR_NAM,
			 		B.EIN,
					A.LON_DDCT_DVSN_CD,
					'0' AS SNO,
			        #yyyymm# AS STR_YM,
			        'AA' AS SAL_DVSN_CD,
			        SUM(A.MN_STT_AM) AS MN_STT_AM,
			        '' AS DDCT_MM_DVSN_CD,
			        '' AS BANK_CD,
			        '' AS ACCOUNT,
			        #yyyymm# AS END_YM,
			        '' AS ETC,
			        '' AS MDF_ID,
			        '' AS DMF_DH        
			   FROM TBCSPLFI001M A,
			        TBDCMACM001M B,
			        TBDCMACM002M C
			  WHERE 1=1
			    AND A.LON_PEN_CNB = B.CNB
			    AND B.DPT_CD = C.DPT_CD
		]]>
		<dynamic>
			<isNotEmpty property="yyyymm">
			<![CDATA[
			   AND	A.STR_YM <= #yyyymm#
			   AND	A.END_YM >= #yyyymm#
			]]>
		   	</isNotEmpty>
		   	<isNotEmpty property="lonDdctDvsnCd">
			   AND	A.LON_DDCT_DVSN_CD = #lonDdctDvsnCd#
		   	</isNotEmpty>
		   	<isNotEmpty property="cnb">
			   AND	A.LON_PEN_CNB = #cnb#
		   </isNotEmpty>
		   <isNotEmpty property="name">
			   AND	B.USR_NAM LIKE '%' || #name# || '%'
		   </isNotEmpty>
		</dynamic>
		<![CDATA[
			 GROUP BY B.USR_NAM, B.EIN, A.LON_DDCT_DVSN_CD
			 ORDER BY B.EIN, A.LON_DDCT_DVSN_CD
		]]>
	</select>
	
	<select id="CSPLFI114EMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	F_USR_INFO(A.LON_PEN_CNB, '2') AS NM,
					A.LON_PEN_CNB,
					C.DPT_NM,
					SUBSTR(B.EIN,0, 6) || (SELECT TO_CHAR('-*******') FROM DUAL) AS EIN,
					A.LON_DDCT_DVSN_CD,
					F_CODE_NM('1000176',B.PST_CD) AS PST_NM,
					F_CODE_NM('1000173',B.RANK_CD) AS RANK_NM,
					'' AS HOBONG,
					A.LON_DDCT_SRNO,
					A.TOT_LON_AM,
					A.MN_STT_AM,
					A.STR_YM,
					A.END_YM,
					CASE WHEN A.END_YM <= (SELECT TO_CHAR(SYSDATE, 'YYYYMM') FROM DUAL) THEN 'Y' ELSE 'N' END AS YN,
					A.LON_DDCT_SRNO
			  FROM 	TBCSPLFI001M A,
			  		TBDCMACM001M B,
			  		TBDCMACM002M C
			 WHERE	1=1
			   AND 	A.LON_PEN_CNB = B.CNB
			   AND	B.DPT_CD = C.DPT_CD 
			   AND	A.LON_PEN_CNB = #cnb#
			 ORDER BY A.LON_DDCT_DVSN_CD, C.DPT_NM, A.LON_PEN_CNB
		]]>
	</select>
	
	<select id="CSPLFI114EUserInfoSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	F_USR_INFO(B.CNB, '2') AS NM,
					B.CNB,
					C.DPT_NM,
					SUBSTR(B.EIN,0, 6) || (SELECT TO_CHAR('-*******') FROM DUAL) AS EIN,
					F_CODE_NM('1000176',B.PST_CD) AS PST_NM,
					F_CODE_NM('1000173',B.RANK_CD) AS RANK_NM,
					F_CODE_NM('1000177', PS_CD) AS HOBONG
			  FROM 	TBDCMACM001M B,
			  		TBDCMACM002M C
			 WHERE	1=1
			   AND	B.DPT_CD = C.DPT_CD 
			   AND	B.CNB = #cnb#
		]]>
	</select>
	
	<insert id="CSPLFI114EInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPLFI001M
			(
				LON_PEN_CNB,
				LON_DDCT_DVSN_CD,
				LON_DDCT_SRNO,
				STR_YM,
				END_YM,
				TOT_LON_AM,
				MN_STT_AM,
				FRT_USR_ID,
				FNL_USR_ID,
				FNL_DEAL_DPT_CD,
				FNL_MNU_ID,
				FRT_REGI_DH,
				FNL_MDF_DH
			)
			VALUES
			(
				#cnb#,
				#LON_DDCT_DVSN_CD#,
				(
					SELECT NVL(MAX(LON_DDCT_SRNO) + 1 , '001')
					  FROM TBCSPLFI001M
					 WHERE 1=1
					   AND LON_PEN_CNB = #cnb#
					   AND LON_DDCT_DVSN_CD = #LON_DDCT_DVSN_CD#
				),
				#STR_YM#,
				#END_YM#,
				#TOT_LON_AM#,
				#MN_STT_AM#,
				#FRT_USR_ID#,
				#FNL_USR_ID#,
				#FNL_DEAL_DPT_CD#,
				#FNL_MNU_ID#,
				SYSDATE,
				SYSDATE
			)
		]]>
	</insert>
	
	<update id="CSPLFI114EUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPLFI001M
			   SET 	STR_YM = #STR_YM#,
					END_YM = #END_YM#,
					TOT_LON_AM = #TOT_LON_AM#,
					MN_STT_AM = #MN_STT_AM#,
					FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE
			 WHERE 	1=1
			   AND 	LON_PEN_CNB			=	#LON_PEN_CNB#
			   AND 	LON_DDCT_DVSN_CD	=	#LON_DDCT_DVSN_CD#
			   AND 	LON_DDCT_SRNO		=	#LON_DDCT_SRNO#
		]]>	
	</update>
	
	<delete id="CSPLFI114EDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE FROM TBCSPLFI001M
			 WHERE 	1=1
			   AND 	LON_PEN_CNB			=	#LON_PEN_CNB#
			   AND 	LON_DDCT_DVSN_CD	=	#LON_DDCT_DVSN_CD#
			   AND 	LON_DDCT_SRNO		=	#LON_DDCT_SRNO#
		]]>
	</delete>	
	
	<!-- 매점공제관리 -->
	<select id="CSPLFI121QMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT 	C.DPT_NM AS DEPT_NM,
					A.CNB AS EMPLNUM,
					B.USR_NAM AS NAME,
					NVL(SUM(A.SALE_TAM),0) as TOT_PRICE,
					A.DDCT_YM AS DEDUCTION_DATE
			  FROM 	TBCSPLFI002L A, 
			       	TBDCMACM001M B, 
			       	TBDCMACM002M C
			 WHERE 	A.CNB = B.CNB
			   AND 	B.DPT_CD = C.DPT_CD
			   AND 	A.DDCT_YM = #deduction_date#
		]]>
			<dynamic>
				<isNotEmpty property="emplNum">
					AND A.CNB = #emplNum#
				</isNotEmpty>
				<isNotEmpty property="name">
					AND B.USR_NAM LIKE '%'||#name#||'%'
				</isNotEmpty>
			</dynamic>
		<![CDATA[  
			 GROUP BY C.DPT_NM, A.CNB, B.USR_NAM, A.DDCT_YM
			 ORDER BY A.CNB asc
		]]>
	</select>
	
	<delete id="CSPLFI121Qdelete" parameterClass="paramMap">
        <![CDATA[       
				DELETE FROM TBCSPLFI002L
				 WHERE DDCT_YM = #deduction_date#
        ]]>
	</delete>
	
	<insert id="CSPLFI121Qinsert" parameterClass="paramMap">
        <![CDATA[
			INSERT INTO TBCSPLFI002L
			(
				SALE_DT,
				SRNO,
				CNB,
				DEAL_TXT,
				COT,
				SALE_TAM,
				FL_UL_DT,
				DDCT_YM,
				MTRL_MDF_DT,
				MDF_PEN_CNB,
				HNDL_YN,
				FRT_USR_ID,
				FNL_USR_ID,
				FNL_DEAL_DPT_CD,
				FNL_MNU_ID,
				FRT_REGI_DH,
				FNL_MDF_DH
			)
			VALUES
			(
				REPLACE(#IDATE#, '-'),
				(SELECT NVL(MAX(SRNO),0) + 1 AS SNO
				   FROM TBCSPLFI002L WHERE SALE_DT = REPLACE(#IDATE#, '-')),
				#EMPLNUM#,
				#ITEM_NAME#,
				TO_NUMBER(#VOL#),
				TO_NUMBER(#TOT_PRICE#),
				REPLACE(#IDATE#, '-'),
				#DEDUCTION_DATE#,
				TO_CHAR(SYSDATE, 'YYYYMMDD'),
				#EMPLNUM#,
				'N',
				#FRT_USR_ID#,
				#FNL_USR_ID#,
				#FNL_DEAL_DPT_CD#,
				#FNL_MNU_ID#,
				SYSDATE,
				SYSDATE
			)
		]]>
	</insert>
	
	<select id="CSPLFI121QexcelExport" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT '1040000' AS SALDEPTCD,
			       B.EIN AS RCN,
			       B.USR_NAM AS NAME,
			       'Z03' AS DEDUCTIONCD,
			       '0' AS SEQ,
			       A.DDCT_YM AS STARTDATE,
			       'AA' AS SALDIVCD,
			       NVL(SUM(A.SALE_TAM),0) AS TOTPRICE,
			       '' AS DEDUCTIONDATECD,
			       '' AS BANKCD,
			       '' AS BANKNUMBER,
			       A.DDCT_YM AS ENDDATE,
			       '' AS ETC,
			       '' AS MODIFYID,
			       '' AS MODIFYDATE
			  FROM TBCSPLFI002L A, TBDCMACM001M B
			 WHERE  A.CNB = B.CNB
			   AND DDCT_YM = #deduction_date#
		]]>
			<dynamic>
				<isNotEmpty property="emplNum">
					AND A.CNB LIKE #emplNum# ||'%'
				</isNotEmpty>
				<isNotEmpty property="name">
					AND B.USR_NAM LIKE '%'||#name#||'%'
				</isNotEmpty>
			</dynamic>
		<![CDATA[  
			 GROUP BY B.EIN,B.USR_NAM, A.DDCT_YM
			 ORDER BY B.EIN ASC
		]]>
	</select>
	
	<update id="CSPLFI121QUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPLFI002L
			   SET 	HNDL_YN = 'Y',
					FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE
			 WHERE 	1=1
			   AND 	DDCT_YM = #deduction_date#
			   AND 	HNDL_YN = 'N'
		]]>	
	</update>
	
	<select id="CSPLFI122QMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT 	SALE_DT,
					SRNO,
					DEAL_TXT,
					COT,
					SALE_TAM,
					F_DPT_INFO(F_USR_INFO(CNB, 5), 4) AS DPT_NM,
					CNB,
					F_USR_INFO(CNB, 2) AS NM
			 FROM 	TBCSPLFI002L
			WHERE DDCT_YM = #ym#
		]]>
		<dynamic>
			<isNotEmpty property="cnb">	
			  AND CNB = #cnb#
			</isNotEmpty>
		</dynamic>
		<![CDATA[
			ORDER BY SALE_DT, CNB
		]]>
	</select>
	
</sqlMap> 
