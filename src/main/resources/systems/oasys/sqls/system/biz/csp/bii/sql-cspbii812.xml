<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/bii/812">
	<!-- 주요자료내역 상세 조회 -->   
	<select id="CSPBII812EMainselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT A.MTRL_KND_CD                                      /* 자료종류코드 */
			     , SUBSTR(A.INF_NO, 1, 4)              AS INF_NO_YE   /* 정보번호-연도 */
			     , SUBSTR(A.INF_NO, 6, 5)              AS INF_NO_SRNO /* 정보번호-일련번호 */
			     , CASE WHEN A.MTRL_KND_CD = '2' THEN A.INF_NO
			            ELSE NULL
			       END                                           AS INF_NO      /* 정보번호 */
			     , A.MTRL_NM                                          /* 자료명 */
			     , A.COPT_GD_CD                                       /* 소관부처코드 */
			     , (SELECT B.ORG_NM
			          FROM TBDCMACM015M B
			         WHERE B.ORG_CD = A.COPT_GD_CD)    AS COPT_GD_NM  /* 소관부처명 */
			     , A.OPEN_YN                                          /* 공개여부 */
			     , A.ACQR_ORG_CD                                      /* 입수기관코드 */
			     , (SELECT B.ORG_NM
			          FROM TBDCMACM015M B
			         WHERE B.ORG_CD = A.ACQR_ORG_CD)   AS ACQR_ORG_NM /* 입수기관명 */
			     , A.ACQR_DIV_NM                                      /* 입수과명 */
			     , A.ETRT_STAD_DT                                     /* 추출기준일 */
			     , A.ETRT_TG_PRD_TXT                                  /* 추출대상기간내용 */
			     , A.ETRT_NOC                                         /* 추출건수 */
			     , A.ETRT_CLU_TXT                                     /* 추출항목내용 */
			     , (SELECT B.DOC_ID
			          FROM TBCSPBII801L B
			         WHERE B.YE   = A.YE
			           AND B.SRNO = A.SRNO 
			           AND B.DOC_TYP_CD = 'SP-II-005') AS SMP_DOC_ID  /* 샘플파일문서번호 */
			         
			     , A.YE                                               /* 연도 */
			     , A.SRNO                                             /* 일련번호 */
			  FROM TBCSPBII800L A  /* 주요자료내역 */
			 WHERE A.YE   = #strYe#
			   AND A.SRNO = #strSrno#
		]]>
	</select>
	
	<!-- 주요자료내역 키 생성 -->
	<select id="CSPBII812EMainKeyValueselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT TO_CHAR(SYSDATE, 'YYYY')               AS YE   /* 연도 */
			     , (SELECT NVL(MAX(SRNO), 0) + 1
		              FROM TBCSPBII800L
		             WHERE YE = TO_CHAR(SYSDATE, 'YYYY')) AS SRNO /* 일련번호 */
		      FROM DUAL
		]]>
	</select>
	
	<!-- 주요자료내역 등록  -->
	<insert id="CSPBII812EMaininsert" parameterClass="paramMap">
		INSERT INTO TBCSPBII800L (
		                          YE              /* 연도 */
		                        , SRNO            /* 일련번호 */
		                        , MTRL_KND_CD     /* 자료종류코드 */
		                        , INF_NO          /* 정보번호 */
		                        , MTRL_NM         /* 자료명 */
		                        , COPT_GD_CD      /* 소관부처코드*/
		                        , ACQR_ORG_CD     /* 입수기관코드  */
		                        , ACQR_DIV_NM     /* 입수과명 */
		                        , OPEN_YN         /* 공개여부 */
		                        , ETRT_STAD_DT    /* 추출기준일 */
		                        , ETRT_TG_PRD_TXT /* 추출대상기간내용 */
		                        , ETRT_NOC        /* 추출건수 */
		                        , ETRT_CLU_TXT    /* 추출항목내용 */
		               		    , FRT_USR_ID      /* 최초사용자ID */
		                        , FNL_USR_ID      /* 최종사용자ID */
		                        , FNL_DEAL_DPT_CD /* 최종거래부서코드 */
		                        , FNL_MNU_ID      /* 최종메뉴ID */
		                        , FRT_REGI_DH     /* 최초등록일시 */
		                        , FNL_MDF_DH      /* 최종수정일시 */
		                         ) 
		                  VALUES (
		                          TO_CHAR(SYSDATE, 'YYYY')
		                        , (SELECT NVL(MAX(SRNO), 0) + 1
		                             FROM TBCSPBII800L
		                            WHERE YE = TO_CHAR(SYSDATE, 'YYYY'))
		                        , #MTRL_KND_CD#
		                        , #INF_NO#
		                        , #MTRL_NM#
		                        , #COPT_GD_CD#
		                        , #ACQR_ORG_CD#
		                        , #ACQR_DIV_NM#
		                        , #OPEN_YN#	
		                        , #ETRT_STAD_DT#
		                        , #ETRT_TG_PRD_TXT#
		                        , #ETRT_NOC#
		                        , #ETRT_CLU_TXT#
		                        , #FRT_USR_ID#
		                        , #FNL_USR_ID#
		                        , #FNL_DEAL_DPT_CD#
		                        , #FNL_MNU_ID#
		                        , SYSDATE
		                        , SYSDATE
				                 )
	</insert>
	
	<!-- 주요자료첨부파일내역 등록  -->
	<insert id="CSPBII812EAttFilinsert" parameterClass="paramMap">
		INSERT INTO TBCSPBII801L (
		                          YE              /* 연도 */
		                        , SRNO            /* 일련번호 */
		                        , DOC_TYP_CD      /* 등록일 */
		                        , DOC_ID          /* 제출자부서코드 */
		               		    , FRT_USR_ID      /* 최초사용자ID */
		                        , FNL_USR_ID      /* 최종사용자ID */
		                        , FNL_DEAL_DPT_CD /* 최종거래부서코드 */
		                        , FNL_MNU_ID      /* 최종메뉴ID */
		                        , FRT_REGI_DH     /* 최초등록일시 */
		                        , FNL_MDF_DH      /* 최종수정일시 */
		                         ) 
		                  VALUES (
		                          #YE#
		                        , #SRNO#
		                        , #DOC_TYP_CD#
		                        , #DOC_ID#
		                        , #FNL_USR_ID#	<!-- 업데이트시에도 첨부파일 insert가 발생할 수 있기 때문에 최종유저ID파라미터로 넘김(FRT_USR_ID와 값 동일) -->
		                        , #FNL_USR_ID#
		                        , #FNL_DEAL_DPT_CD#
		                        , #FNL_MNU_ID#
		                        , SYSDATE
		                        , SYSDATE
				                 )
	</insert>
	
	<!-- 주요자료내역 수정 -->
	<update id="CSPBII812EMainupdate" parameterClass="paramMap">
		UPDATE TBCSPBII800L                       
		   SET MTRL_KND_CD     = #MTRL_KND_CD#     /* 자료종류코드 */
		     , INF_NO          = #INF_NO#          /* 정보번호 */
		     , MTRL_NM         = #MTRL_NM#         /* 자료명 */
		     , COPT_GD_CD      = #COPT_GD_CD#      /* 소관부처코드*/
		     , ACQR_ORG_CD     = #ACQR_ORG_CD#     /* 입수기관코드  */
		     , ACQR_DIV_NM     = #ACQR_DIV_NM#     /* 입수과명 */ 
		     , OPEN_YN         = #OPEN_YN#         /* 공개여부 */
		     , ETRT_STAD_DT    = #ETRT_STAD_DT#    /* 추출기준일 */ 
		     , ETRT_TG_PRD_TXT = #ETRT_TG_PRD_TXT# /* 추출대상기간내용  */
		     , ETRT_NOC        = #ETRT_NOC#        /* 추출건수 */
		     , ETRT_CLU_TXT    = #ETRT_CLU_TXT#    /* 추출항목내용  */
		     , FNL_USR_ID      = #FNL_USR_ID#      /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD# /* 최종거래부서코드 */
		     , FNL_MNU_ID      = #FNL_MNU_ID#      /* 최종메뉴ID */
		     , FNL_MDF_DH      = SYSDATE           /* 최종수정일시 */
		 WHERE YE = #YE#
		   AND SRNO = #SRNO#
	</update>
	
	<!-- 주요자료내역 삭제 -->
	<delete id="CSPBII812EMaindelete" parameterClass="paramMap">
		DELETE TBCSPBII800L
		 WHERE YE   = #YE#
		   AND SRNO = #SRNO#
	</delete>
	
	<!-- 주요자료내역 삭제 -->
	<delete id="CSPBII812EAttFildelete" parameterClass="paramMap">
		DELETE TBCSPBII801L
		 WHERE YE   = #YE#
		   AND SRNO = #SRNO#
	</delete>
</sqlMap> 
