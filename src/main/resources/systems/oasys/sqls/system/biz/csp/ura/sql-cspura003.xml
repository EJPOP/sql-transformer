<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/ura/003">

	<select id="CSPURA008EMainSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT    C.CSL_CMTR_REGI_YE
			        , C.CSL_CMTR_REGI_SLN
			        , C.CSL_CMTR_DVSN_NM
			        ,D1.CSL_CMTR_NAM
			        ,D1.CSL_YE
			        ,D1.APTM_DT
					,D1.DPT_NM
			        ,D1.PST_NM
			        ,D1.MAJ_SPH_NM
			        ,D1.COM_TNB
			        ,D1.HOM_TNB
			        ,D1.HPN
			        ,D1.FAN
			        ,D1.EML_AD
			        ,D1.ZCD AS ZCD
			        ,D1.ROAD_NM_AD
			        ,D1.AD
			        ,D1.ROAD_NM_DTL_AD
			        ,D1.DTL_AD
			        ,D1.REGN_CNB
			        ,D1.USE_YN
			        ,D1.CSL_CMTR_RMK
			        ,C.EXTL_EPRT_DVSN_CD
			FROM    (
			            SELECT  CSL_CMTR_REGI_YE,
			                    CSL_CMTR_REGI_SLN,
			                    AGGR_CONCAT( B.CD_NM, ', ') AS CSL_CMTR_DVSN_NM,
			                    AGGR_CONCAT( A.EXTL_EPRT_DVSN_CD, ', ') AS EXTL_EPRT_DVSN_CD
			            FROM     TBCSPURA006D A
			                    , TBDCMACM013C B
			            WHERE    A.EXTL_EPRT_DVSN_CD = B.CD
			            AND        B.CMM_CD_DVSN_CD = '1000265'
		]]>	
			<dynamic>
				<isNotEmpty property="strEXTL_EPRT_DVSN_CD">
					AND (A.CSL_CMTR_REGI_YE, A.CSL_CMTR_REGI_SLN) IN (SELECT 	CSL_CMTR_REGI_YE, CSL_CMTR_REGI_SLN
																		FROM	TBCSPURA006D Z 
																		WHERE	Z.EXTL_EPRT_DVSN_CD = #strEXTL_EPRT_DVSN_CD#) 
				</isNotEmpty>
			</dynamic>
		<![CDATA[
			            GROUP BY CSL_CMTR_REGI_YE,
			                    CSL_CMTR_REGI_SLN
			        ) C,
			        TBCSPURA005M D1
			WHERE 1=1
			AND	C.CSL_CMTR_REGI_YE = D1.CSL_CMTR_REGI_YE
			AND C.CSL_CMTR_REGI_SLN = D1.CSL_CMTR_REGI_SLN 
		]]>	
			<dynamic>
				<isNotEmpty property="CSL_YE">
				  	AND D1.CSL_YE = #CSL_YE#
				</isNotEmpty>
				<isNotEmpty property="CSL_CMTR_NAM">
					AND D1.CSL_CMTR_NAM like '%'||#CSL_CMTR_NAM#||'%'
				</isNotEmpty>				
				<isNotEmpty property="CSL_CMTR_RMK">
					AND D1.CSL_CMTR_RMK LIKE '%'||#CSL_CMTR_RMK#||'%'
				</isNotEmpty>
				<isNotEmpty property="DPT_NM">
					AND D1.DPT_NM LIKE '%'||#DPT_NM#||'%'
				</isNotEmpty>
			</dynamic>
		<![CDATA[
			ORDER BY CSL_YE DESC, C.CSL_CMTR_REGI_YE DESC, TO_NUMBER(C.CSL_CMTR_REGI_SLN) DESC
		]]>
	</select>
	
	<select id="CSPURA008ESubSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
				SELECT  B.EXTL_EPRT_DVSN_CD,
						B.CSL_CMTR_REGI_YE,
						B.CSL_CMTR_REGI_SLN,
						B.EXTL_EPRT_DVSN_SNO
				  FROM  TBCSPURA005M A,
				        TBCSPURA006D B
				 WHERE 1=1
				   AND  A.CSL_CMTR_REGI_YE  = B.CSL_CMTR_REGI_YE
				   AND	A.CSL_CMTR_REGI_SLN = B.CSL_CMTR_REGI_SLN
				   AND  A.CSL_CMTR_REGI_YE  = #CSL_CMTR_REGI_YE#
				   AND	A.CSL_CMTR_REGI_SLN = #CSL_CMTR_REGI_SLN#
				 ORDER BY B.CSL_CMTR_REGI_YE DESC, TO_NUMBER(B.CSL_CMTR_REGI_SLN) DESC, EXTL_EPRT_DVSN_CD DESC
		]]>
	</select>
	
	<!--  삭제시 디테일 조회 -->
	<select id="CSPURA008EsubCntselect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
				SELECT COUNT(CSL_CMTR_REGI_YE) as CNT 
				  FROM TBCSPURA006D 
				 WHERE CSL_CMTR_REGI_YE = #CSL_CMTR_REGI_YE# 
				   AND CSL_CMTR_REGI_SLN = #CSL_CMTR_REGI_SLN#
		]]>
	</select>
	
	<!--  외부전문가 관리 마스터 인서트(신규 시) -->
	<insert id="CSPURA008EMasterInsert" parameterClass="paramMap">
        <![CDATA[       
				INSERT INTO TBCSPURA005M 
				(
					CSL_CMTR_REGI_YE,
					CSL_CMTR_REGI_SLN,
					CSL_CMTR_NAM,
					CSL_YE,
					DPT_NM,
					PST_NM,
					MAJ_SPH_NM,
					COM_TNB,
					HOM_TNB,
					HPN,
					FAN,
					EML_AD,
					ZCD,
					ROAD_NM_AD,
					AD,
					ROAD_NM_DTL_AD,
					DTL_AD,
					REGN_CNB,
					USE_YN,
					APTM_DT,
					CSL_CMTR_RMK,
					FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH
				)
				VALUES
					(
					#CSL_CMTR_REGI_YE#,
					#CSL_CMTR_REGI_SLN#,
					#CSL_CMTR_NAM#,
					#CSL_YE#,
					#DPT_NM#,
					#PST_NM#,
					#MAJ_SPH_NM#,
					#COM_TNB#,
					#HOM_TNB#,
					#HPN#,
					#FAN#,
					#EML_AD#,
					#ZCD#,
					#ROAD_NM_AD#,
					#AD#,
					#ROAD_NM_DTL_AD#,
					#DTL_AD#,
					#REGN_CNB#,
					'Y',
					#APTM_DT#,
					#CSL_CMTR_RMK#,
					#FRT_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
					SYSDATE
				)
        ]]>
	</insert>
	
	<!--  외부전문가 관리 디테일 인서트(신규 시) -->	
	<insert id="CSPURA008EDetailInsert" parameterClass="paramMap">
        <![CDATA[       
		INSERT INTO TBCSPURA006D
				(
					CSL_CMTR_REGI_YE,
					CSL_CMTR_REGI_SLN,
					EXTL_EPRT_DVSN_SNO,
					EXTL_EPRT_DVSN_CD,
					FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH
				)
				VALUES
				(
					#CSL_CMTR_REGI_YE#,
					#CSL_CMTR_REGI_SLN#,
				    (SELECT NVL(MAX(TO_NUMBER(EXTL_EPRT_DVSN_SNO)+1), 1) 
	        		   FROM TBCSPURA006D
					  WHERE CSL_CMTR_REGI_YE = #CSL_CMTR_REGI_YE#
						AND	CSL_CMTR_REGI_SLN = #CSL_CMTR_REGI_SLN#),   /*순번 */
					#EXTL_EPRT_DVSN_CD2#,
					#FNL_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
					SYSDATE
				)
        ]]>
	</insert>
	
	<!--  마스터 삭제  -->
	<delete id="CSPURA008EDelete" parameterClass="paramMap">
			DELETE FROM TBCSPURA005M
			 WHERE CSL_CMTR_REGI_YE = #CSL_CMTR_REGI_YE#
			   AND CSL_CMTR_REGI_SLN = #CSL_CMTR_REGI_SLN#
	</delete>
	
	<!--  디테일 삭제  -->
	<delete id="CSPURA008EDetailDelete" parameterClass="paramMap">
			DELETE FROM TBCSPURA006D
			 WHERE CSL_CMTR_REGI_YE = #CSL_CMTR_REGI_YE#
			   AND CSL_CMTR_REGI_SLN = #CSL_CMTR_REGI_SLN#
	</delete>
	
	
	<!-- 마스터 업데이트 -->
	<update id="CSPURA008EUpdate" parameterClass="paramMap">
			UPDATE TBCSPURA005M
			SET FNL_MDF_DH = SYSDATE
			<isNotNull prepend="," property="CSL_YE">
				CSL_YE = #CSL_YE#
			</isNotNull>
			<isNotNull prepend="," property="APTM_DT">
				APTM_DT = #APTM_DT#
			</isNotNull>
			<isNotNull prepend="," property="CSL_CMTR_NAM">
				CSL_CMTR_NAM = #CSL_CMTR_NAM#
			</isNotNull>
			<isNotNull prepend="," property="DPT_NM">
				DPT_NM = #DPT_NM# 
			</isNotNull>
			<isNotNull prepend="," property="PST_NM">
				PST_NM = #PST_NM#
			</isNotNull>
			<isNotNull prepend="," property="MAJ_SPH_NM">
				MAJ_SPH_NM = #MAJ_SPH_NM#
			</isNotNull>
			<isNotNull prepend="," property="COM_TNB">
				COM_TNB = #COM_TNB# 
			</isNotNull>
			<isNotNull prepend="," property="HOM_TNB">
				HOM_TNB = #HOM_TNB# 
			</isNotNull>
			<isNotNull prepend="," property="HPN">
				HPN = #HPN# 
			</isNotNull>
			<isNotNull prepend="," property="FAN">
				FAN = #FAN# 
			</isNotNull>
			<isNotNull prepend="," property="EML_AD">
				EML_AD = #EML_AD#
			</isNotNull>
			<isNotNull prepend="," property="ZCD">
				ZCD = #ZCD#
			</isNotNull>
			<isNotNull prepend="," property="ROAD_NM_AD">
				ROAD_NM_AD = #ROAD_NM_AD#
			</isNotNull>
			<isNotNull prepend="," property="ROAD_NM_DTL_AD">
				ROAD_NM_DTL_AD = #ROAD_NM_DTL_AD# 
			</isNotNull>
			<isNotNull prepend="," property="AD">
				AD = #AD# 
			</isNotNull>
			<isNotNull prepend="," property="DTL_AD">
				DTL_AD = #DTL_AD# 
			</isNotNull>			
			<isNotNull prepend="," property="CSL_CMTR_RMK">
				CSL_CMTR_RMK = #CSL_CMTR_RMK# 
			</isNotNull>
			<isNotNull prepend="," property="FNL_USR_ID">
				FNL_USR_ID = #FNL_USR_ID#
			</isNotNull>
			<isNotNull prepend="," property="FNL_DEAL_DPT_CD">
				FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
			</isNotNull>
			<isNotNull prepend="," property="FNL_MNU_ID">
				FNL_MNU_ID =#FNL_MNU_ID#
			</isNotNull>
			WHERE CSL_CMTR_REGI_YE = #CSL_CMTR_REGI_YE#
			  AND CSL_CMTR_REGI_SLN = #CSL_CMTR_REGI_SLN#
	</update>
	
	<!-- 디테일 업데이트 -->
	<update id="CSPURA008EDetailUpdate" parameterClass="paramMap">
			UPDATE TBCSPURA006D
			SET FNL_MDF_DH = SYSDATE
			<isNotNull prepend="," property="EXTL_EPRT_DVSN_CD">
				EXTL_EPRT_DVSN_CD = #EXTL_EPRT_DVSN_CD#
			</isNotNull>
			<isNotNull prepend="," property="FNL_USR_ID">
				FNL_USR_ID = #FNL_USR_ID#
			</isNotNull>
			<isNotNull prepend="," property="FNL_DEAL_DPT_CD">
				FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
			</isNotNull>
			<isNotNull prepend="," property="FNL_MNU_ID">
				FNL_MNU_ID =#FNL_MNU_ID#
			</isNotNull>
			WHERE CSL_CMTR_REGI_YE = #CSL_CMTR_REGI_YE#
			  AND CSL_CMTR_REGI_SLN = #CSL_CMTR_REGI_SLN#
			  AND EXTL_EPRT_DVSN_SNO = #EXTL_EPRT_DVSN_SNO#
	</update>
	
	<select id="CSPURA008EKeySelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT
				(SELECT TO_CHAR(SYSDATE, 'YYYY') FROM DUAL) AS YYYY, 			/* 연도 */
				(SELECT TO_CHAR(NVL(MAX(TO_NUMBER(CSL_CMTR_REGI_SLN)+1), 1) ) 	/* 연번 */
				   FROM TBCSPURA005M   									
				 WHERE CSL_CMTR_REGI_YE = TO_CHAR(SYSDATE, 'YYYY') ) AS SLN 
			 FROM DUAL
		]]>
	</select>
	
</sqlMap> 
