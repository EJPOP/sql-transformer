<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="aep/gkm/023">
	<select id="AEPGKM023Emainselect" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT  EVL_CLU_CD
		       ,EVL_CLU_NM
		       ,EVL_TXT
		       ,NVL(MIN_SC, 0) AS MIN_SC
		       ,MAX_SC
		       ,USE_YN
		       ,(SELECT	CASE
		       				WHEN COUNT(1) > 0
		       				THEN 'N'
		       				ELSE 'Y'
		       			END
		       FROM		TBAEPGKM010L
		       WHERE	EVL_CLU_CD = A.EVL_CLU_CD) AS DML_YN
		FROM    TBAEPGKM008M AS A
		WHERE   1=1
		<isNotEmpty property="USE_YN" prepend="AND">
				USE_YN = #USE_YN#
		</isNotEmpty>
		ORDER BY EVL_CLU_CD
	</select>
	
	<select id="AEPGKM023Esubselect" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT  EVL_CLU_CD
		       ,EVL_RK_CD
		       ,EVL_RK_NM
		       ,EVL_SC
		       ,USE_YN
		      ,(SELECT	CASE
		       				WHEN COUNT(1) > 0
		       				THEN 'N'
		       				ELSE 'Y'
		       			END
		       FROM		TBAEPGKM010L
		       WHERE	EVL_CLU_CD = A.EVL_CLU_CD) AS DML_YN
		FROM    TBAEPGKM009D AS A
		WHERE   1=1
		<isNotEmpty property="EVL_CLU_CD" prepend="AND">
				EVL_CLU_CD = #EVL_CLU_CD#
		</isNotEmpty>
		ORDER BY EVL_SC
	</select>
	
	<select id="AEPGKM023Eclucdselect" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT	NVL(MAX(EVL_CLU_CD), 0) + 1 AS EVL_CLU_CD
		FROM	TBAEPGKM008M
	</select>
	<insert id="AEPGKM023Emaininsert" parameterClass="java.util.Map">
		INSERT INTO TBAEPGKM008M
		(
		EVL_CLU_CD 	/* 평가항목코드  */
		,EVL_CLU_NM	/* 평가항목명 */
		,EVL_TXT	/* 평가내용 */
		,MIN_SC	/* 최소점수 */
		,MAX_SC	/* 최대점수 */
		,USE_YN	/* 사용여부 */
		,FRT_USR_ID	/* 최초사용자ID */
		,FNL_USR_ID	/* 최종사용자ID */
		,FNL_DEAL_DPT_CD	/* 최종거래부서코드 */
		,FNL_MNU_ID	/* 최종메뉴ID */
		,FRT_REGI_DH	/* 최초등록일시 */
		,FNL_MDF_DH	/* 최종수정일시 */
		)
		VALUES
		(
		#EVL_CLU_CD#
		, #EVL_CLU_NM#
		, #EVL_TXT#
		, #MIN_SC#
		, #MAX_SC#
		, #USE_YN#
		, #FRT_USR_ID#
		, #FNL_USR_ID#
		, #FNL_DEAL_DPT_CD#
		, #FNL_MNU_ID#
		, SYSDATE
		, SYSDATE
		)
		
	</insert>
	<insert id="AEPGKM023Esubinsert" parameterClass="java.util.Map">
		INSERT INTO TBAEPGKM009D
		(
		EVL_CLU_CD 	/* 평가항목코드  */
		,EVL_RK_CD	/* 평가등급코드 */
		,EVL_RK_NM	/* 평가등급명 */
		,EVL_SC	/* 평가점수 */
		,USE_YN	/* 사용여부 */
		,FRT_USR_ID	/* 최초사용자ID */
		,FNL_USR_ID	/* 최종사용자ID */
		,FNL_DEAL_DPT_CD	/* 최종거래부서코드 */
		,FNL_MNU_ID	/* 최종메뉴ID */
		,FRT_REGI_DH	/* 최초등록일시 */
		,FNL_MDF_DH	/* 최종수정일시 */
		)
		VALUES	
		(
		#EVL_CLU_CD#
		,(SELECT NVL(MAX(EVL_RK_CD), 0) + 1 FROM TBAEPGKM009D WHERE EVL_CLU_CD = #EVL_CLU_CD#)
		,#EVL_RK_NM#
		,#EVL_SC#
		,#USE_YN#
		,#FRT_USR_ID#
		,#FNL_USR_ID#
		,#FNL_DEAL_DPT_CD#
		,#FNL_MNU_ID#
		,SYSDATE
		,SYSDATE
		)
	</insert>
	<update id="AEPGKM023Emainupdate" parameterClass="java.util.Map">
		UPDATE	TBAEPGKM008M
		SET		EVL_CLU_NM = #EVL_CLU_NM#,
				EVL_TXT = #EVL_TXT#,
				MIN_SC = #MIN_SC#,
				MAX_SC = #MAX_SC#,
				USE_YN = #USE_YN#,
				FNL_USR_ID = #FNL_USR_ID#,
				FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
				FNL_MNU_ID = #FNL_MNU_ID#,
				FNL_MDF_DH = SYSDATE
		WHERE	EVL_CLU_CD = #EVL_CLU_CD#
	</update>
	
	<update id="AEPGKM023Esubupdate" parameterClass="java.util.Map">
		UPDATE	TBAEPGKM009D
		SET		EVL_RK_NM = #EVL_RK_NM#,
				EVL_SC = #EVL_SC#,
				USE_YN = #USE_YN#,
				FNL_USR_ID = #FNL_USR_ID#,
				FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
				FNL_MNU_ID = #FNL_MNU_ID#,
				FNL_MDF_DH = SYSDATE
		WHERE	EVL_CLU_CD = #EVL_CLU_CD#
		AND		EVL_RK_CD = #EVL_RK_CD#
	</update>
	
	<delete id="AEPGKM023Emaindelete" parameterClass="java.util.Map">
		DELETE FROM TBAEPGKM008M
		WHERE EVL_CLU_CD = #EVL_CLU_CD#
	</delete>
	
	<!-- 평가항목기본 삭제하기전 자식테이블에 데이터가 있는지 체크 -->
	<select id="AEPGKM023ECntdelete" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT TO_CHAR(COUNT(*)) AS CNT
			  FROM TBAEPGKM009D
			 WHERE 1 = 1
			   AND EVL_CLU_CD = #EVL_CLU_CD#
		]]>
	</select>
	
	<delete id="AEPGKM023Esubdelete" parameterClass="java.util.Map">
		DELETE FROM TBAEPGKM009D
		WHERE EVL_CLU_CD = #EVL_CLU_CD#
		AND EVL_RK_CD = #EVL_RK_CD#
	</delete>
	
	<!-- 변경여부 체크 -->
	<select id="AEPGKM023Emodifycheck" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT  B.EVL_CLU_CD
				,MAX(DTM_YN) AS DTM_YN
				,COUNT(C.EVL_CLU_CD) AS USE_CNT
		FROM    TBAEPGKM011M AS A,
		        TBAEPGKM010L AS B,
		        TBAEPGKM016L AS C
		WHERE   A.EVL_YR = B.EVL_YR
		AND     A.EVL_DVSN_CD = B.EVL_DVSN_CD
		AND     B.EVL_YR = C.EVL_YR (+)
		AND     B.EVL_DVSN_CD = C.EVL_DVSN_CD (+)
		AND     B.EVL_CLU_CD = C.EVL_CLU_CD (+)
		AND     B.EVL_CLU_CD = #EVL_CLU_CD#
		GROUP BY B.EVL_CLU_CD
	</select>
</sqlMap>

