<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/cor/105">
 	
 	<select id="CSPCOR105QMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	T1.CORR_DVSN_CD
					,T1.ACP_YR
					,T1.CORR_ACP_NO
					,DECODE(T1.RM_CORR_ACP_NO,NULL,NULL,T1.ACP_YR||'-부감-'||T1.RM_CORR_ACP_NO) AS ACP_NO
					,T1.NAM
					,CASE WHEN ( SELECT COUNT(*)
					               FROM TBCSPCOR107L S1
					              WHERE T1.CORR_DVSN_CD = S1.CORR_DVSN_CD
					                AND T1.ACP_YR = S1.ACP_YR
					                AND T1.CORR_ACP_NO = S1.CORR_ACP_NO
					           ) > 0 
					      THEN T1.TIT_NM||'(합건 : '|| ( SELECT AGGR_CONCAT(S2.ACP_YR||'-부감-'||S2.RM_CORR_ACP_NO,',')||')'
					                                     FROM TBCSPCOR107L S1
					                                         ,TBCSPCOR101M S2
					                                    WHERE T1.CORR_DVSN_CD = S1.CORR_DVSN_CD
					                                      AND T1.ACP_YR = S1.ACP_YR
					                                      AND T1.CORR_ACP_NO = S1.CORR_ACP_NO
					                                      AND S1.SUC_CORR_DVSN_CD = S2.CORR_DVSN_CD
					                                      AND S1.SUC_ACP_YR = S2.ACP_YR
					                                      AND S1.SUC_CORR_ACP_NO = S2.CORR_ACP_NO 
					                                 )
					      ELSE T1.TIT_NM END TIT_NM
					,TO_CHAR(T1.ACP_DH,'YYYY-MM-DD HH24:MI') AS ACP_DH
					,T1.ACP_RUT_CD
					,F_CODE_NM('1000885',T1.ACP_RUT_CD) AS ACP_RUT_NM
					,T1.HNDL_STA_CD
					,F_CODE_NM('1000886',T1.HNDL_STA_CD) AS HNDL_STA_NM
					,T1.RM_CORR_ACP_NO
					,T1.TNB
					,TO_CHAR(T2.DTB_DH,'YYYY-MM-DD') AS DTB_DH
					,F_DPT_INFO(T2.HNDL_DPT_CD,'1') AS HNDL_DPT_NM
					,T2.HNDL_DPT_CD
					,F_USR_INFO_BY_ID(T2.HNDL_CHGR_ID,'2') AS HNDL_CHGR_NM
					,T2.HNDL_CHGR_ID
					,T1.EIN
					,TO_CHAR(TO_DATE(T1.HNDL_DDLN_DT),'YYYY-MM-DD') AS HNDL_DDLN_DT
					,T2.INSPC_DPT_CD
					,F_DPT_INFO(T2.INSPC_DPT_CD,'1') AS INSPC_DPT_NM
					,T2.INSPC_CHGR_ID
					,F_USR_INFO_BY_ID(T2.INSPC_CHGR_ID,'2') AS INSPC_CHGR_NM
					,TO_CHAR(T1.HNDL_DH,'YYYY-MM-DD') AS HNDL_DH
			FROM	TBCSPCOR101M T1
			       ,TBCSPCOR104M T2
			WHERE	T1.CORR_DVSN_CD = '1'
			  AND   T1.CORR_DVSN_CD = T2.CORR_DVSN_CD(+)
			  AND   T1.ACP_YR = T2.ACP_YR(+)
			  AND   T1.CORR_ACp_NO = T2.CORR_ACP_NO(+)
			  AND   T1.HNDL_STA_CD NOT IN ('10','20','25')
			  AND   (T1.CORR_DVSN_CD, T1.ACP_YR, T1.CORR_ACP_NO) NOT IN ( SELECT S1.SUC_CORR_DVSN_CD, S1.SUC_ACP_YR, S1.SUC_CORR_ACP_NO
			                                                                FROM TBCSPCOR107L S1
			                                                            )
		]]>
		<dynamic>
			<isNotEmpty property="strACP_YR">
				AND	T1.ACP_YR = #strACP_YR#
			</isNotEmpty>
			<isNotEmpty property="strRM_CORR_ACP_NO">
				AND	T1.RM_CORR_ACP_NO = #strRM_CORR_ACP_NO#
			</isNotEmpty>
			<isNotEmpty property="strACP_DHS">
				AND	TO_CHAR(T1.ACP_DH,'YYYYMMDD') &gt;= #strACP_DHS#
			</isNotEmpty>
			<isNotEmpty property="strACP_DHE">
				AND	TO_CHAR(T1.ACP_DH,'YYYYMMDD') &lt;= #strACP_DHE#
			</isNotEmpty>
			<isNotEmpty property="strHNDL_STA_CD">
				AND	T1.HNDL_STA_CD = #strHNDL_STA_CD#
			</isNotEmpty>
			<isNotEmpty property="strNAM">
				AND	T1.NAM LIKE '%'||#strNAM#||'%'
			</isNotEmpty>
			<isNotEmpty property="strTIT_NM">
				AND	T1.TIT_NM LIKE '%'||#strTIT_NM#||'%'
			</isNotEmpty>
			<isNotEmpty property="strHMP_APL_NO">
				AND	T1.HMP_APL_NO = #strHMP_APL_NO#
			</isNotEmpty>
			<isNotEqual property="strUSR_ID" compareValue="project08">
				<isNotEqual property="strUSR_ID" compareValue="huimangdo">
				AND T2.HNDL_DPT_CD = #strDPT_CD#
				AND T2.HNDL_CHGR_ID = #strUSR_ID#
			</isNotEqual>
			</isNotEqual>
			<isEqual property="strRESULT_YN" compareValue="Y">
				AND T1.HNDL_STA_CD IN ('90','100')
			</isEqual>
			<isEqual property="strRESULT_YN" compareValue="N">
				AND T1.HNDL_STA_CD NOT IN ('90','100')
			</isEqual>
			
		</dynamic>
		<![CDATA[
			ORDER BY T1.ACP_YR DESC,TO_NUMBER(T1.RM_CORR_ACP_NO) DESC
		]]>
	</select>
	
</sqlMap> 
