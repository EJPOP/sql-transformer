<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/cis/201">


	<select id="CSPCIS201QSysDateSelect" resultClass="resultMap">
 	<![CDATA[
 	SELECT TO_CHAR(SYSDATE, 'YYYYMMDD') AS ENDDT,
    	   TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE, -12), 'dd'), 'YYYYMMDD') AS STARTDT
  	FROM DUAL
 	]]>
 	</select>
 	
 	<select id="CSPCIS201QSelectMain" parameterClass="paramMap" resultClass="resultMap">
<![CDATA[
			SELECT TO_CHAR(WRIT_DH, 'YYYY-MM-DD') AS WRIT_DH
			      ,SUBSTR(WRIT_DH,1,4)||'-'||SRNO AS Y_SNO
			      ,SNO
			      ,NAM
			      ,TNB
			      ,CRPT_TYP_NM
			      ,INSP_TXT
			      ,DOC_ID
			      ,DOC_TYP_CD
			      ,EXAM_TXT
			      ,TIT_NM
			      ,HNDL_STEP_CD
			      ,F_CODE_NM('1000658', HNDL_STEP_CD) AS HNDL_STEP_NM
			      ,FIN_DH
			  FROM TBCSPCIS002M
			 WHERE 1=1
			]]>
			<dynamic>
				<isNotEmpty property="ACP_DH_START" >
					<isNotEmpty property="ACP_DH_END" >
						AND TO_CHAR(WRIT_DH, 'YYYYMMDD') BETWEEN #ACP_DH_START# AND #ACP_DH_END#
					</isNotEmpty>
				</isNotEmpty>
				<isNotEmpty property="FIN_DH_ST" >
					AND	FIN_DH >= #FIN_DH_ST#
					<isNotEmpty property="FIN_DH_END" >
						AND	FIN_DH BETWEEN #FIN_DH_ST# AND #FIN_DH_END#
					</isNotEmpty>
				</isNotEmpty>
				<isNotEmpty property="CD">
						AND HNDL_STEP_CD = #CD#
				</isNotEmpty>
				<isNotEmpty property="NAME">
						AND NAM LIKE '%'|| #NAME# ||'%'
				</isNotEmpty>
				<isNotEmpty property="TITLE">
						AND TIT_NM LIKE '%'|| #TITLE# ||'%'
				</isNotEmpty>
				<isNotEmpty property="CRPT_TYP_NM">
						AND CRPT_TYP_NM LIKE '%'|| #CRPT_TYP_NM# ||'%'
				</isNotEmpty>
				
			</dynamic>
		<![CDATA[			
				ORDER BY WRIT_DH DESC
		]]>
</select>
	
	 
	<insert id="CSPCIS201QINSPIS001" parameterClass="paramMap">
	<![CDATA[
	  INSERT INTO TBCSPCIS002M(
				       WRIT_DH
				      ,SNO
				      ,NAM
				      ,CRPT_TYP_NM
				      ,INSP_TXT
				      ,DOC_ID
				      ,TIT_NM
				      ,HNDL_STEP_CD
				      ,TNB
				  )
				  VALUES
				  (
				       TO_CHAR(TO_DATE(SUBSTR(#WRIT_DH#, 0, 8)), 'YYYYMMDDHH24MISS')
				      ,(SELECT NVL(MAX(SNO),0) + 1 FROM TBCSPCIS002M)
				      ,#NAM#
				      ,#CRPT_TYP_NM#
				      ,#INSP_TXT#
				      ,#DOC_ID#
				      ,#TIT_NM#
				      ,'01'
				      ,#HPN#
				  )
	]]>
	</insert>
	
	<select id="CSPCIS201QMaxSno" resultClass="resultMap">
	<![CDATA[
		SELECT NVL(MAX(SNO), 0) + 1 AS MAXSNO
  	      FROM TBCSPCIS002M
	]]>
	</select>
	
	<update id="CSPCIS201QUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE TBCSPCIS002M
	       SET EXAM_TXT     = #EXAM_TXT#
	          ,HNDL_STEP_CD = #HNDL_STEP_CD#
	          ,FIN_DH		= CASE WHEN #HNDL_STEP_CD# = '01' THEN NULL 
	          				WHEN FIN_DH IS NOT NULL THEN FIN_DH 
	          				ELSE TO_CHAR(SYSDATE,'YYYYMMDD') END 
	     WHERE 1=1
	       AND SNO = #SNO#
	]]>
	</update>
 	
	<insert id="CSPCIS201QReceiveInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO	TBCSPCIS002M
					(	WRIT_DH
						,SNO
						,NAM
						,CRPT_TYP_NM
						,INSP_TXT
						,DOC_ID
						,TIT_NM
						,HNDL_STEP_CD
						,TNB
					)
			VALUES	(	#WRIT_DH#
						,#SNO#
						,#NAM#
						,#CRPT_TYP_NM#
						,#INSP_TXT#
						,''
						,#TIT_NM#
						,'01'
						,#HPN#
					)
		]]>
	</insert>
 	
</sqlMap> 
