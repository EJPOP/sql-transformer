<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/mwf/026">
	
	<!-- 예약신청가능 시간 체크 -->
	<select id="CSPMWF026EBokgAplPossDtTmSelect" parameterClass="paramMap" resultClass="String">
		<![CDATA[
		  	WITH BASE_DATE_CTE AS (SELECT 
								        CASE 
								            WHEN TO_CHAR(SYSDATE , 'YYYYMMDD') = '20250814' THEN SYSDATE + 1
								            ELSE SYSDATE
								        END AS BASE_DATE
								     FROM DUAL
								   ) ,
                         DATE_RANGE_CTE AS ( 
                              SELECT TO_CHAR(LEVEL - 1 + (SELECT NEXT_DAY(BASE_DATE,6) - 7 FROM DUAL), 'YYYYMMDD') AS DT 
                                    FROM DUAL , BASE_DATE_CTE
                                 CONNECT BY LEVEL <= 7
                                   )
		     
           SELECT CASE WHEN CURR_DT BETWEEN STR_DT AND END_DT THEN 'Y' 
                       ELSE 'N' 
                   END                 AS YN
             FROM (
                     SELECT MIN(DT) || '090000'                  AS STR_DT
                           ,MAX(DT) || '110000'                  AS END_DT
                           ,(SELECT TO_CHAR(BASE_DATE, 'YYYYMMDDHH24MISS') FROM BASE_DATE_CTE) AS CURR_DT
                       FROM DATE_RANGE_CTE 
                  )
		]]>
	</select>
	
	<!-- 예약신청일시 채번 -->
	<select id="CSPMWF026EBokgAplDhSelect" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDHH24MISSFF6') AS BOKG_APL_DH
			  FROM DUAL
		]]>
	</select>
	
	<!-- 한의과예약방문 입력 -->
	<insert id="CSPMWF026EvisitPpsInsert" parameterClass="paramMap">
        <![CDATA[       
				INSERT INTO TBCSPMWF007M
				(
					 BOKG_APL_DH
					,VI_PPS_DVSN_CD
					,TRTMT_FNDT_TXT
					,TRTMT_NBC_CD
					,CNB
					,DPT_CD					
					,FRT_USR_ID
					,FNL_USR_ID
					,FNL_DEAL_DPT_CD
					,FNL_MNU_ID
					,FRT_REGI_DH
					,FNL_MDF_DH 
				)
				VALUES
				(
					 #BOKG_APL_DH#
					,#VI_PPS_DVSN_CD#
					,#TRTMT_FNDT_TXT#
					,#TRTMT_NBC_CD#
					,#CNB#
					,#DPT_CD#	
					,#FRT_USR_ID#
					,#FNL_USR_ID#
					,#FNL_DEAL_DPT_CD#
					,#FNL_MNU_ID#
					,SYSDATE					
					,SYSDATE
				)
        ]]>
	</insert>	
	
	<!-- 그리드 헤더값 -->
	<select id="CSPMWF026EHeaderSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[ 
					/* 특정일 기준으로 계산에 필요한 날짜 계산 */
					WITH BASE_DATE_CTE AS (SELECT 
								        CASE 
								            WHEN #strStdDt# = '20250814' THEN TO_DATE('20250814' , 'YYYYMMDD') + 1
								            ELSE TO_DATE(#strStdDt# , 'YYYYMMDD')
								        END AS BASE_DATE
								     FROM DUAL)
			
                   SELECT DT                                      AS DT
                         ,TO_CHAR(TO_DATE(DT), 'YYYY-MM-DD')                     || '(' || 
                          TO_CHAR(TO_DATE(DT), 'DY', 'NLS_DATE_LANGUAGE=korean') || ')'
                                                                  AS YOIL                              
                         ,CASE WHEN (SELECT COUNT(1) FROM TBBADDED013B WHERE YE || MD = T1.DT) > 0 THEN 'Y'
                               WHEN (SELECT COUNT(1) FROM TBCSPMWF011M WHERE HLDY     = T1.DT AND BOKG_DVSN_CD = '1') > 0 THEN 'Y'  /* 임시휴일 적용 - 2019.07.29 yyh */ 
                               ELSE 'N' 
                           END                                    AS HOLIDAY_YN
                   FROM (
                           SELECT TO_CHAR(LEVEL + 2 + (SELECT NEXT_DAY(TO_DATE(BASE_DATE_CTE.BASE_DATE), 6) - 7 FROM DUAL), 'YYYYMMDD') AS DT     
						  FROM
						    BASE_DATE_CTE , 
						   DUAL     
						   CONNECT BY LEVEL <= 5
                        ) T1
                  ORDER BY DT 
		]]>
	</select>
		
	<!-- 날짜별 시간표 조회 -->
	<select id="CSPMWF026EMainSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[  	   
                   WITH
                   /* 특정일 기준으로 계산에 필요한 날짜 계산 */       
                   BASE_DATE_CTE AS (SELECT 
								        CASE
								            WHEN #strStdDt# = '20250814' THEN TO_DATE('20250814' , 'YYYYMMDD') + 1
								            ELSE TO_DATE(#strStdDt# , 'YYYYMMDD') 
								        END AS BASE_DATE
								     FROM DUAL) ,  
                   DAY_TABLE AS 
                   (
                       SELECT TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 4 + DT, 'YYYYMMDD') AS STD_DAY1 /*월*/
                             ,TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 3 + DT, 'YYYYMMDD') AS STD_DAY2 /*화*/
                             ,TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 2 + DT, 'YYYYMMDD') AS STD_DAY3 /*수*/
                             ,TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 1 + DT, 'YYYYMMDD') AS STD_DAY4 /*목*/
                             ,TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 0 + DT, 'YYYYMMDD') AS STD_DAY5 /*금*/
                         FROM (
                              SELECT (SELECT NEXT_DAY(TO_DATE(BASE_DATE_CTE.BASE_DATE), 6) - TO_DATE(BASE_DATE_CTE.BASE_DATE) FROM DUAL) AS DT 
                                FROM DUAL , BASE_DATE_CTE                
                              )  , BASE_DATE_CTE  
                    )
                    
                    SELECT T1.BOKG_DVSN_CD                                                                                      AS BOKG_DVSN_CD 
					      ,T1.SCO_HST_SNO                                                                                       AS SCO_HST_SNO
					      ,T1.SCO_SNO                                                                                           AS SCO_SNO
					      ,SUBSTR(T1.SCO_TM_STR_CD,0,2) || ':' || SUBSTR(T1.SCO_TM_STR_CD,3) || ' ~ ' || 
					       SUBSTR(T1.SCO_TM_END_CD,0,2) || ':' || SUBSTR(T1.SCO_TM_END_CD,3)                                    AS SCO_TM_NM
					      ,T1.SCO_TM_STR_CD                                                                                     AS SCO_TM_STR_CD
					      ,T1.SCO_TM_END_CD                                                                                     AS SCO_TM_END_CD
					      ,T1.APC_STR_DT                                                                                        AS APC_STR_DT
					      ,T1.APC_END_DT                                                                                        AS APC_END_DT
        ]]>    
                          /* 월 */
                          ,STD_DAY1                                                                                             AS STD_DAY1
                          ,(SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END
                              FROM (
                                     SELECT YE || MD AS DT FROM TBBADDED013B
                                     UNION ALL
                                     SELECT HLDY     AS DT FROM TBCSPMWF011M WHERE BOKG_DVSN_CD = '1'
                                   ) 
                             WHERE DT = T2.STD_DAY1)                                                                            AS HOLIDAY1   /* 임시휴일 적용 - 2019.07.29 yyh */
                          ,(SELECT BOKG_PEN_CNB
                              FROM TBCSPMWF008M
                             WHERE BOKG_DT     = T2.STD_DAY1
                               AND SCO_HST_SNO = T1.SCO_HST_SNO
                               AND SCO_SNO     = T1.SCO_SNO)                                                                    AS BOKG_CNB1
                    <isEqual property="strAdminYn" compareValue="Y">    
							/* 관리자 */                           
                          ,(SELECT C.ABR_DPT_NM_1 || ' ' || F_CODE_NM('1000173', B.RANK_CD)  || ' ' || B.USR_NAM || ' ' || B.TNB
                              FROM TBCSPMWF008M A
                                  ,TBDCMACM001M B
                                  ,TBDCMACM002M C
                             WHERE A.BOKG_DT      = T2.STD_DAY1
                               AND A.SCO_HST_SNO  = T1.SCO_HST_SNO
                               AND A.SCO_SNO      = T1.SCO_SNO
                               AND A.BOKG_PEN_CNB = B.CNB
                               AND B.DPT_CD       = C.DPT_CD)                                                                   AS BOKG_NM1    
					</isEqual>
					<isEqual property="strAdminYn" compareValue="N">
							/* 사용자 */
                            /* ,CASE WHEN SCO_SNO BETWEEN 1 AND 4 THEN '신규 환자 진료시간'     
                                ELSE '' 
                            END */
                            , ''                                                                                                AS BOKG_NM1                                  
					</isEqual>                                
                          
                          /* 화 */
                          ,STD_DAY2                                                                                             AS STD_DAY2
                          ,(SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END
                              FROM (
                                     SELECT YE || MD AS DT FROM TBBADDED013B
                                     UNION ALL
                                     SELECT HLDY     AS DT FROM TBCSPMWF011M WHERE BOKG_DVSN_CD = '1'
                                   ) 
                             WHERE DT = T2.STD_DAY2)                                                                            AS HOLIDAY2   /* 임시휴일 적용 - 2019.07.29 yyh */ 
                          ,(SELECT BOKG_PEN_CNB
                              FROM TBCSPMWF008M
                             WHERE BOKG_DT     = T2.STD_DAY2
                               AND SCO_HST_SNO = T1.SCO_HST_SNO
                               AND SCO_SNO     = T1.SCO_SNO)                                                                    AS BOKG_CNB2 
		                           
		
					<isEqual property="strAdminYn" compareValue="Y">    
							/* 관리자 */                           
                          ,(SELECT C.ABR_DPT_NM_1 || ' ' || F_CODE_NM('1000173', B.RANK_CD)  || ' ' || B.USR_NAM || ' ' || B.TNB
                              FROM TBCSPMWF008M A
                                  ,TBDCMACM001M B
                                  ,TBDCMACM002M C
                             WHERE A.BOKG_DT      = T2.STD_DAY2
                               AND A.SCO_HST_SNO  = T1.SCO_HST_SNO
                               AND A.SCO_SNO      = T1.SCO_SNO
                               AND A.BOKG_PEN_CNB = B.CNB
                               AND B.DPT_CD       = C.DPT_CD)                                                                   AS BOKG_NM2    
					</isEqual>
					<isEqual property="strAdminYn" compareValue="N">
							/* 사용자 */
                            /* ,CASE WHEN SCO_SNO BETWEEN 1 AND 4 THEN '신규 환자 진료시간'     
                                ELSE '' 
                            END */
                            , ''                                                                                                AS BOKG_NM2                                  
					</isEqual>
					                          
                          /* 수 */                     
                          ,STD_DAY3                                                                                             AS STD_DAY3
                          ,(SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END
                              FROM (
                                     SELECT YE || MD AS DT FROM TBBADDED013B
                                     UNION ALL
                                     SELECT HLDY     AS DT FROM TBCSPMWF011M WHERE BOKG_DVSN_CD = '1'
                                   ) 
                             WHERE DT = T2.STD_DAY3)                                                                            AS HOLIDAY3   /* 임시휴일 적용 - 2019.07.29 yyh */                           
                          ,(SELECT BOKG_PEN_CNB
                              FROM TBCSPMWF008M
                             WHERE BOKG_DT     = T2.STD_DAY3
                               AND SCO_HST_SNO = T1.SCO_HST_SNO
                               AND SCO_SNO     = T1.SCO_SNO)                                                                    AS BOKG_CNB3  
                               
					<isEqual property="strAdminYn" compareValue="Y">
							/* 관리자 */ 					                                                                                      
                          ,(SELECT C.ABR_DPT_NM_1 || ' ' || F_CODE_NM('1000173', B.RANK_CD)  || ' ' || B.USR_NAM || ' ' || B.TNB
                              FROM TBCSPMWF008M A
                                  ,TBDCMACM001M B
                                  ,TBDCMACM002M C
                             WHERE A.BOKG_DT      = T2.STD_DAY3
                               AND A.SCO_HST_SNO  = T1.SCO_HST_SNO
                               AND A.SCO_SNO      = T1.SCO_SNO
                               AND A.BOKG_PEN_CNB = B.CNB
                               AND B.DPT_CD       = C.DPT_CD)                                                                   AS BOKG_NM3 
					</isEqual>
					<isEqual property="strAdminYn" compareValue="N">
							/* 사용자 */
                            /* ,CASE WHEN SCO_SNO BETWEEN 1 AND 4 THEN '신규 환자 진료시간'     
                                ELSE '' 
                            END */
                            , ''                                                                                                AS BOKG_NM3                                  
					</isEqual>                               
                                                      
                          /* 목 */                             
                          ,STD_DAY4                                                                                             AS STD_DAY4
                          ,(SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END
                              FROM (
                                     SELECT YE || MD AS DT FROM TBBADDED013B
                                     UNION ALL
                                     SELECT HLDY     AS DT FROM TBCSPMWF011M WHERE BOKG_DVSN_CD = '1'
                                   ) 
                             WHERE DT = T2.STD_DAY4)                                                                            AS HOLIDAY4   /* 임시휴일 적용 - 2019.07.29 yyh */                           
                          ,(SELECT BOKG_PEN_CNB
                              FROM TBCSPMWF008M
                             WHERE BOKG_DT     = T2.STD_DAY4
                               AND SCO_HST_SNO = T1.SCO_HST_SNO
                               AND SCO_SNO     = T1.SCO_SNO)                                                                    AS BOKG_CNB4
                               
					<isEqual property="strAdminYn" compareValue="Y">
							/* 관리자 */                                
                          ,(SELECT C.ABR_DPT_NM_1 || ' ' || F_CODE_NM('1000173', B.RANK_CD)  || ' ' || B.USR_NAM || ' ' || B.TNB
                              FROM TBCSPMWF008M A
                                  ,TBDCMACM001M B
                                  ,TBDCMACM002M C
                             WHERE A.BOKG_DT      = T2.STD_DAY4
                               AND A.SCO_HST_SNO  = T1.SCO_HST_SNO
                               AND A.SCO_SNO      = T1.SCO_SNO
                               AND A.BOKG_PEN_CNB = B.CNB
                               AND B.DPT_CD       = C.DPT_CD)                                                                   AS BOKG_NM4
					</isEqual>
					<isEqual property="strAdminYn" compareValue="N">
							/* 사용자 */
                            /* ,CASE WHEN SCO_SNO BETWEEN 1 AND 4 THEN '신규 환자 진료시간'     
                                ELSE '' 
                            END */
                            , ''                                                                                                 AS BOKG_NM4                                  
					</isEqual>                                                                                          
                          
		                            
                          /* 금 */                             
                          ,STD_DAY5                                                                                             AS STD_DAY5
                          ,(SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END
                              FROM (
                                     SELECT YE || MD AS DT FROM TBBADDED013B
                                     UNION ALL
                                     SELECT HLDY     AS DT FROM TBCSPMWF011M WHERE BOKG_DVSN_CD = '1'
                                   ) 
                             WHERE DT = T2.STD_DAY5)                                                                            AS HOLIDAY5
                          ,(SELECT BOKG_PEN_CNB
                              FROM TBCSPMWF008M
                             WHERE BOKG_DT     = T2.STD_DAY5
                               AND SCO_HST_SNO = T1.SCO_HST_SNO
                               AND SCO_SNO     = T1.SCO_SNO)                                                                   AS BOKG_CNB5
                          
                          <isEqual property="strAdminYn" compareValue="Y">
							/* 관리자 */                                
                          ,(SELECT C.ABR_DPT_NM_1 || ' ' || F_CODE_NM('1000173', B.RANK_CD)  || ' ' || B.USR_NAM || ' ' || B.TNB
                              FROM TBCSPMWF008M A
                                  ,TBDCMACM001M B
                                  ,TBDCMACM002M C
                             WHERE A.BOKG_DT      = T2.STD_DAY5
                               AND A.SCO_HST_SNO  = T1.SCO_HST_SNO
                               AND A.SCO_SNO      = T1.SCO_SNO
                               AND A.BOKG_PEN_CNB = B.CNB
                               AND B.DPT_CD       = C.DPT_CD)                                                                   AS BOKG_NM5
							</isEqual>
							<isEqual property="strAdminYn" compareValue="N">
									/* 사용자 */
		                            /* ,CASE WHEN SCO_SNO BETWEEN 1 AND 4 THEN '신규 환자 진료시간'     
		                                ELSE '' 
		                            END */
		                            , ''                                                                                        AS BOKG_NM5                                  
							</isEqual>                                                         
                                                       
					  FROM TBCSPMWF009M T1
                          ,DAY_TABLE    T2
					 WHERE T1.BOKG_DVSN_CD = '1'
					   AND #strStdDt# BETWEEN T1.APC_STR_DT AND T1.APC_END_DT
					 ORDER BY SCO_SNO
		
	</select>	
	
	
	<!-- 선택일자에 시간대 예약 여부 -->
	<select id="CSPMWF026EBokgDupChkSelect" parameterClass="paramMap" resultClass="Integer">
		<![CDATA[
                  SELECT COUNT(1) AS CNT 
                    FROM TBCSPMWF008M
                   WHERE BOKG_DT     = #BOKG_DT#
                     AND SCO_HST_SNO = #SCO_HST_SNO#
                     AND SCO_SNO     = #SCO_SNO# 
		]]>
	</select>
	
	<!-- 선택일자에 본인예약 여부 -->
	<select id="CSPMWF026EBokgCnbChkSelect" parameterClass="paramMap" resultClass="Integer">
		<![CDATA[
                  SELECT COUNT(1) AS CNT 
                    FROM TBCSPMWF008M
                   WHERE BOKG_DT      = #BOKG_DT#
                     AND BOKG_PEN_CNB = #BOKG_PEN_CNB#
		]]>
	</select>
	
	<!-- 초진자 예약 여부 -->
	<select id="CSPMWF026EBokgFirstChkSelect" parameterClass="paramMap" resultClass="Integer">
		<![CDATA[
				SELECT COUNT(1) AS CNT 
                    FROM TBCSPMWF008M
                   WHERE 1=1
                     AND BOKG_PEN_CNB = #BOKG_PEN_CNB#
		]]>
	</select>
		
	<!-- 예약입력 -->
	<insert id="CSPMWF026EBokgInsert" parameterClass="paramMap">
        <![CDATA[       
				INSERT INTO TBCSPMWF008M
				(
                     BOKG_DT
                    ,SCO_HST_SNO
                    ,SCO_SNO
                    ,BOKG_PEN_CNB
                    ,BOKG_PEN_DPT_CD                    
                    ,BOKG_APL_DH
					,FRT_USR_ID
					,FNL_USR_ID
					,FNL_DEAL_DPT_CD
					,FNL_MNU_ID
					,FRT_REGI_DH
					,FNL_MDF_DH 
				)
				VALUES
				(
                     #BOKG_DT#
                    ,#SCO_HST_SNO#
                    ,#SCO_SNO#
                    ,#BOKG_PEN_CNB#
                    ,(SELECT DPT_CD FROM TBDCMACM001M WHERE CNB = #BOKG_PEN_CNB#)                    
                    ,#BOKG_APL_DH#
					,#FRT_USR_ID#
					,#FNL_USR_ID#
					,#FNL_DEAL_DPT_CD#
					,#FNL_MNU_ID#
					,SYSDATE					
					,SYSDATE
				)
        ]]>
	</insert>		
	
	<!-- 예약취소 -->
	<update id="CSPMWF026EBokgDelete" parameterClass="paramMap">
			DELETE TBCSPMWF008M
		     WHERE BOKG_DT      = #BOKG_DT#
		       AND SCO_HST_SNO  = #SCO_HST_SNO#
		       AND SCO_SNO      = #SCO_SNO#
			 
	</update>		
	
	<!-- 관리자용 예약목록 -->
	<select id="CSPMWF026EBokgAllSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[
           WITH
           		/* 특정일 기준으로 계산에 필요한 날짜 계산 */       
                BASE_DATE_CTE AS (SELECT 
					        CASE
					            WHEN #strStdDt# = '20250814' THEN TO_DATE('20250814' , 'YYYYMMDD') + 1
					            ELSE TO_DATE(#strStdDt# , 'YYYYMMDD') 
					        END AS BASE_DATE
					     FROM DUAL) ,  
           		BASE AS 
                (
                     /* 금주 시작일 ~ 차주 종료일 (2주간) */
                     SELECT MIN(DT) AS STR_DT
                           ,MAX(DT) AS END_DT
                       FROM (
                              SELECT TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 7 + LEVEL + (SELECT NEXT_DAY(TO_DATE(BASE_DATE_CTE.BASE_DATE),1) - TO_DATE(BASE_DATE_CTE.BASE_DATE) FROM DUAL), 'YYYYMMDD') AS DT  
                                FROM DUAL , BASE_DATE_CTE
                             CONNECT BY LEVEL <= 12
                            ) 
                ),
                
                BASE2 AS 
                (
                     /* 기준일자와 시간표 */
                     SELECT DT
                           ,B.*
                       FROM (
                              SELECT TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 7 + LEVEL + (SELECT NEXT_DAY(TO_DATE(BASE_DATE_CTE.BASE_DATE),1) - TO_DATE(BASE_DATE_CTE.BASE_DATE) FROM DUAL), 'YYYYMMDD') AS DT 
                                FROM DUAL , BASE_DATE_CTE
                             CONNECT BY LEVEL <= 12
                            ) A 
                           ,TBCSPMWF009M B
                      WHERE B.BOKG_DVSN_CD = '1'
                        AND (SELECT COUNT(1) FROM TBBADDED013B WHERE YE || MD = DT) = 0            /* 휴일제외 */
                        AND (SELECT COUNT(1) FROM TBCSPMWF011M WHERE HLDY     = A.DT AND BOKG_DVSN_CD = '1') = 0 /* 임시휴일 적용 - 2019.07.29 yyh */ 
                        AND TO_CHAR(TO_DATE(DT), 'DY', 'NLS_DATE_LANGUAGE=korean') IN ('화','수','목')   /* 화,목 만 조회. 수요일추가 - 2019.03.27 yyh */
                ) 


                 SELECT TO_CHAR(TO_DATE(A.DT), 'YYYY-MM-DD')                     || '(' || 
                        TO_CHAR(TO_DATE(A.DT), 'DY', 'NLS_DATE_LANGUAGE=korean') || ')'
                                                                 AS DSP_DT                      
                       ,SUBSTR(A.SCO_TM_STR_CD,0,2) || ':' || SUBSTR(A.SCO_TM_STR_CD,3) || ' ~ ' || 
                        SUBSTR(A.SCO_TM_END_CD,0,2) || ':' || SUBSTR(A.SCO_TM_END_CD,3) 
                                                                 AS DSP_SCO_TM_NM
                       ,A.DT                                     AS STD_DT
                       ,A.SCO_HST_SNO    
                       ,A.SCO_SNO
                       ,A.SCO_TM_STR_CD
                       ,A.SCO_TM_END_CD
                       ,B.BOKG_DT
                       ,B.DSP_BOKG_DT
                       ,B.SCO_TM_NM
                       ,B.BOKG_PEN_CNB
                       ,B.BOKG_PEN_NM
                       ,B.BOKG_PEN_DPT_CD
                       ,B.BOKG_PEN_DPT_NM
                       ,B.BOKG_RANK_NM
                       ,B.BOKG_TNB                       
                       ,B.TRTMT_INFO
                   FROM BASE2 A
                        ,(
                             SELECT T2.BOKG_DVSN_CD                                AS BOKG_DVSN_CD
                                   ,T1.BOKG_DT                                     AS BOKG_DT
                                   ,T1.SCO_HST_SNO                                 AS SCO_HST_SNO 
                                   ,T1.SCO_SNO                                     AS SCO_SNO
                                   ,TO_CHAR(TO_DATE(T1.BOKG_DT), 'YYYY-MM-DD')                     || '(' || 
                                    TO_CHAR(TO_DATE(T1.BOKG_DT), 'DY', 'NLS_DATE_LANGUAGE=korean') || ')'
                                                                  AS DSP_BOKG_DT                                        
                                   ,SUBSTR(T2.SCO_TM_STR_CD,0,2) || ':' || SUBSTR(T2.SCO_TM_STR_CD,3) || ' ~ ' || 
                                    SUBSTR(T2.SCO_TM_END_CD,0,2) || ':' || SUBSTR(T2.SCO_TM_END_CD,3)                                    
                                                                                   AS SCO_TM_NM
                                   ,BOKG_PEN_CNB                                   AS BOKG_PEN_CNB
                                   ,T5.USR_NAM                                     AS BOKG_PEN_NM
                                   ,BOKG_PEN_DPT_CD                                AS BOKG_PEN_DPT_CD
                                   ,F_DPT_INFO(BOKG_PEN_DPT_CD, '1')               AS BOKG_PEN_DPT_NM
                                   ,F_CODE_NM('1000173', T5.RANK_CD)               AS BOKG_RANK_NM    
                                   ,T5.TNB                                         AS BOKG_TNB         
                                   ,CASE WHEN T4.TRTMT_NBC_CD = '1' THEN '(초진)' 
                                         WHEN T4.TRTMT_NBC_CD = '2' THEN '(재진)'
                                     END || T4.TRTMT_FNDT_TXT                      AS TRTMT_INFO                                   
                               FROM TBCSPMWF008M T1
                                   ,TBCSPMWF009M T2 
                                   ,BASE         T3
                                   ,TBCSPMWF007M T4
                                   ,TBDCMACM001M T5
                              WHERE 1=1
                                AND T1.SCO_HST_SNO     = T2.SCO_HST_SNO
                                AND T1.SCO_SNO         = T2.SCO_SNO
                                AND T2.BOKG_DVSN_CD    = '1'
                                AND T1.BOKG_APL_DH     = T4.BOKG_APL_DH(+)
                                AND T1.BOKG_PEN_CNB    = T5.CNB
                                AND T1.BOKG_DT BETWEEN T3.STR_DT AND T3.END_DT 
                        ) B
                   WHERE 1=1
                     AND A.BOKG_DVSN_CD = B.BOKG_DVSN_CD(+)
                     AND A.SCO_HST_SNO  = B.SCO_HST_SNO(+)
                     AND A.SCO_SNO      = B.SCO_SNO(+)
                     AND A.DT           = B.BOKG_DT(+)                     
                   ORDER BY A.DT
                           ,A.SCO_HST_SNO
                           ,A.SCO_SNO
		]]>                         
	</select>		
		
	<!-- 예약목록 -->
	<select id="CSPMWF026EBokgSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[
            WITH
           		/* 특정일 기준으로 계산에 필요한 날짜 계산 */       
                BASE_DATE_CTE AS (SELECT 
					        CASE
					            WHEN #strStdDt# = '20250814' THEN TO_DATE('20250814' , 'YYYYMMDD') + 1
					            ELSE TO_DATE(#strStdDt# , 'YYYYMMDD') 
					        END AS BASE_DATE
					     FROM DUAL) ,  
                 BASE AS 
                (
                     /* 금주 시작일 ~ 차주 종료일 (2주간) */
                     SELECT MIN(DT) AS STR_DT
                           ,MAX(DT) AS END_DT
                       FROM (
                              SELECT TO_CHAR(TO_DATE(BASE_DATE_CTE.BASE_DATE) - 7 + LEVEL + (SELECT NEXT_DAY(TO_DATE(BASE_DATE_CTE.BASE_DATE),1) - TO_DATE(BASE_DATE_CTE.BASE_DATE) FROM DUAL), 'YYYYMMDD') AS DT 
                                FROM DUAL , BASE_DATE_CTE
                             CONNECT BY LEVEL <= 12
                            ) 
                )
                
                
                SELECT T1.BOKG_DT                                     AS BOKG_DT
                      ,T1.SCO_HST_SNO                                 AS SCO_HST_SNO 
                      ,T1.SCO_SNO                                     AS SCO_SNO
                      ,TO_CHAR(TO_DATE(T1.BOKG_DT), 'YYYY-MM-DD')                     || '(' || 
                       TO_CHAR(TO_DATE(T1.BOKG_DT), 'DY', 'NLS_DATE_LANGUAGE=korean') || ')'
                                                                      AS DSP_BOKG_DT                           
                      ,SUBSTR(T2.SCO_TM_STR_CD,0,2) || ':' || SUBSTR(T2.SCO_TM_STR_CD,3) || ' ~ ' || 
                       SUBSTR(T2.SCO_TM_END_CD,0,2) || ':' || SUBSTR(T2.SCO_TM_END_CD,3)                                    
                                                                      AS SCO_TM_NM
                      ,BOKG_PEN_CNB                                   AS BOKG_PEN_CNB
                      ,F_USR_INFO(BOKG_PEN_CNB, '2')                  AS BOKG_PEN_NM
                      ,BOKG_PEN_DPT_CD                                AS BOKG_PEN_DPT_CD
                      ,F_DPT_INFO(BOKG_PEN_DPT_CD, '1')               AS BOKG_PEN_DPT_NM
                      ,CASE WHEN T4.TRTMT_NBC_CD = '1' THEN '(초진)' 
                            WHEN T4.TRTMT_NBC_CD = '2' THEN '(재진)'
                        END || T4.TRTMT_FNDT_TXT                      AS TRTMT_INFO                      
                  FROM TBCSPMWF008M T1
                      ,TBCSPMWF009M T2 
                      ,BASE         T3
                      ,TBCSPMWF007M T4
                 WHERE 1=1
                   AND T1.SCO_HST_SNO     = T2.SCO_HST_SNO
                   AND T1.SCO_SNO         = T2.SCO_SNO
                   AND T2.BOKG_DVSN_CD    = '1'
                   AND T1.BOKG_APL_DH     = T4.BOKG_APL_DH(+)
                   AND T1.BOKG_DT BETWEEN T3.STR_DT AND T3.END_DT 
			       AND T1.BOKG_PEN_CNB    = #strBokgPenCnb#		
                 ORDER BY T1.BOKG_DT
                         ,T1.SCO_SNO
		]]>                         
	</select>	
	
	<!-- 예약자 변경처리 및 신규입력 -->
	<insert id="CSPMWF026EBokgChngMerge" parameterClass="paramMap">
		<![CDATA[
			MERGE INTO TBCSPMWF008M
			USING DUAL
			   ON (     
			            BOKG_DT     = #BOKG_DT#
			        AND SCO_HST_SNO = #SCO_HST_SNO#
			        AND SCO_SNO     = #SCO_SNO#
			      ) 
			      
			WHEN MATCHED  THEN 		
				UPDATE 
				   SET BOKG_PEN_CNB    = #BOKG_PEN_CNB#
		             , BOKG_PEN_DPT_CD = (SELECT DPT_CD FROM TBDCMACM001M WHERE CNB = #BOKG_PEN_CNB#) 
		             , BOKG_APL_DH     = ''
		             , FNL_USR_ID      = #FNL_USR_ID#
		             , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		             , FNL_MNU_ID      = #FNL_MNU_ID#
		             , FNL_MDF_DH      = SYSDATE
		             			      
			 WHEN NOT MATCHED THEN   
				INSERT 
				(
                     BOKG_DT
                    ,SCO_HST_SNO
                    ,SCO_SNO
                    ,BOKG_PEN_CNB
                    ,BOKG_PEN_DPT_CD                    
					,FRT_USR_ID
					,FNL_USR_ID
					,FNL_DEAL_DPT_CD
					,FNL_MNU_ID
					,FRT_REGI_DH
					,FNL_MDF_DH 
				)
				VALUES
				(
                     #BOKG_DT#
                    ,#SCO_HST_SNO#
                    ,#SCO_SNO#
                    ,#BOKG_PEN_CNB#
                    ,(SELECT DPT_CD FROM TBDCMACM001M WHERE CNB = #BOKG_PEN_CNB#)                    
					,#FRT_USR_ID#
					,#FNL_USR_ID#
					,#FNL_DEAL_DPT_CD#
					,#FNL_MNU_ID#
					,SYSDATE					
					,SYSDATE
				)
		]]>
	</insert>	
	
	<!-- 휴진일 정보 조회 -->
	<select id="CSPMWF026EHldyInfoTxtSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[
					SELECT SUBSTR(EXTRACT(XMLAGG(XMLELEMENT(A, ', '|| HLDY_INFO_TXT  ) ORDER BY HLDY_INFO_TXT), '//text()'), 3)   AS HLDY_INFO_TXT
					  FROM (
					        SELECT '(' || TO_CHAR(TO_DATE(T2.HLDY), 'YYYY-MM-DD') || ') ' || T2.HLDY_RSN_TXT     AS HLDY_INFO_TXT
					          FROM (SELECT TO_CHAR(TO_DATE(#strStdDt#) - 7 + LEVEL + (SELECT NEXT_DAY(TO_DATE(#strStdDt#), 1) - TO_DATE(#strStdDt#) FROM DUAL), 'YYYYMMDD') AS DT 
					                  FROM DUAL
					               CONNECT BY LEVEL <= 5) T1
					              ,TBCSPMWF011M           T2
					         WHERE BOKG_DVSN_CD = '1'       /* 예약구분코드(1:한의과,2:안마기) */
					           AND T1.DT        =  T2.HLDY
					       )
		]]>
	</select>	
	
	<!-- 선택일자가 들어간 주에 본인예약 여부 -->
	<select id="CSPMWF026EBokgCnbWeekChkSelect" parameterClass="paramMap" resultClass="Integer">
		<![CDATA[
        SELECT COUNT(1) AS CNT 
			FROM TBCSPMWF008M
		WHERE BOKG_DT  IN (
			SELECT TO_CHAR(TO_DATE(#BOKG_DT#) - 7 + LEVEL + (SELECT NEXT_DAY(TO_DATE(#BOKG_DT#), 1) - TO_DATE(#BOKG_DT#) FROM DUAL), 'YYYYMMDD') AS DT 
			FROM DUAL
			CONNECT BY LEVEL <= 5  )
                     AND BOKG_PEN_CNB = #BOKG_PEN_CNB#
	]]>	
	</select>
	
</sqlMap> 
