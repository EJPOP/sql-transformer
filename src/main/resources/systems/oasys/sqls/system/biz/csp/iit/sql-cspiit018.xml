<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/iit/018">
 	
 	<select id="CSPIIT018EMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
		   SELECT  D1.TSK_CAT_CD
			      ,D1.TSK_SNO
			      ,D1.REGI_DT
			      ,D1.REGI_HMS
			      ,D1.HNDL_DPT_CD
			      ,F_DPT_INFO(D1.HNDL_DPT_CD, '1') AS HNDL_DPT_NM
			      ,D1.AUD_STR_DT
			      ,D1.AUD_END_DT
			      ,D1.AUD_SBJ_NM
			      ,D1.AUD_SBJ_TXT
			      ,D1.SRCH_NOC
			      ,D1.MSG_DOC_ID
			      ,D1.NEWS_MTRL_DOC_ID
			      ,D1.OPEN_YN
			      ,D1.AUD_SLN
			      ,SUBSTR(D1.AUD_SLN, 0, 4) AS AUD_SLN_YR
			      ,SUBSTR(D1.AUD_SLN, 5, 3) AS AUD_SLN_NO
			      ,SUBSTR(D1.AUD_SPH_CD, 0, 3)||'0' AS AUD_SPH_HIRK_CD
			      ,D1.AUD_SPH_CD
			      ,F_CODE_NM('1000660', D1.AUD_SPH_CD) AS AUD_SPH_NM
			      ,D1.REL_ORG_CD
			      ,F_ORG_INFO(D1.REL_ORG_CD, '1') AS REL_ORG_NM
			      ,D1.EML_SND_YN
			      ,(SELECT S1.FILE_NAME
			        FROM ECM_FILE_LIST_VIEW2 S1
			        WHERE S1.DOC_ID = D1.MSG_DOC_ID
			        AND ROWNUM = 1
			        ) AS MSG_FILE_NAME
			      ,(SELECT S2.FILE_NAME
			        FROM ECM_FILE_LIST_VIEW2 S2
			        WHERE S2.DOC_ID = D1.NEWS_MTRL_DOC_ID
			        AND ROWNUM = 1
			        ) AS NEWS_FILE_NAME
			  FROM TBCSPIIT013M D1
			  WHERE 1=1
			    AND D1.TSK_CAT_CD = 'KP1' 
		]]>		
		      <isNotEmpty property="STARTDT">
		       <isNotEmpty property="ENDDT">
		        AND TO_CHAR(D1.REGI_DT, 'YYYYMMDD') BETWEEN #STARTDT# AND #ENDDT#
		       </isNotEmpty>
		      </isNotEmpty>
		      
		      <isNotEmpty property="AUD_SPH_CD">
		        AND D1.AUD_SPH_CD = #AUD_SPH_CD# 
		      </isNotEmpty>
		      
		      <isNotEmpty property = "HNDL_DPT_CD">
		        AND D1.HNDL_DPT_CD = #HNDL_DPT_CD#
		      </isNotEmpty>
		      
		      <isNotEmpty property="ORGCD">
		        AND D1.REL_ORG_CD = #ORGCD#
		      </isNotEmpty>
		      
		      <isNotEmpty property="OPENYN">
		      	AND D1.OPEN_YN = #OPENYN#
		      </isNotEmpty>
		      
		     <isEqual property="SEARCHKEY" compareValue="1">
			 <isNotEmpty property="SEARCHVALUE">
			   AND D1.AUD_SBJ_NM LIKE '%'||#SEARCHVALUE#||'%'
			 </isNotEmpty>
			</isEqual>
			
			<isEqual property="SEARCHKEY" compareValue="2">
			 <isNotEmpty property="SEARCHVALUE">
			   AND D1.AUD_SBJ_TXT LIKE '%'||#SEARCHVALUE#||'%'
			 </isNotEmpty>
			</isEqual>
		      
		      ORDER BY D1.TSK_SNO DESC
		
		
	</select>
	
	<select id="CSPIIT018EMaxSno" parameterClass="paramMap"
		resultClass="java.lang.String"> 
		
		SELECT NVL(MAX(TSK_SNO), 0)+1  AS MAX_SRNO
          FROM TBCSPIIT013M
         WHERE 1=1
           AND TSK_CAT_CD = 'KP1'
		
	</select>
	
	<insert id="CSPIIT018EInsert" parameterClass="paramMap">
	<![CDATA[
	INSERT INTO TBCSPIIT013M(
            TSK_CAT_CD 
            ,TSK_SNO
            ,REGI_DT
            ,REGI_HMS
            ,HNDL_DPT_CD
            ,AUD_SBJ_NM 
            ,AUD_SBJ_TXT
            ,MSG_DOC_TYP_CD 
            ,MSG_DOC_ID 
            ,NEWS_MTRL_DOC_TYP_CD 
            ,NEWS_MTRL_DOC_ID 
            ,OPEN_YN 
            ,AUD_SLN 
            ,AUD_SPH_CD 
            ,REL_ORG_CD 
            ,FRT_USR_ID 
            ,FNL_USR_ID 
            ,FNL_DEAL_DPT_CD 
            ,FNL_MNU_ID 
            ,FRT_REGI_DH
            ,FNL_MDF_DH
            )
            VALUES(
                'KP1'
               ,#TSK_SNO#
               ,TO_CHAR(SYSDATE, 'YYYYMMDD')
               ,TO_CHAR(SYSDATE, 'HH24MISS')
               ,#HNDL_DPT_CD#
               ,#AUD_SBJ_NM# 
               ,#AUD_SBJ_TXT#
               ,#MSG_DOC_TYP_CD#
               ,#MSG_DOC_ID# 
               ,#NEWS_MTRL_DOC_TYP_CD#
               ,#NEWS_MTRL_DOC_ID# 
               ,#OPEN_YN#
               ,#AUD_SLN#
               ,#AUD_SPH_CD#
               ,#REL_ORG_CD#
               ,#FRT_USR_ID#
               ,#FNL_USR_ID# 
               ,#FNL_DEAL_DPT_CD#
               ,#FNL_MNU_ID# 
               ,SYSDATE
               ,SYSDATE
            )  
	]]>
	</insert>
	
	<update id="CSPIIT018EUpdate" parameterClass="paramMap">
	<![CDATA[
	UPDATE TBCSPIIT013M
       SET FNL_USR_ID         = #FNL_USR_ID#
    	  ,FNL_DEAL_DPT_CD    = #FNL_DEAL_DPT_CD#
    	  ,FNL_MNU_ID         = #FNL_MNU_ID#
          ,FNL_MDF_DH         = SYSDATE
          ,AUD_SLN    = #AUD_SLN#
          ,AUD_SPH_CD = #AUD_SPH_CD#
          ,REL_ORG_CD = #REL_ORG_CD#
          ,HNDL_DPT_CD= #HNDL_DPT_CD#
          ,AUD_SBJ_NM = #AUD_SBJ_NM#
          ,AUD_SBJ_TXT= #AUD_SBJ_TXT#
          ,OPEN_YN    = #OPEN_YN#
	]]>
          <isNotEmpty prepend="," property="MSG_DOC_ID">
           MSG_DOC_ID = #MSG_DOC_ID#
		 </isNotEmpty>
		 <isNotEmpty prepend="," property="NEWS_MTRL_DOC_ID">
		 	NEWS_MTRL_DOC_ID = #NEWS_MTRL_DOC_ID#
		 </isNotEmpty>
     WHERE TSK_CAT_CD = #TSK_CAT_CD#
       AND TSK_SNO    = #TSK_SNO#
        
	</update>
	
	<delete id="CSPIIT018EDelete" parameterClass="paramMap">
	<![CDATA[
	
		      DELETE 
                FROM TBCSPIIT013M
               WHERE 1=1
                 AND TSK_CAT_CD = #TSK_CAT_CD#
                 AND TSK_SNO    = #TSK_SNO#
	
	]]>
	</delete>
</sqlMap> 
