<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="faa/cav/074">
	<select id="FAACAV074QMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<include refid = "include.pageSelct"/>
		<![CDATA[
			SELECT 	T1.YR
					,NVL(T1.ACP_DT, T1.APL_DT) AS ACP_DT /*신청접수일*/
					,T1.APL_CNB
					,T1.DPT_CD
					,F_DPT_INFO(T1.DPT_CD,'1') AS DPT_NM
					,T1.RANK_CD
					,F_CODE_NM('1000173',T1.RANK_CD) AS RANK_NM
					,T1.APL_NAM
					,T1.GEN_ADMN_DVSN_CD
					,F_CODE_NM('1000852',T1.GEN_ADMN_DVSN_CD) AS GEN_ADMN_DVSN_NM /* 직렬 */
					,T1.BZT_TREXP_RCIT_BNK_CD                       AS BZT_TREXP_RCIT_BNK_CD /* 출장여비수령은행코드 */
            		,F_CODE_NM('1000166', T1.BZT_TREXP_RCIT_BNK_CD) AS BZT_TREXP_RCIT_BNK_NM /* 출장여비수령은행명 */
					,DGUARD.DECRYPT('TB_ENC','EAN', T1.BZT_TREXP_RCIT_EAN) AS BZT_TREXP_RCIT_EAN /*주석해제시 컬럼명 확인*/
            		 /*,T1.BZT_TREXP_RCIT_EAN                          AS BZT_TREXP_RCIT_EAN    출장여비수령암호화계좌번호 */
            		,T1.SRNO   /* 일련번호  */
					,T1.SPH /* 분야 */
					,T1.DTIL_SPH /* 세부분야 */
					,T1.APVR_DT /* 승인일 */
					,T1.APVR_AM /* 승인금액 */
					,T1.APL_AM /* 신청금액 */
					,T1.DOC_ID
					,T1.SPRT_EXPT_AM /* 지원예상금액 */
					,T1.PMT_AM /* 지급금액 */
					,T1.TIT_NM  /* 제목 */
					,T1.HNDL_STEP  /* 처리상태 */
					,TO_CHAR(T1.APV_DT, 'YYYY-MM-DD') AS APV_DT /* 결재일 */
					,T1.FRT_REGI_DH 
					,T1.APV_DOC_NO
			FROM	TBFAACAV074M T1
			WHERE	1=1
			
		]]>	
		
		<isNotEmpty property="strYr">
			AND  T1.YR = #strYr# 
		</isNotEmpty>
			
		<isNotEmpty property="strSrno">
			AND  T1.SRNO = #strSrno# 
		</isNotEmpty>
		
		<isNotEmpty property="strCNB">
			AND T1.APL_CNB = #strCNB# 
		</isNotEmpty>
		
		<isEqual property="strAUTH_CD" compareValue="ALL">
        	AND	 (T1.APL_CNB = #strCnb# OR T1.HNDL_STEP <![CDATA[ >= ]]> '2') /* ALL 권한자이면 모든 '신청'된 등록 사항을 조회 */
        	<isNotEmpty property="strDPT_CD2">
				AND  T1.DPT_CD = #strDPT_CD2# 
			</isNotEmpty>
        </isEqual>
        
		<!-- 직렬 -->
		<isNotEmpty property="strGEN_ADMN_DVSN_CD">
			AND	T1.GEN_ADMN_DVSN_CD = #strGEN_ADMN_DVSN_CD#
		</isNotEmpty>
		
		<isNotEmpty property="strHNDL_STEP">
			AND  T1.HNDL_STEP = #strHNDL_STEP# 
		</isNotEmpty>
		
		<isNotEmpty property="strSPH">
			AND  T1.SPH = #strSPH# 
		</isNotEmpty>
		
		<!-- 제목 -->
		<isNotEmpty prepend="AND" property="strTIT_NM">
			T1.TIT_NM LIKE '%'||#strTIT_NM# ||'%'
		</isNotEmpty>
		
		<!-- 신청일 -->
		<isNotEmpty property="strACP_DTS">
			<![CDATA[
				AND	TO_CHAR(NVL(T1.ACP_DT, T1.APL_DT) ,'YYYYMMDD') >= #strACP_DTS# 
			]]>
		</isNotEmpty>
		<isNotEmpty property="strACP_DTE">
			<![CDATA[
				AND	TO_CHAR(NVL(T1.ACP_DT, T1.APL_DT) ,'YYYYMMDD') <= #strACP_DTE# 
			]]>
		</isNotEmpty>
		
		<include refid = "include.pageOrder"/> 
	</select>
	
	<select id="FAACAV074QSelectRate" parameterClass="paramMap" resultClass="String"> 
		WITH BASE AS (
		    SELECT NVL((SELECT SPRT_AM FROM TBDCMACM067M WHERE YR = #strYr# AND DVSN_CD = '2'),0) AS COL1 /*예산액*/
                 , (SELECT NVL(SUM(PMT_AM),0) FROM TBFAACAV074M WHERE YR = #strYr# AND HNDL_STEP IN ('3','7')) AS COL2 /*누적확정액*/
            FROM DUAL		    
		)
		
		SELECT DECODE((SELECT COL1 FROM BASE),0,0,ROUND((SELECT COL2 FROM BASE ) / (SELECT COL1 FROM BASE ),2) * 100) || '%' AS RATE
  		  FROM DUAL	
	</select>

	<select id="FAACAV074EMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT 	T1.YR
					,TO_CHAR(NVL(T1.ACP_DT, T1.APL_DT), 'YYYY.MM.DD') AS ACP_DT
					,T1.APL_CNB
					,T1.DPT_CD
					,F_DPT_INFO(T1.DPT_CD,'1') AS DPT_NM
					,T1.RANK_CD
					,F_CODE_NM('1000173',T1.RANK_CD) AS RANK_NM
					,T1.APL_NAM
					,T1.GEN_ADMN_DVSN_CD
					,F_CODE_NM('1000852',T1.GEN_ADMN_DVSN_CD) AS GEN_ADMN_DVSN_NM /* 직렬 */
					,T1.APL_NAM || '(' || T1.APL_CNB || ')'  AS APL_INFO1
					,F_DPT_INFO(T1.DPT_CD,'1') || ' ' || F_CODE_NM('1000173',T1.RANK_CD)  || ' ' || F_CODE_NM('1000852',T1.GEN_ADMN_DVSN_CD) AS APL_INFO2
					,T1.BZT_TREXP_RCIT_BNK_CD                       AS BZT_TREXP_RCIT_BNK_CD /* 출장여비수령은행코드 */
            		,F_CODE_NM('1000166', T1.BZT_TREXP_RCIT_BNK_CD) AS BZT_TREXP_RCIT_BNK_NM /* 출장여비수령은행명 */
					,REGEXP_REPLACE((DGUARD.DECRYPT('TB_ENC','EAN', T1.BZT_TREXP_RCIT_EAN)) ,'[^0-9]') AS BZT_TREXP_RCIT_EAN /*주석해제시 컬럼명 확인*/
            		/*,T1.BZT_TREXP_RCIT_EAN                          AS BZT_TREXP_RCIT_EAN     출장여비수령암호화계좌번호 */
            		,T1.SRNO   /* 일련번호  */
					,T1.SPH /* 분야 */
					,T1.TIT_NM /* 세부분야 */
					,T1.DTIL_SPH /* 세부분야 */
					,T1.APVR_DT /* 승인일 */
					,T1.APVR_AM /* 승인금액 */
					,T1.APVR_CNB /* 승인자 전산번호 */
					,F_USR_INFO(T1.APVR_CNB, '2') AS APVR_NAM /* 승인자 이름 */
					,T1.APL_AM /* 신청금액 */
					,(SELECT DOC_ID FROM TBFAACAV074L Z 
			 		WHERE Z.YR = T1.YR 
			 		AND	Z.SRNO = T1.SRNO) AS DOC_ID
					,T1.SPRT_EXPT_AM /* 지급예상금액 */
					,T1.PMT_AM /* 지급금액 */
					,T1.HNDL_STEP  /* 처리상태 */
					,TO_CHAR(T1.APV_DT, 'YYYY.MM.DD') AS APV_DT /* 결재일 */
					,T1.APV_DOC_NO
					,T1.EDU_SDT
					,T1.EDU_EDT
					,T1.EDU_ORG
					,T1.EDU_TM
					,T1.EDU_RT
					,T1.APV_HIS /* 미승인내역  */
					,T1.PART_APV_HIS /* 부분승인내역  */
			FROM	TBFAACAV074M T1
			WHERE	1=1
			
		]]>
		<isNotEmpty property="strYr">
			AND  T1.YR = #strYr# 
		</isNotEmpty>
				
		<isNotEmpty property="strSrno">
			AND  T1.SRNO = #strSrno# 
		</isNotEmpty>
            
		
	</select>

	<select id="FAACAV074ESubSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT A.YR
			     , A.SRNO
			     , A.BOOK_NUM
			     , A.DTIL_SPH
			     , A.BOOK_NM
			     , A.PBL_NM
			     , A.ATR_NM
			     , A.BOOK_AM
			  FROM TBFAACAV074B A  /* 도서정보내역 */
			 WHERE A.YR   = #strYr#
			   AND A.SRNO = #strSrno#
			ORDER BY A.BOOK_NUM
		]]>
	</select>


	<select id="FAACAV074EUserSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	NVl(D1.BZT_TREXP_RCIT_BNK_CD
				,(SELECT T.BZT_TREXP_RCIT_BNK_CD
				FROM (SELECT T1.BZT_TREXP_RCIT_BNK_CD
						FROM TBFAACAV074M T1
					    WHERE T1.APL_CNB = #strUserCnb#
				        ORDER BY T1.APL_DT DESC) T WHERE ROWNUM =1  ) 
				) AS BZT_TREXP_RCIT_BNK_CD /* 사용자정보 기본은행이 없을때 가장 최근에 사용한 계좌 가져오기 */
				,NVl(REGEXP_REPLACE((DGUARD.DECRYPT('TB_ENC','EAN', D1.BZT_TREXP_RCIT_EAN)) ,'[^0-9]') /* D1.BZT_TREXP_RCIT_EAN */
				,(SELECT REGEXP_REPLACE((DGUARD.DECRYPT('TB_ENC','EAN', T.BZT_TREXP_RCIT_EAN)) ,'[^0-9]') /* T.BZT_TREXP_RCIT_EAN  */
				FROM (SELECT T1.BZT_TREXP_RCIT_EAN
						FROM TBFAACAV074M T1
					    WHERE T1.APL_CNB = #strUserCnb#
				        ORDER BY T1.APL_DT DESC) T WHERE ROWNUM =1  ) 
				) AS BZT_TREXP_RCIT_EAN /* 사용자정보 기본계좌가 없을때 가장 최근에 사용한 계좌 가져오기 */
				,D1.GEN_ADMN_DVSN_CD
				,F_CODE_NM('1000852',D1.GEN_ADMN_DVSN_CD) AS GEN_ADMN_DVSN_NM /* 직렬 */
				,D1.RANK_CD
				,F_CODE_NM('1000173',D1.RANK_CD) AS RANK_NM
				FROM	TBDCMACM001M D1 
				WHERE	D1.CNB = #strUserCnb#
	]]>
	</select>
	
	<select id="FAACAV074ESectSelect" parameterClass="paramMap"	resultClass="resultMap">
     
		SELECT CD, CD_NM, USR_DFN_TXT_1,USR_DFN_TXT_2
		FROM TBDCMACM013C
		WHERE 1=1
			AND USE_YN = 'Y'
			AND CMM_CD_DVSN_CD='1000887'
			AND CD != '000000000'
		ORDER BY USR_DFN_TXT_1,TO_NUMBER(REGEXP_REPLACE(CD ,'[^0-9]'))

	</select>


	<select id="FAACAV074QMgYrLtdSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT 	T1.YR
					, T1.SPH
					, T1.SPRT_LTD
					, T1.SPRT_AM
					, T1.TOTAL_AM
			FROM	TBFAACAV074D T1
			WHERE	1=1
		]]>
		<isNotEmpty property="strYr">
			AND  T1.YR = #strYr# 
		</isNotEmpty>
	</select>

	
	<select id="FAACAV074DCntSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT 	COUNT(*) AS CNT
			FROM	TBFAACAV074D T1
			WHERE	1=1
		]]>
			AND  T1.YR = #YR#
			AND  T1.SPH = #SPH#
			
	</select>
	
	<update id="FAACAV074Dupdate" parameterClass="paramMap">
	<![CDATA[
			UPDATE	TBFAACAV074D
			SET		YR = #YR# /* 신청일 */
					,SPH = #SPH#
					,SPRT_LTD = #SPRT_LTD#
					,SPRT_AM = #SPRT_AM# /* 지원금액 */
					,TOTAL_AM = #TOTAL_AM# /* 지원총액 */
			WHERE	YR = #YR#  AND  SPH = #SPH#
		]]>
	</update>
	
	<insert id="FAACAV074Dinsert" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO TBFAACAV074D
        	(
        			YR,
        			SPH,
        			SPRT_LTD,
        			SPRT_AM,
        			TOTAL_AM
        	) VALUES (
        			#YR#,
        			#SPH#,
        			#SPRT_LTD#,
	        		#SPRT_AM#,
	        		#TOTAL_AM#
        	)
        ]]>
	</insert>
	
	<delete id="FAACAV074Ddelete" parameterClass="paramMap">
		DELETE
		TBFAACAV074D
		WHERE YR = #YR#
		AND SPH = #SPH#
	</delete>
	<select id="FAACAV074DMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT TOTAL_AM, PMT_SUM,APP_SUM, (TOTAL_AM - PMT_SUM - APP_SUM) AS APPPOS_SUM 
    		FROM (
       			SELECT  RPAD(TOTAL_AM,9,'0') TOTAL_AM,
            		   (SELECT SUM(PMT_AM) FROM TBFAACAV074M WHERE YR =  #strYr#  AND HNDL_STEP > 5)  AS PMT_SUM ,
            		   (SELECT SUM(PMT_AM) FROM TBFAACAV074M WHERE YR =  #strYr#  AND HNDL_STEP = 3)  AS APP_SUM  
       			FROM	TBFAACAV074D 
				WHERE	1=1
            	AND  YR =  #strYr# )T1
		]]>
	</select>
	
	<select id="FAACAV074EMYrSprtSelect"  parameterClass="paramMap" resultClass="resultMap">
			SELECT SPH, SPRT_AM
			FROM TBFAACAV074D  
			WHERE 1=1 
			AND TO_CHAR(SYSDATE,'YYYY') = YR
			ORDER BY SPH
	</select>
	
	<select id="FAACAV074EPsnSumSelect"  parameterClass="paramMap" resultClass="resultMap">
		SELECT APL_NAM, COUNT(PMT_AM) AS PCNT, NVL(SUM(PMT_AM),0) AS PMT_SUM
			,NVL((SELECT SUM(PMT_AM) AS PMT_SUM_01    
				FROM TBFAACAV074M 
				WHERE APL_CNB =  #strUserCnb#
				AND YR = TO_CHAR(SYSDATE,'YYYY')
				AND SPH ='01'
				AND (HNDL_STEP='3' OR HNDL_STEP='6' OR HNDL_STEP='7' ) 
				GROUP BY APL_NAM ),0)  AS PMT_SUM_01  /* 온라인 건 표시 */
 			,NVL((SELECT SUM(PMT_AM) AS PMT_SUM_02    
				FROM TBFAACAV074M 
				WHERE APL_CNB =  #strUserCnb#
				AND YR = TO_CHAR(SYSDATE,'YYYY')
				AND SPH ='02'
				AND (HNDL_STEP='3'  OR HNDL_STEP='6'  OR HNDL_STEP='7' ) 
				GROUP BY APL_NAM ),0) AS PMT_SUM_02    /* 오프라인건건 표시 */ 
     		,NVL((SELECT SUM(PMT_AM) AS PMT_SUM_03    
				FROM TBFAACAV074M 
				WHERE APL_CNB =  #strUserCnb#
				AND YR = TO_CHAR(SYSDATE,'YYYY')
				AND SPH ='03'
				AND (HNDL_STEP='3' OR HNDL_STEP='6' OR HNDL_STEP='7' )   /* 승인된것만 표시 */
				GROUP BY APL_NAM ),0) AS PMT_SUM_03  /* 도서분야건 표시 */
			FROM TBFAACAV074M 
			WHERE APL_CNB = #strUserCnb#
			AND YR = TO_CHAR(SYSDATE,'YYYY')
			AND SPH IN ('01','02','03')
			AND (HNDL_STEP='3' OR HNDL_STEP='6' OR HNDL_STEP='7' )  /* 승인된것만 표시 */
			GROUP BY APL_NAM 
	
	</select>
	<insert id="FAACAV074ESprtInsert" parameterClass="paramMap">		
			INSERT INTO	TBFAACAV074M
				(
					 YR
					, APL_DT
					, APL_CNB
					, SRNO
					, DPT_CD
					, RANK_CD
					, APL_NAM
					, GEN_ADMN_DVSN_CD
					, BZT_TREXP_RCIT_BNK_CD
					, BZT_TREXP_RCIT_EAN
					, SPH
					, DTIL_SPH
					, APL_AM
					, SPRT_EXPT_AM
					, PMT_AM
					, TIT_NM
					, EDU_SDT
					, EDU_EDT
					, EDU_ORG
					, EDU_TM
					, EDU_RT
			        , HNDL_STEP
			        , APVR_DT
					, APVR_CNB
			        , APV_HIS
			        , PART_APV_HIS
		        	<isEqual property="HNDL_STEP" compareValue="2">
		        	, ACP_DT
		        	</isEqual>
					, FRT_USR_ID
					, FNL_USR_ID
					, FNL_MNU_ID
					, FRT_REGI_DH
					, FNL_MDF_DH
				)
			VALUES	(
						TO_CHAR(SYSDATE,'YYYY')
						, TO_CHAR(SYSDATE,'YYYYMMDD')
						, #APL_CNB#
						,(	SELECT 	NVL(MAX(SRNO),0)+1 
							FROM 	TBFAACAV074M
						)
						, F_USR_INFO(#APL_CNB#, '5')/*DPT_CD*/
						, F_USR_INFO(#APL_CNB#, '3') /*RANK_CD*/
						, F_USR_INFO(#APL_CNB#, '2') /* USR_NAM*/ 
						,(	SELECT GEN_ADMN_DVSN_CD FROM TBDCMACM001M WHERE CNB= #APL_CNB# )
						, #BZT_TREXP_RCIT_BNK_CD#
						, #BZT_TREXP_RCIT_EAN# /* 주석해제시 컬럼명 확인 로컬시 변경*/
						, #SPH#
						, #DTIL_SPH#
						, #APL_AM# /* 신청금액 */ 
						, #SPRT_EXPT_AM# /* 지원예상금액 */ 
						, #PMT_AM# /* 승인금액 */ 
						, #TIT_NM#
						, #EDU_SDT#
						, #EDU_EDT#
						, #EDU_ORG#
						, #EDU_TM#
						, #EDU_RT#
	        			, #HNDL_STEP# /*1:작성  2:신청  3:승인  4:미승인  5:반려  6:결재중 7:지급*/
	        			, #APVR_DT#
						, #APVR_CNB#
	        			, #APV_HIS#
	        			, #PART_APV_HIS#
			        	<isEqual property="HNDL_STEP" compareValue="2">
			        	, SYSDATE
			        	</isEqual>
						, #FNL_USR_ID#
						, #FNL_USR_ID#
						, #FNL_MNU_ID#
						, SYSDATE
						, SYSDATE
					)		
	</insert>
	
	<update id="FAACAV074EupdateMain" parameterClass="paramMap">
		<![CDATA[
			UPDATE	TBFAACAV074M
			SET		BZT_TREXP_RCIT_BNK_CD = #BZT_TREXP_RCIT_BNK_CD#
					,BZT_TREXP_RCIT_EAN = #BZT_TREXP_RCIT_EAN#  /* 주석해제시 컬럼명 확인*/
					/*,BZT_TREXP_RCIT_EAN = BZT_TREXP_RCIT_EAN */
					,SPH = #SPH#  /* 분야 */
					,DTIL_SPH = #DTIL_SPH# /* 세부분야 */
					,APVR_DT = #APVR_DT#  /* 승인일 */
					,APVR_CNB = #APVR_CNB#  /* 승인자 */
					,PMT_AM = #PMT_AM# /* 지급금액 */
					,APL_AM = #APL_AM# /* 신청금액 */
					,SPRT_EXPT_AM = #SPRT_EXPT_AM# /* 지원예상금액 */
					,HNDL_STEP = #HNDL_STEP# /*처리상태*/
					,TIT_NM = #TIT_NM#
					,EDU_SDT = #EDU_SDT#
					,EDU_EDT = #EDU_EDT#
					,EDU_ORG = #EDU_ORG#
					,EDU_TM = #EDU_TM#
					,EDU_RT = #EDU_RT#
					,APV_HIS = #APV_HIS# /*미승인 내역*/
					,PART_APV_HIS = #PART_APV_HIS# /*부분승인 내역*/
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_MNU_ID = #FNL_MNU_ID#
			]]>
			<isEqual property="HNDL_STEP" compareValue="2">
					,ACP_DT = SYSDATE
			</isEqual>
			<isEqual property="HNDL_STEP" compareValue="1">
					,ACP_DT = ''
			</isEqual>
			WHERE	YR = #YR#
			AND		SRNO = #SRNO#
		
	</update>
	
	<select id="FAACAV074EMainKeyValueSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT TO_CHAR(SYSDATE, 'YYYY')               AS YR
			     , (SELECT NVL(MAX(SRNO), 0) + 1
		              FROM TBFAACAV074M ) AS SRNO 
		      FROM DUAL
		]]>
	</select>
	<insert id="FAACAV074EFileInsert" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO TBFAACAV074L
        	(
        			YR,
        			SRNO,
        			DOC_ID,
        			FRT_USR_ID,
        			FNL_USR_ID,
        			FNL_MNU_ID,
        			FRT_REGI_DH,
        			FNL_MDF_DH
        	) VALUES (
        			#YR#,
	        		#SRNO#,
	        		#DOC_ID#,
	        		#FRT_USR_ID#,
	        		#FNL_USR_ID#,
	        		#FNL_MNU_ID#,
	        		SYSDATE,
	        		SYSDATE
        	)
        ]]>
	</insert>
	
	<delete id="FAACAV074EdeleteMain" parameterClass="paramMap">
		<![CDATA[
			DELETE	
			FROM	TBFAACAV074M
			WHERE	YR = #YR#
			AND		SRNO = #SRNO#
		]]>
	</delete>
	
	<delete id="FAACAV074EFileDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE	
			FROM	TBFAACAV074L
			WHERE	YR = #YR#
			AND		SRNO = #SRNO#
		]]>
	</delete>
	
	<delete id="FAACAV074EBookDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE	
			FROM	TBFAACAV074B
			WHERE	YR = #YR#
			AND		SRNO = #SRNO#
		]]>
	</delete>
	<select id="FAACAV074QExcelExportSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[ 
			SELECT ROW_NUMBER() OVER(ORDER BY DPT_SNO ASC) AS NUM,	A.* 
 				FROM ( SELECT 
					T1.YR /* 연도 */
					,(SELECT DPT_SNO FROM TBDCMACM002M WHERE DPT_CD = T1.DPT_CD) AS DPT_SNO
					,F_DPT_INFO(T1.DPT_CD,'1') AS DPT_NM /* 부서 */
					,F_CODE_NM('1000173',T1.RANK_CD) AS RANK_NM /* 직급 */
					,F_CODE_NM('1000176',T2.PST_CD) AS PST_NM /* 직위 */
					,T1.APL_CNB /* 신청자 전산번호 */
					,T1.APL_NAM /* 신청자 명 */
					,F_CODE_NM('1000852',T1.GEN_ADMN_DVSN_CD) AS GEN_ADMN_DVSN_NM /* 직렬 */
					,TO_CHAR(NVL(T1.ACP_DT, T1.APL_DT), 'YYYY.MM.DD') AS ACP_DT /* 신청일 */
					,T1.TIT_NM  /* 제목 */
					,F_CODE_NM('1000961',T1.SPH) AS SPH_NM /* 분야 */
					,F_CODE_NM('1000887',T1.DTIL_SPH) AS DTIL_SPH  /* 세부분야 */
					,(CASE WHEN T1.SPH = '01' THEN T1.APL_AM ELSE NULL END ) TITLE1 /* 수강료 온라인 */
					,(CASE WHEN T1.SPH = '02' THEN T1.APL_AM ELSE NULL END ) TITLE2 /* 수강료 오프라인 */
					,(CASE WHEN T1.SPH = '03' THEN T1.APL_AM ELSE NULL END ) TITLE3 /* 도서 */
					,T1.APL_AM  /* 신청금액 */
					,T1.SPRT_EXPT_AM /* 지급예상금액 */
            		,F_CODE_NM('1000166', T1.BZT_TREXP_RCIT_BNK_CD) AS BNK_NM /* 출장여비수령은행명 */
					,DGUARD.DECRYPT('TB_ENC','EAN', T1.BZT_TREXP_RCIT_EAN) AS EAN /*주석해제시 컬럼명 확인*/
            		/*,T1.BZT_TREXP_RCIT_EAN                          AS EAN     출장여비수령암호화계좌번호 */
					,TO_CHAR(T1.APV_DT, 'YYYY.MM.DD') AS APV_DT /* 결재일 (지급일) */
					,T1.PMT_AM /* 지급금액 */
					,F_CODE_NM('1000884',T1.HNDL_STEP) AS HNDL_STEP  /* 처리상태 */
					
			FROM	TBFAACAV074M T1,TBDCMACM001M T2
			WHERE	1=1 AND T1.APL_CNB = T2.CNB
		]]>
		<isNotEmpty property="strYr">
			AND  T1.YR = #strYr# 
		</isNotEmpty>
			
		<isNotEmpty property="strSrno">
			AND  T1.SRNO = #strSrno# 
		</isNotEmpty>
            
		<isNotEmpty property="strCNB">
			AND T1.APL_CNB = #strCNB# 
		</isNotEmpty>
		
        <isEqual property="strAUTH_CD" compareValue="ALL">
        	AND	 (T1.APL_CNB = #strCnb# OR T1.HNDL_STEP <![CDATA[ >= ]]> '2') /* ALL 권한자이면 모든 '신청'된 등록 사항을 조회 */
        	<isNotEmpty property="strDPT_CD2">
				AND  T1.DPT_CD = #strDPT_CD2# 
			</isNotEmpty>
        </isEqual>
		<!-- 직렬 -->
		<isNotEmpty property="strGEN_ADMN_DVSN_CD">
			AND	T1.GEN_ADMN_DVSN_CD = #strGEN_ADMN_DVSN_CD#
			
		</isNotEmpty>
		
		<isNotEmpty property="strHNDL_STEP">
			AND  T1.HNDL_STEP = #strHNDL_STEP# 
		</isNotEmpty>
		
		<isNotEmpty property="strSPH">
			AND  T1.SPH = #strSPH# 
		</isNotEmpty>
		
		<!-- 제목 -->
		<isNotEmpty prepend="AND" property="strTIT_NM">
			T1.TIT_NM LIKE '%'||#strTIT_NM# ||'%'
		</isNotEmpty>
		
		<!-- 신청일 -->
		<!-- 신청일 -->
		<isNotEmpty property="strACP_DTS">
			<![CDATA[
				AND	TO_CHAR(NVL(T1.ACP_DT, T1.APL_DT) ,'YYYYMMDD') >= #strACP_DTS# 
			]]>
		</isNotEmpty>
		<isNotEmpty property="strACP_DTE">
			<![CDATA[
				AND	TO_CHAR(NVL(T1.ACP_DT, T1.APL_DT) ,'YYYYMMDD') <= #strACP_DTE# 
			]]>
		</isNotEmpty>
		ORDER BY DPT_SNO ASC, T1.APL_NAM,T1.ACP_DT DESC, APL_DT DESC, T1.SPH ASC ) A
	</select>
	
	
	<select id="FAACAV074APMainApvSelect" parameterClass="paramMap" 	resultClass="resultMap">
	
        <![CDATA[
			SELECT 	T1.YR
					,TO_CHAR(NVL(T1.ACP_DT, T1.APL_DT), 'YYYY.MM.DD') AS ACP_DT
					,T1.APL_CNB
					,T1.DPT_CD
					,F_DPT_INFO(T1.DPT_CD,'1') AS DPT_NM
					,T1.RANK_CD
					,F_CODE_NM('1000173',T1.RANK_CD) AS RANK_NM
					,T1.APL_NAM
					,T1.GEN_ADMN_DVSN_CD
					,F_CODE_NM('1000852',T1.GEN_ADMN_DVSN_CD) AS GEN_ADMN_DVSN_NM /* 직렬 */
					,T1.BZT_TREXP_RCIT_BNK_CD                       AS BZT_TREXP_RCIT_BNK_CD /* 출장여비수령은행코드 */
            		,F_CODE_NM('1000166', T1.BZT_TREXP_RCIT_BNK_CD) AS BZT_TREXP_RCIT_BNK_NM /* 출장여비수령은행명 */
					,DGUARD.DECRYPT('TB_ENC','EAN', T1.BZT_TREXP_RCIT_EAN) AS BZT_TREXP_RCIT_EAN /*주석해제시 컬럼명 확인*/
            		/*,T1.BZT_TREXP_RCIT_EAN                          AS BZT_TREXP_RCIT_EAN     출장여비수령암호화계좌번호 */
            		,T1.SRNO   /* 일련번호  */
					,T1.SPH /* 분야 */
					,T1.DTIL_SPH /* 세부분야 */
					,T1.APVR_DT /* 승인일 */
					,T1.APVR_AM /* 승인금액 */
					,T1.APL_AM /* 신청금액 */
					,T1.DOC_ID
					,T1.SPRT_EXPT_AM /* 지원예상금액 */
					,T1.PMT_AM /* 지급금액 */
					,T1.TIT_NM  /* 제목 */
					,T1.EDU_SDT
					,T1.EDU_EDT
					,T1.EDU_ORG
					,T1.EDU_TM
					,T1.EDU_RT
					,T1.HNDL_STEP  /* 처리상태 */
					,TO_CHAR(T1.APV_DT, 'YYYY.MM.DD') AS APV_DT /* 결재일 */
					,T1.FRT_REGI_DH 
					,T1.APV_DOC_NO
                    ,(SELECT NVL(SUM(T2.PMT_AM),0) FROM TBFAACAV074M T2 WHERE T2.YR= TO_CHAR(SYSDATE,'YYYY') AND T2.HNDL_STEP='7') AS SYS_PMT_AM
                    ]]>	
                    
                    ,(SELECT SUM(T3.PMT_AM) FROM TBFAACAV074M T3 WHERE 1=1
								                    <isNotEmpty property = "parentKey">
											AND  T3.SRNO IN
											<iterate property = "parentKey" open="(" close=")" conjunction=",">
												#parentKey[]#
											</iterate>
										</isNotEmpty>
										<isNotEmpty property="strYr"><!-- 신청년도 -->
										AND T3.YR =  #strYr#
										</isNotEmpty>
										<isNotEmpty property="strApvDocNo"><!-- 결쟂문서번호 -->
										AND T3.APV_DOC_NO =  #strApvDocNo#
										</isNotEmpty>
                    
                    ) AS THIS_PMT_AM
			FROM	TBFAACAV074M T1
			WHERE	1=1
			
		
		
		
		<isNotEmpty property = "parentKey">
			AND  T1.SRNO IN
			<iterate property = "parentKey" open="(" close=")" conjunction=",">
				#parentKey[]#
			</iterate>
		</isNotEmpty>
		<isNotEmpty property="strYr"><!-- 신청년도 -->
		AND T1.YR =  #strYr#
		</isNotEmpty>
		<isNotEmpty property="strApvDocNo"><!-- 결쟂문서번호 -->
		AND T1.APV_DOC_NO =  #strApvDocNo#
		</isNotEmpty>
		
	</select>
	
	<select id="FAACAV074QSelectApvDocNoList" parameterClass="paramMap" 	resultClass="resultMap">
	
        <![CDATA[
			SELECT a.SRNO,a.APV_DOC_NO,a.YR
			FROM
				TBFAACAV074M a
			WHERE 1=1
		]]>	
		
		<isNotEmpty property="strDocNo"><!-- 결재문서번호 -->
		AND a.APV_DOC_NO =  #strDocNo#
		</isNotEmpty>		
	</select>
	
	<!-- 결재처리정보를 수정한다 -->
	<update id="FAACAV074APApvInfoupdate" parameterClass="paramMap">
           UPDATE TBFAACAV074M                    		
              SET APV_DOC_NO        = #APV_DOC_NO#,		/* 결재문서번호 */
                  HNDL_STEP    	    = #HNDL_STEP#,
                  APV_DT    	    = SYSDATE
           WHERE 1=1
          	<isNotEmpty property = "parentKey">
				 AND SRNO IN
				<iterate property = "parentKey" open="(" close=")" conjunction=",">
					#parentKey[]#
				</iterate>
			</isNotEmpty>
	</update>
	
	<!-- 결재처리정보를 수정한다 -->	
	<update id="FAACAV074APApvDocInfoupdate" parameterClass="paramMap">
           UPDATE TBFAACAV074M                    		
              SET APV_DOC_NO        = #APV_DOC_NO#,		/* 결재문서번호 */
                  HNDL_STEP    		= #HNDL_STEP#,
                  APV_DT    	    = SYSDATE
           WHERE 1=1
           <isNotEmpty property="strApvDocNo"><!-- 결재문서번호 -->
			 AND APV_DOC_NO = #strApvDocNo#
		   </isNotEmpty>
			
	</update>
	
	
	
	<insert id="FAACAV074EMsgInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO
			TBDCMACM026L
			(
			  MSG_SNO
			, TSK_CAT_CD
			, FUNC_CAT_CD
			, SEND_ID
	        , MSG_TP_YN
	        , MSG_TXT_2
	        , RCNT_CNT
	        , RCNT_HIS
	        , MSG_REGI_DH
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
			)
			VALUES
			(
			  (SELECT NVL(MAX(MSG_SNO),0)+1 FROM TBDCMACM026L)
			, 'SP'
			, 'BO'
			, #FNL_USR_ID#
	        , '0'
	        , #MSG_TXT#
	        , 1
	        , #APL_CNB#
	        , SYSDATE
			, #FNL_USR_ID#
			, #FNL_USR_ID#
			, #FNL_DEAL_DPT_CD#
			, #FNL_MNU_ID#
			, SYSDATE
			, SYSDATE
			);
			
		]]>
	</insert>


	
	<!-- 상세카운트 -->   
	<select id="FAACAV074ESubCnt" parameterClass="paramMap" resultClass="Integer">
		<![CDATA[       
			SELECT COUNT(YR)
			  FROM TBFAACAV074B A  /* 도서내역 */
			 WHERE A.YR     = #YR#
			   AND A.SRNO   = #SRNO#
		]]>
	</select>
	<insert id="FAACAV074EinsertSub" parameterClass="paramMap">
		INSERT INTO TBFAACAV074B (
		                          YR            
		                        , SRNO           
		                        , BOOK_NUM             /* 성명 */
		                        , DTIL_SPH         /* 한자성명 */
		                        , BOOK_NM /* */
		                        , PBL_NM         /* 계급코드 */
		                        , ATR_NM       /* 직무등급코드 */               
		                        , BOOK_AM      /* 최초사용자ID */
		                         ) 
		                  VALUES (
		                          #YR#
		                        , #SRNO#
		                        , (SELECT NVL(MAX(BOOK_NUM), 0) + 1
		                             FROM TBFAACAV074B
		                            WHERE YR   = #YR#
		                              AND SRNO = #SRNO#)
		                        , #DTIL_SPH#
		                        , #BOOK_NM#
		                        , #PBL_NM#
		                        , #ATR_NM#
		                        , #BOOK_AM#
				                 )
	</insert>

	<update id="FAACAV074EupdateSub"  parameterClass="paramMap">
		
		UPDATE TBFAACAV074B
		   SET YR				= #YR#
		     , SRNO				= #SRNO#
		     , BOOK_NUM			= #BOOK_NUM#
		     , DTIL_SPH			= #DTIL_SPH#
		     , BOOK_NM			= #BOOK_NM#
		     , PBL_NM			= #PBL_NM#
		     , ATR_NM			= #ATR_NM#
		     , BOOK_AM			= #BOOK_AM#
		 WHERE YR			= #YR#
		   AND SRNO			= #SRNO#
		   AND BOOK_NUM 	= #BOOK_NUM#
		
		
	</update>
	
	<!--도서정보 정보 삭제 -->
	<delete id="FAACAV074EdeleteSub" parameterClass="paramMap">
		DELETE TBFAACAV074B
		 WHERE YR          = #YR#
		   AND SRNO        = #SRNO#	
		   AND BOOK_NUM    = #BOOK_NUM#
	</delete>
	
	
	
</sqlMap> 