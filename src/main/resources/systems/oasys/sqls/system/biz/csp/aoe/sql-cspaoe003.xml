<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/aoe/003">

	<!-- [현행 인사정보 가져오기] 자체평가자 : 지원부서 과장 -->
	<insert id="CSPAOE013EsubCd01insert" parameterClass="paramMap">
		INSERT INTO TBCSPAOE017D
			(
				EVL_YR
			  , HLYR_DVSN_CD
			  , TSK_DVSN_CD
			  , AUD_TSK_KND_CD
			  , CHGR_DVSN_CD
			  , CHGR_CNB
			  , EVL_CMTR_NO
			  , BLT_DPT_CD
			  , RANK_CD
			  , FRT_USR_ID
			  , FNL_USR_ID
			  , FNL_DEAL_DPT_CD
			  , FNL_MNU_ID
			  , FRT_REGI_DH
			  , FNL_MDF_DH
			)
          SELECT #strEvlYr#
			   , #strHlyrDvsnCd#
			   , #strTskDvsnCd#
			   , #strAudTskKndCd#
               , 'CD01'
               , CASE WHEN D3.CNB IS NOT NULL THEN D3.CNB
                      ELSE 'X' || ROWNUM END AS CNB
               , ( ROWNUM - 1 ) + (SELECT NVL(MAX(EVL_CMTR_NO), 0) + 1
                                          FROM TBCSPAOE017D
                                         WHERE EVL_YR         = #strEvlYr#
                                           AND HLYR_DVSN_CD   = #strHlyrDvsnCd#
                                           AND TSK_DVSN_CD    = #strTskDvsnCd#
                                           AND AUD_TSK_KND_CD = #strAudTskKndCd#
                                           AND CHGR_DVSN_CD   = 'CD01'
                                   ) AS EVL_CMTR_NO
               , NVL(D3.DPT_CD, D4.BLT_DPT_CD) AS DPT_CD
               , D3.RANK_CD      
               , #FRT_USR_ID#
			   , #FNL_USR_ID#
			   , #FNL_DEAL_DPT_CD#
			   , #FNL_MNU_ID#
			   , SYSDATE
			   , SYSDATE
            FROM (
	               SELECT D1.CNB
	                    , D1.DPT_CD
	                    , D1.RANK_CD
	                FROM TBDCMACM001M D1
	                   , TBDCMACM002M D2
	               WHERE D1.DPT_CD = D2.DPT_CD
	                 AND D2.DPT_TP_CD = 'S'	/*지원부서*/
	                 AND D2.USE_YN = 'Y'
	                 AND D1.PST_CD IN ('0013600', '0096800', '0035400')   /*과장, 팀장, 담당관 15.01.28 최원형감사관님 요청.*/
	                 AND D1.DPT_CD NOT IN ('770770', '300210', '300220', '300230', '100100') /*감사원, 연구1,2,3팀, 감찰담당관 제외 15.01.29 최원형감사관님 요청. 앞으로 쭉 평가대상제외부서*/
	                 AND D1.USR_NAM NOT LIKE 'test%' /*test로 들어간 정보들은 제거한다*/
	             ) D3 FULL OUTER JOIN 
	             (
	              SELECT BLT_DPT_CD
	               FROM TBCSPAOE017D
	              WHERE EVL_YR         = #strCopyEvlYr#
	                AND HLYR_DVSN_CD   = #strCopyHlyrDvsnCd#
	                AND TSK_DVSN_CD    = '10002'
	                AND AUD_TSK_KND_CD = '10000'
	                AND CHGR_DVSN_CD   = 'CD01'     
	                GROUP BY BLT_DPT_CD       
	             ) D4
           		ON D3.DPT_CD = D4.BLT_DPT_CD
	</insert>
	
	
	<!-- [현행 인사정보 가져오기] 상급자평가 : 지원부서 국장 -->
	<insert id="CSPAOE013EsubCd02insert" parameterClass="paramMap">
		INSERT INTO TBCSPAOE017D
		(
			EVL_YR
			, HLYR_DVSN_CD
			, TSK_DVSN_CD
			, AUD_TSK_KND_CD
			, CHGR_DVSN_CD
			, CHGR_CNB
			, EVL_CMTR_NO
			, BLT_DPT_CD
			, RANK_CD
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		)
          SELECT #strEvlYr#
			   , #strHlyrDvsnCd#
			   , #strTskDvsnCd#
			   , #strAudTskKndCd#
               , 'CD02'
               , CASE WHEN D3.CNB IS NOT NULL THEN D3.CNB
                      ELSE 'X' || ROWNUM END AS CNB
               , ( ROWNUM - 1 ) + (SELECT NVL(MAX(EVL_CMTR_NO), 0) + 1
                                          FROM TBCSPAOE017D
                                         WHERE EVL_YR         = #strEvlYr#
                                           AND HLYR_DVSN_CD   = #strHlyrDvsnCd#
                                           AND TSK_DVSN_CD    = #strTskDvsnCd#
                                           AND AUD_TSK_KND_CD = #strAudTskKndCd#
                                           AND CHGR_DVSN_CD   = 'CD02'
                                        ) AS EVL_CMTR_NO
               , NVL(D3.DPT_CD, D4.BLT_DPT_CD) AS DPT_CD
               , D3.RANK_CD      
               , #FRT_USR_ID#
			   , #FNL_USR_ID#
			   , #FNL_DEAL_DPT_CD#
			   , #FNL_MNU_ID#
			   , SYSDATE
			   , SYSDATE
            FROM (
               SELECT 'CD01'
                    , D1.CNB
                    , D1.DPT_CD
                    , D1.RANK_CD
                FROM TBDCMACM001M D1
                   , TBDCMACM002M D2
               WHERE D1.DPT_CD = D2.DPT_CD
                 AND D2.DPT_TP_CD = 'S'	/*지원부서*/
                 AND D2.USE_YN = 'Y'
			     AND D1.PST_CD IN ('0035100', '0067400', '0058100', '0015800', '0013900', '0020600', '0037500')   /*단장, 원장, 실장, 관리관, 국장, 기획조정실장(실장)(기획실장), 대변인(국장)이익현 15.01.28 최원형 감사관 요청.*/
		         AND D1.DPT_CD NOT IN ('770770', '500000' ) /*감사원, 감사원장 평가대상제외부서 15.01.29 최원형감사관님 요청*/
		         AND D1.USR_NAM NOT LIKE 'test%' /*test로 들어간 정보들은 제거한다*/
             ) D3 FULL OUTER JOIN 
              (
              SELECT BLT_DPT_CD
               FROM TBCSPAOE017D
              WHERE EVL_YR         = #strCopyEvlYr#
                AND HLYR_DVSN_CD   = #strCopyHlyrDvsnCd#
                AND TSK_DVSN_CD    = '10002'
                AND AUD_TSK_KND_CD = '10000'
                AND CHGR_DVSN_CD   = 'CD02'            
             ) D4
           ON D3.DPT_CD = D4.BLT_DPT_CD
	</insert>
	
	
	<!-- [현행 인사정보 가져오기] 지원부서 평가위원 : 감사부서 국장, 사무총장, 제1사무차장, 제2사무차장, 공직감찰본부장, 기획조정실장, 감사교육원장, 감사연구원원장, 감찰관, 심의실장, 공보관, 심사관리관 -->
	<insert id="CSPAOE013EsubCd03insert" parameterClass="paramMap">
		INSERT INTO TBCSPAOE017D
		(
			EVL_YR
			, HLYR_DVSN_CD
			, TSK_DVSN_CD
			, AUD_TSK_KND_CD
			, CHGR_DVSN_CD
			, CHGR_CNB
			, EVL_CMTR_NO
			, BLT_DPT_CD
			, RANK_CD
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		)
		SELECT #strEvlYr#
				, #strHlyrDvsnCd#
				, #strTskDvsnCd#
				, #strAudTskKndCd#
				, 'CD03'
				, D1.CNB
				, ( ROWNUM - 1 ) + (SELECT NVL(MAX(EVL_CMTR_NO), 0) + 1
										FROM TBCSPAOE017D
										WHERE EVL_YR = #strEvlYr#
										AND HLYR_DVSN_CD = #strHlyrDvsnCd#
										AND TSK_DVSN_CD = #strTskDvsnCd#
										AND AUD_TSK_KND_CD = #strAudTskKndCd#
										AND CHGR_DVSN_CD = 'CD03'
									) AS EVL_CMTR_NO
				, D1.DPT_CD
				, D1.RANK_CD
				, #FRT_USR_ID#
				, #FNL_USR_ID#
				, #FNL_DEAL_DPT_CD#
				, #FNL_MNU_ID#
				, SYSDATE
				, SYSDATE
		FROM TBDCMACM001M D1
           , TBDCMACM002M D2
		WHERE D1.DPT_CD = D2.DPT_CD
          AND D1.WOK_DVSN_CD = 'AAA'
		  AND ( (D2.DPT_TP_CD = 'A' AND D1.PST_CD = '0015800')     /*감사부서 국장*/             
             OR (D1.DPT_CD = '530000' AND D1.PST_CD = '0055600')   /*제1사무차장*/
             OR (D1.DPT_CD = '540000' AND D1.PST_CD = '0055600')   /*제2사무차장*/
             OR (D1.DPT_CD = '550000' AND D1.PST_CD = '0045900')   /*공직감찰본부장*/
             OR (D1.DPT_CD = '140000' AND D1.PST_CD = '0020600')   /*기획조정실장*/      
             OR (D1.DPT_CD = '200000' AND D1.PST_CD = '0067400')   /*감사교육원장*/
		     OR (D1.DPT_CD = '300000' AND D1.PST_CD = '0067400')   /*감사연구원원장*/
		     OR (D1.DPT_CD = '100000' AND D1.PST_CD = '0010300')   /*감찰관*/
             OR (D1.DPT_CD = '160000' AND D1.PST_CD = '0058100')   /*심의실장*/
             OR (D1.DPT_CD = '110000' AND D1.PST_CD = '0012800')   /*공보관*/
             OR (D1.DPT_CD = '170000' AND D1.PST_CD = '0013900')   /*심사관리관*/
             /*2015.02.02 최원형 감사관 추가 요청*/
             OR (D1.DPT_CD = '0E0000' AND D1.PST_CD = '0035100')   /*지방건설단장*/
             OR (D1.DPT_CD = '1A0000' AND D1.PST_CD = '0037500')   /*대변인*/
             OR (D1.DPT_CD = '0G0000' AND D1.PST_CD = '0035100')   /*국방감사단장*/
             OR (D1.DPT_CD = '0H0000' AND D1.PST_CD = '0035100')   /*IT감사단장*/
             ) /*사무총장 제거 사무총장님은 고정우 감사관님이 대신 평가*/
	</insert>
	
	
	<!-- [현행 인사정보 가져오기] 부서별담당자 -->
	<insert id="CSPAOE013EsubCd04insert" parameterClass="paramMap">
		INSERT INTO TBCSPAOE017D
		(
			EVL_YR
			, HLYR_DVSN_CD
			, TSK_DVSN_CD
			, AUD_TSK_KND_CD
			, CHGR_DVSN_CD
			, CHGR_CNB
			, EVL_CMTR_NO
			, BLT_DPT_CD
			, RANK_CD
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		)
		SELECT #strEvlYr#
			 , #strHlyrDvsnCd#
			 , #strTskDvsnCd#
			 , #strAudTskKndCd#
			 , #strChgrDvsnCd#
			 , D1.CNB
			 , ( ROWNUM - 1 ) + (SELECT NVL(MAX(EVL_CMTR_NO), 0) + 1
							       FROM TBCSPAOE017D
							      WHERE EVL_YR = #strEvlYr#
								    AND HLYR_DVSN_CD = #strHlyrDvsnCd#
								    AND TSK_DVSN_CD = #strTskDvsnCd#
								    AND AUD_TSK_KND_CD = #strAudTskKndCd#
								    AND CHGR_DVSN_CD = #strChgrDvsnCd#
			                    ) AS EVL_CMTR_NO
			 , D1.DPT_CD
			 , D1.RANK_CD
			 , #FRT_USR_ID#
			 , #FNL_USR_ID#
		 	 , #FNL_DEAL_DPT_CD#
		 	 , #FNL_MNU_ID#
		 	 , SYSDATE
			 , SYSDATE
		  FROM TBDCMACM001M D1
		     , TBDCMACM002M D2
		 WHERE D1.DPT_CD = D2.DPT_CD		   
		   AND D2.USE_YN = 'Y'  /*사용여부*/           
		   AND (
                ( D2.DPT_TP_CD = 'A' AND D1.PST_CD IN ('0015800', '0013600', '0035100'))  /*국장, 과장, 단장*/
                OR ( D2.DPT_TP_CD = 'S' AND D1.PST_CD IN ('0013600', '0096800', '0035400','0035100', '0067400', '0058100', '0015800', '0013900', '0020600', '0037500'))  /*과장,팀장,담당관, 단장, 원장, 실장, 관리관, 국장, 기획조정실장(실장)(기획실장), 대변인(국장)*/              
                )
           AND D1.DPT_CD NOT IN ('770770', '500000','300210', '300220', '300230', '100100' ) /*감사원, 감사원장, 연구1,2,3팀, 감찰담당관 평가대상제외 */
		   AND D1.WOK_DVSN_CD = 'AAA'	/*재직*/
		   
	</insert>
	
	<!-- ##################################### 감사외업무 평가관리 시작 (CSPAOE041E) ##################################### -->
	
	<!-- 온로드시 업무종류(공통업무 제외) -->
	<select id="CSPAOE041EAudKndCdListselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT A.CD
			     , A.CD_NM
			  FROM TBDCMACM013C A
			  	  ,TBCSPAOE009M B
			 WHERE 1 = 1
			   AND A.CD = B.AUD_TSK_KND_CD
			   AND A.CMM_CD_DVSN_CD = '1000272'
			   AND NVL(A.USE_YN, 'N') = 'Y'
			   AND A.CD != '10000' /*공통업무 제외*/
			   AND A.CD != '000000000'
			   AND B.EVL_YR = #strEvlYr#
    		   AND B.HLYR_DVSN_CD = #strHlyrDvsnCd#
			   AND B.TSK_DVSN_CD = #strTskDvsnCd#
			 ORDER BY SUBSTR(A.CD_NM, 0, 4), A.OTPT_SEQ, A.CD
		]]>
	</select>
	
	<!-- 온로드시 평가단계(평가자, 확인자) -->
	<select id="CSPAOE041EEvlStepCdListselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT CD
			     , CD_NM
			  FROM TBDCMACM013C 
		 	 WHERE 1=1
		 	   AND CMM_CD_DVSN_CD = '1000279'
			   AND NVL(USE_YN, 'N') = 'Y'
			   AND CD IN ('600', '700') /*평가자, 확인자*/
		]]>
	</select>
	
	<!-- 감사외업무 평가관리 조회한다. -->
	<select id="CSPAOE041Emainselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT D5.EVL_YR                   AS EVL_YR              /*평가년도*/
			     , D5.HLYR_DVSN_CD             AS HLYR_DVSN_CD        /*반기구분코드*/
			     , D5.TSK_DVSN_CD              AS TSK_DVSN_CD         /*업무구분코드*/
			     , D5.TSK_KND_CD               AS AUD_TSK_KND_CD      /*업무종류코드*/
			     , F_CODE_NM ('1000272', D5.TSK_KND_CD) AS AUD_TSK_KND_NM
			     , D5.EVL_STEP_CD              AS EVL_STEP_CD         /*평가단계코드*/
			     , D5.CHGR_DVSN_CD             AS EVL_CMTR_DVSN_CD    /*평가위원 구분코드*/
			     , D5.CHGR_CNB                 AS EVL_CMTR_CNB        /*평가위원 전산번호*/
			     , D5.TSK_NO                   AS TSK_NO              /*업무번호*/
			     , F_DPT_INFO(D5.CHR_DPT_CD, '1') AS CHR_DPT_NM       /*담당부서명*/
			     , D5.TSK_NM                   AS TSK_NM              /*업무명*/
			     , D5.TSK_TXT                  AS TSK_TXT             /*업무내용*/
			     , NVL(D6.EVL_STA_CD, '100')   AS EVL_STA_CD          /*평가상태*/
			     , D6.NAUD_TSK_EVL_SC          AS NAUD_TSK_EVL_SC     /*업무평점*/
			     , D6.EVL_RK_CD                AS EVL_RK_CD           /*평가등급*/
			     , D6.EVL_OPIN                 AS EVL_OPIN            /*평가의견*/
			     , D5.CHR_DPT_CD
			     , D13.OTPT_SEQ
			     , CASE WHEN D5.TSK_KND_CD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_100 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_100 END)  ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_100, NULL , NULL, NULL, NULL), 2) END AS NAUD_TSK_EVL_SC_100 /*감사외업무 평가점수 (탁월)*/
			     , CASE WHEN D5.TSK_KND_CD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_200 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_200 END)  ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_200, NULL , NULL, NULL, NULL), 2) END  AS NAUD_TSK_EVL_SC_200 /*감사외업무 평가점수 (매우우수)*/
			     , CASE WHEN D5.TSK_KND_CD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_300 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_300 END)  ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_300, NULL , NULL, NULL, NULL), 2) END  AS NAUD_TSK_EVL_SC_300 /*감사외업무 평가점수 (우수+)*/
			     , CASE WHEN D5.TSK_KND_CD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_800 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_800 END)  ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_800, NULL , NULL, NULL, NULL), 2) END  AS NAUD_TSK_EVL_SC_800 /*감사외업무 평가점수 (우수)*/
			     , CASE WHEN D5.TSK_KND_CD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_400 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_400 END)  ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_400, NULL , NULL, NULL, NULL), 2) END  AS NAUD_TSK_EVL_SC_400 /*감사외업무 평가점수 (양호-)*/
			     , CASE WHEN D5.TSK_KND_CD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_500 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_500 END)  ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_500, NULL , NULL, NULL, NULL), 2) END  AS NAUD_TSK_EVL_SC_500 /*감사외업무 평가점수 (양호)*/
			     , CASE WHEN D5.TSK_KND_CD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_600 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_600 END)  ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_600, NULL , NULL, NULL, NULL), 2) END  AS NAUD_TSK_EVL_SC_600 /*감사외업무 평가점수 (보통)*/
			     , CASE WHEN D5.TSK_KND_CD = '10006' THEN ( CASE WHEN D5.STND_ASC + D8.RK_CD_700 > 420 THEN 420 ELSE D5.STND_ASC + D8.RK_CD_700 END)  ELSE ROUND(F_TSK_ASC_SUM('10001', D12.FML_TXT, D5.STND_ASC, D8.RK_CD_700, NULL , NULL, NULL, NULL), 2) END  AS NAUD_TSK_EVL_SC_700 /*감사외업무 평가점수 (미흡)*/
			     , D10.EVL_RK_CD_600           AS EVL_RK_CD_600
			     , NVL(D10.CONF_YN, 'N')       AS CONF_YN             /*Y인 것만 확인자가 확정할수 있다.*/
			     , NVL(D11.NO_CONF_YN, 'N')    AS NO_CONF_YN          /*N인 것만 확정취소 할 수 있다.*/
			  FROM (
			        SELECT D4.EVL_YR                                                                   /*평가년도*/
			             , D4.HLYR_DVSN_CD                                                             /*반기구분코드*/
			             , MAN.TSK_DVSN_CD                                                             /*업무구분코드*/
			             , D4.TSK_KND_CD                                                               /*업무종류코드*/
			             , DECODE(MOD(SUBSTR(MAN.CHGR_DVSN_CD, 4), 2), 1, '600', '700') AS EVL_STEP_CD /*단계코트 홀수면 평가자, 짝수면 확인자(구분코드가 하드코딩이므로)*/
			             , MAN.CHGR_DVSN_CD                                                            /*평가위원 구분코드*/
			             , MAN.CHGR_CNB                                                                /*평가위원 전산번호*/
			             , D4.TSK_NO                                                                   /*업무번호*/
			             , D4.CHR_DPT_CD															   /*담당부서코드*/
			             , D4.TSK_NM                                                                   /*업무명*/
			             , D4.TSK_TXT                                                                  /*업무내용*/
			             , CASE WHEN D4.TSK_KND_CD = '10006' THEN ((NVL(D4.JUD_PNSH_CRCT_NOC, 0) * MAN.STND_ASC_1) + (NVL(D4.IMP_RDA_NTF_NOC, 0) * MAN.STND_ASC_2) + (NVL(D4.SPCN_MNG_NOC, 0) * MAN.STND_ASC_3)) ELSE MAN.STND_ASC END AS STND_ASC /*표준평점*/
			             , NVL(D4.JUD_PNSH_CRCT_NOC, 0) AS JUD_PNSH_CRCT_NOC /*판정징계시정건수*/
			             , MAN.STND_ASC_1   /*표준평점1*/
			             , NVL(D4.IMP_RDA_NTF_NOC, 0) AS IMP_RDA_NTF_NOC /*개선권고통보건수*/
			             , MAN.STND_ASC_2   /*표준평점2*/
			             , NVL(D4.SPCN_MNG_NOC, 0) AS SPCN_MNG_NOC /*특수관리건수*/
			             , MAN.STND_ASC_3   /*표준평점3*/
			          FROM (
			                SELECT D1.EVL_YR
			                     , D1.HLYR_DVSN_CD
			                     , D1.TSK_DVSN_CD
			                     , D1.AUD_TSK_KND_CD
			                     , D1.CHGR_DVSN_CD
			                     , D2.CHGR_CNB
			                     , F_USR_INFO(D2.CHGR_CNB, '2') AS NAM
			                     , D7.STND_ASC
			                     , D7.STND_ASC_1  /*표준평점1*/
			                     , D7.STND_ASC_2  /*표준평점2*/
			                     , D7.STND_ASC_3  /*표준평점3*/
			                  FROM TBCSPAOE016M D1
			                     , TBCSPAOE017D D2
			                     , TBCSPAOE006M D7 /*업무종류별 표준평점을 알기위해*/
			                WHERE D1.EVL_YR          = D2.EVL_YR
			                  AND D1.HLYR_DVSN_CD    = D2.HLYR_DVSN_CD
			                  AND D1.TSK_DVSN_CD     = D2.TSK_DVSN_CD
			                  AND D1.AUD_TSK_KND_CD  = D2.AUD_TSK_KND_CD
			                  AND D1.CHGR_DVSN_CD    = D2.CHGR_DVSN_CD
			                  AND D1.EVL_YR          = D7.EVL_YR
                              AND D1.HLYR_DVSN_CD    = D7.HLYR_DVSN_CD
                              AND D1.TSK_DVSN_CD     = D7.TSK_DVSN_CD
                              AND D1.AUD_TSK_KND_CD  = D7.TSK_KND_CD
			                  AND D1.TSK_DVSN_CD     = '10001' /*감사외업무*/
			                  AND D1.EVL_YR          = #strEvlYr#
			                  AND D1.HLYR_DVSN_CD    = #strHlyrDvsnCd#
			                  AND D2.CHGR_DVSN_CD NOT IN ('CD33', 'CD34') /*감사업무쪽 코드임*/
		]]>
		<isNotEmpty property="strAudTskKndCd">
			AND D1.AUD_TSK_KND_CD = #strAudTskKndCd#
		</isNotEmpty>		
		<isNotEmpty property="strEvlCmtrCnb">
			AND D2.CHGR_CNB = #strEvlCmtrCnb#
		</isNotEmpty>
        <![CDATA[ 			                  
			                ) MAN
			                , TBCSPAOE024M D4
			                , (
		                      SELECT EVL_YR
		                         , HLYR_DVSN_CD
		                         , TSK_KND_CD
		                         , TSK_NO
		                      FROM TBCSPAOE025M
		                      WHERE EVL_YR       =  #strEvlYr#
					            AND HLYR_DVSN_CD = #strHlyrDvsnCd#
		                     GROUP BY EVL_YR, HLYR_DVSN_CD, TSK_KND_CD, TSK_NO                            
                            ) D5 /*감사외 업무 팜여인원이 등록되지 않음 보여질 필요가 없다.*/
			        WHERE MAN.EVL_YR          = D4.EVL_YR 
			          AND MAN.HLYR_DVSN_CD    = D4.HLYR_DVSN_CD 
			          AND MAN.AUD_TSK_KND_CD  = D4.TSK_KND_CD
			          AND D4.EVL_YR           = D5.EVL_YR
                      AND D4.HLYR_DVSN_CD     = D5.HLYR_DVSN_CD
                      AND D4.TSK_KND_CD       = D5.TSK_KND_CD
                      AND D4.TSK_NO           = D5.TSK_NO 
		]]>
		<isNotEmpty property="strTskNm">
			AND D4.TSK_NM LIKE '%' || #strTskNm# || '%'
		</isNotEmpty>	
        <![CDATA[									   
			        ORDER BY D4.TSK_KND_CD, D4.TSK_NO
			    ) D5 /*감사외 업무의 평가자, 확인자 리스트를 뽑아 평가위원에 해당하는 업무를 뽑아냄.*/
			    , TBCSPAOE029M D6
			    , (
			        SELECT SUM(DECODE(RK_CD, '100', IDVT_INDEX_VAL, 0)) AS RK_CD_100
			             , SUM(DECODE(RK_CD, '200', IDVT_INDEX_VAL, 0)) AS RK_CD_200
			             , SUM(DECODE(RK_CD, '300', IDVT_INDEX_VAL, 0)) AS RK_CD_300
			             , SUM(DECODE(RK_CD, '800', IDVT_INDEX_VAL, 0)) AS RK_CD_800
			             , SUM(DECODE(RK_CD, '400', IDVT_INDEX_VAL, 0)) AS RK_CD_400
			             , SUM(DECODE(RK_CD, '500', IDVT_INDEX_VAL, 0)) AS RK_CD_500
			             , SUM(DECODE(RK_CD, '600', IDVT_INDEX_VAL, 0)) AS RK_CD_600
			             , SUM(DECODE(RK_CD, '700', IDVT_INDEX_VAL, 0)) AS RK_CD_700
			             , EVL_YR
			             , HLYR_DVSN_CD
			             , TSK_DVSN_CD
			             , AUD_TSK_KND_CD
			         FROM TBCSPAOE010D
			        WHERE EVL_YR       = #strEvlYr#
			          AND HLYR_DVSN_CD = #strHlyrDvsnCd#
			          AND TSK_DVSN_CD  = '10001' /*감사외업무*/
			          AND IDCT_YN      = 'Y'
			        GROUP BY EVL_YR, HLYR_DVSN_CD, TSK_DVSN_CD, AUD_TSK_KND_CD    
			    ) D8 /*평가등급별 성과가중치 개별지표값을 알기위해서*/	
			    , (
			        SELECT EVL_YR
			             , HLYR_DVSN_CD
			             , TSK_DVSN_CD
			             , AUD_TSK_KND_CD
			             , EVL_STEP_CD
			             , '700' AS STEP_CD
			             , EVL_CMTR_DVSN_CD
			             , CASE WHEN LENGTH(EVL_CMTR_DVSN_CD) = '4' AND TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) != 99 THEN 'CD' || LPAD(TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) + 1, 2, 0)
               					ELSE 'CD' || LPAD(TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) + 1, 3) END AS DVSN_CD /*확인자 구분코드*/
			             , EVL_CMTR_CNB
			             , TSK_NO
			             , NVL(EVL_DTM_YN, 'N') AS CONF_YN /*평가확정여부*/
			             , EVL_RK_CD AS EVL_RK_CD_600 /*평가자가 평가한 평가등급-평가확정된게 아니여도 평가등급이 있으면 세팅해주기로 함.*/
			          FROM TBCSPAOE029M
			         WHERE EVL_STEP_CD = '600' /*평가자*/
			           AND NAUD_TSK_EVL_SC IS NOT NULL    
			    ) D10 /*이 쿼리에 정보가 있다는것은 평가자가 평가확정 했다는 것*/
			    ,(
			        SELECT EVL_YR
			             , HLYR_DVSN_CD
			             , TSK_DVSN_CD
			             , AUD_TSK_KND_CD
			             , EVL_STEP_CD
			             , '600' AS STEP_CD
			             , EVL_CMTR_DVSN_CD            
			             , CASE WHEN LENGTH(EVL_CMTR_DVSN_CD) = '4' AND TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) != 99 THEN 'CD' || LPAD(TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) + 1, 2, 0)
               					ELSE 'CD' || LPAD(TO_NUMBER(SUBSTR(EVL_CMTR_DVSN_CD, 3)) + 1, 3) END AS DVSN_CD /*평가자 구분코드*/
			             , EVL_CMTR_CNB
			             , TSK_NO
			             , EVL_DTM_YN AS NO_CONF_YN /*평가확정여부 - 확정했으면 확인취소 못한다.*/
			          FROM TBCSPAOE029M
			         WHERE EVL_STEP_CD     = '700' /*확인자*/
			           AND NAUD_TSK_EVL_SC IS NOT NULL
			           AND EVL_DTM_YN      = 'Y'
			    ) D11 /*이 쿼리에 정보가 있다는것은 확인자가 평가확정 했다는 것*/
			    , (
					SELECT EVL_YR
					     , HLYR_DVSN_CD
					     , FML_TXT /*계산식*/
					  FROM TBCSPAOE013M 
					 WHERE EVL_YR       = #strEvlYr#
					   AND HLYR_DVSN_CD = #strHlyrDvsnCd#
					   AND TSK_DVSN_CD  = '10001'			    
			    ) D12
                , (
                  SELECT CD
                       , ROWNUM AS OTPT_SEQ
                    FROM (
                     SELECT CD
                          , CD_NM
                      FROM TBDCMACM013C 
                     WHERE CMM_CD_DVSN_CD = '1000272'
                       AND NVL(USE_YN, 'N') = 'Y'
                       AND CD != '10000' /*공통업무 제외*/
                       AND CD != '000000000'
                     ORDER BY SUBSTR(CD_NM, 0, 4), OTPT_SEQ, CD
                     )               
                ) D13			    
			WHERE D5.EVL_YR        = D6.EVL_YR(+)
			  AND D5.HLYR_DVSN_CD  = D6.HLYR_DVSN_CD(+)
			  AND D5.TSK_DVSN_CD   = D6.TSK_DVSN_CD (+)
			  AND D5.TSK_KND_CD    = D6.AUD_TSK_KND_CD (+)
			  AND D5.EVL_STEP_CD   = D6.EVL_STEP_CD (+)
			  AND D5.CHGR_DVSN_CD  = D6.EVL_CMTR_DVSN_CD (+)
			  AND D5.CHGR_CNB      = D6.EVL_CMTR_CNB (+)
			  AND D5.TSK_NO        = D6.TSK_NO (+)
			  AND D5.EVL_YR        = D8.EVL_YR /* 개별지표값이 없으면 계산이 안되니깐 아웃터 할 필요 없음. 없음 안되!*/
			  AND D5.HLYR_DVSN_CD  = D8.HLYR_DVSN_CD
			  AND D5.TSK_DVSN_CD   = D8.TSK_DVSN_CD 
			  AND D5.TSK_KND_CD    = D8.AUD_TSK_KND_CD
			  AND D5.EVL_YR        = D10.EVL_YR(+)
			  AND D5.HLYR_DVSN_CD  = D10.HLYR_DVSN_CD(+)
			  AND D5.TSK_DVSN_CD   = D10.TSK_DVSN_CD (+)
			  AND D5.TSK_KND_CD    = D10.AUD_TSK_KND_CD (+)
			  AND D5.EVL_STEP_CD   = D10.STEP_CD (+)
			  AND D5.CHGR_DVSN_CD  = D10.DVSN_CD (+)
			  AND D5.TSK_NO        = D10.TSK_NO (+)		
			  AND D5.EVL_YR        = D11.EVL_YR(+)
			  AND D5.HLYR_DVSN_CD  = D11.HLYR_DVSN_CD(+)
			  AND D5.TSK_DVSN_CD   = D11.TSK_DVSN_CD (+)
			  AND D5.TSK_KND_CD    = D11.AUD_TSK_KND_CD (+)
			  AND D5.EVL_STEP_CD   = D11.STEP_CD (+)
			  AND D5.CHGR_DVSN_CD  = D11.DVSN_CD (+)
			  AND D5.TSK_NO        = D11.TSK_NO (+)		
			  AND D5.EVL_YR        = D12.EVL_YR
			  AND D5.HLYR_DVSN_CD  = D12.HLYR_DVSN_CD
			  AND D5.TSK_KND_CD    = D13.CD  	  
		]]>
		<isNotEmpty property="strEvlStaCd">
			AND NVL(D6.EVL_STA_CD, '100') = #strEvlStaCd#
		</isNotEmpty>
		<isNotEmpty property="strEvlStepCd">
			AND D5.EVL_STEP_CD = #strEvlStepCd#
		</isNotEmpty>			
	</select>
	
	<!-- 이전단계 평가자 정보 조회 -->
	<select id="CSPAOE041Esubselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT MAN.CHGR_DVSN_NM  AS CHGR_DVSN_NM /*단계구분*/
			     , MAN.NAM           AS NAM          /*평가자명*/
			     , F_CODE_NM('1000274', EVL.EVL_RK_CD) AS EVL_RK_NM /*평가등급*/
			 	 , F_CODE_NM('1000280', NVL(EVL_STA_CD, '100')) AS  EVL_STA_NM
			 FROM (
					SELECT '평가자' AS  CHGR_DVSN_NM
					      , F_USR_INFO(D1.CHGR_CNB, '2') AS NAM
					      , D1.EVL_YR
					      , D1.HLYR_DVSN_CD
					      , D1.TSK_DVSN_CD
					      , D1.AUD_TSK_KND_CD
					      , D1.CHGR_DVSN_CD
					      , D1.CHGR_CNB
					      , #strTskNo# AS TSK_NO
					 FROM TBCSPAOE017D D1
					WHERE 1=1
					  AND D1.EVL_YR         = #strEvlYr#
					  AND D1.HLYR_DVSN_CD   = #strHlyrDvsnCd#
					  AND D1.TSK_DVSN_CD    = #strTskDvsnCd#
					  AND D1.AUD_TSK_KND_CD = #strAudTskKndCd#
					  AND D1.CHGR_DVSN_CD = (
			                                    SELECT CASE WHEN LENGTH(#strChgrDvsnCd#) = '4' THEN 'CD' || LPAD(TO_NUMBER(SUBSTR(#strChgrDvsnCd#, 3)) - 1, 2, 0)
			                                                ELSE 'CD' || TRIM(LPAD(TO_NUMBER(SUBSTR(#strChgrDvsnCd#, 3)) - 1, 3)) END AS CHGR_DVSN_CD
			                                      FROM DUAL
			                                 ) /*해당 업무종류의 평가자를 찾아야한다.*/
			      ) MAN
			      , TBCSPAOE029M EVL
			WHERE MAN.EVL_YR         = EVL.EVL_YR (+)
			  AND MAN.HLYR_DVSN_CD   = EVL.HLYR_DVSN_CD (+)
			  AND MAN.TSK_DVSN_CD    = EVL.TSK_DVSN_CD (+)
			  AND MAN.AUD_TSK_KND_CD = EVL.AUD_TSK_KND_CD (+)
			  AND MAN.CHGR_DVSN_CD   = EVL.EVL_CMTR_DVSN_CD (+)
			  AND MAN.CHGR_CNB       = EVL.EVL_CMTR_CNB (+)		
			  AND MAN.TSK_NO         = EVL.TSK_NO (+)
		]]>
	</select>
	
	<!-- 신규 or 수정된 정보를 저장한다. -->
	<update id="CSPAOE041Emainupdate" parameterClass="paramMap">
		<![CDATA[
			MERGE INTO TBCSPAOE029M
		    USING DUAL
			   ON ( 
					    EVL_YR           = #EVL_YR#
					AND HLYR_DVSN_CD     = #HLYR_DVSN_CD#
					AND TSK_DVSN_CD      = #TSK_DVSN_CD#
					AND AUD_TSK_KND_CD   = #AUD_TSK_KND_CD#
					AND EVL_STEP_CD      = #EVL_STEP_CD#
					AND EVL_CMTR_DVSN_CD = #EVL_CMTR_DVSN_CD#
					AND EVL_CMTR_CNB     = #EVL_CMTR_CNB#
					AND AUD_YR			 = #EVL_YR#
					AND TSK_NO           = #TSK_NO#
			  	   )
			WHEN MATCHED  THEN 		
				UPDATE 
				   SET FNL_MDF_DH      = SYSDATE
				     , EVL_STA_CD      = #EVL_STA_CD#
		             , EVL_OPIN        = #EVL_OPIN#
		             , NAUD_TSK_EVL_SC = #NAUD_TSK_EVL_SC#
		             , EVL_RK_CD       = #EVL_RK_CD#
		             , EVL_DTM_YN      = #EVL_DTM_YN#
		]]>
		<isNotEmpty prepend="," property="FNL_USR_ID">
			FNL_USR_ID = #FNL_USR_ID#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
			FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_MNU_ID">
			FNL_MNU_ID = #FNL_MNU_ID#
		</isNotEmpty>
		<![CDATA[
            WHEN NOT MATCHED THEN 
				INSERT 
				    (
				       EVL_YR
					 , HLYR_DVSN_CD
					 , TSK_DVSN_CD
					 , AUD_TSK_KND_CD
					 , EVL_STEP_CD
					 , EVL_CMTR_DVSN_CD
					 , EVL_CMTR_CNB
					 , AUD_YR
					 , TSK_NO
					 , EVL_STA_CD
					 , EVL_RK_CD
					 , EVL_OPIN
					 , NAUD_TSK_EVL_SC
					 , EVL_DTM_YN
				 	 , FRT_USR_ID
				 	 , FNL_USR_ID
					 , FNL_DEAL_DPT_CD
					 , FNL_MNU_ID
					 , FRT_REGI_DH
					 , FNL_MDF_DH
					)  VALUES 
					(
				       #EVL_YR#
					 , #HLYR_DVSN_CD#
					 , #TSK_DVSN_CD#
					 , #AUD_TSK_KND_CD#
					 , #EVL_STEP_CD#
					 , #EVL_CMTR_DVSN_CD#
					 , #EVL_CMTR_CNB#
					 , #EVL_YR#
					 , #TSK_NO#
					 , #EVL_STA_CD# 
					 , #EVL_RK_CD#
					 , #EVL_OPIN#
					 , #NAUD_TSK_EVL_SC#
					 , #EVL_DTM_YN#
					 , #FNL_USR_ID#
					 , #FNL_USR_ID#
					 , #FNL_DEAL_DPT_CD#
					 , #FNL_MNU_ID#
					 , SYSDATE
					 , SYSDATE	
					 )
		]]>
	</update>
	
	<!-- 인사이력관리를 조회한다. -->
	<select id="CSPAOE041ENevltInfoListselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[  
			SELECT D1.EVL_YR                                                  AS EVL_YR         /*평가년도*/
			     , D1.HLYR_DVSN_CD                                            AS HLYR_DVSN_CD   /*반기구분코드*/
			     , D1.PTCPT_CNB                                               AS NEVLT_CNB      /*피평가자 전산번호*/     
			     , '10001'                                                    AS TSK_DVSN_CD    /*업무구분코드 - 감사외업무*/
			     , D1.TSK_KND_CD                                              AS AUD_TSK_KND_CD /*감사업무종류코드*/
			     , D1.TSK_NO                                                  AS TSK_NO         /*업무번호*/   
			     , #EVL_CMTR_CNB#                                             AS EVLT_CNB       /*평가자전산번호 */
			     , D2.HIRK_DPT_CD                                             AS DPT_CD_1       /*부서코드1*/
			     , D1.CHR_DPT_CD                                              AS DPT_CD         /*부서코드*/
			     , D1.RANK_CD                                                 AS RANK_CD        /*직급코드*/
			     , ROUND( TO_NUMBER(#NAUD_TSK_EVL_SC#) * (D1.CTB_RTE/100), 2) AS PSN_TSK_ASC    /*개인업무평점*/
			     , #EVL_DTM_YN#                                              AS EVL_DTM_YN     /*평가확정여부*/
			 FROM TBCSPAOE025M D1
			    , TBDCMACM002M D2
			WHERE D1.CHR_DPT_CD = D2.DPT_CD
			  AND EVL_YR        = #EVL_YR#
			  AND HLYR_DVSN_CD  = #HLYR_DVSN_CD#
			  AND TSK_KND_CD    = #AUD_TSK_KND_CD#
			  AND TSK_NO        = #TSK_NO#
		]]>
	</select>
	
	
	<!-- 개인별 평점관리 테이블 신규 or 수정된 정보를 저장한다. -->
	<update id="CSPAOE041EConfinsertupdate" parameterClass="paramMap">
		<![CDATA[
			MERGE INTO TBCSPAOE035M
		    USING DUAL
			   ON (   
					    EVL_YR          = #EVL_YR#
					AND HLYR_DVSN_CD    = #HLYR_DVSN_CD#
					AND TSK_DVSN_CD     = #TSK_DVSN_CD#
					AND AUD_YR			= #EVL_YR#
					AND TSK_NO          = #TSK_NO#
					AND NEVLT_CNB       = #NEVLT_CNB#
					AND EVLT_CNB 		= #EVLT_CNB#
					AND AUD_TSK_KND_CD  = #AUD_TSK_KND_CD#
			  	   )
			WHEN MATCHED  THEN 		
				UPDATE 
				   SET FNL_MDF_DH  = SYSDATE
		             , DPT_CD_1    = #DPT_CD_1#
		             , DPT_CD      = #DPT_CD#
		             , RANK_CD     = #RANK_CD#
		             , PSN_TSK_ASC = #PSN_TSK_ASC#
		]]>
		<isNotEmpty prepend="," property="AUD_SPRT_ASC">
			AUD_SPRT_ASC = #AUD_SPRT_ASC#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_USR_ID">
			FNL_USR_ID = #FNL_USR_ID#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
			FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_MNU_ID">
			FNL_MNU_ID = #FNL_MNU_ID#
		</isNotEmpty>
		<![CDATA[
            WHEN NOT MATCHED THEN 
				INSERT 
				    (
				       EVL_YR
					 , HLYR_DVSN_CD
					 , TSK_DVSN_CD
					 , AUD_YR
					 , TSK_NO
					 , NEVLT_CNB
					 , EVLT_CNB
					 , AUD_TSK_KND_CD
					 , DPT_CD_1
					 , DPT_CD
					 , RANK_CD
					 , PSN_TSK_ASC
				]]>
				<isNotEmpty prepend="," property="SPRT_CVS_ASC">
					SPRT_CVS_ASC
				</isNotEmpty>
				<![CDATA[					 
				 	 , FRT_USR_ID
				 	 , FNL_USR_ID
					 , FNL_DEAL_DPT_CD
					 , FNL_MNU_ID
					 , FRT_REGI_DH
					 , FNL_MDF_DH
					)  VALUES 
					(
				       #EVL_YR#
					 , #HLYR_DVSN_CD#
					 , #TSK_DVSN_CD#
					 , #EVL_YR#
					 , #TSK_NO#
					 , #NEVLT_CNB#
					 , #EVLT_CNB#
					 , #AUD_TSK_KND_CD#
					 , #DPT_CD_1#
					 , #DPT_CD# 
					 , #RANK_CD#
					 , #PSN_TSK_ASC#
				]]>
				<isNotEmpty prepend="," property="SPRT_CVS_ASC">
					#SPRT_CVS_ASC#
				</isNotEmpty>
				<![CDATA[	
					 , #FNL_USR_ID#
					 , #FNL_USR_ID#
					 , #FNL_DEAL_DPT_CD#
					 , #FNL_MNU_ID#
					 , SYSDATE
					 , SYSDATE	
					 )
		]]>
	</update>
	
	<!-- 감사사항 평가관리에 평가확정여부를 Y로 업뎃한다. -->
	<update id="CSPAOE041EConfupdate" parameterClass="paramMap">
		UPDATE TBCSPAOE029M
		SET 
			FNL_MDF_DH = SYSDATE
			, EVL_DTM_YN = #strEvlDtmYn#
			, EVL_STA_CD = #strEvlStaCd#
		<isNotEmpty prepend="," property="FNL_USR_ID">
			FNL_USR_ID = #FNL_USR_ID#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
			FNL_DEAL_DPT_CD =
			#FNL_DEAL_DPT_CD#
		</isNotEmpty>
		<isNotEmpty prepend="," property="FNL_MNU_ID">
			FNL_MNU_ID = #FNL_MNU_ID#
		</isNotEmpty>
		WHERE 1 = 1
		AND EVL_YR = #EVL_YR#
		AND HLYR_DVSN_CD = #HLYR_DVSN_CD#
		AND TSK_DVSN_CD = #TSK_DVSN_CD#
		AND AUD_TSK_KND_CD = #AUD_TSK_KND_CD#
		AND EVL_STEP_CD = #EVL_STEP_CD#
		AND EVL_DVSN_CD = #EVL_DVSN_CD#
		AND EVL_CMTR_CNB = #EVL_CMTR_CNB#
		AND TSK_NO = #TSK_NO#
	</update>
	
	<!-- 확정취소한다. -->
	<update id="CSPAOE041ENoConfupdate" parameterClass="paramMap">
		<![CDATA[	
			UPDATE TBCSPAOE035M
			   SET FNL_MDF_DH  = SYSDATE
	             , EVL_DTM_YN  = #EVL_DTM_YN#
		]]>
				<isNotEmpty prepend="," property="FNL_USR_ID">
					FNL_USR_ID = #FNL_USR_ID#
				</isNotEmpty>
				<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
				</isNotEmpty>
				<isNotEmpty prepend="," property="FNL_MNU_ID">
					FNL_MNU_ID = #FNL_MNU_ID#
				</isNotEmpty>
		<![CDATA[
		   WHERE EVL_YR          = #EVL_YR#
			 AND HLYR_DVSN_CD    = #HLYR_DVSN_CD#
			 AND TSK_DVSN_CD     = #TSK_DVSN_CD#
			 AND AUD_TSK_KND_CD  = #AUD_TSK_KND_CD#
			 AND TSK_NO          = #TSK_NO#
		]]>
	</update>
	
	<!-- 평가등급은 평가등급별 기준관리에서 등록된 평가등급을 가져온다 -->
	<select id="CSPAOE041EEvlRkCdselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT D1.RK_CD          AS CD
			     , D2.CD_NM          AS CD_NM
			     , D1.AUD_TSK_KND_CD AS KEY
			 FROM TBCSPAOE010D D1
			    , TBDCMACM013C D2
			WHERE 1=1
			  AND D1.RK_CD          = D2.CD
			  AND D2.CD             <> '000000000'
			  AND D2.CMM_CD_DVSN_CD = '1000274'
			  AND D2.USE_YN         = 'Y'
			  AND D1.EVL_YR         = #strEvlYr#
			  AND D1.HLYR_DVSN_CD   = #strHlyrDvsnCd#
			  AND D1.TSK_DVSN_CD    = #strTskDvsnCd#
			  AND D1.IDCT_YN        = 'Y'
		]]>
		<isNotEmpty property="strAudTskKndCd">
			AND D1.AUD_TSK_KND_CD = #strAudTskKndCd#
		</isNotEmpty>		
        <![CDATA[ 
        	ORDER BY D2.OTPT_SEQ, D2.CD
		]]>
	</select>
	
	<!-- 시스템 관리자가 아닌 평가자 혹은 관리자가 로그인 했을때 로그인 한 사람이 가지고 있는 평가단계 리스트를 가지고 온다. -->
	<select id="CSPAOE041EEvlStepCdselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT SUM(DECODE(MOD(TO_NUMBER(SUBSTR(CHGR_DVSN_CD, 3)), 2), 0, 1, 0)) AS DIV_700
			     , SUM(DECODE(MOD(TO_NUMBER(SUBSTR(CHGR_DVSN_CD, 3)), 2), 1, 1, 0)) AS DIV_600
			  FROM TBCSPAOE017D
			 WHERE 1=1
			   AND EVL_YR       = #strEvlYr#
			   AND HLYR_DVSN_CD = #strHlyrDvsnCd#
			   AND TSK_DVSN_CD  = '10001'
			   AND CHGR_CNB     = #strEvlCmtrCnb#
		]]>
	</select>
	<!-- ##################################### 감사외업무 평가관리 끝(CSPAOE041E) ##################################### -->
	<!-- 평가유무를 체크한다. -->
	<select id="CSPAOE031EEvlYnselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[  
        	SELECT (
					SELECT DECODE(COUNT(*), 0, 'N', 'Y') AS EVL_YN
					  FROM TBCSPAOE032M
					 WHERE 1=1
					   AND EVL_YR       = #strEvlYr#
					   AND HLYR_DVSN_CD = #strHlyrDvsnCd#
					   AND NEVLT_CNB    = #strPtcptCnb#
					   AND NVL(EVL_STA_CD, '100') != '100' /*미평가가 아닌것*/
					),
					(
					SELECT DECODE(COUNT(*), 0, 'N', 'Y') AS EVL_YN
					  FROM TBCSPAOE032M
					 WHERE 1=1
					   AND EVL_YR       = #strEvlYr#
					   AND HLYR_DVSN_CD = #strHlyrDvsnCd#
					   AND NEVLT_CNB    = #strPtcptCnb#
					   AND EVL_DTM_YN = 'Y' /*미평가가 아닌것*/
					) AS EVL_DTM_YN
			FROM	DUAL
			
		]]>
	</select>
	
	<!-- 평가유무를 체크한다. -->
	<select id="CSPAOE030EEvlYnselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[  
			SELECT	(
					SELECT DECODE(COUNT(*), 0, 'N', 'Y') AS EVL_YN
					  FROM TBCSPAOE031M
					 WHERE 1=1
					   AND EVL_YR       = #strEvlYr#
					   AND HLYR_DVSN_CD = #strHlyrDvsnCd#
					   AND DPT_CD       = #strDeptCd#
					   AND NVL(EVL_STA_CD, '100') != '100') AS EVL_YN /*미평가가 아닌것*/
					,(
						SELECT DECODE(COUNT(*), 0, 'N', 'Y') AS EVL_YN
						  FROM TBCSPAOE031M
						 WHERE 1=1
						   AND EVL_YR       = #strEvlYr#
						   AND HLYR_DVSN_CD = #strHlyrDvsnCd#
						   AND DPT_CD       = #strDeptCd#
						   AND EVL_DTM_YN = 'Y'
					) AS EVL_DTM_YN
			FROM DUAL
		]]>
	</select>
	
	<delete id="CSPAOE030EmainTBCSPAOE031Mdelete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			FROM	TBCSPAOE031M
			WHERE	EVL_YR = #EVL_YR#
			AND		HLYR_DVSN_CD = #HLYR_DVSN_CD#
			AND		TSK_NO = #TSK_NO#
			AND		DPT_CD = #CHR_DPT_CD#
		]]>
	</delete>
	
	<delete id="CSPAOE029EmaindTBCSPAOE029elete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			FROM	TBCSPAOE029M
			WHERE	EVL_YR = #EVL_YR#
			AND		HLYR_DVSN_CD = #HLYR_DVSN_CD#
			AND		AUD_TSK_KND_CD = #TSK_KND_CD#
			AND 	TSK_NO = #TSK_NO#
			AND		TSK_DVSN_CD = '10001'
		]]>
	</delete>
	
	<select id="CSPAOE023EFileSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT T1.AUD_YR
                    ,T1.AUD_NO
                    ,T1.AUD_STEP_CD
                    ,T1.DOC_ID
                    ,T2.AUD_DOC_CD
                    ,T1.AUD_KND_CD
                    ,T1.AUD_GRN_NO
                    ,NVL(T1.RPRT_NM,T2.DTIL_AUD_DOC_NM) AS RPRT_NM
                    ,NVL(T1.RPRT_NM,T2.DTIL_AUD_DOC_NM) AS RPRT_NM1
                    ,NVL(F_CODE_NM('1000773',APV_STA_CD),'미작성') AS APV_STA_NM
                    ,APV_STA_CD
                    ,RPRT_CD
                    ,CASE WHEN APV_STA_CD = '30' THEN F_CODE_NM('1000773',APV_STA_CD)||'('||
                                                  (SELECT APV_DH 
                                                     FROM (
                                                         SELECT TO_CHAR(ST1.APV_DH,'YYYY-MM-DD') AS APV_DH, APV_DOC_NO
                                                         FROM TBDCMACM023L ST1
                                                         WHERE ST1.APVR_KND_CD = '3'
                                                         ORDER BY ST1.APV_SNO DESC)
                                                     WHERE ROWNUM = 1
                                                     AND APV_DOC_NO = T1.APV_RQS_ID) ||')'
                    WHEN APV_STA_CD IS NULL THEN '미작성'
                    ELSE F_CODE_NM('1000773',APV_STA_CD)||'('||TO_CHAR(T1.FNL_MDF_DH,'YYYY-MM-DD')||')'
                END AS RPRT_STAT_CD
                ,F_MNG_KND_AUDYRNO(AUD_YR, AUD_NO, AUD_KND_CD, '-') AS AUD_YR_NO
            FROM    TBBADDED103M T1
                    ,TBFDMADM002M T2
            WHERE   T1.RPRT_CD = T2.AUD_DOC_CD 
            AND     (T1.RPRT_CD IN ('A10200100','A10300100','A10500200','A10500210','A10800100')
            		OR (T2.AUD_DOC_CD = 'A10600200' AND T2.AUD_RPRT_TYPE_CD = SUBSTR(AUD_KND_CD,-1)))
            AND		T1.AUD_YR =#strAudYr#
            AND		T1.AUD_NO = #strTskNo#
		]]>
	</select>
</sqlMap> 	