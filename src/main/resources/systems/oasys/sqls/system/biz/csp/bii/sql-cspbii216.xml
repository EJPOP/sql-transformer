<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/bii/216">

	<!--BARON 활용내역 조회 -->
	<select id="CSPBII216QMainSelect" parameterClass="paramMap" resultClass="resultMap">
	<include refid = "include.pageSelct"/>
        <![CDATA[     
	    SELECT /* csp.bii.service.impl.CSPBII216QServiceImpl.CSPBII216QMainSelect */
	           T1.AUD_YR            	AS AUD_YR           		/*감사년도*/
	         , T1.AUD_NO           		AS AUD_NO           		/*감사번호*/
       		 , T1.AUD_YR_NO             AS AUD_YR_NO 
	         , T1.AUD_GRN_NO       		AS AUD_GRN_NO         		/*감사부여번호 - 2016.05.25 yyh*/
	         , T1.AUD_YR_NO_KND_CD      AS AUD_YR_NO_KND_CD         /*감사연번호종류코드*/
	         , T1.AUD_YR_NO_KND_NM      AS AUD_YR_NO_KND_NM         /*감사연번호종류코드명*/
	         , T1.AUD_DTL_NO    		AS AUD_DTL_NO    		    /*세부연번호*/
	         , T1.AUD_TASK_CD      		AS AUD_TASK_CD      		/*감사과제코드*/
             , T1.AUD_TASK_NM      		AS AUD_TASK_NM      		
	         , T1.ORG_DVSN_CD      		AS ORG_DVSN_CD      		/*기관구분코드*/
	         , T1.AUD_KND_CD       		AS AUD_KND_CD       		/*감사종류코드*/
             , T1.AUD_KND_NM       		AS AUD_KND_NM       		
	         , T1.SPV_BRDV_CD      		AS SPV_BRDV_CD      		/*주관국과코드*/
	         , T1.SPV_BRDV_NM  			AS SPV_BRDV_NM  			/*주관국과명*/
	         , T1.AUD_WAY_CD       		AS AUD_WAY_CD       		/*감사방법코드*/
             , T1.AUD_WAY_NM       		AS AUD_WAY_NM       		
	         , T1.AUD_SBJ_NM       		AS AUD_SBJ_NM       		/*감사사항명*/
	         , T1.AUD_SCL_CD       		AS AUD_SCL_CD       		/*감사규모코드*/
	         , T1.TSK_CAT_CD       		AS TSK_CAT_CD       		/*업무분류코드*/
	         , T1.TSK_CAT_NM       		AS TSK_CAT_NM       		
	         , T1.AUD_RPST_ORG_CD  		AS AUD_RPST_ORG_CD  		/*감사대표기관코드*/
	         , T1.AUD_RPST_ORG_NM  		AS AUD_RPST_ORG_NM  		
	         , T1.MNG_DPT_CD       		AS MNG_DPT_CD       		/*관리부서코드*/
	         , T1.MNG_DPT_NM			AS MNG_DPT_NM
             , T1.PRSS_STEP_CD          AS PRSS_STEP_CD             /*진행단계코드*/
			 , F_CODE_NM('1000785',T1.PRSS_STEP_CD)  
		       || 
		       (CASE WHEN T1.BZT_BGT_DVSN_CD = '1' AND T1.PRSS_STEP_CD = '02'
		                 THEN 
						     (SELECT '/'|| F_CODE_NM('1000030',AUD_BZT_KND_CD)
						        FROM TBBADDED002M 
						       WHERE BZT_YR || BZT_SNO = (SELECT MAX(BZT_YR || BZT_SNO)
												            FROM TBBADDED002M
												           WHERE REL_AUD_YR = T1.AUD_YR
												             AND REL_AUD_NO = T1.AUD_NO
												          )
							 )
				   END) AS PRSS_STEP_NM     		                /*진행단계코드명*/
		       
			 , T1.AUD_STR_DT, T1.AUD_END_DT
			 , T1.FLD_AUD_END_DT AS FLD_AUD_END_DT  /* 종료보고일- 2017.10.31 EUNOK */
		     , T1.DOC_ID
		     , T1.RPRT_NM
		     , TO_CHAR(T1.FNL_APV_DH,'YYYYMMDD') AS FNL_APV_DH
		     , T1.RMK_TXT /* 담당자비고 - 2018.02.01 EUNOK (담당자비고를 정보수집건수로 변경 20200807 EUNOK) */
		     , T1.APV_STA_CD 
		     , T1.DOC_TYPE
		     , T1.DOC_ID2
		     , T1.RPRT_NM2
		     , T1.DOC_TYPE2
          FROM (
          
			    SELECT D1.AUD_YR                   	AS AUD_YR           /*감사년도*/
			         , D1.AUD_NO                   	AS AUD_NO           /*감사번호*/
			         , D1.AUD_GRN_NO                AS AUD_GRN_NO       /*감사부여번호*/
			         , F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D1.AUD_KND_CD, '-')
			                                        AS AUD_YR_NO        /*감사년번호 - 수정(2015.12.17-yyh)*/
			         , CASE WHEN D1.AUD_YR >= '2016' 
			                     THEN D1.AUD_KND_CD
			                ELSE '' 
			            END                         AS AUD_YR_NO_KND_CD /*감사연번호종류코드 추가 - 2015.12.18 yyh*/
			         , CASE WHEN D1.AUD_YR >= '2016' 
			                     THEN F_CODE_NM('1000739',D1.AUD_KND_CD)   
			                ELSE '-' 
			            END                         AS AUD_YR_NO_KND_NM /*감사연번호종류코드명 추가 - 2015.12.22 yyh*/			            
			         , D1.AUD_YR||'-'||SUBSTR(D1.AUD_TASK_CD,-1)||'-'||D1.ORG_DVSN_CD||'-'||SUBSTR(D1.AUD_KND_CD,-1)
			         ||'-'||SUBSTR(D1.SPV_BRDV_CD,1,2)||SUBSTR(D1.SPV_BRDV_CD,4,2)||'-'||SUBSTR(D1.AUD_WAY_CD,-1)||'-'||D1.AUD_NO AS AUD_DTL_NO    /*세부연번호*/
			         , D1.AUD_TASK_CD              	AS AUD_TASK_CD      /*감사과제코드*/
                     , F_CODE_NM_YEAR('1000008', D1.AUD_TASK_CD, D1.AUD_YR) AS AUD_TASK_NM 
			         , D1.ORG_DVSN_CD              	AS ORG_DVSN_CD      /*기관구분코드*/
			         , D1.AUD_KND_CD               	AS AUD_KND_CD       /*감사종류코드*/
                     , F_CODE_NM_YEAR('1000007', D1.AUD_KND_CD, D1.AUD_YR) AS AUD_KND_NM 
			         , D1.SPV_BRDV_CD              	AS SPV_BRDV_CD      /*주관국과코드*/
			         , F_DPT_INFO(D1.SPV_BRDV_CD,'1')	AS SPV_BRDV_NM  /*주관국과명*/
			         , D1.AUD_WAY_CD               	AS AUD_WAY_CD       /*감사방법코드*/
                     , F_CODE_NM_YEAR('1000009', D1.AUD_WAY_CD, D1.AUD_YR) AS AUD_WAY_NM 
			         , D1.AUD_SBJ_NM               	AS AUD_SBJ_NM       /*감사사항명*/
			         , D1.AUD_SCL_CD               	AS AUD_SCL_CD       /*감사규모코드*/
			         , D1.TSK_CAT_CD               	AS TSK_CAT_CD       /*업무분류코드*/
			         , F_CODE_NM('1000120',D1.TSK_CAT_CD) AS TSK_CAT_NM			        
			         , D1.AUD_RPST_ORG_CD          	AS AUD_RPST_ORG_CD  /*감사대표기관코드*/
			         , F_ORG_INFO(D1.AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM 
			         , D1.MNG_DPT_CD               	AS MNG_DPT_CD       /*관리부서코드*/
			         , F_DPT_INFO(D1.MNG_DPT_CD,'1') 		AS MNG_DPT_NM	
 					 , D1.PRSS_STEP_CD                          AS PRSS_STEP_CD   /*진행단계코드*/         
				     , D1.RMK_TXT /* 종료보고일- 2017.10.31 EUNOK */	
				   , D1.BZT_BGT_DVSN_CD	
				   ,(SELECT MIN(AUD_STR_DT)  FROM TBBADDED002M A 
				   		WHERE REL_AUD_YR = D1.AUD_YR AND REL_AUD_NO = D1.AUD_NO AND AUD_BZT_KND_CD IN ('02','03')) AS AUD_STR_DT /* 실지감사 02:실지감사, 03:실지감사연장- 2017.11.14 EUNOK */
				   ,(SELECT MAX(AUD_END_DT)  FROM TBBADDED002M A 
				   		WHERE REL_AUD_YR = D1.AUD_YR AND REL_AUD_NO = D1.AUD_NO AND AUD_BZT_KND_CD IN ('02','03')) AS AUD_END_DT /* 감사종료일 02:실지감사, 03:실지감사연장- 2017.11.07 EUNOK */ 
				   
				   , D3.FLD_AUD_END_DT  /* 종료보고일 - 2017.10.31 EUNOK */
				   , D4.DOC_ID
				   , D4.RPRT_NM 
				   , D4.APV_STA_CD 
				   , D4.DOC_TYPE
				   , D5.FNL_APV_DH
				   , D6.DOC_ID AS DOC_ID2
				   , D6.RPRT_NM AS RPRT_NM2
				   , D6.DOC_TYPE AS DOC_TYPE2
				FROM TBBADDED001M D1
			       , TBCSPDCP101M D2
      			   , TBBADDED003M D3
                   ,(SELECT A1.AUD_YR ,A1.AUD_NO, MAX (A1.APV_STA_CD) AS APV_STA_CD
                         ,SUBSTR(XMLAGG(XMLELEMENT(X,',',DOC_ID) ORDER BY AUD_YR,AUD_NO,AUD_STEP_CD,DOC_ID).EXTRACT('//text()'),2) DOC_ID 
                         ,SUBSTR(XMLAGG(XMLELEMENT(X,',',RPRT_NM) ORDER BY AUD_YR,AUD_NO,AUD_STEP_CD,DOC_ID).EXTRACT('//text()'),2) RPRT_NM 
                         ,F_OPEN_EDIT(A1.LINK_URL)  AS DOC_TYPE
                         FROM TBBADDED103M A1
                 WHERE A1.AUD_STEP_CD = 'A1030'
                 AND A1.RPRT_CD = 'A10300100'
                ]]>
						AND A1.APV_STA_CD = '30'
                        GROUP BY A1.AUD_YR ,A1.AUD_NO, F_OPEN_EDIT(A1.LINK_URL) ) D4 
                         
                    ,(  SELECT MAX(AA.AUD_YR) AS AUD_YR, MAX(AA.AUD_NO) AS AUD_NO, MAX(BB.APV_DH) AS FNL_APV_DH
                         FROM TBBADDED103M AA,TBDCMACM023L BB
                         WHERE AA.AUD_STEP_CD = 'A1030' 
                               AND AA.RPRT_CD  = 'A10300100' 
                               AND AA.APV_RQS_ID = BB.APV_DOC_NO
                               AND AA.APV_STA_CD = '30' 
			 <![CDATA[		
			   			GROUP BY AA.AUD_YR ,AA.AUD_NO,AA.APV_RQS_ID,AA.RPRT_CD) D5	
                   ,(SELECT A1.AUD_YR ,A1.AUD_NO, MAX (A1.APV_STA_CD) AS APV_STA_CD
                         ,SUBSTR(XMLAGG(XMLELEMENT(X,',',DOC_ID) ORDER BY AUD_YR,AUD_NO,AUD_STEP_CD,DOC_ID).EXTRACT('//text()'),2) DOC_ID 
                         ,SUBSTR(XMLAGG(XMLELEMENT(X,',',RPRT_NM) ORDER BY AUD_YR,AUD_NO,AUD_STEP_CD,DOC_ID).EXTRACT('//text()'),2) RPRT_NM 
                         ,F_OPEN_EDIT(A1.LINK_URL)  AS DOC_TYPE
                         FROM TBBADDED103M A1
                 WHERE A1.AUD_STEP_CD = 'A1030'
                 AND A1.RPRT_CD = 'A10300150'
                ]]>
						AND A1.APV_STA_CD = '30'
                        GROUP BY A1.AUD_YR ,A1.AUD_NO, F_OPEN_EDIT(A1.LINK_URL) ) D6 
                         
                    ,(  SELECT MAX(AA.AUD_YR) AS AUD_YR, MAX(AA.AUD_NO) AS AUD_NO, MAX(BB.APV_DH) AS FNL_APV_DH
                         FROM TBBADDED103M AA,TBDCMACM023L BB
                         WHERE AA.AUD_STEP_CD = 'A1030' 
                               AND AA.RPRT_CD  = 'A10300150' 
                               AND AA.APV_RQS_ID = BB.APV_DOC_NO
                               AND AA.APV_STA_CD = '30' 
			 <![CDATA[		
			   			GROUP BY AA.AUD_YR ,AA.AUD_NO,AA.APV_RQS_ID,AA.RPRT_CD) D7				   			
			   				
			   WHERE 1=1
			     AND D1.ACP_YR        = D2.ACP_YR(+)
			     AND D1.CVPT_ACP_NO   = D2.CVPT_ACP_NO(+)
			     AND D1.REQ_DVSN_CD   = D2.REQ_DVSN_CD(+)
			     AND D1.AUD_YR 		  = D3.AUD_YR(+)
			     AND D1.AUD_NO 		  = D3.AUD_NO(+)
			     AND D1.AUD_YR 		  = D4.AUD_YR(+)
			     AND D1.AUD_NO 		  = D4.AUD_NO(+)
			     AND D1.AUD_YR 		  = D5.AUD_YR(+)
			     AND D1.AUD_NO 		  = D5.AUD_NO(+)
			     AND D1.AUD_YR 		  = D6.AUD_YR(+)
			     AND D1.AUD_NO 		  = D6.AUD_NO(+)
			     AND D1.AUD_YR 		  = D7.AUD_YR(+)
			     AND D1.AUD_NO 		  = D7.AUD_NO(+)			     			     
		         /*AND D1.AUD_NO NOT LIKE '9%' 서면모니터링을 걸러내야하므로*/
		         AND D1.AUD_KND_CD NOT LIKE '175'  /* 확인출장 제외 */
		         AND D1.SPV_BRDV_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#)))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/   		
		 ]]>
		
		<isNotEmpty property="strAudSbjNm">	 	   
			     AND D1.AUD_SBJ_NM LIKE '%'||#strAudSbjNm#||'%'
		</isNotEmpty>
		
		<isNotEmpty property="strPrssStepCd">	 
                 AND D1.PRSS_STEP_CD = #strPrssStepCd#
		</isNotEmpty>
		
		<isNotEmpty property="strAudKndCd">	 
			     AND D1.AUD_KND_CD  = #strAudKndCd#
		</isNotEmpty>
		<isNotEmpty property="strSpvBrdvCd">	 
			     AND D1.SPV_BRDV_CD = #strSpvBrdvCd#
		</isNotEmpty>   
		<isNotEmpty property="strReqDvsnCd">	 
			     AND D1.REQ_DVSN_CD = #strReqDvsnCd#
		</isNotEmpty>
		
		<isNotEmpty property="strIsPop">
			 <![CDATA[  
			     /*감사사항검색팝업의 경우 서면/모니터링 감사의 경우 통제가 해제된 건에 대해서만 조회되어야 한다. */
				 AND NOT EXISTS (
		                        SELECT 1
		                          FROM TBBADDED001M 
		                         WHERE 1=1
		                           AND AUD_YR = D1.AUD_YR
		                           AND AUD_NO = D1.AUD_NO
		                           AND SUBSTR(AUD_KND_CD,3,1) = '9' 
		                           AND NVL(SUBSTR(AUD_WAY_CD,3,1),' ') <> '4'
		                       )  
			]]>
		</isNotEmpty>
		
        <![CDATA[ 
        	) T1 
        	WHERE 1=1
        	AND T1.AUD_STR_DT >= '20170908' AND T1.AUD_STR_DT  <= TO_CHAR(SYSDATE,'YYYYMMDD') /*실지감사 시작일이 20170908 이후 이고, 실지감사 시작한 감사사항*/
        	AND T1.AUD_YR BETWEEN #strAudYrSt# AND #strAudYrEnd#
        	AND T1.DOC_ID IS NOT NULL
        	]]>	
        	
			<isNotEmpty property="strAudEnd_DTS">
				AND	TO_CHAR(T1.FNL_APV_DH,'YYYYMMDD') &gt;= #strAudEnd_DTS#
			</isNotEmpty>
			<isNotEmpty property="strAudEnd_DTE">
				AND	TO_CHAR(T1.FNL_APV_DH,'YYYYMMDD') &lt;= #strAudEnd_DTE#
			</isNotEmpty>
        	
		<isNotEmpty property="strAudYrSt">
			<isNotEmpty property="strAudGrnNoSt"> 
        	<![CDATA[     		
			  AND T1.AUD_YR||LPAD(T1.AUD_GRN_NO,4,'0') >= #strAudYrSt#||DECODE(#strAudGrnNoSt#,'','0000', LPAD(#strAudGrnNoSt#,4,'0'))
			]]>
			</isNotEmpty>
		</isNotEmpty>	
		<isNotEmpty property="strAudYrEnd">
		<isNotEmpty property="strAudGrnNoEnd">
        	<![CDATA[     		
			  AND T1.AUD_YR||LPAD(T1.AUD_GRN_NO,4,'0') <= #strAudYrEnd#||DECODE(#strAudGrnNoEnd#,'','9999', LPAD(#strAudGrnNoEnd#,4,'0'))
			]]>
			</isNotEmpty>
		</isNotEmpty>	
		
		/* 감사연번종류코드 추가 - 2015.12.22 yyh */		
		<isNotEmpty property="strAudYrNoKndCdSt">
        	<![CDATA[ 			
                AND SUBSTR(T1.AUD_KND_CD,3,1) = SUBSTR(#strAudYrNoKndCdSt#,3,1)
			]]>                 
		</isNotEmpty>						
        
		<include refid = "include.pageOrder"/> 
	</select>
	
	<!--BARON 활용내역 엑셀다운 -->
	<select id="CSPBII216QExcelSelect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[     
	    SELECT /* csp.bii.service.impl.CSPBII216QServiceImpl.CSPBII216QExcelSelect */
	           T1.AUD_YR              	AS AUD_YR           		/*감사년도*/
	         , T1.AUD_NO           		AS AUD_NO           		/*감사번호*/
       		 , T1.AUD_YR_NO             AS AUD_YR_NO 
	         , T1.AUD_GRN_NO       		AS AUD_GRN_NO         		/*감사부여번호 - 2016.05.25 yyh*/
	         , T1.AUD_YR_NO_KND_CD      AS AUD_YR_NO_KND_CD         /*감사연번호종류코드*/
	         , T1.AUD_YR_NO_KND_NM      AS AUD_YR_NO_KND_NM         /*감사연번호종류코드명*/
	         , T1.AUD_DTL_NO    		AS AUD_DTL_NO    		    /*세부연번호*/
	         , T1.AUD_TASK_CD      		AS AUD_TASK_CD      		/*감사과제코드*/
             , T1.AUD_TASK_NM      		AS AUD_TASK_NM      		
	         , T1.ORG_DVSN_CD      		AS ORG_DVSN_CD      		/*기관구분코드*/
	         , T1.AUD_KND_CD       		AS AUD_KND_CD       		/*감사종류코드*/
             , T1.AUD_KND_NM       		AS AUD_KND_NM       		
	         , T1.SPV_BRDV_CD      		AS SPV_BRDV_CD      		/*주관국과코드*/
	         , T1.SPV_BRDV_NM  			AS SPV_BRDV_NM  			/*주관국과명*/
	         , T1.AUD_WAY_CD       		AS AUD_WAY_CD       		/*감사방법코드*/
             , T1.AUD_WAY_NM       		AS AUD_WAY_NM       		
	         , T1.AUD_SBJ_NM       		AS AUD_SBJ_NM       		/*감사사항명*/
	         , T1.AUD_SCL_CD       		AS AUD_SCL_CD       		/*감사규모코드*/
	         , T1.TSK_CAT_CD       		AS TSK_CAT_CD       		/*업무분류코드*/
	         , T1.TSK_CAT_NM       		AS TSK_CAT_NM       		
	         , T1.AUD_RPST_ORG_CD  		AS AUD_RPST_ORG_CD  		/*감사대표기관코드*/
	         , T1.AUD_RPST_ORG_NM  		AS AUD_RPST_ORG_NM  		
	         , T1.MNG_DPT_CD       		AS MNG_DPT_CD       		/*관리부서코드*/
	         , T1.MNG_DPT_NM			AS MNG_DPT_NM
             , T1.PRSS_STEP_CD          AS PRSS_STEP_CD             /*진행단계코드*/
			 , F_CODE_NM('1000785',T1.PRSS_STEP_CD)  
		       || 
		       (CASE WHEN T1.BZT_BGT_DVSN_CD = '1' AND T1.PRSS_STEP_CD = '02'
		                 THEN 
						     (SELECT '/'|| F_CODE_NM('1000030',AUD_BZT_KND_CD)
						        FROM TBBADDED002M 
						       WHERE BZT_YR || BZT_SNO = (SELECT MAX(BZT_YR || BZT_SNO)
												            FROM TBBADDED002M
												           WHERE REL_AUD_YR = T1.AUD_YR
												             AND REL_AUD_NO = T1.AUD_NO
												          )
							 )
				   END) AS PRSS_STEP_NM     		                /*진행단계코드명*/
		       
			 , T1.AUD_STR_DT, T1.AUD_END_DT
			 , T1.FLD_AUD_END_DT AS FLD_AUD_END_DT  /* 종료보고일- 2017.10.31 EUNOK */
		     , T1.DOC_ID
		     , T1.RPRT_NM
		     , TO_CHAR(T1.FNL_APV_DH,'YYYY-MM-DD') AS FNL_APV_DH
		     , T1.RMK_TXT /* 담당자비고 - 2018.02.01 EUNOK (담당자비고를 정보수집건수로 변경 20200807 EUNOK) */
		     , T1.APV_STA_CD 
		     , T1.DOC_TYPE
		     , T1.DOC_ID2
		     , T1.RPRT_NM2
		     , T1.DOC_TYPE2
          FROM (
          
			    SELECT D1.AUD_YR                   	AS AUD_YR           /*감사년도*/
			         , D1.AUD_NO                   	AS AUD_NO           /*감사번호*/
			         , D1.AUD_GRN_NO                AS AUD_GRN_NO       /*감사부여번호*/
			         , F_MNG_KND_AUDYRNO(D1.AUD_YR, D1.AUD_NO, D1.AUD_KND_CD, '-')
			                                        AS AUD_YR_NO        /*감사년번호 - 수정(2015.12.17-yyh)*/
			         , CASE WHEN D1.AUD_YR >= '2016' 
			                     THEN D1.AUD_KND_CD
			                ELSE '' 
			            END                         AS AUD_YR_NO_KND_CD /*감사연번호종류코드 추가 - 2015.12.18 yyh*/
			         , CASE WHEN D1.AUD_YR >= '2016' 
			                     THEN F_CODE_NM('1000739',D1.AUD_KND_CD)   
			                ELSE '-' 
			            END                         AS AUD_YR_NO_KND_NM /*감사연번호종류코드명 추가 - 2015.12.22 yyh*/			            
			         , D1.AUD_YR||'-'||SUBSTR(D1.AUD_TASK_CD,-1)||'-'||D1.ORG_DVSN_CD||'-'||SUBSTR(D1.AUD_KND_CD,-1)
			         ||'-'||SUBSTR(D1.SPV_BRDV_CD,1,2)||SUBSTR(D1.SPV_BRDV_CD,4,2)||'-'||SUBSTR(D1.AUD_WAY_CD,-1)||'-'||D1.AUD_NO AS AUD_DTL_NO    /*세부연번호*/
			         , D1.AUD_TASK_CD              	AS AUD_TASK_CD      /*감사과제코드*/
                     , F_CODE_NM_YEAR('1000008', D1.AUD_TASK_CD, D1.AUD_YR) AS AUD_TASK_NM 
			         , D1.ORG_DVSN_CD              	AS ORG_DVSN_CD      /*기관구분코드*/
			         , D1.AUD_KND_CD               	AS AUD_KND_CD       /*감사종류코드*/
                     , F_CODE_NM_YEAR('1000007', D1.AUD_KND_CD, D1.AUD_YR) AS AUD_KND_NM 
			         , D1.SPV_BRDV_CD              	AS SPV_BRDV_CD      /*주관국과코드*/
			         , F_DPT_INFO(D1.SPV_BRDV_CD,'1')	AS SPV_BRDV_NM  /*주관국과명*/
			         , D1.AUD_WAY_CD               	AS AUD_WAY_CD       /*감사방법코드*/
                     , F_CODE_NM_YEAR('1000009', D1.AUD_WAY_CD, D1.AUD_YR) AS AUD_WAY_NM 
			         , D1.AUD_SBJ_NM               	AS AUD_SBJ_NM       /*감사사항명*/
			         , D1.AUD_SCL_CD               	AS AUD_SCL_CD       /*감사규모코드*/
			         , D1.TSK_CAT_CD               	AS TSK_CAT_CD       /*업무분류코드*/
			         , F_CODE_NM('1000120',D1.TSK_CAT_CD) AS TSK_CAT_NM			        
			         , D1.AUD_RPST_ORG_CD          	AS AUD_RPST_ORG_CD  /*감사대표기관코드*/
			         , F_ORG_INFO(D1.AUD_RPST_ORG_CD,'1')  AS AUD_RPST_ORG_NM 
			         , D1.MNG_DPT_CD               	AS MNG_DPT_CD       /*관리부서코드*/
			         , F_DPT_INFO(D1.MNG_DPT_CD,'1') 		AS MNG_DPT_NM	
 					 , D1.PRSS_STEP_CD                          AS PRSS_STEP_CD   /*진행단계코드*/         
				     , D1.RMK_TXT /* 종료보고일- 2017.10.31 EUNOK */	
				   , D1.BZT_BGT_DVSN_CD	
				   ,(SELECT MIN(AUD_STR_DT)  FROM TBBADDED002M A 
				   		WHERE REL_AUD_YR = D1.AUD_YR AND REL_AUD_NO = D1.AUD_NO AND AUD_BZT_KND_CD IN ('02','03')) AS AUD_STR_DT /* 실지감사 02:실지감사, 03:실지감사연장- 2017.11.14 EUNOK */
				   ,(SELECT MAX(AUD_END_DT)  FROM TBBADDED002M A 
				   		WHERE REL_AUD_YR = D1.AUD_YR AND REL_AUD_NO = D1.AUD_NO AND AUD_BZT_KND_CD IN ('02','03')) AS AUD_END_DT /* 감사종료일 02:실지감사, 03:실지감사연장- 2017.11.07 EUNOK */ 
				   
				   , D3.FLD_AUD_END_DT  /* 종료보고일 - 2017.10.31 EUNOK */
				   , D4.DOC_ID
				   , D4.RPRT_NM 
				   , D4.APV_STA_CD 
				   , D4.DOC_TYPE
				   , D5.FNL_APV_DH
				   , D6.DOC_ID AS DOC_ID2
				   , D6.RPRT_NM AS RPRT_NM2
				   , D6.DOC_TYPE AS DOC_TYPE2
				FROM TBBADDED001M D1
			       , TBCSPDCP101M D2
      			   , TBBADDED003M D3
                   ,(SELECT A1.AUD_YR ,A1.AUD_NO, MAX (A1.APV_STA_CD) AS APV_STA_CD
                         ,SUBSTR(XMLAGG(XMLELEMENT(X,',',DOC_ID) ORDER BY AUD_YR,AUD_NO,AUD_STEP_CD,DOC_ID).EXTRACT('//text()'),2) DOC_ID 
                         ,SUBSTR(XMLAGG(XMLELEMENT(X,',',RPRT_NM) ORDER BY AUD_YR,AUD_NO,AUD_STEP_CD,DOC_ID).EXTRACT('//text()'),2) RPRT_NM 
                         ,F_OPEN_EDIT(A1.LINK_URL)  AS DOC_TYPE
                         FROM TBBADDED103M A1
                 WHERE A1.AUD_STEP_CD = 'A1030'
                 AND A1.RPRT_CD = 'A10300100'
                ]]>
						AND A1.APV_STA_CD = '30'
                        GROUP BY A1.AUD_YR ,A1.AUD_NO, F_OPEN_EDIT(A1.LINK_URL) ) D4 
                         
                    ,(  SELECT MAX(AA.AUD_YR) AS AUD_YR, MAX(AA.AUD_NO) AS AUD_NO, MAX(BB.APV_DH) AS FNL_APV_DH
                         FROM TBBADDED103M AA,TBDCMACM023L BB
                         WHERE AA.AUD_STEP_CD = 'A1030' 
                               AND AA.RPRT_CD  = 'A10300100' 
                               AND AA.APV_RQS_ID = BB.APV_DOC_NO
                               AND AA.APV_STA_CD = '30' 
			 <![CDATA[		
			   			GROUP BY AA.AUD_YR ,AA.AUD_NO,AA.APV_RQS_ID,AA.RPRT_CD) D5	
                   ,(SELECT A1.AUD_YR ,A1.AUD_NO, MAX (A1.APV_STA_CD) AS APV_STA_CD
                         ,SUBSTR(XMLAGG(XMLELEMENT(X,',',DOC_ID) ORDER BY AUD_YR,AUD_NO,AUD_STEP_CD,DOC_ID).EXTRACT('//text()'),2) DOC_ID 
                         ,SUBSTR(XMLAGG(XMLELEMENT(X,',',RPRT_NM) ORDER BY AUD_YR,AUD_NO,AUD_STEP_CD,DOC_ID).EXTRACT('//text()'),2) RPRT_NM 
                         ,F_OPEN_EDIT(A1.LINK_URL)  AS DOC_TYPE
                         FROM TBBADDED103M A1
                 WHERE A1.AUD_STEP_CD = 'A1030'
                 AND A1.RPRT_CD = 'A10300150'
                ]]>
						AND A1.APV_STA_CD = '30'
                        GROUP BY A1.AUD_YR ,A1.AUD_NO, F_OPEN_EDIT(A1.LINK_URL) ) D6 
                         
                    ,(  SELECT MAX(AA.AUD_YR) AS AUD_YR, MAX(AA.AUD_NO) AS AUD_NO, MAX(BB.APV_DH) AS FNL_APV_DH
                         FROM TBBADDED103M AA,TBDCMACM023L BB
                         WHERE AA.AUD_STEP_CD = 'A1030' 
                               AND AA.RPRT_CD  = 'A10300150' 
                               AND AA.APV_RQS_ID = BB.APV_DOC_NO
                               AND AA.APV_STA_CD = '30' 
			 <![CDATA[		
			   			GROUP BY AA.AUD_YR ,AA.AUD_NO,AA.APV_RQS_ID,AA.RPRT_CD) D7				   			
			   				
			   WHERE 1=1
			     AND D1.ACP_YR        = D2.ACP_YR(+)
			     AND D1.CVPT_ACP_NO   = D2.CVPT_ACP_NO(+)
			     AND D1.REQ_DVSN_CD   = D2.REQ_DVSN_CD(+)
			     AND D1.AUD_YR 		  = D3.AUD_YR(+)
			     AND D1.AUD_NO 		  = D3.AUD_NO(+)
			     AND D1.AUD_YR 		  = D4.AUD_YR(+)
			     AND D1.AUD_NO 		  = D4.AUD_NO(+)
			     AND D1.AUD_YR 		  = D5.AUD_YR(+)
			     AND D1.AUD_NO 		  = D5.AUD_NO(+)
			     AND D1.AUD_YR 		  = D6.AUD_YR(+)
			     AND D1.AUD_NO 		  = D6.AUD_NO(+)
			     AND D1.AUD_YR 		  = D7.AUD_YR(+)
			     AND D1.AUD_NO 		  = D7.AUD_NO(+)			     			     
		         /*AND D1.AUD_NO NOT LIKE '9%' 서면모니터링을 걸러내야하므로*/
		         AND D1.AUD_KND_CD NOT LIKE '175'  /* 확인출장 제외 */
		         AND D1.SPV_BRDV_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #dptAuth#, '', #strUpSpvBrdvCd#)))   /*직급이 원장일 경우 'ALL' 그외는 'DEPTLW'로 셋팅*/   		
		 ]]>
		
		<isNotEmpty property="strAudSbjNm">	 	   
			     AND D1.AUD_SBJ_NM LIKE '%'||#strAudSbjNm#||'%'
		</isNotEmpty>
		
		<isNotEmpty property="strPrssStepCd">	 
                 AND D1.PRSS_STEP_CD = #strPrssStepCd#
		</isNotEmpty>
		
		<isNotEmpty property="strAudKndCd">	 
			     AND D1.AUD_KND_CD  = #strAudKndCd#
		</isNotEmpty>
		<isNotEmpty property="strSpvBrdvCd">	 
			     AND D1.SPV_BRDV_CD = #strSpvBrdvCd#
		</isNotEmpty>   
		<isNotEmpty property="strReqDvsnCd">	 
			     AND D1.REQ_DVSN_CD = #strReqDvsnCd#
		</isNotEmpty>
		
		<isNotEmpty property="strIsPop">
			 <![CDATA[  
			     /*감사사항검색팝업의 경우 서면/모니터링 감사의 경우 통제가 해제된 건에 대해서만 조회되어야 한다. */
				 AND NOT EXISTS (
		                        SELECT 1
		                          FROM TBBADDED001M 
		                         WHERE 1=1
		                           AND AUD_YR = D1.AUD_YR
		                           AND AUD_NO = D1.AUD_NO
		                           AND SUBSTR(AUD_KND_CD,3,1) = '9' 
		                           AND NVL(SUBSTR(AUD_WAY_CD,3,1),' ') <> '4'
		                       )  
			]]>
		</isNotEmpty>
		
        <![CDATA[ 
        	) T1 
        	WHERE 1=1
        	AND T1.AUD_STR_DT >= '20170908' AND T1.AUD_STR_DT  <= TO_CHAR(SYSDATE,'YYYYMMDD') /*실지감사 시작일이 20170908 이후 이고, 실지감사 시작한 감사사항*/
        	AND T1.AUD_YR BETWEEN #strAudYrSt# AND #strAudYrEnd#
        	AND T1.DOC_ID IS NOT NULL
        	]]>	
		<isNotEmpty property="strAudYrSt">
			<isNotEmpty property="strAudGrnNoSt"> 
        	<![CDATA[     		
			  AND T1.AUD_YR||LPAD(T1.AUD_GRN_NO,4,'0') >= #strAudYrSt#||DECODE(#strAudGrnNoSt#,'','0000', LPAD(#strAudGrnNoSt#,4,'0'))
			]]>
			</isNotEmpty>
		</isNotEmpty>	
		<isNotEmpty property="strAudYrEnd">
		<isNotEmpty property="strAudGrnNoEnd">
        	<![CDATA[     		
			  AND T1.AUD_YR||LPAD(T1.AUD_GRN_NO,4,'0') <= #strAudYrEnd#||DECODE(#strAudGrnNoEnd#,'','9999', LPAD(#strAudGrnNoEnd#,4,'0'))
			]]>
			</isNotEmpty>
		</isNotEmpty>	
		
			<isNotEmpty property="strAudEnd_DTS">
				AND	TO_CHAR(T1.FNL_APV_DH,'YYYYMMDD') &gt;= #strAudEnd_DTS#
			</isNotEmpty>
			<isNotEmpty property="strAudEnd_DTE">
				AND	TO_CHAR(T1.FNL_APV_DH,'YYYYMMDD') &lt;= #strAudEnd_DTE#
			</isNotEmpty>		
		
		/* 감사연번종류코드 추가 - 2015.12.22 yyh */		
		<isNotEmpty property="strAudYrNoKndCdSt">
        	<![CDATA[ 			
                AND SUBSTR(T1.AUD_KND_CD,3,1) = SUBSTR(#strAudYrNoKndCdSt#,3,1)
			]]>                 
		</isNotEmpty>
		
 			 ORDER BY AUD_YR DESC, AUD_NO DESC
        
	</select>	

</sqlMap>