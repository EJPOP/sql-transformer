<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/iit/046">
	
	<select id="CSPIIT046QMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<include refid = "include.pageSelct"/>
        <![CDATA[
			SELECT 	DISTINCT A.AUD_YR,
					A.AUD_NO,			
					A.DSP_RQ_KND_CD,
					A.DSP_RQ_ENF_DT,
					A.RQS_TIT_NM,			/*활용내역명*/
					A.AUD_SBJ_NM,
					B.USR_NAM AS RQR_NAM,	/*제출자명*/
					A.CNB,					/*제출자전산번호*/
                    A.DPT_CD,
                    A.TIT_TXT,
                    D.DPT_NM AS DPT_NM,
                    A.DOC_ID,
                    A.AUD_GRN_NO,
                    F_CODE_NM('1000002',A.DSP_RQ_KND_CD) AS DSP_RQ_KND_NM,
                    CASE WHEN C.AUD_YR >= '2016' 
			                THEN C.AUD_KND_CD
			        ELSE '' 
			        END                              AS AUD_YR_NO_KND_CD,
			        D.HIRK_DPT_CD,
			        F_CODE_NM('1000978',A.APP_KND_CD) AS APP_KND_NM
			FROM   	TBCSPIIT026M A,
					TBDCMACM001M B, 		/*사용자테이블(제출자)*/
                    TBBADDED001M C,
                    TBDCMACM002M D			/*부서코드(요청자)*/
			WHERE	A.CNB = B.CNB(+)
            AND     A.DPT_CD = D.DPT_CD(+)
            AND     A.AUD_YR = C.AUD_YR(+)
            AND     A.AUD_NO = C.AUD_NO(+)
        ]]>
        <dynamic>
        	<isNotEmpty property="strDSP_RQ_ENF_DTS">
        		AND	A.DSP_RQ_ENF_DT &gt;= #strDSP_RQ_ENF_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strDSP_RQ_ENF_DTE">
        		AND	A.DSP_RQ_ENF_DT &lt;= #strDSP_RQ_ENF_DTE#
        	</isNotEmpty>
        	<isNotEmpty property="strSEARCH_NM">
        		AND	(D.DPT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.AUD_SBJ_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.RQS_TIT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.TIT_TXT LIKE '%'||#strSEARCH_NM#||'%')
        	</isNotEmpty>
        	<isNotEmpty property="strRQR_NAM">
        		AND B.USR_NAM LIKE '%'||#strRQR_NAM#||'%'
        	</isNotEmpty>
        	<isNotEmpty property="strSpvBrdvCd">
			     AND A.DPT_CD = #strSpvBrdvCd#
			</isNotEmpty>
			<isNotEmpty property="strRQS_KND_CD">	 
			     AND A.DSP_RQ_KND_CD = #strRQS_KND_CD#
			</isNotEmpty>
        </dynamic> 
        <include refid = "include.pageOrder"/> 
	</select>     
	
	<select id="CSPIIT047EMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[
        	SELECT  A.AUD_YR, 
        			A.AUD_NO,
        			A.DSP_RQ_ENF_DT, 
        			A.CNB,
        			(SELECT USR_NAM 
        			FROM TBDCMACM001M Z
        			WHERE A.CNB = Z.CNB
        			) AS RQR_NAM,		/*요청자명*/
        			A.RQS_TIT_NM,	/*활용내역명*/
			 		A.TIT_TXT,
                    A.DSP_RQ_KND_CD,
                    F_CODE_NM('1000002',A.DSP_RQ_KND_CD) AS DSP_RQ_KND_NM,
                    A.DPT_CD,
                    A.AUD_SBJ_NM,
                    A.AUD_GRN_NO,
                    A.DOC_ID,
                    CASE WHEN B.AUD_YR >= '2016' 
			                THEN B.AUD_KND_CD
			        ELSE '' 
			        END                              AS AUD_YR_NO_KND_CD,
			        (SELECT C.HIRK_DPT_CD
				       FROM  TBDCMACM002M C
				      WHERE A.DPT_CD = C.DPT_CD) AS HIRK_DPT_CD,
				      F_CODE_NM('1000978',A.APP_KND_CD) AS APP_KND_NM,
				      A.APP_KND_CD
        	FROM	TBCSPIIT026M A
        		   ,TBBADDED001M B
        	WHERE 1=1
              AND	A.AUD_YR = B.AUD_YR(+)
              AND	A.AUD_NO = B.AUD_NO(+)
			  AND A.AUD_YR = #strAUD_YR#
			  AND A.AUD_NO = #strAUD_NO#
        	]]>
        	<dynamic>
        	<isNotEmpty property="strDSP_RQ_ENF_DTS">
        		AND	A.DSP_RQ_ENF_DT &gt;= #strDSP_RQ_ENF_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strDSP_RQ_ENF_DTE">
        		AND	A.DSP_RQ_ENF_DT &lt;= #strDSP_RQ_ENF_DTE#
        	</isNotEmpty>
        	<isNotEmpty property="strSEARCH_NM">
        		AND	(D.DPT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.AUD_SBJ_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.RQS_TIT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.TIT_TXT LIKE '%'||#strSEARCH_NM#||'%')
        	</isNotEmpty>
        	<isNotEmpty property="strRQR_NAM">
        		AND B.USR_NAM LIKE '%'||#strRQR_NAM#||'%'
        	</isNotEmpty>
        	<isNotEmpty property="strDPT_CD">
			     AND A.DPT_CD = #strDPT_CD#
			</isNotEmpty>
			<isNotEmpty property="strDSP_RQ_KND_CD">	 
			     AND A.DSP_RQ_KND_CD = #strDSP_RQ_KND_CD#
			</isNotEmpty>
        </dynamic> 
	</select>
	
	<insert id="CSPIIT047EMainInsert" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO TBCSPIIT026M
        	(		AUD_YR,
        			AUD_NO,
        			CNB,
        			DPT_CD,
        			RQS_TIT_NM,
        			DSP_RQ_KND_CD,
        			DSP_RQ_ENF_DT,
        			AUD_SBJ_NM,
        			TIT_TXT,
        			AUD_GRN_NO,
        			DOC_ID,
        			APP_KND_CD,
        			FRT_USR_ID,
					FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH
        	) VALUES (
        			#AUD_YR#,
        			#AUD_NO#,
        			#CNB#,
        			#DPT_CD#,
        			#RQS_TIT_NM#,
        			#DSP_RQ_KND_CD#,
        			#DSP_RQ_ENF_DT#,
        			#AUD_SBJ_NM#,
        			#TIT_TXT#,
        			#AUD_GRN_NO#,
        			#DOC_ID#,
        			#APP_KND_CD#,
	        		#FRT_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
					SYSDATE
        	)
        ]]>
	</insert>
	
	<update id="CSPIIT047EMainUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPIIT026M
			SET		CNB = #CNB#,
					DPT_CD = #DPT_CD#,
					RQS_TIT_NM = #RQS_TIT_NM#,
					DSP_RQ_KND_CD = #DSP_RQ_KND_CD#,
					DSP_RQ_ENF_DT = #DSP_RQ_ENF_DT#,
					AUD_SBJ_NM = #AUD_SBJ_NM#,
					TIT_TXT = #TIT_TXT#,
					DOC_ID = #DOC_ID#,
					APP_KND_CD = #APP_KND_CD#,
					FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE
			WHERE	AUD_YR = #AUD_YR#
			AND		AUD_NO = #AUD_NO#
			AND		AUD_GRN_NO = #AUD_GRN_NO#
		]]>
	</update>
	
	<delete id="CSPIIT047EMainDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE	
			FROM	TBCSPIIT026M
			WHERE	AUD_YR = #AUD_YR#
			AND		AUD_NO = #AUD_NO#
		]]>
	</delete>

	
	<!-- 전산개선 및 자료요청 엑셀다운로드 -->
	<select id="CSPIIT046QExcelExportSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[
			SELECT 	DISTINCT A.AUD_YR,
					A.AUD_NO,			
					A.DSP_RQ_KND_CD,
					A.DSP_RQ_ENF_DT,
					A.RQS_TIT_NM,			/*활용내역명*/
					A.AUD_SBJ_NM,
					B.USR_NAM AS RQR_NAM,	/*제출자명*/
					A.CNB,					/*제출자전산번호*/
                    A.DPT_CD,
                    A.TIT_TXT,
                    D.DPT_NM AS DPT_NM,
                    A.DOC_ID,
                    A.AUD_GRN_NO,
                    F_CODE_NM('1000002',A.DSP_RQ_KND_CD) AS DSP_RQ_KND_NM,
                    CASE WHEN C.AUD_YR >= '2016' 
			                THEN C.AUD_KND_CD
			        ELSE '' 
			        END                              AS AUD_YR_NO_KND_CD,
			        D.HIRK_DPT_CD,
			        F_CODE_NM('1000978',A.APP_KND_CD) AS APP_KND_NM
			FROM   	TBCSPIIT026M A,
					TBDCMACM001M B, 		/*사용자테이블(제출자)*/
                    TBBADDED001M C,
                    TBDCMACM002M D			/*부서코드(요청자)*/
			WHERE	A.CNB = B.CNB(+)
            AND     A.DPT_CD = D.DPT_CD(+)
            AND     A.AUD_YR = C.AUD_YR(+)
            AND     A.AUD_NO = C.AUD_NO(+)
        ]]>
        <dynamic>
        	<isNotEmpty property="strDSP_RQ_ENF_DTS">
        		AND	A.DSP_RQ_ENF_DT &gt;= #strDSP_RQ_ENF_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strDSP_RQ_ENF_DTE">
        		AND	A.DSP_RQ_ENF_DT &lt;= #strDSP_RQ_ENF_DTE#
        	</isNotEmpty>
        	<isNotEmpty property="strSEARCH_NM">
        		AND	(D.DPT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.AUD_SBJ_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.RQS_TIT_NM LIKE '%'||#strSEARCH_NM#||'%'
        				OR A.TIT_TXT LIKE '%'||#strSEARCH_NM#||'%')
        	</isNotEmpty>
        	<isNotEmpty property="strRQR_NAM">
        		AND B.USR_NAM LIKE '%'||#strRQR_NAM#||'%'
        	</isNotEmpty>
        	<isNotEmpty property="strSpvBrdvCd">
			     AND A.DPT_CD = #strSpvBrdvCd#
			</isNotEmpty>
			<isNotEmpty property="strDSP_RQ_KND_CD">	 
			     AND A.DSP_RQ_KND_CD = #strDSP_RQ_KND_CD#
			</isNotEmpty>
        	</dynamic> 
        <![CDATA[
        	ORDER BY A.AUD_YR, A.AUD_NO DESC
        ]]>
	</select>
	
	<select id="CSPIIT047ERqrUsrID" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[   
			SELECT A.CNB, (SELECT USR_ID FROM TBDCMACM001M S WHERE S.CNB = A.CNB) AS USR_ID FROM TBCSPIIT026M A    
        		WHERE  AUD_YR = #AUD_YR#
        		  AND  AUD_NO = #AUD_NO#
        		  AND  AUD_GRN_NO = #AUD_GRN_NO#
		]]>
	</select>
	
	<!-- BARON담당자전산번호 가져오기 -->
	<select id="CSPIIT047ECnbSelect" parameterClass="paramMap"	resultClass="resultMap">
        <![CDATA[     	
			SELECT TO_CHAR( EXTRACT(XMLAGG(XMLELEMENT(A, ''|| USR_DFN_TXT_1) ORDER BY USR_DFN_TXT_1), '//text()') ) AS RCNT_CNB
            FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD='1000882' AND USR_DFN_TXT_3='BARON'
		]]>
	</select>
	
	<select id="CSPIIT047ECodeSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT D1.CD
           		 , D1.CD_NM
              FROM TBDCMACM013C D1 
             WHERE 1=1
               AND D1.CD <> '000000000'
         	   AND D1.CMM_CD_DVSN_CD = '1000002'
		]]>
	</select>
	
	<select id="CSPIIT047ECodeSelect2" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT D1.CD
           		 , D1.CD_NM
              FROM TBDCMACM013C D1 
             WHERE 1=1
               AND D1.CD <> '000000000'
         	   AND D1.CMM_CD_DVSN_CD = '1000978'
		]]>
	</select>
	
	<select id="CSPIIT047EAudYrNoKndCdSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT D1.CD
           		 , D1.CD_NM
              FROM TBDCMACM013C D1 
             WHERE 1=1
               AND D1.CD <> '000000000'
         	   AND D1.CMM_CD_DVSN_CD = '1000739'
               AND D1.USE_YN = 'Y'
               ORDER BY USR_DFN_TXT_2
		]]>
	</select>
</sqlMap> 
