<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/ear/099">

	<!--처분요구목록 조회-->
	<select id="BADEAR099PMainSelect" parameterClass="paramMap" resultClass="resultMap">
        SELECT  
		        A.REQ_DVSN_CD as REQ_DVSN_CD,
		        A.ACP_YR      as ACP_YR     ,
		        A.CVPT_ACP_NO as CVPT_ACP_NO,
		        A.RPRT_NM     as RPRT_NM    ,
		        A.DOC_ID      as DOC_ID     ,
		        F_CODE_NM('1000773',A.APV_STA_CD) AS APV_STA_NM
		  FROM TBCSPDCP603M A 
		      ,TBCSPEAR001M B
		 WHERE 1=1
		   AND A.ACP_YR      = B.ACP_YR
		   AND A.CVPT_ACP_NO = B.CVPT_ACP_NO
		   AND A.REQ_DVSN_CD = B.REQ_DVSN_CD
		   
		<isNotEmpty property="AUD_YR">	
		   AND A.ACP_YR = #AUD_YR#
		</isNotEmpty>
		
		<isNotEmpty property="AUD_NO">	
		   AND A.CVPT_ACP_NO = #AUD_NO#
		</isNotEmpty>
		
		<isNotEmpty property="REQ_DVSN_CD">	
		   AND A.REQ_DVSN_CD = #REQ_DVSN_CD#
		</isNotEmpty>
		
		<isNotEmpty property="SND_APV_DOC_NO">	
		   AND B.SND_APV_DOC_NO = #SND_APV_DOC_NO#
		</isNotEmpty>
		
		   
		   UNION ALL
		   
		   SELECT  
		        C.REQ_DVSN_CD    as REQ_DVSN_CD,
		        C.ACP_YR         as ACP_YR     ,
		        C.CVPT_ACP_NO    as CVPT_ACP_NO,
		        C.FILE_NM        as RPRT_NM    ,
		        C.ACP_DCM_DOC_ID as DOC_ID     ,
		        NULL           as APV_STA_NM
		  FROM TBCSPDCP608D C
		      ,TBCSPEAR001M D
		 WHERE 1=1
		   AND C.ACP_YR      = D.ACP_YR
		   AND C.CVPT_ACP_NO = D.CVPT_ACP_NO
		   AND C.REQ_DVSN_CD = D.REQ_DVSN_CD
		   
		<isNotEmpty property="AUD_YR">	
		   AND C.ACP_YR = #AUD_YR#
		</isNotEmpty>
		
		<isNotEmpty property="AUD_NO">	
		   AND C.CVPT_ACP_NO = #AUD_NO#
		</isNotEmpty>
		
		<isNotEmpty property="REQ_DVSN_CD">	
		   AND C.REQ_DVSN_CD = #REQ_DVSN_CD#
		</isNotEmpty>
		
		<isNotEmpty property="SND_APV_DOC_NO">	
		   AND D.SND_APV_DOC_NO = #SND_APV_DOC_NO#
		</isNotEmpty>
		
	</select>


	<!-- 결재상신 update -->
	<update id="BADEAR099PApvupdate_1" parameterClass="paramMap">
        <![CDATA[
			UPDATE TBCSPEAR001M
			SET
                SND_STA_CD        = #SND_STA_CD#         /* 송부상태코드 */
			   ,SND_APV_DOC_NO    = #SND_APV_DOC_NO#     /* 송부결재문서번호 */
			   ,SND_RET_RSN_TXT   = ''                   /* 송부반려사유내용 */
			   ,FNL_USR_ID        = #FNL_USR_ID#
			   ,FNL_DEAL_DPT_CD   = #FNL_DEAL_DPT_CD#
			   ,FNL_MNU_ID        = #FNL_MNU_ID#
			   ,FNL_MDF_DH        = SYSDATE
			WHERE 1 = 1
			  AND ACP_YR = #AUD_YR#
			  AND CVPT_ACP_NO = #AUD_NO#
			  AND REQ_DVSN_CD = #REQ_DVSN_CD#
        ]]>
	</update>	
	
		
	<!-- 결재 update -->
	<update id="BADEAR099PApvupdate_2" parameterClass="paramMap">
        <![CDATA[
			UPDATE TBCSPEAR001M
			SET
                SND_STA_CD        = #SND_STA_CD#                           /* 송부상태코드 */
			   ,FNL_USR_ID        = #FNL_USR_ID#
			   ,SND_APV_DOC_NO    = #SND_APV_DOC_NO#     /* 송부결재문서번호 */
			   ,FNL_DEAL_DPT_CD   = #FNL_DEAL_DPT_CD#
			   ,FNL_MNU_ID        = #FNL_MNU_ID#
			   ,FNL_MDF_DH        = SYSDATE
       	    WHERE SND_APV_DOC_NO = #SND_APV_DOC_NO#
       ]]>
	</update>	
			
	<!-- 결재 update -->
	<update id="BADEAR099PApvupdate_3" parameterClass="paramMap">
        
					UPDATE TBCSPDCP101M
					   SET AUD_INF_TRF_DVSN_CD	= 'T'    /* 감사정보이관구분코드  */
					 <isEmpty property="SND_APV_DOC_NO">
							 <isNotEmpty property="AUD_YR">
									  WHERE C.ACP_YR = #AUD_YR#
									  AND C.CVPT_ACP_NO = #AUD_NO#
									  AND C.REQ_DVSN_CD = #REQ_DVSN_CD#
							 </isNotEmpty>
					 </isEmpty>
					 
		   WHERE (REQ_DVSN_CD, ACP_YR, CVPT_ACP_NO) IN (
		                                                SELECT REQ_DVSN_CD, ACP_YR, CVPT_ACP_NO
		                                                  FROM TBCSPEAR001M C
		                                                  
                                 <isEmpty property="HOME_SEND">   
                                  WHERE SND_APV_DOC_NO = #SND_APV_DOC_NO#
                                 </isEmpty>
								 <isNotEmpty property="HOME_SEND">
										 <isNotEmpty property="AUD_YR">		                                                  
		                                                 WHERE C.ACP_YR = #AUD_YR#
														  AND C.CVPT_ACP_NO = #AUD_NO#
														  AND C.REQ_DVSN_CD = #REQ_DVSN_CD#
										</isNotEmpty>
								</isNotEmpty>
										                                                 
		                                                 
		                                                 
		                                                 ) 
					 
					 
       
	</update>		
	
	<update id="BADEAR099PApvupdate_4" parameterClass="paramMap">
        
		 UPDATE TBCSPEAR001M
			SET
                SND_STA_CD        = #SND_STA_CD#                           /* 송부상태코드 */
			   ,FNL_USR_ID        = #FNL_USR_ID#
			   ,SND_APV_DOC_NO    = #SND_APV_DOC_NO#     /* 송부결재문서번호 */
			   ,FNL_DEAL_DPT_CD   = #FNL_DEAL_DPT_CD#
			   ,FNL_MNU_ID        = #FNL_MNU_ID#
			   ,FNL_MDF_DH        = SYSDATE

		 
		 	
		   WHERE (REQ_DVSN_CD, ACP_YR, CVPT_ACP_NO) IN (
		                                                SELECT REQ_DVSN_CD, ACP_YR, CVPT_ACP_NO
		                                                  FROM TBCSPEAR001M
		                                                  
                                 <isEmpty property="HOME_SEND">   
                                 	WHERE SND_APV_DOC_NO = #SND_APV_DOC_NO#
                                 </isEmpty>
								 <isNotEmpty property="HOME_SEND">
										 <isNotEmpty property="AUD_YR">		                                                  
		                                                 WHERE ACP_YR = #AUD_YR#
														  AND CVPT_ACP_NO = #AUD_NO#
														  AND REQ_DVSN_CD = #REQ_DVSN_CD#
										</isNotEmpty>
								</isNotEmpty>
		                                                 
		                                                 
		                                                 )        
	
	</update>				
</sqlMap> 
