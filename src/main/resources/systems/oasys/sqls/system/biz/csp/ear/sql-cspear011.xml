<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/ear/011">
 	<select id="CSPEAR011EMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	A.REQ_DVSN_CD
					,A.ACP_YR
					,A.CVPT_ACP_NO
					,A.ACP_YR||'-'||F_CODE_NM('1000740',A.REQ_DVSN_CD)||'-'||A.CVPT_ACP_NO AS ACP_NO
					,A.REQ_DT
					,A.HNDL_DDLN_CD
					,A.AUD_REQ_TIT_NM
					,A.NTAS_REQ_SBT
					,A.HNDL_DPT_CD
					,F_DPT_INFO(A.HNDL_DPT_CD,'1') AS HNDL_DPT_NM
					,A.PMN_CMT_NM
					,A.SGS_ASBM_NM
					,A.HNDL_DDLN_DT
					,NVL(A.EXTN_YN,'N') AS EXTN_YN
					,A.EXTN_HNDL_DDLN_DT
					,A.CPLT_DT
					,A.DOC_ID
					,A.EXTN_RSN
					,A.REL_BAS_DOC_NO
					,A.REL_BAS_ENF_DT
					,DECODE(A.CPLT_DT,NULL,'',TO_DATE(A.CPLT_DT)-TO_DATE(A.REQ_DT)) AS HNDL_DDLN_DT_CNT
					,A.CHGR_NM
					,A.HNDL_STT_TXT
					,F_CODE_NM('1000376', A.HNDL_DDLN_CD) AS HNDL_DDLN_NM
					,DECODE(B.AUD_YR,NULL,NULL,F_MNG_KND_AUDYRNO(B.AUD_YR, B.AUD_NO, B.AUD_KND_CD, '-')) AS AUD_YR_N0
					,B.AUD_YR
					,B.AUD_NO
			FROM	TBCSPEAR007M A
					,(SELECT B.TSK_KEY2,TSK_KEY1,TSK_KEY3,C.AUD_YR,C.AUD_NO,C.AUD_KND_CD
					   FROM TBBADDED030L B
							,TBBADDED001M C
					  WHERE (SUBSTR(C.AUD_KND_CD,'3','1') <> '5' OR C.AUD_KND_CD IS NULL)
					    AND B.AUD_YR = C.AUD_YR
					    AND B.AUD_NO = C.AUD_NO
					) B
			WHERE	1=1
			AND		A.REQ_DVSN_CD = B.TSK_KEY2(+)
			AND     A.ACP_YR = B.TSK_KEY1(+)
			AND     A.CVPT_ACP_NO = B.TSK_KEY3(+)
		]]>
		<dynamic>
		
			<isNotEmpty property="strACP_YR">
				AND	A.ACP_YR = #strACP_YR#
			</isNotEmpty>
			<isNotEmpty property="strCVPT_ACP_NO">
				AND	A.CVPT_ACP_NO = #strCVPT_ACP_NO#
			</isNotEmpty>
			<isNotEmpty property="strREQ_DTS">
				AND	A.REQ_DT &gt;= #strREQ_DTS#
			</isNotEmpty>
			<isNotEmpty property="strREQ_DTE">
				AND	A.REQ_DT &lt;= #strREQ_DTE#
			</isNotEmpty>
			<isNotEmpty property="strAUD_REQ_TIT_NM">
				AND	A.AUD_REQ_TIT_NM LIKE '%'||#strAUD_REQ_TIT_NM#||'%'
			</isNotEmpty>
			<isNotEmpty property="strHNDL_DDLN_CD">
				AND	A.HNDL_DDLN_CD = #strHNDL_DDLN_CD#
			</isNotEmpty>
			<isNotEmpty property="strSGS_ASBM_NM">
				AND	A.SGS_ASBM_NM LIKE '%'||#strSGS_ASBM_NM#||'%'
			</isNotEmpty>
			
		</dynamic>
		<![CDATA[
			ORDER BY A.ACP_YR DESC,  A.CVPT_ACP_NO DESC
		]]>
	</select>
	
	
	<select id="CSPEAR011EKeySelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	LPAD(TO_CHAR(NVL(MAX(TO_NUMBER(CVPT_ACP_NO)),0)+1),3,0) AS CVPT_ACP_NO
			FROM	TBCSPEAR007M
			WHERE	REQ_DVSN_CD ='4'
			AND		ACP_YR = #ACP_YR#
		]]>
	</select>
	
	<insert id="CSPEAR011EMainInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO	TBCSPEAR007M
					(	REQ_DVSN_CD
						,ACP_YR
						,CVPT_ACP_NO
						,REQ_DT
						,HNDL_DDLN_CD
						,AUD_REQ_TIT_NM
						,NTAS_REQ_SBT
						,HNDL_DPT_CD
						,PMN_CMT_NM
						,SGS_ASBM_NM
						,HNDL_DDLN_DT
						,EXTN_YN
						,EXTN_HNDL_DDLN_DT
						,CPLT_DT
						,DOC_ID
						,EXTN_RSN
						,REL_BAS_DOC_NO
						,REL_BAS_ENF_DT
						,CHGR_NM
						,HNDL_STT_TXT
						,FRT_USR_ID
       					,FNL_USR_ID
       					,FNL_DEAL_DPT_CD
       					,FNL_MNU_ID
       					,FRT_REGI_DH
       					,FNL_MDF_DH
					)
			VALUES	(	'4'
						,#ACP_YR#
						,#CVPT_ACP_NO#
						,#REQ_DT#
						,(	SELECT 	CASE WHEN #EXTN_YN# = 'Y' AND #CPLT_DT# IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,5),'YYYYMMDD') < #CPLT_DT# THEN '2'
										WHEN #EXTN_YN# = 'N' AND #CPLT_DT# IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,3),'YYYYMMDD') < #CPLT_DT# THEN '2'
											WHEN #CPLT_DT# IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,3),'YYYYMMDD') >= #CPLT_DT#  THEN '1'
											WHEN #EXTN_YN# = 'Y' AND #CPLT_DT# IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,5),'YYYYMMDD') >= #CPLT_DT#  THEN '1' 
											ELSE '' END FROM DUAL)
						,#AUD_REQ_TIT_NM#
						,#NTAS_REQ_SBT#
						,#HNDL_DPT_CD#
						,#PMN_CMT_NM#
						,#SGS_ASBM_NM#
						,TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,3),'YYYYMMDD')  /* (처리기한은 접수일자+3개월-1) - 2017.03.10 yyh */
						,#EXTN_YN#
						,DECODE(#EXTN_YN#,'Y',TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,5),'YYYYMMDD'),'') /* (연장처리기한일은 접수일자+5개월-1) - 2017.03.10 yyh */
						,#CPLT_DT#
						,#DOC_ID#
						,#EXTN_RSN#
						,#REL_BAS_DOC_NO#
						,#REL_BAS_ENF_DT#
						,#CHGR_NM#
						,#HNDL_STT_TXT#
						,#FRT_USR_ID#
       					,#FNL_USR_ID#
       					,#FNL_DEAL_DPT_CD#
       					,#FNL_MNU_ID#
       					,SYSDATE
       					,SYSDATE
       				)
		]]>
	</insert>
	
	<update id="CSPEAR011EMainUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	TBCSPEAR007M
			SET		REQ_DT = #REQ_DT#
					,HNDL_DDLN_CD = (	SELECT 	CASE WHEN #EXTN_YN# = 'Y' AND #CPLT_DT# IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,5),'YYYYMMDD') < #CPLT_DT# THEN '2'
										WHEN #EXTN_YN# = 'N' AND #CPLT_DT# IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,3),'YYYYMMDD') < #CPLT_DT# THEN '2'
											WHEN #CPLT_DT# IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,3),'YYYYMMDD') >= #CPLT_DT#  THEN '1'
											WHEN #EXTN_YN# = 'Y' AND #CPLT_DT# IS NOT NULL AND TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,5),'YYYYMMDD') >= #CPLT_DT#  THEN '1' 
											ELSE '' END FROM DUAL)
					,AUD_REQ_TIT_NM = #AUD_REQ_TIT_NM#
					,NTAS_REQ_SBT = #NTAS_REQ_SBT#
					,HNDL_DPT_CD = #HNDL_DPT_CD#
					,PMN_CMT_NM = #PMN_CMT_NM#
					,SGS_ASBM_NM = #SGS_ASBM_NM#
					,HNDL_DDLN_DT = TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,3),'YYYYMMDD') 
					,EXTN_YN = #EXTN_YN#
					,EXTN_HNDL_DDLN_DT = DECODE(#EXTN_YN#,'Y',TO_CHAR(ADD_MONTHS(TO_DATE(#REQ_DT#)-1,5),'YYYYMMDD'),'')
					,CPLT_DT = #CPLT_DT#
					,DOC_ID = #DOC_ID#
					,EXTN_RSN = #EXTN_RSN#
					,REL_BAS_DOC_NO = #REL_BAS_DOC_NO#
					,REL_BAS_ENF_DT = #REL_BAS_ENF_DT#
					,CHGR_NM = #CHGR_NM#
					,HNDL_STT_TXT = #HNDL_STT_TXT#
					,FNL_USR_ID = #FNL_USR_ID#
   					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
   					,FNL_MNU_ID = #FNL_MNU_ID#
   					,FNL_MDF_DH = SYSDATE
			WHERE	REQ_DVSN_CD = '4'
			AND		ACP_YR = #ACP_YR#
			AND		CVPT_ACP_NO = #CVPT_ACP_NO#
		]]>
	</update>
	
	
	<delete id="CSPEAR011EMainDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			FROM	TBCSPEAR007M
			WHERE	REQ_DVSN_CD = '4'
			AND		ACP_YR = #ACP_YR#
			AND		CVPT_ACP_NO = #CVPT_ACP_NO#
		]]>
	</delete>
</sqlMap> 
