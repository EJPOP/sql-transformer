<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/ear/053">

	<!--감사결정례 조회-->
	<select id="BADEAR053EMainSelect" parameterClass="paramMap" resultClass="resultMap">	
        <![CDATA[    
                   SELECT T1.DCSEXP_YR || '-' || T1.DCSEXP_NO                      AS DCSEXP_YRNO       /* 결정례연번호 */
                         ,T1.DCSEXP_YR                                             AS DCSEXP_YR         /* 결정례년도 */
                         ,T1.DCSEXP_NO                                             AS DCSEXP_NO         /* 결정례순번 */
                         ,T1.DCSEXP_TIT_NM                                         AS DCSEXP_TIT_NM     /* 결정례제목 */
                         ,T1.DCS_SBT                                               AS DCS_SBT           /* 결정요지 */
                         ,TO_CHAR(TO_DATE(T1.REGI_DT),'YYYY-MM-DD')                AS REGI_DT           /* 등록일자 */
                         ,T1.INN_DOC_ID                                            AS INN_DOC_ID        /* 내부문서ID */
                         ,T1.OPEN_DOC_ID                                           AS OPEN_DOC_ID       /* 공개문서ID */
                         ,T1.AUD_YR                                                AS AUD_YR            /* 감사년도 */
                         ,T1.AUD_NO                                                AS AUD_NO            /* 감사번호 */
                         ,T2.AUD_GRN_NO                                            AS AUD_GRN_NO        /* 감사부여번호 */
                         ,T1.DSP_RQ_SNO                                            AS DSP_RQ_SNO        /* 처분요구순번 */
                         ,T2.AUD_SBJ_NM                                            AS AUD_SBJ_NM        /* 감사사항명 */
                         ,T2.SPV_BRDV_CD                                           AS SPV_BRDV_CD       /* 주관부서 */
                         ,F_DPT_INFO(T2.SPV_BRDV_CD,'1')                           AS SPV_BRDV_NM       /* 주관부서명 */      
                         ,T3.DSP_RQ_KND_CD                                         AS DSP_RQ_KND_CD     /* 처분요구종류코드 */
			             ,F_CODE_NM('1000002',T3.DSP_RQ_KND_CD )                   AS DSP_RQ_KND_NM     /* 처분요구종류명 */   
			             ,T3.TIT_TXT                                               AS TIT_TXT           /* 처분요구제목 */           
 		     	         , CASE WHEN T2.AUD_YR >= '2016' 
			                         THEN F_CODE_NM('1000739',T2.AUD_KND_CD) 
			                    ELSE '-' 
			                END                                                    AS AUD_YR_NO_KND_NM  /* 감사연번호종류코드명 */                         
                         ,F_MNG_KND_AUDYRNO(T2.AUD_YR, T2.AUD_NO, '', '-') || '-' || T1.DSP_RQ_SNO      
                                                                                   AS AUD_YR_NO         /* 처분번호 */
			             ,CASE WHEN T4.RLTN_ORG_CD IS NOT NULL 
			                        THEN F_ORG_INFO(T4.RLTN_ORG_CD,'1')||'외 '||T5.CNT  
			                   ELSE '' 
			                END                                                    AS RLTN_ORG_NM       /*소관기관*/
                    FROM TBBADEAR034M T1 
                        ,TBBADDED001M T2
                        ,TBBADEAR001M T3
                        ,TBBADEAR002D T4
                        ,(SELECT AUD_YR, AUD_NO, DSP_RQ_SNO , COUNT(1)-1 CNT 
			                FROM TBBADEAR006M
			               GROUP BY AUD_YR, AUD_NO, DSP_RQ_SNO 
			             ) T5                        
                   WHERE 1=1
                     AND T1.AUD_YR     = T2.AUD_YR
                     AND T1.AUD_NO     = T2.AUD_NO
                     AND T1.AUD_YR     = T3.AUD_YR
                     AND T1.AUD_NO     = T3.AUD_NO
                     AND T1.DSP_RQ_SNO = T3.DSP_RQ_SNO
                     AND T1.AUD_YR     = T4.AUD_YR
                     AND T1.AUD_NO     = T4.AUD_NO
                     AND T1.DSP_RQ_SNO = T4.DSP_RQ_SNO     
                     AND T1.AUD_YR     = T5.AUD_YR
                     AND T1.AUD_NO     = T5.AUD_NO
                     AND T1.DSP_RQ_SNO = T5.DSP_RQ_SNO                                        
		]]>		
        
        /* 결정례 년도 */
        <isNotEmpty property="strDcsExpYr">
                     AND T1.DCSEXP_YR = #strDcsExpYr# 
        </isNotEmpty>	
        
        /* 결정례 번호 */
        <isNotEmpty property="strDcsExpNo">
                     AND T1.DCSEXP_NO = #strDcsExpNo# 
        </isNotEmpty>
        
        /* 결정례(처분) 제목 */						
        <isNotEmpty property="strDcsExpTitNm">
                     AND ( 
                              T1.DCSEXP_TIT_NM LIKE '%' || #strDcsExpTitNm# || '%' 
                           OR 
                              T3.TIT_TXT LIKE '%' || #strDcsExpTitNm# || '%'
                         )
        </isNotEmpty>
        
        /* 처분종류 */						
        <isNotEmpty property="strDspRqKndCd">
                     AND T3.DSP_RQ_KND_CD = #strDspRqKndCd# 
        </isNotEmpty>
        
        /* 관계기관 */				    
        <isNotEmpty property="strOrgCd">
                     AND T4.RLTN_ORG_CD = #strOrgCd# 
        </isNotEmpty>        
        								
        <![CDATA[ 
                   ORDER BY T1.DCSEXP_YR DESC
                           ,T1.DCSEXP_NO DESC
        ]]>								             
	</select>

	<!-- 결정례순번 채번 -->
	<select id="BADEAR053EMainMaxNoSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[     	
			    SELECT NVL(MAX(DCSEXP_NO),0)+1 AS DCSEXP_NO 
				  FROM TBBADEAR034M
				 WHERE 1=1
				   AND DCSEXP_YR = #DCSEXP_YR# 
		]]>
	</select>
	
	
	<!--결정례신규 insert-->
	<insert id="BADEAR053EMainInsert" parameterClass="paramMap">
				INSERT INTO TBBADEAR034M
				 (
				   DCSEXP_YR          /* 결정례년도 */
				  ,DCSEXP_NO          /* 결정례순번 */
				  ,DCSEXP_TIT_NM      /* 결정례제목 */
				  ,DCS_SBT            /* 결정요지 */
				  ,REGI_DT            /* 등록일자 */
				  ,INN_DOC_ID         /* 내부문서ID */
				  ,OPEN_DOC_ID        /* 공개문서ID */
				  ,AUD_YR             /* 감사년도 */
				  ,AUD_NO             /* 감사번호 */
				  ,DSP_RQ_SNO         /* 처분요구순번 */
				  ,FRT_USR_ID         /* 최초사용자ID */
				  ,FNL_USR_ID         /* 최종사용자ID */
				  ,FNL_DEAL_DPT_CD    /* 최종거래부서코드 */
				  ,FNL_MNU_ID         /* 최종메뉴ID */
				  ,FRT_REGI_DH        /* 최초등록일시 */
				  ,FNL_MDF_DH         /* 최종수정일시 */
				 ) 
				 VALUES
				 (
				   #DCSEXP_YR#
				  ,#DCSEXP_NO#
				  ,#DCSEXP_TIT_NM#
				  ,#DCS_SBT#
				  ,TO_CHAR(SYSDATE,'YYYYMMDD')
				  ,#INN_DOC_ID#
				  ,#OPEN_DOC_ID#
				  ,#AUD_YR#
				  ,#AUD_NO#
				  ,#DSP_RQ_SNO#
				  ,#FRT_USR_ID#
				  ,#FNL_USR_ID#
				  ,#FNL_DEAL_DPT_CD#
				  ,#FNL_MNU_ID#
				  ,SYSDATE
				  ,SYSDATE				 
				 ) 
	</insert>
		
		
	<!--결정례 update-->
	<update id="BADEAR053EMainUpdate" parameterClass="paramMap">
	        UPDATE TBBADEAR034M
	           SET  
				   DCSEXP_TIT_NM      = #DCSEXP_TIT_NM#       /* 결정례제목 */
				  ,DCS_SBT            = #DCS_SBT#             /* 결정요지 */
				  ,INN_DOC_ID         = #INN_DOC_ID#          /* 내부문서ID */
				  ,OPEN_DOC_ID        = #OPEN_DOC_ID#         /* 공개문서ID */
				  ,AUD_YR             = #AUD_YR#              /* 감사년도 */
				  ,AUD_NO             = #AUD_NO#              /* 감사번호 */
				  ,DSP_RQ_SNO         = #DSP_RQ_SNO#          /* 처분요구순번 */
				  ,FNL_USR_ID         = #FNL_USR_ID#          /* 최종사용자ID */
				  ,FNL_DEAL_DPT_CD    = #FNL_DEAL_DPT_CD#     /* 최종거래부서코드 */
				  ,FNL_MNU_ID         = #FNL_MNU_ID#          /* 최종메뉴ID */
				  ,FNL_MDF_DH         = SYSDATE               /* 최종수정일시 */
             WHERE 1=1
               AND DCSEXP_YR = #DCSEXP_YR#
               AND DCSEXP_NO = #DCSEXP_NO#
	</update>
	
	
	<!--결정례 delete -->
	<update id="BADEAR053EMainDelete" parameterClass="paramMap">
	        DELETE 
	          FROM TBBADEAR034M
             WHERE 1=1
               AND DCSEXP_YR = #DCSEXP_YR#
               AND DCSEXP_NO = #DCSEXP_NO#
	</update>		
</sqlMap> 
