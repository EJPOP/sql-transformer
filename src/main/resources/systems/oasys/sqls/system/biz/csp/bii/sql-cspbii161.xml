<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/bii/161">
	<!-- 관련처분 목록 조회 -->   
	<select id="CSPBII161QReltAudInfSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT A.YE      /* 연도 */
			     , A.SRNO    /* 일련번호 */			     
			     , A.INF_NO  /* 정보번호 */
			     , A.TIT_TXT /* 제목내용 (/		  
			  FROM TBCSPBII100M A /* 감사정보기본 */
			 WHERE A.YE   = REGEXP_SUBSTR(#strInfNo#, '[^|-]+', 1, 1)
			   AND A.SRNO = REGEXP_SUBSTR(#strInfNo#, '[^|-]+', 1, 2)
		]]>
	</select>
	
	<!-- 관련처분 목록 조회 -->   
	<select id="CSPBII161ERelDspSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT /*A.AUD_YR || '-' || A.AUD_NO || '-' || A.DSP_RQ_SNO AS DSP_NO    */          /* 처분번호 */
				F_MNG_KND_AUDYRNO(A.AUD_YR, A.AUD_NO, C.AUD_KND_CD, '-') ||'-'|| A.DSP_RQ_SNO AS DSP_NO
			     , B.ENF_DT                                                                  /* 시행일 */
			     , A.DSP_RQ_KND_CD                                                           /* 처분요구종류코드 */
			     , F_CODE_NM('1000002', A.DSP_RQ_KND_CD)              AS DSP_RQ_KND_NM       /* 처분요구종류명 */
			     , A.TIT_TXT                                          AS DSP_TIT_TXT         /* 처분제목내용 */
			     , B.RLTN_ORG_CD                                                             /* 관계기관코드 */
			     , (SELECT C.ORG_NM
			          FROM TBDCMACM015M C
			         WHERE C.ORG_CD = B.RLTN_ORG_CD)                  AS RLTN_ORG_NM         /* 관계기관명 */			    
			     , A.AUD_YR                                                                  /* 감사연도 */
			     , A.AUD_NO                                                                  /* 감사번호 */
			     , A.DSP_RQ_SNO                                                              /* 처분요구순번 */		  
			  FROM TBBADEAR001M A /* 처분요구사항기본 */
			     , TBBADEAR002D B /* 처분요구사항상세 */
			     , TBBADDED001M C
			 WHERE A.AUD_YR     = B.AUD_YR
			   AND A.AUD_NO     = B.AUD_NO
			   AND A.DSP_RQ_SNO = B.DSP_RQ_SNO
			   AND     A.AUD_YR = C.AUD_YR
			   AND     A.AUD_NO = C.AUD_NO
			   AND A.AUD_YR     = #strAudYr#
			   AND A.AUD_NO     = #strAudNo#
			   AND A.DSP_RQ_SNO = #strDspRqSno#
		]]>
	</select>
	
	
	
	<!-- 감사정보기본 수정 -->
	<update id="CSPBII161EMainUpdate100M" parameterClass="paramMap">
		UPDATE TBCSPBII100M                       
		   SET TIT_TXT         = #TIT_TXT#           /* 제목내용 */
		     , PRSR_DPT_CD     = #PRSR_DPT_CD#       /* 제출자부서코드 */
		     , PRSR_CNB        = #PRSR_CNB#		     /* 제출자전산번호 */	
		     , PRSR_RANK_CD    = #PRSR_RANK_CD#		 /* 제출자 직급 코드*/	           
		     , CLC_DVSN_CD     = #CLC_DVSN_CD#       /* 수집구분코드 */
		     , SRC_DVSN_CD     = #SRC_DVSN_CD#       /* 출처구분코드 */
		     , INF_DVSN_CD     = #INF_DVSN_CD#       /* 정보구분코드*/
		     , REL_ORG_CD      = #REL_ORG_CD#        /* 관련기관코드  */
		     , REL_ORG_CD_1    = #REL_ORG_CD_1#      /* 관련기관코드1 */ 
		     , REL_ORG_CD_2    = #REL_ORG_CD_2#      /* 관련기관코드2 */
		     , SMT_SC          = #SMT_SC#            /* 제출점수 */
		     , CAT_ADT_SC      = #CAT_ADT_SC#        /* 분류추가점수 */
		     , SPCF_INF_ADT_SC = #SPCF_INF_ADT_SC#   /* 특정정보추가점수 */
		     , BRON_ADT_SC     = #BRON_ADT_SC#       /* 특정정보추가점수 */
		     , UTL_ADT_SC      = #UTL_ADT_SC#        /* 활용가점추가점수 */
		     , ELY_ADT_SC      = #ELY_ADT_SC#        /* 조기제출추가점수 */
		     , HNDL_ADT_SC     = #HNDL_ADT_SC#       /* 처리가점추가점수 */
		     , QLT_ADPT_ADT_SC = #QLT_ADPT_ADT_SC#   /* 품질가점추가점수 */
		     , MLG_ADT_NOC     = #MLG_ADT_NOC#       /* 마일리지추가건수 */
		     , ACP_DT          = REPLACE(#ACP_DT#, '.', '')     /* 접수일 */
		     , TRNF_DT         = REPLACE(#TRNF_DT#, '.', '')     /* 이송일 */
		     , TRNF_ACP_DT     = REPLACE(#TRNF_ACP_DT#, '.', '') /* 이송접수일 */
		     , HNDL_DPT_CD     = #HNDL_DPT_CD# /* 처리부서코드  */
			 , HNDL_ORD_CD     = #HNDL_ORD_CD#       /* 처리지시코드 */			                                           
		     , OPEN_YN         = #OPEN_YN#           /* 공개여부  */
		     , HNDL_DT         = REPLACE(#HNDL_DT#, '.', '') /* 처리일 */
		     , CMPT_DT         = REPLACE(#CMPT_DT#, '.', '') /* 완료일 */
		     , HNDL_RSLT_CD    = #HNDL_RSLT_CD#      /* 처리결과코드 */	
		     , AUD_INF_PRSS_STA_CD = #AUD_INF_PRSS_STA_CD# /* 감사정보진행상태코드 */
		     , BK_TRNF_DT      = #BK_TRNF_DT#        /* 이전이송일 */
		     , BK_HNDL_DT      = #BK_HNDL_DT#        /* 이전처리일 */
		     , BK_CMPT_DT      = #BK_CMPT_DT#        /* 이전완료일 */
		     , BK_HNDL_PEN_CNB = #BK_HNDL_PEN_CNB#        /* 이전처리자전산번호 */
		     , BK_HNDL_DPT_CD  = #BK_HNDL_DPT_CD#        /* 이전처리부서코드 */
		     , BK_HNDL_ORD_CD  = #BK_HNDL_ORD_CD#        /* 이전처리지시코드 */
		     , FDLTY_MNAG_SC   = #FDLTY_MNAG_SC#              /* 충실성행위주체점수 */
		     , FDLTY_TIME_SC   = #FDLTY_TIME_SC#              /* 충실성행위시기점수 */
		     , FDLTY_TG_SC     = #FDLTY_TG_SC#                /* 충실성행위대상점수 */
		     , FDLTY_TXT_SC    = #FDLTY_TXT_SC#               /* 충실성행위대상점수 */
		     , FDLTY_BAS_SC    = #FDLTY_BAS_SC#               /* 충실성법적근거점수 */
		     , RIBLY_EVI_SC    = #RIBLY_EVI_SC#               /* 신뢰성증거자료점수 */
		     , RIBLY_IVTG_SC   = #RIBLY_IVTG_SC#              /* 신뢰성탐문정보점수 */
		     , UTL_INSP_SC     = #UTL_INSP_SC#                /* 활용가능성감찰정보점수 */
		     , UTL_SPCF_SC     = #UTL_SPCF_SC#                /* 활용가능성특정정보점수 */	
		     , FNL_USR_ID      = #FNL_USR_ID#        /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#   /* 최종거래부서코드 */
		     , FNL_MNU_ID      = #FNL_MNU_ID#        /* 최종메뉴ID */
		     , FNL_MDF_DH      = SYSDATE             /* 최종수정일시 */
		     , SMT_DT = #SMT_DT2#
		     , BLE_CHGR_CNB = #BLE_CHGR_CNB#
		 WHERE YE = #YE#
		   AND SRNO = #SRNO#
	</update>
	
	<!-- 감사정보내역 수정 -->
	<update id="CSPBII161EMainUpdate101L" parameterClass="paramMap">
		UPDATE TBCSPBII101L                       
		   SET AUD_INF_TXT       = #AUD_INF_TXT#       /* 감사정보내용 */
		     , AUD_INF_ETC_TXT   = #AUD_INF_ETC_TXT#   /* 감사정보기타내용 */
		     , AUD_INF_SMM_TXT   = #AUD_INF_SMM_TXT#   /* 감사정보요약내용 */
		     , HNDL_RSLT_SMM_TXT = #HNDL_RSLT_SMM_TXT# /* 처리결과요약내용 */
		     , FNL_USR_ID        = #FNL_USR_ID#        /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD   = #FNL_DEAL_DPT_CD#   /* 최종거래부서코드 */
		     , FNL_MNU_ID        = #FNL_MNU_ID#        /* 최종메뉴ID */
		     , FNL_MDF_DH        = SYSDATE             /* 최종수정일시 */
		     , AUD_INF_ANL_OPIN_TXT = #AUD_INF_ANL_OPIN_TXT#
		     , AUD_INF_BLE_ANL_OPIN_TXT = #AUD_INF_BLE_ANL_OPIN_TXT#
		 WHERE YE   = #YE#
		   AND SRNO = #SRNO#
	</update>
	
	<!-- 감사정보관련자내역 등록  -->
	<insert id="CSPBII161EReltAudInfInsert110L" parameterClass="paramMap">
		INSERT INTO TBCSPBII110L (
		                          YE                /* 연도 */
		                        , SRNO              /* 일련번호 */
		                        , RELT_AUD_INF_YE   /* 연관감사정보연도 */
		                        , RELT_AUD_INF_SRNO /* 연관감사정보일련번호 */		                      
		                        , FRT_USR_ID        /* 최초사용자ID */
		                        , FNL_USR_ID        /* 최종사용자ID */
		                        , FNL_DEAL_DPT_CD   /* 최종거래부서코드 */
		                        , FNL_MNU_ID        /* 최종메뉴ID */
		                        , FRT_REGI_DH       /* 최초등록일시 */
		                        , FNL_MDF_DH        /* 최종수정일시 */
		                         ) 
		                  VALUES (
		                          #YE#
		                        , #SRNO#
		                        , #RELT_AUD_INF_YE#
		                        , #RELT_AUD_INF_SRNO#      		                     		                     
		                        , #FRT_USR_ID#
		                        , #FNL_USR_ID#
		                        , #FNL_DEAL_DPT_CD#
		                        , #FNL_MNU_ID#
		                        , SYSDATE
		                        , SYSDATE
				                 )
	</insert>
	
	<!-- 감사정보관련자내역 수정 -->
	<update id="CSPBII161EReltAudInfUpdate110L" parameterClass="paramMap">
		UPDATE TBCSPBII110L                       
		   SET RELT_AUD_INF_YE   = #RELT_AUD_INF_YE#   /* 연관감사정보연도 */
		     , RELT_AUD_INF_SRNO = #RELT_AUD_INF_SRNO# /* 연관감사정보일련번호 */				     
		     , FNL_USR_ID        = #FNL_USR_ID#        /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD   = #FNL_DEAL_DPT_CD#   /* 최종거래부서코드 */
		     , FNL_MNU_ID        = #FNL_MNU_ID#        /* 최종메뉴ID */
		     , FNL_MDF_DH        = SYSDATE             /* 최종수정일시 */
		 WHERE YE                = #YE#
		   AND SRNO              = #SRNO#
		   AND RELT_AUD_INF_YE   = #CHG_BF_RELT_AUD_INF_YE# 
		   AND RELT_AUD_INF_SRNO = #CHG_BF_RELT_AUD_INF_SRNO#
	</update>
	
	<!-- 감사정보관련자내역 삭제 -->
	<delete id="CSPBII161EReltAudInfDelete110L" parameterClass="paramMap">
		DELETE TBCSPBII110L
		 WHERE YE                = #YE#
		   AND SRNO              = #SRNO#	
		   AND RELT_AUD_INF_YE   = #CHG_BF_RELT_AUD_INF_YE# 
		   AND RELT_AUD_INF_SRNO = #CHG_BF_RELT_AUD_INF_SRNO#
	</delete>
	
	<select id="CSPBII161AudInfPrssStaCdCheck" parameterClass="paramMap" resultClass="Integer">
		<![CDATA[
			SELECT	COUNT(*)
			FROM	TBCSPBII100M
			WHERE	YE = #strYe#
			AND		SRNO = #strSrno#
			AND		AUD_INF_PRSS_STA_CD IN ('05','10','13')
		]]>
	</select>
	
	<update id="CSPBII161CancleUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	TBCSPBII100M
			SET		AUD_INF_PRSS_STA_CD = '01'	/*제출작성 상태로 UPDATE*/
					,SMT_DT = NULL	/*제출일*/
					,ACP_DT = NULL	/*접수일*/
					,SBM_DT = NULL	/*상신일*/
					,APV_DOC_NO = NULL	/*결재문서번호*/
					,BLE_CHGR_CNB = NULL
					,DTB_DT = NULL
					,PRE_EVL_CD = NULL
					,PRE_EVL_FDLTY = NULL
					,PRE_EVL_IFENE = NULL
					,PRE_EVL_WRDO = NULL
			WHERE	YE = #strYe#
			AND		SRNO = #strSrno#
		]]>
	</update>
</sqlMap> 
