<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/bii/723">
	<!-- 출장상황 목록 조회 -->   
	<select id="CSPBII723PBztSituSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT ROW_NUMBER() OVER(PARTITION BY A.YE, A.SRNO ORDER BY A.BZT_STR_DT, A.BZT_END_DT) AS BZT_SITU_NO  
				 , TO_CHAR(TO_DATE(A.BZT_STR_DT, 'YYYYMMDD'), 'MM.DD') || '~' || TO_CHAR(TO_DATE(A.BZT_END_DT, 'YYYYMMDD'), 'MM.DD') || '/'				
				|| A.TIT_TXT || '/'
				|| (SELECT B.ORG_NM
				      FROM TBDCMACM015M B
				     WHERE B.ORG_CD = A.ORG_CD) || CASE WHEN A.ORG_CNT = 0 THEN NULL
				                                        ELSE ' 외 ' || A.ORG_CNT 
				                                   END AS BZT_SITU			                                   
				 , A.YE
				 , A.SRNO
			  FROM (SELECT C.YE
			             , C.SRNO   
			             , A.BZT_STR_DT
			             , A.BZT_END_DT
			             , B.TIT_TXT
			             , (SELECT MIN(D.ORG_CD)
			                  FROM TBBADDED008L D
			                 WHERE D.BZT_YR   = A.BZT_YR
			                   AND D.BZT_SNO  = A.BZT_SNO
			                   AND D.TEAM_SNO = A.TEAM_SNO) AS ORG_CD
			             , (SELECT COUNT(*) - 1
			                  FROM TBBADDED008L D
			                 WHERE D.BZT_YR   = A.BZT_YR
			                   AND D.BZT_SNO  = A.BZT_SNO
			                   AND D.TEAM_SNO = A.TEAM_SNO) AS ORG_CNT
			          FROM TBBADDED005L A
			             , TBBADDED002M B
			             , TBCSPBII170M C
			         WHERE A.BZT_YR  = B.BZT_YR
			           AND A.BZT_SNO = B.BZT_SNO
			           AND A.PCT_CNB = C.PRSR_CNB
			           AND A.BZT_STR_DT >= TO_CHAR(ADD_MONTHS(TO_DATE(C.SMT_DT, 'YYYYMMDD'), -3), 'YYYYMMDD')
			           AND A.BZT_END_DT <= C.SMT_DT
			]]>		
			<isEqual property="strDVSN_CD" compareValue="1">
			           AND C.ACP_DT BETWEEN #strStrAcpDt# AND #strEndAcpDt#
			           AND C.ACP_DH BETWEEN #strStrAcpDh# AND #strEndAcpDh#
			</isEqual>
			<isEqual property="strDVSN_CD" compareValue="2">
			           AND C.DTB_DT BETWEEN #strStrAcpDt# AND #strEndAcpDt#
			</isEqual>
			<isNotEmpty property="strYeList">	
			AND (c.YE, c.SRNO) IN (SELECT REGEXP_SUBSTR(#strYeList#, '[^||]+', 1, LEVEL)
                                        , REGEXP_SUBSTR(#strSrnoList#, '[^||]+', 1, LEVEL)
                                     FROM DUAL
                                   CONNECT BY LEVEL &lt;= REGEXP_COUNT(#strYeList#, '[^|]+'))
			</isNotEmpty>
			<isNotEmpty property="strBLE_CHGR_CNB">
				AND C.BLE_CHGR_CNB = #strBLE_CHGR_CNB#
			</isNotEmpty>
			<isNotEmpty property="strYe">
				AND C.YE =  #strYe#
			</isNotEmpty>
			
			<!-- 일련번호 -->
			<isNotEmpty property="strSrno">
				AND C.SRNO =  #strSrno#
			</isNotEmpty>
			           ) A
			ORDER BY BZT_SITU_NO			           		
		
	</select>
</sqlMap> 
