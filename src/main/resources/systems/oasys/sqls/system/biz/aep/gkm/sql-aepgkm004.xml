<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="aep/gkm/004">

	<!-- 보관지식 저장 -->
	<select id="AEPGKM004PAchivedselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[ 		
			SELECT CNB
				 , CTG_ID
				 , CTG_NM
				 , HIRK_CTG_ID 
				 , SRT_VAL_NM
		      FROM TBAEPGKM003L
		     WHERE CNB = #strMyCnb#
		     ORDER BY SRT_VAL_NM	
			]]>		
	</select>
	
	<!-- 공유지식 탭 조회한다. -->
	<select id="AEPGKM004PSharedselect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[
			SELECT DPT_CD AS CTG_ID
				 , DPT_NM AS CTG_NM
				 , 'S'    AS HIRK_CTG_ID
		      FROM TBDCMACM002M
		     WHERE DPT_CD IN (
						SELECT HIRK_DPT_CD 
						  FROM TBDCMACM002M 
						 WHERE DPT_CD = #strMyDptCd#
						   AND HIRK_DPT_CD IS NOT NULL 
						 UNION ALL
				        SELECT #strMyDptCd#
						  FROM DUAL
							)
			ORDER BY DPT_CD
			]]>			
	</select>	
	
	<!-- 보관지식에 담는다. -->
	<update id="AEPGKM004PAchivedinsert"  parameterClass="paramMap">
		<![CDATA[ 	
			DECLARE
			  BEGIN
				INSERT INTO TBAEPGKM004L
				(
			          KNB
			        , CNB
			        , STRG_KLD_SNO
			        , CTG_ID
			        , STRG_KLD_DVSN_CD
					, FRT_USR_ID
					, FNL_USR_ID
					, FNL_DEAL_DPT_CD
					, FNL_MNU_ID
					, FRT_REGI_DH
					, FNL_MDF_DH
				)
			SELECT KNB
			     , CNB
			     , ( SELECT NVL(MAX(STRG_KLD_SNO), 0) FROM TBAEPGKM004L WHERE CNB = #strMyCnb#) + (ROWNUM-1) AS STRG_KLD_SNO
			     , #strCtgId# AS CTG_ID
			     , 'BM' AS STRG_KLD_DVSN_CD
			     , #FRT_USR_ID#
				 , #FNL_USR_ID#
				 , #FNL_DEAL_DPT_CD#
				 , #FNL_MNU_ID#
				 , SYSDATE
				 , SYSDATE
			  FROM TBAEPGKM002L
			 WHERE CNB = #strMyCnb#
			  ]]>	 
		         <dynamic prepend="AND">
			         <isNotEmpty property = "strKnb">
			         	KNB IN
			         		<iterate property = "strKnb" open="(" close=")" conjunction=",">
			         			TRIM(#strKnb[]#)
			         		</iterate>
			         </isNotEmpty>
		         </dynamic>									
			<![CDATA[ 		 
			;
				
			DELETE TBAEPGKM002L
			 WHERE CNB = #strMyCnb#
			  ]]>	 
		         <dynamic prepend="AND">
			         <isNotEmpty property = "strKnb">
			         	KNB IN
			         		<iterate property = "strKnb" open="(" close=")" conjunction=",">
			         			TRIM(#strKnb[]#)
			         		</iterate>
			         </isNotEmpty>
		         </dynamic>									
			<![CDATA[ 
			;
			   
			END ;
		]]>		
	</update>
	
	<!-- 나의 국과별 공유지식에 담는다. -->
	<update id="AEPGKM004PSharedinsert"  parameterClass="paramMap">
		<![CDATA[ 	
			DECLARE 
			  BEGIN
				INSERT INTO TBAEPGKM004L
				(
			          KNB
			        , CNB
			        , STRG_KLD_SNO
			        , CTG_ID
			        , STRG_KLD_DVSN_CD
			        , DPT_CD
					, FRT_USR_ID
					, FNL_USR_ID
					, FNL_DEAL_DPT_CD
					, FNL_MNU_ID
					, FRT_REGI_DH
					, FNL_MDF_DH
				)
			SELECT KNB
			     , CNB
			     , ( SELECT NVL(MAX(STRG_KLD_SNO), 0) FROM TBAEPGKM004L WHERE CNB = #strMyCnb#) + (ROWNUM-1) AS STRG_KLD_SNO
			     , #strCtgId# AS CTG_ID
			     , 'GP' AS STRG_KLD_DVSN_CD
			     , #strCtgId# AS DPT_CD
			     , #FRT_USR_ID#
				 , #FNL_USR_ID#
				 , #FNL_DEAL_DPT_CD#
				 , #FNL_MNU_ID#
				 , SYSDATE
				 , SYSDATE
			  FROM TBAEPGKM002L
			 WHERE CNB = #strMyCnb#
			  ]]>	 
		         <dynamic prepend="AND">
			         <isNotEmpty property = "strKnb">
			         	KNB IN
			         		<iterate property = "strKnb" open="(" close=")" conjunction=",">
			         			TRIM(#strKnb[]#)
			         		</iterate>
			         </isNotEmpty>
		         </dynamic>									
			<![CDATA[ 		 
			;
				
			DELETE TBAEPGKM002L
			 WHERE CNB = #strMyCnb#
			  ]]>	 
		         <dynamic prepend="AND">
			         <isNotEmpty property = "strKnb">
			         	KNB IN
			         		<iterate property = "strKnb" open="(" close=")" conjunction=",">
			         			TRIM(#strKnb[]#)
			         		</iterate>
			         </isNotEmpty>
		         </dynamic>									
			<![CDATA[ 
			;
			   
			END ;
		]]>		
	</update>
	
</sqlMap>