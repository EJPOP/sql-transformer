<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/cmr/025">

	<resultMap class="java.util.HashMap" id="resultColbMap">
		<result property="EPS_LAW_YE_SNO" column="EPS_LAW_YE_SNO" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="COPT_DPT_NM" column="COPT_DPT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="COPT_DPT_CD" column="COPT_DPT_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ENF_DT" column="ENF_DT" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DSP_RQ_KND_NM" column="DSP_RQ_KND_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="TIT_TXT" column="TIT_TXT" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="RLTN_ORG_NM" column="RLTN_ORG_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="EPS_MNG_LAW_NM" column="EPS_MNG_LAW_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="MONI_YN" column="MONI_YN" jdbcType="VARCHAR2" javaType="java.lang.String" />		
		<result property="EPS_LAW_YE" column="EPS_LAW_YE" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="EPS_LAW_SNO" column="EPS_LAW_SNO" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DSP_RQ_AUD_YE" column="DSP_RQ_AUD_YE" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DSP_RQ_AUD_SNO" column="DSP_RQ_AUD_SNO" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DSP_RQ_DSP_SNO" column="DSP_RQ_DSP_SNO" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DSP_RQ_KND_CD" column="DSP_RQ_KND_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />		
		<result property="DSP_RQ_HND_SBJ" column="DSP_RQ_HND_SBJ" jdbcType="CLOB" javaType="java.lang.String" />
		<result property="DOC_ID" column="DOC_ID" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="CPLT_YN" column="CPLT_YN" jdbcType="VARCHAR2" javaType="java.lang.String" />
    </resultMap>

	<!-- 중점관리법령관리 조회한다. -->
	<select id="BADCMR025Emainselect" parameterClass="paramMap" resultMap="resultColbMap">
		<![CDATA[   
			SELECT EPS_LAW_YE || '-' || EPS_LAW_SNO    AS EPS_LAW_YE_SNO /*No*/
			     , F_DPT_INFO(COPT_DPT_CD, '1')        AS COPT_DPT_NM    /*소과부서명*/
			     , COPT_DPT_CD                         AS COPT_DPT_CD    /*소관부서코드*/
			     , ENF_DT                              AS ENF_DT         /*시행일자*/
			     , F_CODE_NM('1000002', DSP_RQ_KND_CD) AS DSP_RQ_KND_NM  /*처분요구종류*/
			     , TIT_TXT                             AS TIT_TXT        /*처분제목*/
			     , F_DPT_INFO(RLTN_ORG_CD, '1')        AS RLTN_ORG_NM    /*관계기관*/
			     , EPS_MNG_LAW_NM                      AS EPS_MNG_LAW_NM /*법령명*/
			     , MONI_YN                             AS MONI_YN        /*모니터링 유무*/
			     , EPS_LAW_YE                          AS EPS_LAW_YE     /*중점법령연도*/
			     , EPS_LAW_SNO                         AS EPS_LAW_SNO    /*중점법령순번*/
			     , DSP_RQ_AUD_YE                       AS DSP_RQ_AUD_YE  /*처분요구감사연도*/
			     , DSP_RQ_AUD_SNO                      AS DSP_RQ_AUD_SNO /*처분요구감사순번*/
			     , DSP_RQ_DSP_SNO                      AS DSP_RQ_DSP_SNO /*처분요구처분순번*/
			     , DSP_RQ_KND_CD                       AS DSP_RQ_KND_CD  /*처분요구종류코드*/
			     , DSP_RQ_HND_SBJ                      AS DSP_RQ_HND_SBJ /*처분요구조치사항*/
			     , DOC_ID                              AS DOC_ID         /*문서ID*/
			     , NVL(CPLT_YN, 'N')                   AS CPLT_YN        /*완결여부*/
			  FROM ( 
			    SELECT D4.EPS_LAW_YE        /*중점법령연도*/
			         , D4.EPS_LAW_SNO       /*중점법령순번*/
			         , D4.DSP_RQ_AUD_YE     /*처분요구감사연도*/
			         , D4.DSP_RQ_AUD_SNO    /*처분요구감사순번*/
			         , D4.DSP_RQ_DSP_SNO    /*처분요구처분순번*/
			         , D4.COPT_DPT_CD       /*소관부서코드*/
			         , D2.ENF_DT            /*시행일자*/
			         , D1.DSP_RQ_KND_CD     /*처분요구종류코드*/
			         , D1.TIT_TXT           /*제목내용*/
			         , D2.RLTN_ORG_CD       /*관계기관코드*/
			         , D4.EPS_MNG_LAW_NM    /*중점관리법령명*/
			         , CASE WHEN ( SELECT COUNT(LAW_YE) FROM TBBADCMR011M WHERE REL_EPS_MNG_LAW_YE = D4.EPS_LAW_YE AND REL_EPS_MNG_LAW_SNO = D4.EPS_LAW_SNO ) > 0 THEN 'Y' ELSE 'N' END MONI_YN
			         , D3.DSP_RQ_HND_SBJ    /*처분요구조치사항*/
			         , D4.DOC_ID            /*문서ID*/
			         , D4.CPLT_YN
			      FROM TBBADCMR014M D4 /*중점관리법형기본*/
			         , TBBADEAR001M D1 /*처분요구사항기본*/
			         , TBBADEAR002D D2 /*처분요구사항상세*/
			         , TBBADEAR005M D3 /*처분요구요약전기본*/
			     WHERE  1=1 
			       AND  D4.DSP_RQ_AUD_YE  = D1.AUD_YR     (+)   
			       AND  D4.DSP_RQ_AUD_SNO = D1.AUD_NO     (+)
			       AND  D4.DSP_RQ_DSP_SNO = D1.DSP_RQ_SNO (+)
			       AND  D1.AUD_YR         = D2.AUD_YR     (+)
			       AND  D1.AUD_NO         = D2.AUD_NO     (+)
			       AND  D1.DSP_RQ_SNO     = D2.DSP_RQ_SNO (+)
			       AND  D2.AUD_YR         = D3.AUD_YR     (+)  
			       AND  D2.AUD_NO         = D3.AUD_NO     (+)
			       AND  D2.DSP_RQ_SNO     = D3.DSP_RQ_SNO (+) 
		]]>
			<!-- 총괄과다 -->
			<isEqual property="strAuthDept" compareValue="gen">
			    <!-- 부서코드가 0 으로 시작한다.  -->
			    <isEqual property="strDeptFirst" compareValue="0">
			    	AND D4.COPT_DPT_CD LIKE SUBSTR(#strLongInDeptCd#,0 ,2) || '%'   
			    </isEqual>
			    <isNotEqual property="strDeptFirst" compareValue="0">
			    	AND D4.COPT_DPT_CD = #strLongInDeptCd#  
			    </isNotEqual>
			</isEqual>
			
			<!-- 소관과 -->
			<isEqual property="strAuthDept" compareValue="mng">
			    AND D4.COPT_DPT_CD = #strLongInDeptCd#  
			</isEqual>
			<!-- 일자범위 -->
			<isNotEmpty property="strFromEnfDt">
				AND D2.ENF_DT <![CDATA[  >= ]]> #strFromEnfDt#
			</isNotEmpty>
			<isNotEmpty property="strToEnfDt">
				 AND D2.ENF_DT <![CDATA[ <= ]]> #strToEnfDt#
			</isNotEmpty>  
			
			<!-- 소관부서코드가 EX) SUBSTR('010100', 4) = 01, 00 일경우에는 01로 시작하는 모든 과를 조회 아님 과코드로 -->
			<isNotEmpty property="stsrCoptDptCd">
	      		 AND D4.COPT_DPT_CD LIKE ( CASE WHEN SUBSTR(#stsrCoptDptCd#, 4) = '01' THEN SUBSTR(#stsrCoptDptCd#,0, 2) 
	                                            WHEN SUBSTR(#stsrCoptDptCd#, 4) = '00' THEN SUBSTR(#stsrCoptDptCd#,0, 2) 
	                                            ELSE #stsrCoptDptCd# END  ) || '%'
			</isNotEmpty> 
			<isNotEmpty property="strDspRqKndCd">
				AND D1.DSP_RQ_KND_CD = #strDspRqKndCd#  /*처분종류*/
			</isNotEmpty> 			       
			<isNotEmpty property="strRltnOrgCd">
				AND D2.RLTN_ORG_CD  = #strRltnOrgCd#  /*관계기관검색*/
			</isNotEmpty> 
			<isNotEmpty property="strLawNm">
				AND ( UPPER(D1.TIT_TXT) LIKE '%' || UPPER(#strLawNm#)  || '%' OR UPPER(D4.EPS_MNG_LAW_NM) LIKE '%' || UPPER(#strLawNm#)  || '%' )
			</isNotEmpty> 
			
		<![CDATA[
			    )  			    
			WHERE 1 = 1
		]]>	
			<isNotEmpty property="strMoniYn">
				AND NVL(MONI_YN, 'N') = #strMoniYn#
			</isNotEmpty> 	
			<isNotEmpty property="strCpltYn">
				AND NVL(CPLT_YN, 'N') = #strCpltYn#
			</isNotEmpty> 
		<![CDATA[
			ORDER BY EPS_LAW_YE DESC, EPS_LAW_SNO DESC
		]]>
	</select>
	
	<!-- 법령모니터링 조회한다. -->
	<select id="BADCMR025Esubselect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[   
			SELECT LAW_YE 
			     , LAW_MNT_SNO
				 , MTRL_OGN_DT                                                              AS MTRL_OGN_DT         /*발생일*/   
			     , F_CODE_NM('1000253', MTRL_CAT_CD)                                        AS MTRL_CAT_NM         /*자료구분*/
			     , F_DPT_INFO(CHGD_DPT_CD ,'1')                                             AS DPT_NM              /*소관과*/
				 , (SELECT ORG_NM FROM TBDCMACM015M WHERE ORG_CD = TBBADCMR011M.COPT_GD_CD) AS COPT_GD_NM          /*소관기관*/
			     , MNT_TIT_NM                                                               AS MNT_TIT_NM          /*제목*/
			     , F_CODE_NM('1000256', AUD_MNT_HNDL_STA_CD)                                AS AUD_MNT_HNDL_STA_NM /*처리상태*/
			     , NVL2(TRIM(REL_EPS_MNG_LAW_YE), 'O', 'X')                                 AS REL_EPS_MNG_LAW_YE  /*중점*/
				 , DECODE(NVL(HNDL_OPIN_YO, 'N'), 'Y', 'O', 'X')                            AS HNDL_OPIN_YO        /*의견*/
				 , NVL2(TRIM(HNDL_OPIN_RPL_DT), 'O', '')                                    AS HNDL_OPIN_RPL_YN    /*회신*/
				 , ''                                                                       AS EPS_LAW_YE
				 , ''                                                                       AS EPS_LAW_SNO
			  FROM TBBADCMR011M
			 WHERE 1 = 1
			   AND REL_EPS_MNG_LAW_YE  = #strEpsLawYe#
			   AND REL_EPS_MNG_LAW_SNO = #strEpsLawSno#
			   AND AUD_MNT_HNDL_STA_CD IS NOT NULL
			 ORDER BY LAW_YE DESC, LAW_MNT_SNO DESC
		]]>
	</select>
	
	<update id="BADCMR025Emaindelete" parameterClass="paramMap">
		<![CDATA[	
			DELETE TBBADCMR014M
			 WHERE EPS_LAW_YE    = #EPS_LAW_YE#
			   AND EPS_LAW_SNO   = #EPS_LAW_SNO#
		]]>
	</update>
		
	<!-- 법령 모니터링 테이블에 중점관리법령 등록된건 널로 갱신한다. -->
	<update id="BADCMR025EmainupdateRelEpsnmgLaw" parameterClass="paramMap">
		UPDATE TBBADCMR011M
		   SET FNL_MDF_DH     = SYSDATE
		     , REL_EPS_MNG_LAW_YE  = ''
		     , REL_EPS_MNG_LAW_SNO = ''
			<isNotEmpty prepend="," property="FNL_USR_ID">
				FNL_USR_ID = #FNL_USR_ID#
			</isNotEmpty>
			<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
				FNL_DEAL_DPT_CD =
				#FNL_DEAL_DPT_CD#
			</isNotEmpty>
			<isNotEmpty prepend="," property="FNL_MNU_ID">
				FNL_MNU_ID = #FNL_MNU_ID#
			</isNotEmpty>
		 WHERE 1 = 1
		   AND REL_EPS_MNG_LAW_YE  = #EPS_LAW_YE#
		   AND REL_EPS_MNG_LAW_SNO = #EPS_LAW_SNO#
	</update>	
	
	<!-- 인서트할 키값들 -->
	<select id="BADCMR025EmaininsertKey" parameterClass="paramMap" resultClass="resultMap">
		SELECT TO_CHAR(NVL(MAX(EPS_LAW_SNO), 0) + 1) AS EPS_LAW_SNO
		     , TO_CHAR(SYSDATE, 'YYYY')              AS EPS_LAW_YE
		  FROM TBBADCMR014M 
		 WHERE EPS_LAW_YE = TO_CHAR(SYSDATE, 'YYYY')
	</select>
	
	<!-- 중점관리 법령 정보 신규등록 -->
	<insert id="BADCMR025Emaininsert" parameterClass="paramMap">
		INSERT INTO TBBADCMR014M
			(
				  EPS_LAW_YE
				, EPS_LAW_SNO
				, DSP_RQ_AUD_YE
				, DSP_RQ_AUD_SNO
				, DSP_RQ_DSP_SNO
				, EPS_MNG_LAW_NM
				, COPT_DPT_CD
				, DOC_ID
				, DOC_TYP_CD
				, CPLT_DT
				, CPLT_YN
				, FRT_USR_ID
				, FNL_USR_ID
				, FNL_DEAL_DPT_CD
				, FNL_MNU_ID
				, FRT_REGI_DH
				, FNL_MDF_DH
			) VALUES
			(
				  #EPS_LAW_YE#
				, #EPS_LAW_SNO#
				, #DSP_RQ_AUD_YE#
				, #DSP_RQ_AUD_SNO#
				, #DSP_RQ_DSP_SNO#
				, #EPS_MNG_LAW_NM#
				, #COPT_DPT_CD#
				, #DOC_ID#
				, NVL2(#DOC_ID#, 'AD-MR-010', '')
				, DECODE(#CPLT_YN#, 'Y', TO_CHAR(SYSDATE, 'YYYYMMDD'), '')
				, #CPLT_YN#
				, #FRT_USR_ID#
				, #FNL_USR_ID#
				, #FNL_DEAL_DPT_CD#
				, #FNL_MNU_ID#
				, SYSDATE
				, SYSDATE
			)
	</insert>
	
	<!-- 중점관리 법령 정보 수정 -->
	<update id="BADCMR025Emainupdate" parameterClass="paramMap">
		UPDATE TBBADCMR014M
		   SET FNL_MDF_DH     = SYSDATE
		     , DSP_RQ_AUD_YE  = #DSP_RQ_AUD_YE#
		     , DSP_RQ_AUD_SNO = #DSP_RQ_AUD_SNO#
		     , DSP_RQ_DSP_SNO = #DSP_RQ_DSP_SNO#
		     , EPS_MNG_LAW_NM = #EPS_MNG_LAW_NM#
			 , COPT_DPT_CD    = #COPT_DPT_CD#
			 , DOC_ID         = #DOC_ID#
			 , DOC_TYP_CD     = NVL2(#DOC_ID#, 'AD-MR-010', '')
			 , CPLT_DT        = DECODE(#CPLT_YN#, 'Y', TO_CHAR(SYSDATE, 'YYYYMMDD'), '')
			 , CPLT_YN        = #CPLT_YN#
			<isNotEmpty prepend="," property="FNL_USR_ID">
				FNL_USR_ID = #FNL_USR_ID#
			</isNotEmpty>
			<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
				FNL_DEAL_DPT_CD =
				#FNL_DEAL_DPT_CD#
			</isNotEmpty>
			<isNotEmpty prepend="," property="FNL_MNU_ID">
				FNL_MNU_ID = #FNL_MNU_ID#
			</isNotEmpty>
		 WHERE 1 = 1
		   AND EPS_LAW_YE  = #EPS_LAW_YE#
		   AND EPS_LAW_SNO = #EPS_LAW_SNO#
	</update>
	
	<!--  법령 모니터링 테이블에 관려련중점관리 법령연도, 순번을 업데이트 한다. -->
	<update id="BADCMR025Esubupdate" parameterClass="paramMap">
		UPDATE TBBADCMR011M
		   SET FNL_MDF_DH     = SYSDATE
		     , REL_EPS_MNG_LAW_YE  = #EPS_LAW_YE#
		     , REL_EPS_MNG_LAW_SNO = #EPS_LAW_SNO#
			<isNotEmpty prepend="," property="FNL_USR_ID">
				FNL_USR_ID = #FNL_USR_ID#
			</isNotEmpty>
			<isNotEmpty prepend="," property="FNL_DEAL_DPT_CD">
				FNL_DEAL_DPT_CD =
				#FNL_DEAL_DPT_CD#
			</isNotEmpty>
			<isNotEmpty prepend="," property="FNL_MNU_ID">
				FNL_MNU_ID = #FNL_MNU_ID#
			</isNotEmpty>
		 WHERE 1 = 1
		   AND LAW_YE      = #LAW_YE#
		   AND LAW_MNT_SNO = #LAW_MNT_SNO#
	</update>        
</sqlMap> 
