<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/cor/104">
 	
 	<select id="CSPCOR104ESubSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	T1.CORR_DVSN_CD
					,T1.ACP_YR
					,T1.CORR_ACP_NO
					,F_DPT_INFO(T2.HNDL_DPT_CD,'1') AS HNDL_DPT_NM
					,T2.HNDL_DPT_CD
					,F_USR_INFO_BY_ID(T2.HNDL_CHGR_ID,'2') AS HNDL_CHGR_NM
					,T2.HNDL_CHGR_ID
					,T1.HNDL_STA_CD
					,T1.TNB
					,T1.RM_CORR_ACP_NO
			FROM	TBCSPCOR101M T1
			       ,TBCSPCOR104M T2
			WHERE	T1.CORR_DVSN_CD = '1'
			  AND   T1.CORR_DVSN_CD = T2.CORR_DVSN_CD(+)
			  AND   T1.ACP_YR = T2.ACP_YR(+)
			  AND   T1.CORR_ACp_NO = T2.CORR_ACP_NO(+)
			  AND   T1.CORR_DVSN_CD = #strCORR_DVSN_CD#
			  AND   T1.ACP_YR = #strACP_YR#
			  AND   T1.CORR_ACP_NO = #strCORR_ACP_NO#
		]]>
	</select>
	
	<update id="CSPCOR104E101DtpUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	TBCSPCOR101M
			SET		HNDL_STA_CD = CASE WHEN HNDL_STA_CD = '20' THEN '30' ELSE HNDL_STA_CD END
					,FNL_USR_ID = #FNL_USR_ID#
   					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
   					,FNL_MNU_ID = #FNL_MNU_ID#
   					,FNL_MDF_DH=SYSDATE
			WHERE	CORR_DVSN_CD = #CORR_DVSN_CD#
			AND		ACP_YR = #ACP_YR#
			AND		CORR_ACP_NO = #CORR_ACP_NO#
		]]>
	</update>
	
	<update id="CSPCOR104E104DtpbMerge" parameterClass="paramMap">
		<![CDATA[
			MERGE INTO 	TBCSPCOR104M A
        	USING 	(	SELECT 	#CORR_DVSN_CD# AS CORR_DVSN_CD 
        						,#ACP_YR# AS ACP_YR
        						,#CORR_ACP_NO# AS CORR_ACP_NO
        				FROM DUAL
        			) B
        	ON		(	A.CORR_DVSN_CD = B.CORR_DVSN_CD
        				AND	A.ACP_YR = B.ACP_YR
        				AND A.CORR_ACP_NO = B.CORR_ACP_NO
        			)
        	WHEN MATCHED THEN
        			UPDATE	
        			SET		HNDL_DPT_CD = #HNDL_DPT_CD#
        					,HNDL_CHGR_ID = #HNDL_CHGR_ID#
        					,DTB_DH = CASE WHEN DTB_DH IS NULL THEN SYSDATE ELSE DTB_DH END
        					,FNL_DTB_DH = SYSDATE
        					,FNL_USR_ID = #FNL_USR_ID#
        					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
        					,FNL_MNU_ID = #FNL_MNU_ID#
        					,FNL_MDF_DH = SYSDATE
        	WHEN NOT MATCHED THEN
		        	INSERT 		(	CORR_DVSN_CD
		        					,ACP_YR
		        					,CORR_ACP_NO
		        					,HNDL_DPT_CD
		        					,HNDL_CHGR_ID
		        					,DTB_DH
		        					,FNL_DTB_DH
		        					,FRT_USR_ID
		        					,FNL_USR_ID
		        					,FNL_DEAL_DPT_CD
		        					,FNL_MNU_ID
		        					,FRT_REGI_DH
		        					,FNL_MDF_DH 
		        				)
		        		VALUES	(	#CORR_DVSN_CD#
									,#ACP_YR#
									,#CORR_ACP_NO#
									,#HNDL_DPT_CD#
		        					,#HNDL_CHGR_ID#
		        					,SYSDATE
		        					,SYSDATE
									,#FNL_USR_ID#
									,#FNL_USR_ID#
									,#FNL_DEAL_DPT_CD#
									,#FNL_MNU_ID#
									,SYSDATE
									,SYSDATE
								)
		]]>
	</update>
	
</sqlMap> 
