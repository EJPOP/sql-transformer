<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/ear/014">
	
	<select id="CSPEAR014PInitSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	C.TNB AS SEN_TNB
					,A.HPN AS RCPT_TNB
			FROM	TBCSPDCP101M A
					,TBCSPEAR001M B
					,TBDCMACM002M C
			WHERE	A.REQ_DVSN_CD = #strREQ_DVSN_CD#
			AND		A.ACP_YR = #strACP_YR#
			AND		A.CVPT_ACP_NO = #strCVPT_ACP_NO#
   			AND		A.REQ_DVSN_CD = B.REQ_DVSN_CD
   			AND		A.ACP_YR = B.ACP_YR
   			AND		A.CVPT_ACP_NO = B.CVPT_ACP_NO
   			AND		B.HNDL_DPT_CD = C.DPT_CD
		]]>
	</select>
	
 	<select id="CSPEAR014PMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	A.REQ_DVSN_CD
					,A.ACP_YR
   					,A.CVPT_ACP_NO
   					,A.HPN
   					,C.SRNO
   					,C.SEN_DT
   					,C.SMS_TXT
   					,C.SEN_TNB
   					,C.RCPT_TNB
   			FROM	TBCSPDCP101M A
   					,TBCSPEAR001M B
   					,TBCSPEAR008H C
   			WHERE	1=1
   			AND		A.REQ_DVSN_CD = #strREQ_DVSN_CD#
			AND		A.ACP_YR = #strACP_YR#
			AND		A.CVPT_ACP_NO = #strCVPT_ACP_NO#
   			AND		A.REQ_DVSN_CD = B.REQ_DVSN_CD
   			AND		A.ACP_YR = B.ACP_YR
   			AND		A.CVPT_ACP_NO = B.CVPT_ACP_NO
   			AND		A.REQ_DVSN_CD = C.REQ_DVSN_CD
   			AND		A.ACP_YR = C.ACP_YR
   			AND		A.CVPT_ACP_NO = C.CVPT_ACP_NO
   			ORDER BY C.SRNO DESC
		]]>
	</select>
	
	<insert id="CSPEAR014PMmsMsgInsert" parameterClass ="paramMap">
		<![CDATA[
			INSERT INTO MMS_CONTENTS_INFO 
				 	(	CONT_SEQ
				 		, FILE_CNT
				 		, MMS_BODY
				 		, MMS_SUBJECT
				 	) 
			VALUES (	#CONT_SEQ#
						, 1
						, #SMS_TXT#
						, '감사원 감사청구 문자통보'
					)
		]]>
	</insert>
	
	<insert id="CSPEAR014PMsgInsert" parameterClass ="paramMap">
		<![CDATA[
			INSERT INTO MSG_DATA
				 	(	MSG_SEQ
				 		, CUR_STATE
				 		, REQ_DATE
				 		, CALL_TO
				 		, CALL_FROM
				 		, SMS_TXT
				 		, MSG_TYPE
				 		, CONT_SEQ
				 		, USERDATA
				 	) 
			VALUES (	MSG_DATA_SEQ.NEXTVAL
						, 0
						, SYSDATE
						, REPLACE(TRIM(#RCPT_TNB#),'-','')
						, REPLACE(TRIM(#SEN_TNB#),'-','')
						, ''
						, 6
						, #CONT_SEQ#
						, #REQ_DVSN_CD#||#ACP_YR#||#CVPT_ACP_NO#
					)
		]]>
	</insert>
	
	<insert id="CSPEAR014PSmsSendInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO	TBCSPEAR008H
					(	REQ_DVSN_CD
						,ACP_YR
						,CVPT_ACP_NO
						,SRNO
						,SEN_DT
						,SMS_TXT
						,SEN_TNB
						,RCPT_TNB
						,FRT_USR_ID
						,FNL_USR_ID
						,FNL_DEAL_DPT_CD
						,FNL_MNU_ID
						,FRT_REGI_DH
						,FNL_MDF_DH
					)
			VALUES	(	#REQ_DVSN_CD#
						,#ACP_YR#
						,#CVPT_ACP_NO#
						,(	SELECT	NVL(MAX(SRNO),0)+1
							FROM	TBCSPEAR008H
							WHERE	REQ_DVSN_CD = #REQ_DVSN_CD#
							AND		ACP_YR = #ACP_YR#
							AND		CVPT_ACP_NO = #CVPT_ACP_NO#
						)
						,TO_CHAR(SYSDATE,'YYYYMMDD')
						,#SMS_TXT#
						,#SEN_TNB#
						,#RCPT_TNB#
						,#FRT_USR_ID#
						,#FNL_USR_ID#
						,#FNL_DEAL_DPT_CD#
						,#FNL_MNU_ID#
						,SYSDATE
						,SYSDATE
					)
			
		]]>
	</insert>
</sqlMap> 
