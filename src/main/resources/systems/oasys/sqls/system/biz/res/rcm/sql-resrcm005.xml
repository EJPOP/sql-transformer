<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="res/rcm/005">

	<select id="RESRCM005IMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT rownum AS NUM,
			       T1.EVL_YR /* 평가년도 */,
			       T1.HLYR_DVSN_CD /* 반기구분코드 */,
			       T1.EVL_DGE /* 평가차수 */,
			       T1.EVL_TG_DPT_CD /* 평가대상부서코드 */,
			       F_DPT_INFO(T1.EVL_TG_DPT_CD,'1') AS EVL_TG_DPT_NM,
			       T1.UNT_TSK_SNO /* 단위업무순번 */,
			       T1.UNT_TSK_NM /* 단위업무명 */,
			       T1.UNT_TSK_TXT /* 단위업무내용 */,
			       COUNT(1) OVER () AS TOT_CNT
			  FROM TBRESRSP002M T1
			 WHERE 1=1
		]]>
		<isNotEmpty property="EVL_YR">	
			   AND T1.EVL_YR = #EVL_YR#
		</isNotEmpty>

		<isNotEmpty property="HLYR_DVSN_CD">	
			   AND T1.HLYR_DVSN_CD = #HLYR_DVSN_CD#
		</isNotEmpty>
		
		<isNotEmpty property="EVL_DGE">	
			   AND T1.EVL_DGE = #EVL_DGE#
		</isNotEmpty>		
		<isNotEmpty property="EVL_TG_DPT_CD">	
			   AND T1.EVL_TG_DPT_CD = #EVL_TG_DPT_CD#
		</isNotEmpty>		
		<isNotEmpty property="UNT_TSK_SNO">
			   AND T1.UNT_TSK_SNO IN
					<iterate property="UNT_TSK_SNO" open="(" close=")" conjunction=",">
						#UNT_TSK_SNO[]#
					</iterate>
		</isNotEmpty>
	     
		<isNotEmpty property="APV_DOC_NO">	
			   AND T1.APV_DOC_NO = #APV_DOC_NO#
		</isNotEmpty>
	     
		ORDER BY T1.UNT_TSK_SNO ASC
	</select>
	
	<update id="RESRCM005IApvSave" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBRESRSP002M T1
			   SET APV_DOC_NO = #APV_DOC_NO#
			      ,APV_STA_CD = #APV_STA_CD#
			 WHERE 1=1
		]]>
		
		<isNotEmpty property="UNT_TSK_SNO">
			AND T1.EVL_YR = #EVL_YR#
			AND T1.HLYR_DVSN_CD = #HLYR_DVSN_CD#
			AND T1.EVL_DGE = #EVL_DGE#
			AND T1.EVL_TG_DPT_CD = #EVL_TG_DPT_CD#
		   	AND T1.UNT_TSK_SNO IN
				<iterate property="UNT_TSK_SNO" open="(" close=")" conjunction=",">
					#UNT_TSK_SNO[]#
				</iterate>
		</isNotEmpty>
		
		<isEmpty property="UNT_TSK_SNO">
			AND APV_DOC_NO = #APV_DOC_NO#
		</isEmpty>
	</update>
</sqlMap> 
