<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="dcm/acm/045">
	<resultMap class="java.util.HashMap" id="hwpDocMap">
		<result property="TSK_KND_CD" column="TSK_KND_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="TSK_KND_NM" column="TSK_KND_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="TSK_STEP_CD" column="TSK_STEP_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="TSK_STEP_NM" column="TSK_STEP_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="TSK_DOC_CD" column="TSK_DOC_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="TSK_DOC_NM" column="TSK_DOC_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="META_INF_SNO" column="META_INF_SNO" jdbcType="NUMBER" javaType="java.lang.String" />
		<result property="META_INF_DES" column="META_INF_DES" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ADM_YN" column="ADM_YN" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="REGN_ID" column="REGN_ID" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="USE_YN" column="USE_YN" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="META_INF_TXT" column="META_INF_TXT" jdbcType="CLOB" javaType="java.lang.String" />
		<result property="ADM_YN_NM" column="ADM_YN_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
	</resultMap>

	<update id="dcmacm045ChangeSbmCnb" parameterClass="paramMap">
		<![CDATA[
			update tbdcmacm022l
			   set SBM_CNB = #chrCnb#
			 where apv_doc_no = #strDocNo#
			   and apv_dvsn_cd = #strApvDvsnCd#
		]]>
	</update>
	
	<update id="dcmacm045ChangeSbmCnb2" parameterClass="paramMap">
		<![CDATA[
			update tbdcmacm023l
			   set APVR_CNB = #chrCnb#
			   	  ,APVR_DPT_CD = #chrDptCd#
			   	  ,APVR_RANK_CD = #chrRankCd#
			   	  ,APVR_PST_CD = #chrPstCd#
			   	  ,ONR_PST_NM = (SELECT ONR_PST_NM FROM TBDCMACM001M WHERE CNB = #chrCnb#)
			 where apv_doc_no = #strDocNo#
			   and apv_dvsn_cd = #strApvDvsnCd#
			   and APVR_KND_CD = '1'
			   and APV_SNO = '1'
		]]>
	</update>
	
	
	<update id="dcmacm045UpdateSbmDh" parameterClass="paramMap">
		<![CDATA[
			update tbdcmacm022l
			  set SBM_DH = SYSDATE
			where apv_doc_no = #APV_DOC_NO#
			   and apv_dvsn_cd = #APV_DVSN_CD#
		]]>
	</update>
	
	<update id="dcmacm045UpdateApvDh" parameterClass="paramMap">
		<![CDATA[
			update tbdcmacm023l
			  set APV_DH = SYSDATE
			where apv_doc_no = #APV_DOC_NO#
			   and apv_dvsn_cd = #APV_DVSN_CD#
			   and APVR_KND_CD = '1'
			   and APV_SNO = '1'
		]]>
	</update>
	
	<insert id="dcmacm045InsertTskMetaInfDocData" parameterClass="paramMap">
		<![CDATA[
			INSERT 
			  INTO TBFDMADM004M (
						TSK_KND_CD,
						TSK_STEP_CD,
						TSK_DOC_CD,
						META_INF_SNO,
						META_INF_DES,
						ADM_YN,
						REGN_ID, 
						USE_YN,
						FRT_USR_ID,
						FNL_USR_ID,
						FNL_DEAL_DPT_CD,
						FNL_MNU_ID,
						FRT_REGI_DH,
						FNL_MDF_DH
					 )  
					 VALUES (
					 	#strKndCd#,
						#strAudStepCd#,
						#strRprtCd#,
						(SELECT NVL(MAX(META_INF_SNO),0)+1 FROM TBFDMADM004M),
						#strRprtNm#,
						'N',
						#FRT_USR_ID#,
						'Y',
						#FRT_USR_ID#,    /*세션정보*/
						#FNL_USR_ID#,
						#FNL_DEAL_DPT_CD#,
						#FNL_MNU_ID#,
						SYSDATE,
						SYSDATE
					)
		]]>
	</insert>
	<insert id="dcmacm045InsertTskDraftDocData" parameterClass="paramMap">
		<![CDATA[
			INSERT 
			  INTO TBFDMADM005M (
						TSK_KND_CD,
						TSK_STEP_CD,
						TSK_DOC_CD,
						META_INF_SNO,
						META_INF_TXT,
						FRT_USR_ID,
						FNL_USR_ID,
						FNL_DEAL_DPT_CD,
						FNL_MNU_ID,
						FRT_REGI_DH,
						FNL_MDF_DH 
					 ) 
					 VALUES (
					 	#strKndCd#,
						#strAudStepCd#,
						#strRprtCd#,
						(SELECT NVL(MAX(META_INF_SNO),0)+1 FROM TBFDMADM005M),
						#strDraftTxt#,
						#FRT_USR_ID#,    /*세션정보*/
						#FNL_USR_ID#,
						#FNL_DEAL_DPT_CD#,
						#FNL_MNU_ID#,
						SYSDATE,
						SYSDATE
					)
		]]>
	</insert>
	
	<select id="dcmacm067SelectTskMetaInfDoc" parameterClass="paramMap"
		resultMap="hwpDocMap">
	<![CDATA[
	 	SELECT T1.TSK_KND_CD,
		       F_CODE_NM('1000787', T1.TSK_KND_CD) AS TSK_KND_NM,
		       T1.TSK_STEP_CD,
		       F_CODE_NM('1000785', T1.TSK_STEP_CD) AS TSK_STEP_NM,
		       T1.TSK_DOC_CD,
		       F_CODE_NM('1000786', T1.TSK_DOC_CD) AS TSK_DOC_NM,
		       T1.META_INF_SNO,
		       T1.META_INF_DES,
		       CASE
		         WHEN T1.ADM_YN = 'Y' THEN '표준'
		         WHEN T1.ADM_YN = 'N' THEN '비표준'
		       END AS ADM_YN_NM,
		       T1.ADM_YN,
		       T1.REGN_ID,
		       T1.USE_YN,
		       T2.META_INF_TXT
		  FROM TBFDMADM004M T1,
		       TBFDMADM005M T2
		 WHERE 1=1
		   AND T1.TSK_KND_CD = T2.TSK_KND_CD
		   AND T1.TSK_STEP_CD = T2.TSK_STEP_CD
		   AND T1.TSK_DOC_CD = T2.TSK_DOC_CD
		   AND T1.META_INF_SNO = T2.META_INF_SNO
		   AND (T1.ADM_YN = 'Y' 
          ]]>
           
        <isNotEmpty property="sttCnb">
		   		OR T1.REGN_ID = (SELECT USR.USR_ID
					    FROM TBDCMACM001M USR
					   WHERE USR.CNB = #sttCnb# )
		</isNotEmpty>
		  	   )

		<isNotEmpty property="strTskKndCd">
			AND T1.TSK_KND_CD = #strTskKndCd#
		</isNotEmpty>
		<isNotEmpty property="strTskStepCd">
			AND T1.TSK_STEP_CD = #strTskStepCd#
		</isNotEmpty>
		<isNotEmpty property="strTskDocCd">
			AND T1.TSK_DOC_CD = #strTskDocCd#
		</isNotEmpty>
		ORDER BY ADM_YN DESC ,T1.META_INF_SNO DESC;
		
	</select>
	<delete id="dcmacm067DeleteTskDraftDoc" parameterClass="paramMap"	>
		DELETE FROM TBFDMADM005M			   
		 WHERE 1=1 
		 AND TSK_KND_CD = #strTskKndCd#
		 AND TSK_STEP_CD = #strTskStepCd#
		 AND TSK_DOC_CD = #strTskDocCd#
		 AND META_INF_SNO = #strSno#
		
	</delete>
	<delete id="dcmacm067DeleteTskMetaInfDoc" parameterClass="paramMap"	>
		DELETE FROM TBFDMADM004M			   
		 WHERE 1=1 
		 AND TSK_KND_CD = #strTskKndCd#
		 AND TSK_STEP_CD = #strTskStepCd#
		 AND TSK_DOC_CD = #strTskDocCd#
		 AND META_INF_SNO = #strSno#
		
	</delete>
	
</sqlMap>