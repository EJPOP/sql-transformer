<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="aep/gkm/030">
	<select id="AEPGKM030Emainselect" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT  A.EVL_YR
		        ,A.EVL_DVSN_CD
		        ,A.CNB
		        ,MAX(A.USR_NM) AS USR_NM
		        ,MAX(A.DPT_NM) AS DPT_NM
		        ,SUM(A.SC) AS TOT
		        <iterate property="condition" prepend="," conjunction=",">
		        SUM(CASE WHEN A.SC_GRN_TG_CD = #condition[]# THEN A.SC ELSE 0 END) AS SC$condition[]$
		        </iterate>
		        <iterate property="condition" prepend="," conjunction=",">
		        SUM(CASE WHEN A.SC_GRN_TG_CD = #condition[]# THEN 1 ELSE 0 END) AS CT$condition[]$
		        </iterate>
		        ,(CASE WHEN B.CNB IS NULL THEN 'N' ELSE 'Y' END) AS APPLY_YN
		        ,(CASE WHEN B.CNB IS NULL THEN '미승인' ELSE '승인' END) AS APPLY_KO
		FROM    (
		        SELECT  EVL_YR
		                ,EVL_DVSN_CD
		                ,SC_GRN_TG_CD
		                ,CNB
		                ,KNB
		                ,USR_NM
		                ,DPT_NM
		                ,ROUND(AVG(BSC_SC + EVL_SC + ADD_SC)) AS SC
		        FROM    (
		                SELECT  EVL_YR
		                        ,EVL_DVSN_CD
		                        ,SC_GRN_TG_CD
		                        ,KNB
		                        ,EVLT_CNB
		                        ,CNB
		                        ,F_USR_INFO(CNB, '2') AS USR_NM
		                        ,F_DPT_INFO(F_USR_INFO(CNB, '5'), '1') AS DPT_NM
		                        ,MAX(CASE WHEN SC_CAT_CD=1 THEN SC ELSE 0 END) AS BSC_SC
		                        ,SUM(CASE WHEN SC_CAT_CD=2 THEN SC ELSE 0 END) AS EVL_SC
		                        ,MAX(CASE WHEN SC_CAT_CD=3 THEN SC ELSE 0 END) AS ADD_SC
		                FROM    TBAEPGKM016L
		                WHERE   1=1
		                GROUP BY EVL_YR
		                        ,EVL_DVSN_CD
		                        ,SC_GRN_TG_CD
		                        ,KNB
		                        ,EVLT_CNB
		                        ,CNB
		                )
		        WHERE   1=1
		        GROUP BY EVL_YR
		                ,EVL_DVSN_CD
		                ,SC_GRN_TG_CD
		                ,CNB
		                ,KNB
		                ,USR_NM
		                ,DPT_NM
		        ) AS A,
		        TBAEPGKM014L AS B
		WHERE   A.EVL_YR = B.EVL_YR(+)
		AND     A.EVL_DVSN_CD = B.EVL_DVSN_CD(+)
		AND     A.CNB = B.CNB(+)
		<isNotEmpty property="EVL_YR">
		AND		A.EVL_YR = #EVL_YR#
		</isNotEmpty>
		<isNotEmpty property="EVL_DVSN_CD">
		AND		A.EVL_DVSN_CD = #EVL_DVSN_CD#
		</isNotEmpty>
		GROUP BY A.EVL_YR
		        ,A.EVL_DVSN_CD
		        ,A.CNB
		        ,B.CNB
        ORDER BY CNB
	</select>
	
	<select id="AEPGKM031Emainselect" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT  A.EVL_YR
		        ,A.EVL_DVSN_CD
		        ,A.DPT_NM
		        ,A.DPT_CD
		        ,MAX(A.DPT_NM) AS DPT_NM
		        ,SUM(A.SC) AS TOT
		        <iterate property="condition" prepend="," conjunction=",">
		        SUM(CASE WHEN A.SC_GRN_TG_CD = #condition[]# THEN A.SC ELSE 0 END) AS SC$condition[]$
		        </iterate>
		        <iterate property="condition" prepend="," conjunction=",">
		        SUM(CASE WHEN A.SC_GRN_TG_CD = #condition[]# THEN 1 ELSE 0 END) AS CT$condition[]$
		        </iterate>
		        ,(CASE WHEN B.DPT_CD IS NULL THEN 'N' ELSE 'Y' END) AS APPLY_YN
		        ,(CASE WHEN B.DPT_CD IS NULL THEN '미승인' ELSE '승인' END) AS APPLY_KO
		FROM    (
		        SELECT  EVL_YR
		                ,EVL_DVSN_CD
		                ,SC_GRN_TG_CD
		                ,KNB
		                ,DPT_CD
		                ,DPT_NM
		                ,ROUND(AVG(BSC_SC + EVL_SC + ADD_SC)) AS SC
		        FROM    (
		                SELECT  EVL_YR
		                        ,EVL_DVSN_CD
		                        ,SC_GRN_TG_CD
		                        ,KNB
		                        ,EVLT_CNB
		                        ,F_USR_INFO(CNB, '5') AS DPT_CD
		                        ,F_DPT_INFO(F_USR_INFO(CNB, '5'), '1') AS DPT_NM
		                        ,MAX(CASE WHEN SC_CAT_CD=1 THEN SC ELSE 0 END) AS BSC_SC
		                        ,SUM(CASE WHEN SC_CAT_CD=2 THEN SC ELSE 0 END) AS EVL_SC
		                        ,MAX(CASE WHEN SC_CAT_CD=3 THEN SC ELSE 0 END) AS ADD_SC
		                FROM    TBAEPGKM016L
		                WHERE   1=1
		                GROUP BY EVL_YR
		                        ,EVL_DVSN_CD
		                        ,SC_GRN_TG_CD
		                        ,KNB
		                        ,EVLT_CNB
		                        ,CNB
		                        ,COFM_YN
		                )
		        WHERE   1=1
		        GROUP BY EVL_YR
		                ,EVL_DVSN_CD
		                ,SC_GRN_TG_CD
		                ,KNB
		                ,DPT_CD
		                ,DPT_NM
		        ) AS A,
		        TBAEPGKM015L AS B
		WHERE   A.EVL_YR = B.EVL_YR(+)
		AND     A.EVL_DVSN_CD = B.EVL_DVSN_CD(+)
		AND     A.DPT_CD = B.DPT_CD(+)
		<isNotEmpty property="EVL_YR">
		AND		A.EVL_YR = #EVL_YR#
		</isNotEmpty>
		<isNotEmpty property="EVL_DVSN_CD">
		AND		A.EVL_DVSN_CD = #EVL_DVSN_CD#
		</isNotEmpty>
		GROUP BY A.EVL_YR
		        ,A.EVL_DVSN_CD
		        ,A.DPT_NM
		        ,A.DPT_CD
		        ,B.DPT_CD
		ORDER BY A.DPT_CD 
	</select>
	
	
	<insert id="AEPGKM031EUserInsert" parameterClass="java.util.Map">
		INSERT INTO TBAEPGKM014L
		(
		EVL_YR	/* 평가년도 */
		,EVL_DVSN_CD	/* 평가구분코드 */
		,CNB	/* 전산번호 */
		,FRT_USR_ID	/* 최초사용자ID */
		,FNL_USR_ID	/* 최종사용자ID */
		,FNL_DEAL_DPT_CD	/* 최종거래부서코드 */
		,FNL_MNU_ID	/* 최종메뉴ID */
		,FRT_REGI_DH	/* 최초등록일시 */
		,FNL_MDF_DH	/* 최종수정일시 */
		)
        VALUES 
        (#EVL_YR#
        ,#EVL_DVSN_CD#
        ,#CNB#
		,#FRT_USR_ID#              
		,#FNL_USR_ID#  
		,#FNL_DEAL_DPT_CD#         
		,#FNL_MNU_ID#   
		,SYSDATE
		,SYSDATE
		)
	</insert>
	
	<delete id="AEPGKM031EUserDelete" parameterClass="java.util.Map">
		DELETE TBAEPGKM014L
		WHERE 1=1
		  AND EVL_YR =  #EVL_YR#      
          AND EVL_DVSN_CD =   #EVL_DVSN_CD#
          AND CNB = #CNB#          
	</delete>
	
	
	
	<insert id="AEPGKM031EDptInsert" parameterClass="java.util.Map">
		INSERT INTO TBAEPGKM015L
		(
		EVL_YR	/* 평가년도 */
		,EVL_DVSN_CD	/* 평가구분코드 */
		,DPT_CD	/* 부서코드 */
		,FRT_USR_ID	/* 최초사용자ID */
		,FNL_USR_ID	/* 최종사용자ID */
		,FNL_DEAL_DPT_CD	/* 최종거래부서코드 */
		,FNL_MNU_ID	/* 최종메뉴ID */
		,FRT_REGI_DH	/* 최초등록일시 */
		,FNL_MDF_DH	/* 최종수정일시 */
		)
        VALUES 
        (
        #EVL_YR#
        ,#EVL_DVSN_CD#
        ,#DPT_CD#
		,#FRT_USR_ID#              
		,#FNL_USR_ID#  
		,#FNL_DEAL_DPT_CD#         
		,#FNL_MNU_ID#   
		,SYSDATE
		,SYSDATE
		)
	</insert>
	
	<delete id="AEPGKM031EDptDelete" parameterClass="java.util.Map">
		DELETE TBAEPGKM015L
		WHERE 1=1
		  AND EVL_YR =  #EVL_YR#      
          AND EVL_DVSN_CD =   #EVL_DVSN_CD#
          AND DPT_CD = #DPT_CD#          
	</delete>
</sqlMap>

