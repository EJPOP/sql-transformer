<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="aep/gkm/020">
	<select id="AEPGKM020Emainselect" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	<include refid = "include.pageSelct"/>
		SELECT C.KNB 
		     , KLD_NM 
		     , REGI_RQS_DT 
		     , PRSV_WAY_CD 
		     , PRSV_DDLN_DH 
		     , KLD_CAT_CD 
		     , KLD_CAT_NM 
		     , DOC_ID 
		     , KLD_STA_CD 
		     , SRCH_CNT
		     , NVL(D.COUNT, '0') AS COUNT
		     , NVL(E.COFM_YN, 'N') AS COFM_YN
		     , CASE WHEN C.DOC_ID IS NOT NULL THEN (SELECT DECODE(COUNT(*), 0, 'N', 'Y') FROM UBKERAPP.XR_PAGE WHERE DOC_ID = C.DOC_ID ) ELSE 'N' END AS FILE_YN
		     , CASE WHEN C.DOC_ID IS NOT NULL THEN (SELECT DECODE(COUNT(*), 0, 'N', 'Y') FROM UBKERAPP.XR_PAGE WHERE DOC_ID = C.DOC_ID AND PAGE_TITLE IS NOT NULL AND SUBSTR(PAGE_TITLE, CASE WHEN INSTR(PAGE_TITLE, '.',-1) > 0 THEN INSTR(PAGE_TITLE, '.',-1)+1 ELSE 1 END) != 'hwp')
		             ELSE 'N' END AS NOT_HWP_DOC_YN
		     , C.REGN_CNB AS USR_CNB
             , F_USR_INFO(C.REGN_CNB ,'2') AS USR_NAM 
             , NVL(F.CMMT_CNT, 0) AS CMMT_CNT    /*댓글갯수 2015.01.26 박재운감사관 요청*/    
		  FROM (
		    SELECT A.KNB ,
		           A.KLD_NM ,
		           A.REGI_RQS_DT ,
		           A.PRSV_WAY_CD ,
		           ( CASE A.PRSV_WAY_CD WHEN '0' THEN '영구보존' ELSE TO_CHAR(A.PRSV_DDLN_DH, 'YYYY-MM-DD') END) AS PRSV_DDLN_DH ,
		           A.KLD_CAT_CD ,
		           B.TG_CAT_NM AS KLD_CAT_NM ,
		           A.DOC_ID ,
		           A.KLD_STA_CD ,
		           A.SRCH_CNT ,
		           TO_CHAR(ABRG_DH, 'YYYYMMDD') AS ABRG_DH
		           , A.REGN_CNB
		      FROM TBAEPGKM001M AS A ,
		           TBAEPGKM017M AS B 
		     WHERE A.KLD_CAT_CD = B.TG_CAT_ID (+)
				<isNotEmpty property="AUD_NO" prepend="AND">
						A.AUD_NO = #AUD_NO#
				</isNotEmpty>
				<isNotEmpty property="AUD_YR" prepend="AND">
						A.AUD_YR = #AUD_YR#
				</isNotEmpty>		     
				<isNotEmpty property="CNB" prepend="AND">
						A.REGN_CNB = #CNB#
				</isNotEmpty>
				<isNotEmpty property="REGN_CNB" prepend="AND">
						A.REGN_CNB IN (	SELECT 	CNB 
										FROM 	TBDCMACM001M
										WHERE	USR_NAM LIKE '%'||#REGN_CNB#||'%')
						AND REGN_OPEN_YN = 'Y'
				</isNotEmpty>
				<isNotEmpty property="STT_REGI_RQS_DT" prepend="AND">
						<![CDATA[ A.REGI_RQS_DT >= #STT_REGI_RQS_DT# ]]>
				</isNotEmpty>
				<isNotEmpty property="END_REGI_RQS_DT" prepend="AND">
						<![CDATA[ A.REGI_RQS_DT <= #END_REGI_RQS_DT# ]]>
				</isNotEmpty>
				<isNotEmpty property="PRSV_WAY_CD" prepend="AND">
						A.PRSV_WAY_CD = #PRSV_WAY_CD#
				</isNotEmpty>
				<isNotEmpty property="STT_PRSV_DDLN_DH" prepend="AND">
						<![CDATA[ A.PRSV_DDLN_DH >= #STT_PRSV_DDLN_DH# ]]>
				</isNotEmpty>
				<isNotEmpty property="END_PRSV_DDLN_DH" prepend="AND">
						<![CDATA[ A.PRSV_DDLN_DH <= #END_PRSV_DDLN_DH# ]]>
				</isNotEmpty>
				<isNotEmpty property="KLD_CAT_CD" prepend="AND">
						A.KLD_CAT_CD IN (
						         SELECT TG_CAT_ID
						          FROM TBAEPGKM017M A
						             , (
						                SELECT SRT_VAL_NM
						                  FROM TBAEPGKM017M
						                 WHERE TG_CAT_ID = #KLD_CAT_CD#
						              ) B
						        WHERE A.SRT_VAL_NM LIKE B.SRT_VAL_NM || '%'  
						   		)	
				</isNotEmpty>
				<isNotEmpty property="KLD_NM_KYWD" prepend="AND">
						( A.KLD_NM LIKE '%' || #KLD_NM_KYWD# || '%' OR
						(
						A.KYWD_NM_1 LIKE '%' || #KLD_NM_KYWD# || '%' OR
						A.KYWD_NM_2 LIKE '%' || #KLD_NM_KYWD# || '%' OR
						A.KYWD_NM_3 LIKE '%' || #KLD_NM_KYWD# || '%'
						) )
				</isNotEmpty>
				<isNotEmpty property="KLD_STA_CD" prepend="AND">
						A.KLD_STA_CD	= #KLD_STA_CD#
				</isNotEmpty>
				<isNotEmpty property="FUNC_SPH_CD" prepend="AND">
						A.FUNC_SPH_CD	= #FUNC_SPH_CD#
				</isNotEmpty>
				<isNotEmpty property="CAT_SPH_CD" prepend="AND">
						A.CAT_SPH_CD	= #CAT_SPH_CD#
				</isNotEmpty>		     
		     ORDER BY TO_NUMBER(A.KNB) DESC
		 ) C
		 , (
		     SELECT KNB 
		         , COUNT(KNB) AS COUNT
		      FROM (
		        SELECT KNB
		          FROM TBAEPGKM002L
		         UNION ALL
		        SELECT KNB
		         FROM TBAEPGKM004L
		         )
		     GROUP BY KNB
		 ) D
		 , (
		 SELECT KNB
		     , MAX(COFM_YN) AS COFM_YN
		  FROM TBAEPGKM016L
		 WHERE COFM_YN = 'Y'
		   AND KNB IS NOT NULL
		 GROUP BY KNB
		 ) E
         , (
         SELECT POST_SEQ
              , COUNT(*) AS CMMT_CNT
           FROM CTT_POST_CMMT
          WHERE BOARD_ID = '1550'
          GROUP BY POST_SEQ        
         ) F
		WHERE C.KNB = D.KNB (+)
		  AND C.KNB = E.KNB (+)
		  AND C.KNB = F.POST_SEQ (+)
		  ORDER BY C.REGI_RQS_DT DESC
		  <include refid = "include.pageOrder"/> 
	</select>
	
	<update id="AEPGKM020Emainupdate" parameterClass="java.util.Map">
		<isEqual property="KLD_STA_CD" compareValue="6">
			UPDATE	TBAEPGKM001M
			SET		KLD_STA_CD = #KLD_STA_CD#,
					RSTR_DH = SYSDATE,
					EXPR_DH = NULL,
					ABRG_DH = NULL,
					FNL_USR_ID		= #FNL_USR_ID#,
					FNL_DEAL_DPT_CD	= #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID		= #FNL_MNU_ID#,
					FNL_MDF_DH		= SYSDATE
			WHERE	1=1	
			AND		KNB = #KNB#
		</isEqual>
		<isEqual property="KLD_STA_CD" compareValue="7">
			UPDATE	TBAEPGKM001M
			SET		KLD_STA_CD = #KLD_STA_CD#,
					RSTR_DH = NULL,
					EXPR_DH = SYSDATE,
					ABRG_DH = NULL,
					FNL_USR_ID		= #FNL_USR_ID#,
					FNL_DEAL_DPT_CD	= #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID		= #FNL_MNU_ID#,
					FNL_MDF_DH		= SYSDATE
			WHERE	1=1	
			AND		KNB = #KNB#
		</isEqual>
		<isEqual property="KLD_STA_CD" compareValue="8">
			UPDATE	TBAEPGKM001M
			SET		KLD_STA_CD = #KLD_STA_CD#,
					RSTR_DH = NULL,
					ABRG_DH = SYSDATE,
					FNL_USR_ID		= #FNL_USR_ID#,
					FNL_DEAL_DPT_CD	= #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID		= #FNL_MNU_ID#,
					FNL_MDF_DH		= SYSDATE
			WHERE	1=1	
			AND		KNB = #KNB#
		</isEqual>
	</update>

	<delete id="AEPGKM020Emaindelete" parameterClass="java.util.Map">
		DECLARE
			BEGIN
				INSERT INTO TBAEPGKM018H
					(
					HST_DVSN_CD	/* 이력구분코드 */
					,HST_SNO	/* 이력순번 */
					,HST_DH	/* 이력일시 */
					,KNB	/* 지식번호 */
					,KLD_NM	/* 지식명 */
					,KLD_SMM_TXT	/* 지식요약내용 */
					,KYWD_NM_1	/* 키워드명1 */
					,KYWD_NM_2	/* 키워드명2 */
					,KYWD_NM_3	/* 키워드명3 */
					,REGI_RQS_DT	/* 등록요청일 */
					,PRSV_WAY_CD	/* 보존방법코드 */
					,PRSV_DDLN_DH	/* 보존기한일시 */
					,KLD_CAT_CD	/* 지식분류코드 */
					,KLD_TXT	/* 지식내용 */
					,TG_ORG_CD	/* 대상기관코드 */
					,AUD_YR	/* 감사년도 */
					,AUD_NO	/* 감사번호 */
					,DSP_RQ_SNO	/* 처분요구순번 */
					,FUNC_SPH_CD	/* 기능분야코드 */
					,CAT_SPH_CD	/* 분류분야코드 */
					,DOC_ID	/* 문서ID */
					,DOC_TYP_CD	/* 문서유형코드 */
					,REGN_OPEN_YN	/* 등록자공개여부 */
					,KLD_STA_CD	/* 지식상태코드 */
					,SRCH_CNT	/* 조회수 */
					,EXPR_DH	/* 만기일시 */
					,ABRG_DH	/* 폐기일시 */
					,RSTR_DH	/* 복구일시 */
					,ABRG_RSN	/* 폐기사유 */
					,REGN_CNB	/* 등록자전산번호 */
					,REGN_DPT_CD	/* 등록자부서코드 */
					,REGN_DPT_NM	/* 등록자부서명 */
					,MTRL_CD	/* 자료코드 */
					,ORI_SEAT_NM	/* 원서위치명 */
					,AUD_KND_CD	/* 감사종류코드 */
					,AUD_SBJ_NM	/* 감사사항명 */
					,KLD_SRC_NM	/* 지식출처명 */
					,KLD_REGI_YR	/* 지식등록년도 */
					,DSP_RQ_NM	/* 처분요구명 */
					,FRT_USR_ID	/* 최초사용자ID */
					,FNL_USR_ID	/* 최종사용자ID */
					,FNL_DEAL_DPT_CD	/* 최종거래부서코드 */
					,FNL_MNU_ID /* 최종메뉴ID */ 
					,FRT_REGI_DH /* 최초등록일시 */
					,FNL_MDF_DH /* 최종수정일시 */
					,CM_PROCESS_STATUS /*공감상태코드*/
					)
				SELECT	'D' AS HST_DVSN_CD
						,(SELECT NVL(MAX(HST_SNO), 0) + 1 FROM TBAEPGKM018H WHERE HST_DH = SYSDATE) AS HST_SNO
						,SYSDATE AS HST_DH
						,KNB
						,KLD_NM
						,KLD_SMM_TXT
						,KYWD_NM_1
						,KYWD_NM_2
						,KYWD_NM_3
						,REGI_RQS_DT
						,PRSV_WAY_CD
						,PRSV_DDLN_DH
						,KLD_CAT_CD
						,KLD_TXT
						,TG_ORG_CD
						,AUD_YR
						,AUD_NO
						,DSP_RQ_SNO
						,FUNC_SPH_CD
						,CAT_SPH_CD
						,DOC_ID
						,DOC_TYP_CD
						,REGN_OPEN_YN
						,KLD_STA_CD
						,SRCH_CNT
						,EXPR_DH
						,ABRG_DH
						,RSTR_DH
						,ABRG_RSN
						,REGN_CNB
						,REGN_DPT_CD
						,REGN_DPT_NM
						,MTRL_CD
						,ORI_SEAT_NM
						,AUD_KND_CD
						,AUD_SBJ_NM
						,KLD_SRC_NM
						,KLD_REGI_YR
						,DSP_RQ_NM
						,FRT_USR_ID
						,FNL_USR_ID
						,FNL_DEAL_DPT_CD
						,FNL_MNU_ID
						,FRT_REGI_DH
						,FNL_MDF_DH
						,CM_PROCESS_STATUS /*공감상태코드*/
				FROM	TBAEPGKM001M AS A
				WHERE	KNB = #KNB#;
				DELETE FROM TBAEPGKM001M
				WHERE KNB = #KNB#;
				DELETE FROM TBAEPGKM004L
				WHERE KNB = #KNB#;
				DELETE FROM TBAEPGKM002L
				WHERE KNB = #KNB#;
		END;
	</delete>
	
</sqlMap>

