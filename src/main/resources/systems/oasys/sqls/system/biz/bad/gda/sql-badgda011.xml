<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/gda/011">

	<!-- 조회-->
	<select id="BADGDA011EMainselect" parameterClass="paramMap" resultClass="resultMap">	
	
         SELECT         
                A.GB         
               ,CASE WHEN A.GB = '1' THEN '범죄및징계'
                     WHEN A.GB = '2' THEN '망실및훼손'
                     WHEN A.GB = '3' THEN '관련법령(계약체결)'
                     WHEN A.GB = '4' THEN '관련법령(국유재산)'                     
                 END                                        AS GB_NM
               ,A.NTF_NO                     
               ,A.KEY1       
               ,A.KEY2       
               ,A.KEY3       
               ,A.KEY4       
               ,A.DPT_CD     
               ,F_DPT_INFO(A.DPT_CD, '1')                   AS DPT_NM
               ,A.ACP_DT     
               ,A.TIT_NM     
               ,A.HNDL_PEN_ID
               ,A.HNDL_PEN_NM
           FROM (
                SELECT T1.NTF_DVSN_CD   AS GB
                      ,F_ORG_INFO(T1.ORG_CD,'1')            || '-' ||  
                       F_CODE_NM('1000202', T1.OGN_DVSN_CD) || '-' || 
                       T1.NNB           AS NTF_NO  
                      ,T1.ORG_CD        AS KEY1
                      ,T1.NTF_DVSN_CD   AS KEY2
                      ,T1.NNB           AS KEY3
                      ,''               AS KEY4
                      ,T1.DPT_CD        AS DPT_CD
                      ,T1.ACP_DT        AS ACP_DT
                      ,T1.TIT_NM        AS TIT_NM
                      ,T1.HNDL_PEN_ID   AS HNDL_PEN_ID
                      ,T1.HNDL_PEN_NM   AS HNDL_PEN_NM
                  FROM TBBADGDA001M T1 /* 통보사항기본 */
                 WHERE 1=1
                   AND T1.ACP_STA_CD  = '71'
                   AND (T1.HNDL_PEN_NM IS NULL OR T1.HNDL_PEN_NM = '')
                
                UNION ALL
                
                SELECT DECODE(T2.LAW_NTF_DVSN_CD,'100','3','4') AS GB
                      ,F_ORG_INFO(T2.ORG_CD,'1') || '-' ||
                       T2.YR                     || '-' ||
                       T2.SRNO                       AS NTF_NO                  
                      ,T2.ORG_CD                     AS KEY1
                      ,T2.YR                         AS KEY2
                      ,TO_CHAR(T2.SRNO)              AS KEY3
                      ,T2.LAW_NTF_DVSN_CD            AS KEY4
                      ,T2.DPT_CD                     AS DPT_CD
                      ,T2.ACP_DT                     AS ACP_DT
                      ,T2.NTF_TIT_NM                 AS TIT_NM
                      ,T2.HNDL_PEN_ID                AS HNDL_PEN_ID
                      ,T2.HNDL_PEN_NM                AS HNDL_PEN_NM
                  FROM TBBADGDA004M T2 /* 관련법령 통지통보 */
                 WHERE 1=1
                   AND T2.ACP_STA_CD  = '71'
                   AND (T2.HNDL_PEN_NM IS NULL OR T2.HNDL_PEN_NM = '')
          ) A
        WHERE 1=1
          AND A.ACP_DT BETWEEN #strAcpDtStr# AND #strAcpDtEnd#
          
	   		AND A.DPT_CD      IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #strDptAuth#, '', #strDptCd#)))
          
        <isNotEmpty property="strDptCd2">
          AND A.DPT_CD      = #strDptCd2#
        </isNotEmpty>    
          
        <isNotEmpty property="strGb">
          AND A.GB = #strGb#
        </isNotEmpty>
        
        ORDER BY A.ACP_DT DESC, NTF_NO 
	</select>


	<!-- 범죄및징계, 손망실 처리자 지정 저장 -->
	<update id="BADGDA011EMainupdate1" parameterClass="paramMap">
           UPDATE TBBADGDA001M                             /* 통보사항기본 */ 
              SET FNL_MDF_DH        = SYSDATE              /* 최종수정일시 */ 
                 ,FNL_USR_ID        = #FNL_USR_ID#         /* 최종사용자ID */       
                 ,FNL_DEAL_DPT_CD   = #FNL_DEAL_DPT_CD#    /* 최종거래부서코드 */
                 ,FNL_MNU_ID        = #FNL_MNU_ID#         /* 최종메뉴ID */
                 ,HNDL_PEN_ID       = #HNDL_PEN_ID#        /* 처리자ID */
                 ,HNDL_PEN_NM       = #HNDL_PEN_NM#        /* 처리자명 */
                 ,TSK_ORD_SRNO      = #TSK_ORD_SRNO#       /* 업무지시일련번호 */
            WHERE ORG_CD            = #KEY1#               /* 기관코드 */ 
              AND NTF_DVSN_CD       = #KEY2#               /* 통보구분코드 */
              AND NNB               = #KEY3#               /* 통보번호 */
	</update>	
		
	<!-- 관련법령 계약체결/국유재산 처리자 지정 -->
	<update id="BADGDA011EMainupdate2" parameterClass="paramMap">
           UPDATE TBBADGDA004M                             /* 관련법령통지통보 */ 
              SET FNL_MDF_DH        = SYSDATE              /* 최종수정일시 */ 
                 ,FNL_USR_ID        = #FNL_USR_ID#         /* 최종사용자ID */       
                 ,FNL_DEAL_DPT_CD   = #FNL_DEAL_DPT_CD#    /* 최종거래부서코드 */
                 ,FNL_MNU_ID        = #FNL_MNU_ID#         /* 최종메뉴ID */
                 ,HNDL_PEN_ID       = #HNDL_PEN_ID#        /* 처리자ID */  
                 ,HNDL_PEN_NM       = #HNDL_PEN_NM#        /* 처리자명 */
                 ,TSK_ORD_SRNO      = #TSK_ORD_SRNO#       /* 업무지시일련번호 */                 
            WHERE ORG_CD            = #KEY1#               /* 기관코드 */ 
              AND YR                = #KEY2#               /* 년도 */
              AND SRNO              = #KEY3#               /* 일련번호 */
              AND LAW_NTF_DVSN_CD   = #KEY4#               /* 법령통보구분코드 */
	</update>			
		
		
	<select id="BADGDA011EOrderListMaxSeq" parameterClass="paramMap" resultClass="java.lang.String">
		SELECT NVL(MAX(SEQ),0) + 1  AS SEQ
		  FROM PTL_ORDER_LIST 
	</select>		
		
		
	<!-- 나의할일(업무지시사항) 저장  -->
	<insert id="BADGDA011EOrderListinsert" parameterClass="paramMap">
		INSERT INTO PTL_ORDER_LIST
		(
			  SEQ
			, TITLE
			, CONTENT
			, CRT_DT
			, CRT_USER_ID
			, IMP_YN
			, MSN_YN
			, ORDER_TYPE_CD
		)
		VALUES
		(
			  #SEQ#
			, #TITLE#
			, #CONTENT#
			, TO_CHAR(SYSDATE,'yyyymmddhh24miss')
			, #CRT_USER_ID#
			, #IMP_YN#
			, #MSN_YN#
			, #ORDER_TYPE_CD# 
		)
	</insert>
	
	<!-- 나의할일(업무지시알림목록) 저장  -->
	<insert id="BADGDA011EOrderNotiinsert" parameterClass="paramMap">
		INSERT INTO PTL_ORDER_NOTI
		(
			  SEQ
			, NOTI_SEQ
			, USER_ID
			, TITLE
			, CRT_DT
			, IMP_YN
			)
			VALUES
			(
			  #SEQ#
			, (SELECT NVL(MAX(NOTI_SEQ),0)+1 
			     FROM PTL_ORDER_NOTI
		        WHERE SEQ = #SEQ# )
			, #USER_ID#
			, #TITLE#
			, TO_CHAR(SYSDATE,'yyyymmddhh24miss')
			, 'N'
			)

	</insert>	
	
	<!-- 나의할일(업무지시사항수신자목록) 저장  -->	
	<insert id="BADGDA011EOrderReceiveListinsert" parameterClass="paramMap">
		INSERT INTO PTL_ORDER_RECEIVE_LIST
		(
			  SEQ
			, USER_ID
			, CRE_DT
			, COMP_DT
			, SRT_NO /* 2016.12.31 */
		)
		VALUES
		(
			  #SEQ#
			, #USER_ID#
			, TO_CHAR(SYSDATE,'yyyymmddhh24miss')
			, TO_CHAR(SYSDATE,'yyyymmddhh24miss')
			, 1
		)
	</insert>	
			
			
	<!-- 메신저 push 대상 추가 -->	
	<insert id="BADGDA011EPushinsert" parameterClass="paramMap">
			INSERT INTO TBDCMACM026L
			(
				  MSG_SNO
				, TSK_CAT_CD
				, FUNC_CAT_CD
				, SEND_ID
		        , MSG_TP_YN
		        , MSG_TXT_2
		        , RCNT_CNT
		        , RCNT_HIS
		        , MSG_REGI_DH
				, FRT_USR_ID
				, FNL_USR_ID
				, FNL_DEAL_DPT_CD
				, FNL_MNU_ID
				, FRT_REGI_DH
				, FNL_MDF_DH
			)
			VALUES
			(
				  (SELECT NVL(MAX(MSG_SNO),'0')+1 AS MSG_SNO 
				     FROM TBDCMACM026L)
				, #TSK_CAT_CD#
				, #FUNC_CAT_CD#
				, #SEND_ID#
		        , #MSG_TP_YN#
		        , #MSG_TXT_2#
		        , #RCNT_CNT#
		        , #RCNT_HIS#
		        , SYSDATE
				, #FRT_USR_ID#
				, #FNL_USR_ID#
				, #FNL_DEAL_DPT_CD#
				, #FNL_MNU_ID#
				, SYSDATE
				, SYSDATE
			)
	</insert>			
</sqlMap> 
