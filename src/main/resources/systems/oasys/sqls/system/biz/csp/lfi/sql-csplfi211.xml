<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/lfi/211">
	
	<select id="CSPLFI211EMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	*
			  FROM 	TBCSPLFI101M A
			 WHERE	1=1
			   AND	A.ALW_DVSN_CD = #ALW_DVSN_CD#
			 ORDER BY ALW_DVSN_CD, ALW_OCP_CD, ALW_RANK_CD, ALW_PST_CD
		]]>
	</select>
	
	
	<delete id="CSPLFI211EDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE FROM TBCSPLFI101M
			WHERE 1=1
			  AND ALW_DVSN_CD = #ALW_DVSN_CD#
			  AND ALW_OCP_CD = #ALW_OCP_CD#
			  AND ALW_RANK_CD = #ALW_RANK_CD#
			  AND ALW_PST_CD = #ALW_PST_CD#
		]]>
	</delete>
	
	<update id="CSPLFI211EUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPLFI101M
			   SET 	ACTV_DPT_AM = NVL(#ACTV_DPT_AM#, 0),
					SPRT_DPT_AM = NVL(#SPRT_DPT_AM#, 0),
					ETC_DPT_AM = NVL(#ETC_DPT_AM#, 0),
					STD_PRN_AMT = NVL(#STD_PRN_AMT#, 0),
					FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE
			 WHERE 	1=1
			   AND 	ALW_DVSN_CD = #ALW_DVSN_CD#
			   AND 	ALW_OCP_CD = #ALW_OCP_CD#
			   AND 	ALW_RANK_CD = #ALW_RANK_CD#
			   AND 	ALW_PST_CD = #ALW_PST_CD#
		]]>	
	</update>
	
	<insert id="CSPLFI211EInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPLFI101M
			(
				ALW_DVSN_CD,
				ALW_OCP_CD,
				ALW_RANK_CD,
				ALW_PST_CD,
				ACTV_DPT_AM,
				SPRT_DPT_AM,
				ETC_DPT_AM,
				STD_PRN_AMT,
				FRT_USR_ID,
				FNL_USR_ID,
				FNL_DEAL_DPT_CD,
				FNL_MNU_ID,
				FRT_REGI_DH,
				FNL_MDF_DH
			)
			VALUES
			(
				#ALW_DVSN_CD#,
				#ALW_OCP_CD#,
				#ALW_RANK_CD#,
				#ALW_PST_CD#,
				#ACTV_DPT_AM#,
				#SPRT_DPT_AM#,
				#ETC_DPT_AM#,
				#STD_PRN_AMT#,
				#FRT_USR_ID#,
				#FNL_USR_ID#,
				#FNL_DEAL_DPT_CD#,
				#FNL_MNU_ID#,
				SYSDATE,
				SYSDATE
			)
		]]>
	</insert>
	
	<select id="CSPLFI211ECheckSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	COUNT(*) AS CNT, 
			        ALW_DVSN_CD, 
			        ALW_OCP_CD, 
			        ALW_RANK_CD,
			        ALW_PST_CD
			  FROM 	TBCSPLFI101M A
			 WHERE	1=1
			   AND	A.ALW_DVSN_CD = #ALW_DVSN_CD#
			   AND	A.ALW_OCP_CD = #ALW_OCP_CD#
			   AND	A.ALW_RANK_CD = #ALW_RANK_CD#
			   AND	A.ALW_PST_CD = #ALW_PST_CD#
		     GROUP BY ALW_DVSN_CD, ALW_OCP_CD, ALW_RANK_CD, ALW_PST_CD;
		]]>
	</select>
	
<!-- 부서관리 -->

	<select id="CSPLFI221EMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT DPT_CD, DPT_NM, IMD_CD
			  FROM TBDCMACM002M
			  WHERE USE_YN ='Y'
			   AND ( IMD_CD <> 'E' OR IMD_CD IS NULL )
		]]>	  
		<dynamic>
			<isNotEmpty property="IMD_CD">
			  AND IMD_CD LIKE #IMD_CD#
			</isNotEmpty>
		</dynamic>
		<![CDATA[
			  ORDER BY DPT_CD ASC
		]]>
	</select>
	
	<update id="CSPLFI221EUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBDCMACM002M
			   SET 	IMD_CD = #IMD_CD#,
				    FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE
			 WHERE DPT_CD = #DPT_CD#
		]]>
	</update>
	
	<select id="CSPLFI231QSelectYy" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT YYYY AS CD, 
			       YYYY AS CDNM 
			  FROM (
			        SELECT TO_CHAR(SYSDATE,'YYYY') - LEVEL + 2 YYYY 
			          FROM DUAL 
			        CONNECT BY TO_CHAR(SYSDATE,'YYYY') - LEVEL + 2 >= 1980
			       )
		]]>
	</select>
	
	<select id="CSPLFI231QSelectAlwDvsnCd" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT CD, CD_NM FROM TBDCMACM013C 
			WHERE	CMM_CD_DVSN_CD = '1000145' 
			AND	CD != '000000000' 
			ORDER BY USR_DFN_TXT_2
		]]>
	</select>
	
	
	<!-- 변동자만 조회 -->
	<select id="CSPLFI231QMainSelect1" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[ 
			/* 수당변동자만 조회 (지급년월 없음) */
				SELECT  A.ALW_DVSN_CD,
						D.DPT_CD,
						D.DPT_NM,
						A.CNB,
						C.USR_NAM,
						C.RANK_CD,
						C.PS_CD,
						F_CODE_NM('1000173', C.RANK_CD) || '-' ||F_CODE_NM('1000177', C.PS_CD) AS RANK_PS_NM,
						C.PST_CD,
						F_CODE_NM('1000176', C.PST_CD) AS PST_NM,
						NVL(A.ALW_AM, 0) AS ALW_AM,
						NVL(B.PMT_AM, 0) AS PMT_AM,
						A.FIX_YN,
						B.PMT_YM,
						B.PMT_DT
				  FROM 	TBCSPLFI102M A, 
				   		TBCSPLFI104L B,					   	
				        TBDCMACM001M C, 
					   	TBDCMACM002M D,
						TBDCMACM013C E
				 WHERE	1=1
				   AND	A.CNB = B.CNB
				   AND 	A.ALW_DVSN_CD = B.ALW_DVSN_CD
				   AND	A.CNB = C.CNB
				   AND	B.CNB = C.CNB
				   AND	C.DPT_CD = D.DPT_CD
				   AND 	C.BAI_USR_YN = 'Y'
				   AND	D.DPT_CD != '880880'
				   AND	E.CMM_CD_DVSN_CD = '1000145'
				   AND	A.ALW_DVSN_CD = E.CD
				   AND	A.ALW_AM != B.PMT_AM
				   AND	B.PMT_YM = (SELECT MAX(PMT_YM) FROM TBCSPLFI104L WHERE ALW_DVSN_CD IN ('9991','9992','9993','9994','9995')) 
		]]>
			<dynamic>
				<isNotEmpty property="cd">
					AND	A.ALW_DVSN_CD IN
			  	( SELECT SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
			                                        FROM DUAL A
			                                       CROSS JOIN(SELECT ','|| #cd# ||',' AS CODE FROM DUAL) B
			                                       CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
				</isNotEmpty>	
				<isNotEmpty property="cnb">
				   AND 	A.CNB = #cnb#
				</isNotEmpty>
				<isNotEmpty property="dptCd">
				   AND	C.DPT_CD LIKE (SELECT CASE WHEN SUBSTR(#dptCd#, 4, 3) = '000' THEN SUBSTR(#dptCd#, 0, 3) || '%'
				                              ELSE #dptCd# END FROM DUAL)
				</isNotEmpty>
				<isNotEmpty property="fixYn">
				   AND	A.FIX_YN = #fixYn#
				</isNotEmpty>
			</dynamic>
	</select>
	
	
	<!-- 기본 조회 -->
	<select id="CSPLFI231QMainSelect2" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[ 
			/* 수당테이블 조회 */
			SELECT    D1.ALW_DVSN_CD
			        , D3.DPT_CD
			        , D3.DPT_NM
			        , D1.CNB
			        , D2.USR_NAM
			        , D2.RANK_CD
			        , D5.CD_NM || '-' || D6.CD_NM AS RANK_PS_NM
			        , D2.PS_CD
			        , D7.CD_NM AS PST_NM
			        , D2.PST_CD
			        , NVL(D1.ALW_AM, 0) AS ALW_AM
			        , D1.FIX_YN
			        , D8.USR_DFN_TXT_2
			        , '' AS PMT_YM
			        , '' AS PMT_DT
			FROM    TBCSPLFI102M D1
			        , TBDCMACM001M D2
			        , TBDCMACM002M D3
			        , ( SELECT D4.CD, D4.CD_NM FROM TBDCMACM013C D4 WHERE D4.CMM_CD_DVSN_CD = '1000173' ) D5
			        , ( SELECT D4.CD, D4.CD_NM FROM TBDCMACM013C D4 WHERE D4.CMM_CD_DVSN_CD = '1000177' ) D6
			        , ( SELECT D4.CD, D4.CD_NM FROM TBDCMACM013C D4 WHERE D4.CMM_CD_DVSN_CD = '1000176' ) D7
			        , ( SELECT D4.CD, D4.CD_NM, D4.USR_DFN_TXT_2 FROM TBDCMACM013C D4 WHERE D4.CMM_CD_DVSN_CD = '1000145' ) D8
			WHERE    D1.CNB = D2.CNB
			AND        D2.DPT_CD = D3.DPT_CD
			AND        D1.ALW_DVSN_CD = D8.CD
			AND        D2.RANK_CD = D5.CD(+)
			AND        D2.PS_CD = D6.CD(+)
			AND        D2.PST_CD = D7.CD(+)
			AND        D3.DPT_CD != '880880'
			AND        D2.BAI_USR_YN = 'Y'
		]]>
		<isNotEmpty property="cd">
			AND	D1.ALW_DVSN_CD IN
			  	( SELECT SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
			                                        FROM DUAL A
			                                       CROSS JOIN(SELECT ','|| #cd# ||',' AS CODE FROM DUAL) B
			                                       CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
		</isNotEmpty>	
		<isNotEmpty property="cnb">
		   AND 	D1.CNB = #cnb#
		</isNotEmpty>
		<isNotEmpty property="dptCd">
		   AND	D2.DPT_CD LIKE (SELECT CASE WHEN SUBSTR(#dptCd#, 4, 3) = '000' THEN SUBSTR(#dptCd#, 0, 3) || '%'
		                              ELSE #dptCd# END FROM DUAL)
		</isNotEmpty>
		<isNotEmpty property="fixYn">
		   AND	D1.FIX_YN = #fixYn#
		</isNotEmpty>
		<![CDATA[
			ORDER BY CNB, D8.USR_DFN_TXT_2
		]]>
	</select>
	
	<select id="CSPLFI231QMainSelect3" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[	   
			SELECT   TMP.*
			       , TMP.ALW_RANK_CD AS RANK_CD
			       , DECODE(TMP.ALW_PS_CD, NULL, (
			                                        SELECT PS_CD
			                                          FROM TBDCMACM037H
			                                         WHERE CNB = TMP.CNB
			                                           AND FNL_MDF_DH = TMP.FNL_MDF_DH
			                                     ), TMP.ALW_PS_CD
			       ) AS PS_CD
			       , F_CODE_NM('1000173', TMP.ALW_RANK_CD) || '-' || 
			          F_CODE_NM('1000177', DECODE(TMP.ALW_PS_CD, NULL, (
			                                                              SELECT PS_CD
			                                                                FROM TBDCMACM037H
			                                                               WHERE CNB = TMP.CNB
			                                                                 AND FNL_MDF_DH = TMP.FNL_MDF_DH
			                                                           ), TMP.ALW_PS_CD
			                                     )
			
			          ) AS RANK_PS_NM
			          
			  FROM (
			            SELECT   A.ALW_DVSN_CD
			                   , A.DPT_CD
			                   , C.DPT_NM
			                   , A.CNB
			                   , B.USR_NAM
			                   , A.ALW_RANK_CD
			                   , (
			                        SELECT MAX(FNL_MDF_DH)
			                          FROM TBDCMACM037H
			                         WHERE CON_NO > 0
			                           AND CNB = A.CNB
			                           AND A.PMT_DT >= TO_CHAR(FNL_MDF_DH, 'YYYYMMDD')
			                     ) AS FNL_MDF_DH
			                   , A.ALW_PST_CD AS PST_CD
			                   , F_CODE_NM('1000176', A.ALW_PST_CD) AS PST_NM
			                   , NVL(A.PMT_AM, 0) AS ALW_AM
			                   , '' AS FIX_YN
			                   , A.PMT_YM
			                   , A.PMT_DT
			                   , D.USR_DFN_TXT_2
			                   , A.ALW_PS_CD
			              FROM TBCSPLFI104L A, 
			                   TBDCMACM001M B, 
			                   TBDCMACM002M C,
			                   TBDCMACM013C D
			             WHERE 1 = 1
			               AND A.CNB = B.CNB
			               AND A.DPT_CD = C.DPT_CD
			               AND B.BAI_USR_YN = 'Y'
			               AND D.CMM_CD_DVSN_CD = '1000145'
			               AND A.ALW_DVSN_CD = D.CD
			               AND A.PMT_YM = substring(#yyyymm#, 1, 6)
			) TMP
			 WHERE 1 = 1
		]]>
		<dynamic>
			<isNotEmpty property="cd">
				AND	TMP.ALW_DVSN_CD IN 
			  	( SELECT SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
			                                        FROM DUAL A
			                                       CROSS JOIN(SELECT ','|| #cd# ||',' AS CODE FROM DUAL) B
			                                       CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
			</isNotEmpty>	
			<isNotEmpty property="cnb">
			   AND 	TMP.CNB = #cnb#
			</isNotEmpty>
			<isNotEmpty property="dptCd">
			   AND	TMP.DPT_CD LIKE (SELECT CASE WHEN SUBSTR(#dptCd#, 4, 3) = '000' THEN SUBSTR(#dptCd#, 0, 3) || '%'
			                              ELSE #dptCd# END FROM DUAL)
			</isNotEmpty>
		</dynamic>
		<![CDATA[
			ORDER BY TMP.CNB, TMP.USR_DFN_TXT_2
		]]>
		
	</select>
	
	<update id="CSPLFI231QUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPLFI102M
			   SET 	FIX_YN = #FIX_YN#,
				    FNL_USR_ID = #FNL_USR_ID#,
					FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					FNL_MNU_ID = #FNL_MNU_ID#,
					FNL_MDF_DH = SYSDATE
			 WHERE	ALW_DVSN_CD = #ALW_DVSN_CD#
			   AND 	CNB = #CNB#
		]]>
	</update>
	
	<update id="CSPLFI231QAllFixUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPLFI102M
			   SET	FIX_YN = #fix#
			 WHERE	1=1
		]]>
			<dynamic>
				<isNotEmpty property="cd">
				   AND	ALW_DVSN_CD IN 
				  	( SELECT SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
				                                        FROM DUAL A
				                                       CROSS JOIN(SELECT ','|| #cd# ||',' AS CODE FROM DUAL) B
				                                       CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
				</isNotEmpty>
				<isNotEmpty property="fixYn">
			   AND	FIX_YN = #fixYn#
			   	</isNotEmpty>
			   	<isNotEmpty property="dptCd">
			   AND	CNB IN (SELECT CNB 
					           FROM TBDCMACM001M 
					          WHERE DPT_CD LIKE(SELECT CASE WHEN SUBSTR(#dptCd#, 4, 3) = '000' 
					                                        THEN SUBSTR(#dptCd#, 0, 3) || '%'
										                    ELSE #dptCd# END FROM DUAL)
					            AND CNB NOT LIKE '8%'
					            AND CNB NOT LIKE '9%')
				</isNotEmpty>
				<isNotEmpty property="cnb">
			   AND 	CNB = #cnb#
			   	</isNotEmpty>
			</dynamic>
		<![CDATA[
		]]>
	</update>
	
	<select id="CSPLFI231QSelectExcelExport" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT 	(SELECT CD_NM FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000166' AND CD = B.BNK_CD) AS BNK_CD,
					B.EAN AS EAN,
					(SELECT CD_NM FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000145' AND CD = A.ALW_DVSN_CD) AS ALW_DVSN_CD,
					A.ALW_AM,
					A.CNB,
					F_DPT_INFO(SUBSTR(C.DPT_CD, 0,3)||'000', 1) AS BRU,
					F_DPT_INFO(C.DPT_CD, 1) AS DPT_NM,
					C.USR_NAM,
					F_CODE_NM('1000173', C.RANK_CD) AS RANKCD,
					F_CODE_NM('1000176', C.PST_CD) AS PSTCD
			  FROM 	TBCSPLFI102M A, TBCSPLFI103M B, TBDCMACM001M C
			 WHERE	1=1
			   AND 	A.CNB = C.CNB
			   AND	A.CNB = B.CNB
			   AND	C.BAI_USR_YN <> 'N'
			   AND	C.DPT_CD <> '880880'
			   AND	A.ALW_AM IS NOT NULL
			   AND	A.ALW_AM <> 0
		]]>
			<dynamic>
				<isNotEmpty property="cd">
			   AND 	A.ALW_DVSN_CD IN ( SELECT SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
				                                        FROM DUAL A
				                                       CROSS JOIN(SELECT ','|| #cd# ||',' AS CODE FROM DUAL) B
					                                       CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
				</isNotEmpty>
			</dynamic>
		<![CDATA[
			 ORDER	BY B.BNK_CD, A.ALW_DVSN_CD, A.CNB
		]]>
	</select>
	
	<delete id="CSPLFI231QAmSetDelete" parameterClass="paramMap">
	<![CDATA[
			DELETE FROM TBCSPLFI104L 
			WHERE PMT_YM = substring(#yyyymm#,1,6)
	]]>
	<isNotEmpty property="cd">
			AND 	ALW_DVSN_CD IN ( SELECT SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
				                                        FROM DUAL A
				                                       CROSS JOIN(SELECT ','|| #cd# ||',' AS CODE FROM DUAL) B
					                                       CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
					                                       </isNotEmpty>
	</delete>
	
	<insert id="CSPLFI231QAmSetInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPLFI104L 
			(
				PMT_YM,
				ALW_DVSN_CD,
				CNB,
				DPT_CD,
				ALW_OCP_CD,
				ALW_RANK_CD,
				ALW_PST_CD,
				PMT_AM,
				PMT_DT,
				FRT_USR_ID,
				FNL_USR_ID,
				FNL_DEAL_DPT_CD,
				FNL_MNU_ID,
				FRT_REGI_DH,
				FNL_MDF_DH
			   ,ALW_PS_CD                                    /*호봉코드 추가 - 2019.12.03 les*/
			)
			(
			SELECT 	substring(#yyyymm#,1,6) AS PMT_YM,
			       	A.ALW_DVSN_CD,
			       	A.CNB,
			       	B.DPT_CD,
			       	B.OCP_CD,                                /*직종코드 추가 - 2019.12.03 les*/
			       	B.RANK_CD,
			       	NVL(PST_CD, '') AS PST_CD,
			       	A.ALW_AM,
			       	TO_CHAR(SYSDATE, 'YYYYMMDD') AS PMT_DT,
					#FRT_USR_ID#,
					#FNL_USR_ID#,
					#FNL_DEAL_DPT_CD#,
					#FNL_MNU_ID#,
					SYSDATE,
					SYSDATE
				   ,B.PS_CD                                  /*호봉코드 추가 - 2019.12.03 les*/
			  FROM 	TBCSPLFI102M A, TBDCMACM001M B
			 WHERE 	A.CNB = B.CNB
			   AND 	A.ALW_AM <> 0
			   AND 	B.DPT_CD <> '880880'
			   AND 	(B.RSG_DT IS NULL OR B.RSG_DT = '')
			   ]]>
			   <isNotEmpty property="cd">
			   AND 	A.ALW_DVSN_CD IN ( SELECT SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
				                                        FROM DUAL A
				                                       CROSS JOIN(SELECT ','|| #cd# ||',' AS CODE FROM DUAL) B
					                                       CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
			  </isNotEmpty>
			  <![CDATA[
			)
		]]>
	</insert>
	
	<insert id="CSPLFI231QInsertAuotCalc1" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPLFI102M
						(
							 ALW_DVSN_CD
							,CNB
							,ALW_AM
							,FIX_YN
							,FRT_USR_ID
							,FNL_USR_ID
							,FNL_DEAL_DPT_CD
							,FNL_MNU_ID
							,FRT_REGI_DH
							,FNL_MDF_DH
						)
						SELECT	#cd#
								,A.CNB
								,0
								,'N'
								,#FRT_USR_ID#
								,#FNL_USR_ID#
								,#FNL_DEAL_DPT_CD#
								,#FNL_MNU_ID#
								,SYSDATE
								,SYSDATE
						  FROM 	TBDCMACM001M A
						 WHERE	1=1
						   AND	A.BAI_USR_YN <> 'N'
						   AND	A.USR_ID NOT LIKE 'test%'
						   AND	A.CNB NOT LIKE '8%' 
						   AND	A.CNB NOT LIKE '9%'
						   AND	A.CNB NOT IN (SELECT CNB FROM TBCSPLFI102M WHERE ALW_DVSN_CD = #cd#)
						   AND 	A.RQS_STA_CD = '3'
   						   AND	A.DPT_CD != '880880'
		]]>
	</insert>
	
	<update id="CSPLFI231QUpdateAuotCalc1" parameterClass="paramMap">
	<![CDATA[
		UPDATE	TBCSPLFI102M D100
		SET		D100.ALW_AM = (
							SELECT	(
										CASE
											WHEN ( 
													SELECT 	COUNT(1) 
													FROM	TBCSPLFI101M S1
													WHERE 	ALW_DVSN_CD = #cd#
													AND		S1.ALW_OCP_CD = D1.OCP_CD
													AND		S1.ALW_RANK_CD = D1.RANK_SRT_SEQ_NM
													AND		S1.ALW_PST_CD = D1.INN_RANK_CD
												) = 1
											THEN ( 
													SELECT 	(
																CASE D2.IMD_CD  
																	WHEN 'E' THEN 0
													       			WHEN 'Y' THEN S1.ACTV_DPT_AM
													       			WHEN 'N' THEN S1.SPRT_DPT_AM 
													       			WHEN 'S' THEN S1.STD_PRN_AMT
													       			ELSE S1.ETC_DPT_AM
														       	END
															)
													FROM	TBCSPLFI101M S1
													WHERE 	S1.ALW_DVSN_CD = #cd#
													AND		S1.ALW_OCP_CD = D1.OCP_CD
													AND		S1.ALW_RANK_CD = D1.RANK_SRT_SEQ_NM
													AND		S1.ALW_PST_CD = D1.INN_RANK_CD
												)
											ELSE (	
													SELECT 	(
																CASE D2.IMD_CD  
																	WHEN 'E' THEN 0
													       			WHEN 'Y' THEN S1.ACTV_DPT_AM
													       			WHEN 'N' THEN S1.SPRT_DPT_AM 
													       			WHEN 'S' THEN S1.STD_PRN_AMT
													       			ELSE S1.ETC_DPT_AM
														       	END
															)
													FROM	TBCSPLFI101M S1
													WHERE 	ALW_DVSN_CD = #cd#
													AND		S1.ALW_OCP_CD = D1.OCP_CD
													AND		S1.ALW_RANK_CD = D1.RANK_SRT_SEQ_NM
													AND		S1.ALW_PST_CD = '99'
											)
										END
									) AS ALW_AM
							FROM	TBDCMACM001M D1
									, TBDCMACM002M D2
							WHERE	D1.DPT_CD = D2.DPT_CD
							AND		D1.CNB = D100.CNB
						),
				D100.FNL_USR_ID = #FNL_USR_ID#,
				D100.FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
				D100.FNL_MNU_ID = #FNL_MNU_ID#,
				D100.FNL_MDF_DH = SYSDATE
		WHERE	D100.ALW_DVSN_CD = #cd#
		AND		D100.CNB IN (
					SELECT	D1.CNB
					FROM	TBDCMACM001M D1
							, TBDCMACM002M D2
					WHERE	D1.DPT_CD = D2.DPT_CD
					AND		D2.USE_YN = 'Y'
					AND		D1.DPT_CD != '880880'
					AND 	(D1.RSG_DT IS NULL OR D1.RSG_DT = '')
					AND 	D1.WOK_DVSN_CD IN ('AAA', 'AAB')
					AND		D1.CNB IN (
								SELECT	CNB
								FROM	TBCSPLFI102M
								WHERE	ALW_DVSN_CD = #cd#
								AND		FIX_YN <> 'F'
							)
				)
	]]>
	</update>
	
	<!-- <update id="CSPLFI231QUpdateAuotCalc1" parameterClass="paramMap">
		<![CDATA[
			UPDATE    TBCSPLFI102M D1
			   SET    D1.ALW_AM = (
					                SELECT    (CASE A.IMD_CD  WHEN 'E' THEN  0
					                           WHEN 'Y' THEN A.ACTV_DPT_AM
					                           WHEN 'N' THEN A.SPRT_DPT_AM 
					                           WHEN 'S' THEN A.STD_PRN_AMT
					                           ELSE A.ETC_DPT_AM END ) AS ALW_AM
					                FROM (
					                        SELECT A.CNB, 
					                             C.IMD_CD, 
					                             A.DPT_CD, 
					                             A.USR_NAM,
					                             B.ACTV_DPT_AM, 
					                             B.SPRT_DPT_AM, 
					                             B.ETC_DPT_AM, 
					                             B.STD_PRN_AMT,
					                             A.RSG_DT,
					                             A.WOK_DVSN_CD
					                        FROM TBDCMACM001M A, TBCSPLFI101M B, TBDCMACM002M C
					                       WHERE A.DPT_CD = C.DPT_CD
					                         AND C.USE_YN <> 'N'
					                         AND B.ALW_DVSN_CD = #cd#
					                         AND  (B.ALW_OCP_CD = '99' OR A.OCP_CD  =  B.ALW_OCP_CD) 
					                         AND  (ALW_RANK_CD = '99' OR A.RANK_SRT_SEQ_NM =  B.ALW_RANK_CD)
					                         AND  (ALW_PST_CD = '99' OR A.INN_RANK_CD  =  B.ALW_PST_CD)
					                      ) A,
					                      TBCSPLFI102M B
					                WHERE B.ALW_DVSN_CD = #cd#
					                  AND A.CNB = B.CNB
					                  AND B.FIX_YN <> 'F'
					                  AND A.DPT_CD <> '880880'                 
					                  AND (A.RSG_DT IS NULL OR A.RSG_DT = '')
					                  AND A.WOK_DVSN_CD IN ('AAA', 'AAB')
					                  AND B.CNB = D1.CNB
					                  AND B.ALW_DVSN_CD = D1.ALW_DVSN_CD
					                    ),
						D1.FNL_USR_ID = #FNL_USR_ID#,
						D1.FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
						D1.FNL_MNU_ID = #FNL_MNU_ID#,
						D1.FNL_MDF_DH = SYSDATE
			WHERE    ( D1.ALW_DVSN_CD , D1.CNB ) IN ( 
									                SELECT    B.ALW_DVSN_CD
									                        , B.CNB
									                FROM (
									                        SELECT A.CNB, 
									                             C.IMD_CD, 
									                             A.DPT_CD, 
									                             A.USR_NAM,
									                             B.ACTV_DPT_AM, 
									                               B.SPRT_DPT_AM, 
									                             B.ETC_DPT_AM, 
									                             B.STD_PRN_AMT,
									                             A.RSG_DT,
									                             A.WOK_DVSN_CD
									                        FROM TBDCMACM001M A, TBCSPLFI101M B, TBDCMACM002M C
									                       WHERE A.DPT_CD = C.DPT_CD
									                         AND C.USE_YN <> 'N'
									                         AND B.ALW_DVSN_CD = #cd#
									                         AND  (B.ALW_OCP_CD = '99' OR A.OCP_CD  =  B.ALW_OCP_CD) 
									                         AND  (ALW_RANK_CD = '99' OR A.RANK_SRT_SEQ_NM =  B.ALW_RANK_CD)
									                         AND  (ALW_PST_CD = '99' OR A.INN_RANK_CD  =  B.ALW_PST_CD)
									                      ) A,
									                      TBCSPLFI102M B
									                WHERE B.ALW_DVSN_CD = #cd#
									                  AND A.CNB = B.CNB
									                  AND B.FIX_YN <> 'F'
									                  AND A.DPT_CD <> '880880'                 
									                  AND (A.RSG_DT IS NULL OR A.RSG_DT = '')
									                  AND A.WOK_DVSN_CD IN ('AAA', 'AAB')
									                )
		]]>	
	</update> -->
	
	
	<update id="CSPLFI231QUpdateAuotCalc0" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBCSPLFI102M
			   SET ALW_AM = 0,
				   FNL_USR_ID = #FNL_USR_ID#,
				   FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
				   FNL_MNU_ID = #FNL_MNU_ID#,
				   FNL_MDF_DH = SYSDATE
			 WHERE 1=1
			   AND CNB IN (SELECT CNB FROM TBDCMACM001M WHERE WOK_DVSN_CD NOT IN ('AAA','AAB'))
			   AND FIX_YN <> 'F'
			   /* 휴직복귀 후 고정상태에 수당 입력했는데도 수당금액이 0원처리되어 추가함 
			   	WOK_DVSN_CD
			   	AAA	재직
				ABA	휴직
				ABB	휴직
				DAA	퇴직
				DAB	전출
				AAB	재직(파견)
				BAB	파견(전입)
				*/
		]]>	
	</update>
	
	<select id="CSPLFI232EUserInfoSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT 	A.USR_NAM,
			 		A.CNB, 
			 		A.DPT_CD, 
			 		B.DPT_NM,
			 		F_CODE_NM('1000176', A.PST_CD) AS PST_NM, /* 직위 */
			 		F_CODE_NM('1000173', A.RANK_CD) AS RANK_NM, /* 직급 */
			 		F_CODE_NM('1000177', A.PS_CD) AS PS_NM,
			 		F_CODE_NM('1000173', A.RANK_CD) || ' - ' ||F_CODE_NM('1000177', A.PS_CD) AS RANK_PS_NM
			  FROM 	TBDCMACM001M A,
			  		TBDCMACM002M B
			 WHERE 	1=1
			   AND 	A.DPT_CD = B.DPT_CD
			   AND	A.CNB = #cnb#
		]]>
	</select>
	
	<select id="CSPLFI232EBankInfoSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT 	BNK_CD, 
					F_CODE_NM('1000166', BNK_CD) AS BNK_NM,
					EAN, 
					DEPSTR_NM
			  FROM	TBCSPLFI103M
			 WHERE	CNB = #cnb#
		]]>
	</select>
	
	<select id="CSPLFI232EMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT A.CD AS ALW_DVSN_CD,
					#cnb# as CNB,
					NVL(B.ALW_AM, 0) AS ALW_AM,
					NVL(B.FIX_YN, 'N') AS FIX_YN
			FROM
				(
					 SELECT CD, CD_NM,USR_DFN_TXT_2
					   FROM TBDCMACM013C
					  WHERE CMM_CD_DVSN_CD = '1000145'
					    AND CD!= '000000000'
				)A,
				(
					SELECT 	
							ALW_DVSN_CD,
							CNB,
							NVL(ALW_AM, 0) AS ALW_AM,
							FIX_YN
					  FROM 	TBCSPLFI102M
					 WHERE 	CNB = #cnb#
				 )B
			  WHERE 1=1
			    AND A.CD = B.ALW_DVSN_CD(+)
			  ORDER BY A.USR_DFN_TXT_2
		]]>
	</select>
	
	<delete id="CSPLFI231EBankDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE FROM TBCSPLFI103M
			WHERE 1=1
			  AND CNB = #cnb#
		]]>
	</delete>
	
	<delete id="CSPLFI232EAlwDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE FROM TBCSPLFI102M
			WHERE 1=1
			  AND CNB = #CNB#
			  AND ALW_DVSN_CD = #ALW_DVSN_CD#
		]]>
	</delete>
	
	
	<update id="CSPLFI232EAlwUpdate" parameterClass="paramMap">
		<![CDATA[
			MERGE INTO TBCSPLFI102M A
			USING ( select #CNB# AS CNB, #ALW_DVSN_CD# AS ALW_DVSN_CD from DUAL ) B
			ON (A.CNB = B.CNB AND A.ALW_DVSN_CD = B.ALW_DVSN_CD)
			WHEN MATCHED THEN 
			UPDATE 
			   SET	A.ALW_AM = #ALW_AM#,
			   		A.FIX_YN = #FIX_YN#,
			   		A.FNL_USR_ID = #FNL_USR_ID#,
					A.FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					A.FNL_MNU_ID = #FNL_MNU_ID#,
					A.FNL_MDF_DH = SYSDATE
			 WHERE	1=1
			   AND	A.ALW_DVSN_CD = #ALW_DVSN_CD#
			   AND	A.CNB = #CNB#
			   WHEN NOT MATCHED THEN
			INSERT 
			(
				A.ALW_DVSN_CD
				,A.CNB 
				,A.ALW_AM
				,A.FIX_YN
				,A.FRT_USR_ID
				,A.FNL_USR_ID
				,A.FNL_DEAL_DPT_CD
				,A.FNL_MNU_ID
				,A.FRT_REGI_DH
				,A.FNL_MDF_DH
			)
			VALUES
			(
				#ALW_DVSN_CD#
				,#CNB#
				,#ALW_AM#
				,#FIX_YN#
				,#FRT_USR_ID#
				,#FNL_USR_ID#
				,#FNL_DEAL_DPT_CD#
				,#FNL_MNU_ID#
				,SYSDATE
				,SYSDATE
			)
		]]>	
	</update>
	
	<insert id="CSPLFI232EAlwInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPLFI102M
			(
				ALW_DVSN_CD
				,CNB
				,ALW_AM
				,FIX_YN
				,FRT_USR_ID
				,FNL_USR_ID
				,FNL_DEAL_DPT_CD
				,FNL_MNU_ID
				,FRT_REGI_DH
				,FNL_MDF_DH
			)
			VALUES
			(
				#ALW_DVSN_CD#
				,#CNB#
				,#ALW_AM#
				,#FIX_YN#
				,#FRT_USR_ID#
				,#FNL_USR_ID#
				,#FNL_DEAL_DPT_CD#
				,#FNL_MNU_ID#
				,SYSDATE
				,SYSDATE
			)
		]]>
	</insert>
	
	<update id="CSPLFI232EBnkUpdate" parameterClass="paramMap">
		<![CDATA[
			MERGE INTO TBCSPLFI103M A
			USING ( select #cnb# AS CNB from DUAL ) B
			ON (A.CNB = B.CNB)
			WHEN MATCHED THEN 
			UPDATE SET 
				   	A.BNK_CD = #BNK_CD#,
				    A.EAN = #EAN#,
				   	A.DEPSTR_NM = #DEPSTR_NM#,
				   	A.FNL_USR_ID = #FNL_USR_ID#,
					A.FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#,
					A.FNL_MNU_ID = #FNL_MNU_ID#,
					A.FNL_MDF_DH = SYSDATE
			WHEN NOT MATCHED THEN 
			INSERT (CNB, BNK_CD, EAN, DEPSTR_NM, FRT_USR_ID, FNL_USR_ID, FNL_DEAL_DPT_CD, FNL_MNU_ID, FRT_REGI_DH, FNL_MDF_DH)
			VALUES (#cnb#, #BNK_CD#, #EAN#, #DEPSTR_NM#, #FRT_USR_ID#, #FNL_USR_ID#, #FNL_DEAL_DPT_CD#, #FNL_MNU_ID#, SYSDATE, SYSDATE)
		]]>	
	</update>
	
</sqlMap> 