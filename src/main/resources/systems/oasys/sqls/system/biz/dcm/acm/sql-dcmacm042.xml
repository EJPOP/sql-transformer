<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="dcm/acm/042">

	<select id="DCMACM042QCheckSelect" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT	D2.APVR_STA_CD
			FROM	TBDCMACM022L D1, TBDCMACM023L D2
			WHERE	D1.APV_DOC_NO = D2.APV_DOC_NO
			AND		D1.APV_DVSN_CD = D2.APV_DVSN_CD
			AND		D1.APV_DOC_NO = #APV_DOC_NO#
			AND		D1.APV_DVSN_CD = #APV_DVSN_CD#
			AND		D2.APVR_CNB = #APVR_CNB#
			AND		D2.APVR_SEQ = #APVR_SEQ#
		]]>
	</select>
	
	<!-- 일괄결재 UPDATE (TBDCMACM022L) -->
	<update id="DCMACM042QTBDCMACM022LApvUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	TBDCMACM022L
			SET		APV_STA_CD = CASE 
								 	 WHEN #APVR_STA_CD#  = '102' THEN '3'
								 	 WHEN #APVR_STA_CD#  = '103' THEN '3'
			 					 	 WHEN #APVR_STA_CD#  = '104' THEN '3'
			 					 	 WHEN #APVR_STA_CD#  = '105' THEN '3'
			  					 	 WHEN #APVR_STA_CD#  = '106' THEN '3'
			  					     ELSE '2' 
			  					 END
					,FNL_APV_DH = SYSDATE
					,FNL_APV_CNB = #APVR_CNB#
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			WHERE	APV_DOC_NO = #APV_DOC_NO#
			AND		APV_DVSN_CD = #APV_DVSN_CD#
		]]>
	</update>
	
	<update id="dcmacm042ApprSugUpdate" parameterClass="paramMap">
		UPDATE
		TBDCMACM022L
		SET FNL_APV_DH = SYSDATE
		,
		FNL_APV_CNB =#FNL_APV_CNB#

		, FNL_MDF_DH = SYSDATE
		, FNL_USR_ID =
		#FNL_USR_ID#
		, FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		, FNL_MNU_ID =
		#FNL_MNU_ID#
		
		WHERE 1 = 1
		AND APV_DVSN_CD = #APV_DVSN_CD#
		AND APV_DOC_NO =
		#APV_DOC_NO#

	</update>
	
	<!-- 일괄결재 UPDATE (TBDCMACM023L) -->
	<update id="DCMACM042QTBDCMACM023LApvUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM023LApvUpdate*/ TBDCMACM023L
			SET		APVR_STA_CD = DECODE(#APVR_STA_CD#,'102','202','103','203','104','204','105','205','106','203','107','207')
					,APV_DH = SYSDATE
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
					,READ_YN = #READ_YN#
			WHERE	APV_DOC_NO = #APV_DOC_NO#
			AND		APV_DVSN_CD = #APV_DVSN_CD#
			AND		APVR_CNB = #APVR_CNB#
			AND		APV_SNO = #APV_SNO#
			AND		APVR_SEQ = #APVR_SEQ#
		]]>	
	</update>
	
	<!-- 일결결재 다음결재자 성태값 UPDATE (TBDCMACM023L) -->
	<update id="DCMACM042QTBDCMACM023LNextApvUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM023LNextApvUpdate*/ TBDCMACM023L
			SET		APVR_STA_CD = DECODE(#APVR_KND_CD#,'2','102','3','103','4','104','5','105','6','106','7','107','8','103','9','102')
				        ,APV_DH = ''
					,FNL_MDF_DH = SYSDATE
					,APV_OPIN = ''
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			WHERE	APV_DOC_NO = #APV_DOC_NO#
			AND		APV_DVSN_CD = #APV_DVSN_CD#
			AND		APVR_CNB = #APVR_CNB#
			AND		APV_SNO = #APV_SNO#
			AND		APVR_SEQ = #APVR_SEQ#
		]]>
	</update>
	
	<update id="DCMACM042QPtlOrderReceiveListUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	PTL_ORDER_RECEIVE_LIST
			SET		COMP_CMMT = #COMP_CMMT#
					,COMP_DT =  TO_CHAR(SYSDATE,'yyyymmddhh24miss')
			WHERE	1 = 1
			AND		USER_ID = F_USR_INFO(#APVR_CNB#,'1')
			AND		SEQ IN (	SELECT	TO_CHAR(MAX(SEQ)) AS SEQ
								FROM	PTL_ORDER_LIST
								WHERE	DOC_NO = #APV_DOC_NO#
							)
			AND SRT_NO = #APVR_SEQ#
		]]>

	</update>
	
	<update id="DCMACM042QPtlOrderListUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	PTL_ORDER_LIST
			SET		NA_YN ='Y'
					,NA_DT= TO_CHAR(SYSDATE,'yyyymmddhh24miss')
			WHERE	DOC_NO = #APV_DOC_NO#
		]]>
	</update>
	
	<insert id="DCMACM042QPtlOrderNoti" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO	PTL_ORDER_NOTI
					(	SEQ
						,NOTI_SEQ
						,USER_ID
						,TITLE
						,CRT_DT
						,IMP_YN
						,USE_YN
					)
			VALUES	(	(	SELECT	TO_CHAR(MAX(SEQ)) AS SEQ
							FROM	PTL_ORDER_LIST
							WHERE	DOC_NO = #APV_DOC_NO#
						)
						,(	SELECT	NVL(MAX(NOTI_SEQ),'1000000')+1
							FROM	PTL_ORDER_NOTI
							WHERE	SEQ IN (	SELECT	TO_CHAR(MAX(SEQ)) AS SEQ
												FROM	PTL_ORDER_LIST
												WHERE	DOC_NO = #APV_DOC_NO#
											)
						)
						,F_USR_INFO(#SBM_CNB#,'1')
						,'['||#APV_DVSN_NM#||']'||#APV_TIT_NM#||'[결재가 완료 되었습니다.]'
						,TO_CHAR(SYSDATE,'yyyymmddhh24miss')
						,'N'
						,'Y'
					)
		]]>
		
	</insert>
	
	<!-- 다음 결재자에게 알림 -->
	<insert id="DCMACM042QPtlOrderNotiNextInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO	PTL_ORDER_NOTI
					(	SEQ
						,NOTI_SEQ
						,USER_ID
						,TITLE
						,CRT_DT
						,IMP_YN
						,USE_YN
					)
			VALUES	(	(	SELECT	TO_CHAR(MAX(SEQ)) AS SEQ
							FROM	PTL_ORDER_LIST
							WHERE	DOC_NO = #APV_DOC_NO#
						)
						,(	SELECT	NVL(MAX(NOTI_SEQ),'1000000')+1
							FROM	PTL_ORDER_NOTI
							WHERE	SEQ IN (	SELECT	TO_CHAR(MAX(SEQ)) AS SEQ
												FROM	PTL_ORDER_LIST
												WHERE	DOC_NO = #APV_DOC_NO#
											)
						)
						,F_USR_INFO(#APVR_CNB#,'1')
						,#TITLE#
						,TO_CHAR(SYSDATE,'yyyymmddhh24miss')
						,'N'
						,'Y'
					)
		]]>
		
	</insert>
	
	<!-- 다음결재자정보조회 -->
	<select id="DCMACM042QNextApvSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	D1.APV_DOC_NO,D1.APV_DVSN_CD,D2.APV_SNO,D2.APVR_CNB,D2.APVR_STA_CD, D2.APVR_KND_CD, D2.APVR_SEQ, ( SELECT USR.USR_ID FROM TBDCMACM001M USR WHERE USR.CNB = D2.APVR_CNB) AS USR_ID
			  FROM	TBDCMACM022L D1, TBDCMACM023L D2
			 WHERE	D1.APV_DOC_NO = D2.APV_DOC_NO
			   AND	D1.APV_DVSN_CD = D2.APV_DVSN_CD
			   AND	D1.APV_DOC_NO = #APV_DOC_NO#
			   AND	D1.APV_DVSN_CD = #APV_DVSN_CD#
			   AND	D2.APV_SNO = TO_NUMBER(#APV_SNO#)+1
			   AND  D2.APVR_KND_CD <> '7'
		]]>
	</select>
	
	<!-- 메신저연계 TBDCMACM026L max seq -->
	<select id="DCMACM042QTBDCMACM026LMaxMsgSnoSelect" parameterClass="paramMap" resultClass="java.lang.String">
		SELECT 	NVL(MAX(MSG_SNO),0)+1 AS MSG_SNO 
		FROM 	TBDCMACM026L
	</select>
	
	<!-- 결재 메신저 발송 -->
	<insert id="DCMACM042QTBDCMACM026LMsgInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO	TBDCMACM026L
				(
					MSG_SNO
					, TSK_CAT_CD
					, FUNC_CAT_CD
					, SEND_ID
			        , MSG_TP_YN
			        , MSG_TXT_2
			        , RCNT_CNT
			        , RCNT_HIS
			        , MSG_REGI_DH
					, FRT_USR_ID
					, FNL_USR_ID
					, FNL_DEAL_DPT_CD
					, FNL_MNU_ID
					, FRT_REGI_DH
					, FNL_MDF_DH
	
				)
			VALUES	(
						(	SELECT 	NVL(MAX(MSG_SNO),0)+1 
							FROM 	TBDCMACM026L
						)
						, 'CM'
						, 'CM'
						, F_USR_INFO(#SEND_ID#,'1')
				        , '0'
	        			, #MSG_TITLE#
				        , 1
				        , #RCNT_HIS#
				        , SYSDATE
						, #FNL_USR_ID#
						, #FNL_USR_ID#
						, #FNL_DEAL_DPT_CD#
						, #FNL_MNU_ID#
						, SYSDATE
						, SYSDATE
					)
		]]>
	</insert>
	
	<!-- 일괄반려 UPDATE (TBDCMACM022L) -->
	<update id="DCMACM042QTBDCMACM022LApvCancleUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM022LApvCancleUpdate*/ TBDCMACM022L
			SET		APV_STA_CD = '4'
					,FNL_APV_DH = SYSDATE
					,FNL_APV_CNB = #APVR_CNB#
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			WHERE	APV_DOC_NO = #APV_DOC_NO#
			AND		APV_DVSN_CD = #APV_DVSN_CD#
		]]>
	</update>
	
	<!-- 일괄반려 UPDATE (TBDCMACM023L) -->
	<update id="DCMACM042QTBDCMACM023LApvCancleUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM023LApvCancleUpdate*/ TBDCMACM023L
			SET		APVR_STA_CD = '401'
					,APV_DH = SYSDATE
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			WHERE	APV_DOC_NO = #APV_DOC_NO#
			AND		APV_DVSN_CD = #APV_DVSN_CD#
			AND		APVR_CNB = #APVR_CNB#
			AND		APV_SNO = #APV_SNO#
			AND		APVR_SEQ = #APVR_SEQ#
		]]>	
	</update>
	
		<!-- 대결자와 같은 순번의 결재자 상태 변경 (대결자,결재자 상태를 공백으로 변경한다.) -->
	<update id="DCMACM042QTBDCMACM023LApvCancleByInstdUpdate" parameterClass="paramMap">
		<![CDATA[
		     UPDATE	/*DCMACM042QTBDCMACM023LApvByInstdUpdate*/ TBDCMACM023L
				SET	APVR_STA_CD = null
					,APV_DH = null
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			 WHERE APV_DOC_NO = #APV_DOC_NO#
			   AND APVR_SEQ IN (
								SELECT APVR_SEQ
								   FROM TBDCMACM023L
								  WHERE APV_DOC_NO = #APV_DOC_NO#
								  	AND APV_SNO = #APV_SNO#
								    AND APVR_CNB <> #APVR_CNB#
							    )
		]]>	
	</update>
	
	<!-- 제출자 정보 조회 -->
	<select id="DCMACM042QApvSendInfoSelect" parameterClass="paramMap" resultClass="resultMap">
		SELECT	D1.APV_DOC_NO,D1.APV_DVSN_CD,D2.APV_SNO,D2.APVR_CNB,D2.APVR_STA_CD, D2.APVR_KND_CD, D2.APVR_SEQ, ( SELECT USR.USR_ID FROM TBDCMACM001M USR WHERE USR.CNB = D2.APVR_CNB) AS USR_ID
		  FROM	TBDCMACM022L D1, TBDCMACM023L D2
		 WHERE	D1.APV_DOC_NO = D2.APV_DOC_NO
		   AND	D1.APV_DVSN_CD = D2.APV_DVSN_CD
		   AND	D1.APV_DOC_NO = #APV_DOC_NO#
		   AND	D1.APV_DVSN_CD = #APV_DVSN_CD#
		   AND	D2.APV_SNO = #APV_SNO#
		   AND  D2.APVR_KND_CD = '7' 
	</select>
	
	<select id="DCMACM042QPreApvSendInfoSelect" parameterClass="paramMap" resultClass="resultMap">
		SELECT	D1.APV_DOC_NO,D1.APV_DVSN_CD,D2.APV_SNO,D2.APVR_CNB,D2.APVR_STA_CD, D2.APVR_KND_CD, D2.APVR_SEQ, ( SELECT USR.USR_ID FROM TBDCMACM001M USR WHERE USR.CNB = D2.APVR_CNB) AS USR_ID
		  FROM	TBDCMACM022L D1, TBDCMACM023L D2
		 WHERE	D1.APV_DOC_NO = D2.APV_DOC_NO
		   AND	D1.APV_DVSN_CD = D2.APV_DVSN_CD
		   AND	D1.APV_DOC_NO = #APV_DOC_NO#
		   AND	D1.APV_DVSN_CD = #APV_DVSN_CD#
		   AND	D2.APV_SNO = #APV_SNO# -1
		   AND  D2.APVR_KND_CD = '7' 
	</select>
	
	<!-- 이전 결재자 정보 조회 -->
	<select id="DCMACM042QPreApvSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT	D1.APV_DOC_NO,D1.APV_DVSN_CD,D2.APV_SNO,D2.APVR_CNB,D2.APVR_STA_CD, D2.APVR_KND_CD, D2.APVR_SEQ, ( SELECT USR.USR_ID FROM TBDCMACM001M USR WHERE USR.CNB = D2.APVR_CNB) AS USR_ID
			  FROM	TBDCMACM022L D1, TBDCMACM023L D2
			 WHERE	D1.APV_DOC_NO = D2.APV_DOC_NO
			   AND	D1.APV_DVSN_CD = D2.APV_DVSN_CD
			   AND	D1.APV_DOC_NO = #APV_DOC_NO#
			   AND	D1.APV_DVSN_CD = #APV_DVSN_CD#
			   AND  D2.APV_SNO <> #APV_SNO#  
		]]>
	</select>
	
	<!-- 같은 순번의 대결자 상태 변경 (대결자들은 상태값을 공백처리한다.제출자는 제외) -->
	<update id="DCMACM042QTBDCMACM023LInstdApvUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM023LInstdApvUpdate*/ TBDCMACM023L
			   SET	APVR_STA_CD = ''
					,APV_DH = ''
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			 WHERE APV_DOC_NO = #APV_DOC_NO#
			   AND APVR_SEQ IN (
								SELECT APVR_SEQ
								   FROM TBDCMACM023L
								  WHERE APV_DOC_NO = #APV_DOC_NO#
								  	AND APV_SNO = #APV_SNO#
								    AND APVR_CNB <> #APVR_CNB#
								    AND APVR_KND_CD = '6'
							    )
		]]>	
	</update>
	
	<!-- 대결자와 같은 순번의 결재자 상태 변경 (대결완료 상태로 변경한다. 제출자는 제외) -->
	<update id="DCMACM042QTBDCMACM023LApvByInstdUpdate" parameterClass="paramMap">
		<![CDATA[
		     UPDATE	/*DCMACM042QTBDCMACM023LApvByInstdUpdate*/ TBDCMACM023L
				SET	APVR_STA_CD = '206' /*대결완료*/
					,APV_DH = SYSDATE
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			 WHERE APV_DOC_NO = #APV_DOC_NO#
			   AND APVR_SEQ IN (
								SELECT APVR_SEQ
								   FROM TBDCMACM023L
								  WHERE APV_DOC_NO = #APV_DOC_NO#
								  	AND APV_SNO = #APV_SNO#
								    AND APVR_SEQ <> #APVR_SEQ#
								    AND APVR_KND_CD NOT IN ('6','7')
							    )
		]]>	
	</update>
	
	
	<update id="DCMACM042QPtlOrderReceiveListByInstdApvUpdate" parameterClass="paramMap">
		<![CDATA[
		 UPDATE PTL_ORDER_RECEIVE_LIST 
		    SET COMP_CMMT = '',
			    COMP_DT = TO_CHAR(SYSDATE,'yyyymmddhh24miss')
		  WHERE SEQ IN( SELECT TO_CHAR(MAX(SEQ) ) AS SEQ
		                 FROM PTL_ORDER_LIST
		                WHERE DOC_NO = #APV_DOC_NO#
		                  AND SRT_NO IN( SELECT APVR_SEQ
		                                   FROM TBDCMACM023L
		                                  WHERE APV_DOC_NO = #APV_DOC_NO#
		                                    AND APV_SNO = #APV_SNO#
		                                    AND APVR_CNB <> #APVR_CNB#
		                                    AND APVR_KND_CD = '6' )
		              )
		]]>

	</update>
	
	<update id="DCMACM042QPtlOrderReceiveListByInstdApvCancleUpdate" parameterClass="paramMap">
		<![CDATA[
		 UPDATE PTL_ORDER_RECEIVE_LIST 
		    SET COMP_CMMT = '',
			    COMP_DT = TO_CHAR(SYSDATE,'yyyymmddhh24miss')
		  WHERE SEQ IN( SELECT TO_CHAR(MAX(SEQ) ) AS SEQ
		                 FROM PTL_ORDER_LIST
		                WHERE DOC_NO = #APV_DOC_NO#
		                  AND SRT_NO IN( SELECT APVR_SEQ
		                                   FROM TBDCMACM023L
		                                  WHERE APV_DOC_NO = #APV_DOC_NO#
		                                    AND APV_SNO = #APV_SNO#
		                                    AND APVR_CNB <> #APVR_CNB#
		                                   )
		              )
		]]>

	</update>
	
	<update id="DCMACM042QPtlOrderReceiveListByApvInstdUpdate" parameterClass="paramMap">
		<![CDATA[
		 UPDATE PTL_ORDER_RECEIVE_LIST 
		    SET COMP_CMMT = '[대결완료]',
			    COMP_DT = TO_CHAR(SYSDATE,'yyyymmddhh24miss')
		  WHERE SEQ IN( SELECT TO_CHAR(MAX(SEQ) ) AS SEQ
		                 FROM PTL_ORDER_LIST
		                WHERE DOC_NO = #APV_DOC_NO#
		                  AND SRT_NO IN( SELECT APVR_SEQ
		                                   FROM TBDCMACM023L
		                                  WHERE APV_DOC_NO = #APV_DOC_NO#
		                                    AND APV_SNO = #APV_SNO#
		                                    AND APVR_CNB <> #APVR_CNB#
		                                    AND APVR_KND_CD NOT IN ('6','7') )
		              )
		]]>

	</update>
	
	<!-- 일결반려 이전결재자 성태값 UPDATE (TBDCMACM023L) -->
	<update id="DCMACM042QTBDCMACM023LPreApvUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM023LPreApvUpdate*/ TBDCMACM023L
			SET		APVR_STA_CD = DECODE(#APVR_KND_CD#,'1','101','')
					,APV_DH = ''
					,APV_OPIN = ''
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			WHERE	APV_DOC_NO = #APV_DOC_NO#
			AND		APV_DVSN_CD = #APV_DVSN_CD#
			AND		APVR_CNB = #APVR_CNB#
			AND		APV_SNO = #APV_SNO#
			AND		APVR_SEQ = #APVR_SEQ#
		]]>
	</update>
	
	<!-- 결재자 히스토리 -->
	<insert id="dcmacm042ApprSugAssignHistInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBDCMACM023H	
				 SELECT (SELECT NVL(MAX(SEQ), 0) + 1 FROM TBDCMACM023H) AS SEQ
					    ,APV_DOC_NO
						,APV_DVSN_CD
						,APVR_CNB
						,APVR_SEQ
						,APVR_DPT_CD
						,APVR_RANK_CD
						,APVR_PST_CD
						,APVR_KND_CD
						,APV_SNO
						,APVR_STA_CD
						,APV_DH
						,APV_OPIN
						,FRT_USR_ID
						,FNL_USR_ID
						,FNL_DEAL_DPT_CD
						,FNL_MNU_ID
						,SYSDATE AS FRT_REGI_DH
						,SYSDATE AS FNL_MDF_DH
						,ONR_PST_NM
						,VACANCY_CD
						,READ_YN
				  FROM (
						 SELECT *
						  FROM TBDCMACM023L
						 WHERE APV_DOC_NO = #APV_DOC_NO#
						   AND APV_DVSN_CD = #APV_DVSN_CD#
						   AND SUBSTR(APVR_STA_CD,0,1) >= '2'
						   AND SUBSTR(APVR_STA_CD,0,1) <> '3'
						 ORDER BY APV_DH DESC, APVR_KND_CD DESC
						) 
				 WHERE ROWNUM = 1
		]]>
	</insert>
	
	<!-- 후처리 URL 조회 -->
	<select id="DCMACM042QGetAfterProcessUrlByApvDvsnCd" parameterClass="paramMap" resultClass="java.lang.String">
		SELECT APV_MTD_NM
		  FROM TBDCMACM021M
		 WHERE APV_DVSN_CD = #APV_DVSN_CD#
	</select>
	
	<!-- 다음결재자정보조회(자동협조결재용)-->
	<select id="DCMACM042QNextApvSelectByAutoCmptCopr" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			   SELECT A.APV_DOC_NO
				      ,A.APV_DVSN_CD
				      ,A.APV_SNO
				      ,A.APVR_CNB
				      ,A.APVR_STA_CD
				      ,A.APVR_KND_CD
				      ,A.APVR_SEQ
				      ,( SELECT USR.USR_ID FROM TBDCMACM001M USR WHERE USR.CNB = A.APVR_CNB) AS USR_ID
			FROM TBDCMACM023L A 
			WHERE A.APV_DOC_NO = #APV_DOC_NO#
				   AND A.APV_DVSN_CD = #APV_DVSN_CD#
				   AND A.APV_SNO IN (
				  SELECT NVL(MIN(A.APV_SNO),0) AS APV_SNO
				  FROM TBDCMACM023L A
				 WHERE A.APV_DOC_NO = #APV_DOC_NO#
				   AND A.APV_DVSN_CD = #APV_DVSN_CD#
				   AND A.APV_SNO > #CURRENT_APV_SNO#
				   AND A.APV_SNO NOT IN (
							SELECT  APV_SNO
							  FROM (
									SELECT APV_DOC_NO,APV_DVSN_CD,APV_SNO,APVR_CNB,APVR_KND_CD,MIN(APV_DH) AS HIST_APV_DH
									  FROM TBDCMACM023H 
									 WHERE APVR_STA_CD = '204' 
									   AND APV_DOC_NO = #APV_DOC_NO#
									   AND APV_DVSN_CD = #APV_DVSN_CD#
									 GROUP BY APV_DOC_NO,APV_DVSN_CD,APV_SNO,APVR_CNB,APVR_KND_CD
									UNION
									SELECT AA.APV_DOC_NO,AA.APV_DVSN_CD,AA.APV_SNO,AA.APVR_CNB,AB.APVR_KND_CD,AB.HIST_APV_DH
									  FROM TBDCMACM023L AA
									      ,(
											SELECT APV_DOC_NO,APV_DVSN_CD,APV_SNO,APVR_CNB,APVR_KND_CD,MIN(APV_DH) AS HIST_APV_DH
										      FROM TBDCMACM023H 
										     WHERE APVR_KND_CD = '6' 
										       AND APVR_STA_CD = '203'
											   AND APV_DOC_NO = #APV_DOC_NO#
											   AND APV_DVSN_CD = #APV_DVSN_CD#
										     GROUP BY APV_DOC_NO,APV_DVSN_CD,APV_SNO,APVR_CNB,APVR_KND_CD
										   ) AB
									 WHERE AA.APV_DOC_NO = AB.APV_DOC_NO
									   AND AA.APV_DVSN_CD = AB.APV_DVSN_CD
									   AND AA.APVR_CNB = AB.APVR_CNB
									   AND AA.APV_DOC_NO = #APV_DOC_NO#
									   AND AA.APV_DVSN_CD = #APV_DVSN_CD#
									   AND AA.APVR_KND_CD = '6'
									)
							)
						)
		]]>
	</select>
	
	<!-- 일괄결재시 자동협조결재 목록 조회 -->
	<select id="DCMACM042QAutoCmptCoprListSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			   	SELECT  APV_DOC_NO
						,APV_DVSN_CD
						,APV_SNO
						,APVR_CNB
						,APVR_KND_CD
						,HIST_APV_DH
				      	,APVR_STA_CD
				      	,APVR_SEQ
				      	,(SELECT USR.USR_ID FROM TBDCMACM001M USR WHERE USR.CNB = APVR_CNB) AS USR_ID
				  FROM (
				  		SELECT A.APV_DOC_NO, A.APV_DVSN_CD, A.APV_SNO, A.APVR_CNB, A.APVR_SEQ, B.APVR_STA_CD, B.APVR_KND_CD, B.HIST_APV_DH
						  FROM TBDCMACM023L A
						      ,(
								SELECT APV_DOC_NO,APV_DVSN_CD,APV_SNO,APVR_CNB,APVR_STA_CD,APVR_KND_CD,MIN(APV_DH) AS HIST_APV_DH
								  FROM TBDCMACM023H 
								 WHERE APVR_STA_CD = '204' 
								   AND APV_DOC_NO = #APV_DOC_NO#
								   AND APV_DVSN_CD = #APV_DVSN_CD#
								 GROUP BY APV_DOC_NO,APV_DVSN_CD,APV_SNO,APVR_CNB,APVR_STA_CD,APVR_KND_CD
								) B
						 WHERE A.APV_DOC_NO = B.APV_DOC_NO
						   AND A.APV_DVSN_CD = B.APV_DVSN_CD
						   AND A.APVR_CNB = B.APVR_CNB
						   AND A.APV_DOC_NO = #APV_DOC_NO#
						   AND A.APV_DVSN_CD = #APV_DVSN_CD#	 
				   		   AND A.APVR_KND_CD = '4'
						UNION
						SELECT A.APV_DOC_NO, A.APV_DVSN_CD, A.APV_SNO, A.APVR_CNB, A.APVR_SEQ, B.APVR_STA_CD, B.APVR_KND_CD, B.HIST_APV_DH
						  FROM TBDCMACM023L A
						      ,(
								SELECT APV_DOC_NO,APV_DVSN_CD,APV_SNO,APVR_CNB, APVR_STA_CD, APVR_KND_CD, MIN(APV_DH) AS HIST_APV_DH
							      FROM TBDCMACM023H 
							     WHERE APVR_KND_CD = '6' 
							       AND APVR_STA_CD = '203'
								   AND APV_DOC_NO = #APV_DOC_NO#
								   AND APV_DVSN_CD = #APV_DVSN_CD#
							     GROUP BY APV_DOC_NO,APV_DVSN_CD,APV_SNO,APVR_CNB,APVR_STA_CD,APVR_KND_CD
							   ) B
						 WHERE A.APV_DOC_NO = B.APV_DOC_NO
						   AND A.APV_DVSN_CD = B.APV_DVSN_CD
						   AND A.APVR_CNB = B.APVR_CNB
						   AND A.APV_DOC_NO = #APV_DOC_NO#
						   AND A.APV_DVSN_CD = #APV_DVSN_CD#
						   AND A.APVR_KND_CD = '6'
						)
				 WHERE APV_SNO > #CURRENT_APV_SNO#
				   AND APV_SNO < #NEXT_APV_SNO#
		   		 ORDER BY APV_SNO ASC, HIST_APV_DH DESC 
		]]>
	</select>
	
	<!-- 일괄결재시 협조자 자동 결재처리 UPDATE (TBDCMACM023L) -->
	<update id="DCMACM042QTBDCMACM023LAutoCmptCoprUpdateByCopr" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM023LAutoCmptCoprUpdateByCopr*/ TBDCMACM023L
			SET		APVR_STA_CD = #APVR_STA_CD#
					,APV_DH = #HIST_APV_DH#
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			WHERE	APV_DOC_NO = #APV_DOC_NO#
			AND		APV_DVSN_CD = #APV_DVSN_CD#
			AND		APVR_CNB = #APVR_CNB#
			AND		APV_SNO = #APV_SNO#
			AND		APVR_SEQ = #APVR_SEQ#
		]]>
	</update>
	
	<!-- 일괄결재시 협조자 자동 대결 처리 UPDATE (TBDCMACM023L) -->
	<update id="DCMACM042QTBDCMACM023LAutoCmptCoprInstdUpdateByCopr" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM023LAutoCmptCoprInstdUpdateByCopr*/ TBDCMACM023L
			SET		APVR_STA_CD = '206'
					,APV_DH = #HIST_APV_DH#
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			WHERE	APV_DOC_NO = #APV_DOC_NO#
			AND		APV_DVSN_CD = #APV_DVSN_CD#
			AND		APV_SNO = #APV_SNO#
			AND		APVR_KND_CD = '4'
		]]>
	</update>
	
	<!-- 일괄결재시 대결자 자동결재처리 UPDATE (TBDCMACM023L) -->
	<update id="DCMACM042QTBDCMACM023LAutoCmptCoprApvUpdateByInstd" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM023LAutoCmptCoprApvUpdateByInstd*/ TBDCMACM023L
			SET		APVR_STA_CD = #APVR_STA_CD#
					,APV_DH = #HIST_APV_DH#
					,FNL_MDF_DH = SYSDATE
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
			WHERE	APV_DOC_NO =  #APV_DOC_NO#
			AND		APV_DVSN_CD = #APV_DVSN_CD#
			AND		APV_SNO = #APV_SNO#
			AND		APVR_CNB = #APVR_CNB#
			AND		APVR_SEQ = #APVR_SEQ#
			AND		APVR_KND_CD = '6'
		]]>
	</update>
	
	<!-- 일괄결재시 같은순번 대결자 공백처리 UPDATE (TBDCMACM023L) -->
	<update id="DCMACM042QTBDCMACM023LAutoCmptCoprEmptyUpdateByInstd" parameterClass="paramMap">
		<![CDATA[
			UPDATE	/*DCMACM042QTBDCMACM023LAutoCmptCoprEmptyUpdateByInstd*/ TBDCMACM023L
				SET		APVR_STA_CD = null
						,APV_DH = null
						,FNL_MDF_DH = SYSDATE
						,FNL_USR_ID = #FNL_USR_ID#
						,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
						,FNL_MNU_ID = #FNL_MNU_ID#
				WHERE	APV_DOC_NO = #APV_DOC_NO#
				AND		APV_DVSN_CD = #APV_DVSN_CD#
				AND		APV_SNO = #APV_SNO#
				AND 	APVR_CNB <> #APVR_CNB#
				AND		APVR_KND_CD = '6'
		]]>
	</update>
	
	<!-- 일괄결재시 자동협조결재 목록 조회 -->
	<select id="DCMACM042QOrderReceiveListByAutoCmptCoprSelect" parameterClass="paramMap" resultClass="resultMap">
		SELECT DECODE(A.APVR_STA_CD,'201','[상신완료]','202','[검토완료]','203','[결재완료]','204','[협조완료]','205','[전결완료]','206','[대결완료]','207','[제출완료]','401','[결재반려]') AS COMP_CMMT
		     , TO_CHAR(A.APV_DH,'yyyymmddhh24miss') AS COMP_DT, F_USR_INFO(A.APVR_CNB,'1') AS USER_ID, A.APVR_SEQ , MAX(B.SEQ) AS SEQ
		  FROM TBDCMACM023L A
		     , PTL_ORDER_LIST B
		 WHERE A.APV_DOC_NO = B.DOC_NO
		   AND A.APV_DOC_NO = #APV_DOC_NO#
		   AND A.APV_SNO = #APV_SNO#
		   AND A.APV_DH IS NOT NULL
		 GROUP BY A.APVR_STA_CD, A.APV_DH, A.APVR_CNB , A.APVR_SEQ
	</select>
	
	<!-- 일괄결재시 협조자 자동 결재 순번의 업무지시수신자정보 UPDATE-->
	<update id="DCMACM042QOrderReceiveListByAutoCmptCoprUpdate" parameterClass="paramMap">
		UPDATE	PTL_ORDER_RECEIVE_LIST A
		   SET	COMP_CMMT = #COMP_CMMT#
				,COMP_DT =  #COMP_DT#
		 WHERE	USER_ID = #USER_ID#
		   AND	SEQ = #SEQ#
		   AND 	SRT_NO = #APVR_SEQ#
	</update>
	
	<select id="DCMACM047QCheckSelect" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT	D1.APV_STA_CD
			FROM	TBDCMACM022L D1
			WHERE	D1.APV_DOC_NO = #APV_DOC_NO#
			AND		D1.APV_DVSN_CD = #APV_DVSN_CD#
		]]>
	</select>
	
	
	<select id="selectEditUserCheck" parameterClass="paramMap" resultClass="String">
		SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END
		  FROM TBDCMACM013C T1
		     , TBDCMACM001M T2
		 WHERE T1.CMM_CD_DVSN_CD = '1000863'
		   AND ((T1.CD = #S_INN_RANK_CD# AND T1.USR_DFN_TXT_1 IS NULL)
		       OR (T1.CD = #S_INN_RANK_CD# AND (T1.USR_DFN_TXT_1 = #S_DPT_CD#))) 
		   AND T2.CNB = #S_CNB#
	</select>
	
	<select id="selectEditUserCheck2" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT	CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END
			  FROM	TBDCMACM023L
		 	 WHERE	APV_DOC_NO = #strDocNo#
			   AND	APVR_PST_CD IN ('0045900','0055600')
		  	   AND	APVR_STA_CD IN ('102', '103')
		]]>
	</select>	
	
	<select id="selectApvrLineCheck" parameterClass="paramMap" resultClass="resultMap">
	    <![CDATA[
	    SELECT B.CNB
	         , B.USR_NAM
	         , B.USR_ID
	         , B.INN_RANK_CD
	         , F_DPT_INFO(B.DPT_CD, '1') AS DPT_NM
	         , B.ONR_PST_NM
          FROM (
				SELECT SUBSTR(REGEXP_REPLACE(USR_DFN_TXT_2, '[^[:digit:]]'), (LEVEL - 1) * 4 + 1, 4) AS CNB
				FROM (
						SELECT USR_DFN_TXT_2
						  FROM TBDCMACM013C 
						 WHERE CMM_CD_DVSN_CD = '1000858'
						   AND CD = '000000000'
						   AND 1 <= (
								  SELECT COUNT(A.DOC_ID)
								    FROM TBBADDED103M A
								   INNER JOIN TBDCMACM013C B ON (B.CD = A.RPRT_CD)
								   INNER JOIN TBBADDED001M C ON (C.AUD_YR = A.AUD_YR AND C.AUD_NO = A.AUD_NO)
								   WHERE 1=1
	    ]]>
								<isNotEmpty property="strDocIdList">
					                 AND A.DOC_ID IN <iterate open="(" close=")" conjunction="," property="strDocIdList">#strDocIdList[]#</iterate>
								</isNotEmpty>
								<isNotEmpty property="strRprtCd">
			                         AND A.RPRT_CD = #strRprtCd#
		                        </isNotEmpty>
		<![CDATA[
								     AND ((B.CMM_CD_DVSN_CD = '1000858' AND B.USR_DFN_TXT_1 = 'Y' AND B.CD <> 'A10100100')
								      OR (B.CMM_CD_DVSN_CD = '1000858' AND B.USR_DFN_TXT_1 = 'Y' AND B.CD = 'A10100100' AND C.BZT_BGT_DVSN_CD = '1'))
				            )
				      )
				CONNECT BY SUBSTR(REGEXP_REPLACE(USR_DFN_TXT_2, '[^[:digit:]]'), (LEVEL - 1) * 4 + 1, 4) > 0
		  ) A
		  INNER JOIN TBDCMACM001M B ON (A.CNB = B.CNB)
		  ORDER BY B.INN_RANK_CD, B.RANK_CD ASC
	    ]]>
	</select>
	
	
	<select id="selectReferDvsnCdByAudRprt" parameterClass="paramMap" resultClass="String">
	    <![CDATA[
        SELECT CASE WHEN SUM(DECODE(E.REFER_DVSN_CD, 'D10', 1, 0) ) > 0 THEN 'D10' ELSE 'E10' END AS REFER_DVSN_CD
          FROM TBBADDED103M A 
    INNER JOIN TBBADDED103M B ON (B.AUD_YR = A.AUD_YR AND B.AUD_NO = A.AUD_NO AND B.DOC_ID = A.REF_ID AND B.AUD_STEP_CD = 'A1080' AND B.RPRT_CD = 'A10800150') 
    INNER JOIN TBBADDED103M C ON (C.AUD_YR = B.AUD_YR AND C.AUD_NO = B.AUD_NO AND C.DOC_ID = B.REF_ID AND C.FNL_BAI_RPRT_YN = 'Y') 
    INNER JOIN TBBADDED103M D ON (D.AUD_YR = C.AUD_YR AND D.AUD_NO = C.AUD_NO AND D.DOC_ID = C.REF_ID AND D.AUD_STEP_CD = 'A1060' AND D.RPRT_CD = 'A10600200')
    INNER JOIN TBBADDED145M E ON (E.AUD_YR = D.AUD_YR AND E.AUD_NO = D.AUD_NO AND E.DOC_ID = D.DOC_ID AND E.APVR_CD = 'A1070')
         WHERE 1=1
         ]]> 
         <isNotEmpty property="strDocIdList">
         AND A.DOC_ID IN <iterate open="(" close=")" conjunction="," property="strDocIdList">#strDocIdList[]#</iterate>
         </isNotEmpty>
         <isNotEmpty property="strDocNo">
         AND A.APV_RQS_ID = #strDocNo#
         </isNotEmpty>
	</select>
	
	<select id="selectFrsApvrLineCheck" parameterClass="paramMap" resultClass="resultMap">
	    <![CDATA[
	    SELECT B.CNB
	         , B.USR_NAM
	         , B.USR_ID
	         , B.INN_RANK_CD
	         , F_DPT_INFO(B.DPT_CD, '1') AS DPT_NM
	         , B.ONR_PST_NM
          FROM (
				SELECT SUBSTR(REGEXP_REPLACE(USR_DFN_TXT_2, '[^[:digit:]]'), (LEVEL - 1) * 4 + 1, 4) AS CNB
				FROM (
						SELECT USR_DFN_TXT_2
						  FROM TBDCMACM013C 
						 WHERE CMM_CD_DVSN_CD = '1001017'
						   AND CD = '000000000'
						   AND 1 <= (
								  SELECT COUNT(A.DOC_ID)
								    FROM TBBADDED103M A
								   INNER JOIN TBDCMACM013C B ON (B.CD = A.RPRT_CD)
								   INNER JOIN TBBADDED001M C ON (C.AUD_YR = A.AUD_YR AND C.AUD_NO = A.AUD_NO)
								   WHERE 1=1
	    ]]>
								<isNotEmpty property="strDocIdList">
					                 AND A.DOC_ID IN <iterate open="(" close=")" conjunction="," property="strDocIdList">#strDocIdList[]#</iterate>
								</isNotEmpty>
								<isNotEmpty property="strRprtCd">
			                         AND A.RPRT_CD = #strRprtCd#
		                        </isNotEmpty>
		<![CDATA[
				            )
				      )
				CONNECT BY SUBSTR(REGEXP_REPLACE(USR_DFN_TXT_2, '[^[:digit:]]'), (LEVEL - 1) * 4 + 1, 4) > 0
		  ) A
		  INNER JOIN TBDCMACM001M B ON (A.CNB = B.CNB)
		  ORDER BY B.INN_RANK_CD, B.RANK_CD ASC
	    ]]>
	</select>
	
</sqlMap>