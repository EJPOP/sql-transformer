<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/ear/001">
 	<select id="CSPEAR001EMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	A.REQ_DVSN_CD
					,A.ACP_YR
   					,A.CVPT_ACP_NO
   					,A.ACP_YR||'-'||F_CODE_NM('1000740',A.REQ_DVSN_CD)||'-'||A.CVPT_ACP_NO AS ACP_NO
   					,DECODE(A.REQR_KND_CD,'1',A.CVPTR_NM,'2',A.RPST_PEN_NM,'3',A.RPST_PEN_NM,'4',A.CVPTR_NM) AS CVPTR_NM
   					,A.TIT_NM
   					,A.ACP_DH
   					,B.REQR_DVSN_CD
   					,A.CVPT_HNDL_STA_CD
   					,(	SELECT CASE WHEN COUNT(*) > 1 THEN  F_ORG_INFO(MIN(AUD_TG_ORG_CD),'1')||'외 '|| TO_CHAR(COUNT(*)-1)||'건' 
   								ELSE F_ORG_INFO(MIN(AUD_TG_ORG_CD),'1') END 
   						FROM	TBCSPDCP104L Z
   						WHERE	A.REQ_DVSN_CD = Z.REQ_DVSN_CD
   						AND		A.ACP_YR = Z.ACP_YR
   						AND		A.CVPT_ACP_NO = Z.CVPT_ACP_NO
					) AS AUD_TG_ORG_NM
   			FROM	TBCSPDCP101M A
   					,TBCSPEAR001M B
   			WHERE	1=1
   			AND		A.REQ_DVSN_CD = B.REQ_DVSN_CD(+)
   			AND		A.ACP_YR = B.ACP_YR(+)
   			AND		A.CVPT_ACP_NO = B.CVPT_ACP_NO(+)
		]]>
		<dynamic>
			<isNotEmpty property="strREQ_DVSN_CD">
				AND	A.REQ_DVSN_CD = #strREQ_DVSN_CD#
			</isNotEmpty>
			<isEmpty property="strREQ_DVSN_CD">
				AND	A.REQ_DVSN_CD IN ('2','3')
			</isEmpty>
			<isNotEmpty property="strACP_DHS">
				AND	A.ACP_DH &gt;= #strACP_DHS#
			</isNotEmpty>
			<isNotEmpty property="strACP_DHE">
				AND	A.ACP_DH &lt;= #strACP_DHE#
			</isNotEmpty>
			<isNotEmpty property="strTIT_NM">
				AND	A.TIT_NM LIKE '%'||#strTIT_NM#||'%'
			</isNotEmpty>
			<isNotEmpty property="strACP_YR">
				AND	A.ACP_YR = #strACP_YR#
			</isNotEmpty>
			<isNotEmpty property="strCVPT_ACP_NO">
				AND	A.CVPT_ACP_NO = #strCVPT_ACP_NO#
			</isNotEmpty>
			<isNotEmpty property="strCVPT_HNDL_STA_CD">
				AND	A.CVPT_HNDL_STA_CD = #strCVPT_HNDL_STA_CD#
			</isNotEmpty>
			<isNotEmpty property="strCVPTR_NM">
				AND	(A.CVPTR_NM LIKE '%'||#strCVPTR_NM#||'%' OR A.RPST_PEN_NM LIKE '%'||#strCVPTR_NM#||'%')
			</isNotEmpty>
		</dynamic>
		<![CDATA[
			ORDER BY A.ACP_YR DESC, A.CVPT_ACP_NO DESC
		]]>
	</select>
	
	<resultMap class="java.util.HashMap" id="CSPEAR002">
 		<result property="REQ_DVSN_CD" column="REQ_DVSN_CD"                   jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ACP_YR" column="ACP_YR"                             jdbcType="VARCHAR2"  javaType="java.lang.String" /> 
		<result property="CVPT_ACP_NO" column="CVPT_ACP_NO"                   jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="ACP_NO" column="ACP_NO"                             jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="REQR_KND_CD" column="REQR_KND_CD"                   jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="CVPTR_NM" column="CVPTR_NM"                         jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="BTDT" column="BTDT"                                 jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="JB_NM" column="JB_NM"                               jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="RPST_PEN_NM" column="RPST_PEN_NM"                   jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="BZN" column="BZN"                                   jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="CPNM_NM" column="CPNM_NM"                           jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="ZCD" column="ZCD"                                   jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="AD" column="AD"                                     jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="DTL_AD" column="DTL_AD"                             jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="TNB1" column="TNB1"                                 jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="TNB2" column="TNB2"                                 jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="TNB3" column="TNB3"                                 jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="HPN1" column="HPN1"                                 jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="HPN2" column="HPN2"                                 jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="HPN3" column="HPN3"                                 jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="EML_ID" column="EML_ID"                             jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="EML_DMI_NM" column="EML_DMI_NM"                     jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="TIT_NM" column="TIT_NM"                             jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="ACP_DPT_CD" column="ACP_DPT_CD"                     jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="ACP_DPT_NM" column="ACP_DPT_NM"                     jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="RCEP_ID" column="RCEP_ID"                           jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="RCEP_NM" column="RCEP_NM"                           jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="ACP_DH" column="ACP_DH"                             jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="CVPT_HNDL_STA_CD" column="CVPT_HNDL_STA_CD"         jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="CVPT_TXT" column="CVPT_TXT"                         jdbcType="CLOB"      javaType="java.lang.String" />
		<result property="CVPT_SBT" column="CVPT_SBT"                         jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="DOC_ID" column="DOC_ID"                     jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="REQR_CNT" column="REQR_CNT"                     jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="REQR_DVSN_CD" column="REQR_DVSN_CD"                     jdbcType="VARCHAR2"  javaType="java.lang.String" />
		<result property="OGNZ_PSO_CNT" column="OGNZ_PSO_CNT"                     jdbcType="VARCHAR2"  javaType="java.lang.String" />
		
 	</resultMap>
	<select id="CSPEAR002EMainSelect" parameterClass="paramMap"
		resultMap="CSPEAR002">
		<![CDATA[
			SELECT	A.REQ_DVSN_CD
					,A.ACP_YR
   					,A.CVPT_ACP_NO
   					,A.ACP_YR||'-'||F_CODE_NM('1000740',A.REQ_DVSN_CD)||'-'||A.CVPT_ACP_NO AS ACP_NO
   					,A.REQR_KND_CD
   					,A.CVPTR_NM
   					,A.BTDT
   					,A.JB_NM
   					,A.RPST_PEN_NM
   					,A.BZN
   					,A.CPNM_NM
   					,A.ZCD
   					,A.AD
   					,A.DTL_AD
   					,DECODE(A.TNB,NULL,'',SUBSTR(A.TNB,1,INSTR(A.TNB,'-',1,1)-1)) TNB1
   					,DECODE(A.TNB,NULL,'',SUBSTR(A.TNB,INSTR(A.TNB,'-',1,1)+1,INSTR(A.TNB,'-',1,2)-INSTR(A.TNB,'-',1,1)-1)) AS TNB2
   					,DECODE(A.TNB,NULL,'',SUBSTR(A.TNB,INSTR(A.TNB,'-',1,2)+1)) TNB3
   					,DECODE(A.HPN,NULL,'',SUBSTR(HPN,1,INSTR(HPN,'-',1,1)-1)) HPN1
   					,DECODE(A.HPN,NULL,'',SUBSTR(A.HPN,INSTR(A.HPN,'-',1,1)+1,INSTR(A.HPN,'-',1,2)-INSTR(A.HPN,'-',1,1)-1)) AS HPN2
   					,DECODE(A.HPN,NULL,'',SUBSTR(A.HPN,INSTR(A.HPN,'-',1,2)+1)) HPN3
   					,A.EML_ID
   					,A.EML_DMI_NM
   					,A.TIT_NM
   					,A.ACP_DPT_CD
   					,F_DPT_INFO(A.ACP_DPT_CD,'1') AS ACP_DPT_NM
   					,A.RCEP_ID
   					,F_USR_INFO_BY_ID(A.RCEP_ID,'2') AS RCEP_NM
   					,A.ACP_DH
   					,A.CVPT_HNDL_STA_CD
   					,B.CVPT_TXT
   					,B.CVPT_SBT
   					,A.DOC_ID
   					,C.REQR_CNT
   					,C.REQR_DVSN_CD
   					,C.OGNZ_PSO_CNT
   			FROM	TBCSPDCP101M A
   					,TBCSPDCP102M B
   					,TBCSPEAR001M C
   			WHERE	1=1
   			AND		A.REQ_DVSN_CD = #strREQ_DVSN_CD#
   			AND		A.ACP_YR = #strACP_YR#
   			AND		A.CVPT_ACP_NO = #strCVPT_ACP_NO#
   			AND		A.REQ_DVSN_CD = B.REQ_DVSN_CD
   			AND		A.ACP_YR = B.ACP_YR
   			AND		A.CVPT_ACP_NO = B.CVPT_ACP_NO
   			AND		A.REQ_DVSN_CD = C.REQ_DVSN_CD(+)
   			AND		A.ACP_YR = C.ACP_YR(+)
   			AND		A.CVPT_ACP_NO = C.CVPT_ACP_NO(+)
		]]>
			
	</select>
	
	<update id="CSPEAR002EDCP101MainUpdate" parameterClass="paramMap">
        <![CDATA[
        	UPDATE	TBCSPDCP101M
        	SET		CVPTR_NM = #CVPTR_NM#
   					,BTDT = #BTDT#
   					,JB_NM = #JB_NM#
   					,RPST_PEN_NM = #RPST_PEN_NM#
   					,BZN = #BZN#
   					,CPNM_NM = #CPNM_NM#
   					,ZCD = #ZCD#
   					,AD = #AD#
   					,DTL_AD = #DTL_AD#
   					,TNB = DECODE(#TNB1#,NULL,'',#TNB1#||'-'||#TNB2#||'-'||#TNB3#)
   					,HPN = DECODE(#HPN1#,NULL,'',#HPN1#||'-'||#HPN2#||'-'||#HPN3#)
   					,EML_ID = #EML_ID#
   					,EML_DMI_NM = #EML_DMI_NM#
   					,TIT_NM = #TIT_NM#
   					,DOC_ID = #DOC_ID#
   					,DOC_TYP_CD = #DOC_TYP_CD#
   					,FNL_USR_ID = #FNL_USR_ID#
   					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
   					,FNL_MNU_ID = #FNL_MNU_ID#
   					,FNL_MDF_DH = SYSDATE
   			WHERE	REQ_DVSN_CD = #REQ_DVSN_CD#
   			AND		ACP_YR = #ACP_YR#
   			AND		CVPT_ACP_NO = #CVPT_ACP_NO#
       	]]>
	</update>
	
	<insert id="CSPEAR002EEAR001Merge" parameterClass="paramMap">
        <![CDATA[
        	MERGE INTO 	TBCSPEAR001M A
        	USING 	(	SELECT 	#REQ_DVSN_CD# AS REQ_DVSN_CD 
        						,#ACP_YR# AS ACP_YR
        						,#CVPT_ACP_NO# AS CVPT_ACP_NO
        				FROM DUAL
        			) B
        	ON		(	A.REQ_DVSN_CD = B.REQ_DVSN_CD
        				AND	A.ACP_YR = B.ACP_YR
        				AND A.CVPT_ACP_NO = B.CVPT_ACP_NO
        			)
        	WHEN MATCHED THEN
        			UPDATE	
        			SET		REQR_DVSN_CD = #REQR_DVSN_CD#
        					,REQR_CNT = #REQR_CNT#
        					,OGNZ_PSO_CNT = #OGNZ_PSO_CNT#
        					,FNL_USR_ID = #FNL_USR_ID#
        					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
        					,FNL_MNU_ID = #FNL_MNU_ID#
        					,FNL_MDF_DH = SYSDATE
        	WHEN NOT MATCHED THEN
		        	INSERT 		(	REQ_DVSN_CD
		        					,ACP_YR
		        					,CVPT_ACP_NO
		        					,REQR_DVSN_CD
		        					,REQR_CNT
		        					,OGNZ_PSO_CNT
		        					,FRT_USR_ID
		        					,FNL_USR_ID
		        					,FNL_DEAL_DPT_CD
		        					,FNL_MNU_ID
		        					,FRT_REGI_DH
		        					,FNL_MDF_DH
		        				)
		        		VALUES	(	#REQ_DVSN_CD#
									,#ACP_YR#
									,#CVPT_ACP_NO#
									,#REQR_DVSN_CD#
		        					,#REQR_CNT#
		        					,#OGNZ_PSO_CNT#
		        					,F_USR_INFO(#S_CNB#,'1')
									,#FNL_USR_ID#
									,#FNL_DEAL_DPT_CD#
									,#FNL_MNU_ID#
									,SYSDATE
									,SYSDATE
								)
        ]]>
	</insert>
	
	<update id="CSPEAR002EDCP101DtmAcpUpdate" parameterClass="paramMap">
        <![CDATA[
        	UPDATE	TBCSPDCP101M
        	SET		CVPT_HNDL_STA_CD = '20'
   					,FNL_USR_ID = #FNL_USR_ID#
   					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
   					,FNL_MNU_ID = #FNL_MNU_ID#
   					,FNL_MDF_DH = SYSDATE
 		]]>
   			<isEqual property="CVPT_HNDL_STA_CD" compareValue="10">
   				,RCEP_ID = #FNL_USR_ID#
   				,ACP_DPT_CD = #FNL_DEAL_DPT_CD#
   			</isEqual>
   			<![CDATA[
   			WHERE	REQ_DVSN_CD = #REQ_DVSN_CD#
   			AND		ACP_YR = #ACP_YR#
   			AND		CVPT_ACP_NO = #CVPT_ACP_NO#
       	]]>
	</update>
	
	<update id="CSPEAR002EDCP101DtmUpdate" parameterClass="paramMap">
        <![CDATA[
        	UPDATE	TBCSPDCP101M
        	SET		CVPT_HNDL_STA_CD = #CVPT_HNDL_STA_CD#
   					,FNL_USR_ID = #FNL_USR_ID#
   					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
   					,FNL_MNU_ID = #FNL_MNU_ID#
   					,FNL_MDF_DH = SYSDATE
   			WHERE	REQ_DVSN_CD = #REQ_DVSN_CD#
   			AND		ACP_YR = #ACP_YR#
   			AND		CVPT_ACP_NO = #CVPT_ACP_NO#
       	]]>
	</update>
	
	<update id="CSPEAR002EEAR006Insert" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO	TBCSPEAR006H
        				(	REQ_DVSN_CD
        					, ACP_YR
        					, CVPT_ACP_NO
        					, SRNO
        					, DTB_DPT_CD
        					, DTB_PEN_ID
        					, CVPT_HNDL_STA_CD
        					, HNDL_DPT_CD
        					, HNDL_CHGR_ID
        					, FRT_USR_ID
        					, FNL_USR_ID
        					, FNL_DEAL_DPT_CD
        					, FNL_MNU_ID
        					, FRT_REGI_DH
        					, FNL_MDF_DH
        				)
        		VALUES	(	#REQ_DVSN_CD#
        					, #ACP_YR#
        					, #CVPT_ACP_NO#
        					, (	SELECT 	NVL(MAX(SRNO),0)+1
        						FROM	TBCSPEAR006H
        						WHERE	REQ_DVSN_CD = #REQ_DVSN_CD#
					   			AND		ACP_YR = #ACP_YR#
					   			AND		CVPT_ACP_NO = #CVPT_ACP_NO# )
					   		, F_USR_INFO(#S_CNB#, '5')
					   		, F_USR_INFO(#S_CNB#, '1')
        					, #CVPT_HNDL_STA_CD#
        					, #HNDL_DPT_CD#
        					, #HNDL_CHGR_ID#
        					, F_USR_INFO(#S_CNB#, '1')
        					, #FNL_USR_ID#
        					, #FNL_DEAL_DPT_CD#
        					, #FNL_MNU_ID#
        					, SYSDATE
        					, SYSDATE
        				)
       	]]>
	</update>
	
	<select id="CSPEAR002EDCP101Check" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	CVPT_HNDL_STA_CD	/*진행상태*/
					,F_CODE_NM('1000361',A.CVPT_HNDL_STA_CD) AS CVPT_HNDL_STA_NM
			FROM	TBCSPDCP101M A
			WHERE	REQ_DVSN_CD = #REQ_DVSN_CD#
			AND		ACP_YR = #ACP_YR#
			AND		CVPT_ACP_NO = #CVPT_ACP_NO#
		]]>
	</select>
	
</sqlMap> 
