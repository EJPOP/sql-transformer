<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/cis/303">

	<select id="CSPCIS303PSelectAuth" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END AS AUTH_YN
			  FROM TBDCMACM013C T1
			 WHERE 1=1
			   AND T1.CMM_CD_DVSN_CD = '1000868'
			   AND T1.CD = #strCNB#
			   AND T1.USR_DFN_TXT_2 = 'Y'
		]]>
	</select>
	
	<select id="CSPCIS303PSelectMainList" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT T1.SRNO
				  ,T1.APN_CNB
				  ,F_USR_INFO(T1.APN_CNB, '2') AS APN_NAM
				  ,T1.TIT_NM
				  ,T1.APL_DT
				  ,T1.CHGR_CD
				  ,F_CODE_NM('1000868', T1.CHGR_CD) AS CHGR_NM
				  ,T1.EXTL_CHGR_YN
				  ,T1.HPN
				  ,T1.DOC_ID
				  ,T1.DTL_TXT
				  ,T1.MSG_SEN_YN
				  ,T1.HNDL_STEP_CD 
				  ,NVL((SELECT S1.HOM_TNB
				      FROM TBDCMACM001M S1 
				     WHERE S1.CNB = T1.APN_CNB
				   ),'02-2011-2999') AS APN_HPN
				  ,DECODE(T1.EXTL_CHGR_YN,'Y',NULL,T1.HPN) as HPN2
			  FROM TBCSPCIS005M T1
			 WHERE 1=1
		]]>
		
		<dynamic>
			<isNotEqual property="AUTH_YN" compareValue="Y">
			<![CDATA[
				AND (APN_CNB = #strCNB# OR (CHGR_CD = #strCNB# AND NVL(EXTL_CHGR_YN,'N') <> 'Y'))
			]]>
			</isNotEqual>
		</dynamic>
		<![CDATA[
			ORDER BY T1.SRNO DESC
		]]>
	</select>
	
	
	<select id="CSPCIS303PKeySelect" parameterClass="paramMap" resultClass="Integer">
		<![CDATA[
			SELECT TBCSPCIS005M_SEQ.NEXTVAL
			  FROM DUAL
		]]>
	</select>
	
	<insert id="CSPCIS303PMainInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPCIS005M
							(  SRNO
							 , APN_CNB
							 , TIT_NM
							 , CHGR_CD
							 , EXTL_CHGR_YN
							 , DOC_ID
							 , DTL_TXT
							 , HNDL_STEP_CD
							 , FRT_USR_ID
							 , FNL_USR_ID
							 , FNL_DEAL_DPT_CD
							 , FNL_MNU_ID
							 , FRT_REGI_DH
							 , FNL_MDF_DH
							 , HPN
							)
					VALUES (   #SRNO#
					         , #APN_CNB#
					         , #TIT_NM#
					         , #CHGR_CD#
					         , #EXTL_CHGR_YN#
					         , #DOC_ID#
					         , #DTL_TXT#
					         , '01'
					         , #FRT_USR_ID#
					         , #FNL_USR_ID#
					         , #FNL_DEAL_DPT_CD#
					         , #FNL_MNU_ID#
					         , SYSDATE
					         , SYSDATE
					         , #HPN#
					       )
		]]>
	</insert>
	
	<update id="CSPCIS303PMainUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBCSPCIS005M T1
			   SET T1.TIT_NM = #TIT_NM#
			     , T1.CHGR_CD = #CHGR_CD#
			     , T1.EXTL_CHGR_YN = #EXTL_CHGR_YN#
			     , T1.DOC_ID = #DOC_ID#
			     , T1.DTL_TXT = #DTL_TXT#
			     , T1.FNL_USR_ID = #FNL_USR_ID#
			     , T1.FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
			     , T1.FNL_MNU_ID = #FNL_MNU_ID#
			     , T1.FNL_MDF_DH = SYSDATE
			     , T1.HPN = #HPN#
			 WHERE T1.SRNO = #SRNO#
		]]>
	</update>
	
	<select id="CSPCIS303PSelectCodeList" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT CASE WHEN T1.USR_DFN_TXT_3 = 'Y' THEN T1.USR_DFN_TXT_1
						ELSE (SELECT HOM_TNB FROM TBDCMACM001M S1 WHERE S1.CNB = #strCHGR_CD#) 
				   END AS HPN
			      ,T1.USR_DFN_TXT_3 AS EXTL_CHGR_YN
			  FROM TBDCMACM013C T1
			 WHERE T1.CMM_CD_DVSN_CD = '1000868'
			   AND T1.CD = #strCHGR_CD#
		]]>
	</select>
	
	<update id="CSPCIS303PSendUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBCSPCIS005M T1
			   SET T1.APL_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
			     , HNDL_STEP_CD = '02'
			     , T1.FNL_USR_ID = #FNL_USR_ID#
			     , T1.FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
			     , T1.FNL_MNU_ID = #FNL_MNU_ID#
			     , T1.FNL_MDF_DH = SYSDATE
			 WHERE T1.SRNO = #SRNO#
		]]>
	</update>
	
	<delete id="CSPCIS303PMainDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE
			  FROM TBCSPCIS005M
			 WHERE SRNO = #SRNO# 
		]]>
	</delete>
	
	<update id="CSPCIS303PSend2Update" parameterClass="paramMap">
		<![CDATA[
			UPDATE TBCSPCIS005M
			   SET MSG_SEN_YN = 'Y'
			 WHERE SRNO = #SRNO#
		]]>
	</update>
</sqlMap> 
