<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/bii/112">
	<!-- 특정정보 목록 조회 -->   
	<select id="CSPBII112ESpcfInfSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT A.SPCF_INF_CLC_NO AS CD    /* 특정정보수집번호 */
			     , A.SPCF_AUD_SBJ    AS CD_NM /* 특정감사사항 */
			  FROM TBCSPBII140M A  /* 특정정보수집기간기본 */
			 WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A.STR_DT AND A.END_DT
			ORDER BY DECODE(A.SPCF_INF_CLC_NO,'4','2',A.SPCF_INF_CLC_NO)
		]]>
	</select>
	<select id="CSPBII112ESpcfInfSelect2" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT A.SPCF_INF_CLC_NO AS CD    /* 특정정보수집번호 */
			     , A.SPCF_AUD_SBJ    AS CD_NM /* 특정감사사항 */
			  FROM TBCSPBII140M A  /* 특정정보수집기간기본 */
			ORDER BY DECODE(A.SPCF_INF_CLC_NO,'4','2',A.SPCF_INF_CLC_NO)
		]]>
	</select>
	<!-- 소관(처리)부서 자동 세팅 -->
	<select id="CSPBII112EHndlDptSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[   
			SELECT B.DPT_CD
			     , B.DPT_NM
			  FROM TBDCMACM015M A
			     , TBDCMACM002M B			          
			 WHERE A.ENFM_DPT_CD = B.DPT_CD
			   AND A.ORG_CD      = #strRelOrgCd#
		]]>
	</select>
	
	<!-- 감사정보기본 키 생성 -->
	<select id="CSPBII112EMainKeyValueSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT TO_CHAR(SYSDATE, 'YYYY')               AS YE   /* 연도 */
			     , (SELECT NVL(MAX(SRNO), 0) + 1
		              FROM TBCSPBII100M
		             WHERE YE = TO_CHAR(SYSDATE, 'YYYY')) AS SRNO /* 일련번호 */
		      FROM DUAL
		]]>
	</select>
		
	<!-- 감사정보기본 등록  -->
	<insert id="CSPBII112EinsertMain100M" parameterClass="paramMap">
		INSERT INTO TBCSPBII100M (
		                          YE                  /* 연도 */
		                        , SRNO                /* 일련번호 */
		                        , TIT_TXT             /* 제목내용 */
		                        , CLC_DVSN_CD         /* 수집구본코드 */
		                        , SRC_DVSN_CD         /* 출처구분코드 */
		                        , HNDL_ORD_CD         /* 처리유형코드*/
		                        , REL_ORG_CD          /* 관련기관코드  */
		                        , REL_ORG_CD_1        /* 관련기관코드2 */
		                        , REL_ORG_CD_2        /* 관련기관코드3 */
		                        , HNDL_DPT_CD         /* 처리부서코드 */
		                        , AUD_INF_PRSS_STA_CD /* 감사정보진행상태코드[01:제출작성] */
		                        , PRSR_CNB            /* 제출자전산번호 */
		                        , PRSR_RANK_CD        /* 제출자직급코드 */
		                        , PRSR_DPT_CD         /* 제출자부서코드 */
		                        , REGI_DT             /* 등록일 */
		                        , OPEN_YN             /* 공개여부 */
		                        , CVPT_ACP_NO         /* 민원접수번호 */
		                        , ACP_YR              /* 접수년도 */
		                        , REQ_DVSN_CD         /* 청구구분코드 */
		                        , FRT_USR_ID          /* 최초사용자ID */
		                        , FNL_USR_ID          /* 최종사용자ID */
		                        , FNL_DEAL_DPT_CD     /* 최종거래부서코드 */
		                        , FNL_MNU_ID          /* 최종메뉴ID */
		                        , FRT_REGI_DH         /* 최초등록일시 */
		                        , FNL_MDF_DH          /* 최종수정일시 */
		                        , PRSR_DPT_TP_CD
		                        , FDLTY_SC
		                        , RIBLY_SC
		                        , UTL_SC
		                         ) 
		                  VALUES (
		                          #YE#
		                        , #SRNO#
		                        , #TIT_TXT#
		                        , #CLC_DVSN_CD#
		                        , #SRC_DVSN_CD#
		                        , #HNDL_ORD_CD#
		                        , #REL_ORG_CD#
		                        , #REL_ORG_CD_1#
		                        , #REL_ORG_CD_2#	
		                        , NVL(#HNDL_DPT_CD#, (SELECT B.DPT_CD
			                                            FROM TBDCMACM015M A
			                                               , TBDCMACM002M B			          
			                                           WHERE A.ENFM_DPT_CD = B.DPT_CD
			                                             AND A.ORG_CD      = #REL_ORG_CD#))
		                        , '01'	<!-- [01:제출작성] -->
		                        , #PRSR_CNB#
		                        , #PRSR_RANK_CD#
		                        , #PRSR_DPT_CD#
		                        , TO_CHAR(SYSDATE, 'YYYYMMDD')
		                        , #OPEN_YN#
		                        , #CVPT_ACP_NO#
		                        , #ACP_YR#
		                        , #REQ_DVSN_CD#
		                        , #FRT_USR_ID#
		                        , #FNL_USR_ID#
		                        , #FNL_DEAL_DPT_CD#
		                        , #FNL_MNU_ID#
		                        , SYSDATE
		                        , SYSDATE
		                        , (	SELECT	CASE WHEN T1.DPT_CD IN ('062500','062600','062700','062800','170300','170320','071100','071300','180100','180110','100100','081100','081200','081300','081400','081500','081600','081700','081800','081900','0L0100','0L0200','0L0300') 
		                        						THEN 'A'
		                        				ELSE T1.DPT_TP_CD END  
		                        	FROM	TBDCMACM002M T1
		                        	WHERE	T1.DPT_CD = #PRSR_DPT_CD#)
		                        , 0
		                        , 0
		                        , 0
				                 )
	</insert>
	
	<!-- 감사정보기본 수정 -->
	<update id="CSPBII112EupdateMain100M" parameterClass="paramMap">
		UPDATE TBCSPBII100M                       
		   SET TIT_TXT         = #TIT_TXT#           /* 제목내용 */
		     , CLC_DVSN_CD     = #CLC_DVSN_CD#       /* 출처구분코드 */
		     , SRC_DVSN_CD     = #SRC_DVSN_CD#       /* 출처구분코드 */
		     , INF_DVSN_CD     = #INF_DVSN_CD#       /* 정보구분코드*/
		     , REL_ORG_CD      = #REL_ORG_CD#        /* 관련기관코드  */
		     , REL_ORG_CD_1    = #REL_ORG_CD_1#      /* 관련기관코드1 */ 
		     , REL_ORG_CD_2    = #REL_ORG_CD_2#      /* 관련기관코드 2 */
		     , HNDL_DPT_CD     = NVL(#HNDL_DPT_CD#, (SELECT B.DPT_CD
			                                           FROM TBDCMACM015M A
			                                              , TBDCMACM002M B			          
			                                          WHERE A.ENFM_DPT_CD = B.DPT_CD
			                                            AND A.ORG_CD      = #REL_ORG_CD#)) /* 처리부서코드  */
		     , OPEN_YN         = #OPEN_YN#           /* 공개여부  */
		     , CVPT_ACP_NO     = #CVPT_ACP_NO#       /* 민원접수번호 */
		     , ACP_YR          = #ACP_YR#            /* 접수년도 */
		     , REQ_DVSN_CD     = #REQ_DVSN_CD#		 /* 청구구분코드 */      
		     , FNL_USR_ID      = #FNL_USR_ID#        /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#   /* 최종거래부서코드 */
		     , FNL_MNU_ID      = #FNL_MNU_ID#        /* 최종메뉴ID */
		     , FNL_MDF_DH      = SYSDATE             /* 최종수정일시 */
		 WHERE YE = #YE#
		   AND SRNO = #SRNO#
	</update>
	
	<!-- 감사정보기본 삭제 -->
	<delete id="CSPBII112EdeleteMain100M" parameterClass="paramMap">
		DELETE TBCSPBII100M
		 WHERE YE   = #YE#
		   AND SRNO = #SRNO#
	</delete>
	
		
	<!-- 감사정보내역 등록  -->
	<insert id="CSPBII112EinsertMain101L" parameterClass="paramMap">
		INSERT INTO TBCSPBII101L (
		                          YE                 /* 연도 */
		                        , SRNO               /* 일련번호 */
		                        , AUD_INF_TXT        /* 감사정보내용 */
		                        , AUD_INF_ETC_TXT    /* 감사정보기타내용 */
		                        , SCH_AUD_INF_TXT    /* 검색감사정보내용 */		                  
		                        , FRT_USR_ID         /* 최초사용자ID */
		                        , FNL_USR_ID         /* 최종사용자ID */
		                        , FNL_DEAL_DPT_CD    /* 최종거래부서코드 */
		                        , FNL_MNU_ID         /* 최종메뉴ID */
		                        , FRT_REGI_DH        /* 최초등록일시 */
		                        , FNL_MDF_DH         /* 최종수정일시 */
		                        , AUD_INF_ANL_OPIN_TXT
		                         ) 
		                  VALUES (
		                          #YE#
		                        , #SRNO#
		                        , #AUD_INF_TXT#
		                        , #AUD_INF_ETC_TXT#
		                        , #SCH_AUD_INF_TXT#		                        		                      
		                        , #FRT_USR_ID#
		                        , #FNL_USR_ID#
		                        , #FNL_DEAL_DPT_CD#
		                        , #FNL_MNU_ID#
		                        , SYSDATE
		                        , SYSDATE
		                        , #AUD_INF_ANL_OPIN_TXT#
				                 )
	</insert>
	
	<!-- 감사정보내역 수정 -->
	<update id="CSPBII112EupdateMain101L" parameterClass="paramMap">
		UPDATE TBCSPBII101L                       
		   SET AUD_INF_TXT     = #AUD_INF_TXT#       /* 감사정보내용 */
		     , AUD_INF_ETC_TXT = #AUD_INF_ETC_TXT#   /* 감사정보기타내용 */
		     , SCH_AUD_INF_TXT = #SCH_AUD_INF_TXT#   /* 검색감사정보내용 */	
		     , FNL_USR_ID      = #FNL_USR_ID#        /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#   /* 최종거래부서코드 */
		     , FNL_MNU_ID      = #FNL_MNU_ID#        /* 최종메뉴ID */
		     , FNL_MDF_DH      = SYSDATE             /* 최종수정일시 */
		     , AUD_INF_ANL_OPIN_TXT = #AUD_INF_ANL_OPIN_TXT#
		 WHERE YE   = #YE#
		   AND SRNO = #SRNO#
	</update>
	
	<!-- 감사정보내역 삭제 -->
	<delete id="CSPBII112EdeleteMain101L" parameterClass="paramMap">
		DELETE TBCSPBII101L
		 WHERE YE   = #YE#
		   AND SRNO = #SRNO#		   
	</delete>
	
	<!-- 감사정보내역 등록  -->
	<insert id="CSPBII112EinsertMain102L" parameterClass="paramMap">
		MERGE INTO 	TBCSPBII102L A
		USING 	(	SELECT 	#YE#  AS YE
		                        , #SRNO# AS SRNO
        						, 'SP-II-001' AS DOC_TYP_CD
        				FROM DUAL
        			) B
        ON		(	A.YE = B.YE
        				AND	A.SRNO = B.SRNO
        				AND A.DOC_TYP_CD = B.DOC_TYP_CD
        			)
        WHEN MATCHED THEN
        			UPDATE 
        			SET	 DOC_ID = #DOC_ID#
        			     ,FNL_USR_ID =  #FNL_USR_ID#
        			     ,FNL_MDF_DH = SYSDATE
        WHEN NOT MATCHED THEN
		INSERT  (
		                          YE                     /* 연도 */
		                        , SRNO                   /* 일련번호 */
		                        , DOC_TYP_CD             /* 문서유형코드 */
		                        , DOC_ID                 /* 문서ID */
		                        , FRT_USR_ID             /* 최초사용자ID */
		                        , FNL_USR_ID             /* 최종사용자ID */
		                        , FNL_DEAL_DPT_CD        /* 최종거래부서코드 */
		                        , FNL_MNU_ID             /* 최종메뉴ID */
		                        , FRT_REGI_DH            /* 최초등록일시 */
		                        , FNL_MDF_DH             /* 최종수정일시 */
		                         ) 
		                  VALUES (
		                          #YE#
		                        , #SRNO#
		                        , 'SP-II-001' <!-- [SP-II-001:직원제출감사정보] -->
		                        , #DOC_ID#
		                        , #FRT_USR_ID#
		                        , #FNL_USR_ID#
		                        , #FNL_DEAL_DPT_CD#
		                        , #FNL_MNU_ID#
		                        , SYSDATE
		                        , SYSDATE
				                 )
	</insert>

	<!-- 감사정보내역 삭제 -->
	<delete id="CSPBII112EdeleteMain102L" parameterClass="paramMap">
		DELETE TBCSPBII102L
		 WHERE YE   = #YE#
		   AND SRNO = #SRNO#		   
	</delete>
	
	<!-- 감사정보관련자내역 등록  -->
	<insert id="CSPBII112EinsertSub130L" parameterClass="paramMap">
		INSERT INTO TBCSPBII130L (
		                          YE              /* 연도 */
		                        , SRNO            /* 일련번호 */
		                        , REL_PEN_SNO     /* 관련자순번 */
		                        , NAM             /* 성명 */
		                        , EIN             /* 암호화주민등록번호 */
		                        , BTDT		      /* 생년월일 */                      
		                        , BLT_ORG_NM      /* 소속기관명 */
		                        , RANK_NM         /* 직급명 */
		                        , PST_NM          /* 직위명 */               
		                        , FRT_USR_ID      /* 최초사용자ID */
		                        , FNL_USR_ID      /* 최종사용자ID */
		                        , FNL_DEAL_DPT_CD /* 최종거래부서코드 */
		                        , FNL_MNU_ID      /* 최종메뉴ID */
		                        , FRT_REGI_DH     /* 최초등록일시 */
		                        , FNL_MDF_DH      /* 최종수정일시 */
		                         ) 
		                  VALUES (
		                          #YE#
		                        , #SRNO#
		                        , (SELECT NVL(MAX(REL_PEN_SNO), 0) + 1
		                             FROM TBCSPBII130L
		                            WHERE YE   = #YE#
		                              AND SRNO = #SRNO#)
		                        , #NAM#      
		                        , NVL(#EIN#, #RRN#)   /* 암호화주민등록번호(주민등록번호를 6자리 이하로 입력했을 경우 RRN으로 넘어옴) */	
		                        , SUBSTR(#RRN#, 1, 6)
		                        , #BLT_ORG_NM#
		                        , #RANK_NM#
		                        , #PST_NM#	                        		                      
		                        , #FRT_USR_ID#
		                        , #FNL_USR_ID#
		                        , #FNL_DEAL_DPT_CD#
		                        , #FNL_MNU_ID#
		                        , SYSDATE
		                        , SYSDATE
				                 )
	</insert>
	
	<!-- 감사정보관련자내역 수정 -->
	<update id="CSPBII112EupdateSub130L" parameterClass="paramMap">
		UPDATE TBCSPBII130L                       
		   SET NAM             = #NAM#               /* 성명 */
		     , EIN             = NVL(#EIN#, #RRN#)   /* 암호화주민등록번호(주민등록번호를 6자리 이하로 입력했을 경우 RRN으로 넘어옴) */		
		     , BTDT            = SUBSTR(#RRN#, 1, 6) /* 생년월일 */     
		     , BLT_ORG_NM      = #BLT_ORG_NM#        /* 소속기관명 */
		     , RANK_NM         = #RANK_NM#           /* 직급명 */		     		    
		     , PST_NM          = #PST_NM#            /* 직위명 */
		     , FNL_USR_ID      = #FNL_USR_ID#        /* 최종사용자ID */
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#   /* 최종거래부서코드 */
		     , FNL_MNU_ID      = #FNL_MNU_ID#        /* 최종메뉴ID */
		     , FNL_MDF_DH      = SYSDATE             /* 최종수정일시 */
		 WHERE YE          = #YE#
		   AND SRNO        = #SRNO#
		   AND REL_PEN_SNO = #REL_PEN_SNO#
	</update>
	
	<!-- 감사정보관련자내역 삭제 -->
	<delete id="CSPBII112EdeleteSub130L" parameterClass="paramMap">
		DELETE TBCSPBII130L
		 WHERE YE          = #YE#
		   AND SRNO        = #SRNO#	
		   AND REL_PEN_SNO = #REL_PEN_SNO#	   
	</delete>
	
	<select id="CSPBII112EHndlDptSelect2" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[   
			SELECT B.DPT_CD
			     , B.DPT_NM
			  FROM TBCSPBII140M A
			     , TBDCMACM002M B			          
			 WHERE A.SPV_DPT_CD = B.DPT_CD
			   AND A.SPCF_INF_CLC_NO      = #strSPCF_INF_CLC_NO#
			   
		]]>
	</select>
	
	<!-- 조회내역 삭제 -->
	<delete id="CSPBII112EdeleteMain150L" parameterClass="paramMap">
		DELETE TBCSPBII150L
		 WHERE YE          = #YE#
		   AND SRNO        = #SRNO#	
	</delete>	
	
</sqlMap> 
