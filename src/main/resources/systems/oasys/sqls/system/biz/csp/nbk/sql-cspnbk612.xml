<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="csp/nbk/612">

	<typeAlias alias="smbInfoVo" type="org.ebai.iportal.biz.csp.nbk.vo.SmbInfoVO"/>
	
	<resultMap id="smbInfo" class="org.ebai.iportal.biz.csp.nbk.vo.SmbInfoVO">
		<result property="smbDealDt" column="SMB_DEAL_DT"/>
		<result property="smbSln" column="SMB_SLN"/>
		<result property="optMouiNo" column="OPT_MOUI_NO"/>
		<result property="am" column="AM"/>
		<result property="deptsPmtDvsnCd" column="DEPTS_PMT_DVSN_CD"/>
		<result property="ledgKndCd" column="LEDG_KND_CD"/>
		<result property="cnlYn" column="CNL_YN"/>
		<result property="crdtMnstCluCd" column="CRDT_MNST_CLU_CD"/>
		<result property="crdtTaxSitmCd" column="CRDT_TAX_SITM_CD"/>
		<result property="crdtAcctNm" column="CRDT_ACCT_NM"/>
		<result property="crdtAm" column="CRDT_AM"/>
		<result property="dsMnstCluCd" column="DS_MNST_CLU_CD"/>
		<result property="dsTaxSitmCd" column="DS_TAX_SITM_CD"/>
		<result property="dsAcctNm" column="DS_ACCT_NM"/>
		<result property="dsAm" column="DS_AM"/>
	</resultMap>
	
	<select id="CSPNBK612PBSInfoCntSelect" parameterClass="paramMap" resultClass="int">
	<![CDATA[
		SELECT	/* CSPNBK612PBSInfoCntSelect */
				COUNT(DEAL_DT)
		FROM	TBCSPNBK502M D1
	]]>
		<dynamic prepend="WHERE">
			<isNotEmpty property="DEAL_DT" prepend="AND">
					D1.DEAL_DT = #DEAL_DT#
			</isNotEmpty>
			<isEmpty property="DEAL_DT" prepend="AND">
					D1.DEAL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
			</isEmpty>
			<isNotEmpty property="MNST_CLU_CD" prepend="AND">
					D1.MNST_CLU_CD = #MNST_CLU_CD#
			</isNotEmpty>
			<isNotEmpty property="TAX_SITM_CD" prepend="AND">
					D1.TAX_SITM_CD = #TAX_SITM_CD#
			</isNotEmpty>
		</dynamic>
	</select>
	
	<insert id="CSPNBK612PBSInfoPreCopyInsert" parameterClass="paramMap">
	<![CDATA[
		INSERT INTO /* CSPNBK612PBSInfoPreCopyInsert */ TBCSPNBK502M
		(
			DEAL_DT
			, MNST_CLU_CD
			, TAX_SITM_CD
			, AM
			, CRDT_AGG_AM
			, CRDT_NOC
			, DS_AGG_AM
			, DS_NOC
			, YRLY_CRDT_AGG_AM
			, YRLY_CRDT_NOC
			, YRLY_DS_AGG_AM
			, YRLY_DS_NOC
			, CLSNG_YN
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		)
		SELECT	
	]]>
		<isNotEmpty property="DEAL_DT">
				#DEAL_DT# AS DEAL_DT
		</isNotEmpty>
		<isEmpty property="DEAL_DT">
				TO_CHAR(SYSDATE, 'YYYYMMDD') AS DEAL_DT
		</isEmpty>
	<![CDATA[
				, D2.MNST_CLU_CD
				, D2.TAX_SITM_CD
				, D2.AM
				, 0 AS CRDT_AGG_AM
				, 0 AS CRDT_NOC
				, 0 AS DS_AGG_AM
				, 0 AS DS_NOC
				, YRLY_CRDT_AGG_AM
				, YRLY_CRDT_NOC
				, YRLY_DS_AGG_AM
				, YRLY_DS_NOC
				, 'N' AS CLSNG_YN
				, #USR_ID# AS FRT_USR_ID
				, #USR_ID# AS FNL_USR_ID
				, #DPT_CD# AS FNL_DEAL_DPT_CD
				, #MNU_ID# AS FNL_MNU_ID
				, SYSDATE AS FRT_REGI_DH
				, SYSDATE AS FNL_MDF_DH
		FROM	TBCSPNBK502M D2
		WHERE	D2.DEAL_DT = (
								SELECT	MAX(D1.DEAL_DT)
								FROM	TBCSPNBK502M D1
							)
	]]>
		<isNotEmpty property="MNST_CLU_CD" prepend="AND">
				D2.MNST_CLU_CD = #MNST_CLU_CD#
		</isNotEmpty>
		<isNotEmpty property="TAX_SITM_CD" prepend="AND">
				D2.TAX_SITM_CD = #TAX_SITM_CD#
		</isNotEmpty>
	</insert>
	
	<insert id="CSPNBK612PBSInfoInsert" parameterClass="paramMap">
	<![CDATA[
		INSERT INTO /* CSPNBK612PBSInfoInsert */ TBCSPNBK502M
		(
			DEAL_DT
			, MNST_CLU_CD
			, TAX_SITM_CD
			, AM
			, CRDT_AGG_AM
			, CRDT_NOC
			, DS_AGG_AM
			, DS_NOC
			, YRLY_CRDT_AGG_AM
			, YRLY_CRDT_NOC
			, YRLY_DS_AGG_AM
			, YRLY_DS_NOC
			, CLSNG_YN
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		)
		VALUES
		(
			#DEAL_DT#
			, #MNST_CLU_CD#
			, #TAX_SITM_CD#
			, 0
			, 0
			, 0
			, 0
			, 0
			, 0
			, 0
			, 0
			, 0
			, 'N'
			, #USR_ID#
			, #USR_ID#
			, #DPT_CD#
			, #MNU_ID#
			, SYSDATE
			, SYSDATE
		)
	]]>
	</insert>
	
	<update id="CSPNBK612PBSInfoUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK612PBSInfoUpdate */ TBCSPNBK502M
		SET		AM = AM + #AM#
	]]>
		<isEqual property="DEPTS_PMT_DVSN_CD" compareValue="C">
				, CRDT_AGG_AM = CRDT_AGG_AM + #AGG_AM#
				, CRDT_NOC = CRDT_NOC + #CNT#
				, YRLY_CRDT_AGG_AM = YRLY_CRDT_AGG_AM + #AGG_AM#
				, YRLY_CRDT_NOC = YRLY_CRDT_NOC + #CNT#
		</isEqual>
		<isEqual property="DEPTS_PMT_DVSN_CD" compareValue="D">
				, DS_AGG_AM = DS_AGG_AM + #AGG_AM#
				, DS_NOC = DS_NOC + #CNT#
				, YRLY_DS_AGG_AM = YRLY_DS_AGG_AM + #AGG_AM#
				, YRLY_DS_NOC = YRLY_DS_NOC + #CNT#
		</isEqual>
	<![CDATA[
				, FNL_USR_ID = #USR_ID#
				, FNL_DEAL_DPT_CD = #DPT_CD#
				, FNL_MNU_ID = #MNU_ID#
				, FNL_MDF_DH = SYSDATE
		WHERE	DEAL_DT = #DEAL_DT#
		AND		MNST_CLU_CD = #MNST_CLU_CD#
		AND		TAX_SITM_CD = #TAX_SITM_CD#
	]]>
	</update>
	
	<select id="CSPNBK612PNewSmbSlnSelect" parameterClass="smbInfoVo" resultClass="String">
	<![CDATA[
		SELECT	/* CSPNBK612PNewSmbSlnSelect */
				NVL(MAX(D1.SMB_SLN), 0) + 1 AS SMB_SLN
		FROM	TBCSPNBK301M D1
		WHERE	D1.SMB_DEAL_DT = #smbDealDt#
	]]>
	</select>
	
	<insert id="CSPNBK612PSmbInfoInsert" parameterClass="smbInfoVo">
	<![CDATA[
		INSERT INTO /* CSPNBK612PSmbInfoInsert */ TBCSPNBK301M
		(
			SMB_DEAL_DT
			, SMB_SLN
			, OPT_MOUI_NO
			, PET_DH
			, AM
			, DEPTS_PMT_DVSN_CD
			, LEDG_KND_CD
			, CNL_YN
			, CRDT_MNST_CLU_CD
			, CRDT_TAX_SITM_CD
			, DS_MNST_CLU_CD
			, DS_TAX_SITM_CD
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		)
		VALUES
		(
			#smbDealDt#
			, #smbSln#
			, #optMouiNo#
			, SYSDATE
			, #am#
			, #deptsPmtDvsnCd#
			, #ledgKndCd#
			, 'N'
			, #crdtMnstCluCd#
			, #crdtTaxSitmCd#
			, #dsMnstCluCd#
			, #dsTaxSitmCd#
			, #usrId#
			, #usrId#
			, #dptCd#
			, #mnuId#
			, SYSDATE
			, SYSDATE
		)
	]]>
	</insert>
	
	<update id="CSPNBK612PSmbInfoUpdate" parameterClass="smbInfoVo">
	<![CDATA[
		UPDATE	/* CSPNBK612PSmbInfoUpdate */ TBCSPNBK301M
		SET		FNL_USR_ID = #usrId#
				, FNL_DEAL_DPT_CD = #dptCd#
				, FNL_MNU_ID = #mnuId#
				, FNL_MDF_DH = SYSDATE
				, CNL_YN = #cnlYn#
				, CNL_OPT_MOUI_NO = #optMouiNo#
				, CNL_PET_DH = SYSDATE
		WHERE	SMB_DEAL_DT = #smbDealDt#
		AND		SMB_SLN = #smbSln#
	]]>
	</update>
	
	<insert id="CSPNBK612PSmbIjInfoInsert" parameterClass="smbInfoVO">
	<![CDATA[
		INSERT INTO /* CSPNBK612PSmbIjInfoInsert */ TBCSPNBK302L
		 (
		 	SLIP_DEAL_DT
		 	, SLIP_SLN
		 	, OPT_MOUI_NO
		 	, PET_DH
		 	, AM
		 	, DEPTS_PMT_DVSN_CD
		 	, CRDT_MNST_CLU_CD
		 	, CRDT_TAX_SITM_CD
		 	, DS_MNST_CLU_CD
		 	, DS_TAX_SITM_CD
		 	, RMK
		 	, CNL_YN
	]]>
		<isEqual property="cnlYn" compareValue="Y">
			
		 	, CNL_OPT_MOUI_NO
		 	, CNL_PET_DH
		 	, CNL_RMK
		</isEqual>
	<![CDATA[
		 	, SMB_DEAL_DT
		 	, SMB_SLN
		 	, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			, FNL_MDF_DH
		 )
		 VALUES
		 (
		 	#smbDealDt#	
		 	, ( SELECT NVL(MAX(D1.SLIP_SLN), 0) + 1 FROM TBCSPNBK302L D1 WHERE D1.SLIP_DEAL_DT = #smbDealDt# )
		 	, #optMouiNo#
		 	, SYSDATE
		 	, #am#
		 	, #deptsPmtDvsnCd#
		 	, #crdtMnstCluCd#
		 	, #crdtTaxSitmCd#
		 	, #dsMnstCluCd#
		 	, #dsTaxSitmCd#
		 	, #rmk#
		 	, DECODE(#cnlYn#, 'Y', 'Y', 'N')
	]]>
		<isEqual property="cnlYn" compareValue="Y">
		 	, #optMouiNo#
		 	, SYSDATE
		 	, #cnlRmk#
		</isEqual>
	<![CDATA[
		 	, #smbDealDt#
		 	, #smbSln#
		 	, #usrId#
			, #usrId#
			, #dptCd#
			, #mnuId#
			, SYSDATE
			, SYSDATE
		 )
	]]>
	</insert>
	
	<update id="CSPNBK612PSmbIjCancelUpdate" parameterClass="smbInfoVO">
	<![CDATA[
		UPDATE	TBCSPNBK302L D1
		SET		D1.CNL_YN = 'N'
				, D1.CNL_OPT_MOUI_NO = #optMouiNo#
				, D1.CNL_PET_DH = SYSDATE
				, D1.CNL_RMK = #cnlRmk#
		WHERE	D1.SMB_DEAL_DT = #smbDealDt#
		AND		D1.SMB_SLN = #smbSln#
	]]>
	</update>
	
	<select id="CSPNBK612PSmbInfoSelect" parameterClass="smbInfoVO" resultMap="smbInfo">
	<![CDATA[
		SELECT	/* CSPNBK612PSmbInfoSelect */ D1.SMB_DEAL_DT
				, D1.SMB_SLN
				, D1.OPT_MOUI_NO
				, D1.AM
				, D1.DEPTS_PMT_DVSN_CD
				, D1.LEDG_KND_CD
				, D1.CNL_YN
				, D1.CNL_OPT_MOUI_NO
				, D1.CRDT_MNST_CLU_CD
				, D1.CRDT_TAX_SITM_CD
				, (
					SELECT	ACCT_NM
					FROM	TBCSPNBK501M D2
					WHERE	D2.MNST_CLU_CD = D1.CRDT_MNST_CLU_CD
					AND		D2.TAX_SITM_CD = D1.CRDT_TAX_SITM_CD
				) AS CRDT_ACCT_NM
				, DECODE( D1.DEPTS_PMT_DVSN_CD, 'C', D1.AM ) AS CRDT_AM
				, D1.DS_MNST_CLU_CD
				, D1.DS_TAX_SITM_CD
				, (
					SELECT	ACCT_NM
					FROM	TBCSPNBK501M D2
					WHERE	D2.MNST_CLU_CD = D1.DS_MNST_CLU_CD
					AND		D2.TAX_SITM_CD = D1.DS_TAX_SITM_CD
				) AS DS_ACCT_NM
				, DECODE( D1.DEPTS_PMT_DVSN_CD, 'D', D1.AM ) AS DS_AM
		FROM	TBCSPNBK301M D1
		WHERE	D1.SMB_DEAL_DT = #smbDealDt#
		AND		D1.SMB_SLN = #smbSln#
	]]>
	</select>
</sqlMap>