<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/fpl/002">

	<resultMap class="java.util.HashMap" id="hwpDocMap">
		
		<result property="TOTAL_ANS_NO" column="TOTAL_ANS_NO" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="QSTNAI_YR" column="QSTNAI_YR" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="QSTNAI_NO" column="QSTNAI_NO" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="DTIL_ANS_NO" column="DTIL_ANS_NO" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="CHGR_NM" column="CHGR_NM" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="CHGR_ID" column="CHGR_ID" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="CHR_DPT_NM" column="CHR_DPT_NM" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="QUE_TXT" column="QUE_TXT" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="NTAS_RQ_MTRL_HNDL_STA_CD" column="NTAS_RQ_MTRL_HNDL_STA_CD"
			jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="CMTR_NM" column="CMTR_NM" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="RQ_DT" column="RQ_DT" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="SMT_RQ_DT" column="SMT_RQ_DT" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="RET_RSN_TXT" column="RET_RSN_TXT" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="ETC_DOC_ID" column="ETC_DOC_ID" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="HWP_DOC_ID" column="HWP_DOC_ID" jdbcType="VARCHAR2"
			javaType="java.lang.String" />
		<result property="QSTNAIPDF_DOC_ID" column="QSTNAIPDF_DOC_ID"
			jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="QSTNAIHWP_DOC_ID" column="QSTNAIHWP_DOC_ID"
			jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="QSTNAIETC_DOC_ID" column="QSTNAIETC_DOC_ID"
			jdbcType="VARCHAR2" javaType="java.lang.String" />
			<result property="HWP_TEXT" column="HWP_TEXT" jdbcType="CLOB"
			javaType="java.lang.String" />
	</resultMap>

	<!-- 질의서목록 조회 -->
	<select id="CSPFPL002hwpSelect" parameterClass="paramMap"
		resultMap="hwpDocMap">
        <![CDATA[       
			SELECT D2.QSTNAI_YR||'-'||D2.QSTNAI_NO||'-'||D2.DTIL_ANS_NO||'-'||D2.DTIL_DVSN_NO         AS TOTAL_ANS_NO			/*세부질의번호*/
			     , D2.QSTNAI_YR   AS QSTNAI_YR  	/*질의서년도*/
			     , D2.QSTNAI_NO   AS QSTNAI_NO  	/*질의서번호*/
			     , D2.DTIL_ANS_NO   AS DTIL_ANS_NO  	/*세부답변번호*/
			     , D2.DTIL_DVSN_NO   AS DTIL_DVSN_NO  	/*세부구분번호*/
			     , D2.CHGR_NM   AS CHGR_NM  	/*담당자명*/
			     , D2.CHGR_ID   AS CHGR_ID  	/*담당자ID*/
			     , D2.CHR_DPT_NM    AS CHR_DPT_NM        /*담당부서명*/
			     , D2.QUE_TXT     AS QUE_TXT		/*질의내용*/
			     , D2.ANS_MTRL_TXT     AS HWP_TEXT		/*질의내용*/
			     , D2.RET_RSN_TXT     AS RET_RSN_TXT		/*반려사유*/
			     , F_CODE_NM ('1000374',decode(D2.NTAS_RQ_MTRL_HNDL_STA_CD, '20', '30', D2.NTAS_RQ_MTRL_HNDL_STA_CD)) AS NTAS_RQ_MTRL_HNDL_STA_CD /*처리상태코드*/
		        ,( SELECT Z1.CMTR_NM
		             FROM TBCSPFPL001M Z1
		            WHERE Z1.QSTNAI_YR=D2.QSTNAI_YR
		              and Z1.QSTNAI_NO=D2.QSTNAI_NO) AS CMTR_NM /*위원명*/,
		        ( SELECT Z1.RQ_DT
		             FROM TBCSPFPL001M Z1
		            WHERE Z1.QSTNAI_YR=D2.QSTNAI_YR
		              and Z1.QSTNAI_NO=D2.QSTNAI_NO) AS RQ_DT /*요청일자*/,
		        ( SELECT Z1.SMT_RQ_DT
		             FROM TBCSPFPL001M Z1
		            WHERE Z1.QSTNAI_YR=D2.QSTNAI_YR
		              and Z1.QSTNAI_NO=D2.QSTNAI_NO) AS SMT_RQ_DT /*제출일자*/,
		        ( SELECT D6.DOC_ID AS DOC_ID
		             FROM TBCSPFPL006M D6
		            WHERE D2.QSTNAI_YR=D6.QSTNAI_YR
		              and D2.QSTNAI_NO=D6.QSTNAI_NO
		              AND D6.NTAS_RQ_MTRL_DOC_KND_CD = 'A1') AS QSTNAIPDF_DOC_ID,
		        ( SELECT D6.DOC_ID AS DOC_ID
		             FROM TBCSPFPL006M D6
		            WHERE D2.QSTNAI_YR=D6.QSTNAI_YR
		              and D2.QSTNAI_NO=D6.QSTNAI_NO
		              AND D6.NTAS_RQ_MTRL_DOC_KND_CD = 'A2') AS QSTNAIHWP_DOC_ID,
		        ( SELECT D6.DOC_ID AS DOC_ID
		             FROM TBCSPFPL006M D6
		            WHERE D2.QSTNAI_YR=D6.QSTNAI_YR
		              and D2.QSTNAI_NO=D6.QSTNAI_NO
		              AND D6.NTAS_RQ_MTRL_DOC_KND_CD = 'A3') AS QSTNAIETC_DOC_ID,
		        ( SELECT D7.DOC_ID AS DOC_ID
		             FROM TBCSPFPL007M D7
		            WHERE D2.QSTNAI_YR=D7.QSTNAI_YR
		              and D2.QSTNAI_NO=D7.QSTNAI_NO
		              and D2.DTIL_ANS_NO=D7.DTIL_ANS_NO
		              and D2.DTIL_DVSN_NO=D7.DTIL_DVSN_NO
		              AND D7.NTAS_RQ_MTRL_DOC_KND_CD = 'B2') AS ETC_DOC_ID,
		        ( SELECT D7.DOC_ID AS DOC_ID
		             FROM TBCSPFPL007M D7
		            WHERE D2.QSTNAI_YR=D7.QSTNAI_YR
		              and D2.QSTNAI_NO=D7.QSTNAI_NO
		              and D2.DTIL_ANS_NO=D7.DTIL_ANS_NO
		              and D2.DTIL_DVSN_NO=D7.DTIL_DVSN_NO
		              AND D7.NTAS_RQ_MTRL_DOC_KND_CD = 'B1') AS HWP_DOC_ID
			  FROM TBCSPFPL002M D2
			  where 1=1
				AND QSTNAI_YR=#strQstnaiYr#
				AND QSTNAI_NO=#strQstnaiNo#
				AND DTIL_ANS_NO = #strDtilAnsNo#
				AND DTIL_DVSN_NO = #strDtilDvsnAnsNo#
		]]>
	</select>

	<!-- 질의서목록 조회 -->
	<select id="CSPFPL002AnsListSelect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[       
			SELECT D2.QSTNAI_YR||'-'||D2.QSTNAI_NO||'-'||D2.DTIL_ANS_NO||'-'||D2.DTIL_DVSN_NO         AS TOTAL_ANS_NO			/*세부질의번호*/
			     , D2.QSTNAI_YR   AS QSTNAI_YR  	/*질의서년도*/
			     , D2.QSTNAI_NO   AS QSTNAI_NO  	/*질의서번호*/
			     , D2.DTIL_ANS_NO   AS DTIL_ANS_NO  	/*세부답변번호*/
			     , D2.DTIL_DVSN_NO   AS DTIL_DVSN_NO  	/*세부구분번호*/
			     , D2.CHGR_NM   AS CHGR_NM  	/*담당자명*/
			     , D2.CHGR_ID   AS CHGR_ID  	/*담당자ID*/
			     , D2.CHR_DPT_NM    AS CHR_DPT_NM        /*담당부서명*/
			     , D2.QUE_TXT     AS QUE_TXT		/*질의내용*/
			     , D2.SMT_DT     AS SMT_DT		/*제출일*/
				 , (SELECT Z1.NTAS_SMT_DDLN_DT FROM TBCSPFPL001M Z1 WHERE	Z1.QSTNAI_YR=D2.QSTNAI_YR and Z1.QSTNAI_NO=D2.QSTNAI_NO) AS NTAS_SMT_DDLN_DT /*국회제출기한*/
			     , decode(D2.NTAS_RQ_MTRL_HNDL_STA_CD, '20', '30', D2.NTAS_RQ_MTRL_HNDL_STA_CD) AS NTAS_RQ_MTRL_HNDL_STA_CD /*처리상태코드*/
			     , (SELECT Z1.CMTR_NM FROM TBCSPFPL001M Z1 WHERE	Z1.QSTNAI_YR=D2.QSTNAI_YR and Z1.QSTNAI_NO=D2.QSTNAI_NO) AS CMTR_NM /*위원명*/
			     , (SELECT Z1.RQ_DT FROM TBCSPFPL001M Z1 WHERE	Z1.QSTNAI_YR=D2.QSTNAI_YR and Z1.QSTNAI_NO=D2.QSTNAI_NO) AS RQ_DT /*요청일자*/
			     , (SELECT Z1.SMT_RQ_DT FROM TBCSPFPL001M Z1 WHERE	Z1.QSTNAI_YR=D2.QSTNAI_YR and Z1.QSTNAI_NO=D2.QSTNAI_NO) AS SMT_RQ_DT /*제출일자*/
   			     , (SELECT D7.DOC_ID AS DOC_ID FROM TBCSPFPL007M D7 WHERE D2.QSTNAI_YR=D7.QSTNAI_YR and D2.QSTNAI_NO=D7.QSTNAI_NO and D2.DTIL_ANS_NO=D7.DTIL_ANS_NO and D2.DTIL_DVSN_NO=D7.DTIL_DVSN_NO AND D7.NTAS_RQ_MTRL_DOC_KND_CD = 'B2') AS ETC_DOC_ID
			     , (SELECT D7.DOC_ID AS DOC_ID FROM TBCSPFPL007M D7 WHERE D2.QSTNAI_YR=D7.QSTNAI_YR and D2.QSTNAI_NO=D7.QSTNAI_NO and D2.DTIL_ANS_NO=D7.DTIL_ANS_NO and D2.DTIL_DVSN_NO=D7.DTIL_DVSN_NO AND D7.NTAS_RQ_MTRL_DOC_KND_CD = 'B1') AS HWP_DOC_ID
			     , CASE WHEN D2.CHGR_CNB =#usrCnb# THEN 'Y' ELSE 'N' END AS MY_CHGR_YN
			  FROM TBCSPFPL002M D2
			  where 1=1
		]]>
		<dynamic>
			<isNotEmpty prepend="AND" property="strChgrNm">
				D2.CHGR_NM =
				#strChgrNm#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="dptCd">
			    D2.CHR_DPT_CD IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#usrCnb#, '', 'Y', #dptCd#)))
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="strQstnaiYr">
				D2.QSTNAI_YR =
				#strQstnaiYr#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="strQstnaiNo">
				D2.QSTNAI_NO =
				#strQstnaiNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="strDtilAnsNo">
				D2.DTIL_ANS_NO =
				#strDtilAnsNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="strDtilDvsnNo">
				D2.DTIL_DVSN_NO =
				#strDtilDvsnNo#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="strNtasRqMtrlHndlStaCd">
				decode(D2.NTAS_RQ_MTRL_HNDL_STA_CD, '20', '30',
				D2.NTAS_RQ_MTRL_HNDL_STA_CD) =
				#strNtasRqMtrlHndlStaCd#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="strDtilQueTitNm">
				D2.QUE_TXT LIKE
				'%'||#strDtilQueTitNm#||'%'
			</isNotEmpty>
		</dynamic>
		
		<![CDATA[       
			ORDER BY D2.QSTNAI_YR DESC, D2.QSTNAI_NO DESC, D2.DTIL_ANS_NO DESC, D2.DTIL_DVSN_NO ASC
		]]>
	</select>

	<!-- 질의서정보 수정 -->
	<update id="CSPFPL002hwpUpdate" parameterClass="paramMap">
	<![CDATA[    
		UPDATE TBCSPFPL002M
		SET FNL_MDF_DH = SYSDATE
		, ANS_MTRL_TXT = #hwp#
		, NTAS_RQ_MTRL_HNDL_STA_CD = #strNtasRqMtrlHndlStaCd#
 		, FNL_USR_ID = #strUsrId#
		, FNL_DEAL_DPT_CD = #strDptCd#
		, FNL_MNU_ID = #strMenuId#
		WHERE 1 = 1
		AND QSTNAI_YR=#strQstnaiYr#
		AND QSTNAI_NO=#strQstnaiNo#
		AND DTIL_ANS_NO = #strDtilAnsNo#
		AND DTIL_DVSN_NO = #strDtilDvsnAnsNo#
		]]>
	</update>

	<insert id="CSPFPL002EcmFileInsert" parameterClass="paramMap">
	       <![CDATA[
	       	INSERT INTO TBCSPFPL007M
	       	(
	       			QSTNAI_NO,			/*질의서번호*/
	       			QSTNAI_YR,			/*질의서연도*/
	       			DTIL_ANS_NO,		/*세부답변번호*/
	       			DTIL_DVSN_NO,		/*세부구분번호*/
	       			NTAS_RQ_MTRL_DOC_KND_CD,		/*국회요구자료문서구분코드*/
	       			DOC_ID,		/*문서코드*/
        			FNL_USR_ID,
					FNL_DEAL_DPT_CD,
					FNL_MNU_ID,
					FRT_REGI_DH,
					FNL_MDF_DH,
					FRT_USR_ID	       			
	       	) VALUES (
	       			#strQstnaiNo#,
				    #strQstnaiYr#,
				    #strDtilAnsNo#,
				    #strDtilDvsnAnsNo#,
	        		'B2',
	        		#strEtcDocId#,
					#strUsrId#,
					#strDptCd#,
					#strUsrId#,
					SYSDATE,
					SYSDATE,
					#strUsrId#	        		
	       	)
	       ]]>
	</insert>

	<insert id="CSPFPL002EcmFileInsert1" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO TBCSPFPL007M
        	(
        			QSTNAI_NO		/*질의서번호*/
        			, QSTNAI_YR		/*질의서연도*/
	       			, DTIL_ANS_NO		/*세부답변번호*/
	       			, DTIL_DVSN_NO		/*세부구분번호*/
        			, NTAS_RQ_MTRL_DOC_KND_CD		/*국회요구자료문서구분코드*/
        			, DOC_ID			/*문서코드*/
        			, FNL_USR_ID
					, FNL_DEAL_DPT_CD
					, FNL_MNU_ID
					, FRT_REGI_DH
					, FNL_MDF_DH
					, FRT_USR_ID
        	) VALUES (
	       			 #strQstnaiNo#
				    , #strQstnaiYr#
				    , #strDtilAnsNo#
				    , #strDtilDvsnAnsNo#
	        		, 'B1'
	        		, #strHwpDocId#
					, #strUsrId#
					, #strDptCd#
					, #strUsrId#
					, SYSDATE
					, SYSDATE
					, #strUsrId#
		  	)
        ]]>
	</insert>

	<update id="CSPFPL002EcmFileUpdate1" parameterClass="paramMap">
		<![CDATA[ 	
			UPDATE TBCSPFPL007M
			   SET DOC_ID        = #strHwpDocId#
			     , FNL_USR_ID        = #strUsrId#
			     , FNL_DEAL_DPT_CD        = #strDptCd#
			     , FNL_MNU_ID        = #strUsrId#
			     , FNL_MDF_DH        = SYSDATE
	     		WHERE 1 = 1
				AND QSTNAI_YR=#strQstnaiYr#
				AND QSTNAI_NO=#strQstnaiNo#
				AND DTIL_ANS_NO = #strDtilAnsNo#
				AND DTIL_DVSN_NO = #strDtilDvsnAnsNo#
				AND NTAS_RQ_MTRL_DOC_KND_CD = 'B1'
		]]>
	</update>

	<delete id="CSPFPL002EcmFileDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE	
			FROM	TBCSPFPL007M
			WHERE	QSTNAI_NO = #strQstnaiNo#
			AND		QSTNAI_YR = #strQstnaiYr#
			AND		DTIL_ANS_NO = #strDtilAnsNo#
			AND		DTIL_DVSN_NO = #strDtilDvsnAnsNo#
		]]>
	</delete>

	<!-- 답변자료 처리상태 답변제출로 변경 -->
	<update id="CSPFPL002StmStausUpdate" parameterClass="paramMap">
	<![CDATA[    
		UPDATE TBCSPFPL002M
		SET FNL_MDF_DH = SYSDATE
			 ,NTAS_RQ_MTRL_HNDL_STA_CD = #strNtasRqMtrlHndlStaCd#
			 ,NTAS_SMT_HNDL_STA_CD = '20'
			 ,SMT_DT = #strSmtDt#
 	 		, FNL_USR_ID = #strUsrId#
			, FNL_DEAL_DPT_CD = #strDptCd#
			, FNL_MNU_ID = #strMenuId#
		WHERE 1 = 1
		AND QSTNAI_YR=#strQstnaiYr#
		AND QSTNAI_NO=#strQstnaiNo#
		AND DTIL_ANS_NO = #strDtilAnsNo#
		AND DTIL_DVSN_NO = #strDtilDvsnAnsNo#
		]]>
	</update>
	
	<!-- 메신저 push 대상 추가 -->	
	<insert id="CSPFPL006MSGPushInsert" parameterClass="paramMap">
	<![CDATA[ 	
	 INSERT INTO TBDCMACM026L (MSG_SNO,
	        TSK_CAT_CD,
	        FUNC_CAT_CD,
	        SEND_ID,
	        MSG_TP_YN,
	        MSG_TXT_2,
	        RCNT_CNT,
	        RCNT_HIS,
	        MSG_REGI_DH,
	        FRT_USR_ID,
	        FNL_USR_ID,
	        FNL_DEAL_DPT_CD,
	        FNL_MNU_ID,
	        FRT_REGI_DH,
	        FNL_MDF_DH)
	 VALUES( ( SELECT MAX(MSG_SNO) +1
	             FROM ( SELECT MSG_SNO
	                      FROM TBDCMACM026L
	                     ORDER BY MSG_SNO DESC )
	            WHERE ROWNUM<2
	            GROUP BY MSG_SNO),
	        'SP',
	        'PL',
	        'SYSTEM',
	        '0',
	        #MSG_TXT_2#,
	        #RCNT_CNT#,
	        #RCNT_HIS#,
	        SYSDATE,
	        'SYSTEM',
	        'SYSTEM',
	        'SYSTEM',
	        #strMenuId#,
	        SYSDATE,
	        SYSDATE)
			]]>
	</insert>
	<select id="CSPFPL002SelectMessageReceiver" parameterClass="paramMap" resultClass="String">
    	<![CDATA[
    		SELECT USR_DFN_TXT_1 FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD='1000964' 
    	]]>
    </select>
	
</sqlMap> 