<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="aep/gkm/038" >
	<select id="AEPGKM038Qtab1select" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT	REGN_DPT_CD,
				REGN_DPT_NM,
				KLD_CAT_CD,
				KLD_CAT_NM,
				REGI_CNT,
				DIST_CNT,
				EXPR_CNT,
				ABRG_CNT
		FROM	(
				SELECT  REGN_DPT_CD,
				        REGN_DPT_NM,
				        TG_CAT_ID AS KLD_CAT_CD,
						TG_CAT_NM AS KLD_CAT_NM,
						COUNT(TG_CAT_ID) AS REGI_CNT,
						COUNT(DECODE(KLD_STA_CD, '6', '유통')) AS DIST_CNT,
						COUNT(DECODE(KLD_STA_CD, '7', '만기')) AS EXPR_CNT,
						COUNT(DECODE(KLD_STA_CD, '8', '폐기')) AS ABRG_CNT
				FROM    (
				SELECT  CASE
				            WHEN REGN_DPT_NM IS NULL
				            THEN '######'
				            ELSE REGN_DPT_CD
				        END AS REGN_DPT_CD,
				        NVL(REGN_DPT_NM, '미등록부서') AS REGN_DPT_NM,
				        CASE
				            WHEN TG_CAT_NM IS NULL
				            THEN '####'
				            ELSE TG_CAT_ID
				        END AS TG_CAT_ID,
				        NVL(TG_CAT_NM, '미등록카테고리') AS TG_CAT_NM,
				        KLD_STA_CD
				FROM    TBAEPGKM001M AS A,
				        TBAEPGKM017M AS B
				WHERE   1=1
				AND     A.KLD_CAT_CD = B.TG_CAT_ID (+)
				AND     KLD_STA_CD IN (6, 7, 8)
			<isNotEmpty property="KLD_CAT_CD" prepend="AND">
						A.KLD_CAT_CD IN (
						         SELECT TG_CAT_ID
						          FROM TBAEPGKM017M A
						             , (
						                SELECT SRT_VAL_NM
						                  FROM TBAEPGKM017M
						                 WHERE TG_CAT_ID = #KLD_CAT_CD#
						              ) B
						        WHERE A.SRT_VAL_NM LIKE B.SRT_VAL_NM || '%'  
						   		)	
				</isNotEmpty>
				<isNotEmpty property="FROM_DATE" prepend="AND">
				<![CDATA[
						TO_DATE(REGI_RQS_DT) >= TO_DATE(#FROM_DATE#)
				]]>
				</isNotEmpty>
				<isNotEmpty property="TO_DATE" prepend="AND">
				<![CDATA[
						TO_DATE(REGI_RQS_DT) <= TO_DATE(#TO_DATE#)
				]]> 
				</isNotEmpty>
				<isNotEmpty property="HIRK_DPT_CD" prepend="AND">
						REGN_DPT_CD LIKE SUBSTR(#HIRK_DPT_CD#, 0, 3) || '%' 
				</isNotEmpty>
				<isNotEmpty property="DPT_CD" prepend="AND">
						REGN_DPT_CD = #DPT_CD#
				</isNotEmpty>
				<isNotEmpty property="CNB" prepend="AND">
						REGN_CNB = #CNB#
				</isNotEmpty>
				        )
				WHERE   1=1
				GROUP BY REGN_DPT_CD, REGN_DPT_NM, TG_CAT_ID, TG_CAT_NM, KLD_STA_CD
				UNION
				SELECT  REGN_DPT_CD AS REGN_DPT_CD,
				        REGN_DPT_NM,
				        '' AS TG_CAT_ID,
						'소계' AS KLD_CAT_NM,
						COUNT(REGN_DPT_CD) AS REGI_CNT,
						COUNT(DECODE(KLD_STA_CD, '6', '유통')) AS DIST_CNT,
						COUNT(DECODE(KLD_STA_CD, '7', '만기')) AS EXPR_CNT,
						COUNT(DECODE(KLD_STA_CD, '8', '폐기')) AS ABRG_CNT
				FROM    (
				SELECT  CASE
				            WHEN REGN_DPT_NM IS NULL
				            THEN '######'
				            ELSE REGN_DPT_CD
				        END AS REGN_DPT_CD,
				        NVL(REGN_DPT_NM, '미등록부서') AS REGN_DPT_NM,
				        CASE
				            WHEN TG_CAT_NM IS NULL
				            THEN '####'
				            ELSE TG_CAT_ID
				        END AS TG_CAT_ID,
				        NVL(TG_CAT_NM, '미등록카테고리') AS TG_CAT_NM,
				        KLD_STA_CD
				FROM    TBAEPGKM001M AS A,
				        TBAEPGKM017M AS B
				WHERE   1=1
				AND     A.KLD_CAT_CD = B.TG_CAT_ID (+)
				AND     KLD_STA_CD IN (6, 7, 8)
			<isNotEmpty property="KLD_CAT_CD" prepend="AND">
						A.KLD_CAT_CD IN (
						         SELECT TG_CAT_ID
						          FROM TBAEPGKM017M A
						             , (
						                SELECT SRT_VAL_NM
						                  FROM TBAEPGKM017M
						                 WHERE TG_CAT_ID = #KLD_CAT_CD#
						              ) B
						        WHERE A.SRT_VAL_NM LIKE B.SRT_VAL_NM || '%'  
						   		)	
				</isNotEmpty>
				<isNotEmpty property="FROM_DATE" prepend="AND">
				<![CDATA[
						TO_DATE(REGI_RQS_DT) >= TO_DATE(#FROM_DATE#)
				]]>
				</isNotEmpty>
				<isNotEmpty property="TO_DATE" prepend="AND">
				<![CDATA[
						TO_DATE(REGI_RQS_DT) <= TO_DATE(#TO_DATE#)
				]]> 
				</isNotEmpty>
				<isNotEmpty property="HIRK_DPT_CD" prepend="AND">
						REGN_DPT_CD LIKE SUBSTR(#HIRK_DPT_CD#, 0, 3) || '%' 
				</isNotEmpty>
				<isNotEmpty property="DPT_CD" prepend="AND">
						REGN_DPT_CD = #DPT_CD#
				</isNotEmpty>
				<isNotEmpty property="CNB" prepend="AND">
						REGN_CNB = #CNB#
				</isNotEmpty>
				        )
				WHERE   1=1
				GROUP BY REGN_DPT_CD, REGN_DPT_NM
				)
		WHERE 	1=1
		ORDER BY REGN_DPT_CD
	</select>
	
	<select id="AEPGKM038Qtab2select" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT	REGN_CNB,
				REGN_USR_NM,
				KLD_CAT_CD,
				KLD_CAT_NM,
				REGI_CNT,
				DIST_CNT,
				EXPR_CNT,
				ABRG_CNT
		FROM	(
				SELECT  REGN_CNB,
				        USR_NAM AS REGN_USR_NM,
				        KLD_CAT_CD,
				        TG_CAT_NM AS KLD_CAT_NM,
				        COUNT(NVL(REGN_CNB, '0')) AS REGI_CNT,
				        COUNT(DECODE(KLD_STA_CD, '6', '유통')) AS DIST_CNT,
				        COUNT(DECODE(KLD_STA_CD, '7', '만기')) AS EXPR_CNT,
				        COUNT(DECODE(KLD_STA_CD, '8', '폐기')) AS ABRG_CNT
				FROM    (
				SELECT  KNB,
				        CASE
				            WHEN TG_CAT_NM IS NULL
				            THEN '0000'
				            ELSE KLD_CAT_CD
				        END AS KLD_CAT_CD,
				        NVL(TG_CAT_NM, '미등록카테고리') AS TG_CAT_NM,
				        KLD_STA_CD,
				        CASE
				            WHEN USR_NAM IS NULL
				            THEN '####'
				            ELSE REGN_CNB
				        END AS REGN_CNB,
				        NVL(USR_NAM, '미등록사용자') AS USR_NAM
				FROM    TBAEPGKM001M AS A,
				        TBAEPGKM017M AS B,
				        TBDCMACM001M AS C
				WHERE   1=1
				AND     KLD_CAT_CD = TG_CAT_ID (+)
				AND     REGN_CNB = CNB (+)
				AND     KLD_STA_CD IN (6, 7, 8)
				<isNotEmpty property="USR_NAM" prepend="AND">
						USR_NAM LIKE #USR_NAM# || '%'
				</isNotEmpty>
				<isNotEmpty property="KLD_CAT_CD" prepend="AND">
						A.KLD_CAT_CD IN (
						         SELECT TG_CAT_ID
						          FROM TBAEPGKM017M A
						             , (
						                SELECT SRT_VAL_NM
						                  FROM TBAEPGKM017M
						                 WHERE TG_CAT_ID = #KLD_CAT_CD#
						              ) B
						        WHERE A.SRT_VAL_NM LIKE B.SRT_VAL_NM || '%'  
						   		)	
				</isNotEmpty>
				<isNotEmpty property="FROM_DATE" prepend="AND">
				<![CDATA[
						TO_DATE(REGI_RQS_DT) >= TO_DATE(#FROM_DATE#)
				]]>
				</isNotEmpty>
				<isNotEmpty property="TO_DATE" prepend="AND">
				<![CDATA[
						TO_DATE(REGI_RQS_DT) <= TO_DATE(#TO_DATE#)
				]]> 
				</isNotEmpty>
				        )
				WHERE   1=1
				GROUP BY REGN_CNB, USR_NAM, KLD_CAT_CD, TG_CAT_NM, KLD_STA_CD
				UNION
				SELECT  REGN_CNB,
				        USR_NAM AS REGN_USR_NM,
				        '' AS KLD_CAT_CD,
				        '소계' AS KLD_CAT_NM,
				        COUNT(NVL(REGN_CNB, '0')) AS REGI_CNT,
				        COUNT(DECODE(KLD_STA_CD, '6', '유통')) AS DIST_CNT,
				        COUNT(DECODE(KLD_STA_CD, '7', '만기')) AS EXPR_CNT,
				        COUNT(DECODE(KLD_STA_CD, '8', '폐기')) AS ABRG_CNT
				FROM    (
				SELECT  KNB,
				        CASE
				            WHEN TG_CAT_NM IS NULL
				            THEN '0000'
				            ELSE KLD_CAT_CD
				        END AS KLD_CAT_CD,
				        NVL(TG_CAT_NM, '미등록카테고리') AS TG_CAT_NM,
				        KLD_STA_CD,
				        CASE
				            WHEN USR_NAM IS NULL
				            THEN '####'
				            ELSE REGN_CNB
				        END AS REGN_CNB,
				        NVL(USR_NAM, '미등록사용자') AS USR_NAM
				FROM    TBAEPGKM001M AS A,
				        TBAEPGKM017M AS B,
				        TBDCMACM001M AS C
				WHERE   1=1
				AND     KLD_CAT_CD = TG_CAT_ID (+)
				AND     REGN_CNB = CNB (+)
				AND     KLD_STA_CD IN (6, 7, 8)
				<isNotEmpty property="USR_NAM" prepend="AND">
						USR_NAM LIKE #USR_NAM# || '%'
				</isNotEmpty>
				<isNotEmpty property="KLD_CAT_CD" prepend="AND">
						A.KLD_CAT_CD IN (
						         SELECT TG_CAT_ID
						          FROM TBAEPGKM017M A
						             , (
						                SELECT SRT_VAL_NM
						                  FROM TBAEPGKM017M
						                 WHERE TG_CAT_ID = #KLD_CAT_CD#
						              ) B
						        WHERE A.SRT_VAL_NM LIKE B.SRT_VAL_NM || '%'  
						   		)	
				</isNotEmpty>
				<isNotEmpty property="FROM_DATE" prepend="AND">
				<![CDATA[
						TO_DATE(REGI_RQS_DT) >= TO_DATE(#FROM_DATE#)
				]]>
				</isNotEmpty>
				<isNotEmpty property="TO_DATE" prepend="AND">
				<![CDATA[
						TO_DATE(REGI_RQS_DT) <= TO_DATE(#TO_DATE#)
				]]> 
				</isNotEmpty>
				        )
				WHERE   1=1
				GROUP BY REGN_CNB, USR_NAM
				)
		WHERE	1=1
		ORDER BY REGN_CNB
	</select>
</sqlMap>

