<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/dcp/613">
 	
 	<select id="CSPDCP613QSelectMain" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
		 SELECT	D3.TOT_CNT
		 		, D3.RNUM
				, D3.CV_PET_CATE_CD
				, D3.YEAR
				, D3.ACCT_NO
				, D3.YEAR_CV_PET_CATE_CD_ACCT_NO
				, D3.TITLE
				, D3.ACCT_DATE
		        , D3.CV_PETER_NM
		        , D3.CV_PET_HNDL_DIRC_CD
		        , D3.OPER_DATE
		        , D3.CV_PETER_TEL
		        , D3.CV_PETER_TEL2
		        , F_DPT_INFO(D3.HNDL_DEPT_CD, '1') AS HNDL_DEPT_CD_NM
		        ,(
		        	SELECT 	S5.USR_NAM 
		          	FROM	TBDCMACM001M S5 
		          	WHERE 	1=1
		          	AND 	S5.CNB = D3.SUMM_PSON_EMPLNUM
				) AS USR_NAM
				, (SELECT S1.CD_NM
		           FROM CM_ETCCD S1
		          WHERE S1.CD_TYPE = 'AS09' /*민원종류코드*/
		            AND S1.CD      = D3.CV_PET_CATE_CD) AS CV_PET_CATE_NM
		        , (SELECT S2.CD_NM
		           FROM CM_ETCCD S2
		          WHERE S2.CD_TYPE = 'AS13' /*처리지시구분코드*/
		            AND S2.CD = D3.CV_PET_HNDL_DIRC_CD) AS CV_PET_HNDL_DIRC_NM
		FROM	(
					SELECT	D4.*
							, ROWNUM AS RNUM
					FROM	(
								SELECT	D2.*
										, COUNT(1) OVER() AS TOT_CNT 
								FROM	(
											SELECT D1.CV_PET_CATE_CD
											       ,D1.YEAR
											       ,D1.ACCT_NO
											       ,D1.YEAR||'-'||D1.CV_PET_CATE_CD||'-'||D1.ACCT_NO AS YEAR_CV_PET_CATE_CD_ACCT_NO
											       ,D1.TITLE
											       ,D1.ACCT_DATE
											       ,D1.CV_PETER_NM
											       ,D1.CV_PET_HNDL_DIRC_CD
											       ,D1.OPER_DATE
											       ,D1.CV_PETER_TEL
											       ,D1.CV_PETER_TEL2
											       ,( CASE WHEN D1.HNDL_DEPT_CD IS NOT NULL THEN SUBSTR(TRIM(D1.HNDL_DEPT_CD), 1, 2) || '0' || SUBSTR(TRIM(D1.HNDL_DEPT_CD), 3) || '0' ELSE NULL END ) AS HNDL_DEPT_CD
											       ,D1.SUMM_PSON_EMPLNUM
											  FROM AM_CV_PET_HNDL_DOC D1
					 						 WHERE 1=1
					 						 AND   ACCT_DATE BETWEEN #ACP_DH_START# AND #ACP_DH_END#
		]]>
											<dynamic>
											 <isNotEmpty property="YEAR">
											  AND YEAR = #YEAR#
											 </isNotEmpty>
											 
											 <isNotEmpty property="ACCT_NO">
											  AND ACCT_NO = #ACCT_NO#
											 </isNotEmpty>
											 
											 <isNotEmpty property="CV_PETER_TEL">
											  AND (D1.CV_PETER_TEL LIKE '%'||NVL(#TEL1#, '')||NVL2(#TEL1#, '-', '')||NVL(#TEL2#, '')||NVL2(#TEL2#, '-', '')||NVL(#TEL3#, '')||NVL2(#TEL3#, '-', '')||'%'
											   OR D1.CV_PETER_TEL2 LIKE '%'||NVL(#TEL1#, '')||NVL2(#TEL1#, '-', '')||NVL(#TEL2#, '')||NVL2(#TEL2#, '-', '')||NVL(#TEL3#, '')||NVL2(#TEL3#, '-', '')||'%')
											 </isNotEmpty>
											 
											 <isNotEmpty property="TITLE">
											  AND TITLE LIKE '%'||#TITLE#||'%'
											 </isNotEmpty>
											  
											  <isNotEmpty property="CV_PETER_NM">
											  AND CV_PETER_NM LIKE '%'||#CV_PETER_NM#||'%'
											  </isNotEmpty>
											  
											  <isNotEmpty property="HNDL_ORG_CD">
											  AND (HNDL_ORG_CD_1 = #HNDL_ORG_CD# OR HNDL_ORG_CD_2 = #HNDL_ORG_CD# OR HNDL_ORG_CD_3 = #HNDL_ORG_CD#)
											  </isNotEmpty>
								
										  </dynamic>
		<![CDATA[
											  ORDER BY D1.YEAR DESC
													  ,D1.ACCT_NO DESC
					
										) D2
							)D4							
				) D3
		WHERE 	RNUM BETWEEN (((#currPage#- 1) * #pageSize#) + 1) AND (#currPage# * #pageSize#)
		]]>
	</select>
	
	
	<select id="CSPDCP613QSelectExcel" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
	SELECT D1.ACCT_NO 
	      ,D1.ACCT_DATE
	      ,F_ORG_INFO(D1.SUP_ORG_CD , '1') AS SUP_ORG_NM
	      ,F_ORG_INFO(D1.TRAN_ORG_CD, '1') AS TRAN_ORG_NM
	      ,F_ORG_INFO(D1.REL_ORG_CD , '1') AS REL_ORG_NM
	      ,(SELECT S2.CD_NM
	          FROM TBDCMACM013C S2
	         WHERE S2.CMM_CD_DVSN_CD = '1000128'
	           AND S2.CD = F_ORG_INFO(D1.REL_ORG_CD, '2')) AS REL_ORG_DIV
	      ,(SELECT S1.CD_NM
	          FROM CM_ETCCD S1
	         WHERE S1.CD_TYPE = 'AS10' /*민원기관구분코드*/
	           AND S1.CD      = D1.CV_PET_ORG_TYPE_CD) AS CV_PET_ORG_TYPE_NM
	      ,D1.TITLE
	      ,D1.CV_PETER_ADDR
	      ,D1.CV_PETER_NM
	      ,D1.REPEAT_CNT
	      ,(SELECT S3.CD_NM
	          FROM CM_ETCCD S3
	         WHERE S3.CD_TYPE = 'AS11'
	           AND S3.CD      = SUBSTR(D1.CV_PET_ORIGIN_CD,1,3)||'000') AS CV_PET_ORIGIN_BIG_NM
	      ,(SELECT S4.CD_NM
	          FROM CM_ETCCD S4
	         WHERE S4.CD_TYPE = 'AS11'
	           AND S4.CD      = D1.CV_PET_ORIGIN_CD) AS CV_PET_ORIGIN_NM
	      ,D1.LAST_REPEAT_ACCT_NO
	      , (SELECT S2.CD_NM
               FROM CM_ETCCD S2
              WHERE S2.CD_TYPE = 'AS13' /*처리지시구분코드*/
                AND S2.CD = D1.CV_PET_HNDL_DIRC_CD) AS CV_PET_HNDL_DIRC_NM
	      ,D1.OPER_DATE
	      ,F_DPT_INFO(D1.HNDL_DEPT_CD, '1') AS HNDL_DEPT_NM
	      ,(SELECT S5.USR_NAM 
	          FROM TBDCMACM001M S5 
	          WHERE 1=1
	            AND S5.CNB = D1.SUMM_PSON_EMPLNUM) AS USR_NAM
	      ,F_DPT_INFO(D1.SUMM_PSON_DEPT_CD, '1') AS SUMM_PSON_DEPT_NM
	      ,(SELECT S6.CD_NM
	          FROM CM_ETCCD S6
	         WHERE S6.CD_TYPE = 'AS18' /*민원접수형태코드*/
	           AND S6.CD      = D1.ACCT_ROUTE_CD) AS ACCT_ROUTE_NM
	       ,D1.ACCT_ROUTE_CD_DETAIL
	       ,TO_CHAR(TO_DATE(D2.RE_DATE, 'YYYYMMDD'), 'YYYYMMDD') AS RE_DATE
	       ,F_ORG_INFO(D1.HNDL_ORG_CD_1, '1') AS HNDL_ORG_CD_1
	       ,F_ORG_INFO(D1.HNDL_ORG_CD_2, '1') AS HNDL_ORG_CD_2
	       ,F_ORG_INFO(D1.HNDL_ORG_CD_3, '1') AS HNDL_ORG_CD_3
	       ,D2.HNDL_DATE AS HNDL_DATE
	       ,(SELECT S9.CD_NM 
               FROM CM_ETCCD S9
              WHERE 1=1
                AND S9.CD_TYPE = 'AS15' /*민원처리결과코드*/
                AND S9.CD = D2.CV_PET_HNDL_RSLT_CD)AS CV_PET_HNDL_RSLT_NM
	       ,D1.COMPLETE_YN
	       ,(SELECT S7.CD_NM 
               FROM CM_ETCCD S7 
              WHERE S7.CD_TYPE = 'AS16' /*민원해결종류코드*/
                AND S7.CD = D2.SOLVE_TYPE_CD) AS SOLVE_TYPE_CD
	       ,(SELECT S8.CD_NM 
               FROM CM_ETCCD S8 
              WHERE S8.CD_TYPE = 'AS17' /*민원미해결사유코드*/
                AND S8.CD = D2.UNSOLVE_TYPE_CD) AS UNSOLVE_TYPE_CD
	  FROM AM_CV_PET_HNDL_DOC D1
	      ,AM_CV_PET_RSLT_RPT D2
	 WHERE 1=1
	   AND D1.CV_PET_CATE_CD = D2.CV_PET_CATE_CD(+)
	   AND D1.YEAR           = D2.YEAR(+)
	   AND D1.ACCT_NO        = D2.ACCT_NO(+)
	]]>
	<dynamic>
		   <isNotEmpty property="YEAR">
		    AND D1.YEAR = #YEAR#
		   </isNotEmpty>
		   
		   <isNotEmpty property="ACCT_NO">
		    AND D1.ACCT_NO = #ACCT_NO#
		   </isNotEmpty>
		   
		   <isNotEmpty property="CV_PETER_TEL">
		    AND (D1.CV_PETER_TEL LIKE '%'||NVL(#TEL1#, '')||NVL2(#TEL1#, '-', '')||NVL(#TEL2#, '')||NVL2(#TEL2#, '-', '')||NVL(#TEL3#, '')||NVL2(#TEL3#, '-', '')||'%'
		     OR D1.CV_PETER_TEL2 LIKE '%'||NVL(#TEL1#, '')||NVL2(#TEL1#, '-', '')||NVL(#TEL2#, '')||NVL2(#TEL2#, '-', '')||NVL(#TEL3#, '')||NVL2(#TEL3#, '-', '')||'%')
		   </isNotEmpty>
		   
		   <isNotEmpty property="ACP_DH_START">
		   		<isNotEmpty property="ACP_DH_END">
		    AND D1.ACCT_DATE BETWEEN #ACP_DH_START# AND #ACP_DH_END#
		    	</isNotEmpty>
		   </isNotEmpty>
		   
		   <isNotEmpty property="TITLE">
		    AND D1.TITLE LIKE '%'||#TITLE#||'%'
		   </isNotEmpty>
		    
		    <isNotEmpty property="CV_PETER_NM">
		    AND D1.CV_PETER_NM LIKE '%'||#CV_PETER_NM#||'%'
		    </isNotEmpty>
		    
		    <isNotEmpty property="HNDL_ORG_CD">
		    AND (D1.HNDL_ORG_CD_1 = #HNDL_ORG_CD# OR D1.HNDL_ORG_CD_2 = #HNDL_ORG_CD# OR D1.HNDL_ORG_CD_3 = #HNDL_ORG_CD#)
		    </isNotEmpty>
		
		  </dynamic>
		  ORDER BY D1.YEAR DESC
		          ,D1.ACCT_NO DESC
	</select>
 	
</sqlMap> 
