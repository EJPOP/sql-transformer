<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="csp/nbk/312">

	<update id="CSPNBK312PBbkIsueDtUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK312EBbkIsueDtUpdate */ TBCSPNBK101M
		SET		BBK_ISUE_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
				, FNL_USR_ID = #USR_ID#
				, FNL_DEAL_DPT_CD = #DPT_CD#
				, FNL_MNU_ID = #MNU_ID#
				, FNL_MDF_DH = SYSDATE
		WHERE	MOUI_NO = #strMOUI_NO#
	]]>
	</update>
	
	<select id="CSPNBK312PGetMnstCluCd" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT /* CSPNBK312PGetMnstCluCd */
   				 ACCT_NM
			   FROM TBCSPNBK501M
			   WHERE MNST_CLU_CD = #MNST_CLU_CD#
			   AND	TAX_SITM_CD = '0'
		]]>
	</select>
	
	<select id="CSPNBK312PGetFnlOtptRowNo" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT /* CSPNBK312PGetFnlOtptRowNo */
				  MOD((TO_NUMBER(#FNL_OTPT_ROW_NO#) + A.TOT_CNT), 24) AS FNL_OTPT_ROW_NO
				  FROM (
		                SELECT COUNT(*) AS TOT_CNT
		                FROM TBCSPNBK102L
		                WHERE  MOUI_NO = #MOUI_NO#
		                AND  ( INV_DEAL_DT > (SELECT NVL(MAX(INV_DEAL_DT), '19700101')
		                                        FROM TBCSPNBK102L
		                                       WHERE  MOUI_NO = #MOUI_NO#
		                                         AND CNL_YN = 'N'
		                                         AND BBK_PRT_YN = 'Y')
					           OR
				             ( INV_DEAL_DT = (SELECT NVL(MAX(INV_DEAL_DT), '19700101')
		                                        FROM TBCSPNBK102L
		                                       WHERE  MOUI_NO = #MOUI_NO#
		                                         AND CNL_YN = 'N'
		                                         AND BBK_PRT_YN = 'Y')
				                AND
				       			INV_DEAL_SLN > ( SELECT NVL(MAX(INV_DEAL_SLN), 0) AS INV_DEAL_SLN
		                                           FROM   TBCSPNBK102L
		                                          WHERE  INV_DEAL_DT = (SELECT MAX(INV_DEAL_DT) 			
		                                              					FROM TBCSPNBK102L
		                                                                WHERE  MOUI_NO = #MOUI_NO#
		                                                                AND CNL_YN = 'N'
		                                                                AND BBK_PRT_YN = 'Y') 
		                                          AND MOUI_NO = #MOUI_NO#
		                                          AND CNL_YN = 'N'
		                                          AND BBK_PRT_YN = 'Y' )   ) )) A     
		]]>
	</select>
	
	<select id="CSPNBK312PGetLoanFnlOtptRowNo" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT /* CSPNBK312PGetLoanFnlOtptRowNo */
				  MOD((TO_NUMBER(#FNL_OTPT_ROW_NO#) + A.TOT_CNT), 24) AS FNL_OTPT_ROW_NO
				  FROM (
		                SELECT COUNT(*) AS TOT_CNT
		                FROM TBCSPNBK205L
		                WHERE  MOUI_NO = #MOUI_NO#
		                AND	   LEND_KND_CD = #LEND_KND_CD#
		                AND  ( LEND_DEAL_DT > (SELECT NVL(MAX(LEND_DEAL_DT), '19700101')
		                                        FROM TBCSPNBK205L
		                                       WHERE  MOUI_NO = #MOUI_NO#
		                                         AND CNL_YN = 'N'
		                                         AND BBK_PRT_YN = 'Y'
		                                         AND LEND_KND_CD = #LEND_KND_CD#)
					           OR
				             ( LEND_DEAL_DT = (SELECT NVL(MAX(LEND_DEAL_DT), '19700101')
		                                        FROM TBCSPNBK205L
		                                       WHERE  MOUI_NO = #MOUI_NO#
		                                         AND CNL_YN = 'N'
		                                         AND BBK_PRT_YN = 'Y'
		                                         AND LEND_KND_CD = #LEND_KND_CD#)
				                AND
				       			LEND_DEAL_DT_SLN > ( SELECT NVL(MAX(LEND_DEAL_DT_SLN), 0) AS INV_DEAL_SLN
		                                           FROM   TBCSPNBK205L
		                                          WHERE  LEND_DEAL_DT = (SELECT MAX(LEND_DEAL_DT) 			
		                                              					FROM TBCSPNBK205L
		                                                                WHERE  MOUI_NO = #MOUI_NO#
		                                                                AND CNL_YN = 'N'
		                                                                AND BBK_PRT_YN = 'Y'
		                                                                AND LEND_KND_CD = #LEND_KND_CD#) 
		                                          AND MOUI_NO = #MOUI_NO#
		                                          AND CNL_YN = 'N'
		                                          AND BBK_PRT_YN = 'Y'
		                                          AND LEND_KND_CD = #LEND_KND_CD#) 
			                                          )
		                       )
		                      ) A    
		]]>
	</select>
	
	<update id="CSPNBK312PBbkPrtYnUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK312PBbkPrtYnUpdate */ TBCSPNBK102L
        SET    BBK_PRT_YN = 'Y'
         WHERE  MOUI_NO = #MOUI_NO#
         AND  ( INV_DEAL_DT > ( SELECT NVL(MAX(INV_DEAL_DT), '19700101')
		   						FROM TBCSPNBK102L
                                WHERE  MOUI_NO = #MOUI_NO#
                                AND CNL_YN = 'N'
                                AND BBK_PRT_YN = 'Y')
			   	 OR
					( INV_DEAL_DT = ( SELECT NVL(MAX(INV_DEAL_DT), '19700101')
					   FROM TBCSPNBK102L
			                                WHERE  MOUI_NO = #MOUI_NO#
			                                AND CNL_YN = 'N'
			                                AND BBK_PRT_YN = 'Y')
			   		AND
			  		  INV_DEAL_SLN > ( SELECT NVL(MAX(INV_DEAL_SLN), 0) AS INV_DEAL_SLN
			                                 FROM   TBCSPNBK102L
			                                 WHERE  INV_DEAL_DT = (SELECT MAX(INV_DEAL_DT) 			
			                                       					FROM TBCSPNBK102L
			                                                         WHERE  MOUI_NO = #MOUI_NO#
			                                                         AND CNL_YN = 'N'
			                                                         AND BBK_PRT_YN = 'Y') 
			                                 AND MOUI_NO = #MOUI_NO#
			                                 AND CNL_YN = 'N'
			                                 AND BBK_PRT_YN = 'Y' )  ) )  
	]]>
	</update>
	
	<update id="CSPNBK312PLoanBbkPrtYnUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK312PLoanBbkPrtYnUpdate */ TBCSPNBK205L
		SET		BBK_PRT_YN = 'Y'
				, FNL_USR_ID = #USR_ID#
				, FNL_DEAL_DPT_CD = #DPT_CD#
				, FNL_MNU_ID = #MNU_ID#
				, FNL_MDF_DH = SYSDATE
		WHERE	MOUI_NO = #MOUI_NO#
		AND		( LEND_DEAL_DT > (	SELECT NVL(MAX(LEND_DEAL_DT), '19700101') AS MAX_DEAL_DATE
									FROM TBCSPNBK205L
									WHERE  MOUI_NO = #MOUI_NO#
									AND CNL_YN = 'N'
									AND BBK_PRT_YN = 'Y'
									AND LEND_KND_CD = #LEND_KND_CD#)
				OR
					( LEND_DEAL_DT = (	SELECT NVL(MAX(LEND_DEAL_DT), '19700101') AS MAX_DEAL_DATE
									FROM TBCSPNBK205L
									WHERE  MOUI_NO = #MOUI_NO#
									AND CNL_YN = 'N'
									AND BBK_PRT_YN = 'Y'
									AND LEND_KND_CD = #LEND_KND_CD#)
					AND
					LEND_DEAL_DT_SLN > (SELECT NVL(MAX(LEND_DEAL_DT_SLN), 0) AS MAX_LEND_DEAL_DT_SLN
										FROM   TBCSPNBK205L
										WHERE  LEND_DEAL_DT = (SELECT 	MAX(LEND_DEAL_DT) 																
										                       FROM 	TBCSPNBK205L
										                       WHERE  	MOUI_NO = #MOUI_NO#
										                       AND 		CNL_YN = 'N'
										                       AND 		BBK_PRT_YN = 'Y'
										                       AND 		LEND_KND_CD = #LEND_KND_CD# )
										AND MOUI_NO = #MOUI_NO#
										AND CNL_YN = 'N'
										AND BBK_PRT_YN = 'Y'
										AND LEND_KND_CD = #LEND_KND_CD# ) )
				) 
	]]>
	</update>
	
	<update id="CSPNBK312PBbkPrtRowUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK312PBbkPrtRowUpdate */ TBCSPNBK101M
           SET 	FNL_OTPT_ROW_NO = #FNL_OTPT_ROW_NO#
           		, FNL_USR_ID = #USR_ID#
				, FNL_DEAL_DPT_CD = #DPT_CD#
				, FNL_MNU_ID = #MNU_ID#
				, FNL_MDF_DH = SYSDATE
         WHERE 	(MOUI_NO = #strMOUI_NO# OR MOUI_NO = #MOUI_NO#)
	]]>
	</update>
	
	<update id="CSPNBK312PLoanBbkPrtRowUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK312PLoanBbkPrtRowUpdate */ TBCSPNBK202M
		SET 	FNL_OTPT_ROW_NO = #FNL_OTPT_ROW_NO#
				, FNL_USR_ID = #USR_ID#
				, FNL_DEAL_DPT_CD = #DPT_CD#
				, FNL_MNU_ID = #MNU_ID#
				, FNL_MDF_DH = SYSDATE
		WHERE 	(MOUI_NO = #strMOUI_NO# OR MOUI_NO = #MOUI_NO#)
	]]>
	</update>
		
	<select id="CSPNBK312PReadPrintOutInvest" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT /* CSPNBK312PReadPrintOutInvest */
        	       MOUI_NO
        	       , TO_CHAR(TO_DATE(INV_DEAL_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS INV_DEAL_DT 
        	       , INV_DEAL_SLN
        	       , PET_DH
        	       , INV_AM
        	       , DEPTS_PMT_DVSN_CD
        	       , DEAL_BK_LEDG_BL
        	       , DEAL_AF_LEDG_BL
        	       , RMK
        	       , BBK_PRT_YN
        	       , INV_KND_CD
        	       , #FNL_OTPT_ROW_NO# AS TOT_FNL_OTPT_ROW_NO
        	FROM TBCSPNBK102L
           WHERE  MOUI_NO = #MOUI_NO#
             AND CNL_YN = 'N'
             AND ( INV_DEAL_DT > ( SELECT NVL(MAX(INV_DEAL_DT), '19700101')
								   FROM TBCSPNBK102L
                                   WHERE  MOUI_NO = #MOUI_NO#
                                   AND CNL_YN = 'N'
                                   AND BBK_PRT_YN = 'Y')
		       	 OR
	     		( INV_DEAL_DT = ( SELECT NVL(MAX(INV_DEAL_DT), '19700101')
								   FROM TBCSPNBK102L
                                   WHERE  MOUI_NO = #MOUI_NO#
                                   AND CNL_YN = 'N'
                                   AND BBK_PRT_YN = 'Y')
	        		AND
	       		  INV_DEAL_SLN > ( SELECT NVL(MAX(INV_DEAL_SLN), 0) AS INV_DEAL_SLN
                                    FROM   TBCSPNBK102L
                                    WHERE  INV_DEAL_DT = (SELECT MAX(INV_DEAL_DT) 			
                                          					FROM TBCSPNBK102L
                                                            WHERE  MOUI_NO = #MOUI_NO#
                                                            AND CNL_YN = 'N'
                                                            AND BBK_PRT_YN = 'Y') 
                                    AND MOUI_NO = #MOUI_NO#
                                    AND CNL_YN = 'N'
                                    AND BBK_PRT_YN = 'Y' )  ) ) 
		ORDER BY INV_DEAL_DT, INV_DEAL_SLN		
		]]>
	</select>
	
	<select id="CSPNBK312PReadPrintOutLoan" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT /* CSPNBK312PReadPrintOutLoan */
					MOUI_NO
					, TO_CHAR(TO_DATE(LEND_DEAL_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS LEND_DEAL_DT 
					, LEND_DEAL_DT_SLN
					, PET_DH
					, DEAL_PRN
					, DEPTS_PMT_DVSN_CD
					, LEND_BL
					, LAG_WDL_RMK
					, BBK_PRT_YN
					, LEND_DEAL_DVSN_CD
					, INT_AM
					, #FNL_OTPT_ROW_NO# AS TOT_FNL_OTPT_ROW_NO
			FROM 	TBCSPNBK205L
			WHERE  	MOUI_NO = #MOUI_NO#
			AND 	LEND_KND_CD = #LEND_KND_CD#
			AND 	CNL_YN = 'N'
			AND  	( LEND_DEAL_DT > (SELECT NVL(MAX(LEND_DEAL_DT), '19700101') AS MAX_DEAL_DATE
									 FROM 	TBCSPNBK205L
									WHERE  	MOUI_NO = #MOUI_NO#
									AND 	CNL_YN = 'N'
									AND 	BBK_PRT_YN = 'Y'
									AND 	LEND_KND_CD = #LEND_KND_CD#)
									OR		( LEND_DEAL_DT = (SELECT NVL(MAX(LEND_DEAL_DT), '19700101') AS MAX_DEAL_DATE
															FROM TBCSPNBK205L
															WHERE  MOUI_NO = #MOUI_NO#
															AND CNL_YN = 'N'
															AND BBK_PRT_YN = 'Y'
															AND LEND_KND_CD = #LEND_KND_CD#
														  )
											AND
											LEND_DEAL_DT_SLN > (SELECT NVL(MAX(LEND_DEAL_DT_SLN), 0) AS MAX_LEND_DEAL_DT_SLN
																FROM   TBCSPNBK205L
																WHERE  LEND_DEAL_DT = (SELECT 	MAX(LEND_DEAL_DT) 																
																						FROM 	TBCSPNBK205L
																						WHERE  	MOUI_NO = #MOUI_NO#
																						AND 		CNL_YN = 'N'
																						AND 		BBK_PRT_YN = 'Y'
																						AND 		LEND_KND_CD = #LEND_KND_CD# )
																AND MOUI_NO = #MOUI_NO#
																AND CNL_YN = 'N'
																AND BBK_PRT_YN = 'Y'
																AND LEND_KND_CD = #LEND_KND_CD#
																)
											 )
							)
				
			ORDER BY LEND_DEAL_DT, LEND_DEAL_DT_SLN
		]]>
	</select>
	
	<select id="CSPNBK312PGetFnlOtptRowNoParam" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT /* CSPNBK312PGetFnlOtptRowNoParam */
					MOD(TO_NUMBER(#strPRT_LINE#)+TO_NUMBER(A.TOT_CNT), 24) AS TOT_PRT_LINE
			FROM (
			        SELECT	COUNT(*) AS TOT_CNT
			        FROM 	TBCSPNBK102L
			        WHERE  	MOUI_NO = #strMOUI_NO#
			        AND 	( INV_DEAL_DT > #strINV_DEAL_DT#
				  			OR
			     				( INV_DEAL_DT = #strINV_DEAL_DT#
			        			AND
			      				INV_DEAL_SLN >= #strINV_DEAL_SLN# )
			      			) 
				 ) A
		]]>
	</select>
	
	<select id="CSPNBK312PGetlnBbkFnlOtptRowNoParam" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT /* CSPNBK312PGetlnBbkFnlOtptRowNoParam */
					MOD(TO_NUMBER(#strPRT_LINE#)+TO_NUMBER(A.TOT_CNT), 24) AS TOT_PRT_LINE
			FROM	(
					SELECT	COUNT(*) AS TOT_CNT
					FROM	TBCSPNBK205L
					WHERE	MOUI_NO = #strMOUI_NO#
					AND		LEND_KND_CD = #strLEND_KND_CD#
					AND		(LEND_DEAL_DT > #strLEND_DEAL_DT#
								OR
								( LEND_DEAL_DT = #strLEND_DEAL_DT#
								AND
								LEND_DEAL_DT_SLN >= #strLEND_DEAL_DT_SLN# ) )     /* PARAM */
					) A
		]]>
	</select>
	
	<update id="CSPNBK312PBbkPrtYnParamUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK312PBbkPrtYnParamUpdate */ TBCSPNBK102L
		SET    	BBK_PRT_YN = 'Y'
				, FNL_USR_ID = #USR_ID#
				, FNL_DEAL_DPT_CD = #DPT_CD#
				, FNL_MNU_ID = #MNU_ID#
				, FNL_MDF_DH = SYSDATE
		WHERE  	MOUI_NO = #strMOUI_NO#
		AND	  	( INV_DEAL_DT > #strINV_DEAL_DT#
				OR
					( INV_DEAL_DT = #strINV_DEAL_DT#
					AND
					INV_DEAL_SLN >= #strINV_DEAL_SLN# )
			    )
	]]>
	</update>
	
	<update id="CSPNBK312PLnBbkPrtYnUpdateParam" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK312PLnBbkPrtYnUpdateParam */ TBCSPNBK205L
		SET    	BBK_PRT_YN = 'Y'
				, FNL_USR_ID = #USR_ID#
				, FNL_DEAL_DPT_CD = #DPT_CD#
				, FNL_MNU_ID = #MNU_ID#
				, FNL_MDF_DH = SYSDATE
		WHERE  	MOUI_NO = #strMOUI_NO#
		AND		(LEND_DEAL_DT > #strLEND_DEAL_DT#
			 		OR
			 		( LEND_DEAL_DT = #strLEND_DEAL_DT#
			 		AND
			 		LEND_DEAL_DT_SLN >= #strLEND_DEAL_DT_SLN# ) )
	]]>
	</update>
	
	<select id="CSPNBK312PReadPrintOutInvestParam" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT /* CSPNBK312PReadPrintOutInvestParam */
        	       MOUI_NO
        	       , TO_CHAR(TO_DATE(INV_DEAL_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS INV_DEAL_DT 
        	       , INV_DEAL_SLN
        	       , PET_DH
        	       , INV_AM
        	       , DEPTS_PMT_DVSN_CD
        	       , DEAL_BK_LEDG_BL
        	       , DEAL_AF_LEDG_BL
        	       , RMK
        	       , BBK_PRT_YN
        	       , INV_KND_CD
        	       , #FNL_OTPT_ROW_NO# AS TOT_FNL_OTPT_ROW_NO
        	FROM TBCSPNBK102L
			WHERE	MOUI_NO = #strMOUI_NO#
			AND		CNL_YN = 'N'
			AND		( INV_DEAL_DT >  #strINV_DEAL_DT#
					OR
					( INV_DEAL_DT =  #strINV_DEAL_DT#
					AND
					INV_DEAL_SLN >= #strINV_DEAL_SLN# ) )
			ORDER BY INV_DEAL_DT, INV_DEAL_SLN
		]]>
	</select>
	
	<select id="CSPNBK312PReadPrintOutlnParam" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
			SELECT /* CSPNBK312PReadPrintOutlnParam */
				MOUI_NO
				, TO_CHAR(TO_DATE(LEND_DEAL_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS LEND_DEAL_DT 
				, LEND_DEAL_DT_SLN
				, PET_DH
				, DEAL_PRN
				, DEPTS_PMT_DVSN_CD
				, LEND_BL
				, NVL(LAG_WDL_RMK, '') AS LAG_WDL_RMK
				, BBK_PRT_YN
				, NVL(LEND_DEAL_DVSN_CD, '0') AS LEND_DEAL_DVSN_CD
				, INT_AM
        	    , #FNL_OTPT_ROW_NO# AS TOT_FNL_OTPT_ROW_NO
			FROM	TBCSPNBK205L
			WHERE	MOUI_NO = #strMOUI_NO#
			AND		LEND_KND_CD = #strLEND_KND_CD#
			AND		CNL_YN = 'N'
			AND  	(LEND_DEAL_DT > #strLEND_DEAL_DT#
					OR
					( LEND_DEAL_DT = #strLEND_DEAL_DT#
					AND
					LEND_DEAL_DT_SLN >= #strLEND_DEAL_DT_SLN# ) )
			ORDER BY LEND_DEAL_DT, LEND_DEAL_DT_SLN
		]]>
	</select>
	
	<select id="CSPNBK312PGetOptName" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT	/* CSPNBK312PGetOptName */
					USR_NAM
			FROM	TBDCMACM001M
			WHERE	CNB = ( SELECT	CNB
							FROM	TBCSPNBK001M
							WHERE	MOUI_NO = (SELECT 	OPT_MOUI_NO
											   FROM		TBCSPNBK301M
											   WHERE	SMB_DEAL_DT = #strSMB_DEAL_DT#
											   AND		SMB_SNL = #strSMB_SLN#)
							)
		]]>
	</select>
	
</sqlMap>