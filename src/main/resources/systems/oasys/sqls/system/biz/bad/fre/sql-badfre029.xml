<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="bad/fre/029">
	
	<!-- 재심의심사청구 조회-->
	<select id="BADFRE029PMainList" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[
SELECT F_DPT_INFO(D1.ENFM_MNG_BRDV_CD, '1') AS DPT_NM
     , D1.ENFM_MNG_BRDV_CD
     , D1.GROUP_FLAG
     , D1.IN_TERM
     , D1.OUT_TERM
     , D1.HRA_CNT
     , D1.OVER_CNT
  FROM (
        SELECT E.ENFM_MNG_BRDV_CD
             , '처분요구' AS GROUP_FLAG
             , SUM(
                   CASE WHEN TO_CHAR(SYSDATE, 'YYYYMMDD') <= NVL(E.HNDL_DDLN_DT, '99991231') THEN 1
                        ELSE 0
                    END ) AS IN_TERM		/* 처분요구 기한내 */
             , SUM(
                   CASE WHEN TO_CHAR(SYSDATE, 'YYYYMMDD') > NVL(E.HNDL_DDLN_DT, '99991231') THEN 1
                        ELSE 0
                    END ) AS OUT_TERM		/* 처분요구 기한외 */
             /* , SUM(
                   CASE WHEN NVL(E.HRK_MNG_ASG_YN, 'N') = 'Y' THEN 1
                        ELSE 0
                    END ) AS HRA_CNT	     처분요구 HBA */
                    
              /* HRA 삭제, 집중관리 추가 - 2016.06.29 yyh*/
			   , SUM(
                   CASE WHEN E.NOT_CPLT_STA_DVSN_CD = '2' THEN 1
                        ELSE 0
                    END ) AS HRA_CNT		 /* 처분요구 집중관리 */                    
                    
             , SUM(NVL(F.TMP_CNT, 0))AS OVER_CNT      /* 처분요구 집행회보접수 */
          FROM TBBADEAR001M D
             , TBBADEAR002D E
		     , (
		       SELECT   1 AS TMP_CNT
		              , S1.AUD_YR
		              , S1.AUD_NO
		              , S1.DSP_RQ_SNO
		         FROM TBBADFRE001H S1
		        WHERE 1 = 1
		          AND S1.BAI_CHGD_ACP_DT IS NULL
		        GROUP BY S1.AUD_YR
		               , S1.AUD_NO
		               , S1.DSP_RQ_SNO
		       ) F
         WHERE 1=1
           AND D.AUD_YR                 = E.AUD_YR(+)
           AND D.AUD_NO                 = E.AUD_NO(+) 
           AND D.DSP_RQ_SNO             = E.DSP_RQ_SNO(+)
           AND D.AUD_YR                 = F.AUD_YR(+)
           AND D.AUD_NO                 = F.AUD_NO(+)
           AND D.DSP_RQ_SNO             = F.DSP_RQ_SNO(+)
           AND E.DTM_STA_CD = '1' 
           AND D.DSP_RQ_KND_CD IN ('110', '210', '310', '320', '391', '800', '810', '820', '830', '840', '850')
           AND E.ENFM_MNG_BRDV_CD IN (
           SELECT DPT_CD
             FROM TBDCMACM002M START WITH DPT_CD = #searchKey# CONNECT BY PRIOR DPT_CD = HIRK_DPT_CD
           ) 
           AND E.ENFM_MNG_BRDV_CD NOT IN (#searchKey#)
GROUP BY E.ENFM_MNG_BRDV_CD
UNION ALL
        SELECT E.ENFM_MNG_BRDV_CD
             , '권고.통보' AS GROUP_FLAG
             , SUM(
                   CASE WHEN TO_CHAR(SYSDATE, 'YYYYMMDD') <= NVL(E.HNDL_DDLN_DT, '99991231') THEN 1
                        ELSE 0
                    END ) AS IN_TERM		/* 처분요구 기한내 */
             , SUM(
                   CASE WHEN TO_CHAR(SYSDATE, 'YYYYMMDD') > NVL(E.HNDL_DDLN_DT, '99991231') THEN 1
                        ELSE 0
                    END ) AS OUT_TERM		/* 처분요구 기한외 */
             /*, SUM(
                   CASE WHEN NVL(E.HRK_MNG_ASG_YN, 'N') = 'Y' THEN 1
                        ELSE 0
                    END ) AS HRA_CNT		 처분요구 HBA */
                    
              /* HRA 삭제, 집중관리 추가 - 2016.06.29 yyh*/
			   , SUM(
                   CASE WHEN E.NOT_CPLT_STA_DVSN_CD = '2' THEN 1
                        ELSE 0
                    END ) AS HRA_CNT		 /* 처분요구 집중관리 */                    
                    
             , SUM(NVL(F.TMP_CNT, 0))AS OVER_CNT      /* 처분요구 집행회보접수 */
          FROM TBBADEAR001M D
             , TBBADEAR002D E
		     , (
		       SELECT   1 AS TMP_CNT
		              , S1.AUD_YR
		              , S1.AUD_NO
		              , S1.DSP_RQ_SNO
		         FROM TBBADFRE001H S1
		        WHERE 1 = 1
		          AND S1.BAI_CHGD_ACP_DT IS NULL
		        GROUP BY S1.AUD_YR
		               , S1.AUD_NO
		               , S1.DSP_RQ_SNO
		       ) F
         WHERE 1=1
           AND D.AUD_YR                 = E.AUD_YR(+)
           AND D.AUD_NO                 = E.AUD_NO(+) 
           AND D.DSP_RQ_SNO             = E.DSP_RQ_SNO(+)
           AND D.AUD_YR                 = F.AUD_YR(+)
           AND D.AUD_NO                 = F.AUD_NO(+)
           AND D.DSP_RQ_SNO             = F.DSP_RQ_SNO(+)
           AND E.DTM_STA_CD = '1'  
           AND D.DSP_RQ_KND_CD IN ('510','520','530','610','611', '620', '621', '623', '630')
           AND E.ENFM_MNG_BRDV_CD IN (
           SELECT DPT_CD
             FROM TBDCMACM002M START WITH DPT_CD = #searchKey# CONNECT BY PRIOR DPT_CD = HIRK_DPT_CD
           ) 
           AND E.ENFM_MNG_BRDV_CD NOT IN (#searchKey#)
GROUP BY E.ENFM_MNG_BRDV_CD
) D1
ORDER BY D1.ENFM_MNG_BRDV_CD
       , D1.GROUP_FLAG DESC
	]]>
	</select>
</sqlMap> 
