<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="csp/nbk/512">
	
	<select id="CSPNBK512EDvdRtsInfoSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK512EDvdRtsInfoSelect */
				D2.DVD_YR
				, D2.CALCU_ACM
				, D2.ELT_CRFW_PRF_M
				, D2.THTM_UN_DSP_PRF_SP
				, D2.THTM_PIA_DVD_M
				, D2.THTM_DVD_TG_PRF_M
				, D2.TOT_ACM
				, D2.THTM_DVD_TG_PRF_M - (D2.WTDW_DVD_AM + D2.NWD_DVD_AM + D2.EX_DVD_AM) AS BAL_AM
				, D2.WTDW_ACM
				, D2.WTDW_DVD_RTS
				, D2.WTDW_DVD_AM
				, D2.NWD_ACM
				, D2.NWD_DVD_RTS
				, D2.NWD_DVD_AM
				, D2.EX_ACM
				, D2.EX_DVD_RTS
				, D2.EX_DVD_AM
				, D2.WTDW_DVD_AM + D2.NWD_DVD_AM + D2.EX_DVD_AM AS TOT_DVD_AM
				, D2.TOT_MOUI_DVD_AM
				, D2.THTM_DVD_TG_PRF_M - D2.TOT_MOUI_DVD_AM AS BAL_DVD_AM
				, D2.DVD_RTS_CHG_YN
		FROM	(
					SELECT	D1.DVD_YR
							, NVL((FLOOR(D1.THTM_DVD_TG_PRF_M * 365 / (D1.WTDW_ACM + D1.NWD_ACM + D1.EX_ACM) * 100 * 10000) / 10000), 0) AS CALCU_ACM
							, D1.ELT_CRFW_PRF_M
							, D1.THTM_UN_DSP_PRF_SP
							, D1.THTM_PIA_DVD_M
							, D1.THTM_DVD_TG_PRF_M
							, D1.WTDW_ACM + D1.NWD_ACM + D1.EX_ACM AS TOT_ACM
							, D1.WTDW_ACM
							, D1.WTDW_DVD_RTS
							, FLOOR(D1.WTDW_ACM * D1.WTDW_DVD_RTS / 100 / 365) AS WTDW_DVD_AM
							, D1.NWD_ACM
							, D1.NWD_DVD_RTS
							, FLOOR(D1.NWD_ACM * D1.NWD_DVD_RTS / 100 / 365) AS NWD_DVD_AM
							, D1.EX_ACM
							, D1.EX_DVD_RTS
							, FLOOR(D1.EX_ACM * D1.EX_DVD_RTS / 100 / 365) AS EX_DVD_AM
							, (
								SELECT	SUM(D3.DVD_AM)
								FROM	TBCSPNBK402M D3
								WHERE	D3.DVD_YR = D1.DVD_YR
							) AS TOT_MOUI_DVD_AM
							, D1.DVD_RTS_CHG_YN
					FROM	TBCSPNBK401M D1
					WHERE	D1.DVD_YR = #dvdYr#
				) D2
	]]>
	</select>
	
	<delete id="CSPNBK512EDvdRtsInfoDelete" parameterClass="paramMap">
	<![CDATA[
		DELETE 	FROM /* CSPNBK512EDvdRtsInfoDelete */ TBCSPNBK401M D1
		WHERE	D1.DVD_YR = #dvdYr#
	]]>
	</delete>
	
	<delete id="CSPNBK512EDvdMouiListDelete" parameterClass="paramMap">
	<![CDATA[
		DELETE 	FROM /* CSPNBK512EDvdMouiListDelete */ TBCSPNBK402M D1
		WHERE	D1.DVD_YR = #dvdYr#
	]]>
	</delete>
	
	<update id="CSPNBK512EDvdRtsInfoUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK512EDvdRtsInfoUpdate */ TBCSPNBK401M
		SET		WTDW_DVD_RTS = #WTDW_DVD_RTS#
				, NWD_DVD_RTS = #NWD_DVD_RTS#
				, EX_DVD_RTS = #EX_DVD_RTS#
				, DVD_RTS_CHG_YN = 'Y'
				, FNL_USR_ID = #usrId#
				, FNL_DEAL_DPT_CD = #dptCd#
				, FNL_MNU_ID = #mnuId#
				, FNL_MDF_DH = SYSDATE
		WHERE	DVD_YR = #DVD_YR#
	]]>
	</update>
	
	<update id="CSPNBK512EDvdRtsChgYnUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	/* CSPNBK512EDvdRtsInfoUpdate */ TBCSPNBK401M
		SET		DVD_RTS_CHG_YN = #dvdRtsChgYn#
				, FNL_USR_ID = #usrId#
				, FNL_DEAL_DPT_CD = #dptCd#
				, FNL_MNU_ID = #mnuId#
				, FNL_MDF_DH = SYSDATE
		WHERE	DVD_YR = #dvdYr#
	]]>
	</update>
	
	<select id="CSPNBK512EDvdMouiListSelect" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT	/* CSPNBK512EDvdMouiListSelect */
				D1.DVD_YR
				, F_CODE_NM( '1000153', D2.MOUI_DVSN_CD) AS MOUI_DVSN_NM
				, D1.MOUI_NO
				, DECODE( D2.MOUI_DVSN_CD, '0', D3.USR_NAM, '1', D2.OGNZ_NM ) AS MOUI_NM
				, D2.CNB
				, D1.WTDW_ACM
				, D1.NWD_ACM
				, D1.EX_ACM
				, D1.DVD_AM
				, D1.CSH_DVD_YN
				, D4.INV_BL
		FROM	TBCSPNBK402M D1
				, TBCSPNBK001M D2
				, TBDCMACM001M D3
				, TBCSPNBK101M D4
		WHERE	D1.MOUI_NO = D2.MOUI_NO
		AND		D2.CNB = D3.CNB
		AND		D1.MOUI_NO = D4.MOUI_NO(+)
		AND		D1.DVD_YR = #dvdYr#
	]]>
	<isNotEmpty property="mouiNo" prepend="AND">
				D1.MOUI_NO = #mouiNo#
	</isNotEmpty>
	<isNotEmpty property="mouiNm" prepend="AND">
				( D3.USR_NAM LIKE '%' || #mouiNm# || '%' OR D2.OGNZ_NM LIKE '%' || #mouiNm# || '%' )
	</isNotEmpty>
	<isNotEmpty property="cshDvdYn" prepend="AND">
				D1.CSH_DVD_YN = #cshDvdYn#
	</isNotEmpty>
	<![CDATA[
		ORDER BY MOUI_NO
	]]>
	</select>
	
	<select id="CSPNBK512EDvdCompleteChekSelect" parameterClass="paramMap" resultClass="String">
	<![CDATA[
		SELECT	D1.DVD_YR
		FROM	TBCSPNBK401M D1
		WHERE	D1.DVD_YR = #dvdYr#
		AND		D1.DVD_HNDL_STA_CD = '1'
	]]>
	</select>
	
	<update id="CSPNBK512EDvdHndlStaCdUpdate" parameterClass="paramMap">
	<![CDATA[
		UPDATE	TBCSPNBK401M D1
		SET		DVD_HNDL_STA_CD = #dvdHndlStaCd#
				, FNL_USR_ID = #usrId#
				, FNL_DEAL_DPT_CD = #dptCd#
				, FNL_MNU_ID = #mnuId#
				, FNL_MDF_DH = SYSDATE
		WHERE	D1.DVD_YR = #dvdYr#
	]]>
	</update>
	
	<select id="CSPNBK512ESelectReport1" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT  COUNT(MOUI_NO) AS MOUI_NO,
		        NVL(SUM(WTDW_ACM) + SUM(NWD_ACM)  + SUM(EX_ACM), 0) AS ACC_AMOUNT,
		        NVL(SUM(DVD_AM), 0) AS DVD_AM1,
		        NVL(SUM(DVD_AM), 0) AS DVD_AM2,
		        '' AS REMARK
		FROM    TBCSPNBK402M
		WHERE   CSH_DVD_YN = 'Y'
		AND     DVD_YR = #dvdYr#
	]]>
	</select>
	
	<select id="CSPNBK512ESelectReport2" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT  FLOOR(A.WTDW_ACM * B.WTDW_DVD_RTS / 10 / 365) EASY_APP,
		        B.WTDW_DVD_RTS AS WTDW_DVD_RTS,
		        FLOOR(A.NWD_ACM * B.NWD_DVD_RTS / 10 / 365) HARD_APP,
		        B.NWD_DVD_RTS AS NWD_DVD_RTS,
		        FLOOR(A.EX_ACM * B.EX_DVD_RTS / 10 / 365) EXC_APP,
		        B.EX_DVD_RTS AS EX_DVD_RTS
		FROM    ( SELECT  SUM(WTDW_ACM) AS WTDW_ACM, 
		                  SUM(NWD_ACM) AS NWD_ACM, 
		                  SUM(EX_ACM) AS EX_ACM
		          FROM    TBCSPNBK402M
		          WHERE   CSH_DVD_YN = 'Y'
		          AND     DVD_YR = #dvdYr# ) A
		        , TBCSPNBK401M B
		WHERE   B.DVD_YR = #dvdYr#
	]]>
	</select>
	
	<select id="CSPNBK512ESelectReport3" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT  COUNT(MOUI_NO) CNT_2,
		        NVL(SUM(WTDW_ACM) + SUM(NWD_ACM) + SUM(EX_ACM), 0) ACC_AMOUNT_2,
		        NVL(SUM(DVD_AM), 0) AS DVD_AM1_2,
		        '' REMARK_2
		FROM    TBCSPNBK402M
		WHERE   CSH_DVD_YN = 'N'
		AND     DVD_YR = #dvdYr#
	]]>
	</select>
	
	<select id="CSPNBK512ESelectReport4" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		SELECT  FLOOR(A.WTDW_ACM * B.WTDW_DVD_RTS / 10 / 365) AS EASY_APP_2,
		        B.WTDW_DVD_RTS AS WTDW_ACM_PER_2,
		        FLOOR(A.NWD_ACM * B.NWD_DVD_RTS / 10 / 365) AS HARD_APP_2,
		        B.NWD_DVD_RTS AS NWD_ACM_PER_2,
		        FLOOR(A.EX_ACM * B.EX_DVD_RTS / 10 / 365) AS EXC_APP_2,
		        B.EX_DVD_RTS AS EX_ACM_PER_2
		FROM    ( SELECT  SUM(WTDW_ACM) WTDW_ACM
		                  , SUM(NWD_ACM) NWD_ACM
		                  , SUM(EX_ACM) EX_ACM
		          FROM    TBCSPNBK402M
		          WHERE   CSH_DVD_YN = 'N'
		          AND DVD_YR = #dvdYr# ) A
		        , TBCSPNBK401M B
		WHERE   B.DVD_YR = #dvdYr#
	]]>
	</select>
	
	<select id="CSPNBK512ESelectReport5" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		/*
		 * 예상이익금배당지급자
		 *         위의 타이틀부분
		 */
		SELECT  DVD_YR,
		        THTM_DVD_TG_PRF_M,
		        WTDW_ACM + NWD_ACM + EX_ACM AS ACC,
		        WTDW_DVD_RTS,
		        NWD_DVD_RTS,
		        EX_DVD_RTS
		FROM    TBCSPNBK401M
		WHERE   DVD_YR = #dvdYr#
	]]>
	</select>
	
	<select id="CSPNBK512ESelectReport6" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		/*
		 * 예상이익금배당지급자
		 *       중간 리스트부분
		 */
		SELECT  '개인' AS MOUI_DVSN,
		        A.MOUI_NO,
		        NVL(C.USR_NAM,'') AS USR_NAM,
		        NVL(B.CNB, '') AS CNB,
		        D.DPT_NM,
		        E.CD_NM,
		        A.WTDW_ACM,
		        A.NWD_ACM,
		        A.EX_ACM,
		        A.DVD_AM
		FROM    TBCSPNBK402M A,
		        TBCSPNBK001M B,
		        TBDCMACM001M C,
		        TBDCMACM002M D,
		        TBDCMACM013C E
		WHERE   A.DVD_YR = #dvdYr#
		AND     A.MOUI_NO = B.MOUI_NO
		AND     B.MOUI_DVSN_CD = '0'
		AND     B.CNB = C.CNB
		AND     C.DPT_CD = D.DPT_CD
		AND     E.CMM_CD_DVSN_CD = '1000173'
		AND     E.CD = C.RANK_CD
		UNION
		SELECT  '단체' AS MOUI_DVSN,
		        A.MOUI_NO,
		        NVL(B.OGNZ_NM,'') AS USR_NAM,
		        '' AS CNB,
		        '' AS DPT_NM,
		        '' AS CD_NM,
		        A.WTDW_ACM,
		        A.NWD_ACM,
		        A.EX_ACM,
		        A.DVD_AM
		FROM    TBCSPNBK402M A,
		        TBCSPNBK001M B
		WHERE   A.DVD_YR = #dvdYr#
		AND     A.MOUI_NO = B.MOUI_NO
		AND     B.MOUI_DVSN_CD = '1'
	]]>
	</select>
	
	<select id="CSPNBK512ESelectReport7" parameterClass="paramMap" resultClass="resultMap">
	<![CDATA[
		/*
		 * 예상이익금배당지급자
		 *         아래부분
		 */
		
		SELECT  COUNT(MOUI_NO) AS MOUI_NO_CNT, SUM(DVD_AM) AS DVD_AM
		FROM    TBCSPNBK402M
		WHERE   DVD_YR =#dvdYr#
	]]>
	</select>
</sqlMap>