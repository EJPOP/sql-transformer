<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/ded/123">

	<!-- 전뭌가 자문비 기분을  조회한다.  -->
	<select id="BADDED123PMainSelect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[       
			SELECT M.BZT_YR
			     , M.BZT_SNO
			     , M.PCT_CNB PCT_CNB
			     , M.PCT_RANK_CD
			     , M.PCT_NM
			     , NVL(A.DT_EXS_STAD_AM, STD.BZT_STAD_AM) DT_EXS_STAD_AM
			  FROM TBBADDED007B A
			     , (SELECT BZT_YR
			             , BZT_SNO
			             , PCT_CNB
			             , MAX(PCT_NM) PCT_NM
			             , MAX(PCT_RANK_CD) PCT_RANK_CD
			          FROM TBBADDED005L
			         WHERE BZT_YR = #BZT_YR#
			           AND BZT_SNO = #BZT_SNO#
			           AND STF_DVSN_CD = '3' /*전문가코드*/
			         GROUP BY BZT_YR, BZT_SNO, PCT_CNB) M
			     , TBBADDED180B    STM
			     , TBBADDED018B    STD
			 WHERE A.BZT_YR(+)      = M.BZT_YR
			   AND A.BZT_SNO(+)     = M.BZT_SNO
			   AND A.PCT_CNB(+)     = M.PCT_CNB
			   AND STM.BZT_SRNO     = STD.BZT_SRNO
			   AND STM.STAD_STR_DT <= REPLACE(#AUD_STR_DT#,'-','') AND STM.STAD_END_DT >= REPLACE(#AUD_STR_DT#,'-','')
			   AND STD.RGN_DVSN_CD  = '0'  /*전체지역*/
			   AND STD.RANK_DVSN_CD = '00' /*전체직급*/
			   AND STD.TREXP_CLU_CD = '02' /*일비 */
			   AND STM.BZT_DVSN_CD  = #BZT_DVSN_CD# /* 츌장구분코드 추가 - 2015.06.01 yyh */
		]]>
	</select>

	<!--전문가 자문비 기준을  저장한다. update-->
	<update id="BADDED123PMainUpdate" parameterClass="paramMap">
        <![CDATA[            
			MERGE INTO TBBADDED007B
			USING DUAL
			   ON (     
			            BZT_YR  = #BZT_YR#
			        AND BZT_SNO = #BZT_SNO#
			        AND PCT_CNB = #PCT_CNB# 
			      ) 
			 WHEN MATCHED THEN 
			    UPDATE 
			       SET DT_EXS_STAD_AM 	= #DT_EXS_STAD_AM# 
			         , FNL_USR_ID       = #FNL_USR_ID#
			         , FNL_DEAL_DPT_CD  = #FNL_DEAL_DPT_CD#
			         , FNL_MNU_ID       = #FNL_MNU_ID#
			         , FNL_MDF_DH       = SYSDATE
			 WHEN NOT MATCHED THEN   
			    INSERT( 
			           BZT_YR
			         , BZT_SNO
			         , PCT_CNB
			         , DT_EXS_STAD_AM
			         , FRT_USR_ID
			         , FNL_USR_ID
			         , FNL_DEAL_DPT_CD
			         , FNL_MNU_ID
			         , FRT_REGI_DH
			         , FNL_MDF_DH )
			    VALUES( 
			           #BZT_YR#
			         , #BZT_SNO#
			         , #PCT_CNB#
			         , #DT_EXS_STAD_AM#
			         , #FRT_USR_ID#
			         , #FNL_USR_ID#
			         , #FNL_DEAL_DPT_CD#
			         , #FNL_MNU_ID#
			         , #FRT_REGI_DH#
			         , #FNL_MDF_DH#
			    ) 
			             
		]]>
	</update>
</sqlMap> 

