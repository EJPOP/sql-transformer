<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="aep/gkm/013">
	<select id="aepgkm013select" parameterClass="java.util.Map" resultClass="java.util.HashMap">
              <include refid="include.pageSelct" />
						SELECT	C.AUD_YR AS AUD_YR
								,C.AUD_NO AS AUD_NO
								,C.AUD_YR || '-' || C.AUD_NO AS AUD_YR_NO
								,TO_CHAR(TO_DATE( MIN(B.AUD_STR_DT), 'YYYYMMDD'), 'YYYY.MM.DD')||'~'||TO_CHAR(TO_DATE( MIN(B.AUD_END_DT), 'YYYYMMDD'), 'YYYY.MM.DD') AS AUD_STR_END
                                ,F_CODE_NM('1000007',C.AUD_KND_CD) AS AUD_KND_NM
								,MAX(C.AUD_SBJ_NM) AS AUD_SBJ_NM
						      	,MIN(A.ORG_CD) AS ORG_CD
						      	,MAX(A.TEAM_SNO) AS TEAM_SNO
						     	,MIN(B.AUD_STR_DT) AS AUD_STR_DT
						     	,MAX(B.AUD_END_DT) AS AUD_END_DT
								,MAX(B.AUD_DCN) AS AUD_DCN
								,MAX(B.BZT_TL_CNB) AS BZT_TL_CNB
								,MAX(B.AUD_BZT_KND_CD) AS AUD_BZT_KND_CD
								,MAX(C.AUD_TASK_CD) AS AUD_TASK_CD
								,MAX(C.ORG_DVSN_CD) AS ORG_DVSN_CD
								,MAX(C.AUD_KND_CD) AS AUD_KND_CD
								,MAX(C.SPVR_BRDV_CD) AS SPVR_BRDV_CD
								,D.DPT_NM AS DPT_NM
								,MAX(C.AUD_WAY_CD) AS AUD_WAY_CD
						FROM	TBBADDED008L A
								,TBBADDED002M B
								,TBBADDED001M C
								,TBDCMACM002M D
						WHERE	1=1
						AND		A.BZT_YR = B.BZT_YR  
						AND 	A.BZT_SNO = B.BZT_SNO  
						AND 	B.BZT_DVSN_CD = '1' 
						AND 	C.AUD_YR = B.REL_AUD_YR  
						AND 	C.AUD_NO = B.REL_AUD_NO
						AND		C.SPVR_BRDV_CD = D.DPT_CD(+)
						<isNotEmpty property="ORG_CD" prepend="AND">
							A.ORG_CD = #ORG_CD# <!-- 대상기관 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_YR" prepend="AND">
							C.AUD_YR = #AUD_YR# <!-- 감사년도 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_KND_CD" prepend="AND">
							C.AUD_KND_CD = #AUD_KND_CD# <!-- 감사종류 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_YR_NO" prepend="AND">
							C.AUD_YR||C.AUD_NO = #AUD_YR_NO# <!-- 감사연번 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_SBJ_NM" prepend="AND">
							C.AUD_SBJ_NM LIKE '%' || #AUD_SBJ_NM# || '%' <!-- 감사사항명 -->
						</isNotEmpty>
						GROUP BY C.AUD_YR
								 ,C.AUD_NO
								 ,C.AUD_KND_CD
								 ,D.DPT_NM
						ORDER BY C.AUD_YR DESC
								 ,C.AUD_NO
            <include refid="include.pageOrder" />
	</select>
	
	<!-- 팝업띄우기 전 카운트 체크 -->
	<select id="aepgkm013PopCntselect" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT AUD_YR AS AUD_YR 
             , AUD_NO AS AUD_NO 
             , AUD_SBJ_NM AS AUD_SBJ_NM 
             , AUD_KND_CD AS AUD_KND_CD 
             , TO_CHAR(COUNT(1) OVER()) AS TOT_CNT
		 FROM TBBADDED001M 
		WHERE 1=1
		<isNotEmpty property="strAudSbjNm" prepend="AND">
			AUD_SBJ_NM LIKE '%' || #strAudSbjNm# || '%' 
		</isNotEmpty>
	</select>
	
	<select id="aepgkm013YearListselect" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT DISTINCT (AUD_YR) FROM TBBADDED001M ORDER BY AUD_YR DESC
	</select>
	
	<!-- jsp 단 쿼리 -->
	<select id="AEPGKM013P.SELECT" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT	A.*, B.ORG_NM 
		FROM	(
				SELECT	FLOOR((ROWNUM - 1) / #SRN# + 1) AS PAGE,
						A.*
				FROM	(
						SELECT	C.AUD_YR AS AUD_YR,
								C.AUD_NO AS AUD_NO,
								C.AUD_YR || '-' || C.AUD_NO AS AUD_YR_NO,
								MAX(C.AUD_SBJ_NM) AS AUD_SBJ_NM,
						      	MIN(A.ORG_CD) AS ORG_CD,
						      	MAX(A.TEAM_SNO) AS TEAM_SNO,
						     	MIN(B.AUD_STR_DT) AS AUD_STR_DT,
						     	MAX(B.AUD_END_DT) AS AUD_END_DT,
								MAX(B.AUD_DCN) AS AUD_DCN,
								MAX(B.BZT_TL_CNB) AS BZT_TL_CNB,
								MAX(B.AUD_BZT_KND_CD) AS AUD_BZT_KND_CD,
								MAX(C.AUD_TASK_CD) AS AUD_TASK_CD,
								MAX(C.ORG_DVSN_CD) AS ORG_DVSN_CD,
								MAX(C.AUD_KND_CD) AS AUD_KND_CD,
								(
								SELECT	CD_NM
								FROM	TBDCMACM013C
								WHERE	CD = C.AUD_KND_CD
								AND		CMM_CD_DVSN_CD='AA07'
								) AS AUD_KND_NM,
								MAX(C.SPVR_BRDV_CD) AS SPVR_BRDV_CD,
								D.DPT_NM AS DPT_NM,
								MAX(C.AUD_WAY_CD) AS AUD_WAY_CD
						FROM	TBBADDED008L A,
								TBBADDED002M B,
								TBBADDED001M C,
								TBDCMACM002M D
						WHERE	1=1
						AND		A.BZT_YR = B.BZT_YR  
						AND 	A.BZT_SNO = B.BZT_SNO  
						AND 	B.BZT_DVSN_CD = '1' 
						AND 	C.AUD_YR = B.REL_AUD_YR  
						AND 	C.AUD_NO = B.REL_AUD_NO
						AND		C.SPVR_BRDV_CD = D.DPT_CD(+)
						<isNotEmpty property="ORG_CD" prepend="AND">
							A.ORG_CD = #ORG_CD# <!-- 대상기관 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_YR" prepend="AND">
							C.AUD_YR = #AUD_YR# <!-- 감사년도 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_KND_CD" prepend="AND">
							C.AUD_KND_CD = #AUD_KND_CD# <!-- 감사종류 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_YR_NO" prepend="AND">
							C.AUD_YR||C.AUD_NO = #AUD_YR_NO# <!-- 감사연번 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_SBJ_NM" prepend="AND">
							C.AUD_SBJ_NM LIKE '%' || #AUD_SBJ_NM# || '%' <!-- 감사사항명 -->
						</isNotEmpty>
						GROUP BY C.AUD_YR,
								 C.AUD_NO,
								 C.AUD_KND_CD,
								 D.DPT_NM
						ORDER BY C.AUD_YR DESC,
								 C.AUD_NO
						) AS A
				) AS A,
				TBDCMACM015M B
		WHERE	A.ORG_CD = B.ORG_CD
		AND		PAGE = #CPN#
		ORDER BY PAGE;
	</select>
	
	<select id="AEPGKM013P.SELECT.TAB" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT	TAB,
				MIN(PAGE) AS MIN_PAGE,
				MAX(PAGE) AS MAX_PAGE
		FROM	(
				SELECT	FLOOR((ROWNUM - 1) / #SRN# + 1) AS PAGE,
						FLOOR((FLOOR((ROWNUM - 1) / #SRN# + 1) - 1) / 10) AS TAB
				FROM	(
						SELECT	MAX(C.AUD_SBJ_NM) AS AUD_SBJ_NM<!-- 감사사항명 -->,
						      	MIN(A.ORG_CD) AS ORG_CD<!-- 대상기관코드 -->,
						      	MAX(A.TEAM_SNO) AS TEAM_SNO<!-- 출장조순번 -->,
						      	MIN(B.AUD_STR_DT) AS AUD_STR_DT<!-- 감사시작일 -->,
						      	MAX(B.AUD_END_DT) AS AUD_END_DT<!-- 감사종료일 -->,
						      	MAX(B.AUD_DCN) AS AUD_DCN<!-- 감사일수 -->,
						      	MAX(B.BZT_TL_CNB) AS BZT_TL_CNB<!-- 출장반장전산번호 -->,
						      	MAX(B.AUD_BZT_KND_CD) AS AUD_BZT_KND_CD<!-- 감사출장종류코드 -->,
						      	MAX(C.AUD_TASK_CD) AS AUD_TASK_CD<!-- 감사과제코드 -->,
						      	MAX(C.ORG_DVSN_CD) AS ORG_DVSN_CD<!-- 기관구분코드 -->,
						      	MAX(C.AUD_KND_CD) AS AUD_KND_CD<!-- 감사종류코드 -->,
						      	MAX(C.SPVR_BRDV_CD) AS SPVR_BRDV_CD<!-- 주관국과코드 -->,
						      	MAX(C.AUD_WAY_CD) AS AUD_WAY_CD<!-- 감사방법코드  --> 						
						FROM	TBBADDED008L A,
								TBBADDED002M B,
								TBBADDED001M C
						WHERE	1=1
						AND		A.BZT_YR = B.BZT_YR  
						AND 	A.BZT_SNO = B.BZT_SNO  
						AND 	B.BZT_DVSN_CD = '1' 
						AND 	C.AUD_YR = B.REL_AUD_YR  
						AND 	C.AUD_NO = B.REL_AUD_NO
						<isNotEmpty property="ORG_CD" prepend="AND">
							A.ORG_CD = #ORG_CD# <!-- 대상기관 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_YR" prepend="AND">
							C.AUD_YR = #AUD_YR# <!-- 감사년도 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_KND_CD" prepend="AND">
							C.AUD_KND_CD = #AUD_KND_CD# <!-- 감사종류 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_YR_NO" prepend="AND">
							C.AUD_YR||C.AUD_NO = #AUD_YR_NO# <!-- 감사연번 -->
						</isNotEmpty>
						<isNotEmpty property="AUD_SBJ_NM" prepend="AND">
							C.AUD_SBJ_NM LIKE '%' || #AUD_SBJ_NM# || '%' <!-- 감사사항명 -->
						</isNotEmpty>
						GROUP BY C.AUD_YR, C.AUD_NO, C.AUD_KND_CD
						ORDER BY C.AUD_YR DESC, C.AUD_NO
						)
				)
		WHERE	TAB = #TAB#
		GROUP BY TAB;
	</select>
	
	<select id="AEPGKM013P.TOTAL" parameterClass="java.util.Map" resultClass="java.lang.Integer">
		SELECT	MAX(FLOOR((ROWNUM - 1) / #SRN# + 1)) AS TOTAL
		FROM	(
				SELECT	C.AUD_YR AS AUD_YR<!-- 감사년도 -->, 
				      	C.AUD_NO AS AUD_NO<!-- 감사순번 -->,
				      	C.AUD_YR||'-'|| C.AUD_NO AS AUD_YR_NO<!-- 감사연번호 -->,
				      	MAX(C.AUD_SBJ_NM) AS AUD_SBJ_NM<!-- 감사사항명 -->,
				      	MIN(A.ORG_CD) AS ORG_CD<!-- 대상기관코드 -->,
				      	MAX(A.TEAM_SNO) AS TEAM_SNO<!-- 출장조순번 -->,
				      	MIN(B.AUD_STR_DT) AS AUD_STR_DT<!-- 감사시작일 -->,
				      	MAX(B.AUD_END_DT) AS AUD_END_DT<!-- 감사종료일 -->,
				      	MAX(B.AUD_DCN) AS AUD_DCN<!-- 감사일수 -->,
				      	MAX(B.BZT_TL_CNB) AS BZT_TL_CNB<!-- 출장반장전산번호 -->,
				      	MAX(B.AUD_BZT_KND_CD) AS AUD_BZT_KND_CD<!-- 감사출장종류코드 -->,
				      	MAX(C.AUD_TASK_CD) AS AUD_TASK_CD<!-- 감사과제코드 -->,
				      	MAX(C.ORG_DVSN_CD) AS ORG_DVSN_CD<!-- 기관구분코드 -->,
				      	MAX(C.AUD_KND_CD) AS AUD_KND_CD<!-- 감사종류코드 -->,
				      	(SELECT CD_NM FROM TBDCMACM013C WHERE CD = C.AUD_KND_CD AND CMM_CD_DVSN_CD='AA07') AS AUD_KND_NM<!-- 감사종류명 -->,
				      	MAX(C.SPVR_BRDV_CD) AS SPVR_BRDV_CD<!-- 주관국과코드 -->,
				      	MAX(C.AUD_WAY_CD) AS AUD_WAY_CD<!-- 감사방법코드  --> 						
				FROM	TBBADDED008L A,
						TBBADDED002M B,
						TBBADDED001M C
				WHERE	1=1
				AND		A.BZT_YR = B.BZT_YR  
				AND 	A.BZT_SNO = B.BZT_SNO  
				AND 	B.BZT_DVSN_CD = '1' 
				AND 	C.AUD_YR = B.REL_AUD_YR  
				AND 	C.AUD_NO = B.REL_AUD_NO
				<isNotEmpty property="ORG_CD" prepend="AND">
					A.ORG_CD = #ORG_CD# <!-- 대상기관 -->
				</isNotEmpty>
				<isNotEmpty property="AUD_YR" prepend="AND">
					C.AUD_YR = #AUD_YR# <!-- 감사년도 -->
				</isNotEmpty>
				<isNotEmpty property="AUD_KND_CD" prepend="AND">
					C.AUD_KND_CD = #AUD_KND_CD# <!-- 감사종류 -->
				</isNotEmpty>
				<isNotEmpty property="AUD_YR_NO" prepend="AND">
					C.AUD_YR||C.AUD_NO = #AUD_YR_NO# <!-- 감사연번 -->
				</isNotEmpty>
				<isNotEmpty property="AUD_SBJ_NM" prepend="AND">
					C.AUD_SBJ_NM LIKE '%' || #AUD_SBJ_NM# || '%' <!-- 감사사항명 -->
				</isNotEmpty>
				GROUP BY C.AUD_YR, C.AUD_NO, C.AUD_KND_CD
				ORDER BY C.AUD_YR DESC, C.AUD_NO
				)
	</select>
	
	<select id="AEPGKM013P.SELECT.AUD_YR" resultClass="java.util.HashMap">
		SELECT	DISTINCT AUD_YR
		FROM	TBBADDED001M
	</select>
	
	<select id="AEPGKM013P.SELECT.AUD_KND_CD" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT 	DISTINCT AUD_KND_CD, AUD_KND_NM
		FROM	(
				SELECT	C.AUD_YR AS AUD_YR<!-- 감사년도 -->, 
				      	C.AUD_NO AS AUD_NO<!-- 감사순번 -->,
				      	C.AUD_YR||'-'|| C.AUD_NO AS AUD_YR_NO<!-- 감사연번호 -->,
				      	MAX(C.AUD_SBJ_NM) AS AUD_SBJ_NM<!-- 감사사항명 -->,
				      	MIN(A.ORG_CD) AS ORG_CD<!-- 대상기관코드 -->,
				      	MAX(A.TEAM_SNO) AS TEAM_SNO<!-- 출장조순번 -->,
				      	MIN(B.AUD_STR_DT) AS AUD_STR_DT<!-- 감사시작일 -->,
				      	MAX(B.AUD_END_DT) AS AUD_END_DT<!-- 감사종료일 -->,
				      	MAX(B.AUD_DCN) AS AUD_DCN<!-- 감사일수 -->,
				      	MAX(B.BZT_TL_CNB) AS BZT_TL_CNB<!-- 출장반장전산번호 -->,
				      	MAX(B.AUD_BZT_KND_CD) AS AUD_BZT_KND_CD<!-- 감사출장종류코드 -->,
				      	MAX(C.AUD_TASK_CD) AS AUD_TASK_CD<!-- 감사과제코드 -->,
				      	MAX(C.ORG_DVSN_CD) AS ORG_DVSN_CD<!-- 기관구분코드 -->,
				      	MAX(C.AUD_KND_CD) AS AUD_KND_CD<!-- 감사종류코드 -->,
				      	(SELECT CD_NM FROM TBDCMACM013C WHERE CD = C.AUD_KND_CD AND CMM_CD_DVSN_CD='AA07') AS AUD_KND_NM<!-- 감사종류명 -->,
				      	MAX(C.SPVR_BRDV_CD) AS SPVR_BRDV_CD<!-- 주관국과코드 -->,
				      	MAX(C.AUD_WAY_CD) AS AUD_WAY_CD<!-- 감사방법코드  --> 						
				FROM	TBBADDED008L A,
						TBBADDED002M B,
						TBBADDED001M C
				WHERE	1=1
				AND		A.BZT_YR = B.BZT_YR  
				AND 	A.BZT_SNO = B.BZT_SNO  
				AND 	B.BZT_DVSN_CD = '1' 
				AND 	C.AUD_YR = B.REL_AUD_YR  
				AND 	C.AUD_NO = B.REL_AUD_NO
				<isNotEmpty property="AUD_YR" prepend="AND">
					C.AUD_YR = #AUD_YR# <!-- 감사년도 -->
				</isNotEmpty>
				GROUP BY C.AUD_YR, C.AUD_NO, C.AUD_KND_CD
				ORDER BY C.AUD_YR DESC, C.AUD_NO
				)
	</select>
</sqlMap>

