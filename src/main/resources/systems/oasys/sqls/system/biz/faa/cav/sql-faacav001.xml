<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="faa/cav/001"> 
	<select id="FAACAV001EComboList" parameterClass="paramMap" 	resultClass="resultMap">
		<![CDATA[  /* faa/cav/001/FAACAV001EComboList */ ]]>
			SELECT 
			       CD ,
			       CD_NM
			  FROM TBDCMACM013C
			 WHERE 1=1
			   AND CD != '000000000'
			   AND CMM_CD_DVSN_CD ='1000701'
			 ORDER BY CD
	</select>
 	
	<!-- 수신이력조회 조회 -->
	<select id="FAACAV001EMainselect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[  /* faa/cav/001/FAACAV001EMainselect */ ]]>
		<include refid="include.pageSelct" />
        <![CDATA[
           SELECT ROWNUM AS KEY, 
           			A.COPT_CD||'-'||A.ACNT_CD||'-'||A.BLL_CD||'-'||A.PROF_DRTR_SRNO||'-'|| A.DL_XPN_RCDB_PBSVT_SRNO AS PROF_DRTR_CD /*증명책임자부호*/ 
                   , A.PROF_YM			/* 증명년월 */ 
                   , A.RCPT_DH			/* 수신일자 */
                   , A.RCPT_STA_CD		/* 수신상태 */
                   , A.FILD_GOV_CD		/* 관서부호 */
                   , F_AV_ACCMN_NM(A.COPT_CD,A.ACNT_CD,A.BLL_CD ,A.PROF_DRTR_SRNO ,A.DL_XPN_RCDB_PBSVT_SRNO) ORG_NM	/* 기관명 */
                   , A.BU_RUT_NM        /* 백업경로 */
                   , F_AV_BLL_COPT_CD_NM(A.COPT_CD) AS COPT_NM
				   , F_AV_ACNT_CD_NM(A.ACNT_CD) AS ACNT_NM
				   , F_AV_BLL_CD_NM(A.BLL_CD, A.DL_XPN_RCDB_PBSVT_SRNO) AS BLL_NM
				   , B.ABLT_DT
				   , B.TNB
				   , B.MDF_PEN_NM
            FROM   TWFAACAV002H A , TWFAACAV003M B
            WHERE A.COPT_CD = B.COPT_CD
            AND A.ACNT_CD = B.ACNT_CD
            AND A.BLL_CD = B.BLL_CD
            AND A.PROF_DRTR_SRNO = B.PROF_DRTR_SRNO
            AND A.DL_XPN_RCDB_PBSVT_SRNO = B.DL_XPN_RCDB_PBSVT_SRNO
		]]>
		<isNotEmpty property="strYm">
			<isNotEmpty property="strMm">
			   AND A.PROF_YM     = #strYm#
			</isNotEmpty>	 	   
			<isEmpty property="strMm">
			   AND A.PROF_YM    LIKE #strYm#||'%'
			</isEmpty>
		</isNotEmpty>	
			
		<isNotEmpty property="strCoptCd">	 	   
			   AND A.COPT_CD     = #strCoptCd#
		</isNotEmpty>   
		<isNotEmpty property="strAcntCd">	 	   
			   AND A.ACNT_CD     = #strAcntCd#
		</isNotEmpty>
		<isNotEmpty property="strBllCd">
	        <isNotEmpty property="strDlXpnRcdbPbsvtSrno">
	        	<isEqual property="strFildGovYn" compareValue="N">
               		AND (A.DL_XPN_RCDB_PBSVT_SRNO = '000' AND A.DL_XPN_RCDB_PBSVT_SRNO = #strDlXpnRcdbPbsvtSrno#)
               	</isEqual>
               	<isEqual property="strFildGovYn" compareValue="Y">
                	AND (A.DL_XPN_RCDB_PBSVT_SRNO &lt;&gt; '000' AND A.DL_XPN_RCDB_PBSVT_SRNO = #strDlXpnRcdbPbsvtSrno#)
	            </isEqual>
	            AND A.BLL_CD = #strBllCd#
	        </isNotEmpty>
	        
	        <isEmpty property="strDlXpnRcdbPbsvtSrno">
	            <isEqual property="strFildGovYn" compareValue="N">
	                AND A.DL_XPN_RCDB_PBSVT_SRNO = '000'
	                <isEqual property="strBllCd" compareValue="17">
	                    AND A.BLL_CD IN ('17','18')
	                </isEqual>
	                <isEqual property="strBllCd" compareValue="22">
	                    AND A.BLL_CD IN ('22','23','24')
	                </isEqual>
	                <isEqual property="strBllCd" compareValue="42">
	                    AND A.BLL_CD IN ('42','43')
	                </isEqual>
	                <isNotEmpty property="strBllCd">
	                    AND A.BLL_CD = CASE WHEN #strBllCd# IN ('17','22','42') THEN A.BLL_CD 
	                                           ELSE #strBllCd#
	                                      END
	                </isNotEmpty>
	            </isEqual>
	            <isEqual property="strFildGovYn" compareValue="Y">
	                AND A.DL_XPN_RCDB_PBSVT_SRNO &lt;&gt; '000'
	                <isEqual property="strBllCd" compareValue="17">
	                    AND A.BLL_CD IN ('17','18')
	                </isEqual>
	                <isEqual property="strBllCd" compareValue="22">
	                    AND A.BLL_CD IN ('22','23','24')
	                </isEqual>
	                <isNotEmpty property="strBllCd">
	                    AND A.BLL_CD = CASE WHEN #strBllCd# IN ('17','22') THEN A.BLL_CD 
	                                           ELSE #strBllCd#
	                                      END
	                </isNotEmpty>
	            </isEqual>
	        </isEmpty>
	    </isNotEmpty>
	    
	    <isEmpty property="strBllCd">
	        <isEqual property="strFildGovYn" compareValue="N">
	        	AND A.DL_XPN_RCDB_PBSVT_SRNO = '000'
	        </isEqual>
	        <isEqual property="strFildGovYn" compareValue="Y">
	            <isNotEmpty property="strDlXpnRcdbPbsvtSrno">	
	                AND  A.DL_XPN_RCDB_PBSVT_SRNO = #strDlXpnRcdbPbsvtSrno#
	            </isNotEmpty>
	            <isEmpty property="strDlXpnRcdbPbsvtSrno">	
	                AND  A.DL_XPN_RCDB_PBSVT_SRNO &lt;&gt; '000'
	            </isEmpty>
	        </isEqual>
	    </isEmpty>
	    
	    <isNotEmpty property="strProfDrtrSrno">
	        AND A.PROF_DRTR_SRNO = #strProfDrtrSrno#
	    </isNotEmpty>

		<isNotEmpty property="strFildGovCd">
			   AND A.FILD_GOV_CD  like '%'||#strFildGovCd#||'%'
		</isNotEmpty>	
		
    	<isNotEmpty property="strSdt">
    		<isNotEmpty property="strEdt">
			   AND A.RCPT_DH BETWEEN TO_TIMESTAMP( #strSdt#,'YYYYMMDD') AND TO_TIMESTAMP(#strEdt#||235959,'YYYYMMDDHH24MISS')
			</isNotEmpty>   
			<isEmpty property="strEdt">
			   AND A.RCPT_DH BETWEEN TO_TIMESTAMP(#strSdt#,'YYYYMMDD') AND TO_TIMESTAMP(SYSDATE,'YYYYMMDDHH24MISS')
			</isEmpty>
		</isNotEmpty>
		
    	<isNotEmpty property="strEdt">
    		<isEmpty property="strSdt">
			   AND A.RCPT_DH &lt;= TO_TIMESTAMP(#strEdt#||235959,'YYYYMMDDHH24MISS')
			</isEmpty>
		</isNotEmpty>
		 
		<isNotEmpty property="strRcptSta">
			   AND A.RCPT_STA_CD     = #strRcptSta#
		</isNotEmpty>
		
		<isNotEmpty property="strOrgNm">
			   AND B.ORG_CD = #strOrg1#||#strOrg2#||#strOrg3#||#strOrg4#
		</isNotEmpty>
		<include refid="include.pageOrder" />
		   ORDER BY PROF_DRTR_CD, PROF_YM, RCPT_DH
	</select>
	
	<select id="FAACAV001ECodeXMainselect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[  /* faa/cav/001/FAACAV001ECodeXMainselect */ ]]>
		<include refid="include.pageSelct" />
        <![CDATA[
           SELECT ROWNUM AS KEY, 
           		  A.COPT_CD||'-'||A.ACNT_CD||'-'||A.BLL_CD||'-'||A.PROF_DRTR_SRNO||'-'|| A.DL_XPN_RCDB_PBSVT_SRNO AS PROF_DRTR_CD, /*증명책임자부호*/ 
                  A.PROF_YM ,     /* 증명년월 */ 
                  A.RCPT_DH,      /* 수신일자 */
                  A.RCPT_STA_CD,     /* 수신상태 */
                  A.FILD_GOV_CD, /* 관서부호 */
                  F_AV_ACCMN_NM(A.COPT_CD,A.ACNT_CD,A.BLL_CD ,A.PROF_DRTR_SRNO ,A.DL_XPN_RCDB_PBSVT_SRNO) ORG_NM,       /* 기관명 */
                  A.BU_RUT_NM        /* 백업경로 */
                  , F_AV_BLL_COPT_CD_NM(A.COPT_CD) AS COPT_NM
				  , F_AV_ACNT_CD_NM(A.ACNT_CD) AS ACNT_NM
				  , F_AV_BLL_CD_NM(A.BLL_CD, A.DL_XPN_RCDB_PBSVT_SRNO) AS BLL_NM
				  , '' AS ABLT_DT
				  , '' AS TNB
				  , '' AS MDF_PEN_NM
             FROM TWFAACAV002H A
            WHERE 1=1
		]]>
		<isNotEmpty property="strYm">
			<isNotEmpty property="strMm">
			   AND A.PROF_YM     = #strYm#
			</isNotEmpty>	 	   
			<isEmpty property="strMm">
			   AND A.PROF_YM    LIKE #strYm#||'%'
			</isEmpty>
		</isNotEmpty>	
			
		<isNotEmpty property="strCoptCd">	 	   
			   AND A.COPT_CD     = #strCoptCd#
		</isNotEmpty>   
		<isNotEmpty property="strAcntCd">	 	   
			   AND A.ACNT_CD     = #strAcntCd#
		</isNotEmpty>
		<isNotEmpty property="strBllCd">
	        <isNotEmpty property="strDlXpnRcdbPbsvtSrno">
	        	<isEqual property="strFildGovYn" compareValue="N">
               		AND (A.DL_XPN_RCDB_PBSVT_SRNO = '000' AND A.DL_XPN_RCDB_PBSVT_SRNO = #strDlXpnRcdbPbsvtSrno#)
               	</isEqual>
               	<isEqual property="strFildGovYn" compareValue="Y">
                	AND (A.DL_XPN_RCDB_PBSVT_SRNO &lt;&gt; '000' AND A.DL_XPN_RCDB_PBSVT_SRNO = #strDlXpnRcdbPbsvtSrno#)
	            </isEqual>
	            AND A.BLL_CD = #strBllCd#
	        </isNotEmpty>
	        
	        <isEmpty property="strDlXpnRcdbPbsvtSrno">
	            <isEqual property="strFildGovYn" compareValue="N">
	                AND A.DL_XPN_RCDB_PBSVT_SRNO = '000'
	                <isEqual property="strBllCd" compareValue="17">
	                    AND A.BLL_CD IN ('17','18')
	                </isEqual>
	                <isEqual property="strBllCd" compareValue="22">
	                    AND A.BLL_CD IN ('22','23','24')
	                </isEqual>
	                <isEqual property="strBllCd" compareValue="42">
	                    AND A.BLL_CD IN ('42','43')
	                </isEqual>
	                <isNotEmpty property="strBllCd">
	                    AND A.BLL_CD = CASE WHEN #strBllCd# IN ('17','22','42') THEN A.BLL_CD 
	                                           ELSE #strBllCd#
	                                      END
	                </isNotEmpty>
	            </isEqual>
	            <isEqual property="strFildGovYn" compareValue="Y">
	                AND A.DL_XPN_RCDB_PBSVT_SRNO &lt;&gt; '000'
	                <isEqual property="strBllCd" compareValue="17">
	                    AND A.BLL_CD IN ('17','18')
	                </isEqual>
	                <isEqual property="strBllCd" compareValue="22">
	                    AND A.BLL_CD IN ('22','23','24')
	                </isEqual>
	                <isNotEmpty property="strBllCd">
	                    AND A.BLL_CD = CASE WHEN #strBllCd# IN ('17','22') THEN A.BLL_CD 
	                                           ELSE #strBllCd#
	                                      END
	                </isNotEmpty>
	            </isEqual>
	        </isEmpty>
	    </isNotEmpty>
	    
	    <isEmpty property="strBllCd">
	        <isEqual property="strFildGovYn" compareValue="N">
	        	AND A.DL_XPN_RCDB_PBSVT_SRNO = '000'
	        </isEqual>
	        <isEqual property="strFildGovYn" compareValue="Y">
	            <isNotEmpty property="strDlXpnRcdbPbsvtSrno">	
	                AND  A.DL_XPN_RCDB_PBSVT_SRNO = #strDlXpnRcdbPbsvtSrno#
	            </isNotEmpty>
	            <isEmpty property="strDlXpnRcdbPbsvtSrno">	
	                AND  A.DL_XPN_RCDB_PBSVT_SRNO &lt;&gt; '000'
	            </isEmpty>
	        </isEqual>
	    </isEmpty>
	    
	    <isNotEmpty property="strProfDrtrSrno">
	        AND A.PROF_DRTR_SRNO = #strProfDrtrSrno#
	    </isNotEmpty>

		<isNotEmpty property="strFildGovCd">
			   AND A.FILD_GOV_CD  like '%'||#strFildGovCd#||'%'
		</isNotEmpty>	
		
    	<isNotEmpty property="strSdt">
    		<isNotEmpty property="strEdt">
			   AND A.RCPT_DH BETWEEN TO_TIMESTAMP( #strSdt#,'YYYYMMDD') AND TO_TIMESTAMP(#strEdt#||235959,'YYYYMMDDHH24MISS')
			</isNotEmpty>   
			<isEmpty property="strEdt">
			   AND A.RCPT_DH BETWEEN TO_TIMESTAMP(#strSdt#,'YYYYMMDD') AND TO_TIMESTAMP(SYSDATE,'YYYYMMDDHH24MISS')
			</isEmpty>
		</isNotEmpty>
		
    	<isNotEmpty property="strEdt">
    		<isEmpty property="strSdt">
			   AND A.RCPT_DH &lt;= TO_TIMESTAMP(#strEdt#||235959,'YYYYMMDDHH24MISS')
			</isEmpty>
		</isNotEmpty>
		 
		<isNotEmpty property="strRcptSta">
			   AND A.RCPT_STA_CD     = #strRcptSta#
		</isNotEmpty>

		<include refid="include.pageOrder" />
		   ORDER BY PROF_DRTR_CD, PROF_YM, RCPT_DH
	</select>
	
	
	<!--수신이력 오류 조회-->
	<select id="FAACAV001EMainDtlselect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[  /* faa/cav/001/FAACAV001EMainDtlselect */ ]]>
		SELECT
			ERRDTL.PROF_YM
            , TO_CHAR(ERRDTL.ACP_DH, 'YYYY-MM-DD HH24:MM:SS') AS RCPT_DH
			, ERRDTL.SRNO
			, ERRDTL.ACP_ERR_CD
			, CD.RMK_2 AS RMK2            
		FROM   TWFAACAV006D ERRDTL, 
			   TWFAACAV024C CD  
		WHERE  ERRDTL.COPT_CD||ERRDTL.ACNT_CD||ERRDTL.BLL_CD||ERRDTL.PROF_DRTR_SRNO||ERRDTL.DL_XPN_RCDB_PBSVT_SRNO = REPLACE(#strProfDrtrCd#,'-','')
			AND ERRDTL.PROF_YM = #strYm#
			AND  ERRDTL.ACP_ERR_CD = CD.ACNT_CD
			AND  CD.ACNT_DVSN_CD = '11'
		<isNotEmpty property="strRcptDh">
			AND  ERRDTL.ACP_DH = #strRcptDh#
		</isNotEmpty>
	</select>
		
	<!--수신이력 파일 조회-->
	<select id="FAACAV001ESelectFileView" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[  /* faa/cav/001/FAACAV001ESelectFileView */ ]]>
		SELECT 
		     CASE WHEN (SELECT 
								BU_RUT_NM
						FROM TWFAACAV002H A  
						WHERE A.COPT_CD||A.ACNT_CD||A.BLL_CD||A.PROF_DRTR_SRNO||A.DL_XPN_RCDB_PBSVT_SRNO = REPLACE(#strProfDrtrCd#,'-','')
						AND RCPT_DH = #strRcptDh#) IS NULL 
		     THEN  (SELECT BU_RUT_NM
					   FROM TWFAACAV002H A
					  WHERE A.COPT_CD || A.ACNT_CD || A.BLL_CD || A.PROF_DRTR_SRNO || A.DL_XPN_RCDB_PBSVT_SRNO = REPLACE(#strProfDrtrCd#, '-','')
					<isNotEmpty property="strProfYm">
					    AND A.PROF_YM = #strProfYm#
					</isNotEmpty>
					    AND A.RCPT_DH = (SELECT MAX(RCPT_DH) 
								         FROM TWFAACAV002H 
								         WHERE COPT_CD || ACNT_CD || BLL_CD || PROF_DRTR_SRNO || DL_XPN_RCDB_PBSVT_SRNO = REPLACE(#strProfDrtrCd#, '-','')
								         <isNotEmpty property="strProfYm">
								         AND PROF_YM =  #strProfYm#
								         AND RCPT_STA_CD = 'A'
								         </isNotEmpty>
								         )
					)
			 ELSE (SELECT 
							BU_RUT_NM
					FROM TWFAACAV002H A  
					WHERE A.COPT_CD||A.ACNT_CD||A.BLL_CD||A.PROF_DRTR_SRNO||A.DL_XPN_RCDB_PBSVT_SRNO = REPLACE(#strProfDrtrCd#,'-','')
					AND RCPT_DH = #strRcptDh#) 
			END AS BU_RUT_NM
		FROM DUAL
	</select>	
	
	<select id="FAACAV001R_01" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[  /* faa/cav/001/FAACAV001R_01 */ ]]>
		SELECT
			ERRDTL.COPT_CD|| '-' ||ERRDTL.ACNT_CD|| '-' ||ERRDTL.BLL_CD|| '-' ||ERRDTL.PROF_DRTR_SRNO|| '-' ||ERRDTL.DL_XPN_RCDB_PBSVT_SRNO AS 증명책임자부호
			, SUBSTR(ERRDTL.PROF_YM,1,4) || '.' || SUBSTR(ERRDTL.PROF_YM,5,2) AS 증명년월
			, TO_CHAR(ERRDTL.ACP_DH, 'YYYY.MM.DD.  HH24:MI:SS') AS 접수일시
			, ERRDTL.SRNO AS  일련번호
			, ERRDTL.ACP_ERR_CD AS 접수오류코드
			, CD.RMK_2 AS 비고           
		FROM   TWFAACAV006D ERRDTL, TWFAACAV024C CD  
		WHERE  ERRDTL.COPT_CD||ERRDTL.ACNT_CD||ERRDTL.BLL_CD||ERRDTL.PROF_DRTR_SRNO||ERRDTL.DL_XPN_RCDB_PBSVT_SRNO = REPLACE(#strProfDrtrCd#,'-','')
			AND ERRDTL.PROF_YM = #strYm#
			AND  ERRDTL.ACP_ERR_CD = CD.ACNT_CD
			AND  CD.ACNT_DVSN_CD = '11'
		<isNotEmpty property="strRcptDh">
			AND  ERRDTL.ACP_DH = #strRcptDh#
		</isNotEmpty>
	</select>
	
</sqlMap> 

