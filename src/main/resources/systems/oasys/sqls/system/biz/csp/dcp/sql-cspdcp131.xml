<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/dcp/131">
 	
 	<select id="CSPDCP131QSelectMain" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT /*CSPDCP131QSelectMain*/ D1.ACP_YR
			      ,D1.CVPT_ACP_NO
			      ,D1.REQ_DVSN_CD
			      ,D1.ACP_YR||'-민원-'||D1.RM_CVPT_ACP_NO AS ACP_YR_NO
			      ,F_CODE_NM('1000047', D1.CVPT_KND_CD) AS CVPT_KND_NM
			      ,D1.TIT_NM
			      ,DECODE(D1.REQR_KND_CD,'1',D1.CVPTR_NM,'2',D1.RPST_PEN_NM,'3',D1.RPST_PEN_NM,'4',D1.CVPTR_NM) AS CVPTR_NM
			      ,F_CODE_NM('1000754', D2.CVPT_HNDL_DVSN_CD) AS CVPT_HNDL_DVSN_NM
			      ,D3.ORG_NM
			      ,D1.AUD_INF_TRF_DVSN_CD
			      ,(CASE WHEN D1.AUD_INF_TRF_DVSN_CD = 'T' THEN 'Y' ELSE 'N' END) AS AUD_INF_TRF_DVSN_YN
			      ,D5.YE
			      ,D5.SRNO
			      ,( CASE WHEN D5.SRNO IS NOT NULL THEN D5.YE || '-' || D5.SRNO ELSE NULL END ) AS INFO_NO
			      ,D6.DSP_RQ_KND_CD_NM 
			      ,D6.SPV_BRDV_DPT_NM
			      ,F_CODE_NM('1000085', D5.AUD_INF_PRSS_STA_CD)                     AS AUD_INF_PRSS_STA_NM
			  FROM TBCSPDCP101M D1
			      ,TBCSPDCP205L D2
			      ,(SELECT	S1.REQ_DVSN_CD
			                , S1.ACP_YR
			                , S1.CVPT_ACP_NO
			                , AGGR_CONCAT( DECODE(S1.OGN_ORG_DVSN_CD,'10',S2.ORG_NM,'20',S1.ORG_NM), ',') AS ORG_NM
			        FROM	TBCSPDCP206L S1
			               ,TBDCMACM015M S2
			        WHERE	S1.ORG_CD = S2.ORG_CD(+)
			        AND		S1.REQ_DVSN_CD = '1'
			        AND		S1.ORG_HIS_DVSN_CD = '1'
			        GROUP BY S1.REQ_DVSN_CD, S1.ACP_YR, S1.CVPT_ACP_NO
			        ) D3
			      ,TBCSPDCP102M D4
			      , TBCSPBII100M D5
			      , (
			      	SELECT	D21.YE
							, D21.SRNO
							, D24.DPT_NM AS SPV_BRDV_DPT_NM
							, AGGR_CONCAT(( SELECT CD_NM FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000002' AND CD = D22.DSP_RQ_KND_CD ), ' , ') AS DSP_RQ_KND_CD_NM
					FROM	TBCSPBII120L D21
							, TBBADEAR001M D22
							, TBBADDED001M D23
							, TBDCMACM002M D24
					WHERE	D21.AUD_YR = D22.AUD_YR
					AND		D21.AUD_NO = D22.AUD_NO
					AND		D21.DSP_RQ_SNO = D22.DSP_RQ_SNO
					AND		D21.AUD_YR = D23.AUD_YR
					AND		D21.AUD_NO = D23.AUD_NO
					AND		D23.SPV_BRDV_CD = D24.DPT_CD
					GROUP BY D21.YE, D21.SRNO, D24.DPT_NM
			      ) AS D6
			 WHERE 1=1
			   AND D1.REQ_DVSN_CD = D2.REQ_DVSN_CD
			   AND D1.ACP_YR      = D2.ACP_YR
			   AND D1.CVPT_ACP_NO = D2.CVPT_ACP_NO
			   AND D1.REQ_DVSN_CD = D3.REQ_DVSN_CD
			   AND D1.ACP_YR      = D3.ACP_YR
			   AND D1.CVPT_ACP_NO = D3.CVPT_ACP_NO
			   AND D1.REQ_DVSN_CD = D4.REQ_DVSN_CD
			   AND D1.ACP_YR      = D4.ACP_YR
			   AND D1.CVPT_ACP_NO = D4.CVPT_ACP_NO
			   AND D1.REQ_DVSN_CD = D5.REQ_DVSN_CD(+)
			   AND D1.ACP_YR      = D5.ACP_YR(+)
			   AND D1.CVPT_ACP_NO = D5.CVPT_ACP_NO(+)
			   AND D5.YE = D6.YE(+)
			   AND D5.SRNO = D6.SRNO(+)
			   AND D1.REQ_DVSN_CD = 1
			   AND D1.CVPT_HNDL_STA_CD = '60'
			   
			   AND (D2.REQ_DVSN_CD, D2.CVPT_ACP_NO, D2.ACP_YR, D2.SRNO ) IN (	SELECT	Z.REQ_DVSN_CD, Z.CVPT_ACP_NO, Z.ACP_YR, MIN(Z.SRNO)
			   																	FROM	TBCSPDCP205L Z
			   																	WHERE	D1.REQ_DVSN_CD = Z.REQ_DVSN_CD
			   																	AND		D1.CVPT_ACP_NO = Z.CVPT_ACP_NO
			   																	AND		D1.ACP_YR = Z.ACP_YR
			   																	GROUP BY Z.REQ_DVSN_CD, Z.CVPT_ACP_NO, Z.ACP_YR
			   																)
		]]>
		<dynamic>
			<isNotEmpty property="TIT_NM">
		  		<isEqual property="SEARCH_CD" compareValue="1">
		  			AND D1.TIT_NM LIKE '%'||#TIT_NM#||'%'
		  		</isEqual>
		  		<isEqual property="SEARCH_CD" compareValue="2">
		  			AND D4.CVPT_SBT LIKE '%'||#TIT_NM#||'%'
		  		</isEqual>
		  	</isNotEmpty>
			<isNotEmpty property="ACP_YR" >
				AND D1.ACP_YR = #ACP_YR#
			</isNotEmpty>
			<isNotEmpty property="RM_CVPT_ACP_NO" >
				AND D1.RM_CVPT_ACP_NO = #RM_CVPT_ACP_NO#
			</isNotEmpty>
			<isNotEmpty property="ACP_DH_START" >
			  <isNotEmpty property="ACP_DH_END" >
			   AND TO_CHAR(D1.ACP_DH, 'YYYYMMDD') BETWEEN #ACP_DH_START# AND #ACP_DH_END#
			  </isNotEmpty>
			</isNotEmpty>
			<isNotEmpty property="strCVPT_KND_CD">
			   AND D1.CVPT_KND_CD IN (SELECT 	SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
					                    FROM 	DUAL A
					                    CROSS JOIN(SELECT ','|| #strCVPT_KND_CD# ||',' AS CODE FROM DUAL) B
					                    CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
			</isNotEmpty>
			
			<isNotEmpty property="strCVPT_HNDL_DVSN_CD">
			   AND D2.CVPT_HNDL_DVSN_CD IN (SELECT 	SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
						                      FROM 	DUAL A
						                      CROSS JOIN(SELECT ','|| #strCVPT_HNDL_DVSN_CD# ||',' AS CODE FROM DUAL) B
						                      CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )
			
			</isNotEmpty>
			<isNotEmpty property="CVPTR_NM">
				AND	(D1.CVPTR_NM LIKE '%'||#CVPTR_NM#||'%' OR D1.RPST_PEN_NM LIKE '%'||#CVPTR_NM#||'%')
			</isNotEmpty>
			<isEqual property="strAUD_INF_TRF_DVSN_CD" compareValue="Y">
				AND D1.AUD_INF_TRF_DVSN_CD = 'T'
			</isEqual>
			<isEqual property="strAUD_INF_TRF_DVSN_CD" compareValue="N">
				AND (D1.AUD_INF_TRF_DVSN_CD != 'T' OR D1.AUD_INF_TRF_DVSN_CD IS NULL )
			</isEqual>
			
		</dynamic>
		ORDER BY D1.ACP_YR DESC
                ,D1.RM_CVPT_ACP_NO DESC
	</select>
 	
 	<update id="CSPDCP131QUpdateAudInfTrfDvsnCd" parameterClass="paramMap">
 		UPDATE TBCSPDCP101M
 		   SET AUD_INF_TRF_DVSN_CD = #AUD_INF_TRF_DVSN_CD# 
 			  ,FNL_USR_ID         = #FNL_USR_ID#
		      ,FNL_DEAL_DPT_CD    = #FNL_DEAL_DPT_CD#
		      ,FNL_MNU_ID         = #FNL_MNU_ID#
		      ,FNL_MDF_DH         = SYSDATE
 	     WHERE 1=1
 	       AND REQ_DVSN_CD = #REQ_DVSN_CD#
 	       AND CVPT_ACP_NO = #CVPT_ACP_NO# 
 	       AND ACP_YR      = #ACP_YR#
 	</update>
 	
</sqlMap> 
