<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="aep/gkm/003">

	<select id="AEPGKM003Pmainselect" parameterClass="java.util.Map" resultClass="java.util.HashMap">
	
		SELECT	A.KNB,
				KLD_NM,
				KLD_CAT_CD,
				TG_CAT_NM
		FROM	TBAEPGKM002L AS A,
				TBAEPGKM001M AS B,
				TBAEPGKM017M AS C
		WHERE	1=1
		AND		A.KNB = B.KNB
		AND		B.KLD_CAT_CD = TG_CAT_ID
		AND		CNB = #strUsrCnb#
		ORDER BY KNB
	</select>
	

	<insert id="AEPGKM003Pmaininsert" parameterClass="paramMap">
		DECLARE
					BEGIN
						INSERT INTO TBAEPGKM004L 
						VALUES (#KNB#, 
								#CNB#,
								(
								SELECT	NVL(MAX(STRG_KLD_SNO), 0) + 1
								FROM	TBAEPGKM004L
								WHERE	CNB = #CNB#    
								), 
								#CTG_ID#,
						<isEqual property="CTG_TYPE" compareValue="A">
								'BM',
								NULL,
		   				</isEqual>
		   				<isEqual property="CTG_TYPE" compareValue="S">
		   						'GP',
		   						#CTG_ID#,
		   				</isEqual>
								#FRT_USR_ID#,
								#FNL_USR_ID#,
								#FNL_DEAL_DPT_CD#,
								#FNL_MNU_ID#,
								SYSDATE,
								SYSDATE
						);
						DELETE FROM TBAEPGKM002L
						WHERE	CNB = #CNB#
						AND		KNB = #KNB#
						;
					END
				;
	
	</insert>
	

</sqlMap>