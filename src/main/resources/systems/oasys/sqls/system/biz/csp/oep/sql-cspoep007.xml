<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/oep/007">

	<!-- 비상소집 select -->
    <select id="CSPOEP007EMainSelect" parameterClass="paramMap" resultClass="resultMap">
        <![CDATA[
				SELECT	T1.CNB
						, T1.DPT_CD
						, T2.DPT_NM
						, T1.USR_NAM
						, T1.PBSVT_NO
						,F_CODE_NM('1000338',T1.USR_DVSN_CD) AS USR_DVSN_NM
						,RAL_BLT_DIV_CD,
                         INN_RANK_CD,
                         RANK_SRT_SEQ_NM,
                         CRNT_RANK_APM_DT,
                         SRT_KY_NO,
                         CRNT_DPT_APM_DT,
                         EIN ,DPT_SNO
                         ,REPLACE(T1.PBSVT_NO,'1040000-','') AS PBSVT_NO2
                         ,T1.PBSVT_NO AS OLD_PBSVT_NO
				FROM	TBDCMACM001M T1
						,TBDCMACM002M T2
				WHERE	1=1
				AND		T1.DPT_CD = T2.DPT_CD
				AND		T1.RQS_STA_CD ='3'
				AND		T1.USR_DVSN_CD IN ('1','3')
				AND		SUBSTR(T1.CNB,1,1) <> '5'
				
        ]]>
        
        <dynamic>
        	<isNotEmpty property="strCNB" prepend="AND">
        		T1.CNB = #strCNB#
        	</isNotEmpty>
        	
        	<isNotEmpty property="strDPT_CD" prepend="AND">
        		T1.DPT_CD = #strDPT_CD#
        	</isNotEmpty>
        	
        	<isEqual property="strHNDL_STA_CD" compareValue="Y" prepend="AND">
        		T1.PBSVT_NO IS NOT NULL
        	</isEqual>
        	
        	<isEqual property="strHNDL_STA_CD" compareValue="N" prepend="AND">
        		T1.PBSVT_NO IS NULL
        	</isEqual>
        	
        	<isNotEmpty property="strUSR_DVSN_CD" prepend="AND">
        		T1.USR_DVSN_CD = #strUSR_DVSN_CD#
        	</isNotEmpty>
        	
        	<isNotEmpty property="strPBSVT_NO" prepend="AND">
        		T1.PBSVT_NO LIKE '%'||#strPBSVT_NO#||'%'
        	</isNotEmpty>
        	
        </dynamic>
        
        ORDER BY T1.CNB DESC
    </select>
    
    
    <update id="CSPOEP007EUpdate" parameterClass="paramMap">
    	<![CDATA[
    		UPDATE	TBDCMACM001M
    		SET		PBSVT_NO = #PBSVT_NO#
    				,COFM_STA_CD = CASE WHEN COFM_STA_CD IS NOT NULL AND #OLD_PBSVT_NO# <> #PBSVT_NO# THEN 'N' ELSE COFM_STA_CD  END
    				,COFM_DT = CASE WHEN COFM_STA_CD IS NOT NULL AND  #OLD_PBSVT_NO# <> #PBSVT_NO# THEN TO_CHAR(SYSDATE,'YYYYMMDD') ELSE COFM_DT END 
    		WHERE	CNB = #CNB#
    	]]>
    </update>
</sqlMap> 
