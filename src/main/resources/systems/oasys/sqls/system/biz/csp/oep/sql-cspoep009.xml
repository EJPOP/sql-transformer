<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/oep/009">

	<resultMap class="java.util.HashMap" id="mainselect">
	    <result property="NDTY_DT"            column="NDTY_DT"          jdbcType="VARCHAR2"     javaType="java.lang.String"/>
	    <result property="NDTY_DVSN_CD"       column="NDTY_DVSN_CD"     jdbcType="VARCHAR2"		javaType="java.lang.String"/>
	    <result property="NDTY_DVSN_NM"       column="NDTY_DVSN_NM"     jdbcType="VARCHAR2"		javaType="java.lang.String"/>
	    <result property="NDTY_DRTR_NAM"      column="NDTY_DRTR_NAM"    jdbcType="VARCHAR2"		javaType="java.lang.String"/>
	    <result property="NDTY_DRTR_CNB"      column="NDTY_DRTR_CNB"    jdbcType="VARCHAR2"		javaType="java.lang.String"/>
	    <result property="NDTY_DRTR_RANK"     column="NDTY_DRTR_RANK"   jdbcType="VARCHAR2"		javaType="java.lang.String"/> 
	    <result property="NDTY_AST_NAM"       column="NDTY_AST_NAM"     jdbcType="VARCHAR2"     javaType="java.lang.String"/>
	    <result property="NDTY_AST_CNB"       column="NDTY_AST_CNB"     jdbcType="VARCHAR2"     javaType="java.lang.String"/>
	    <result property="NDTY_AST_RANK"      column="NDTY_AST_RANK"    jdbcType="VARCHAR2"     javaType="java.lang.String"/>
	    <result property="NDTY_WRK_TXT"       column="NDTY_WRK_TXT"     jdbcType="CLOB"       	javaType="java.lang.String"/>
	    <result property="APV_DOC_NO"         column="APV_DOC_NO"       jdbcType="VARCHAR2"     javaType="java.lang.String"/>
	    <result property="APV_STA_CD"         column="APV_STA_CD"       jdbcType="VARCHAR2"     javaType="java.lang.String"/>
    </resultMap>
    
    
    <resultMap class="java.util.HashMap" id="detailselect">
	    <result property="NDTY_DT"            column="NDTY_DT"          jdbcType="VARCHAR2"     javaType="java.lang.String"/>
	    <result property="NDTY_DVSN_CD"       column="NDTY_DVSN_CD"     jdbcType="VARCHAR2"		javaType="java.lang.String"/>
	    <result property="NDTY_DVSN_NM"       column="NDTY_DVSN_NM"     jdbcType="VARCHAR2"		javaType="java.lang.String"/>
	    <result property="NDTY_DRTR_NAM"      column="NDTY_DRTR_NAM"    jdbcType="VARCHAR2"		javaType="java.lang.String"/>
	    <result property="NDTY_DRTR_CNB"      column="NDTY_DRTR_CNB"    jdbcType="VARCHAR2"		javaType="java.lang.String"/>
	    <result property="NDTY_DRTR_RANK"     column="NDTY_DRTR_RANK"   jdbcType="VARCHAR2"		javaType="java.lang.String"/> 
	    <result property="NDTY_WRK_TXT"       column="NDTY_WRK_TXT"     jdbcType="CLOB"       	javaType="java.lang.String"/>
	    <result property="APV_DOC_NO"         column="APV_DOC_NO"       jdbcType="VARCHAR2"     javaType="java.lang.String"/>
	    <result property="APV_STA_CD"         column="APV_STA_CD"       jdbcType="VARCHAR2"     javaType="java.lang.String"/>
	    <result property="NDTY_DTS"       column="NDTY_DTS"     jdbcType="VARCHAR2"       	javaType="java.lang.String"/>
	    <result property="NDTY_DTE"       column="NDTY_DTE"     jdbcType="VARCHAR2"       	javaType="java.lang.String"/>
    </resultMap>
	
	<!-- 당직근무 목록조회 수정본_20220721 -->
    <select id="CSPOEP009QMainSelectDts" parameterClass="paramMap" resultClass="resultMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009QMainSelect */ ]]>
		<![CDATA[
		SELECT ROWNUM AS KEY,
               T.*
          FROM (
					SELECT  A.NDTY_DT,
					        A.NDTY_DVSN_CD,
					        F_CODE_NM('1000899', A.NDTY_DVSN_CD) AS NDTY_DVSN_NM,
					        F_DPT_INFO(B.DPT_CD, '1') AS NDTY_DRTR_DPT_NM,
					        F_CODE_NM('1000173', B.RANK_CD) AS NDTY_DRTR_RANK,
							B.USR_NAM AS NDTY_DRTR_NAM,
					        A.APV_DOC_NO,
					        A.APV_STA_CD,
					        A.NDTY_DTS,
					        A.NDTY_DTE,
					        TO_CHAR(TO_DATE(A.NDTY_DT,'YYYYMMDD'), 'DY') AS NDTY_DATE,
					        F_CODE_NM('1000333', A.APV_STA_CD) AS APV_STA_CD_NM,
					        A.NDTY_DRTR_CNB
					FROM    TBCSPOEP004M A,
					        TBDCMACM001M B
					WHERE   A.NDTY_DRTR_CNB = B.CNB
        ]]>
        <dynamic>
        	<isNotEmpty property="strNDTY_DTS" prepend="AND">
        			A.NDTY_DT &gt;= #strNDTY_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strNDTY_DTE" prepend="AND">
        			A.NDTY_DT &lt;= #strNDTY_DTE#
        	</isNotEmpty>
        	<isNotEmpty property="strCNB" prepend="AND">
        			(A.NDTY_DRTR_CNB = #strCNB# OR A.NDTY_AST_CNB = #strCNB#)
        	</isNotEmpty>
        	<isNotEmpty property="strAPV_STA_CD" prepend="AND">
        			A.APV_STA_CD = #strAPV_STA_CD#
        		<isEqual property="strAPV_STA_CD" compareValue="0" prepend="AND">
        			A.APV_STA_CD IN ('2','3', NULL)
        		</isEqual>  		
        	</isNotEmpty>
        	<isNotEmpty property="strNDTY_DVSN_CD" prepend="AND">
        			A.NDTY_DVSN_CD = #strNDTY_DVSN_CD#
        		<isEqual property="strNDTY_DVSN_CD" compareValue="00" prepend="AND">
        			A.NDTY_DVSN_CD IN ('01','02')
        		</isEqual>  		
        	</isNotEmpty>
        </dynamic>
        	ORDER BY A.NDTY_DT DESC, A.NDTY_DVSN_CD ASC
       ) T
    </select>
	
	
	
	
	
	<!-- 당직근무 목록조회 -->
    <select id="CSPOEP009QMainSelect" parameterClass="paramMap" resultClass="resultMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009QMainSelect */ ]]>
		<![CDATA[
		SELECT ROWNUM AS KEY,
               T.*
          FROM (
					SELECT  A.NDTY_DT,
					        A.NDTY_DVSN_CD,
					        F_CODE_NM('1000899', A.NDTY_DVSN_CD) AS NDTY_DVSN_NM,
					        F_DPT_INFO(B.DPT_CD, '1') AS NDTY_DRTR_DPT_NM,
					        F_CODE_NM('1000173', B.RANK_CD) AS NDTY_DRTR_RANK,
							B.USR_NAM AS NDTY_DRTR_NAM,
							F_DPT_INFO(C.DPT_CD, '1') AS NDTY_AST_DPT_NM,
							F_CODE_NM('1000173', C.RANK_CD) AS NDTY_AST_RANK,
					        C.USR_NAM AS NDTY_AST_NAM,
					        A.APV_DOC_NO,
					        A.APV_STA_CD,
					        F_CODE_NM('1000333', A.APV_STA_CD) AS APV_STA_CD_NM
					FROM    TBCSPOEP004M A,
					        TBDCMACM001M B,
					        TBDCMACM001M C
					WHERE   A.NDTY_DRTR_CNB = B.CNB
					AND     A.NDTY_AST_CNB  = C.CNB
        ]]>
        <dynamic>
        	<isNotEmpty property="strNDTY_DTS" prepend="AND">
        			A.NDTY_DT &gt;= #strNDTY_DTS#
        	</isNotEmpty>
        	<isNotEmpty property="strNDTY_DTE" prepend="AND">
        			A.NDTY_DT &lt;= #strNDTY_DTE#
        	</isNotEmpty>
        	<isNotEmpty property="strCNB" prepend="AND">
        			(A.NDTY_DRTR_CNB = #strCNB# OR A.NDTY_AST_CNB = #strCNB#)
        	</isNotEmpty>
        	<isNotEmpty property="strAPV_STA_CD" prepend="AND">
        			A.APV_STA_CD = #strAPV_STA_CD#
        		<isEqual property="strAPV_STA_CD" compareValue="0" prepend="AND">
        			A.APV_STA_CD IN ('2','3', NULL)
        		</isEqual>  		
        	</isNotEmpty>
        	<isNotEmpty property="strNDTY_DVSN_CD" prepend="AND">
        			A.NDTY_DVSN_CD = #strNDTY_DVSN_CD#
        		<isEqual property="strNDTY_DVSN_CD" compareValue="00" prepend="AND">
        			A.NDTY_DVSN_CD IN ('01','02')
        		</isEqual>  		
        	</isNotEmpty>
        </dynamic>
        	ORDER BY A.NDTY_DT DESC, A.NDTY_DVSN_CD ASC
       ) T
    </select>
    
    
    <!-- 당직근무 상세조회 -->
    <select id="CSPOEP009EDetailSelect" parameterClass="paramMap" resultMap="detailselect">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EDetailSelect */ ]]>
		SELECT  A.NDTY_DT,
				A.NDTY_DVSN_CD,
				F_CODE_NM('1000899', A.NDTY_DVSN_CD) AS NDTY_DVSN_NM,
		        B.USR_NAM AS NDTY_DRTR_NAM,
		        A.NDTY_DRTR_CNB,
		        F_CODE_NM('1000173', B.RANK_CD) AS NDTY_DRTR_RANK,
				A.NDTY_WRK_TXT,
				A.APV_DOC_NO,
				A.APV_STA_CD
		FROM    TBCSPOEP004M A,
		        TBDCMACM001M B
		WHERE   A.NDTY_DRTR_CNB = B.CNB
		<isNotEmpty property="strNDTY_DT" prepend="AND">
			A.NDTY_DT		= #strNDTY_DT#
		</isNotEmpty>
		<isNotEmpty property="strNDTY_DVSN_CD" prepend="AND">
			A.NDTY_DVSN_CD	= #strNDTY_DVSN_CD#
		</isNotEmpty>
		<isNotEmpty property="APV_DOC_NO" prepend="AND">
			A.APV_DOC_NO = #APV_DOC_NO#
		</isNotEmpty>
    </select>
    
    <!-- 당직근무 상세조회수정_20220721 -->
    <select id="CSPOEP009EDetailDtsSelect" parameterClass="paramMap" resultMap="detailselect">
    	SELECT A.NDTY_DT,
		       A.NDTY_DVSN_CD,
		       F_CODE_NM('1000899', A.NDTY_DVSN_CD) AS NDTY_DVSN_NM,
		       B.USR_NAM AS NDTY_DRTR_NAM,
		       A.NDTY_DRTR_CNB,
		       F_CODE_NM('1000173', B.RANK_CD) AS NDTY_DRTR_RANK,
		       A.NDTY_DTS,
		       A.NDTY_DTE,
		       A.NDTY_WRK_TXT,
		       A.APV_DOC_NO,
		       A.APV_STA_CD
		  FROM TBCSPOEP004M A,
		       TBDCMACM001M B
		 WHERE A.NDTY_DRTR_CNB = B.CNB
		 <isNotEmpty property="strNDTY_DT" prepend="AND">
			A.NDTY_DT		= #strNDTY_DT#
		</isNotEmpty>
		<isNotEmpty property="strNDTY_DVSN_CD" prepend="AND">
			A.NDTY_DVSN_CD	= #strNDTY_DVSN_CD#
		</isNotEmpty>
		<isNotEmpty property="APV_DOC_NO" prepend="AND">
			A.APV_DOC_NO = #APV_DOC_NO#
		</isNotEmpty>
		<isNotEmpty property="strNDTY_DTS" prepend="AND">
			A.NDTY_DTS	= #strNDTY_DTS#
		</isNotEmpty>
		<isNotEmpty property="strNDTY_DTE" prepend="AND">
			A.NDTY_DTE	= #strNDTY_DTE#
		</isNotEmpty>
    </select>
    
    <!-- 당직근무 등록 -->
    <update id="CSPOEP009EInsert"  parameterClass="paramMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EInsert */ ]]>
   		INSERT INTO TBCSPOEP004M(
   			NDTY_DT,
   			NDTY_DVSN_CD,
   			NDTY_DRTR_CNB,
   			NDTY_AST_CNB,
   			NDTY_WRK_TXT,
   			APV_DOC_NO,
   			APV_STA_CD,
   			FRT_USR_ID,
   			FNL_USR_ID,
   			FNL_DEAL_DPT_CD,
   			FNL_MNU_ID,
   			FRT_REGI_DH,
   			FNL_MDF_DH,
   			NDTY_DTS,
   			NDTY_DTE
   		)VALUES (
   			#NDTY_DT#,
   			#NDTY_DVSN_CD#,
   			#NDTY_DRTR_CNB#,
   			#NDTY_AST_CNB#,
   			#NDTY_WRK_TXT#,
   			#APV_DOC_NO#,
   			'1',
   			#FRT_USR_ID#,
   			#FNL_USR_ID#,
   			#FNL_DEAL_DPT_CD#,
   			#FNL_MNU_ID#,
   			SYSDATE,
   			SYSDATE,
   			#NDTY_DTS#,
   			#NDTY_DTE#
   		)
    </update>
    
    
    <!-- 당직근무 수정 -->
    <update id="CSPOEP009EUpdate" parameterClass="paramMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EUpdate */ ]]>
   		UPDATE	TBCSPOEP004M
   		SET		NDTY_DRTR_CNB = #NDTY_DRTR_CNB#,
   				NDTY_AST_CNB  = #NDTY_AST_CNB#,
   				NDTY_WRK_TXT = #NDTY_WRK_TXT#,
   				NDTY_DTS = #NDTY_DTS#,
   				NDTY_DTE = #NDTY_DTE#
   		WHERE	NDTY_DT = #NDTY_DT#
   		AND		NDTY_DVSN_CD = #NDTY_DVSN_CD#
	</update>
    
    
    <!-- 당직근무 삭제 -->
    <update id="CSPOEP009EDelete" parameterClass="paramMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EDelete */ ]]>
   		DELETE	TBCSPOEP004M
   		WHERE	NDTY_DT		= #NDTY_DT#
   		AND		NDTY_DVSN_CD= #NDTY_DVSN_CD#
    </update>
    
    
    <!-- 당직근무 결재선정보 삭제 -->
    <update id="CSPOEP009EApvSubDelete" parameterClass="paramMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EApvSubDelete */ ]]>
   		DELETE	TBDCMACM023L
   		WHERE	APV_DOC_NO	= #APV_DOC_NO#
   		AND		APV_DVSN_CD = #APV_DVSN_CD#
    </update>
    
    
    <!-- 당직근무 결재정보 삭제 -->
    <update id="CSPOEP009EApvMstDelete" parameterClass="paramMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EApvMstDelete */ ]]>
   		DELETE	TBDCMACM022L
   		WHERE	APV_DOC_NO	= #APV_DOC_NO#
   		AND		APV_DVSN_CD = #APV_DVSN_CD#
    </update>
    
    
    <!-- 당직근무 결재이력 삭제 -->
    <update id="CSPOEP009EApvHstDelete" parameterClass="paramMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EApvHstDelete */ ]]>
   		DELETE	TBDCMACM023H
   		WHERE	APV_DOC_NO	= #APV_DOC_NO#
   		AND		APV_DVSN_CD = #APV_DVSN_CD#
    </update>
    
    
    <!-- 당직근무 결재정보 수정 -->
    <update id="CSPOEP009EApvSave" parameterClass="paramMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EApvSave */ ]]>
    	UPDATE	TBCSPOEP004M
		SET		APV_DOC_NO = #APV_DOC_NO#,
				APV_STA_CD = #APV_STA_CD#
		WHERE	1=1
		<isEmpty property="NDTY_DT" prepend="AND">
			APV_DOC_NO = #APV_DOC_NO#
		</isEmpty>
		<isNotEmpty property="NDTY_DT" prepend="AND">
			NDTY_DT = #NDTY_DT#
			AND		NDTY_DVSN_CD = #NDTY_DVSN_CD#
		</isNotEmpty>
    </update>
    
    
    <!-- 결재번호로 당직근무 키 조회 -->
    <select id="CSPOEP009EMainKeySelect" parameterClass="paramMap" resultClass="resultMap">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EMainKeySelect */ ]]>
    	SELECT	NDTY_DT,
    			NDTY_DVSN_CD,
    			APV_STA_CD,
    			APV_DOC_NO
		FROM	TBCSPOEP004M
		WHERE	1=1
		AND		APV_DOC_NO = #APV_DOC_NO#
    </select>
    
    <select id ="CSPOEP009EDocCntSelect" parameterClass="paramMap" resultClass="Integer">
    	<![CDATA[  /* csp/oep/009/CSPOEP009EDocCntSelect */ ]]>
    		SELECT	COUNT(*)
    		FROM	TBCSPOEP005M 
    		WHERE	NDTY_DT			= #NDTY_DT#
    		AND		NDTY_DVSN_CD	= #NDTY_DVSN_CD#
    </select>
    
    
    <insert id="CSPOEP009EMsgInsert" parameterClass="paramMap">
		<![CDATA[	
			INSERT INTO TBDCMACM026L (              			
			            MSG_SNO 
			          , TSK_CAT_CD 
			          , FUNC_CAT_CD 
			          , SEND_ID 
			          , MSG_TP_YN 
			          , MSG_TXT_2 
			          , RCNT_CNT 
			          , RCNT_HIS 
			          , MSG_REGI_DH 
			          , MSG_HNDL_YN 
			          , FRT_USR_ID 
			          , FNL_USR_ID 
			          , FNL_DEAL_DPT_CD 
			          , FNL_MNU_ID 
			          , FRT_REGI_DH 
			          , FNL_MDF_DH )
			  VALUES ( 
			            (SELECT NVL(MAX(MSG_SNO),0) + 1 
			               FROM (SELECT MSG_SNO 
			                       FROM TBDCMACM026L        		
			                      ORDER BY MSG_SNO DESC) 
			              WHERE ROWNUM < 2 
			              GROUP BY MSG_SNO) 
			          , 'SP' 
			          , 'EP' 
			          , #SEND_USR_ID#                         /* 보내는 사람 USR_ID */
			          , '0' 
			          , #TXT_CONT#                            /* 내용 */
			          , 1 
			          , #RCV_CNB#                             /* 받는사람 전산번호 */
			          , SYSDATE 
			          , 'N' 
			          , #FRT_USR_ID#
			          , #FNL_USR_ID#
			          , #FNL_DEAL_DPT_CD#
			          , #FNL_MNU_ID# 
			          , SYSDATE
			          , SYSDATE )
		]]>			          
	</insert>
    
</sqlMap> 
