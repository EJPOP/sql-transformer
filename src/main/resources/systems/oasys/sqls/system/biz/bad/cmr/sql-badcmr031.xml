<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/cmr/031">

	
  <!-- 대상기관과제기본 조회 -->	  
  <select id="badcmr031Taskselect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[    
			SELECT T1.YE        
			     , T1.TASK_SNO
			     , T1.YE ||'-'|| T1.TASK_SNO    AS TASK_YE_SNO
			     , TASK_TIT_NM
			     , TASK_TXT
			     , CHR_DPT_CD 
			     , F_DPT_INFO (CHR_DPT_CD,'1')  AS DPT_NM
			     , T2.CHGR_ID_1                 AS CHGR_ID
			     , F_USR_INFO(T2.CHGR_ID_1,'2') AS CHGR_NM
			     , ORG_CD
			     , (SELECT F_ORG_INFO(MIN(ORG_CD), '1') || CASE WHEN COUNT(1) > 1 THEN  ' 외 ' || (COUNT(1) - 1) 
                                                                ELSE ''
                                                            END 
                      FROM TBBADCMR017L
                     WHERE YE       = T1.YE
                       AND TASK_SNO = T1.TASK_SNO
                     GROUP BY YE
                             ,TASK_SNO)         AS ORG_NM			     
			     , CMPT_YN
                 , T2.CHGR_ID_1
                 , F_USR_INFO(T2.CHGR_ID_1,'2') AS CHGR_NM_1
                 , T2.CHGR_ID_2
                 , F_USR_INFO(T2.CHGR_ID_2,'2') AS CHGR_NM_2
                 , T2.CHGR_ID_3
                 , F_USR_INFO(T2.CHGR_ID_3,'2') AS CHGR_NM_3
			  FROM TBBADCMR016M T1
                  ,(SELECT YE
                          ,TASK_SNO
                          ,MAX(CASE WHEN ROW_CNT = 1 THEN CHGR_ID ELSE '' END) AS CHGR_ID_1
                          ,MAX(CASE WHEN ROW_CNT = 2 THEN CHGR_ID ELSE '' END) AS CHGR_ID_2
                          ,MAX(CASE WHEN ROW_CNT = 3 THEN CHGR_ID ELSE '' END) AS CHGR_ID_3
                      FROM (
                            SELECT YE
                                  ,TASK_SNO
                                  ,ROW_NUMBER() OVER(PARTITION BY YE, TASK_SNO ORDER BY CHGR_ID ASC) AS ROW_CNT
                                  ,CHGR_ID
                              FROM TBBADCMR021L
                            )
                     GROUP BY YE
                             ,TASK_SNO) T2
			 WHERE 1=1
               AND T1.YE       = T2.YE(+)
               AND T1.TASK_SNO = T2.TASK_SNO(+)			 
			   AND T1.YE       = #strYear#
			  ]]>
			  
		 	<isNotEmpty prepend="AND" property="strTaskSno">
				   T1.TASK_SNO = #strTaskSno#
			</isNotEmpty> 
          </select>
          
 
          
    <!-- 대상기관과제기본 삭제 -->	
	<update id="badcmr031Taskdelete" parameterClass="paramMap">
	
	DECLARE
			BEGIN
				DELETE
				FROM
				TBBADCMR019D
				WHERE 1=1
				AND YE = #YE#
				AND TASK_SNO =#TASK_SNO#;
		        
		        DELETE
		        FROM TBBADCMR017L
		        WHERE 1=1
		        AND TASK_SNO=#TASK_SNO#
		        AND YE =#YE#;
		        
		        DELETE
		        FROM TBBADCMR018L
		        WHERE 1=1
		        AND TASK_SNO=#TASK_SNO#
		        AND YE =#YE#;
		        
		        DELETE
		        FROM TBBADCMR016M
		        WHERE 1=1
		        AND TASK_SNO=#TASK_SNO#
		        AND YE =#YE#;

		        DELETE
		        FROM TBBADCMR021L
		        WHERE 1=1
		        AND TASK_SNO=#TASK_SNO#
		        AND YE =#YE#;
		        
		        
		 	END;
		        
	</update>
	
  <!-- 대상기관과제 부처 조회 -->	
	  <select id="badcmr031TaskDptselect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[    
	        SELECT YE         		/*연도*/
	             , GD_CD
	             , F_ORG_INFO(GD_CD,'1') AS GD_NM
			     , TASK_SNO
			     , GD_CD AS GD_CD_OLD
			     , F_ORG_INFO(GD_CD,'5') AS AD
			  FROM TBBADCMR018L 
			 WHERE 1=1
			   AND YE = #strYear#	
			   AND TASK_SNO =#strTaskSno#
			  ]]>

          </select>
      <!-- 대상기관과제 기관 조회 -->	    
       <select id="badcmr031TaskOrgselect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[    
			 SELECT YE         		/*연도*/
	             , ORG_CD
	             , F_ORG_INFO(ORG_CD,'1') AS ORG_NM
			     , TASK_SNO
			     , ORG_CD AS ORG_CD_OLD
			     , F_ORG_INFO(ORG_CD,'5') AS AD
			  FROM TBBADCMR017L
			 WHERE 1=1
			   AND YE = #strYear#	
			   AND TASK_SNO =#strTaskSno#
			  ]]>

          </select>      
          
          
          
       <update id="badcmr031TaskDptupdate" parameterClass="paramMap">
		UPDATE TBBADCMR018L
		SET YE = #YE#
		, TASK_SNO =#TASK_SNO#
		, GD_CD=#GD_CD#
		
		, FNL_MDF_DH = SYSDATE
		, FNL_USR_ID = #FNL_USR_ID#
		, FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		, FNL_MNU_ID = #FNL_MNU_ID#

		WHERE 1 = 1
		AND YE = #YE#
		AND GD_CD =#GD_CD_OLD#
		AND TASK_SNO =#TASK_SNO#

	</update>
	<!-- 대상기관 관련기관 업데이트 -->
	<update id="badcmr031TaskOrgupdate" parameterClass="paramMap">
		UPDATE TBBADCMR017L
		SET YE = #YE#
		, TASK_SNO =#TASK_SNO#
		, ORG_CD=#ORG_CD#

		
		, FNL_MDF_DH = SYSDATE
		, FNL_USR_ID = #FNL_USR_ID#
		, FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		, FNL_MNU_ID = #FNL_MNU_ID#

		WHERE 1 = 1
		AND YE = #YE#
		AND ORG_CD =#ORG_CD_OLD#
		AND TASK_SNO =#TASK_SNO#

	</update>
	<!-- 대상기관 부처 삭제 -->
	<update id="badcmr031TaskDptdelete" parameterClass="paramMap">
		DELETE TBBADCMR018L

		WHERE 1 = 1
		AND YE = #YE#
		AND GD_CD =#GD_CD#
		AND TASK_SNO =#TASK_SNO#

	</update>

	<update id="badcmr031TaskOrgdelete" parameterClass="paramMap">
		DELETE TBBADCMR017L

		WHERE 1 = 1
		AND YE = #YE#
		AND ORG_CD =#ORG_CD#
		AND TASK_SNO =#TASK_SNO#

	</update>
	
	
	
	
	
	<insert id="badcmr031Taskinsert" parameterClass="paramMap">
		INSERT INTO
		TBBADCMR016M
		(
		YE                         /*연도*/
		, TASK_SNO              /*과제순번*/

		, TASK_TIT_NM           /*과제제목명*/
		, TASK_TXT              /*과제내용*/
		, ORG_CD
		, CHR_DPT_CD                /*담당부서*/
		, CHGR_ID                   /*담당자*/
		, CMPT_YN                   /*완료여부*/
		, REGI_DT                   /*등록일*/
		, REGN_ID                   /*등록자*/
		                            /**/
		, MDF_DT                    /*수정일*/
		, MDF_PEN_ID                /*수정자*/
		, DEL_YN                    /*삭제여부*/
		, CPLT_YN
		                            
		, FNL_MNU_ID               
		, FRT_USR_ID               
		, FNL_USR_ID              
		, FNL_DEAL_DPT_CD          
		, FRT_REGI_DH               
		, FNL_MDF_DH                
		)                          
		VALUES                      
		(                           
		#YE#                        
		, #TASK_SNO#            
         
		, #TASK_TIT_NM#         
		, #TASK_TXT#   
		, #ORG_CD#         
		, #CHR_DPT_CD#              
		, #CHGR_ID#                 
		, #CMPT_YN#                 
		, TO_CHAR(SYSDATE,'YYYYMMDD')
		, #S_CNB#
		
		, TO_CHAR(SYSDATE,'YYYYMMDD')
		, #S_CNB#
		,'N'
		,'N'

		
		, #FNL_MNU_ID#
		, #FRT_USR_ID#
		, #FNL_USR_ID#
		, #FNL_DEAL_DPT_CD#
		, SYSDATE
		, SYSDATE
		)
	</insert>
  
  <update id="badcmr031Taskupdate" parameterClass="paramMap">
		UPDATE TBBADCMR016M
		SET YE = #YE#
		, TASK_SNO =#TASK_SNO#
		, TASK_TIT_NM=#TASK_TIT_NM#

		, CMPT_YN = #CMPT_YN#
		
		
		, MDF_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
		, MDF_PEN_ID = #S_CNB#
		
		, FNL_MDF_DH = SYSDATE
		, FNL_USR_ID = #FNL_USR_ID#
		, FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		, FNL_MNU_ID = #FNL_MNU_ID#
		<isNotNull prepend="," property="TASK_TXT">
			TASK_TXT = #TASK_TXT#
		</isNotNull>
		<isNotNull prepend="," property="CHR_DPT_CD">
			CHR_DPT_CD = #CHR_DPT_CD#
		</isNotNull>
		<isNotNull prepend="," property="ORG_CD">
			ORG_CD = #ORG_CD#
		</isNotNull>
		<isNotNull prepend="," property="CHGR_ID">
			CHGR_ID = #CHGR_ID#
		</isNotNull>
		WHERE 1 = 1
		AND YE = #YE#
		AND TASK_SNO =#TASK_SNO#


	</update>
  
       <select id="badcmr031TaskMaxselect" parameterClass="paramMap"
	resultClass="java.lang.String">
        <![CDATA[    
			 SELECT LPAD(NVL(MAX(TASK_SNO), 0) + 1, 3, 0) AS TASK_SNO
			  FROM TBBADCMR016M
			 WHERE 1=1
			   AND YE = #strYear#
			  ]]>
          </select>
          
          
          
          
          <insert id="badcmr031TaskDptinsert" parameterClass="paramMap">
		INSERT INTO
		TBBADCMR018L
		(
		YE                         /*연도*/
		, GD_CD              /*부처코드*/
		, TASK_SNO              /*과제번호*/

		                            
		, FNL_MNU_ID               
		, FRT_USR_ID               
		, FNL_USR_ID              
		, FNL_DEAL_DPT_CD          
		, FRT_REGI_DH               
		, FNL_MDF_DH                
		)                          
		VALUES                      
		(                           
		#YE#                                  
		, #GD_CD#            
		, #TASK_SNO#            
	

		
		, #FNL_MNU_ID#
		, #FRT_USR_ID#
		, #FNL_USR_ID#
		, #FNL_DEAL_DPT_CD#
		, SYSDATE
		, SYSDATE
		)
	</insert>
		<insert id="badcmr031TaskOrginsert" parameterClass="paramMap">
		INSERT INTO
		TBBADCMR017L
		(
		YE                         /*연도*/
		, ORG_CD              /*기관코드*/
		, TASK_SNO              /*과제번호*/
	
		                            
		, FNL_MNU_ID               
		, FRT_USR_ID               
		, FNL_USR_ID              
		, FNL_DEAL_DPT_CD          
		, FRT_REGI_DH               
		, FNL_MDF_DH                
		)                          
		VALUES                      
		(                           
		#YE#                              
		, #ORG_CD#            
		, #TASK_SNO#            
	

		
		, #FNL_MNU_ID#
		, #FRT_USR_ID#
		, #FNL_USR_ID#
		, #FNL_DEAL_DPT_CD#
		, SYSDATE
		, SYSDATE
		)
	</insert>
	
  	<!-- 담당자 입력 -->	  
	<insert id="badcmr031TaskChgrinsert" parameterClass="paramMap">
		INSERT INTO TBBADCMR021L
		(
		  YE                  
		, TASK_SNO             
		, CHGR_ID
		, FNL_MNU_ID               
		, FRT_USR_ID               
		, FNL_USR_ID              
		, FNL_DEAL_DPT_CD          
		, FRT_REGI_DH               
		, FNL_MDF_DH                
		)                          
		VALUES                      
		(                           
		  #YE#                        
		, #TASK_SNO#            
		, #CHGR_ID#
		, #FNL_MNU_ID#
		, #FRT_USR_ID#
		, #FNL_USR_ID#
		, #FNL_DEAL_DPT_CD#
		, SYSDATE
		, SYSDATE
		)
	</insert>
	
	<!-- 담당자 수정 -->
	<update id="badcmr031TaskChgrupdate" parameterClass="paramMap">
		UPDATE TBBADCMR021L
		   SET YE              = #YE#
		     , TASK_SNO        = #TASK_SNO#
		     , CHGR_ID         = #CHGR_ID#
		     , FNL_MDF_DH      = SYSDATE
		     , FNL_USR_ID      = #FNL_USR_ID#
		     , FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
		     , FNL_MNU_ID      = #FNL_MNU_ID#
		WHERE 1 = 1
		  AND YE       = #YE#
		  AND TASK_SNO = #TASK_SNO#
		  AND CHGR_ID  = #CHGR_ID_OLD#
	</update>
	
	<!-- 담당자 삭제 -->
	<update id="badcmr031TaskChgrdelete" parameterClass="paramMap">
		DELETE TBBADCMR021L
		 WHERE 1 = 1
		   AND YE       = #YE#
		   AND TASK_SNO = #TASK_SNO#
	</update>	
</sqlMap> 
