<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/oep/001">

	<select id="CSPOEP001EinitSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT CD, CD_NM FROM TBDCMACM013C 
			 WHERE CMM_CD_DVSN_CD = '1000001' 
			   AND CD LIKE '%00' 
			   AND CD NOT LIKE '5%'
			   AND CD <> '000000000'
		]]>
	</select>
	
	<select id="CSPOEP001EMainSelect" parameterClass="paramMap"	resultClass="resultMap">
	<include refid = "include.pageSelct"/>
		<![CDATA[
		SELECT T1.*, 
			   ROWNUM AS NO
          FROM (
			SELECT	A.VI_DT,
			        A.VI_HM,
			        SUBSTR(A.VI_HM, 0,2) AS HM1,
			        SUBSTR(A.VI_HM, 3,2) AS HM2,
			        TO_CHAR(TO_DATE(A.VI_DT), 'YYYY-MM-DD') || ' ' ||
			        TO_CHAR(TO_DATE(A.VI_HM, 'HH24:MI'), 'HH24:MI') AS VI_TIME,
			        A.VI_SLN,
			        A.CNB,
			        (SELECT TNB FROM TBDCMACM001M M WHERE M.CNB = A.CNB) IN_TNB,
			        A.BLT_BRDV_NM,
			        A.BLT_BRDV_CD,
			        A.NAM,
					CASE WHEN A.RANK_CD IN (SELECT CD FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000173') 
					     THEN A.RANK_CD ELSE '' END AS RANK_CD,
					CASE WHEN A.RANK_CD IN (SELECT CD FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000173') 
					     THEN F_CODE_NM('1000173', A.RANK_CD) ELSE '' END AS RANK_NM,
			        A.WRK_PLAC_NM,
			        A.VI_PEN_RGN_CD,
			        A.VI_PEN_NAM,
			        A.NOP_CNT,
			        A.VI_PEN_NAM || '(' || NVL(A.NOP_CNT,0) || ')' AS NM,
			        A.CAR_NO,
			        A.VI_PPS_CD,
			        A.VI_PPS_TXT,
			        A.VI_WAY_CD,
			        A.TNB,
			        A.IO_NO,
			        #fromYmd# AS FROMYMD,
			        #toYmd#	AS TOYMD,
			        A.REN_DT,
			        A.REN_HH,
			        A.REN_MM,
			        TO_CHAR(TO_DATE(A.REN_DT), 'YYYY-MM-DD') || ' ' ||
			        TO_CHAR(TO_DATE((A.REN_HH||A.REN_MM), 'HH24:MI'), 'HH24:MI') AS REN_TIME,
			        NVL2(REN_DT,'반납','출입') AS REN_STATUS,
			        A.VI_WAY_TXT
			  FROM	TBCSPOEP001M A
			 WHERE 	1=1
		]]>
		<dynamic>
			<isNotEmpty property="fromYmd">
				AND	A.VI_DT &gt;= #fromYmd#
			</isNotEmpty>
			<isNotEmpty property="toYmd">
				AND	A.VI_DT &lt;= #toYmd#
			</isNotEmpty>
			<isNotEmpty property="dptCd">
				AND A.BLT_BRDV_CD = #dptCd#
			</isNotEmpty>
			<isNotEmpty property="rankCd">
				AND A.RANK_CD = #rankCd#
			</isNotEmpty>
			<isNotEmpty property="cnb">
				AND A.CNB = #cnb#
			</isNotEmpty>
			<isNotEmpty property="ioNo">
				AND A.IO_NO LIKE '%'||#ioNo#||'%'
			</isNotEmpty>			
			<isNotEmpty property="workPlace">
				AND A.WRK_PLAC_NM LIKE '%'||#workPlace#||'%'
			</isNotEmpty>
			<isNotEmpty property="carNo">
				AND A.CAR_NO LIKE '%'||#carNo#||'%'
			</isNotEmpty>
			<isNotEmpty property="name">
				AND A.VI_PEN_NAM LIKE '%'||#name#||'%'
			</isNotEmpty>
		</dynamic>
		<![CDATA[
			 ORDER	BY A.VI_DT DESC, A.VI_HM DESC) T1
		]]>				
		<include refid = "include.pageOrder"/> 
	</select>
	
	
	<select id="CSPOEP001EReportSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT	A.VI_DT,
			        A.VI_HM,
			        SUBSTR(A.VI_HM, 0,2) AS HM1,
			        SUBSTR(A.VI_HM, 3,2) AS HM2,
			        TO_CHAR(TO_DATE(A.VI_DT), 'YYYY-MM-DD') || ' ' ||
			        TO_CHAR(TO_DATE(A.VI_HM, 'HH24:MI'), 'HH24:MI') AS VI_TIME,
			        A.VI_SLN,
			        A.CNB,
			        A.BLT_BRDV_CD,
			        A.NAM,
					CASE WHEN A.RANK_CD IN (SELECT CD FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000173') 
					     THEN A.RANK_CD ELSE '' END AS RANK_CD,
					CASE WHEN A.RANK_CD IN (SELECT CD FROM TBDCMACM013C WHERE CMM_CD_DVSN_CD = '1000173') 
					     THEN F_CODE_NM('1000173', A.RANK_CD) ELSE '' END AS RANK_NM,
			        A.WRK_PLAC_NM,
			        A.VI_PEN_RGN_CD,
				 	F_CODE_NM('1000001', A.VI_PEN_RGN_CD) AS RGN_NM,
			        A.VI_PEN_NAM,
			        A.NOP_CNT,
			        A.VI_PEN_NAM || '(' || A.NOP_CNT || ')' AS NM,
			        A.CAR_NO,
			        A.VI_PPS_CD,
        			F_CODE_NM('1000284', A.VI_PPS_CD) AS VI_PPS_NM,
        			A.VI_PPS_TXT,
        			A.VI_WAY_CD,
        			F_CODE_NM('1000285', A.VI_WAY_CD) AS VI_WAY_NM,
			        #fromYmd# AS FROMYMD,
			        #toYmd#	AS TOYMD
			  FROM	TBCSPOEP001M A
			 WHERE 	1=1
		]]>
		<dynamic>
			<isNotEmpty property="fromYmd">
				AND	A.VI_DT &gt;= #fromYmd#
			</isNotEmpty>
			<isNotEmpty property="toYmd">
				AND	A.VI_DT &lt;= #toYmd#
			</isNotEmpty>
			<isNotEmpty property="dptCd">
				AND A.BLT_BRDV_CD = #dptCd#
			</isNotEmpty>
			<isNotEmpty property="rankCd">
				AND A.RANK_CD = #rankCd#
			</isNotEmpty>
			<isNotEmpty property="cnb">
				AND A.CNB = #cnb#
			</isNotEmpty>
			<isNotEmpty property="workPlace">
				AND A.WRK_PLAC_NM LIKE '%'||#workPlace#||'%'
			</isNotEmpty>
			<isNotEmpty property="carNo">
				AND A.CAR_NO LIKE '%'||#carNo#||'%'
			</isNotEmpty>
			<isNotEmpty property="name">
				AND A.VI_PEN_NAM LIKE '%'||#name#||'%'
			</isNotEmpty>
		</dynamic>
		<![CDATA[
			 ORDER	BY A.VI_DT DESC, A.VI_SLN DESC
		]]>
	</select>
	
	<delete id="CSPOEP001EDelete" parameterClass="paramMap">
		<![CDATA[
			DELETE FROM TBCSPOEP001M
			 WHERE VI_DT = #VI_DT#
			   AND VI_HM = #VI_HM#
			   AND VI_SLN = #VI_SLN#
		]]>
	</delete>
	
	<update id="CSPOEP001EUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPOEP001M
			   SET	FNL_MDF_DH 		= SYSDATE
			   		,REN_DT = #REN_DT#
			   		,REN_HH = #REN_HH#
			   		,REN_MM = #REN_MM#
		]]>
			<dynamic>
				<isNotEmpty prepend="," property="cnb">
					CNB				= #CNB#
				</isNotEmpty>
				<isNotEmpty prepend="," property="BLT_BRDV_CD">
					BLT_BRDV_CD		= #BLT_BRDV_CD#
				</isNotEmpty>
				<isNotEmpty prepend="," property="BLT_BRDV_NM">
					BLT_BRDV_NM		= #BLT_BRDV_NM#
				</isNotEmpty>
				<isNotEmpty prepend="," property="NAM">
					NAM				= #NAM#
				</isNotEmpty>
				<isNotEmpty prepend="," property="RANK_CD">
					RANK_CD			= #RANK_CD#
				</isNotEmpty>
				<isNotEmpty prepend="," property="WRK_PLAC_NM">
					WRK_PLAC_NM		= #WRK_PLAC_NM#
				</isNotEmpty>
				<isNotEmpty prepend="," property="VI_PEN_RGN_CD">
					VI_PEN_RGN_CD	= #VI_PEN_RGN_CD#
				</isNotEmpty>
				<isNotEmpty prepend="," property="VI_PEN_NAM">
					VI_PEN_NAM		= #VI_PEN_NAM#
				</isNotEmpty>
				<isNotEmpty prepend="," property="NOP_CNT">
					NOP_CNT			= #NOP_CNT#
				</isNotEmpty>
				<isNotEmpty prepend="," property="CAR_NO">
					CAR_NO			= #CAR_NO#
				</isNotEmpty>
				<isNotEmpty prepend="," property="IO_NO">
					IO_NO			= #IO_NO#
				</isNotEmpty>
				<isNotEmpty prepend="," property="TNB">
					TNB			= #TNB#
				</isNotEmpty>
				<isNotEmpty prepend="," property="VI_PPS_CD">
					VI_PPS_CD		= #VI_PPS_CD#
				</isNotEmpty>
				<isNotEmpty prepend="," property="VI_PPS_TXT">
					VI_PPS_TXT		= #VI_PPS_TXT#
				</isNotEmpty>
				<isNotEmpty prepend="," property="VI_WAY_CD">
					VI_WAY_CD		= #VI_WAY_CD#
				</isNotEmpty>
				<isNotEmpty prepend="," property="VI_WAY_TXT">
					VI_WAY_TXT		= #VI_WAY_TXT#
				</isNotEmpty>				
			</dynamic>
		<![CDATA[
					,FNL_USR_ID		= #FNL_USR_ID#
					,FNL_DEAL_DPT_CD	= #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID		= #FNL_MNU_ID#
			 WHERE 	1=1
			   AND 	VI_DT = #VI_DT#
			   AND	VI_HM = #VI_HM#
			   AND	VI_SLN = #VI_SLN#
		]]>
	</update>
	
	<update id="CSPOEP001EReturnUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPOEP001M
			   SET	FNL_MDF_DH = SYSDATE
			   	   ,REN_DT = TO_CHAR(SYSDATE, 'yyyyMMdd')
			   	   ,REN_HH = TO_CHAR(SYSDATE, 'HH24')
			   	   ,REN_MM = TO_CHAR(SYSDATE, 'MI')
		]]>
		<![CDATA[
			 WHERE 	1=1
			   AND 	VI_DT  = #VI_DT#
			   AND	VI_HM  = #VI_HM#
			   AND	VI_SLN = #VI_SLN#
		]]>
	</update>
	
	<update id="CSPOEP001ECancelUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE 	TBCSPOEP001M
			   SET	FNL_MDF_DH = SYSDATE
			   	   ,REN_DT = ''
			   	   ,REN_HH = ''
			   	   ,REN_MM = ''
		]]>
		<![CDATA[
			 WHERE 	1=1
			   AND 	VI_DT  = #VI_DT#
			   AND	VI_HM  = #VI_HM#
			   AND	VI_SLN = #VI_SLN#
		]]>
	</update>		
	
	<insert id="CSPOEP001EInsert" parameterClass="paramMap">
        <![CDATA[       
			INSERT INTO TBCSPOEP001M
			(
				VI_DT
				,VI_HM
				,VI_SLN
				,CNB
				,BLT_BRDV_CD
				,BLT_BRDV_NM
				,NAM
				,RANK_CD
				,WRK_PLAC_NM
				,VI_PEN_RGN_CD
				,VI_PEN_NAM
				,NOP_CNT
				,CAR_NO
				,IO_NO
				,TNB
				,VI_PPS_CD
				,VI_PPS_TXT
				,VI_WAY_CD
				,VI_WAY_TXT
				,FRT_USR_ID
				,FNL_USR_ID
				,FNL_DEAL_DPT_CD
				,FNL_MNU_ID
				,FRT_REGI_DH
				,FNL_MDF_DH
				,REN_DT
				,REN_HH
				,REN_MM
			)
			VALUES
			(
				#VI_DT#
				,#VI_HM#
				,(SELECT NVL(MAX(VI_SLN) + 1, '001') FROM TBCSPOEP001M 
				   WHERE VI_DT  = #VI_DT# AND VI_HM = #VI_HM#)
				,#CNB#
				,#BLT_BRDV_CD#
				,#,BLT_BRDV_NM#
				,#NAM#
				,#RANK_CD#
				,#WRK_PLAC_NM#
				,#VI_PEN_RGN_CD#
				,#VI_PEN_NAM#
				,#NOP_CNT#
				,#CAR_NO#
				,#IO_NO#
				,#TNB#
				,#VI_PPS_CD#
				,#VI_PPS_TXT#
				,#VI_WAY_CD#
				,#VI_WAY_TXT#
				,#FRT_USR_ID#
				,#FNL_USR_ID#
				,#FNL_DEAL_DPT_CD#
				,#FNL_MNU_ID#
				,SYSDATE
				,SYSDATE
				,#REN_DT#
				,#REN_HH#
				,#REN_MM#
			)
        ]]>
	</insert>
	
	<select id="CSPOEP004QMainSelect1" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT  A.YYYYMM,
			        TO_CHAR(A.TOTAL1, 'FM999,999') || CHR(13)|| CHR(10)|| '('|| TO_CHAR(A.TOTAL_NOP, 'FM999,999')||')' AS TOTAL,
			        TO_CHAR(A.A1, 'FM999,999') || CHR(13)|| CHR(10)|| '('|| TO_CHAR(A.AA1, 'FM999,999')||')' AS CD1,
			        TO_CHAR(A.B1, 'FM999,999') || CHR(13)|| CHR(10)|| '('|| TO_CHAR(A.BB1, 'FM999,999')||')' AS CD2,
			        TO_CHAR(A.C1, 'FM999,999') || CHR(13)|| CHR(10)|| '('|| TO_CHAR(A.CC1, 'FM999,999')||')' AS CD3,
			        TO_CHAR(A.D1, 'FM999,999') || CHR(13)|| CHR(10)|| '('|| TO_CHAR(A.DD1, 'FM999,999')||')' AS CD4,
			        TO_CHAR(A.E1, 'FM999,999') || CHR(13)|| CHR(10)|| '('|| TO_CHAR(A.EE1, 'FM999,999')||')' AS CD5,
			        TO_CHAR(A.F1, 'FM999,999') || CHR(13)|| CHR(10)|| '('|| TO_CHAR(A.FF1, 'FM999,999')||')' AS CD6,
			        #yy1#||'-'||#mm1# AS FROMYMD,
			        #yy2#||'-'||#mm2# AS TOYMD
			 FROM(
					SELECT 	NVL2(SUBSTR(VI_DT, 0, 6),SUBSTR(VI_DT, 0, 6),'합계') AS YYYYMM,
							COUNT(VI_PPS_CD) AS TOTAL1,
							SUM(NOP_CNT) AS TOTAL_NOP,
					        SUM(CASE WHEN VI_PPS_CD = '1' THEN 1 ELSE 0 END) AS A1,
							SUM(CASE WHEN VI_PPS_CD = '1' THEN NOP_CNT ELSE 0 END) AS AA1,
					        SUM(CASE WHEN VI_PPS_CD = '2' THEN 1 ELSE 0 END) AS B1,
							SUM(CASE WHEN VI_PPS_CD = '2' THEN NOP_CNT ELSE 0 END) AS BB1,
					        SUM(CASE WHEN VI_PPS_CD = '3' THEN 1 ELSE 0 END) AS C1,
							SUM(CASE WHEN VI_PPS_CD = '3' THEN NOP_CNT ELSE 0 END) AS CC1,
					        SUM(CASE WHEN VI_PPS_CD = '4' THEN 1 ELSE 0 END) AS D1,
							SUM(CASE WHEN VI_PPS_CD = '4' THEN NOP_CNT ELSE 0 END) AS DD1,
					        SUM(CASE WHEN VI_PPS_CD = '5' THEN 1 ELSE 0 END) AS E1,
							SUM(CASE WHEN VI_PPS_CD = '5' THEN NOP_CNT ELSE 0 END) AS EE1,
					        SUM(CASE WHEN VI_PPS_CD = '6' THEN 1 ELSE 0 END) AS F1,
							SUM(CASE WHEN VI_PPS_CD = '6' THEN NOP_CNT ELSE 0 END) AS FF1
					  FROM 	TBCSPOEP001M
					 WHERE 	1=1
					   AND	SUBSTR(VI_DT, 0, 6) >= #yy1#||#mm1#
					   AND	SUBSTR(VI_DT, 0, 6) <= #yy2#||#mm2#
					 GROUP	BY ROLLUP (SUBSTR(VI_DT, 0, 6))
			 	) A
		]]>
	</select>
	
	<select id="CSPOEP004QMainSelect2" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT 	A.CNB, 
					DECODE(A.CNB,'합계','',A.BLT_BRDV_CD) AS BLT_BRDV_CD, 
					DECODE(A.CNB,'합계','',A.RANK_NM) AS RANK_NM, 
					DECODE(A.CNB,'합계','',A.NAM) AS NAM,
					F_DPT_INFO(DECODE(A.CNB, '합계', '', A.BLT_BRDV_CD), 1) AS BLT_BRDV_NM,
					TO_CHAR(A.TOTAL, 'FM999,999') AS TOTAL, 
					TO_CHAR(A.T1, 'FM999,999') AS T1,
					TO_CHAR(A.T2, 'FM999,999') AS T2,
					TO_CHAR(A.T3, 'FM999,999') AS T3,
					TO_CHAR(A.T4, 'FM999,999') AS T4,
					TO_CHAR(A.T5, 'FM999,999') AS T5,
					TO_CHAR(A.T6, 'FM999,999') AS T6,
					TO_CHAR(TO_DATE(#fromYmd#), 'YYYY-MM-DD') AS FROMYMD,
					TO_CHAR(TO_DATE(#toYmd#), 'YYYY-MM-DD') AS TOYMD
			  FROM (
					SELECT 	NVL2(CNB,CNB,'합계') AS CNB,
							MAX(BLT_BRDV_CD) AS BLT_BRDV_CD,
							F_CODE_NM('1000173', MAX(RANK_CD)) AS RANK_NM, 
							MAX(NAM) AS NAM,
							COUNT(VI_PPS_CD) AS TOTAL,
							SUM(CASE WHEN VI_PPS_CD = '1' THEN 1 ELSE 0 END) AS T1,
							SUM(CASE WHEN VI_PPS_CD = '2' THEN 1 ELSE 0 END) AS T2,
							SUM(CASE WHEN VI_PPS_CD = '3' THEN 1 ELSE 0 END) AS T3,
							SUM(CASE WHEN VI_PPS_CD = '4' THEN 1 ELSE 0 END) AS T4,
							SUM(CASE WHEN VI_PPS_CD = '5' THEN 1 ELSE 0 END) AS T5,
							SUM(CASE WHEN VI_PPS_CD = '6' THEN 1 ELSE 0 END) AS T6
					  FROM 	TBCSPOEP001M
					 WHERE	1=1
					   AND	CNB IS NOT NULL
					   AND	VI_DT >= #fromYmd#
					   AND	VI_DT <= #toYmd#
					 GROUP 	BY ROLLUP(CNB)
			   ) A
			ORDER BY DECODE(A.CNB,'합계','99999999',NVL(BLT_BRDV_CD,'99999998')), DECODE(A.CNB,'합계','99999999',CNB)
		]]>
	</select>
	
	<select id="CSPOEP004QMainSelect3" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			/* 방문횟수별 인원목록 */
			SELECT 	'1회'  AS NM, 
					NVL(TO_CHAR(SUM(CASE WHEN CNT = 1 THEN 1 ELSE 0 END), 'FM999,999'), 0) AS CNT1,
					TO_CHAR(TO_DATE(#fromYmd#), 'YYYY-MM-DD') AS FROMYMD,
					TO_CHAR(TO_DATE(#toYmd#), 'YYYY-MM-DD') AS TOYMD
			  FROM(
					SELECT	CNB, 
							BLT_BRDV_CD,NAM,
							F_CODE_NM('1000173', RANK_CD) AS RANK_NM,
							NVL(COUNT(VI_PPS_CD), 0) AS CNT
					  FROM	TBCSPOEP001M
					 WHERE	1=1
					   AND	CNB IS NOT NULL
					   AND	VI_DT >= #fromYmd#
					   AND	VI_DT <= #toYmd#
					 GROUP	BY CNB, BLT_BRDV_CD,NAM,RANK_CD
				  )
			UNION ALL
			SELECT 	'2회'  AS NM, 
					NVL(TO_CHAR(SUM(CASE WHEN CNT = 2 THEN 1 ELSE 0 END), 'FM999,999'), 0) AS CNT1,
					TO_CHAR(TO_DATE(#fromYmd#), 'YYYY-MM-DD') AS FROMYMD,
					TO_CHAR(TO_DATE(#toYmd#), 'YYYY-MM-DD') AS TOYMD
			  FROM(
					SELECT	CNB, 
							BLT_BRDV_CD,NAM,
							F_CODE_NM('1000173', RANK_CD) AS RANK_NM,
							NVL(COUNT(VI_PPS_CD), 0) AS CNT
					  FROM	TBCSPOEP001M
					 WHERE	1=1
					   AND	CNB IS NOT NULL
					   AND	VI_DT >= #fromYmd#
					   AND	VI_DT <= #toYmd#
					 GROUP	BY CNB, BLT_BRDV_CD,NAM,RANK_CD
				  )
			UNION ALL
			SELECT 	'3회'  AS NM, 
					NVL(TO_CHAR(SUM(CASE WHEN CNT = 3 THEN 1 ELSE 0 END), 'FM999,999'), 0) AS CNT1,
					TO_CHAR(TO_DATE(#fromYmd#), 'YYYY-MM-DD') AS FROMYMD,
					TO_CHAR(TO_DATE(#toYmd#), 'YYYY-MM-DD') AS TOYMD
			  FROM(
					SELECT	CNB, 
							BLT_BRDV_CD,NAM,
							F_CODE_NM('1000173', RANK_CD) AS RANK_NM,
							NVL(COUNT(VI_PPS_CD), 0) AS CNT
					  FROM	TBCSPOEP001M
					 WHERE	1=1
					   AND	CNB IS NOT NULL
					   AND	VI_DT >= #fromYmd#
					   AND	VI_DT <= #toYmd#
					 GROUP	BY CNB, BLT_BRDV_CD,NAM,RANK_CD
				  )
			UNION ALL
			SELECT 	'4회'  AS NM, 
					NVL(TO_CHAR(SUM(CASE WHEN CNT = 4 THEN 1 ELSE 0 END), 'FM999,999'), 0) AS CNT1,
					TO_CHAR(TO_DATE(#fromYmd#), 'YYYY-MM-DD') AS FROMYMD,
					TO_CHAR(TO_DATE(#toYmd#), 'YYYY-MM-DD') AS TOYMD
			  FROM(
					SELECT	CNB, 
							BLT_BRDV_CD,NAM,
							F_CODE_NM('1000173', RANK_CD) AS RANK_NM,
							NVL(COUNT(VI_PPS_CD), 0) AS CNT
					  FROM	TBCSPOEP001M
					 WHERE	1=1
					   AND	CNB IS NOT NULL
					   AND	VI_DT >= #fromYmd#
					   AND	VI_DT <= #toYmd#
					 GROUP	BY CNB, BLT_BRDV_CD,NAM,RANK_CD
				  )
			UNION ALL
			SELECT 	'5회 이상'  AS NM, 
					NVL(TO_CHAR(SUM(CASE WHEN CNT >= 5 THEN 1 ELSE 0 END), 'FM999,999'), 0) AS CNT1,
					TO_CHAR(TO_DATE(#fromYmd#), 'YYYY-MM-DD') AS FROMYMD,
					TO_CHAR(TO_DATE(#toYmd#), 'YYYY-MM-DD') AS TOYMD
			  FROM(
					SELECT	CNB, 
							BLT_BRDV_CD,NAM,
							F_CODE_NM('1000173', RANK_CD) AS RANK_NM,
							NVL(COUNT(VI_PPS_CD), 0) AS CNT
					  FROM	TBCSPOEP001M
					 WHERE	1=1
					   AND	CNB IS NOT NULL
					   AND	VI_DT >= #fromYmd#
					   AND	VI_DT <= #toYmd#
					 GROUP	BY CNB, BLT_BRDV_CD,NAM,RANK_CD
				  )
			UNION ALL
			SELECT 	'합계'  AS NM, 
					NVL(TO_CHAR(COUNT(CNT), 'FM999,999'), 0) AS CNT1,
					TO_CHAR(TO_DATE(#fromYmd#), 'YYYY-MM-DD') AS FROMYMD,
					TO_CHAR(TO_DATE(#toYmd#), 'YYYY-MM-DD') AS TOYMD
			  FROM(
					SELECT	CNB, 
							BLT_BRDV_CD,NAM,
							F_CODE_NM('1000173', RANK_CD) AS RANK_NM,
							NVL(COUNT(VI_PPS_CD), 0) AS CNT
					  FROM	TBCSPOEP001M
					 WHERE	1=1
					   AND	CNB IS NOT NULL
					   AND	VI_DT >= #fromYmd#
					   AND	VI_DT <= #toYmd#
					 GROUP	BY CNB, BLT_BRDV_CD,NAM,RANK_CD
				  )
		]]>
	</select>
	
	<select id="CSPOEP004QReportSelect2" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT 	CNB,
					BLT_BRDV_CD,
					F_DPT_INFO(BLT_BRDV_CD, 1) AS BLT_BRDV_NM,
					F_CODE_NM('1000173', RANK_CD) AS RANK_NM, 
					NAM,
					COUNT(VI_PPS_CD) AS TOTAL,
					SUM(CASE WHEN VI_PPS_CD = '1' THEN 1 ELSE 0 END) AS T1,
					SUM(CASE WHEN VI_PPS_CD = '2' THEN 1 ELSE 0 END) AS T2,
					SUM(CASE WHEN VI_PPS_CD = '3' THEN 1 ELSE 0 END) AS T3,
					SUM(CASE WHEN VI_PPS_CD = '4' THEN 1 ELSE 0 END) AS T4,
					SUM(CASE WHEN VI_PPS_CD = '5' THEN 1 ELSE 0 END) AS T5,
					SUM(CASE WHEN VI_PPS_CD = '6' THEN 1 ELSE 0 END) AS T6,
					TO_CHAR(TO_DATE(#fromYmd#), 'YYYY-MM-DD') AS FROMYMD,
					TO_CHAR(TO_DATE(#toYmd#), 'YYYY-MM-DD') AS TOYMD
			  FROM 	TBCSPOEP001M
			 WHERE	1=1
			   AND	CNB IS NOT NULL
			   AND	VI_DT >= #fromYmd#
			   AND	VI_DT <= #toYmd#
			 GROUP 	BY  CNB, BLT_BRDV_CD, RANK_CD, NAM
			 ORDER 	BY BLT_BRDV_CD, CNB
		]]>
	</select>
	
	<select id="CSPOEP001EExcelSelect" parameterClass="paramMap"	resultClass="resultMap">
		<![CDATA[       
			SELECT	TO_CHAR(TO_DATE(A.VI_DT), 'YYYY-MM-DD') || ' ' || TO_CHAR(TO_DATE(A.VI_HM, 'HH24:MI'), 'HH24:MI') AS VI_TIME,
			       A.VI_SLN,
			       A.CNB,
			       A.BLT_BRDV_NM,
			       A.NAM,
			       F_CODE_NM('1000173', A.RANK_CD) AS RANK_NM,
			       A.WRK_PLAC_NM,
			       A.VI_PEN_NAM,
			       A.NOP_CNT,
			       A.CAR_NO,
			       F_CODE_NM('1000284',A.VI_PPS_CD) AS VI_PPS_NM,
			       A.VI_PPS_TXT,
			       F_CODE_NM('1000285',A.VI_WAY_CD) AS VI_WAY_NM,
			       A.VI_WAY_TXT,
			       A.TNB,
			       A.IO_NO,
			       F_CODE_NM('1000001', A.VI_PEN_RGN_CD) AS RGN_NM,
			       TO_CHAR(TO_DATE(A.REN_DT), 'YYYY-MM-DD') || ' ' ||
			       TO_CHAR(TO_DATE((A.REN_HH||A.REN_MM), 'HH24:MI'), 'HH24:MI') AS REN_TIME
			          
			  FROM	TBCSPOEP001M A
			 WHERE 	1=1
		]]>
		<dynamic>
			<isNotEmpty property="fromYmd">
				AND	A.VI_DT &gt;= #fromYmd#
			</isNotEmpty>
			<isNotEmpty property="toYmd">
				AND	A.VI_DT &lt;= #toYmd#
			</isNotEmpty>
			<isNotEmpty property="dptCd">
				AND A.BLT_BRDV_CD = #dptCd#
			</isNotEmpty>
			<isNotEmpty property="rankCd">
				AND A.RANK_CD = #rankCd#
			</isNotEmpty>
			<isNotEmpty property="cnb">
				AND A.CNB = #cnb#
			</isNotEmpty>
			<isNotEmpty property="workPlace">
				AND A.WRK_PLAC_NM LIKE '%'||#workPlace#||'%'
			</isNotEmpty>
			<isNotEmpty property="carNo">
				AND A.CAR_NO LIKE '%'||#carNo#||'%'
			</isNotEmpty>
			<isNotEmpty property="name">
				AND A.VI_PEN_NAM LIKE '%'||#name#||'%'
			</isNotEmpty>
		</dynamic>
		<![CDATA[
			 ORDER	BY A.VI_DT DESC, A.VI_HM DESC
		]]>
	</select>
</sqlMap> 
