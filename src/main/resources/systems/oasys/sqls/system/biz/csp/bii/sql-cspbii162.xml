<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/bii/162">
	
	
	<!-- 연관감사정보 목록 조회 -->   
	<select id="CSPBII162PMainSelect" parameterClass="paramMap" resultClass="resultMap">
		<include refid="include.pageSelct" />
		
		<![CDATA[       
			SELECT /* csp.bii.service.impl.CSPBII121QServiceImpl.CSPBII121QMainSelect */
			       A.YE || '-' || A.SRNO                                           AS INF_NO
			     , A.SMT_DT
			     , A.PRSR_CNB
			     , (SELECT B.USR_NAM
			          FROM TBDCMACM001M B
			         WHERE B.CNB = A.PRSR_CNB)                                     AS PRSR_NAM
			     , CASE WHEN SUBSTR(F_CODE_NM('1000097', A.INF_DVSN_CD), 1, 2) is not null THEN '(' || SUBSTR(F_CODE_NM('1000097', A.INF_DVSN_CD), 1, 2) || ')' || A.TIT_TXT
			            ELSE A.TIT_TXT
			             END AS TIT_TXT
			     , (SELECT B.ORG_NM
			          FROM TBDCMACM015M B
			         WHERE B.ORG_CD = A.REL_ORG_CD)                                AS REL_ORG_NM
			     , A.HNDL_DPT_CD
			     , (SELECT B.DPT_NM
			                 FROM TBDCMACM002M B
			                WHERE B.DPT_CD = A.HNDL_DPT_CD)                        AS HNDL_DPT_NM
			     , F_CODE_NM('1000039', A.HNDL_ORD_CD)                             AS HNDL_ORD_NM		
			     , A.AUD_INF_PRSS_STA_CD	    
			     , F_CODE_NM('1000085', A.AUD_INF_PRSS_STA_CD)                     AS AUD_INF_PRSS_STA_NM
			     , A.HNDL_DT
			     , F_CODE_NM('1000042', A.HNDL_RSLT_CD)                            AS HNDL_RSLT_NM
			     , A.OPEN_YN 
			     , A.YE
			     , A.SRNO
			  FROM TBCSPBII100M A
			 WHERE 1=1
		]]>
		
		<!-- 시작 연도 -->
		<isNotEmpty property="strStrYe">
			AND A.YE >= #strStrYe#
		</isNotEmpty>
		
		<!-- 종료 연도 -->
		<isNotEmpty property="strEndYe">
			AND A.YE &lt;= #strEndYe#
		</isNotEmpty>
		
		<!-- 시작 일련번호 -->
		<isNotEmpty property="strStrSrno">
			AND A.SRNO >= #strStrSrno#
		</isNotEmpty>
		
		<!-- 종료 일련번호 -->
		<isNotEmpty property="strEndSrno">
			AND A.SRNO &lt;= #strEndSrno#
		</isNotEmpty>
		
		<!-- 제목/내용 -->
		<isNotEmpty property="strSrhTxt">
			AND (A.TIT_TXT LIKE '%' || #strSrhTxt# || '%'
			 OR EXISTS (SELECT 1
			              FROM TBCSPBII101L B
			             WHERE INSTR(B.SCH_AUD_INF_TXT, #strSrhTxt#, 1, 1) > 0
			               AND B.YE   = A.YE
			               AND B.SRNO = A.SRNO))
		</isNotEmpty>
		
		<!-- 시작 기간 -->
		<isNotEmpty property="strStrDt">
			AND A.$strDtDvsnCd$ >= #strStrDt#
		</isNotEmpty>
		
		<!-- 종료 기간 -->
		<isNotEmpty property="strEndDt">
			AND A.$strDtDvsnCd$ &lt;= #strEndDt#
		</isNotEmpty>
		
		<!-- 시작관련기관 -->
		<isNotEmpty property="strStrRelOrgCd">
			<isEmpty property="strEndRelOrgCd">
				<isEqual property="strRelOrgIclsAt" compareValue="Y">
					AND (A.REL_ORG_CD   LIKE SUBSTR(#strStrRelOrgCd#, 0, INSTR(#strStrRelOrgCd#, '000') -1) || '%'
					  OR A.REL_ORG_CD_1 LIKE SUBSTR(#strStrRelOrgCd#, 0, INSTR(#strStrRelOrgCd#, '000') -1) || '%'
					  OR A.REL_ORG_CD_2 LIKE SUBSTR(#strStrRelOrgCd#, 0, INSTR(#strStrRelOrgCd#, '000') -1) || '%')
				</isEqual>
				<isNotEqual property="bltOrgIclsAt" compareValue="Y">
					AND (A.REL_ORG_CD   = #strStrRelOrgCd#
					  OR A.REL_ORG_CD_1 = #strStrRelOrgCd#
					  OR A.REL_ORG_CD_2 = #strStrRelOrgCd#)
				</isNotEqual>	
			</isEmpty>
			<isNotEmpty property="strEndRelOrgCd">
				AND (A.REL_ORG_CD   >= #strStrRelOrgCd#
				  OR A.REL_ORG_CD_1 >= #strStrRelOrgCd#
				  OR A.REL_ORG_CD_2 >= #strStrRelOrgCd#)
			</isNotEmpty>
		</isNotEmpty>
		
		<!-- 종료 관련기관 -->
		<isNotEmpty property="strEndRelOrgCd">
			<isEmpty property="strStrRelOrgCd">
				<isEqual property="strRelOrgIclsAt" compareValue="Y">
					AND (A.REL_ORG_CD   LIKE SUBSTR(#strEndRelOrgCd#, 0, INSTR(#strEndRelOrgCd#, '000') -1) || '%'
					  OR A.REL_ORG_CD_1 LIKE SUBSTR(#strEndRelOrgCd#, 0, INSTR(#strEndRelOrgCd#, '000') -1) || '%'
					  OR A.REL_ORG_CD_2 LIKE SUBSTR(#strEndRelOrgCd#, 0, INSTR(#strEndRelOrgCd#, '000') -1) || '%')
				</isEqual>
				<isNotEqual property="bltOrgIclsAt" compareValue="Y">
					AND (A.REL_ORG_CD   = #strEndRelOrgCd#
					  OR A.REL_ORG_CD_1 = #strEndRelOrgCd#
					  OR A.REL_ORG_CD_2 = #strEndRelOrgCd#)
				</isNotEqual>	
			</isEmpty>
			<isNotEmpty property="strStrRelOrgCd">
				AND (A.REL_ORG_CD   &lt;= #strEndRelOrgCd#
				  OR A.REL_ORG_CD_1 &lt;= #strEndRelOrgCd#
				  OR A.REL_ORG_CD_2 &lt;= #strEndRelOrgCd#)
			</isNotEmpty>
		</isNotEmpty>
		
		<include refid="include.pageOrder" />
	</select>
	
	<!-- 연관감사정보 조회 -->   
	<select id="CSPBII162IAudInfSelect" parameterClass="paramMap" resultClass="resultMap">
		<![CDATA[       
			SELECT A.YE                            /* 연도 */
			     , A.SRNO                          /* 일련번호 */			     
			     , A.YE || '-' || A.SRNO AS INF_NO /* 정보번호 */
			     , A.TIT_TXT                       /* 제목내용 */		  
			  FROM TBCSPBII100M A /* 감사정보기본 */
			 WHERE A.YE   = REGEXP_SUBSTR(#strInfNo#, '[^|-]+', 1, 1)
			   AND A.SRNO = REGEXP_SUBSTR(#strInfNo#, '[^|-]+', 1, 2)
		]]>
	</select>
</sqlMap> 
