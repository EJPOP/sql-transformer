<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/cmr/005">

<select id="badcmr005QDetailselect" parameterClass="paramMap"
		resultClass="resultMap">
        <![CDATA[       
        SELECT 
         A.YE||'-'||A.LAG_CAT_SNO||'-'||A.MID_CAT_SNO||'-'||A.SALL_CAT_SNO AS CAT_NO
          ,A.YE
          ,A.SALL_CAT_SNO
          ,A.LAG_CAT_SNO /* 정책목표 */
          ,C.LAG_CAT_TIT_NM
          ,A.MID_CAT_SNO /* 중분류번호 */
          ,B.MID_CAT_TIT_NM
          ,A.SALL_CAT_TIT_NM  /* 소분류제목 */
          ,A.SALL_CAT_TXT
          ,A.CHR_DPT_CD
          , F_DPT_INFO(A.CHR_DPT_CD,'1') AS CHR_DPT_NM
          ,A.CHGR_ID /* 담당자ID */
          ,F_USR_INFO(A.CHGR_ID,'2') AS CHGR_NM
          ,A.CMPT_YN  /* 완료여부 */
          ,A.REGI_DT
          ,A.REGN_ID
          ,A.MDF_DT
          ,A.MDF_PEN_ID
          ,A.DEL_YN
        

        
        ,(select max(PLCY_MDF_DH) from TBBADCMR004D   
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0101' ) QT1_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0401' ) QT2_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0701' ) QT3_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'1001' ) QT4_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0101' ) MONTH1_PLCY_MDF_DH   
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0201' ) MONTH2_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0301' ) MONTH3_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0401' ) MONTH4_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0501' ) MONTH5_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0601' ) MONTH6_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0701' ) MONTH7_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0801' ) MONTH8_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'0901' ) MONTH9_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'1001' ) MONTH10_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'1101' ) MONTH11_PLCY_MDF_DH  
           ,(select max(PLCY_MDF_DH) from TBBADCMR004D  
             where YE = A.YE and SALL_CAT_SNO = A.SALL_CAT_SNO  
                   and REGI_DT like #strYear#||'1201' ) MONTH12_PLCY_MDF_DH  

       ,D.USR_NAM AS CHRG_PSON_NM
       , A.CPR_CHGR_ID
			     , F_USR_INFO(A.CPR_CHGR_ID,'2')AS CPR_CHGR_NM
					, A.CPR_DPT_CD
					, F_DPT_INFO(A.CPR_DPT_CD,'1') AS CPR_DPT_NM
					, A.STD_CHGR_ID
					, F_USR_INFO(A.STD_CHGR_ID,'2')AS STD_CHGR_NM
					, A.STD_DPT_CD
					, F_DPT_INFO(A.STD_DPT_CD,'1') AS STD_DPT_NM
					,NVL(A.EPS_MNG_YN,'N') AS EPS_MNG_YN
         FROM TBBADCMR003M A 
            , TBDCMACM001M D 
            , TBBADCMR002M B
            , TBBADCMR001M C
         WHERE 
             D.BAI_USR_YN = 'Y' 
         AND A.CHGR_ID = D.CNB(+)
           AND A.CHGR_ID = D.CNB(+)
		   AND A.LAG_CAT_SNO = B.LAG_CAT_SNO
		   AND A.MID_CAT_SNO = B.MID_CAT_SNO
		   AND A.YE =B.YE
		   AND A.LAG_CAT_SNO = C.LAG_CAT_SNO
		   AND A.YE =C.YE
	 
             AND A.YE = #strYear#
       
        ]]>
       
        
          <isNotEmpty property="strLagCatSno">	 
             AND A.LAG_CAT_SNO = #strLagCatSno# 
            </isNotEmpty> 

      
          <isNotEmpty property="strMidCatSno">	 
             AND A.MID_CAT_SNO = #strMidCatSno#  
           </isNotEmpty> 

        
           <isNotEmpty property="strSalTit">	 
             AND A.SALL_CAT_TIT_NM LIKE '%'||#strSalTit#||'%'

           </isNotEmpty> 

       
         <isNotEmpty property="strUsrCnb">	 
             AND A.CHGR_ID = #strUsrCnb# 
          </isNotEmpty> 
       
       
          <isNotEmpty property="strYn">	 
             AND A.CMPT_YN LIKE #strYn#||'%' 
          </isNotEmpty> 
          
            <isNotEmpty property="strDptCd">	 
             AND A.CHR_DPT_CD = #strDptCd# 
            </isNotEmpty> 
            
            <isNotEmpty property="strLikeDptCd">	 
             AND A.CHR_DPT_CD LiKE #strLikeDptCd#||'%'
            </isNotEmpty> 
            <isNotEmpty property="strEPS_MNG_YN">	 
             AND NVL(A.EPS_MNG_YN,'N') = #strEPS_MNG_YN# 
            </isNotEmpty> 
            
  
<![CDATA[
         ORDER BY A.YE, CASE WHEN A.YE ='2017' AND A.SALL_CAT_SNO < 187 THEN 1 ELSE 0 END, A.SALL_CAT_SNO 
       ]]>
  </select>
  
  
  	<resultMap class="java.util.HashMap" id="resultClob">
		<result property="SALL_CAT_TIT_NM" column="SALL_CAT_TIT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DPT_NM" column="DPT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="CHGR_NM" column="CHGR_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="YE" column="YE" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="SALL_CAT_SNO" column="SALL_CAT_SNO" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="REGI_DT" column="REGI_DT" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="MAIN_PLCY_DTL_TXT" column="MAIN_PLCY_DTL_TXT" jdbcType="CLOB" javaType="java.lang.String" />
        <result property="LAG_CAT_TIT_NM" column="LAG_CAT_TIT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="MID_CAT_TIT_NM" column="MID_CAT_TIT_NM" jdbcType="VARCHAR2" javaType="java.lang.String" />
        <result property="SUBJ_NO" column="SUBJ_NO" jdbcType="VARCHAR2" javaType="java.lang.String" />  
    </resultMap>
  
  <select id="badcmr005QPrintselect" parameterClass="paramMap"
		resultMap="resultClob">
        <![CDATA[    
			SELECT D.SALL_CAT_TIT_NM /*과제명*/
			     , F_DPT_INFO(D.CHR_DPT_CD, '1') AS DPT_NM /*담당부서*/
			     , F_USR_INFO(D.CHGR_ID, '2') AS CHGR_NM /*전담자*/
			     , D.YE AS YE
			     , D.SALL_CAT_SNO AS SALL_CAT_SNO
			     , D.REGI_DT
			     , (SELECT MAIN_PLCY_DTL_TXT
			          FROM TBBADCMR004D
			         WHERE YE = #strYear#
			           AND SALL_CAT_SNO=D.SALL_CAT_SNO
			           AND MAIN_PLCY_DTL_DVSN_CD ='b'
			           AND REGI_DT = D.REGI_DT) AS MAIN_PLCY_DTL_TXT
			     , LAG_CAT_TIT_NM /*대분류 명*/
			     , MID_CAT_TIT_NM /*중분류명*/
			     , SUBJ_NO /*과제번호*/
			  FROM (
			  
			  SELECT A.SALL_CAT_TIT_NM /*과제명*/
			             , A.CHR_DPT_CD /*담당부서*/
			             , A.CHGR_ID /*전담자*/
			
			              , MAX(B.REGI_DT) AS REGI_DT                         
			             , (SELECT LAG_CAT_TIT_NM
			                  FROM TBBADCMR001M
			                 WHERE YE = #strYear#
			                   AND LAG_CAT_SNO = A.LAG_CAT_SNO) AS LAG_CAT_TIT_NM /*대분류 명*/
			             , (SELECT MID_CAT_TIT_NM
			                  FROM TBBADCMR002M
			                 WHERE YE = #strYear#
			                   AND LAG_CAT_SNO = A.LAG_CAT_SNO
			                   AND MID_CAT_SNO = A.MID_CAT_SNO) AS MID_CAT_TIT_NM /*중분류명*/
			             , A.YE || '-' || A.LAG_CAT_SNO || '-' || A.MID_CAT_SNO || '-' || A.SALL_CAT_SNO AS SUBJ_NO /*과제번호*/
			             , A.SALL_CAT_SNO
			             , A.YE
			          FROM TBBADCMR003M A
			             , TBBADCMR004D B
			         WHERE A.YE = B.YE (+)
			           AND A.SALL_CAT_SNO = B.SALL_CAT_SNO (+)
			
			           AND A.YE = #strYear#
			           ]]>
			       <isNotEmpty property = "strSnoArrayList">
				      AND  A.SALL_CAT_SNO IN 
				         		<iterate property = "strSnoArrayList" open="(" close=")" conjunction=",">
				         			#strSnoArrayList[]#
				         		</iterate>
				   </isNotEmpty> 
			          
			           AND B.MAIN_PLCY_DTL_DVSN_CD (+) = 'b' /*모니터링결과*/
			        GROUP BY A.SALL_CAT_TIT_NM, A.CHR_DPT_CD, A.CHGR_ID, A.LAG_CAT_SNO, A.MID_CAT_SNO,A.YE,A.SALL_CAT_SNO
			            )D
			            ORDER BY D.SALL_CAT_SNO
        </select>
  
	
</sqlMap> 
