<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/cis/301">

	<resultMap class="java.util.HashMap" id="CSPCIS302PMainSelect">
		<result property="REGI_DT" column="REGI_DT" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="REGI_NO" column="REGI_NO" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="LVL_CNT" column="LVL_CNT" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DVSN_CD" column="DVSN_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="TIT_ENN" column="TIT_ENN" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ENTX" column="ENTX" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ECN" column="ECN" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="USR_EID" column="USR_EID" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="USR_NAM" column="USR_NAM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ATT_FL_EID" column="ATT_FL_EID" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DOC_TYP_CD" column="DOC_TYP_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="STA_YN" column="STA_YN" jdbcType="VARCHAR2" javaType="java.lang.String" />
	</resultMap>
	<select id="CSPCIS302PMainSelect" parameterClass="paramMap" resultMap="CSPCIS302PMainSelect">
		<![CDATA[
			 SELECT A.REGI_DT,
			        A.REGI_NO,
			        A.LVL_CNT,
			        A.DVSN_CD,
			        A.TIT_ENN,
			        A.ENTX,
			        A.ECN,
			        A.USR_EID,
			        A.USR_NAM,
			        A.ATT_FL_EID,
			        A.DOC_TYP_CD,
			        A.STA_YN
			   FROM TBCSPCIS003M A
			  WHERE 1=1
			  AND (A.ECN = #cnb#
			  OR (A.REGI_DT , A.REGI_NO) 
			  IN (SELECT  A.REGI_DT , A.REGI_NO  FROM TBCSPCIS003M A WHERE A.ECN = #cnb#))
			 ORDER	BY REGI_DT DESC, REGI_NO DESC, LVL_CNT
		]]>
	</select>
	
	<resultMap class="java.util.HashMap" id="CSPCIS302PDetailSelectList">
		<result property="REGI_DT" column="REGI_DT" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="REGI_NO" column="REGI_NO" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="LVL_CNT" column="LVL_CNT" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DVSN_CD" column="DVSN_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="TIT_ENN" column="TIT_ENN" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ENTX" column="ENTX" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ECN" column="ECN" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="USR_EID" column="USR_EID" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="USR_NAM" column="USR_NAM" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ATT_FL_EID" column="ATT_FL_EID" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DOC_TYP_CD" column="DOC_TYP_CD" jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="STA_YN" column="STA_YN" jdbcType="VARCHAR2" javaType="java.lang.String" />
	</resultMap>
	<select id="CSPCIS302PDetailSelectList" parameterClass="paramMap" resultMap="CSPCIS302PDetailSelectList">
		<![CDATA[
			SELECT	
					REGI_DT,
					REGI_NO,
					LVL_CNT,
					DVSN_CD,
					TIT_ENN,
					ENTX,
					ECN,
					USR_EID,
					USR_NAM,
					ATT_FL_EID,
					DOC_TYP_CD,
					STA_YN
			  FROM 	TBCSPCIS003M
			 WHERE	1=1
			   AND	REGI_DT = #dt#
			   AND	REGI_NO = #no#
			   AND	LVL_CNT = #lvl#
		]]>
	</select>
	
	<insert id="CSPCIS302PInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPCIS003M
			(
				 REGI_DT
				,REGI_NO
				,LVL_CNT
				,DVSN_CD
				,TIT_ENN
				,ENTX
				,ECN
				,USR_EID
				,USR_NAM
				,ATT_FL_EID
				,STA_YN
				
			)
			VALUES
			(
				 TO_CHAR(SYSDATE, 'YYYYMMDD')
				,(SELECT NVL(MAX(REGI_NO)+1,1) FROM TBCSPCIS003M)
				,0
				,#DVSN_CD#
				,#TIT_ENN#
				,#ENTX#
				,#S_CNB#
				,#FNL_USR_ID#
				,#S_USR_NAM#
				,#ATT_FL_EID#
				,'N'
			)
		]]>
	</insert>
	
	<update id="CSPCIS302PUpdate" parameterClass="paramMap" >
		<![CDATA[
		 UPDATE TBCSPCIS003M
			SET  DVSN_CD 	= #DVSN_CD#
				,TIT_ENN 	= #TIT_ENN#
				,ENTX		= #ENTX#
				,ECN		= #ECN#
				,USR_EID	= #USR_EID#
				,USR_NAM	= #USR_NAM#
				,ATT_FL_EID= #ATT_FL_EID#
				,STA_YN			= 'N'
			WHERE	REGI_DT    =   #REGI_DT#
			  AND	REGI_NO    =   #REGI_NO#
			  AND	LVL_CNT    =   0
		]]>
	</update>
	
	 <resultMap class="java.util.HashMap" 	id="CSPCIS301PMainSelect">
		<result property="REGI_DT" 	column="REGI_DT" 		jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="REGI_NO" 	column="REGI_NO" 		jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="LVL_CNT" 	column="LVL_CNT" 		jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DVSN_CD" 	column="DVSN_CD" 		jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="CD_NM" 			column="CD_NM" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="TIT_ENN" 	column="TIT_ENN" 		jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ENTX" 		column="ENTX" 			jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ECN" 		column="ECN" 			jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="USR_EID" 	column="USR_EID" 		jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="USR_NAM" 	column="USR_NAM" 		jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="ATT_FL_EID" 	column="ATT_FL_EID" 	jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="DOC_TYP_CD" 	column="DOC_TYP_CD" 	jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="STA_YN" 			column="STA_YN" 			jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="REPLY_YN" 		column="REPLY_YN" 			jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_DT" 			column="B_DT" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_NO" 			column="B_NO" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_CNT" 			column="B_CNT" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_CD" 			column="B_CD" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_ENN" 			column="B_ENN" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_ENTX" 			column="B_ENTX" 			jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_ECN" 			column="B_ECN" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_EID" 			column="B_EID" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_NAM" 			column="B_NAM" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
		<result property="B_YN" 			column="B_YN" 				jdbcType="VARCHAR2" javaType="java.lang.String" />
	</resultMap>
	<select id="CSPCIS301PMainSelect" parameterClass="paramMap" resultMap="CSPCIS301PMainSelect">
		<![CDATA[
			SELECT 	A.REGI_DT,
					A.REGI_NO,
					A.LVL_CNT,
					A.DVSN_CD,
					F_CODE_NM('1000308', A.DVSN_CD) AS CD_NM,
					A.TIT_ENN,
					A.ENTX,
					A.ECN,
					A.USR_EID,
					A.USR_NAM,
					A.ATT_FL_EID,
					A.DOC_TYP_CD,
					A.STA_YN,
					DECODE(B.REGI_DT,NULL,'N','Y') AS REPLY_YN,
					B.REGI_DT AS B_DT,
					B.REGI_NO AS B_NO, 
					B.LVL_CNT AS B_CNT,
					A.DVSN_CD AS B_CD,
					B.TIT_ENN AS B_ENN,
					B.ENTX AS B_ENTX,
					B.ECN AS B_ECN,
					B.USR_EID AS B_EID,
					B.USR_NAM AS B_NAM,
					B.STA_YN AS B_YN
			FROM
				(SELECT * FROM TBCSPCIS003M A WHERE LVL_CNT = 0) A, 
				(SELECT * FROM TBCSPCIS003M A WHERE LVL_CNT <> 0 ) B 
			WHERE A.REGI_DT = B.REGI_DT(+)
			AND A.REGI_NO = B.REGI_NO(+)
		]]>
		<dynamic>
			<isNotEmpty property="readYn">
				AND	A.STA_YN = #readYn#
			</isNotEmpty>
			<isNotEmpty property="dt">
				AND A.REGI_DT = #dt#
			</isNotEmpty>
			<isNotEmpty property="no">
				AND A.REGI_NO = #no#
			</isNotEmpty>
		</dynamic>
		<![CDATA[
			ORDER BY A.REGI_DT DESC, A.REGI_NO DESC
		]]>
	</select>
	
	<update id="CSPCIS301PUpdate" parameterClass="paramMap" >
		<![CDATA[
			MERGE INTO TBCSPCIS003M A
			USING ( SELECT  #B_DT# AS REGI_DT
			               ,#B_NO# AS REGI_NO
			               ,1 AS LVL_CNT
			          FROM DUAL 
			       ) B
			ON (    A.REGI_DT = B.REGI_DT 
			    AND	A.REGI_NO = B.REGI_NO
			    AND	A.LVL_CNT = B.LVL_CNT
				)
			WHEN MATCHED THEN 
			UPDATE SET 
					 DVSN_CD 	= #B_CD#
					,TIT_ENN 	= #B_ENN#
					,ENTX		= #B_ENTX#
			WHEN NOT MATCHED THEN 
			INSERT (		
					 REGI_DT
					,REGI_NO
					,LVL_CNT
					,DVSN_CD
					,TIT_ENN
					,ENTX
					,ECN
					,USR_EID
					,USR_NAM
					,STA_YN
					)
			VALUES (				 
					 #REGI_DT#
					,#REGI_NO#
					,1
					,#B_CD#
					,#B_ENN#
					,#B_ENTX#
					,#S_CNB#
					,#FNL_USR_ID#
					,#S_USR_NAM#
					,'N'
					)
		]]>
	</update>
	
	<update id="CSPCIS301PStaYnUpdate" parameterClass="paramMap" >
		<![CDATA[
		 UPDATE TBCSPCIS003M
			SET  STA_YN 	= 'Y'
			WHERE	REGI_DT    =   #dt#
			  AND	REGI_NO    =   #no#
			  AND	LVL_CNT    =   0
		]]>
	</update>
	
	<insert id="CSPCIS301PInsert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO TBCSPCIS003M
			(
				 REGI_DT
				,REGI_NO
				,LVL_CNT
				,DVSN_CD
				,TIT_ENN
				,ENTX
				,ECN
				,USR_EID
				,USR_NAM
				,STA_YN
				
			)
			VALUES
			(
				 #REGI_DT#
				,#REGI_NO#
				,1
				,#B_CD#
				,#B_ENN#
				,#B_ENTX#
				,#S_CNB#
				,#FNL_USR_ID#
				,#S_USR_NAM#
				,'N'
			)
		]]>
	</insert>
	
	<update id="CSPCIS302PStaYnUpdate" parameterClass="paramMap" >
		<![CDATA[
			UPDATE 	TBCSPCIS003M
			   SET 	STA_YN 	= 'Y'
			 WHERE	REGI_DT    =   #dt#
			   AND	REGI_NO    =   #no#
			   AND	LVL_CNT    =   1
		]]>
	</update>
	
	<select id="CSPCIS302PSelectMaxMMSSeq" parameterClass="paramMap" resultClass="String">
        <![CDATA[
   			SELECT MMS_CONTENTS_INFO_SEQ.NEXTVAL AS SEQ FROM DUAL
       	]]>
	</select>
	
	<insert id="CSPCIS302PInsertSms" parameterClass="paramMap">
        <![CDATA[
 			INSERT INTO MSG_DATA 
	 			      ( MSG_SEQ
	 			      , REQ_DATE
	 			      , CUR_STATE
	 			      , CALL_TO
	 			      , CALL_FROM
	 			      , SMS_TXT
	 			      , MSG_TYPE
	 			      , CONT_SEQ)
 			      VALUES (
 			            MSG_DATA_SEQ.NEXTVAL
 			          , SYSDATE
 			          , 0
 			          , REPLACE(#CALL_TO#, '-')
 			          , '감사원장'
 			          , '원장님이 글을 확인하였습니다.'
 			          , 4
 			          , #CONT_SEQ#)
        ]]>
	</insert>
	
	<select id="CSPCIS302PSelectHomTnb" parameterClass="paramMap" resultClass="String">
        <![CDATA[
   			SELECT HOM_TNB FROM TBDCMACM001M WHERE CNB = #toCnb#
       	]]>
	</select>
	
	<delete id="CSPCIS302PDelete" parameterClass="paramMap" >
		<![CDATA[
			DELETE FROM TBCSPCIS003M
			WHERE REGI_DT = #REGI_DT#
			AND REGI_NO = #REGI_NO#
		]]>
	</delete>
	
	<update id="CSPCIS302EUpdate" parameterClass="paramMap" >
		<![CDATA[
		 UPDATE TBCSPCIS003M
			SET  
				 TIT_ENN 	= #TIT_ENN#
				,ENTX		= #ENTX#
				,ECN		= #ECN#
				,USR_EID	= #USR_EID#
				,USR_NAM	= #USR_NAM#
				,ATT_FL_EID = #ATT_FL_EID#
				,STA_YN			= 'N'
			WHERE	REGI_DT    =   #REGI_DT#
			  AND	REGI_NO    =   #REGI_NO#
			  AND	LVL_CNT    =   0
		]]>
	</update>
	
	<select id="CSPCIS302PUSelect" parameterClass="paramMap" resultClass="String">
		<![CDATA[
			SELECT 	CNB
			FROM 	TBDCMACM001M 
			WHERE 	DPT_CD ='121000'
			AND 	INN_RANK_CD ='30'
		]]>
	</select>

	<insert id="CSPCIS302PMsg206Insert" parameterClass="paramMap">
		<![CDATA[
			INSERT INTO
			TBDCMACM026L
			(
			  MSG_SNO
			, TSK_CAT_CD
			, FUNC_CAT_CD
			, SEND_ID
	        , MSG_TP_YN
	  
	        , MSG_TXT_2
	        , RCNT_CNT
	        , RCNT_HIS
	        , MSG_REGI_DH
	
			, FRT_USR_ID
			, FNL_USR_ID
			, FNL_DEAL_DPT_CD
			, FNL_MNU_ID
			, FRT_REGI_DH
			,
			FNL_MDF_DH
	
			)
			VALUES
			(
			  (SELECT NVL(MAX(MSG_SNO),0)+1 FROM TBDCMACM026L)
			, 'SP'
			, 'IS'
			, #FNL_USR_ID#
	        , '0'
	     
	        , #MSG_TXT#
	        , 1
	        , #MSG_CNB#
	        , SYSDATE
	        
	        
			, #FNL_USR_ID#
			, #FNL_USR_ID#
			, #FNL_DEAL_DPT_CD#
			, #FNL_MNU_ID#
			, SYSDATE
			, SYSDATE
	
			);
			
		]]>
	</insert>	
</sqlMap> 
