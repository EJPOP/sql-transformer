<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="bad/gda/001">
	
	<!--범죄 및 징계통보 조회-->
	<select id="BADGDA001EMainselect" parameterClass="paramMap" resultClass="resultMap">
    	<include refid="include.pageSelct" />
              SELECT 
                     D1.ORG_CD                                     /* 기관코드 */     
                    ,D1.NTF_DVSN_CD                                /* 통보구분코드 */ 
                    ,D1.YR                                         /* 년도 */         
                    ,D1.DPT_CD                                     /* 부서코드 */
                    ,F_DPT_INFO(D1.DPT_CD, '1') AS DPT_NM          /* 부서명 */
                    ,D1.NNB                                        /* 통보번호 */     
                    ,D1.ACP_STA_CD                                 /* 접수상태코드 */
                    ,CASE WHEN D1.ACP_STA_CD IN ('58','59')      THEN '미접수'
                          WHEN D1.ACP_STA_CD IN ('71','72','76') THEN '처리중' 
                          WHEN D1.ACP_STA_CD = '75'              THEN '결재중' 
                          WHEN D1.ACP_STA_CD = '77'              THEN '완결'
                          ELSE D1.ACP_STA_CD 
                      END    AS ACP_STA_NM                         /* 접수상태코드 */                        
                    ,D1.ACP_MNG_NO                                 /* 접수관리번호 */     
                    ,D1.ACP_DT                                     /* 접수일 */           
                    ,D1.DGE1_ORG_ACP_DT                            /* 1차기관접수일 */    
                    ,D1.BAI_BRDV_CD                                /* 감사원국과코드 */   
                    ,D1.COPT_ORG_CD                                /* 소관기관코드 */     
                    ,D1.TIT_NM                                     /* 제목명 */           
                    ,D1.WRDO_CD                                    /* 비위코드 */   
                    ,D1.WRDO_NM                                    /* 비위코드명 */
                    ,D1.DFNT_CNT                                   /* 관계자수 */         
                    ,D1.NTF_ETC_TXT                                /* 통보기타내용 */     
                    ,D1.OGN_DVSN_CD                                /* 발생구분코드 */   
                    ,D1.REGI_DT                                    /* 등록일 */           
                    ,D1.REGN_ID                                    /* 등록자ID */         
                    ,D1.HNDL_DT                                    /* 처리일 */           
                    ,D1.TSK_CAT_CD                                 /* 업무분류코드 */     
                    ,D1.LOS_AM                                     /* 손해금액 */         
                    ,D1.RFD_AM                                     /* 환불금액 */         
                    ,D1.SLF_CPS_AM                                 /* 자체변상금액 */     
                    ,D1.OPM_NO                                     /* 시행문번호 */       
                    ,D1.COFM_DT                                    /* 승인일 */           
                    ,D1.CPLT_DT                                    /* 완결일 */           
                    ,D1.ENF_KND_CD                                 /* 시행종류코드 */     
                    ,D1.SUP_ORG_CD                                 /* 감독기관코드 */     
                    ,D1.PRAC_ORG_CD                                /* 실행기관코드 */     
                    ,D1.DOC_TEXT_NO                                /* 문서텍스트번호 */         
                    ,D1.DOC_DT                                     /* 문서일 */           
                    ,D1.RCEP_ID                                    /* 접수자ID */         
                    ,D1.APV_DOC_NO                                 /* 결재문서번호 */     
                    ,D1.HNDL_PEN_NM                                /* 처리자명 */         
                    ,D1.HNDL_OPIN_CD                               /* 처리의견코드 */
                    ,CASE WHEN D1.HNDL_OPIN_CD IS NOT NULL 
                               THEN F_CODE_NM('1000200', D1.HNDL_OPIN_CD)
                          ELSE '미처리'
                      END                       AS  HNDL_OPIN_NM   /* 처리의견명 */                    
                    ,D1.CFM_YN                                     /* 확인여부 */         
                    ,D1.CFM_DH                                     /* 확인일시 */         
                    ,D1.MDF_DT                                     /* 수정일 */           
                    ,D1.MDF_PEN_ID                                 /* 수정자ID */         
                    ,D1.EXAM_RSLT_TXT                              /* 검토결과내용 */     
                    ,D1.HNDL_PEN_RANK_NM                           /* 처리자직급명 */     
                    ,D1.HNDL_STT_TXT                               /* 처리상황내용 */     
                    ,D1.CMT_SBCN_TXT                               /* 위원회부의내용 */   
                    ,D1.ENF_DT                                     /* 시행일 */           
                    ,D1.AUD_MTRL_RMK                               /* 감사자료비고 */     
                    ,D1.AUD_MTRL_YR                                /* 감사자료년도 */     
                    ,D1.AUD_MTRL_DPT_CD                            /* 감사자료부서코드 */ 
                    ,D1.AUD_MTRL_SRNO                              /* 감사자료일련번호 */ 
                    ,D1.SLF_PRSS_STA_CD                            /* 자체진행상태코드 */ 
                    ,D1.SLF_SEN_DT                                 /* 자체발송일 */       
                    ,D1.SLF_APV_DT                                 /* 자체결재일 */       
                    ,D1.DOC_ID                                     /* 문서ID */           
                    ,D1.DOC_TYP_CD                                 /* 문서유형코드 */     
                    ,D1.FRT_USR_ID                                 /* 최초사용자ID */     
                    ,D1.FNL_USR_ID                                 /* 최종사용자ID */     
                    ,D1.FNL_DEAL_DPT_CD                            /* 최종거래부서코드 */ 
                    ,D1.FNL_MNU_ID                                 /* 최종메뉴ID */       
                    ,D1.FRT_REGI_DH                                /* 최초등록일시 */     
                    ,D1.FNL_MDF_DH                                 /* 최종수정일시 */     
                    ,D1.CON_RET_KY_NM                              /* 연계반려키명 */     
                    ,D1.CON_YR                                     /* 연계년도 */         
                    ,D1.CON_SRNO                                   /* 연계일련번호 */
                    ,D2.DFNT_NMS                                   /* 가공한 관계자명 */ 
                    ,(SELECT ORG_NM
                        FROM TBDCMACM015M
                       WHERE ORG_CD = D1.ORG_CD) 
                     || '-' ||  
                     (SELECT CD_NM 
                        FROM TBDCMACM013C
                       WHERE CMM_CD_DVSN_CD  ='1000202'
                         AND CD              = D1.OGN_DVSN_CD
                         AND NVL(USE_YN,'N') ='Y')                        
                     || '-' ||  
                     D1.NNB             AS   NTF_SBJ_NO            /* 통보사항번호 */
               FROM TBBADGDA001M  D1     /* 통보기본사항 */
               
                <!-- 검색어 존재 -->
                <isNotEmpty property="strSchTxt">                
                    <!-- 전체 조회 -->
                    <isEqual property="strSchDvsn" compareValue="0">
                    ,( SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              <!--  
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T2.SRNO) = 1 THEN MAX(T2.DFNT_NM)
                                    WHEN COUNT(T2.SRNO) > 1 THEN MAX(T2.DFNT_NM) || '외 ' || ( COUNT(T2.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001M T1     /* 통보사항 기본 */
                             ,TBBADGDA001L T2     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.ORG_CD      = T2.ORG_CD(+)
                          AND T1.NTF_DVSN_CD = T2.NTF_DVSN_CD(+)
                          
                          <!-- 
                          AND T1.YR          = T2.YR(+)
                          AND T1.DPT_CD      = T2.DPT_CD(+)
                           -->
                          
                          AND T1.NNB         = T2.NNB(+)
                          AND T1.TIT_NM LIKE '%' || #strSchTxt# || '%'
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!-- GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB -->
                     
                     UNION
                     
                       SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              <!-- 
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T1.SRNO) = 1 THEN MAX(T1.DFNT_NM)
                                    WHEN COUNT(T1.SRNO) > 1 THEN MAX(T1.DFNT_NM) || '외 ' || ( COUNT(T1.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001L T1     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.CRIM_WRDO_TXT LIKE '%' || #strSchTxt# || '%'
                          
                      <!-- 관계자명 -->
                      <isNotEmpty property="strDfntNm">
                          AND T1.DFNT_NM LIKE '%' || #strDfntNm# || '%'
                      </isNotEmpty>
                                                
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!--  GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB  -->
                    ) D2
                    </isEqual>
                    
                    <!-- 제목 조회 -->
                    <isEqual property="strSchDvsn" compareValue="1">
                     ,(SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              
                              <!-- 
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                               
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T2.SRNO) = 1 THEN MAX(T2.DFNT_NM)
                                    WHEN COUNT(T2.SRNO) > 1 THEN MAX(T2.DFNT_NM) || '외 ' || ( COUNT(T2.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001M T1     /* 통보사항 기본 */
                             ,TBBADGDA001L T2     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.ORG_CD      = T2.ORG_CD(+)
                          AND T1.NTF_DVSN_CD = T2.NTF_DVSN_CD(+)
                          
                          <!-- 
                          AND T1.YR          = T2.YR(+)
                          AND T1.DPT_CD      = T2.DPT_CD(+)
                           -->
                          
                          AND T1.NNB         = T2.NNB(+)
                          AND T1.TIT_NM LIKE '%' || #strSchTxt# || '%'
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!-- GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB -->
                    ) D2                    
                    </isEqual>
                    
                    <!-- 내용 조회 -->
                    <isEqual property="strSchDvsn" compareValue="2">
                     ,(SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              <!-- 
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T1.SRNO) = 1 THEN MAX(T1.DFNT_NM)
                                    WHEN COUNT(T1.SRNO) > 1 THEN MAX(T1.DFNT_NM) || '외 ' || ( COUNT(T1.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001L T1     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.CRIM_WRDO_TXT LIKE '%' || #strSchTxt# || '%'
                          
                      <!-- 관계자명 -->
                      <isNotEmpty property="strDfntNm">
                          AND T1.DFNT_NM LIKE '%' || #strDfntNm# || '%'
                      </isNotEmpty>
                                                
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!-- GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB -->
                    ) D2                    
                    </isEqual>                    
                </isNotEmpty>

                <!-- 검색어 미존재 -->
                <isEmpty property="strSchTxt">
                     ,(SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              <!-- 
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T2.SRNO) = 1 THEN MAX(T2.DFNT_NM)
                                    WHEN COUNT(T2.SRNO) > 1 THEN MAX(T2.DFNT_NM) || '외 ' || ( COUNT(T2.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001M T1     /* 통보사항 기본 */
                             ,TBBADGDA001L T2     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.ORG_CD      = T2.ORG_CD(+)
                          AND T1.NTF_DVSN_CD = T2.NTF_DVSN_CD(+)
                          
                          <!-- 
                          AND T1.YR          = T2.YR(+)
                          AND T1.DPT_CD      = T2.DPT_CD(+)
                           -->
                          
                          AND T1.NNB         = T2.NNB(+)
                      <!-- 관게자 존재 -->
                      <isNotEmpty property="strDfntNm">                        
                          AND T2.DFNT_NM LIKE '%' || #strDfntNm# || '%'
                      </isNotEmpty>
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!-- GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB -->
                    ) D2
                </isEmpty>

              WHERE 1=1        
                AND D1.ORG_CD      = D2.ORG_CD
                AND D1.NTF_DVSN_CD = D2.NTF_DVSN_CD
                
                <!-- 
                AND D1.YR          = D2.YR
                AND D1.DPT_CD      = D2.DPT_CD
                 -->
                 
                AND D1.NNB         = D2.NNB
                AND D1.NTF_DVSN_CD = '1' /* 통보구분코드 (1:범죄및징계, 2:망실및훼손) */
                AND D1.ACP_STA_CD  != '51'                
                
                AND D1.DPT_CD      IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #strDptAuth#, '', #strDptCd#)))
                
			<isNotEmpty property="strDptCd2">
                AND D1.DPT_CD      = #strDptCd2#
            </isNotEmpty> 
               
			<!-- 접수일자 -->
			<isNotEmpty property="strAcpDtStr">	
				AND D1.ACP_DT  BETWEEN #strAcpDtStr#  AND #strAcpDtEnd#    /* 접수일자 */
			</isNotEmpty>
			               
            <!-- 처리구분코드 --> 
            <isNotEqual property="strHndlStaDvsnCd" compareValue="0">
                <!-- 미결-->
                <isEqual property="strHndlStaDvsnCd" compareValue="1">
                    AND D1.ACP_STA_CD IN ('58', '59', '71', '72', '75', '76')  
                </isEqual>
                <!-- 처리중 -->
                <isEqual property="strHndlStaDvsnCd" compareValue="3">
                    AND D1.ACP_STA_CD IN ('71', '72', '76') 
                </isEqual>
                <!-- 결재중 -->
                <isEqual property="strHndlStaDvsnCd" compareValue="4">
                    AND D1.ACP_STA_CD = '75'   
                </isEqual>
                <!-- 완결 -->
                <isEqual property="strHndlStaDvsnCd" compareValue="5">
                    AND D1.ACP_STA_CD = '77' 
                </isEqual>
            </isNotEqual>

            <!-- 통보구분(통보발생구분코드) 분기 -->
            <isEqual property="strOgnDvsnCd" compareValue="0">
                AND D1.OGN_DVSN_CD IN ('1','2')                            /* 통보구분 */
            </isEqual>
            <isNotEqual property="strOgnDvsnCd" compareValue="0">
                AND D1.OGN_DVSN_CD = #strOgnDvsnCd#                        /* 통보구분 */
            </isNotEqual>
                
            <!-- 관계기관 -->
            <isNotEmpty property="strOrgCd">	
                AND D1.ORG_CD = #strOrgCd#
            </isNotEmpty>
            
            <!-- 처리결과 -->
            <isNotNull property="strHndlOpinCdCnt">				
				<isEqual property="strHndlOpinCdCnt" compareValue="1">
                	AND D1.HNDL_OPIN_CD = #strHndlOpinCd1#
                </isEqual>
                <isEqual property="strHndlOpinCdCnt" compareValue="2">
                	AND D1.HNDL_OPIN_CD IN (#strHndlOpinCd1#, #strHndlOpinCd2#)
                </isEqual>
                <isEqual property="strHndlOpinCdCnt" compareValue="3">
                	AND D1.HNDL_OPIN_CD IN (#strHndlOpinCd1#, #strHndlOpinCd2#, #strHndlOpinCd3#)
                </isEqual>                
                <isEqual property="strHndlOpinCdCnt" compareValue="4">
                	AND D1.HNDL_OPIN_CD IN (#strHndlOpinCd1#, #strHndlOpinCd2#, #strHndlOpinCd3#, #strHndlOpinCd4#)
                </isEqual>           
                <isEqual property="strHndlOpinCdCnt" compareValue="5">
                	AND D1.HNDL_OPIN_CD IN (#strHndlOpinCd1#, #strHndlOpinCd2#, #strHndlOpinCd3#, #strHndlOpinCd4#, #strHndlOpinCd5#)
                </isEqual>                           
            </isNotNull>

    	<include refid="include.pageOrder" />
	</select>


	<!-- 통보사항 관계자 내역 -->
	<select id="BADGDA001EDtlselect" parameterClass="paramMap" resultClass="resultMap">
              SELECT 
                     ORG_CD                                                      /* 기관코드 */
                    ,F_ORG_INFO(ORG_CD,'1')      AS ORG_NM                       /* 기관명 */
                    ,NTF_DVSN_CD                                                 /* 통보구분코드 */
                    ,NNB                                                         /* 통보번호 */
                    ,SRNO                                                        /* 일련번호 */
                    ,DPT_CD                                                      /* 부서코드 */
                    ,YR                                                          /* 년도 */
                    ,EIN                                                         /* 주민등록번호 */
                    ,DFNT_NM                                                     /* 관계자명 */
                    ,REL_PEN_OCP_CD                                              /* 관련자직종코드 */
                    ,F_CODE_NM('1000057', REL_PEN_OCP_CD)   AS REL_PEN_OCP_NM    /* 관련자직종명 */
                    ,REL_PEN_RANK_CD                                             /* 관련자직급코드 */
                    ,F_CODE_NM('1000058', REL_PEN_RANK_CD)  AS REL_PEN_RANK_NM   /* 관련자직급명 */
                    ,DSP_AM                                                      /* 처분금액 */
                    ,DSP_DT                                                      /* 처분일 */
                    ,ENFM_TYP_CD                                                 /* 집행유형코드 */
                    ,F_CODE_NM('1000249', ENFM_TYP_CD)      AS ENFM_TYP_NM       /* 집행유형명 */                                       
                    ,REGI_DH                                                     /* 등록일시 */
                    ,REGN_ID                                                     /* 등록자ID */
                    ,CRIM_WRDO_TXT                                               /* 범행비위내용 */
                    ,RFR_MTRL_TXT                                                /* 참고자료내용 */
                    ,ATP_DPT_NM                                                  /* 행위시부서명 */
                    ,PRST_DPT_NM                                                 /* 현재부서명 */
                    ,HND_SBJ                                                     /* 조치사항 */
                    ,PSC_YN                                                      /* 고발여부 */
                    ,PST_NOO                                                     /* 직위직명 */
                    ,MNG_PRD_TXT                                                 /* 관리기간내용 */
                    ,ETC_MNG_CD                                                  /* 기타관리코드 */
                    ,MDF_DT                                                      /* 수정일 */
                    ,MDF_PEN_ID                                                  /* 수정자ID */
                    ,ATP_BLT_ORG_CD                                              /* 행위시소속기관코드 */
                    ,F_ORG_INFO(ATP_BLT_ORG_CD,'1')   AS ATP_BLT_ORG_NM          /* 행위시소속기관명 */
                    ,PRST_BLT_ORG_CD                                             /* 현재소속기관코드 */
                    ,F_ORG_INFO(PRST_BLT_ORG_CD,'1')  AS PRST_BLT_ORG_NM         /* 현재소속기관명 */  
                    ,RANK_NM                                                     /* 직급명 */            
                    ,PSC_LWS_STT_TXT                                             /* 고발소송상황내용 */
                    ,SLF_HNDL_HND_TXT                                            /* 자체처리조치내용 */
                    ,ACNT_NOO                                                    /* 회계직명 */
                    ,PSC_DH_HIS                                                  /* 고발일시내역 */
                    ,ATP_RANK_NM                                                 /* 행위시직급명 */
                    ,HND_RSLT_TXT                                                /* 조치결과내용 */
                    ,CON_YR                                                      /* 연계년도 */
                    ,CON_SRNO                                                    /* 연계일련번호 */
                    ,FRT_USR_ID                                                  /* 최초사용자ID */
                    ,FNL_USR_ID                                                  /* 최종사용자ID */
                    ,FNL_DEAL_DPT_CD                                             /* 최종거래부서코드 */
                    ,FNL_MNU_ID                                                  /* 최종메뉴ID */
                    ,FRT_REGI_DH                                                 /* 최초등록일시 */      
                    ,FNL_MDF_DH                                                  /* 최종수정일시 */
               FROM TBBADGDA001L                       /* 통보사항관계자내역 */                        
              WHERE ORG_CD        = #strOrgCd#         /* 기관코드 */
                AND NTF_DVSN_CD   = #strNtfDvsnCd#     /* 통보구분코드 */
                AND NNB           = #strNnb#           /* 통보번호 */
            <isNotEmpty property="strSrno">          
                AND SRNO          = #strSrno#          /* 일련번호 */
            </isNotEmpty>
            
            <!-- 
                AND DPT_CD        = #strDptCd#         /* 부서코드 */
                AND YR            = #strYr#            /* 년도 */
             -->
	</select>
	
	
	<!-- 범죄 및 징계통보 접수 -->
	<update id="BADGDA001EAcpupdate" parameterClass="paramMap">
           UPDATE TBBADGDA001M                                   /* 통보사항 기본 */ 
              SET ACP_STA_CD      = '71'                         /* 접수상태코드 (71:대상기관발송문서접수) */
                 ,DGE1_ORG_ACP_DT = #DGE1_ORG_ACP_DT#            /* 1차기관 접수일 */
                 ,ACP_DT          = TO_CHAR(SYSDATE,'YYYYMMDD')  /* 접수일자 */
                 ,RCEP_ID         = #FNL_USR_ID#                 /* 접수자ID */
                 ,BAI_BRDV_CD     = #BAI_BRDV_CD#                /* 감사원국과코드 */
                 ,CPLT_DT         = ''                           /* 완결일자 */
                 ,FNL_USR_ID      = #FNL_USR_ID#                 /* 최종사용자ID */   
                 ,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#            /* 최종거래부서코드 */
                 ,FNL_MNU_ID      = #FNL_MNU_ID#                 /* 최종메뉴ID */      
                 ,FNL_MDF_DH      = SYSDATE                      /* 최종수정일시 */                 
            WHERE ORG_CD          = #ORG_CD#                     /* 기관코드 */ 
              AND NTF_DVSN_CD     = #NTF_DVSN_CD#                /* 통보구분코드 */  
              
              <!-- 
              AND YR              = #YR#                         /* 년도 */
              AND DPT_CD          = #DPT_CD#                     /* 부서코드 */
               -->
                    
              AND NNB             = #NNB#                        /* 통보번호 */
	</update>
	
	<!-- 통보사항기본 delete -->
	<update id="BADGDA001EMaindelete" parameterClass="paramMap">
          DELETE 
            FROM TBBADGDA001M                    /* 통보사항기본 */
           WHERE ORG_CD       = #ORG_CD#         /* 기관코드 */
             AND NTF_DVSN_CD  = #NTF_DVSN_CD#    /* 통보구분코드 */
             
             <!-- 
             AND YR           = #YR#             /* 년도 */
             AND DPT_CD       = #DPT_CD#         /* 부서코드 */
              -->
              
             AND NNB          = #NNB#            /* 통보번호 */
	</update>
	
	
	<!-- 통보사항관계자내역 delete -->
	<update id="BADGDA001EDfntdelete" parameterClass="paramMap">
          DELETE 
            FROM TBBADGDA001L                    /* 통보사항관계자내역 */
           WHERE ORG_CD       = #ORG_CD#         /* 기관코드 */
             AND NTF_DVSN_CD  = #NTF_DVSN_CD#    /* 통보구분코드 */
             <!-- 
             AND YR           = #YR#             /* 년도 */
             AND DPT_CD       = #DPT_CD#         /* 부서코드 */
              -->
             AND NNB          = #NNB#            /* 통보번호 */
	</update>
	
    <!-- 통보사항기본삭제이력 insert-->
	<insert id="BADGDA001EDelHstinsert" parameterClass="paramMap">
         INSERT INTO TBBADGDA005H   /* 통보사항기본삭제이력 */
         ( 
               CON_NO                  /* 연계번호 */        
             , NTF_DVSN_CD             /* 통보구분코드 */
             , ORG_CD                  /* 기관코드 */     
             , YR                      /* 년도 */
             , NNB                     /* 통보번호 */
             , USE_YN                  /* 사용여부 */
             , CON_RET_KY_NM           /* 연계반려키명 - 2016.06.24 yyh */
             , RET_RSN_TXT             /* 반려사유내용 - 2016.12.13 yyh */
             , FRT_USR_ID              /* 최초사용자ID */    
             , FNL_USR_ID              /* 최종사용자ID */    
             , FNL_DEAL_DPT_CD         /* 최종거래부서코드 */
             , FNL_MNU_ID              /* 최종메뉴ID */      
             , FRT_REGI_DH             /* 최초등록일시 */    
             , FNL_MDF_DH              /* 최종수정일시 */    
         ) VALUES (
               (SELECT NVL(MAX(CON_NO),0) + 1
                  FROM TBBADGDA005H)   /* 연계번호 */
             , #NTF_DVSN_CD#           /* 통보구분코드 */        
             , #ORG_CD#                /* 기관코드 */    
             , #YR#                    /* 년도 */        
             , #NNB#                   /* 통보번호 */
             , #USE_YN#                /* 사용여부 */
             , #CON_RET_KY_NM#         /* 연계반려키명 */
             , #RET_RSN_TXT#           /* 반려사유내용 */
             , #FRT_USR_ID#            /* 최초사용자ID */    
             , #FNL_USR_ID#            /* 최종사용자ID */    
             , #FNL_DEAL_DPT_CD#       /* 최종거래부서코드 */
             , #FNL_MNU_ID#            /* 최종메뉴ID */      
             , SYSDATE                 /* 최초등록일시 */    
             , SYSDATE                 /* 최종수정일시 */    
         )
	</insert>
	
	
	<!-- 목록출력 리스트 조회-->
	<select id="BADGDA001EReportListselect" parameterClass="paramMap" resultClass="resultMap">
    
              SELECT 
              	    <!-- 조회조건 -->
              	     DECODE(#strHndlStaDvsnCd#, 0, '전체', F_CODE_NM ('1000587', #strHndlStaDvsnCd#)) 
              	                                                              AS CND_HNDL_DVSN_NM  /* 처리구분 */
              		,F_DPT_INFO(#strDptCd#,'1')                               AS CND_HNDL_DPT_NM   /* 처리국과 */
              		
		            <isNotNull property="strHndlOpinCdCnt">				
						<isEqual property="strHndlOpinCdCnt" compareValue="1">
		                	,F_CODE_NM('1000200', #strHndlOpinCd1#)           AS CND_HNDL_OPIN_NM  /* 처리결과 */ 
		                </isEqual>
		                <isEqual property="strHndlOpinCdCnt" compareValue="2">
		                	,F_CODE_NM('1000200', #strHndlOpinCd1#) || ', ' || 
		                	 F_CODE_NM('1000200', #strHndlOpinCd2#)           AS CND_HNDL_OPIN_NM  /* 처리결과 */ 
		                </isEqual>
		                <isEqual property="strHndlOpinCdCnt" compareValue="3">
		                	,F_CODE_NM('1000200', #strHndlOpinCd1#) || ', ' || 
		                	 F_CODE_NM('1000200', #strHndlOpinCd2#) || ', ' || 
		                	 F_CODE_NM('1000200', #strHndlOpinCd3#)           AS CND_HNDL_OPIN_NM  /* 처리결과 */ 
		                </isEqual>                
		                <isEqual property="strHndlOpinCdCnt" compareValue="4">
		                	,F_CODE_NM('1000200', #strHndlOpinCd1#) || ', ' || 
		                	 F_CODE_NM('1000200', #strHndlOpinCd2#) || ', ' || 
		                	 F_CODE_NM('1000200', #strHndlOpinCd3#) || ', ' || 
		                	 F_CODE_NM('1000200', #strHndlOpinCd4#)           AS CND_HNDL_OPIN_NM  /* 처리결과 */ 
		                </isEqual>
		                <isEqual property="strHndlOpinCdCnt" compareValue="5">
		                	,F_CODE_NM('1000200', #strHndlOpinCd1#) || ', ' || 
		                	 F_CODE_NM('1000200', #strHndlOpinCd2#) || ', ' || 
		                	 F_CODE_NM('1000200', #strHndlOpinCd3#) || ', ' ||
		                	 F_CODE_NM('1000200', #strHndlOpinCd4#) || ', ' || 
		                	 F_CODE_NM('1000200', #strHndlOpinCd5#)           AS CND_HNDL_OPIN_NM  /* 처리결과 */ 
		                </isEqual>		                                   
		            </isNotNull>
		            <isNull property="strHndlOpinCdCnt">
		                ,''                                                   AS CND_HNDL_OPIN_NM  /* 처리결과 */ 	
		            </isNull>              	                                                              
              	                                                               
              		,''                                                       AS CND_REGI_DT       /* 송부일자 */
              		,#strDfntNm#                                              AS CND_DFNT_NM       /* 관계자명 */
              		,#strSchTxt#                                              AS CND_SCH_TXT       /* 검색어 */
              		,TO_CHAR(TO_DATE(#strAcpDtStr#), 'YYYY.MM.DD') || '~' || 
              		 TO_CHAR(TO_DATE(#strAcpDtEnd#), 'YYYY.MM.DD')            AS CND_ACP_DT        /* 접수일자 */
              		,F_ORG_INFO(#strOrgCd#,'1')                               AS CND_ORG_NM        /* 관계기관 */
              		
             		<!-- 목록 -->
                    ,TO_CHAR(TO_DATE(D1.REGI_DT), 'YYYY.MM.DD')               AS REGI_DT           /* 송부일자(등록일) */ 
                    ,F_ORG_INFO(D1.ORG_CD,'1')  
                     || '-' || 
                     F_CODE_NM('1000202', D1.OGN_DVSN_CD)                     
                     || '-' ||  
                     D1.NNB                                                   AS NTF_SBJ_NO    /* 통보사항번호 */              
                    ,D1.TIT_NM                                                AS TIT_NM        /* 제목명 */    
                    ,D1.WRDO_NM                                               AS WRDO_NM       /* 비위코드명 */                    
                    ,D2.DFNT_NMS                                              AS DFNT_NMS      /* 관계자명 */                                   
                    ,TO_CHAR(TO_DATE(D1.ACP_DT), 'YYYY.MM.DD')                AS ACP_DT        /* 접수일 */    
                    ,CASE WHEN D1.ACP_STA_CD IN ('58','59')      THEN '미접수'
                          WHEN D1.ACP_STA_CD IN ('71','72','76') THEN '처리중' 
                          WHEN D1.ACP_STA_CD = '75'              THEN '결재중' 
                          WHEN D1.ACP_STA_CD = '77'              THEN '완결'
                          ELSE D1.ACP_STA_CD 
                      END                                                     AS ACP_STA_NM    /* 접수상태코드 */                  
                    ,TO_CHAR(TO_DATE(D1.CPLT_DT), 'YYYY.MM.DD')               AS CPLT_DT       /* 완결일 */    
               FROM TBBADGDA001M  D1     /* 통보기본사항 */
               
                <!-- 검색어 존재 -->
                <isNotEmpty property="strSchTxt">                
                    <!-- 전체 조회 -->
                    <isEqual property="strSchDvsn" compareValue="0">
                    ,( SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              <!--  
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T2.SRNO) = 1 THEN MAX(T2.DFNT_NM)
                                    WHEN COUNT(T2.SRNO) > 1 THEN MAX(T2.DFNT_NM) || '외 ' || ( COUNT(T2.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001M T1     /* 통보사항 기본 */
                             ,TBBADGDA001L T2     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.ORG_CD      = T2.ORG_CD(+)
                          AND T1.NTF_DVSN_CD = T2.NTF_DVSN_CD(+)
                          
                          <!-- 
                          AND T1.YR          = T2.YR(+)
                          AND T1.DPT_CD      = T2.DPT_CD(+)
                           -->
                          
                          AND T1.NNB         = T2.NNB(+)
                          AND T1.TIT_NM LIKE '%' || #strSchTxt# || '%'
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!-- GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB -->
                     
                     UNION
                     
                       SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              <!-- 
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T1.SRNO) = 1 THEN MAX(T1.DFNT_NM)
                                    WHEN COUNT(T1.SRNO) > 1 THEN MAX(T1.DFNT_NM) || '외 ' || ( COUNT(T1.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001L T1     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.CRIM_WRDO_TXT LIKE '%' || #strSchTxt# || '%'
                          
                      <!-- 관계자명 -->
                      <isNotEmpty property="strDfntNm">
                          AND T1.DFNT_NM LIKE '%' || #strDfntNm# || '%'
                      </isNotEmpty>
                                                
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!--  GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB  -->
                    ) D2
                    </isEqual>
                    
                    <!-- 제목 조회 -->
                    <isEqual property="strSchDvsn" compareValue="1">
                     ,(SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              
                              <!-- 
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                               
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T2.SRNO) = 1 THEN MAX(T2.DFNT_NM)
                                    WHEN COUNT(T2.SRNO) > 1 THEN MAX(T2.DFNT_NM) || '외 ' || ( COUNT(T2.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001M T1     /* 통보사항 기본 */
                             ,TBBADGDA001L T2     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.ORG_CD      = T2.ORG_CD(+)
                          AND T1.NTF_DVSN_CD = T2.NTF_DVSN_CD(+)
                          
                          <!-- 
                          AND T1.YR          = T2.YR(+)
                          AND T1.DPT_CD      = T2.DPT_CD(+)
                           -->
                          
                          AND T1.NNB         = T2.NNB(+)
                          AND T1.TIT_NM LIKE '%' || #strSchTxt# || '%'
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!-- GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB -->
                    ) D2                    
                    </isEqual>
                    
                    <!-- 내용 조회 -->
                    <isEqual property="strSchDvsn" compareValue="2">
                     ,(SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              <!-- 
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T1.SRNO) = 1 THEN MAX(T1.DFNT_NM)
                                    WHEN COUNT(T1.SRNO) > 1 THEN MAX(T1.DFNT_NM) || '외 ' || ( COUNT(T1.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001L T1     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.CRIM_WRDO_TXT LIKE '%' || #strSchTxt# || '%'
                          
                      <!-- 관계자명 -->
                      <isNotEmpty property="strDfntNm">
                          AND T1.DFNT_NM LIKE '%' || #strDfntNm# || '%'
                      </isNotEmpty>
                                                
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!-- GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB -->
                    ) D2                    
                    </isEqual>                    
                </isNotEmpty>

                <!-- 검색어 미존재 -->
                <isEmpty property="strSchTxt">
                     ,(SELECT  T1.ORG_CD         AS ORG_CD        /* 기관코드 */
                              ,T1.NTF_DVSN_CD    AS NTF_DVSN_CD   /* 통보구분코드 */
                              <!-- 
                              ,T1.YR             AS YR            /* 년도 */
                              ,T1.DPT_CD         AS DPT_CD        /* 부서코드 */
                               -->
                              ,T1.NNB            AS NNB           /* 통보번호 */
                              ,CASE WHEN COUNT(T2.SRNO) = 1 THEN MAX(T2.DFNT_NM)
                                    WHEN COUNT(T2.SRNO) > 1 THEN MAX(T2.DFNT_NM) || '외 ' || ( COUNT(T2.SRNO) - 1 ) || '명'
                                    ELSE ''
                                END              AS DFNT_NMS       /* 관계자명 */
                         FROM TBBADGDA001M T1     /* 통보사항 기본 */
                             ,TBBADGDA001L T2     /* 통보사항 관계자 내역 */
                        WHERE 1=1
                          AND T1.ORG_CD      = T2.ORG_CD(+)
                          AND T1.NTF_DVSN_CD = T2.NTF_DVSN_CD(+)
                          
                          <!-- 
                          AND T1.YR          = T2.YR(+)
                          AND T1.DPT_CD      = T2.DPT_CD(+)
                           -->
                          
                          AND T1.NNB         = T2.NNB(+)
                      <!-- 관게자 존재 -->
                      <isNotEmpty property="strDfntNm">                        
                          AND T2.DFNT_NM LIKE '%' || #strDfntNm# || '%'
                      </isNotEmpty>
                     GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.NNB
                     <!-- GROUP BY T1.ORG_CD, T1.NTF_DVSN_CD, T1.YR, T1.DPT_CD, T1.NNB -->
                    ) D2
                </isEmpty>

              WHERE 1=1        
                AND D1.ORG_CD      = D2.ORG_CD
                AND D1.NTF_DVSN_CD = D2.NTF_DVSN_CD
                
                <!-- 
                AND D1.YR          = D2.YR
                AND D1.DPT_CD      = D2.DPT_CD
                 -->
                 
                AND D1.NNB         = D2.NNB
                AND D1.NTF_DVSN_CD = '1' /* 통보구분코드 (1:범죄및징계, 2:망실및훼손) */
                AND D1.ACP_STA_CD  != '51'
                
                AND D1.DPT_CD      IN (SELECT DPT_CD FROM TABLE(F_AUTH_DEPT(#strCnb#, #strDptAuth#, '', #strDptCd#)))
                
			<isNotEmpty property="strDptCd2">
                AND D1.DPT_CD      = #strDptCd2#
            </isNotEmpty>                 
                
			<!-- 접수일자 -->
			<isNotEmpty property="strAcpDtStr">	
				AND D1.ACP_DT  BETWEEN #strAcpDtStr#  AND #strAcpDtEnd#    /* 접수일자 */
			</isNotEmpty>
			               
            <!-- 처리구분코드 --> 
            <isNotEqual property="strHndlStaDvsnCd" compareValue="0">
                <!-- 미결-->
                <isEqual property="strHndlStaDvsnCd" compareValue="1">
                    AND D1.ACP_STA_CD IN ('58', '59', '71', '72', '75', '76')  
                </isEqual>
                <!-- 처리중 -->
                <isEqual property="strHndlStaDvsnCd" compareValue="3">
                    AND D1.ACP_STA_CD IN ('71', '72', '76') 
                </isEqual>
                <!-- 결재중 -->
                <isEqual property="strHndlStaDvsnCd" compareValue="4">
                    AND D1.ACP_STA_CD = '75'   
                </isEqual>
                <!-- 완결 -->
                <isEqual property="strHndlStaDvsnCd" compareValue="5">
                    AND D1.ACP_STA_CD = '77' 
                </isEqual>
            </isNotEqual>                

            <!-- 통보구분(통보발생구분코드) 분기 -->
            <isEqual property="strOgnDvsnCd" compareValue="0">
                AND D1.OGN_DVSN_CD IN ('1','2')                            /* 통보구분 */
            </isEqual>
            <isNotEqual property="strOgnDvsnCd" compareValue="0">
                AND D1.OGN_DVSN_CD = #strOgnDvsnCd#                        /* 통보구분 */
            </isNotEqual>
                
            <!-- 관계기관 -->
            <isNotEmpty property="strOrgCd">	
                AND D1.ORG_CD = #strOrgCd#
            </isNotEmpty>
            
            <!-- 처리결과 -->
            <isNotNull property="strHndlOpinCdCnt">				
				<isEqual property="strHndlOpinCdCnt" compareValue="1">
                	AND D1.HNDL_OPIN_CD = #strHndlOpinCd1#
                </isEqual>
                <isEqual property="strHndlOpinCdCnt" compareValue="2">
                	AND D1.HNDL_OPIN_CD IN (#strHndlOpinCd1#, #strHndlOpinCd2#)
                </isEqual>
                <isEqual property="strHndlOpinCdCnt" compareValue="3">
                	AND D1.HNDL_OPIN_CD IN (#strHndlOpinCd1#, #strHndlOpinCd2#, #strHndlOpinCd3#)
                </isEqual>                
                <isEqual property="strHndlOpinCdCnt" compareValue="4">
                	AND D1.HNDL_OPIN_CD IN (#strHndlOpinCd1#, #strHndlOpinCd2#, #strHndlOpinCd3#, #strHndlOpinCd4#)
                </isEqual>
                <isEqual property="strHndlOpinCdCnt" compareValue="5">
                	AND D1.HNDL_OPIN_CD IN (#strHndlOpinCd1#, #strHndlOpinCd2#, #strHndlOpinCd3#, #strHndlOpinCd4#, #strHndlOpinCd5#)
                </isEqual>                                                      
            </isNotNull>
            
            ORDER BY D1.ACP_DT DESC 
                    ,D1.ORG_CD 
                    ,D1.NTF_DVSN_CD   
                    ,D1.NNB  DESC                   
	</select>
	
			
</sqlMap> 
