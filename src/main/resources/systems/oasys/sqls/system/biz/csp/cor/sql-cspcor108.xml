<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/cor/108">
 	
 	<select id="CSPCOR108PMainSelect" parameterClass="paramMap" resultClass="resultMap">
 		<![CDATA[
 			SELECT T1.CORR_DVSN_CD
 			      ,T1.ACP_YR
 			      ,T1.CORR_ACP_NO
 			      ,T1.MSG_SEQ
 			      ,CASE WHEN T2.CUR_STATE = '0' THEN '전송요구'
 			        WHEN T2.CUR_STATE IN ('1','2') THEN '전송중'
 			        WHEN T2.CUR_STATE = '3' THEN '전송완료'
 			        ELSE NULL
 			       END AS CUR_STATE
 			      ,TO_CHAR(T2.RSLT_DATE,'YYYY-MM-DD HH24:MI') RSLT_DATE
 			      ,TO_CHAR(T2.REQ_DATE,'YYYY-MM-DD HH24:MI') REQ_DATE
 			      ,CASE WHEN T2.RSLT_CODE IS NULL THEN '전송중'
 			         WHEN T2.RSLT_CODE = '100' THEN '전송성공' ELSE '전송실패' END AS RSLT_CODE
 			      ,T2.RSLT_CODE2
 			      ,T2.CALL_TO
 			      ,T2.CALL_FROM
 			      ,T3.MMS_BODY
 			  FROM TBCSPCOR106H T1
 			      ,MSG_DATA T2
 			      ,MMS_CONTENTS_INFO T3
 			 WHERE T1.MSG_SEQ = T2.MSG_SEQ
 			   AND T2.CONT_SEQ = T3.CONT_SEQ
 			   AND T1.CORR_DVSN_CD = #strCORR_DVSN_CD#
 			   AND T1.ACP_YR = #strACP_YR#
 			   AND T1.CORR_ACP_NO = #strCORR_ACP_NO#
 			ORDER BY T1.MSG_SEQ DESC
 		]]>
 	</select>
 	
 	<select id="CSPCOR108PSelectFromTnb" parameterClass="paramMap" resultClass="String">
 		<![CDATA[
 			SELECT REPLACE(TNB,'-','') AS TNB
 			  FROM TBDCMACM002M
 			 WHERE DPT_CD = #strDPT_CD#
 		]]>
 	</select>
 	
 	<select id="CSPCOR108PSelectMsgSeq" parameterClass="paramMap" resultClass="Integer">
 		<![CDATA[
 			SELECT MSG_DATA_SEQ.NEXTVAL FROM DUAL
 		]]>
 	</select>
 	
 	<select id="CSPCOR108PSelectContSeq" parameterClass="paramMap" resultClass="Integer">
 		<![CDATA[
 			SELECT MMS_CONTENTS_INFO_SEQ.NEXTVAL FROM DUAL
 		]]>
 	</select>
 	
 	<insert id="CSPCOR108PMMS_CONTENTS_INFOInsert" parameterClass="paramMap" >
 		<![CDATA[
 			INSERT INTO MMS_CONTENTS_INFO 
				 	(	CONT_SEQ
				 		, FILE_CNT
				 		, MMS_BODY
				 		, MMS_SUBJECT
				 	) 
			VALUES (	#CONT_SEQ#
						, 0
						, #MMS_BODY#
						, '감사원 부패행위 신고 문자통보'
					)
 		]]>
 	</insert>
 	
 	
 	<insert id="CSPCOR108PMSG_DATAInsert" parameterClass="paramMap">
 		<![CDATA[
 			INSERT INTO MSG_DATA
				 	(	MSG_SEQ
				 		, CUR_STATE
				 		, REQ_DATE
				 		, CALL_TO
				 		, CALL_FROM
				 		, SMS_TXT
				 		, MSG_TYPE
				 		, CONT_SEQ
				 	) 
			VALUES (	#MSG_SEQ#
						, 0
						, SYSDATE
						, REPLACE(#CALL_TO#,'-','')
						, NVL(NVL(REPLACE(#CALL_FROM#,'-',''),(SELECT	S1.TNB
										   						FROM 	TBDCMACM002M S1
										   						WHERE 	S1.DPT_CD = #FNL_DEAL_DPT_CD#
										   						)),'0220112191')
						, ''
						, 6
						, #CONT_SEQ#
					)
 		]]>
 	</insert>
 	
 	<insert id="CSPCOR108PTBCSPCOR106HInsert" parameterClass="paramMap">
 		<![CDATA[
 			INSERT INTO TBCSPCOR106H
 					( CORR_DVSN_CD
 					 ,ACP_YR
 					 ,CORR_ACP_NO
 					 ,MSG_SEQ
 					 ,FRT_USR_ID
					 ,FNL_USR_ID
					 ,FNL_DEAL_DPT_CD
					 ,FNL_MNU_ID
					 ,FRT_REGI_DH
					 ,FNL_MDF_DH
					)
				VALUES ( #CORR_DVSN_CD#
				        ,#ACP_YR#
				        ,#CORR_ACP_NO#
				        ,#MSG_SEQ#
				        ,#FNL_USR_ID#
				        ,#FNL_USR_ID#
				        ,#FNL_DEAL_DPT_CD#
				        ,#FNL_MNU_ID#
				        ,SYSDATE
				        ,SYSDATE
				       )
				       
  		]]>
 	</insert>

</sqlMap> 
