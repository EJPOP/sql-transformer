<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="csp/qbo/141">
 
 
 	<select id="CSPQBO141EMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT 	 A.BOO_DVSN
					,A.BOO_KND_CD
					,A.BOO_NO
					,A.BOO_NO||'-'||A.BOO_VLE_NO AS BOO_NOS
					,A.BOO_VLE_NO
					,A.CAT_SYM_NM
					,A.BOO_TIT_NM
					,A.PBC_PLAC_NM
					,A.ATR_NM
					,A.BOO_LEND_DT
					,A.COPT_CAT_CD
					,A.BOO_LEND_POSS_YN
					,A.LAG_INV_CNB
					,A.BOO_DVSN_CD
					,A.BOO_BOKG_SLN
					,A.BAR_CD
			FROM 	(
						SELECT	 F_CODE_NM('1000325',B.BOO_REN_YN_CD) AS BOO_DVSN		/*도서종류코드*/
								,A.BOO_KND_CD
								,A.BOO_NO
								,A.BOO_VLE_NO
								,A.CAT_SYM_NM
								,A.BOO_TIT_NM
								,A.PBC_PLAC_NM
								,A.ATR_NM
								,B.BOO_LEND_DT
								,A.COPT_CAT_CD
								,'0' BOO_LEND_POSS_YN
								,B.LAG_INV_CNB
								,B.BOO_REN_YN_CD AS BOO_DVSN_CD
								,'' AS BOO_BOKG_SLN
								,A.BAR_CD
						FROM	TBCSPQBO001M A,	TBCSPQBO002H B
						WHERE	1=1
						AND		A.COPT_CAT_CD = B.COPT_CAT_CD
						AND		A.BOO_KND_CD = B.BOO_KND_CD
						AND		A.BOO_NO = B.BOO_NO
						AND		A.CAT_SYM_NM = B.CAT_SYM_NM
						AND		A.BOO_VLE_NO = B.BOO_VLE_NO
						AND		A.COPT_CAT_CD = #strCOPT_CAT_CD#
						AND		B.BOO_REN_YN_CD = '0'
						AND		B.LAG_INV_CNB = #strLAG_INV_CNB#
						UNION ALL
						SELECT	 F_CODE_NM('1000326',B.LEND_BOKG_STA_CD) AS BOO_DVSN		/*도서종류코드*/
								,A.BOO_KND_CD
								,A.BOO_NO
								,A.BOO_VLE_NO
								,A.CAT_SYM_NM
								,A.BOO_TIT_NM
								,A.PBC_PLAC_NM
								,A.ATR_NM
								,'' AS BOO_LEND_DT
								,A.COPT_CAT_CD
								,CASE WHEN ( A.BOO_LEND_DVSN_CD = '1' OR A.BOO_LEND_DVSN_CD IS NULL ) AND B.BOO_BOKG_NO = '1' THEN '1' ELSE '0' END BOO_LEND_POSS_YN
								,B.LEND_BOKG_PEN_CNB AS LAG_INV_CNB
								,B.LEND_BOKG_STA_CD AS BOO_DVSN_CD
								,B.BOO_BOKG_SLN
								,A.BAR_CD
						FROM	TBCSPQBO001M A,	
								(SELECT 	A.COPT_CAT_CD, 
											A.BOO_KND_CD, 
											A.BOO_NO, 
											A.CAT_SYM_NM, 
											A.BOO_VLE_NO,
											A.LEND_BOKG_PEN_CNB, 
											A.LEND_BOKG_STA_CD,
											A.BOO_BOKG_SLN,
											RANK() OVER (PARTITION BY A.COPT_CAT_CD, A.BOO_KND_CD, 
														A.BOO_NO, A.CAT_SYM_NM, A.BOO_VLE_NO ORDER BY 
														A.BOO_BOKG_SLN ASC) AS BOO_BOKG_NO 
									FROM 	TBCSPQBO003H A 
									WHERE 	A.LEND_BOKG_STA_CD = 'Y'
								) B
						WHERE	1=1
						AND		A.COPT_CAT_CD = B.COPT_CAT_CD
						AND		A.BOO_KND_CD = B.BOO_KND_CD
						AND		A.BOO_NO = B.BOO_NO
						AND		A.CAT_SYM_NM = B.CAT_SYM_NM
						AND		A.BOO_VLE_NO = B.BOO_VLE_NO
						AND		A.COPT_CAT_CD = #strCOPT_CAT_CD#
						AND		B.LEND_BOKG_STA_CD = 'Y'
						AND		B.LEND_BOKG_PEN_CNB = #strLAG_INV_CNB#
					) A
			ORDER BY A.BOO_LEND_DT DESC
		]]>
	</select>
		
 	<select id="CSPQBO142PMainSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	A.COPT_CAT_CD,			/*소관분류코드*/
					A.BOO_KND_CD,
					F_CODE_NM('1000149',A.BOO_KND_CD) AS BOO_KND_NM,		/*도서종류코드*/
					A.BOO_NO,			/*도서번호*/
					A.BOO_NO||'-'||A.BOO_VLE_NO AS BOO_NOS,
					A.BOO_VLE_NO,
					SUBSTR(A.CAT_SYM_NM,1,1) CAT_SYM_NM1,
					SUBSTR(A.CAT_SYM_NM,2,3) CAT_SYM_NM2,
					SUBSTR(A.CAT_SYM_NM,5,3) CAT_SYM_NM3,
					A.CAT_SYM_NM,
					A.BOO_ACP_DT,
					A.BAR_CD,
					A.DRVT_SYM_NM,
					A.BOO_SYM_NM,
					A.BOO_TIT_NM,
					A.PBC_PLAC_NM,
					A.PBC_RGN_NM,
					A.PBC_DT,
					A.PBC_YR,
					A.ATR_NM,
					A.PON,
					A.SZ_VAL,
					A.KYWD_NM,
					A.BOO_RMK,
					A.ORI_NM,
					A.STN_PEN_NM,
					A.BOO_PBC_BR_CD,
					A.LIB_SBJ,
					A.CLC_WAY_CD,
					A.BOO_PUR_PR,
					A.INTNA_STND_BOO_NO,
					A.DEG_NM,
					A.MTRL_MNG_YR,
					A.MTRL_MNG_DVSN_NO,
					A.MTRL_MNG_NO,
					A.ACP_YR,
					A.PBLC_KND_CD,
					A.INTNA_STND_PBLC_SRNO,
					A.SSCR_PRD_STR_DT,
					A.SSCR_PRD_END_DT,
					A.YRLY_SSCR_FEE,
					A.SSCR_COT,
					A.AVDOC_SHP_CD,
					A.BOO_MAIN_TXT,
					A.BOO_RPRT_NO,
					A.ASTR_TXT,
					NVL(A.BOO_LEND_DVSN_CD,1) AS BOO_LEND_DVSN_CD,  /*대출여부 0: 예(대출중) 1:아니오(미대출)*/
					(CASE WHEN BOO_LEND_DVSN_CD = '0' THEN '0'
					WHEN (BOO_LEND_DVSN_CD = '1' OR BOO_LEND_DVSN_CD IS NULL ) AND B.BOO_BOKG_NO = 1 THEN '1'
					WHEN (BOO_LEND_DVSN_CD = '1' OR BOO_LEND_DVSN_CD IS NULL ) AND B.BOO_BOKG_NO > 1 THEN '0'
					WHEN B.BOO_BOKG_NO IS NULL AND (SELECT COUNT(*) 
													FROM TBCSPQBO003H C
													WHERE  	A.COPT_CAT_CD = C.COPT_CAT_CD
													AND	   	A.BOO_KND_CD = C.BOO_KND_CD
													AND  	A.BOO_NO = C.BOO_NO  
													AND  	A.CAT_SYM_NM = C.CAT_SYM_NM
													AND		A.BOO_VLE_NO = C.BOO_VLE_NO
													AND  	C.LEND_BOKG_STA_CD = 'Y' ) = 0 THEN '1' ELSE '0' END 
					)	BOO_LEND_POSS_YN,	   /*대출가능여부 1 : 예(대출가능)  0: 아니오(대출불가능)*/			
					C.BOO_REN_APT_DT 	/*반납예정일자*/
					,C.BOO_LEND_SLN
					,DECODE((SELECT COUNT(*)
							FROM 	TBCSPQBO003H H 
							WHERE 	A.COPT_CAT_CD = H.COPT_CAT_CD
							AND		A.BOO_KND_CD = H.BOO_KND_CD
							AND		A.BOO_NO = H.BOO_NO
							AND		A.CAT_SYM_NM = H.CAT_SYM_NM
							AND		A.BOO_VLE_NO = H.BOO_VLE_NO
							AND		H.LEND_BOKG_STA_CD = 'Y'),0,'N','Y'
						) AS BOO_BOKG_YN	/*대출예약여부  Y 예약, N 미예약*/
					,F_USR_INFO(C.LAG_INV_CNB, '2') AS LAG_INV_NAM	
					,C.LAG_INV_CNB
					,F_DPT_INFO(F_USR_INFO(C.LAG_INV_CNB, '5'), '1') AS LAG_INV_DPT_NM	/*대출부서*/
					,F_USR_INFO(C.LAG_INV_CNB, '5') AS LAG_INV_DPT_CD	/*대출부서코드*/
			FROM	TBCSPQBO001M A,
					(SELECT 	A.COPT_CAT_CD, 
								A.BOO_KND_CD, 
								A.BOO_NO, 
								A.CAT_SYM_NM, 
								A.BOO_VLE_NO,
								A.LEND_BOKG_PEN_CNB, 
								A.LEND_BOKG_STA_CD,
								RANK() OVER (PARTITION BY A.COPT_CAT_CD, A.BOO_KND_CD, 
											A.BOO_NO, A.CAT_SYM_NM, A.BOO_VLE_NO ORDER BY 
											A.BOO_BOKG_SLN ASC) AS BOO_BOKG_NO 
						FROM 	TBCSPQBO003H A 
						WHERE 	A.LEND_BOKG_STA_CD = 'Y'
					) B, TBCSPQBO002H C
			WHERE	1=1	
			AND		A.COPT_CAT_CD = B.COPT_CAT_CD(+)
			AND		A.BOO_KND_CD = B.BOO_KND_CD(+)
			AND		A.BOO_NO = B.BOO_NO(+)
			AND		A.CAT_SYM_NM = B.CAT_SYM_NM(+)
			AND		A.BOO_VLE_NO = B.BOO_VLE_NO(+)
			AND 	A.COPT_CAT_CD = C.COPT_CAT_CD (+)
		    AND 	A.BOO_KND_CD = C.BOO_KND_CD (+)
		    AND 	A.BOO_NO = C.BOO_NO (+)
		    AND 	A.CAT_SYM_NM = C.CAT_SYM_NM (+)
		    AND 	A.BOO_VLE_NO = C.BOO_VLE_NO (+)
		    AND 	C.BOO_REN_YN_CD(+) = '0'
		    AND		B.LEND_BOKG_PEN_CNB(+) = #strUsrCnb#
		    AND		A.COPT_CAT_CD = #strCoptCatCd#  
		]]>
		<dynamic>
			<isNotEmpty property="strBooKndCd"> 
			  	AND A.BOO_KND_CD IN 
			  		(SELECT 	SUBSTR(CODE,INSTR(CODE,',',1,LEVEL)+1,INSTR(CODE,',',1,LEVEL+1)-INSTR(CODE,',',1,LEVEL) -1) merge_col
                     FROM 	DUAL A
                     CROSS JOIN(SELECT ','|| #strBooKndCd# ||',' AS CODE FROM DUAL) B
                     CONNECT BY LEVEL&lt;=LENGTH(CODE)-LENGTH(REPLACE(CODE,','))-1 )				
			</isNotEmpty>
			<isNotEmpty property="strBooNo">
				AND A.BOO_NO = #strBooNo#
			</isNotEmpty>
			<isNotEmpty property="strCatSymNm">
				AND A.CAT_SYM_NM = #strCatSymNm#
			</isNotEmpty>
			<isNotEmpty property="strBarCd">
				AND A.BAR_CD = #strBarCd#
			</isNotEmpty>
			<isNotEmpty property="strBooTitNm">
				AND A.BOO_TIT_NM LIKE '%'||#strBooTitNm#||'%'
			</isNotEmpty>
			<isNotEmpty property="strPbcPlacNm">
				AND A.PBC_PLAC_NM LIKE '%'||#strPbcPlacNm#||'%'
			</isNotEmpty>
			<isNotEmpty property="strAtrNm">
				AND A.ATR_NM LIKE '%'||#strAtrNm#||'%'
			</isNotEmpty>
			<isNotEmpty property="strKywdNm">
				AND A.KYWD_NM LIKE '%'||#strKywdNm#||'%'
			</isNotEmpty>
		</dynamic>
	</select>
	<insert id="CSPQBO141EMainInsert" parameterClass="paramMap">
        <![CDATA[
        	INSERT INTO TBCSPQBO002H
        	(
        			COPT_CAT_CD,			/*소관분류코드*/
        			BOO_KND_CD,				/*도서종류코드*/
        			BOO_NO,					/*도서번호*/
        			CAT_SYM_NM,				/*분류기호명*/
        			BOO_VLE_NO,				/*도서권번호*/
        			BOO_LEND_SLN,			/*도서대출연번*/
        			LAG_INV_CNB,			/*초록내용*/
        			BOO_LEND_DT,
        			BOO_REN_YN_CD,
        			BOO_REN_APT_DT,
        			BOO_REN_DT,
        			AGT_CNB,
        			FRT_USR_ID,				/*최초사용자ID*/
        			FNL_USR_ID,				/*최초사용자ID*/
        			FNL_DEAL_DPT_CD,		/*최종거래부서코드*/
        			FNL_MNU_ID,				/*최종메뉴ID*/
        			FRT_REGI_DH,			/*최초등록일시*/
        			FNL_MDF_DH				/*최종수정일시*/
        	) VALUES (
	        		#COPT_CAT_CD#,
	        		#BOO_KND_CD#,
	        		#BOO_NO#,
	        		#CAT_SYM_NM#,
	        		#BOO_VLE_NO#,
	        		( SELECT	NVL(MAX(TO_NUMBER(BOO_LEND_SLN))+1,1)
		        		FROM 	TBCSPQBO002H 
		        		WHERE 	COPT_CAT_CD = #COPT_CAT_CD#
		        		AND		BOO_KND_CD = #BOO_KND_CD#
		        		AND		BOO_NO = #BOO_NO#
		        		AND		CAT_SYM_NM = #CAT_SYM_NM#),
	        		#LAG_INV_CNB#,
	        		TO_CHAR(SYSDATE,'YYYYMMDD'),
	        		'0',
	        		F_GET_WORK_DT(TO_CHAR(SYSDATE+14,'YYYYMMDD')),
	        		'',
	        		#AGT_CNB#,
	        		#FRT_USR_ID#,
	        		#FNL_USR_ID#,
	        		#FNL_DEAL_DPT_CD#,
	        		#FNL_MNU_ID#,
	        		SYSDATE,
	        		SYSDATE
        	)
        ]]>
	</insert>
	
	<update id="CSPQBO141EBooLendDvsnCdUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	TBCSPQBO001M
			SET		 BOO_LEND_DVSN_CD = '0'
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
					,FNL_MDF_DH = SYSDATE
			WHERE	COPT_CAT_CD = #COPT_CAT_CD#
			AND		BOO_KND_CD = #BOO_KND_CD#
			AND		BOO_NO = #BOO_NO#
			AND		CAT_SYM_NM = #CAT_SYM_NM#
			AND		BOO_VLE_NO = #BOO_VLE_NO#
        ]]>
	</update>
	
	<update id="CSPQBO141ELendBokgStaCdUpdate" parameterClass="paramMap">
		<![CDATA[
			UPDATE	TBCSPQBO003H
			SET		 LEND_BOKG_STA_CD = 'N'
					,FNL_USR_ID = #FNL_USR_ID#
					,FNL_DEAL_DPT_CD = #FNL_DEAL_DPT_CD#
					,FNL_MNU_ID = #FNL_MNU_ID#
					,FNL_MDF_DH = SYSDATE
			WHERE	COPT_CAT_CD = #COPT_CAT_CD#
			AND		BOO_KND_CD = #BOO_KND_CD#
			AND		BOO_NO = #BOO_NO#
			AND		CAT_SYM_NM = #CAT_SYM_NM#
			AND		BOO_VLE_NO = #BOO_VLE_NO#
			AND		BOO_BOKG_SLN = #BOO_BOKG_SLN#
        ]]>
	</update>
	
	<select id="CSPQBO141QReportSelect" parameterClass="paramMap"
		resultClass="resultMap">
		<![CDATA[
			SELECT	  F_USR_INFO(B.LAG_INV_CNB,'2')  AS LAG_INV_NAM 					/*대출자명*/
						, F_USR_INFO(B.LAG_INV_CNB,'1')  AS LAG_INV_ID 					/*대출자ID*/
						, F_DPT_INFO(F_USR_INFO(B.LAG_INV_CNB,'5'), '1') AS DPT_NM			/*부서명*/
						, F_CODE_NM('1000173', F_USR_INFO(B.LAG_INV_CNB, '3')) AS RANK_NAM	/*직급명*/
						, TO_CHAR(TO_DATE(B.BOO_LEND_DT),'YYYY-MM-DD') AS BOO_LEND_DT			/*BOO_LEND_DT*/
						, DECODE(B.BOO_REN_YN_CD,'0',TO_CHAR(TO_DATE(B.BOO_REN_APT_DT),'YYYY-MM-DD'),'') AS BOO_REN_APT_DT	/*도서반납예정일*/
						, A.BOO_NO  			/*도서번호*/
						, A.BOO_NO||'-'||A.BOO_VLE_NO AS BOO_NOS/*도서번호*/
						, A.BOO_VLE_NO /*도서권번호*/
						, A.CAT_SYM_NM 			/*분류기호명*/
						, SUBSTR(A.CAT_SYM_NM,1,1)||'-'||SUBSTR(A.CAT_SYM_NM,2,3)||'-'||SUBSTR(A.CAT_SYM_NM,5,3) AS CAT_SYM_NM2
						, A.BOO_TIT_NM  		/*도서제목명*/
						, A.ATR_NM  			/*저자명*/
						, A.BOO_KND_CD			/*도서종류코드*/
						, A.COPT_CAT_CD			/*소관분류코드*/
						, B.LAG_INV_CNB			/*대출자전산번호*/
						, F_USR_INFO(B.LAG_INV_CNB,'5')	AS DPT_CD		/*부서코드*/
						, F_USR_INFO(B.LAG_INV_CNB, '3') AS RANK_CD		/*직급코드*/
						, B.BOO_LEND_SLN		/*도서대출연번*/
						, NVL(B.BOO_REN_YN_CD,'1') AS BOO_REN_YN_CD
				FROM	TBCSPQBO001M A ,
						TBCSPQBO002H B
				WHERE	1=1
				AND		A.COPT_CAT_CD = B.COPT_CAT_CD
				AND		A.BOO_KND_CD = B.BOO_KND_CD
				AND		A.BOO_NO = B.BOO_NO
				AND		A.CAT_SYM_NM = B.CAT_SYM_NM
				AND		A.BOO_VLE_NO = B.BOO_VLE_NO
				AND		A.COPT_CAT_CD = #strCOPT_CAT_CD#
				AND		B.BOO_REN_YN_CD = '0'
				AND		B.LAG_INV_CNB = #strLAG_INV_CNB#
				AND		B.BOO_LEND_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
			ORDER BY A.BOO_NO DESC
		]]>
	</select>
	
</sqlMap> 
